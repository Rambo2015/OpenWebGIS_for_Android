<!--
  Copyright (c) 2015, OpenWebGIS, Fedor Kolomeyko <openwebgisnew@gmail.com>
All rights reserved.

Redistribution and use in source and binary forms, with or without modification, are
permitted provided that the following conditions are met:

  1. Redistributions of source code must retain the above copyright notice, this list of
     conditions and the following disclaimer.

  2. Redistributions in binary form must reproduce the above copyright notice, this list
     of conditions and the following disclaimer in the documentation and/or other materials
     provided with the distribution.

THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS" AND ANY
EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF
MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE
COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR
TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 -->
﻿<html> 
  <head> 
<title>OpenWebGIS: открытая и свободная онлайн ГИС для всех нас</title>
<META name="keywords" content="географическая информационная система, бесплатная, открытый исходный код, openwebgis, opengis,онлайн ГИС, ГИС" >
<link rel="icon" href="imgopen/favicon.ico" type="image/x-icon">
<link rel="shortcut icon" href="imgopen/favicon.ico" type="image/x-icon"> 
<link rel="stylesheet" href="openlayers/theme/default/style.css" type="text/css" />
 <link rel="stylesheet" href="openlayers/theme/default/google.css" type="text/css">
 <style type="text/css">
 .block1 { 
 width: 230px;
 height:600px;
 overflow: auto;

background: rgba(239,228,176,0.5);
color:#000080;
 padding: 15px;
 padding-right: 15 px; 
 border: solid 1px black; 
 float: left;
position:relative;top:0px;left:0px;
z-index:1000;
cursor:default;
border-radius: 5px; box-shadow: inset rgba(0,0,0,.6) 0 -1px 1px, inset rgba(252,255,255,.7) 0 1px 1px, rgba(0,0,0,.8) 0 1px 1px -1px;

 }
 .dragSwitcher { 
 width: 10px;
height:10px; 
 background:#ccc;
 padding:5px;
 padding-right:15px; 
 border:solid 2px black; 
 float:left;
cursor:move;
position:absolute; top:174px; left:-4px;
z-index:1200;
 }
.Weathclass {
height:30px;
border-color:#50F078 #9bb838 #9bb838 #50F078;
border-style:solid;border-width:1px;background:#50F078;
position:relative;top:25px;left:885px;cursor:pointer;
box-shadow: inset rgba(0,0,0,.6) 0 -1px 3px, inset rgba(252,255,255,.7) 0 3px 3px, rgba(0,0,0,.8) 0 3px 3px -1px;
border-radius: 15px;
}

.Weathclass:hover {
border-color:#FFCC66 #FFFF99 #FFFF99 #FFCC66;
border-style:solid;border-width:1px;background:#FFFF99;
box-shadow: inset rgba(0,0,0,.6) 0 -1px 3px, inset rgba(252,255,255,.7) 0 3px 3px, rgba(0,0,0,.8) 0 3px 3px -1px;
border-radius: 15px;
}
.Weathclass:focus {
background:#ddd;border-color:#ddd #333 #333 #ddd;border-style:solid;border-width:1px;
box-shadow: inset rgba(0,0,0,.6) 0 -1px 3px, inset rgba(252,255,255,.7) 0 3px 3px, rgba(0,0,0,.8) 0 3px 3px -1px;
border-radius: 15px;
}
.Weathclass:active {background:#ff0000;
border-color:#ddd #333 #333 #ddd;border-style:solid;border-width:1px;
box-shadow: inset rgba(0,0,0,.6) 0 -1px 3px, inset rgba(252,255,255,.7) 0 3px 3px, rgba(0,0,0,.8) 0 3px 3px -1px;
border-radius: 15px;
}

.SearchHclass {
height:15px;
border-color:#50F078 #9bb838 #9bb838 #50F078;
border-style:solid;border-width:1px;background:#50F078;
position:relative;cursor:pointer;
box-shadow: inset rgba(0,0,0,.6) 0 -1px 3px, inset rgba(252,255,255,.7) 0 3px 3px, rgba(0,0,0,.8) 0 3px 3px -1px;
border-radius: 15px;
}
.SearchHclass:hover {
border-color:#FFCC66 #FFFF99 #FFFF99 #FFCC66;
border-style:solid;border-width:1px;background:#FFFF99;
box-shadow: inset rgba(0,0,0,.6) 0 -3px 3px, inset rgba(252,255,255,.7) 0 3px 3px, rgba(0,0,0,.8) 0 3px 3px -3px;
border-radius: 15px;
}
.SearchHclass:focus {
background:#ddd;border-color:#ddd #333 #333 #ddd;border-style:solid;border-width:1px;
box-shadow: inset rgba(0,0,0,.6) 0 -1px 3px, inset rgba(252,255,255,.7) 0 3px 3px, rgba(0,0,0,.8) 0 3px 3px -1px;
border-radius: 15px;
}
.SearchHclass:active {background:#ff0000;
border-color:#ddd #333 #333 #ddd;border-style:solid;border-width:1px;
box-shadow: inset rgba(0,0,0,.6) 0 -1px 3px, inset rgba(252,255,255,.7) 0 3px 3px, rgba(0,0,0,.8) 0 3px 3px -1px;
border-radius: 15px;
}
.Searchclass {
height:20px;
border-color:#50F078 #9bb838 #9bb838 #50F078;
border-style:solid;border-width:1px;background:#50F078;
position:relative;cursor:pointer;
box-shadow: inset rgba(0,0,0,.6) 0 -1px 3px, inset rgba(252,255,255,.7) 0 3px 8px, rgba(0,0,0,.8) 0 3px 3px -1px;
border-radius: 15px;
}

.Searchclass:hover {
border-color:#FFCC66 #FFFF99 #FFFF99 #FFCC66;
border-style:solid;border-width:1px;background:#FFFF99;
box-shadow: inset rgba(0,0,0,.6) 0 -3px 3px, inset rgba(252,255,255,.7) 0 3px 3px, rgba(0,0,0,.8) 0 3px 3px -3px;
border-radius: 15px;
}
.Searchclass:focus {
background:#ddd;border-color:#ddd #333 #333 #ddd;border-style:solid;border-width:1px;
box-shadow: inset rgba(0,0,0,.6) 0 -1px 3px, inset rgba(252,255,255,.7) 0 3px 3px, rgba(0,0,0,.8) 0 3px 3px -1px;
border-radius: 15px;
}
.Searchclass:active {background:#ff0000;
border-color:#ddd #333 #333 #ddd;border-style:solid;border-width:1px;
box-shadow: inset rgba(0,0,0,.6) 0 -1px 3px, inset rgba(252,255,255,.7) 0 3px 3px, rgba(0,0,0,.8) 0 3px 3px -1px;
border-radius: 15px;
}
.DonPclass {
height:30px;
width:40px;
position:relative;top:100px;left:1290px;cursor:pointer;
}
.Donclass {
height:30px;
border-color:#50F078 #9bb838 #9bb838 #50F078;
border-style:solid;border-width:1px;background:#50F078;
position:relative;top:-110px;left:690px;cursor:pointer;
}
.Donclass:hover {
border-color:#FFCC66 #FFFF99 #FFFF99 #FFCC66;
border-style:solid;border-width:1px;background:#FFFF99;
}
.Donclass:focus {
background:#ddd;border-color:#ddd #333 #333 #ddd;border-style:solid;border-width:1px;
}
.Donclass:active {background:#ff0000;
border-color:#ddd #333 #333 #ddd;border-style:solid;border-width:1px;
}
.headerOpenWebGIS
{
 position: absolute; 
 top: 90px; 
 left: 3px;
height:60px;
}
 .block2 { 
 width: 1000px; 
height: 600px;
 background: #efe4b0; 
 padding: 5px; 
 border: solid 1px black; 
 float: left; 
 position: relative; 
 top: 0px; 
 left: 0px; 
 }
.struc
{float: left; 
 position: relative; 
 top: -5px; 
 left: -5px; }
.menu { background:#50f078; width:1700px;height:25px;/*margin-left:230px;*/cursor:default; position:relative;top:0px;left:-4px; font: 1em Arial, sans-serif;
 text-shadow: #0000ff 0 0 2px;border-radius: 15px; box-shadow: inset rgba(0,0,0,.6) 0 -3px 8px, inset rgba(252,255,255,.7) 0 3px 8px, rgba(0,0,0,.8) 0 3px 8px -3px;}
.dragMenu { background:#082567; width:10px; height:10px; /*margin-left:250px;*/ padding: 5px;
 padding-right: 15 px; border: solid 2px black; position:absolute; left:300px; top:150px;
 float: left; z-index:4000; cursor:move;}
.block_menu { width:1700px;height:25px;left:5px;cursor:default; position:relative;}
.punkt {float:left; padding: 1px 1px 0px 1px; /*background:transparent; */ position:relative; cursor:pointer; }
.punkt div {padding:2px 7px 2px 7px;}
div.list_punkts {background:#ECE5B1;z-index:4001;color:#0000ff; position:absolute; top:26px; left:0px;border-radius: 3px; box-shadow: inset rgba(0,0,0,.6) 0 -2px 3px, inset rgba(252,255,255,.7) 0 2px 3px, rgba(0,0,0,.8) 0 2px 3px -2px;
display:none; padding:0px; width:250px; border:solid 1px #000; font: 0.9em Arial, sans-serif;
 text-shadow: none; }
div.list_punkts div.kont {padding:0px;margin:3px; /*background:#80FF00;*/ }
div.list_punkts a {text-decoration:none; padding:0px; cursor:pointer; color:#0000ff;}
div.list_punkts div a div.podpunkt { /*background:#FF8000;*/ width:100%; padding:0px; margin-top:2px; }
div.list_punkts div a div.podpunkt div { width:100%;padding:0px 0px 0px 2px; white-space:pre;}
div.list_punkts div a:hover { background:#badbba;}
div.list_punkts div a:hover div.podpunkt { background:#badbba; color:#fff;border-radius: 5px; box-shadow: inset rgba(0,0,0,.6) 0 -1px 1px, inset rgba(252,255,255,.7) 0 1px 1px, rgba(0,0,0,.8) 0 1px 1px -1px; }
.footer_menu { clear:both; }
 
 .toolbar {
 position: absolute;
left:300px;
top:145px;
 padding-bottom: 0.5em;
 display: none;
z-index:5000;
background: #339933;
height:50px;
 }
 #toolbar ul {
 list-style: none;
 padding: 0;
 margin: 0;
 }
 #toolbar ul li {
 float: left;
 padding-right: 1em;
 padding-bottom: 0.5em;
 }
 #toolbar ul li a {
 font-weight: bold;
 font-size: smaller;
 vertical-align: middle;
 color: black;
 text-decoration: none;
 }
 #toolbar ul li a:hover {
 text-decoration: underline;
 }
 #toolbar ul li * {
 vertical-align: middle;
 }
 #wrapper {
 width: 938px;position:absolute; left: 300px; top: 200px;
 }
 #legend {
 position: absolute;
 top: 0px;
 left: 550px;
 height: 256px;
 width: 150px;
 }
 #location {
 position: relative;
 left: -17px;
 top: 17px;
 float: left;
 }
#options {
 position: absolute;
 left: 40px;
 top: 7px;
 z-index: 3000;
 }
 table.featureInfo, table.featureInfo td, table.featureInfo th {
 border: 1px solid #ddd;
 border-collapse: collapse;
 margin: 0;
 padding: 0;
 font-size: 90%;
 padding: .2em .1em;
 color:#082567;
 }
 table.featureInfo th {
 padding: .2em .2em;
 text-transform: uppercase;
 font-weight: bold;
 background: #eee;
 }
 table.featureInfo td {
 background: #fff;
 }
 table.featureInfo tr.odd td {
 background: #eee;
 }
 table.featureInfo caption {
 text-align: left;
 font-size: 100%;
 font-weight: bold;
 text-transform: uppercase;
 padding: .2em .2em;
 }
.customEditingToolbar {
 float: right;
 right: 0px;
 height: 30px; 
 }
 .customEditingToolbar div {
 float: right;
 margin: 5px;
 width: 24px;
 height: 24px;
 }
 .olControlNavigationItemActive { 
 background-image: url("openlayers/theme/default/img/editing_tool_bar.png");
 background-repeat: no-repeat;
 background-position: -103px -23px; 
 }
 .olControlNavigationItemInactive { 
 background-image: url("openlayers/theme/default/img/editing_tool_bar.png");
 background-repeat: no-repeat;
 background-position: -103px -0px; 
 }
 .olControlDrawFeaturePolygonItemInactive { 
 background-image: url("openlayers/theme/default/img/editing_tool_bar.png");
 background-repeat: no-repeat;
 background-position: -26px 0px; 
 }
 .olControlDrawFeaturePolygonItemActive { 
 background-image: url("openlayers/theme/default/img/editing_tool_bar.png");
 background-repeat: no-repeat;
 background-position: -26px -23px ; 
 }
 .olControlModifyFeatureItemActive { 
 background-image: url("openlayers/theme/default/img/move_feature_on.png");
 background-repeat: no-repeat;
 background-position: 0px 1px;
 }
 .olControlModifyFeatureItemInactive { 
 background-image: url("openlayers/theme/default/img/move_feature_off.png");
 background-repeat: no-repeat;
 background-position: 0px 1px;
 }
 .olControlDeleteFeatureItemActive { 
 background-image: url("openlayers/theme/default/img/remove_point_on.png");
 background-repeat: no-repeat;
 background-position: 0px 1px;
 }
 .olControlDeleteFeatureItemInactive { 
 background-image: url("openlayers/theme/default/img/remove_point_off.png");
 background-repeat: no-repeat;
 background-position: 0px 1px;
 }
 .olControlDrawFeaturePointItemInactive {
background-image: url("openlayers/theme/default/img/add_point_off.png");
background-repeat: no-repeat;
background-position: 0px 1px;
}
.olControlDrawFeaturePointItemActive {
background-image: url("openlayers/theme/default/img/add_point_on.png");
background-repeat: no-repeat;
 background-position: 0px -1px;
}
 .olControlDrawFeaturePathItemActive {
background-image: url("openlayers/theme/default/img/draw_line_on.png");
background-repeat: no-repeat;
 background-position: 0px -1px;
}
 .olControlDrawFeaturePathItemInactive{
background-image: url("openlayers/theme/default/img/draw_line_off.png");
background-repeat: no-repeat;
 background-position: 0px -1px;
}
 .olControlDrawFeaturePolygon2ItemInactive { 
 background-image: url("openlayers/theme/default/img/drag_off.png");
 background-repeat: no-repeat;
 background-position: 0px -1px; 
 }
 .olControlDrawFeaturePolygon2ItemActive { 
 background-image: url("openlayers/theme/default/img/drag_on.png");
 background-repeat: no-repeat;
 background-position: 0px -1px ; 
 }
 .olControlDrawFeaturePolygon3ItemInactive { 
 background-image: url("openlayers/theme/default/img/sel_off.png");
 background-repeat: no-repeat;
 background-position: 0px -1px; 
 }
 .olControlDrawFeaturePolygon3ItemActive { 
 background-image: url("openlayers/theme/default/img/sel_on.png");
 background-repeat: no-repeat;
 background-position: 0px -1px ; 
 }
.olControlDrawFeaturePolygonItemInactive { 
 background-image: url("openlayers/theme/default/img/draw_polygon_off.png");
 background-repeat: no-repeat;
 background-position: 0px -1px; 
 }
 .olControlDrawFeaturePolygonItemActive { 
 background-image: url("openlayers/theme/default/img/draw_polygon_on.png");
 background-repeat: no-repeat;
 background-position: 0px -1px ; 
 }
.olControlDrawFeatureCoordItemInactive { 
 background-image: url("openlayers/theme/default/img/coord_off.png");
 background-repeat: no-repeat;
 background-position: 0px -1px; 
 }
 .olControlDrawFeatureCoordItemActive { 
 background-image: url("openlayers/theme/default/img/coord_on.png");
 background-repeat: no-repeat;
 background-position: 0px -1px ; 
 }
#paletteC {
width:364px; height:20px;
}
#paletteC div {
width:1px; height:20px;
float:left;
}
.blockRule { 
    width: 260px; 
      background: #99A8C7;
color:#000080;
    padding: 15px;
    padding-right: 15 px; 
position:absolute;
top: 20px;
left: 20px;
border: solid 1px black; 
float: left;
   }
.blockbutOpen { 
    position:absolute;
top: 100px;
left: 80px;
   }
.blockUpdateTable
{display:none;}

.blockFilter { 
    width: 260px; 
      background: #99A8C7;
color:#000080;
    padding: 15px;
    padding-right: 15 px; 
position:absolute;
top: 160px;
left: 20px;
border: solid 1px black; 
float: left;
   }
.blockSort
{position:absolute; top: 35px;left: 180px;
 }
.ok{position:absolute;left: 20px;top: 84px;}
.blockTextCalculation { 
    width: 260px; 
     background: #99A8C7;
color:#000080;
    padding: 15px;
    padding-right: 15 px; 
position:absolute;
top: 360px;
left: 20px;
border: solid 1px black; 
float: left;
   }
.blockChart { 
    width: 260px; 
     background: #99A8C7;
color:#000080;
    padding: 15px;
    padding-right: 15 px; 
position:absolute;
top: 600px;
left: 20px;
border: solid 1px black; 
float: left;
   }

.blockTable
{
top:20px;
left: 320px;
position:relative;
}
.ChartBlockAreaDiv
{
top:20px;
left: 320px;
position:absolute;
}
#paletteCs {
		width:364px; height:20px;
	}
	#paletteCs div {
		width:1px; height:20px;
		float:left;
	}
	#paletteC2s {
		width:364px; height:20px;
	}
	#paletteC2s div {
		width:1px; height:20px;
		float:left;
	}
#paletteCstroke {
		width:364px; height:20px;
	}
	#paletteCstroke div {
		width:1px; height:20px;
		float:left;
	}


#blockleg
{ background: #ccc; 
width: 25px;
 hight: 2px; 
border: solid 1px black;}

#blocklegStrokeColor
{ background: #ccc; 
width: 25px;
 hight: 2px; 
border: solid 1px black;}

.blockRuleS { 
    width: 200px; 
    background: #99A8C7;
color:#000080;
    padding: 15px;
    padding-right: 15 px; 
position:absolute;
top: 60px;
left: 410px;
border: solid 1px black; 
float: left;
   }
.blockfield { 
    width: 200px; 
        background: #99A8C7;
color:#000080;
    padding: 15px;
    padding-right: 15 px; 
position:absolute;
top: 60px;
left: 680px;
border: solid 1px black; 
float: left;
display:none;
   }

.blockRulesSet { 
    width: 350px; 
        background: #99A8C7;
color:#000080;
    padding: 15px;
    padding-right: 15 px; 
position:absolute;
top: 145px;
left: 680px;
border: solid 1px black; 
float: left;
display:none;
   }

.blockMinMax { 
    width: 200px; 
     background: #99A8C7;
color:#000080;
    padding: 15px;
    padding-right: 15 px; 
position:absolute;
top: 145px;
left: 410px;
border: solid 1px black; 
float: left;
display:none;
   }

.blockOpacity{ 
position:absolute;
top: 110px;
left: 380px;
border: solid 1px black; 
float: left;
   }
.ok{margin-top: 30px;}
#blocklegcolor
{ background: #ccc; 
width: 25px;
 hight: 2px; 
border: solid 1px black;}
.Clustclass {
height:20px;
border-color:#99a8f0 #9bb838 #9bb838 #99a8f0;
border-style:solid;border-width:1px;background:#99a8f0;
position:relative;cursor:pointer;
box-shadow: inset rgba(0,0,0,.6) 0 -1px 3px, inset rgba(252,255,255,.7) 0 3px 8px, rgba(0,0,0,.8) 0 3px 3px -1px;
border-radius: 15px;
}

.Clustclass:hover {
border-color:#FFCC66 #FFFF99 #FFFF99 #FFCC66;
border-style:solid;border-width:1px;background:#FFFF99;
box-shadow: inset rgba(0,0,0,.6) 0 -3px 3px, inset rgba(252,255,255,.7) 0 3px 3px, rgba(0,0,0,.8) 0 3px 3px -3px;
border-radius: 15px;
}
.Clustclass:focus {
background:#ddd;border-color:#ddd #333 #333 #ddd;border-style:solid;border-width:1px;
box-shadow: inset rgba(0,0,0,.6) 0 -1px 3px, inset rgba(252,255,255,.7) 0 3px 3px, rgba(0,0,0,.8) 0 3px 3px -1px;
border-radius: 15px;
}
.Clustlass:active {background:#ff0000;
border-color:#ddd #333 #333 #ddd;border-style:solid;border-width:1px;
box-shadow: inset rgba(0,0,0,.6) 0 -1px 3px, inset rgba(252,255,255,.7) 0 3px 3px, rgba(0,0,0,.8) 0 3px 3px -1px;
border-radius: 15px;
}
#paletteCcolor {
		width:364px; height:20px;
	}
	#paletteCcolor div {
		width:1px; height:20px;
		float:left;
	}
 </style> 

 <script src="openlayers/OpenLayersRU.js"></script>
<script src="tableOWG.js"></script>
<script src="downloadOWG.js"></script>
<script src="colorOWG.js"></script>
 <script src="http://maps.google.com/maps/api/js?v=3.9&amp;sensor=false"></script>
 <script type="text/javascript" src="3d/Build/Cesium/Cesium.js"></script>
 <script>
 Cesium.BingMapsApi.defaultKey='AmLI8x4K57fDpPvI7qo1JoG4fjH3V9hjkosVs5BjNeihMpLkyUWTNssTndbIZb3S';
 OpenLayers.Layer.Google.v3.repositionMapElements = function() {
 google.maps.event.trigger(this.mapObject, "resize");
 var div = this.mapObject.getDiv().firstChild;
 if (!div || div.childNodes.length < 3) {
 this.repositionTimer = window.setTimeout(
 OpenLayers.Function.bind(this.repositionMapElements, this),
 250
 );
 return false;
 }
 var cache = OpenLayers.Layer.Google.cache[this.map.id];
 var container = this.map.viewPortDiv;
 for (var i=div.children.length-1; i>=0; --i) {
 if (div.children[i].style.zIndex == 1000001) {
 var termsOfUse = div.children[i];
 container.appendChild(termsOfUse);
 termsOfUse.style.zIndex = "1100";
 termsOfUse.style.bottom = "";
 termsOfUse.className = "olLayerGoogleCopyright olLayerGoogleV3";
 termsOfUse.style.display = "";
 cache.termsOfUse = termsOfUse;
 }
 if (div.children[i].style.zIndex == 1000000) {
 var poweredBy = div.children[i];
 container.appendChild(poweredBy);
 poweredBy.style.zIndex = "1100";
 poweredBy.style.bottom = "";
 poweredBy.className = "olLayerGooglePoweredBy olLayerGoogleV3 gmnoprint";
 poweredBy.style.display = "";
 cache.poweredBy = poweredBy;
 }
 if (div.children[i].style.zIndex == 10000002) {
 container.appendChild(div.children[i]);
 }
 }
 this.setGMapVisibility(this.visibility);
 };
 </script>
<script src="proj4js/lib/proj4js-combined.js"></script> 
 <script type="text/javascript"> 
 var agt=navigator.userAgent.toLowerCase();
 var is_major = parseInt(navigator.appVersion);
 var is_minor = parseFloat(navigator.appVersion);
 var is_nav = ((agt.indexOf('mozilla')!=-1) && (agt.indexOf('spoofer')==-1)
 && (agt.indexOf('compatible') == -1) && (agt.indexOf('opera')==-1)
 && (agt.indexOf('webtv')==-1) && (agt.indexOf('hotjava')==-1));
 var is_nav4 = (is_nav && (is_major == 4));
 var is_nav6 = (is_nav && (is_major == 5));
 var is_nav6up = (is_nav && (is_major >= 5));
 var is_ie = ((agt.indexOf("msie") != -1) && (agt.indexOf("opera") == -1));
 var dragapproved=false
 var z,x,y,zz
 var maxleft,maxtop,maxright,maxbottom; 
var checkdrag_or_size;var tempTopMapSize;var tempLeftMapSize;
var colorElem;
var pureCoverage = false;
var map;
var ams;
var ams2;
var editlayer2;
var editlayerMainName;
var edilayerMainLayer;
var editlayerMainType;
var sudak;
var wfs_cur;
 var panel;
var highlightCtrl;
var selectCtr;
var drawPoint;
var wfs_temp;
var rule;
 var sellayer3;
var external_control2;
var layerLegendMain;
var LegendTextMain=new Array();
var fillColorLegend;
var pRadLegend;
var pOpacityLegend;
var pStrokeLegend;
var StrokeColorLegend;
var divPalMain = new Array();
var divPalBMain = new Array();
var LegendStrockRMain = new Array();
var LegendIndexMain = new Array();
var LegendTextNameMain=new Array();
var SizeInputMain= new Array();
var LegendValueMain=new Array();
var LegendFieldMain;
var selectedFeatureWebGis;
var saveStrategy;
var editCoord;
var ChartKvadr;
var feature2Geom;
var abstractWMS;
var layerObj;
var wms2;
var ams;
var ams2;
var simpl='1';
var inter='3';
var sz='30';
var render_inter='2';
var radius_inter='140';
var intervals;
var ams_Inter;
var popup_inter;
var popup_interW;
var field_interpolation_Main;
var info=1;
var Interpolation_L;
var rtt;
var request22;
var maxValue_Interpolation;
var minValue_Interpolation;
var requestInter;
//var new_layer_n;
var kmlText2;
var myWinExport;
var arrFeaturesAggreg;
var fileZIP;
var vectorLayer;
var vectorLayer2;
var intervalID;
var intervalID2;
var intervaTime;
var countAnim;
var countAnim2;
var myWinGame;
var NumIterGame;
var InterInterpBB;
var contentsTXTfile;
var featureNameZonalStat;
var featureNameZonalStatPolyg;
var MarkAsBaseLayer;
var mapCenterPan=[];
var mapCenterZoom=[];
var exportMapControl;
var MousControl;
var newLegendDivMain;
var countLayerTileExport;
var WindowAddLayer='';
var stopDragInterface=false;
var stopGradiculeInterface=false;
var VarPostGISfromGML=0;
var VarPostGISfromCSV=0;
var PostGISLayerCSV;
var Export_to_shapefile=false;
var pLegendImageWebGis;
var pLegendImageWebGisW;
var pLegendImageWebGisH;
var imageMarkerArWebGis=[];
var imageMarkerArWebGisWH=[];
var ObjforChangeLayerOpacity;
var TurnOffPopUpOpacity=true;
var SSALayerMain;
var newArrayAggregOrNo;
var startTimefromPause=false;
var GraticulePropertyStyles;
var GraticuleRule;
var GlobalUN='';
var featuresGeomM;
var filterStartG=0;
var filterStartGArr=[];
var filterStartG2=0;
var filterStartGArr2=[];
var stoprotateWebGisRul=[];
var GlobalWeatherVar='';
var ImageLayerMove;
var ImageLayerMoveL;
var ImageLayerMoveL2;
var ImageLayerMoveL3;
var dopImagex=0;var dopImagey=0;
var ImageLayerMoveT=1;
var WikiLayerOpenWebGIS='0';
var WikiLanguageSel='en';
var checkDiscrWiki=true;
var measurePointGis=[];
var measurePointDist=0;
var nameMeaslayerMain='distanceGIS';
var nameMeaslayerMainSq='areaGIS';
var deawLineRuleMain;
var drawPolygonSqMain;
var checkMeasDistMain=false;
var checkMeasSqMain=false;
var nameAbstract=false; var UnameYes=false; 
var selectLenAreaMain;
var labelAtrrinuteMain;
var labelAtrrinuteArrayMain=[];
var localStorageOpenWebGIS;
var namedownlodfileopenwebgis;
var pauseSatellite;
var primitive3D;
var wmsArray3d;
var intervaTimeSpaceArray=[];
var intervaTimeLocateOthArray=[];
var CesiumDisplay;
var intervaTimeGeoLoc=0;
var new_layer_MyLocationInterval=0;
var new_layer_MyLocationIntervalTrack=0;
var MainImageData2='';
var osmb;
var globalwidg3dowg=0;
var globalwidg3dEntity=0;var globalwidg3dWMS=0;
var exportGridOWG=0;TimeFieldowg="timestr";
var opacityOSMbuild=0.95;
file3dSky=[];


var wps = "/geoserver/wps",
 capabilities,
 process;
var DeleteFeature = OpenLayers.Class(OpenLayers.Control, {
initialize: function(layer, options) {
OpenLayers.Control.prototype.initialize.apply(this, [options]);
this.layer = layer;
this.handler = new OpenLayers.Handler.Feature(
this, layer, {click: this.clickFeature}
);
},
clickFeature: function(feature) {
if(feature.fid == undefined) {
this.layer.destroyFeatures([feature]);
} else {
feature.state = OpenLayers.State.DELETE;
this.layer.events.triggerEvent("afterfeaturemodified",
{feature: feature});
feature.style ={ fillColor: "red",
 strokeColor: "red",
 fillOpacity: 0.2,
 strokeOpacity: 0.3,
display:"none"
}
this.layer.drawFeature(feature);
}
},
setMap: function(map) {
this.handler.setMap(map);
OpenLayers.Control.prototype.setMap.apply(this, arguments);
},
CLASS_NAME: "OpenLayers.Control.DeleteFeature"
});
/*for (var i in feature.attributes)
{
console.log(i+"."+feature.attributes[i]);
htmlText+=i+" "+'<input id='+i+"_ "+' type="text" size="20" value='+feature.attributes[i]+'>'+'<br>';
}
*/
var DrawFeature = OpenLayers.Class(OpenLayers.Control.DrawFeature, {
initialize: function(layer, options) {
var handler=OpenLayers.Handler.Point;
OpenLayers.Control.DrawFeature.prototype.initialize.apply(this,[layer,handler,options]);
},
clickFeature2: function(feature) {
feature.state = OpenLayers.State.INSERT;
this.layer.addFeatures([feature]);
this.featureAdded(feature);
feature.geometry = new OpenLayers.Geometry.MultiPoint(
 feature.geometry);
this.layer.events.triggerEvent("featureadded",
{feature: feature});
feature.renderIntent = "select";
this.layer.drawFeature(feature);
},
setMap: function(map) {
this.handler.setMap(map);
OpenLayers.Control.DrawFeature.prototype.setMap.apply(this, arguments);
},
CLASS_NAME: "OpenLayers.Control.DrawFeature"
});
function showMsg(szMessage) {
document.getElementById("nodelist").innerHTML = szMessage;
setTimeout(
"document.getElementById('nodelist').innerHTML = ''",2000);
}
function showSuccessMsg(){
showMsg("Transaction successfully completed");
};
function showFailureMsg(){
showMsg("An error occured while operating the transaction");
};
OpenLayers.DOTS_PER_INCH = 25.4 / 0.28
function init() {
var AlertWait=document.createElement("div");
AlertWait.id="tableAlertWait";
AlertWait.innerHTML='<p align="center" style="color:#ffffff"><a ><font size="7" >Подождите...</font><a><p>';
AlertWait.style.zIndex="10000";
document.getElementById("map").appendChild(AlertWait);
var AlertWait2=document.createElement("div");
AlertWait2.id="tableAlertWait2";
AlertWait2.innerHTML='<p align="center" style="color:#ffffff"><a><font size="7">Подождите...</font><a><p>';
AlertWait2.style.zIndex="10000";
AlertWait2.style.display="none";
document.getElementById("map").appendChild(AlertWait2);
if(localStorage["bodyColor2"])
{document.body.style.backgroundColor=localStorage["bodyColor2"];
document.getElementById("map").style.width=localStorage["mapWidth2"];
document.getElementById("map").style.height=localStorage["mapHeight2"];
document.getElementById("mapResize").style.left=localStorage["mapLeft2"];
document.getElementById("mapResize").style.top=localStorage["mapTop2"];
document.getElementById("external_control2").style.backgroundColor=localStorage["LayerSwitcher2"];
document.getElementById("drag").style.top=localStorage["LayerSwitcherTop2"];
document.getElementById("drag").style.left=localStorage["LayerSwitcherLeft2"];
document.getElementById("dragMenu").style.top=localStorage["dragMenuTop2"];
document.getElementById("dragMenu").style.left=localStorage["dragMenuLeft2"];
document.getElementById("id_menu").style.backgroundColor=localStorage["menu2"];
document.getElementById("dragEditLayer").style.top=localStorage["dragEditLayerTop2"];
document.getElementById("dragEditLayer").style.left=localStorage["dragEditLayerLeft2"];
document.getElementById("dragCoord").style.top=localStorage["dragCoordTop2"];
document.getElementById("dragCoord").style.left=localStorage["dragCoordLeft2"];
document.getElementById("dragScale").style.top=localStorage["dragScaleTop2"];
document.getElementById("dragScale").style.left=localStorage["dragScaleLeft2"];
document.getElementById("dragToolbar_opt").style.top=localStorage["dragToolbar_optTop2"];
document.getElementById("dragToolbar_opt").style.left=localStorage["dragToolbar_optLeft2"];
document.getElementById("OpenStreetMapIdSearch").style.left=localStorage["OpenStreetMapIdSearchLeft"];
document.getElementById("OpenStreetMapIdSearch").style.top=localStorage["OpenStreetMapIdSearchTop"];
document.getElementById("OpenWikipediaSearch").style.left=localStorage["OpenWikipediaSearchLeft"];
document.getElementById("OpenWikipediaSearch").style.top=localStorage["OpenWikipediaSearchTop"];
if(localStorage["changeMenubrYes"])
{if(localStorage["changeMenubrYes"]=='changeMenubrYes'){changeMenu();}}
}
var simpl='1';
var inter='3';
var sz='30';
var render_inter='2';
var radius_inter='140';
intervals="14.014,15.182,15.351,15.52,15.688,15.857,16.025,16.194,16.365";
 format = 'image/png';
 if(pureCoverage) {
 document.getElementById('filterType').disabled = true;
 document.getElementById('filter').disabled = true;
 document.getElementById('antialiasSelector').disabled = true;
 document.getElementById('updateFilterButton').disabled = true;
 document.getElementById('resetFilterButton').disabled = true;
 document.getElementById('updateRadiusButton').disabled = true;
 document.getElementById('resetRadiusButton').disabled = true;
 document.getElementById('jpeg').selected = true;
 format = "image/jpeg";
inter="3";
simpl="1";
sz="30";
render_inter="2";
radius_inter="140";
intervals="14.014,15.182,15.351,15.52,15.688,15.857,16.025,16.194,16.365";
 }
saveStrategy = new OpenLayers.Strategy.Save();
saveStrategy.events.register("success", '', showSuccessMsg);
saveStrategy.events.register("failure", '', showFailureMsg);
MousControl=new OpenLayers.Control.NavToolbar();
var options = {
projection : new OpenLayers.Projection("EPSG:900913"),
displayProjection : new OpenLayers.Projection("EPSG:4326"),
units : 'm',
numZoomLevels : 22,
center: new OpenLayers.LonLat(-3431423.30379, 2185079.4498939),
zoom:2,
 controls: [
 new OpenLayers.Control.Navigation(),
 new OpenLayers.Control.PanZoomBar(),
 new OpenLayers.Control.ScaleLine(),
 new OpenLayers.Control.Scale(),
 MousControl, new OpenLayers.Control.ZoomOut({displayClass: 'olControlDrawFeaturePolygon3ItemInactive'}),
 new OpenLayers.Control.OverviewMap()
 ],
maxExtent : new OpenLayers.Bounds(-20037508.34, -20037508.34, 20037508.34, 20037508.34),
eventListeners: {'changebaselayer': function(e) {
if(e.layer.name=="Base layer for interpolation"){
}
if(e.layer.name=="Google Maps....")
{//map.setCenter(new OpenLayers.LonLat(21.13, 55.26).transform(
var mzoom='';
if(map.zoom==20&&map.layers.length==1)
{if(map.zoom!=20){mzoom=map.zoom}else{mzoom=2}
map.setCenter(new OpenLayers.LonLat(map.center.lon, map.center.lat), mzoom);}
else
{if(map.zoom<=20){mzoom=map.zoom}else{mzoom=20}
map.setCenter(new OpenLayers.LonLat(map.center.lon, map.center.lat), mzoom);}
}
if(e.layer.name=="OpenStreetMap")
{//map.setCenter(new OpenLayers.LonLat(21.13, 55.26).transform(
var mzoom='';
if(map.zoom==18&&map.layers.length==1)
{if(map.zoom!=18){mzoom=map.zoom}else{mzoom=2}
map.setCenter(new OpenLayers.LonLat(map.center.lon, map.center.lat), mzoom);}
else{
if(map.zoom<=18){mzoom=map.zoom}else{mzoom=18}
map.setCenter(new OpenLayers.LonLat(map.center.lon, map.center.lat), mzoom);
}
}
}}
};
map = new OpenLayers.Map('map', options);
 var myPopupClass = new OpenLayers.Class
 (OpenLayers.Popup.FramedCloud,{'autoSize': false,
 'maxSize': new OpenLayers.Size(500,500)
 }
 ); 
map.events.register("moveend", map, function() {
if(mapCenterPan.length<2)
 { mapCenterPan.push(map.getCenter());}
else{var w=mapCenterPan[1];mapCenterPan=[];mapCenterPan.push(w);mapCenterPan.push(map.getCenter());}
for(var i=0;i<map.layers.length;i++)
{if(map.layers[i].heatmapOWG){var zoomH=map.layers[i];HeatmapCanvas(zoomH);}if(map.layers[i].IDWOWG&&map.layers[i].visibility==true){var zoomIDW=map.layers[i];IDWCanvas2(zoomIDW);}}
 });
map.events.register("zoomend", map, function() {if(map.zoom>30&&map.zoom<=35){external_control.numDigits=10;}if(map.zoom>35){external_control.numDigits=14;}//if(map.zoom<=30){external_control.numDigits=5;}
if(gsat==''){document.getElementById("tableAlertWait").style.display="none";return;};if(gsat==map.baseLayer){if(!document.getElementById("tableAlertWait")){document.getElementById("tableAlertWait2").style.display="block";}}
 if(mapCenterZoom.length<2) { mapCenterZoom.push(map.zoom);}
else{var w=mapCenterZoom[1];mapCenterZoom=[];mapCenterZoom.push(w);mapCenterZoom.push(map.zoom);}
for(var i=0;i<map.layers.length;i++)
{if(map.layers[i].CLASS_NAME=="OpenLayers.Layer.Image"){map.layers[i].div.childNodes[0].style.display="block";}/*if(map.layers[i].heatmapOWG){var zoomH=map.layers[i];HeatmapCanvas(zoomH);}if(map.layers[i].IDWOWG&&map.layers[i].visibility==true){alert("2");var zoomIDW=map.layers[i];IDWCanvas2(zoomIDW);}*/}

 });
 info = new OpenLayers.Control.WMSGetFeatureInfo({
 url: "/geoserver/wms", 
 title: 'Identify features by clicking',
infoFormat: 'text/html',
 queryVisible: true,
 eventListeners: {
 getfeatureinfo: function(event) {

map.addPopup(new myPopupClass(
 "popupWMS", 
 map.getLonLatFromPixel(event.xy),
null,
 layerObj=event.text,
 null,
 true
 ));
 }
 }
 });
 map.addControl(info);
 info.activate();
 
OpenLayers.Control.ArtLayerSwitcher = OpenLayers.Class(OpenLayers.Control.LayerSwitcher,{
 redraw: function (){
 if (!this.checkRedraw()) { 
 return this.div; 
 } 
 this.clearLayersArray("base");
 this.clearLayersArray("data");
 var containsOverlays = false;
 var containsBaseLayers = false;
 var len = this.map.layers.length;
 this.layerStates = new Array(len);
 for (var i=0; i <len; i++) {
 var layer = this.map.layers[i];
 this.layerStates[i] = {
 'name': layer.name, 
 'visibility': layer.visibility,
 'inRange': layer.inRange,
 'id': layer.id
 };
 } 
 var layers = this.map.layers.slice();
 if (!this.ascending) { layers.reverse(); }
 for(var i=0, len=layers.length; i<len; i++) {
 var layer = layers[i];
 var baseLayer = layer.isBaseLayer;
 if (layer.displayInLayerSwitcher) {
 if (baseLayer) {
 containsBaseLayers = true;
 } else {
 containsOverlays = true;
 } 
 var checked = (baseLayer) ? (layer == this.map.baseLayer)
 : layer.getVisibility();
 var inputElem = document.createElement("input");
 inputElem.id = this.id + "_input_" + layer.name;
 inputElem.name = (baseLayer) ? this.id + "_baseLayers" : layer.name;
 inputElem.type = (baseLayer) ? "radio" : "checkbox";
 inputElem.value = layer.name;
 inputElem.checked = checked;
 inputElem.defaultChecked = checked;
 inputElem.className = "olButton";
 inputElem._layer = layer.id;
 inputElem._layerSwitcher = this.id;
 if (!baseLayer && !layer.inRange) {
 inputElem.disabled = true;
 }
 var labelSpan = document.createElement("label");
 labelSpan["for"] = inputElem.id;
 OpenLayers.Element.addClass(labelSpan, "labelSpan olButton");
 labelSpan._layer = layer.id;
 labelSpan._layerSwitcher = this.id;
 if (!baseLayer && !layer.inRange) {
 labelSpan.style.color = "gray";
 }
 labelSpan.innerHTML = layer.name;
 labelSpan.style.verticalAlign = (baseLayer) ? "bottom" 
 : "baseline";
 var br = document.createElement("br");
 var groupArray = (baseLayer) ? this.baseLayers
 : this.dataLayers;
 groupArray.push({
 'layer': layer,
 'inputElem': inputElem,
 'labelSpan': labelSpan
 });
 var groupDiv = (baseLayer) ? this.baseLayersDiv
 : this.dataLayersDiv;
 groupDiv.appendChild(inputElem);
 groupDiv.appendChild(labelSpan);
 groupDiv.appendChild(br);
groupDiv.appendChild(br);
groupDiv.appendChild(br);
 }
 }
 this.dataLbl.style.display = (containsOverlays) ? "" : "none"; 
 this.baseLbl.style.display = (containsBaseLayers) ? "" : "none"; 
 return this.div;
 },
 CLASSNAME: "OpenLayers.Control.ArtLayerSwitcher"
});
external_control2=new OpenLayers.Control.LayerSwitcher({div: document.getElementById('external_control2') });
external_control2.useLegendGraphics = true;
map.addControl(external_control2);
if(typeof (google)!=="undefined"){
if(google.maps.MapTypeId){
var gsat = new OpenLayers.Layer.Google(
"Google Maps....", {
type : google.maps.MapTypeId.SATELLITE,sphericalMercator: true,
numZoomLevels : 21
},
{
useCanvas: OpenLayers.Layer.Grid.ONECANVASPERLAYER
}
);
}}
else
{var gsat ='';}
stylewfs_cur= new OpenLayers.Style({
 pointRadius: 3,
 fillColor: "#FF9000",
 strokeColor: "#F5FC6B",
 strokeWidth: 1,
 fillOpacity:1,
 strokeOpacity:1
 });
 var selStyle = new OpenLayers.Style({
 pointRadius: 5, 
 fillColor: "#ffaa00",
 strokeColor: "#00DDFF",
 strokeWidth:2,
fillOpacity:1,
 strokeOpacity:1
 }); 
  ////////////base layer
 
 var wfs_cur_base = new OpenLayers.Layer.Vector("Countries_base", {
strategies : [saveStrategy],renderers: ["Canvas", "SVG", "VML"],
styleMap: new OpenLayers.StyleMap({'default':stylewfs_cur,'select': selStyle}),
isBaseLayer:true});
var la=wfs_cur_base;
la.isBaseLayer=true;
var opt= {buffer: 0, displayOutsideMaxExtent: true, isBaseLayer:true,queryable: true,projection: new OpenLayers.Projection("EPSG:900913"),
minResolution: null,maxResolution: 156543.03390625,
numZoomLevels : 32,maxScale: null,minScale: null,
maxExtent: new OpenLayers.Bounds(-20037508.34, -20037508.34, 20037508.34, 20037508.34),
minExtent : null, }
la.options=opt;la.displayOutsideMaxExtent=true;la.buffer=0;
la.queryable=true;la.projection=new OpenLayers.Projection("EPSG:900913");
la.minResolution=null;la.maxResolution=156543.03390625;la.numZoomLevels=32;la.maxScale=null;la.minScale=null;
la.maxExtent=new OpenLayers.Bounds(-20037508.34, -20037508.34, 20037508.34, 20037508.34);la.minExtent=null;
 var reqcobb = new XMLHttpRequest();  
reqcobb.open('GET', 'layers/Countries_base.json', false);   
reqcobb.setRequestHeader("Cache-Control", "no-cache");
reqcobb.setRequestHeader("Content-type", "text/xml");
reqcobb.onreadystatechange = function()
{if(reqcobb.readyState == 4&&(reqcobb.status == 200||reqcobb.status == 0)) {
 
 var formatL=new OpenLayers.Format.GeoJSON({ 'internalProjection': new OpenLayers.Projection("EPSG:900913"),'externalProjection': new OpenLayers.Projection("EPSG:4326")})
 var jsonstringF = formatL.read(reqcobb.responseText);
wfs_cur_base.addFeatures(jsonstringF);
var reqcobb2 = new XMLHttpRequest();  
reqcobb2.open('GET', 'layers/Countries_base_legend.sld', false);   
reqcobb2.setRequestHeader("Cache-Control", "no-cache");
reqcobb2.setRequestHeader("Content-type", "text/xml");
reqcobb2.onreadystatechange = function()
{if(reqcobb2.readyState == 4&&(reqcobb2.status == 200||reqcobb2.status == 0)) {
var SLDcont=reqcobb2.responseText
var format=new OpenLayers.Format.SLD()
var SLDcont2=SLDcont.split("<NamedLayer>")[1];
 var pos = SLDcont.indexOf('<se:');
if(pos!=-1)
{var tsld='<?xml version="1.0" encoding="UTF-8"?><sld:StyledLayerDescriptor version="1.0.0" '+
'xmlns:sld="http://www.opengis.net/sld" xmlns:ogc="http://www.opengis.net/ogc" xmlns:gml="http://www.opengis.net/gml" xmlns:xlink="http://www.w3.org/1999/xlink" '+
'xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" '+
'xsi:schemaLocation="http://www.opengis.net/sld '+'http://schemas.opengis.net/sld/1.0.0/StyledLayerDescriptor.xsd">xmlns:se="http://www.opengis.net/se"><NamedLayer>';
SLDcont2=tsld+SLDcont2;SLDcont2=SLDcont2.split("</NamedLayer>")[0]+'</NamedLayer></sld:StyledLayerDescriptor>';

SLDcont2=SLDcont2.replace(/SvgParameter/g,"CssParameter");SLDcont2=SLDcont2.replace(/<se:/g,"<sld:");SLDcont2=SLDcont2.replace(/<\/se:/g,"<\/sld:");
var styleSLD=format.read(SLDcont2);}
else{var styleSLD=format.read(SLDcont);SLDcont2=SLDcont;} 
 for (var l in styleSLD.namedLayers) {
        var styles = styleSLD.namedLayers[l].userStyles, style;
        for (var i=0,ii=styles.length; i<ii; ++i) {
            style = styles[i];
            if (style.isDefault||!style.isDefault) {
                wfs_cur_base.styleMap.styles["default"] = style;
                break;
            }
        } }
var de=wfs_cur_base.styleMap.styles.default.rules;
for(var b=0;b<de.length;b++)
{if(de[b].symbolizer.Point&&!de[b].symbolizer.Text){de[b].symbolizer=JSON.parse(JSON.stringify(de[b].symbolizer.Point))}
if(de[b].symbolizer.Point&&de[b].symbolizer.Text){var psl=JSON.stringify(de[b].symbolizer.Point);
var psl2=JSON.stringify(de[b].symbolizer.Text);psl2=psl2.replace(/fillColor/g,"fontColor");var psl3=(psl2+psl).replace('}{',",");
de[b].symbolizer=JSON.parse(psl3);de[b].symbolizer.fontColor=SetHexRGBColor(de[b].symbolizer.fontColor)}
}
 


}
}
 reqcobb2.send(null);

 }  }
 reqcobb.send(null);
 
 /////////////////////////////////////////
var wfs_cur = new OpenLayers.Layer.Vector("Страны", {
strategies : [saveStrategy],
renderers: ["Canvas", "SVG", "VML"],
styleMap: new OpenLayers.StyleMap({'default':stylewfs_cur,'select': selStyle}),
visibility:false
});
 var reqco = new XMLHttpRequest();  
reqco.open('GET', 'layers/Countries.json', false);   
reqco.setRequestHeader("Cache-Control", "no-cache");
reqco.setRequestHeader("Content-type", "text/xml");
reqco.onreadystatechange = function()
{if(reqco.readyState == 4&&(reqco.status == 200||reqco.status == 0)) {
 
 var formatL=new OpenLayers.Format.GeoJSON({ 'internalProjection': new OpenLayers.Projection("EPSG:900913"),'externalProjection': new OpenLayers.Projection("EPSG:4326")})
 var jsonstringF = formatL.read(reqco.responseText);
wfs_cur.addFeatures(jsonstringF);
var reqco2 = new XMLHttpRequest();  
reqco2.open('GET', 'layers/Countries_legend.sld', false);   
reqco2.setRequestHeader("Cache-Control", "no-cache");
reqco2.setRequestHeader("Content-type", "text/xml");
reqco2.onreadystatechange = function()
{if(reqco2.readyState == 4&&(reqco2.status == 200||reqco2.status == 0)) {
var SLDcont=reqco2.responseText
var format=new OpenLayers.Format.SLD()
var SLDcont2=SLDcont.split("<NamedLayer>")[1];
 var pos = SLDcont.indexOf('<se:');
if(pos!=-1)
{var tsld='<?xml version="1.0" encoding="UTF-8"?><sld:StyledLayerDescriptor version="1.0.0" '+
'xmlns:sld="http://www.opengis.net/sld" xmlns:ogc="http://www.opengis.net/ogc" xmlns:gml="http://www.opengis.net/gml" xmlns:xlink="http://www.w3.org/1999/xlink" '+
'xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" '+
'xsi:schemaLocation="http://www.opengis.net/sld '+'http://schemas.opengis.net/sld/1.0.0/StyledLayerDescriptor.xsd">xmlns:se="http://www.opengis.net/se"><NamedLayer>';
SLDcont2=tsld+SLDcont2;SLDcont2=SLDcont2.split("</NamedLayer>")[0]+'</NamedLayer></sld:StyledLayerDescriptor>';

SLDcont2=SLDcont2.replace(/SvgParameter/g,"CssParameter");SLDcont2=SLDcont2.replace(/<se:/g,"<sld:");SLDcont2=SLDcont2.replace(/<\/se:/g,"<\/sld:");
var styleSLD=format.read(SLDcont2);}
else{var styleSLD=format.read(SLDcont);SLDcont2=SLDcont;} 
 for (var l in styleSLD.namedLayers) {
        var styles = styleSLD.namedLayers[l].userStyles, style;
        for (var i=0,ii=styles.length; i<ii; ++i) {
            style = styles[i];
            if (style.isDefault||!style.isDefault) {
                wfs_cur.styleMap.styles["default"] = style;
                break;
            }
        } }
var de=wfs_cur.styleMap.styles.default.rules;
for(var b=0;b<de.length;b++)
{if(de[b].symbolizer.Point&&!de[b].symbolizer.Text){de[b].symbolizer=JSON.parse(JSON.stringify(de[b].symbolizer.Point))}
if(de[b].symbolizer.Point&&de[b].symbolizer.Text){var psl=JSON.stringify(de[b].symbolizer.Point);//psl='"'+psl.split(\"}\")[1].split(\"{\")[0]+'"}'; //alert("a");
var psl2=JSON.stringify(de[b].symbolizer.Text);psl2=psl2.replace(/fillColor/g,"fontColor");var psl3=(psl2+psl).replace('}{',",");
de[b].symbolizer=JSON.parse(psl3);de[b].symbolizer.fontColor=SetHexRGBColor(de[b].symbolizer.fontColor)}
}
 


}
}
 reqco2.send(null);

 }  }
reqco.send(null);
stylewfs_vis= new OpenLayers.Style({
 pointRadius: 3,
 strokeColor: "#0000FF",
 strokeWidth: 1,
fillOpacity:1,
 strokeOpacity:1
 });
var wfs_riv = new OpenLayers.Layer.Vector("Реки", {
strategies : [saveStrategy],
renderers: ["Canvas", "SVG", "VML"],visibility:true,
styleMap: new OpenLayers.StyleMap({'default':stylewfs_vis,'select': selStyle})
});
 var req = new XMLHttpRequest();  
req.open('GET', 'layers/Rivers.json', false);   
req.setRequestHeader("Cache-Control", "no-cache");
req.setRequestHeader("Content-type", "text/xml");
req.onreadystatechange = function()
{if(req.readyState == 4&&(req.status == 200||req.status == 0)) {
 
 var formatL=new OpenLayers.Format.GeoJSON({ 'internalProjection': new OpenLayers.Projection("EPSG:900913"),'externalProjection': new OpenLayers.Projection("EPSG:4326")})
 var jsonstringF = formatL.read(req.responseText);
wfs_riv.addFeatures(jsonstringF);
 }  }
 req.send(null);

editlayer2=wfs_riv;
var mapPanel, legendPanel;
 var rulest = [
 new OpenLayers.Rule({
 title: "< 15.182 grad",
 filter: new OpenLayers.Filter.Comparison({
 type: OpenLayers.Filter.Comparison.LESS_THAN,
 property: "Mapped___s",
 value: 15.182
 }),
 symbolizer: {
 pointRadius: 8,
 fillColor: "#99ccff",
 strokeColor: "#666666",
 strokeWidth: 1,
fillOpacity:1,
 strokeOpacity:1
 }
 }),
 new OpenLayers.Rule({
 title: "15.182 - 15.857",
 filter: new OpenLayers.Filter.Comparison({
 type: OpenLayers.Filter.Comparison.BETWEEN,
 property: "Mapped___s",
 upperBoundary:15.52,
 lowerBoundary: 15.182
 }),
 symbolizer: {
 pointRadius: 6,
 fillColor: "#6699cc",
 strokeColor: "#666666",
 strokeWidth: 1,
fillOpacity:1,
 strokeOpacity:1
 }
 }),
 new OpenLayers.Rule({
 title: "> 15.857",
 maxScaleDenominator: 3000000,
 filter: new OpenLayers.Filter.Comparison({
 type: OpenLayers.Filter.Comparison.GREATER_THAN,
 property: "Mapped___s",
 value: 15.857
 }),
 symbolizer: {
 pointRadius: 4,
 fillColor: "#0033cc",
 strokeColor: "#666666",
 strokeWidth: 1,
fillOpacity:1,
 strokeOpacity:1
 }
 })
 ];
rule = new OpenLayers.Rule({
 title:"jkkkkk",
 symbolizer: {
 pointRadius: 3,
 fillColor: "#FF693F",
 strokeColor: "#666666",
 strokeWidth: 1,
fillOpacity:1,
 strokeOpacity:1
 } 
});
 style2 = new OpenLayers.Style({
 pointRadius: 3,
 fillColor: "#FF693F",
 strokeColor: "#666666",
 strokeWidth: 1,
fillOpacity:1,
 strokeOpacity:1
});
 style22T = new OpenLayers.Style({
 pointRadius: 3,
 fillColor: "#FF693F",
 strokeColor: "#666666",
 strokeWidth: 1,
fillOpacity:1,
 strokeOpacity:1
});
wfs_cit = new OpenLayers.Layer.Vector("Города", {
strategies : [saveStrategy],
renderers: ["Canvas", "SVG", "VML"],
visibility:true,
styleMap: new OpenLayers.StyleMap({'default':style22T,'select': selStyle})
});

var reqc = new XMLHttpRequest();  
reqc.open('GET', 'layers/Cities.json', false);   
reqc.setRequestHeader("Cache-Control", "no-cache");
reqc.setRequestHeader("Content-type", "text/xml");
reqc.onreadystatechange = function()
{if(reqc.readyState == 4&&(reqc.status == 200||reqc.status == 0)) {
 
 var formatL=new OpenLayers.Format.GeoJSON({ 'internalProjection': new OpenLayers.Projection("EPSG:900913"),'externalProjection': new OpenLayers.Projection("EPSG:4326")})
 var jsonstringF = formatL.read(reqc.responseText);
wfs_cit.addFeatures(jsonstringF);
 }  }
 reqc.send(null);
 stylewfs_VL = new OpenLayers.Style({
 pointRadius: 3,
 fillColor: "#FF693F",
 strokeColor: "#FF9000",
 strokeWidth: 1,
fillOpacity:1,
 strokeOpacity:1
 });
 style3 = new OpenLayers.Style({
 pointRadius: 3,
 fillColor: "#FF693F",
 strokeColor: "#666666",
 strokeWidth: 1,
fillOpacity:1,
 strokeOpacity:1
});


 stylewfs_Vbathim = new OpenLayers.Style({
 pointRadius: 3,
 fillColor: "#FFC300",
 strokeColor: "#FFC300",
 strokeWidth: 1,
fillOpacity:1,
 strokeOpacity:1
 });
var renderer = OpenLayers.Util.getParameters(window.location.href).renderer;
renderer = (renderer) ? [renderer] : OpenLayers.Layer.Vector.prototype.renderers;
var layerOSM = new OpenLayers.Layer.OSM();
layerOSM.numZoomLevels=21;
layerOSM.isBaseLayer=true;
ams = new OpenLayers.Layer.WMS(
 "Layer Interpolation1", "/geoserver/wms",
 {
 LAYERS: 'webgis:sst_cl_20100908_Inter',
 STYLES: '',
 format: format,
 SERVICE: "AMS",
 VALUE_COLUMN: "Mapped___s",
 SIMPLIFY_METHOD: simpl,
 SIMPLIFY_SIZE: sz,
 'INTERVALS[]': "14.014,15.182,15.351,15.52,15.688,15.857,16.025,16.194,16.365",
 'INTERVALS_COLORS[]': "0x7FCE82CC,0x508252CC,0xEF9700CC,0xFF3F3FCC,0xDF0000CC,0x7F0000CC,0x7F0000CF,0x7F0000FC,0x7F00F0CC",
RENDERER_TYPE: 1,
 INTERPOLATION_STRATEGY:inter,
 RADIUS: 140
 },
 {
 singleTile: true,
 isBaseLayer: false,
projection: new OpenLayers.Projection("EPSG:900913"),
minResolution: null,
maxResolution: 48,
numZoomLevels : 32,
maxScale: null,
minScale: 1271428,
maxExtent: new OpenLayers.Bounds(-20037508.34, -20037508.34, 20037508.34, 20037508.34),
minExtent : null,
visibility:false,
 }
 );
ams2 = new OpenLayers.Layer.WMS(
 "Layer Interpolation2", "/geoserver/wms",
 {
 LAYERS: 'webgis:sst_cl_20100908_Inter',
 STYLES: '',
 format: format,
 SERVICE: "AMS",
 VALUE_COLUMN: "Mapped___s",
 SIMPLIFY_METHOD: simpl,
 SIMPLIFY_SIZE: sz,
 'INTERVALS[]': "14.014,15.182,15.351,15.52,15.688,15.857,16.025,16.194,16.365",
 'INTERVALS_COLORS[]': "0x7FCE82CC,0x508252CC,0xEF9700CC,0xFF3F3FCC,0xDF0000CC,0x7F0000CC,0x7F0000CF,0x7F0000FC,0x7F00F0CC",
RENDERER_TYPE: 2,
 INTERPOLATION_STRATEGY:inter,
 RADIUS: 140
 },
 {
 buffer: 0,
 displayOutsideMaxExtent: true,
 isBaseLayer: false,
projection: new OpenLayers.Projection("EPSG:900913"),
minResolution: null,
maxResolution: 48,
numZoomLevels : 32,
maxScale: null,
minScale: 1271428,
maxExtent: new OpenLayers.Bounds(-20037508.34, -20037508.34, 20037508.34, 20037508.34),
minExtent : null,
visibility:false
 }
 );
wms2= new OpenLayers.Layer.WMS(
 "Base layer for interpolation", "/geoserver/wms",
 {
LAYERS: 'webgis:sst_cl_20100908',
 STYLES: '',
 format: format,
 },
 {
 buffer: 0,
 displayOutsideMaxExtent: true,
 isBaseLayer: true,
projection: new OpenLayers.Projection("EPSG:900913"),
minResolution: null,
maxResolution: 48,
numZoomLevels : 32,
maxScale: null,
minScale: 1271428,
maxExtent: new OpenLayers.Bounds(-20037508.34, -20037508.34, 20037508.34, 20037508.34),
minExtent : null,
displayProjection : new OpenLayers.Projection("EPSG:4326"),
 }
 );
stylewfs_cur= new OpenLayers.Style({
 pointRadius: 3,
 fillColor: "#FF9000",
 strokeColor: "#FF9000",
 strokeWidth: 1,
 fillOpacity:1,
 strokeOpacity:1
 });
 var selStyle = new OpenLayers.Style({
 pointRadius: 5, 
 fillColor: "#ffaa00",
 strokeColor: "#00DDFF",
 strokeWidth:2,
fillOpacity:1,
 strokeOpacity:1
 }); 

 if(gsat!=='')
{map.addLayers([layerOSM,gsat, wfs_cur_base, wfs_cur,wfs_riv,wfs_cit]);}
else{map.addLayers([layerOSM, wfs_cur_base, wfs_cur,wfs_riv,wfs_cit]);}
if(gsat!=='')
{gsat.mapObject.setTilt(0);
google.maps.event.addListener(gsat.mapObject, "tilesloaded", 
function(){var removeFin=document.getElementById("tableAlertWait");var removeFin2=document.getElementById("tableAlertWait2");
if(removeFin)
{document.getElementById("tableAlertWait").parentNode.removeChild(removeFin);}
if(removeFin2)
{removeFin2.style.display="none";}
});}
layerOSM.events.register("loadstart",layerOSM, function() {document.getElementById("tableAlertWait2").style.display="block";});
layerOSM.events.register("loadend",layerOSM, function() {document.getElementById("tableAlertWait2").style.display="none"; 
var osment=0;var osmcount=0;if(layerOSM.visibility==true)
{for(var osm=0;osm<layerOSM.grid.length;osm++)
{for(var osm2=0;osm2<layerOSM.grid[osm].length;osm2++)
{if(layerOSM.grid[osm][osm2].imgDiv.className!=='olTileImage'){osment++;}osmcount++;}
} if(osment==osmcount){/*alert("may be internet error")*/
for(var mb=0;mb<map.layers.length;mb++){if(map.layers[mb].name=='Countries_base'&&map.layers[mb].isBaseLayer==true){map.setBaseLayer(map.layers[mb]);;}}
} }


});
wfs_cur.events.register("loadstart",wfs_cur, function() {WaitWindow();});
wfs_cur.events.register("loadend",wfs_cur, function() {if(popup_Wait){popup_Wait.destroy();} });
MousControl.div.style.top="340px";
map.events.register("changebaselayer", map, function() {
if(document.getElementById("OpenLayers_Control_PanZoomBar_ZoombarOpenLayers.Map_13").style.height.split('px')[0]>231)
{MousControl.div.style.left="35px";}
else{MousControl.div.style.left="10px";}
});
var scriptLegend = document.createElement("script"); 
scriptLegend.src = 'legendOWG.js'; 
 scriptLegend.type = 'text/javascript'; 
 scriptLegend.id="legendOWGjs_id";
scriptLegend.async=false;document.body.appendChild(scriptLegend)
streamControl = new OpenLayers.Control.GetFeature({
 protocol : OpenLayers.Protocol.WFS({
url : "/geoserver/wfs",
 featurePrefix: "webgis",
featureType : "sst_cl_20100908",
featureNS : "http://localhost:8080/data/webgis/curonian",
geometryName: "the_geom"
}),
 box: true
});
streamControl.events.register('featureselected', this, function(e) {
select.addFeatures([e.feature]);
 var popup = new OpenLayers.Popup("chicken",
 new OpenLayers.LonLat(5,40),
 new OpenLayers.Size(200,200),
 "example popup",
 true);
popup.show();
 map.addPopup(popup);
}); 
function popupStream(feature, htmlText) {
 var popup = new OpenLayers.Popup.FramedCloud("popup",
 map.getLonLatFromPixel(e.xy),
 new OpenLayers.Size(120,120),
 e.text=htmlText,
 null,
 true
 );
 map.addPopup(popup);
 } 
 /*function popupStream (feature, htmlText) {
 popup = new GeoExt.Popup({
 title: 'My Popup',
 feature: feature,
 width:200,
lonlat: map.getLonLatFromPixel(e.xy),
 html: htmlText,
 maximizable: false,
 collapsible: true
 });
 popup.show();
}*/
 var options = document.getElementById("options");
 options.onclick = toggleControlPanel;
var external_control = new OpenLayers.Control.MousePosition({
 div: document.getElementById('external_control') });
map.addControl(external_control);
map.addControl(new OpenLayers.Control.Scale($('scale')));
 map.addControl(new OpenLayers.Control.MousePosition({element: $('location')}));
panel = new OpenLayers.Control.Panel({
 displayClass: 'customEditingToolbar',
 allowDepress: true
 });
 var drawLine = new OpenLayers.Control.DrawFeature(
 wfs_riv, OpenLayers.Handler.Path,
 {displayClass: 'olControlDrawFeaturePath',title:'Добавить линию'}
 );
drawLine.events.register("activate", drawLine, function(){if(document.getElementById("editL1").value=="0")
{alert ("Выберите название слоя в который хотите добавить элемент или создайте новый слой и также выберите его в списке 'Редактируемый слой'"); drawLine.deactivate();}});
 drawLine.featureAdded = function(feature) {
 feature.layer.eraseFeatures([feature]);
 feature.geometry = new OpenLayers.Geometry.MultiLineString(
 feature.geometry
 );
 feature.style.strokeColor = "#ff0000";
 feature.state = OpenLayers.State.INSERT;
 feature.layer.drawFeature(feature);
 }
 var drawPolygon = new OpenLayers.Control.DrawFeature(
 wfs_riv, OpenLayers.Handler.Polygon,
 {displayClass: 'olControlDrawFeaturePolygon',title:'Добавить полигон'}
 );
rtt=drawPolygon;
drawPolygon.events.register("activate", drawPolygon, function(){if(document.getElementById("editL1").value=="0")
{alert ("Выберите название слоя в который хотите добавить элемент или создайте новый слой и также выберите его в списке 'Редактируемый слой'"); drawPolygon.deactivate();}});
drawPoint = new DrawFeature(
 editlayer2, {title: "Добавить точку",displayClass: 'olControlDrawFeaturePoint'}
 );
drawPoint.events.register("activate", drawPoint, function(){if(document.getElementById("editL1").value=="0")
{alert ("Выберите название слоя в который хотите добавить элемент или создайте новый слой и также выберите его в списке 'Редактируемый слой'"); drawPoint.deactivate();}});

 var edit = new OpenLayers.Control.ModifyFeature(wfs_riv, {
title: "Редактировать(модифицировать) элемент слоя",
displayClass: "olControlModifyFeature"
});
edit.events.register("activate", edit, function(){if(document.getElementById("editL1").value=="0")
{alert ("Выберите название слоя в котором хотите модифицировать элементы или создайте новый слой и также выберите его в списке 'Редактируемый слой'"); edit.deactivate();}});
var del = new DeleteFeature(wfs_riv, {title: "Удалить элемент слоя"});
del.events.register("activate", del, function(){if(document.getElementById("editL1").value=="0")
{alert ("Выберите название слоя из которого хотите удалить элемент или создайте новый слой и также выберите его в списке 'Редактируемый слой'"); del.deactivate();}});
var rout = new OpenLayers.Control.Button({
title: "Построить маршрут на авто",
trigger: function() {

var bbox = document.getElementById("map").getBoundingClientRect();
 var body = document.body
 var docElem = document.documentElement
 var scrollTop = window.pageYOffset || docElem.scrollTop || body.scrollTop
 var scrollLeft = window.pageXOffset || docElem.scrollLeft || body.scrollLeft
 var clientTop = docElem.clientTop || body.clientTop || 0
 var clientLeft = docElem.clientLeft || body.clientLeft || 0
 var topTop = bbox.top + scrollTop - clientTop
 var leftLeft = bbox.left + scrollLeft - clientLeft
var DivEditeLeg=document.createElement("div");
DivEditeLeg.id="id_divRoutLegMain2";
DivEditeLeg.className="id_divRoutLegMain";
DivEditeLeg.style.position="relative";

DivEditeLeg.innerHTML='<div id="id_divRoutLeg" style="background:#ffffff; color:#0000ff;z-index: 6000;position:absolute;left:'+Math.round(leftLeft+50)+'px;top:'+Math.round(topTop+20)+
'px;overflow:hidden; border: 1px solid black;"><img onclick="closeRoutWin()" src="openlayers/theme/default/img/close.gif" style="position:relative; top:10px;float:right; cursor:pointer"><a style="position:relative; top:20px"></a>'+
'<a style="font-size: 9px;"> Вы можете перемещать это окно если щёлкните по пункту меню: переключить режим интерфейса</a><br>'+
'<a>Пожалуйста щёлкните по карте:</a>'+
'<a>маршрут только для авто:</a><br>'+
'Начало<input type="text" size="25" id="RoutId_start" value=""/><img onclick="clearRoutWin1()" src="openlayers/img/cancel.png"><br>'+
'Конец..<input type="text" size="25" id="RoutId_end" value=""/><img onclick="clearRoutWin2()" src="openlayers/img/cancel.png"><br>'+
'Название слоя маршрута <input type="text" size="20" id="NameRoutId_web" value="NewRout"/><br>'+
'<input type="checkbox" id="id_RoutCheckGis" title="если галочка не стоит, то маршрут будет построен в виде набора линий с указанием параметров каждого отрезка маршрута - длина, время и т.д., если галочка стоит, то будет построена одна линия с указание общей длины и времени маршрута" value="checkbox"/>результат как одна линия<br>'+
'<p> <button type=button onclick=Routing()>OK</button></p>'+
'<div style="font-size: 10px;" id="legal-notice" >Routing by '+
'<a href="http://project-osrm.org/">Project OSRM</a>'+
'- Geocoder by '+'<a href="http://wiki.openstreetmap.org/wiki/Nominatim">Nominatim</a>'+
'- OSRM hosting by '+'<a href="http://algo2.iti.kit.edu/">KIT</a></div><br>'+
'<div id="instructRourwebgis" style="height: 10px; font-size: 10px; overflow:auto;border: solid 1px black;"</div><br>'+
'</div>';
if(!document.getElementById("id_divRoutLeg"))
{body.appendChild(DivEditeLeg); 

document.getElementById("id_divRoutLegMain2").onmousedown=function(event){drags(event)};
document.getElementById("id_divRoutLegMain2").onmouseup=function(e){enddrag()};
      OpenLayers.Control.Click = OpenLayers.Class(OpenLayers.Control, {                
defaultHandlerOptions: {
'single': true,
'double': false,
'pixelTolerance': 0,
'stopSingle': false,
'stopDouble': false
},

initialize: function(options) {
this.handlerOptions = OpenLayers.Util.extend(
{}, this.defaultHandlerOptions
);
OpenLayers.Control.prototype.initialize.apply(
this, arguments
); 
this.handler = new OpenLayers.Handler.Click(
                        this, {
'click': this.trigger
}, this.handlerOptions
                    );
                }, 

trigger: function(e) {
var lonlat = map.getLonLatFromPixel(e.xy);
var yesLayer='no';
for(var l=0;l<map.layers.length;l++)
{if(map.layers[l].name=='MarkersRout'&&map.layers[l].CLASS_NAME=='OpenLayers.Layer.Markers'){yesLayer='yes';markers=map.layers[l];}}
if(yesLayer=='no'){var markers = new OpenLayers.Layer.Markers( "MarkersRout" ); 
map.addLayer(markers);}

var size = new OpenLayers.Size(21,25);
var offset = new OpenLayers.Pixel(10.5, -25);
offset.x=(-1)*offset.x;
rtt=offset;

var icon = new OpenLayers.Icon('img/markerstartdss.png', size, offset);
var icon2 = new OpenLayers.Icon('img/markerenddss.png', size, offset);


var new_pos=new OpenLayers.LonLat(lonlat.lon,lonlat.lat).transform(
map.getProjectionObject(),new OpenLayers.Projection("EPSG:4326")
);
if(document.getElementById("RoutId_start")&&!document.getElementById("RoutId_start").value.split(';')[0])
{document.getElementById("RoutId_start").value=new_pos.lon+";"+new_pos.lat;
for(var kk=0;kk<markers.markers.length;kk++)
{if(markers.markers[kk].icon.url=='img/markerstartdss.png'){markers.removeMarker(markers.markers[kk]); }}
markers.addMarker(new OpenLayers.Marker(new OpenLayers.LonLat(lonlat.lon,lonlat.lat),icon.clone()));
}

else{
if(document.getElementById("RoutId_end")&&document.getElementById("RoutId_start").value.split(';')[0])
{document.getElementById("RoutId_end").value=new_pos.lon+";"+new_pos.lat}
for(var kk=0;kk<markers.markers.length;kk++)
{if(markers.markers[kk].icon.url=='img/markerenddss.png'){markers.removeMarker(markers.markers[kk]); }}
markers.addMarker(new OpenLayers.Marker(new OpenLayers.LonLat(lonlat.lon,lonlat.lat),icon2.clone()));
}


	
                }

            });
var clickRout = new OpenLayers.Control.Click();
clickRout.title="click to routing";
 map.addControl(clickRout);
clickRout.activate();
}




},
displayClass: "olControlRoutFeatures"
});
var new_layer_area = new OpenLayers.Layer.Vector(nameMeaslayerMainSq,{renderers:["Canvas", "SVG", "VML"]});
 var drawPolygonSq = new OpenLayers.Control.DrawFeature(
 new_layer_area, OpenLayers.Handler.Polygon,
 {displayClass: 'olControlSquareFeatures',multi:true,title: "Измерить площадь",callbacks : {"point": pointHandlerSq}}
 );
function pointHandlerSq()
{
var areaP=drawPolygonSq.handler.polygon.clone().geometry.transform(map.getProjectionObject(),new OpenLayers.Projection("EPSG:4326"));
var area=areaP.getGeodesicArea(new OpenLayers.Projection("EPSG:4326"));
var areaL=areaP.getGeodesicLength(new OpenLayers.Projection("EPSG:4326"));
if(document.getElementById("id_divControlmeasureGisSqLeg"))
{if(areaL<0.1)
{document.getElementById("id_divControlmeasureGisLegSq2").innerHTML='<a>area: '+area.toFixed(10)+' sq.m.</a><br>'+'<a>length: '+areaL.toFixed(10)+' m<a>';}
else
{document.getElementById("id_divControlmeasureGisLegSq2").innerHTML='<a>area: '+area.toFixed(5)+' sq.m.</a><br>'+'<a>length: '+areaL.toFixed(5)+' m<a>';}
}
}
drawPolygonSq.featureAdded = function(feature) {
feature.attributes={};
feature.data={};
if(new_layer_area.features.length>2)
{
var numberP=parseInt(new_layer_area.features[new_layer_area.features.length-2].fid.split('.')[1])+parseInt(1);
var lnewFid=new_layer_area.features[new_layer_area.features.length-2].fid.split('.')[0]+"."+numberP;
}
else{var lnewFid=new_layer_area.name+"."+parseInt(new_layer_area.features.length);}
var areaP=feature.clone().geometry.transform(map.getProjectionObject(),new OpenLayers.Projection("EPSG:4326"));
area=areaP.getGeodesicArea(new OpenLayers.Projection("EPSG:4326"));
feature.attributes["area"]=parseFloat(area);feature.data["area"]=parseFloat(area);
feature.fid=lnewFid;
 feature.state = OpenLayers.State.INSERT;
var layeradd='';

if(document.getElementById("DistMeasureGisaSq_id").value!=='0')
{
for(var tt=0;tt<map.layers.length;tt++)
{if(map.layers[tt].name==document.getElementById("DistMeasureGisaSq_id").value)
{layeradd=map.layers[tt];
for(var ttt=0;ttt<map.layers[tt].features.length;ttt++)
{if(!map.layers[tt].features[ttt].attributes['area'])
{map.layers[tt].features[ttt].attributes['area']='';}
for (jk in layeradd.features[0].attributes)
{if(jk=='area'){}
else{feature.attributes[jk]='';}
}

}
}
}
}
feature.layer.drawFeature(feature);
if(document.getElementById("DistMeasureGisaSq_id").value!=='0'){var e=[];e.push(feature.clone());layeradd.addFeatures(e);}
 }

drawPolygonSq.events.register("activate", drawPolygonSq, function(){

drawPolygonSq.panel_div.id="ControlmeasureGisSq_id";
var bbox = document.getElementById("ControlmeasureGisSq_id").parentNode.getBoundingClientRect();
 var body = document.body
 var docElem = document.documentElement
 var scrollTop = window.pageYOffset || docElem.scrollTop || body.scrollTop
 var scrollLeft = window.pageXOffset || docElem.scrollLeft || body.scrollLeft
 var clientTop = docElem.clientTop || body.clientTop || 0
 var clientLeft = docElem.clientLeft || body.clientLeft || 0
 var topTop = bbox.top + scrollTop - clientTop
 var leftLeft = bbox.left + scrollLeft - clientLeft
var DivEditeLeg=document.createElement("div");
DivEditeLeg.id="id_divControlmeasureGisSq2";
DivEditeLeg.className="id_divControlmeasureGisSq";
DivEditeLeg.style.position="relative";
DivEditeLeg.innerHTML='<div id="id_divControlmeasureGisSqLeg" style="background:#ffffff; color:#0000ff;z-index: 6000;position:absolute;left:'+Math.round(leftLeft)+'px;top:'+Math.round(topTop-230)+
'px;overflow:hidden; border: 1px solid black;"><img onclick="closeMeasureSqWin()" src="openlayers/theme/default/img/close.gif" style="position:relative; top:3px left:50px;float:right; cursor:pointer"><a style="position:relative; top:20px"></a>'+
'<div id="id_divControlmeasureGisLegSq2" style="font-size:11px"></div>'+
'<div onclick="OptionSqMeas()" title="open options of  measure area" style="cursor:pointer"><img src="img/option.png"/></div><div id="DistMeasureGisaSqDiv_id" style="display:none;font-size:11px" ><a style="font-size:11px">add to:</a> <select style="font-size:11px" id="DistMeasureGisaSq_id" onchange="" title="if in this combobox the layer is selected then information about area will be added to this layer and in the new layer,otherwise the information about area will be added ONLY in the new layer">.'+
 '<option selected value="0">.</option>'+
'</select>'+'<br>layer name:<input type="text" style="font-size:11px" size="15" id="DistMeasureGisaSqL_id" title="insert name of the new layer with area. The new name will be set after the reopening of this popup window" value="'+nameMeaslayerMainSq+'" onBlur="OnBlurtDistMeasureGisaSqL()"/>'+
'<br><input type="checkbox" title="delete new layer with area after deactivating of control /measure area/" id="Id_CheckSqMeas" onclick="DistMeasDelLSq()" value="true" checked />delete new layer'+
'</div>'+
'</div>';

if(!document.getElementById("id_divControlmeasureGisSqLeg"))
{body.appendChild(DivEditeLeg); document.getElementById("id_divControlmeasureGisLegSq2").innerHTML='0.00000'+" sq.m";

drawPolygonSqMain=drawPolygonSq;
document.getElementById("id_divControlmeasureGisSq2").onmousedown=function(event){drags(event)};
document.getElementById("id_divControlmeasureGisSq2").onmouseup=function(e){enddrag()};
var new_layer_area = new OpenLayers.Layer.Vector(document.getElementById("DistMeasureGisaSqL_id").value,{renderers:["Canvas", "SVG", "VML"]});
drawPolygonSq.layer=new_layer_area;
var t=document.createElement('option');t.value=new_layer_area.name;t.text=new_layer_area.name;
document.getElementById("editL1").appendChild(t);
map.addLayer(new_layer_area);
for(var i=0;i<map.layers.length;i++)
{if(map.layers[i].CLASS_NAME=="OpenLayers.Layer.Vector"&&map.layers[i].name!=="OpenLayers.Handler.Polygon")
{var t=document.createElement('option');
t.value=map.layers[i].name;t.text=map.layers[i].name;document.getElementById("DistMeasureGisaSq_id").appendChild(t);}
}
}
if(checkMeasSqMain==true)
{document.getElementById("Id_CheckSqMeas").checked=true}
if(checkMeasSqMain==false)
{document.getElementById("Id_CheckSqMeas").checked=false}

});

 drawPolygonSq.events.register("deactivate", drawPolygonSq, function(){
 if(checkMeasSqMain==true)
 {
 var ListL=document.getElementById('editL1');
for (var k=0; k<ListL.length; k++)
{if(ListL.options[k].value==drawPolygonSq.layer.name){ListL.removeChild(ListL.options[k]);}}
drawPolygonSq.layer.destroy();
 }
 });
var new_layer_Rule = new OpenLayers.Layer.Vector(nameMeaslayerMain,{renderers:["Canvas", "SVG", "VML"]});
var drawLineRule = new OpenLayers.Control.DrawFeature(
 new_layer_Rule, OpenLayers.Handler.Path,
 {displayClass: 'olControlRuleFeatures',multi: true,title: "Измерить расстояние", callbacks : {"point": pointHandler}}
 );
function pointHandler()
{
var new_pos1=new OpenLayers.LonLat(drawLineRule.handler.point.geometry.x,drawLineRule.handler.point.geometry.y);
measurePointGis.push(new_pos1);
var lengt=measurePointGis.length-2; if(lengt==-1){lengt=0;}
var dist=distanceOpenWebGIS(measurePointGis[lengt].lon,measurePointGis[lengt].lat,new_pos1.lon,new_pos1.lat)
measurePointDist=measurePointDist+dist;
if(document.getElementById("id_divControlmeasureGisLeg"))
{if(measurePointDist<0.01)
{document.getElementById("id_divControlmeasureGisLeg2").innerHTML=measurePointDist.toFixed(10)+" m";}
else
{document.getElementById("id_divControlmeasureGisLeg2").innerHTML=measurePointDist.toFixed(5)+" m";}
}
}
function distanceOpenWebGIS(x1,y1,x2,y2)
{
var new_pos1=new OpenLayers.LonLat(x1,y1).transform(map.getProjectionObject(),new OpenLayers.Projection("EPSG:4326"));
var new_pos2=new OpenLayers.LonLat(x2,y2).transform(map.getProjectionObject(),new OpenLayers.Projection("EPSG:4326"));
var long1=new_pos1.lon;
var lat1=new_pos1.lat;
var long2=new_pos2.lon;
var lat2=new_pos2.lat;
var R = 6372795;
lat1 *= Math.PI / 180;lat2 *= Math.PI / 180;
long1 *= Math.PI / 180;long2 *= Math.PI / 180;
var cl1 = Math.cos(lat1);var cl2 = Math.cos(lat2);var sl1 = Math.sin(lat1);var sl2 = Math.sin(lat2);
var delta = long2 - long1;var cdelta = Math.cos(delta);var sdelta = Math.sin(delta);var y = Math.sqrt(Math.pow(cl2 * sdelta, 2) + Math.pow(cl1 * sl2 - sl1 * cl2 * cdelta, 2));
var x = sl1 * sl2 + cl1 * cl2 * cdelta;var ad = Math.atan2(y, x);
if((ad * R)<0.01){var dist = parseFloat((ad * R).toFixed(10));}
else
{var dist = parseFloat((ad * R).toFixed(5));}
return dist;

}
  drawLineRule.featureAdded = function(feature) {
feature.attributes={};
feature.data={};
measurePointGis=[];
var x1=feature.geometry.components[0].components[0].x;
var y1=feature.geometry.components[0].components[0].y;
var x2=feature.geometry.components[0].components[feature.geometry.components[0].components.length-1].x
var y2=feature.geometry.components[0].components[feature.geometry.components[0].components.length-1].y

if(document.getElementById("id_divControlmeasureGisLeg"))
{document.getElementById("id_divControlmeasureGisLeg2").innerHTML=measurePointDist+" m";}

if(new_layer_Rule.features.length>2)
{
var numberP=parseInt(new_layer_Rule.features[new_layer_Rule.features.length-2].fid.split('.')[1])+parseInt(1);
var lnewFid=new_layer_Rule.features[new_layer_Rule.features.length-2].fid.split('.')[0]+"."+numberP;
}
else{var lnewFid=new_layer_Rule.name+"."+parseInt(new_layer_Rule.features.length);}
//DistMeasureGisa_id
feature.attributes["distance"]=parseFloat(measurePointDist);feature.data[name]=parseFloat(measurePointDist);
measurePointDist=0;
feature.fid=lnewFid;
 feature.state = OpenLayers.State.INSERT;
 

var layeradd='';

if(document.getElementById("DistMeasureGisa_id").value!=='0')
{
for(var tt=0;tt<map.layers.length;tt++)
{if(map.layers[tt].name==document.getElementById("DistMeasureGisa_id").value)
{layeradd=map.layers[tt];
for(var ttt=0;ttt<map.layers[tt].features.length;ttt++)
{if(!map.layers[tt].features[ttt].attributes['distance'])
{map.layers[tt].features[ttt].attributes['distance']='';}
for (jk in layeradd.features[0].attributes)
{if(jk=='distance'){}
else{feature.attributes[jk]='';}
}

}
}
}
}
feature.layer.drawFeature(feature);
if(document.getElementById("DistMeasureGisa_id").value!=='0'){var e=[];e.push(feature.clone());layeradd.addFeatures(e);}

 }
  drawLineRule.events.register("deactivate", drawLineRule, function(){
 if(checkMeasDistMain==true)
 {
 var ListL=document.getElementById('editL1');
for (var k=0; k<ListL.length; k++)
{if(ListL.options[k].value==drawLineRule.layer.name){ListL.removeChild(ListL.options[k]);}}
drawLineRule.layer.destroy();
 }
 });
drawLineRule.events.register("activate", drawLineRule, function(){

drawLineRule.panel_div.id="ControlmeasureGis_id";
var bbox = document.getElementById("ControlmeasureGis_id").parentNode.getBoundingClientRect();
 var body = document.body
 var docElem = document.documentElement
 var scrollTop = window.pageYOffset || docElem.scrollTop || body.scrollTop
 var scrollLeft = window.pageXOffset || docElem.scrollLeft || body.scrollLeft
 var clientTop = docElem.clientTop || body.clientTop || 0
 var clientLeft = docElem.clientLeft || body.clientLeft || 0
 var topTop = bbox.top + scrollTop - clientTop
 var leftLeft = bbox.left + scrollLeft - clientLeft
var DivEditeLeg=document.createElement("div");
DivEditeLeg.id="id_divControlmeasureGis2";
DivEditeLeg.className="id_divControlmeasureGis";
DivEditeLeg.style.position="relative";
DivEditeLeg.innerHTML='<div id="id_divControlmeasureGisLeg" style="background:#ffffff; color:#0000ff;z-index: 6000;position:absolute;left:'+Math.round(leftLeft)+'px;top:'+Math.round(topTop-230)+
'px;overflow:hidden; border: 1px solid black;"><img onclick="closeMeasureWin()" src="openlayers/theme/default/img/close.gif" style="position:relative; top:3px left:50px;float:right; cursor:pointer"><a style="position:relative; top:20px"></a>'+
'<div id="id_divControlmeasureGisLeg2" style="font-size:11px"></div>'+
'<div onclick="OptionDistMeas()" title="open options of  measure distance" style="cursor:pointer"><img src="img/option.png"/></div><div id="DistMeasureGisaDiv_id" style="display:none;font-size:11px" ><a style="font-size:11px">add to:</a> <select style="font-size:11px" id="DistMeasureGisa_id" onchange="" title="if in this combobox the layer is selected then information about distance will be added to this layer and in the new layer,otherwise the information about distance will be added ONLY in the new layer">.'+
 '<option selected value="0">.</option>'+
'</select>'+'<br>layer name:<input type="text" style="font-size:11px" size="15" id="DistMeasureGisaL_id" title="insert name of the new layer with distance. The new name will be set after the reopen this popup window" value="'+nameMeaslayerMain+'" onBlur="OnBlurtDistMeasureGisaL()"/>'+
'<br><input type="checkbox" title="delete new layer with distance after deactivate control /measure distance/" id="Id_CheckDistMeas" onclick="DistMeasDelL()" value="true" checked />delete new layer'+
'</div>'+
'</div>';

if(!document.getElementById("id_divControlmeasureGisLeg"))
{body.appendChild(DivEditeLeg); document.getElementById("id_divControlmeasureGisLeg2").innerHTML='0.00000'+" m";

drawLineRuleMain=drawLineRule;
document.getElementById("id_divControlmeasureGis2").onmousedown=function(event){drags(event)};
document.getElementById("id_divControlmeasureGis2").onmouseup=function(e){enddrag()};
var new_layer_Rule = new OpenLayers.Layer.Vector(document.getElementById("DistMeasureGisaL_id").value,{renderers:["Canvas", "SVG", "VML"]});
drawLineRule.layer=new_layer_Rule;
var t=document.createElement('option');t.value=new_layer_Rule.name;t.text=new_layer_Rule.name;
document.getElementById("editL1").appendChild(t);
map.addLayer(new_layer_Rule);
for(var i=0;i<map.layers.length;i++)
{if(map.layers[i].CLASS_NAME=="OpenLayers.Layer.Vector"&&map.layers[i].name!=="OpenLayers.Handler.Path")
{var t=document.createElement('option');
t.value=map.layers[i].name;t.text=map.layers[i].name;document.getElementById("DistMeasureGisa_id").appendChild(t);}
}
}
if(checkMeasDistMain==true)
{document.getElementById("Id_CheckDistMeas").checked=true}
if(checkMeasDistMain==false)
{document.getElementById("Id_CheckDistMeas").checked=false}

});
var save = new OpenLayers.Control.Button({
title: "Сохранить изменения",
trigger: function() {
if(edit.feature) {
edit.selectControl.unselectAll();
}
saveStrategy.save();
},
displayClass: "olControlSaveFeatures"
});
save.events.register("activate", save, function(){if(document.getElementById("editL1").value=="0")
{alert ("Выберите название слоя в списке 'Редактируемый слой'"); save.deactivate();}});
var drag = new OpenLayers.Control.DragFeature(wfs_riv, {
 onStart: startDrag,
 onDrag: doDrag,
 onComplete: endDrag,
displayClass: "olControlDrawFeaturePolygon2"
});
drag.title="Переместить элемент слоя"
var select = new OpenLayers.Control.SelectFeature(wfs_riv, {
 box: true,
 multiple: true,
 onSelect: addSelected,
 onUnselect: clearSelected,
displayClass: "olControlDrawFeaturePolygon3"
});
drag.events.register("activate", drag, function(){if(document.getElementById("editL1").value=="0")
{alert ("Выберите название слоя в списке 'Редактируемый слой'"); drag.deactivate();}});
select.events.register("activate", select, function(){if(document.getElementById("editL1").value=="0")
{alert ("Выберите название слоя в списке 'Редактируемый слой'"); select.deactivate();}});
select.title="Выделить элемент слоя"
function addSelected(feature) {
 selectedFeatures.push(feature);
}
function clearSelected(feature) {
 selectedFeatures = [];
}
function startDrag(feature, pixel) {
 lastPixel = pixel;
}
function doDrag(feature, pixel) {
 for (f in selectedFeatures) {
 if (feature != selectedFeatures[f]) {
 var res = map.getResolution();
 selectedFeatures[f].geometry.move(res * (pixel.x - lastPixel.x), res * (lastPixel.y - pixel.y));
 vectors.drawFeature(selectedFeatures[f]);
 }
 }
 lastPixel = pixel;
}
function endDrag(feature, pixel) {
 for (f in selectedFeatures) {
 f.state = OpenLayers.State.UPDATE;
 }
}
var m3dContAdd = new OpenLayers.Control.Button({
title: "Добавить 3D карту. Глобус. Для работы с 3D-картой используйте следующие инструкции: Двигать вид: щелкните левой кнопкой + перетаскивание; Увеличить изображение: Щелкните правой кнопкой мыши + перетаскивание или Колесо прокрутки мыши. Вращать вид: средняя кнопка мыши + перетаскивание или CTRL + щелчок левой кнопкой мыши + перетаскивание.",
trigger: function() {

var bbox = document.getElementById("map").getBoundingClientRect();
 var body = document.body
 var docElem = document.documentElement
 var scrollTop = window.pageYOffset || docElem.scrollTop || body.scrollTop
 var scrollLeft = window.pageXOffset || docElem.scrollLeft || body.scrollLeft
 var clientTop = docElem.clientTop || body.clientTop || 0
 var clientLeft = docElem.clientLeft || body.clientLeft || 0
 var topTop = bbox.top + scrollTop - clientTop
 var leftLeft = bbox.left + scrollLeft - clientLeft
var DivEditeLeg=document.createElement("div");
DivEditeLeg.id="id_div3dMapMain0";
DivEditeLeg.className="id_divRoutLegMain";
DivEditeLeg.style.position="relative";
DivEditeLeg.innerHTML='<div id="id_id_div3dWebGisLeg0" style="background:#ffffff; color:#0000ff;z-index: 6000;position:absolute;left:'+Math.round(leftLeft+50)+'px;top:'+Math.round(topTop-100)+
'px;overflow:hidden; border: 1px solid black;">'+
'<img onclick="close3dFirstWin()" src="openlayers/theme/default/img/close.gif" style="position:relative; top:10px;float:right; cursor:pointer"><a style="position:relative; top:20px"><br>'+
'<a>Установить размер области 3D карты в пикселях:</a><br>'+
'<a>ширина:</a><input type="text" size="5" id="id_3dOpenWebWidth" value="500"/><br>'+
'<a>высота:</a><input type="text" size="5" id="id_3dOpenWebHeight" value="500"/><br>'+
'<input type="checkbox" id="id_zoom3dCurrent" title="" value="checkbox" checked/>увеличить 3d карту до текущего экстента<br>'+
'<input type="checkbox" id="id_3dJSON" title="" value="checkbox" />дополнительные настройки 3D (добавление высоты) <br>'+
'<div id="dopdiv3djson" style="display:none"></div>'+
'<p> <button type=button onclick=Open3Dmap()>Ok</button>'+
//'<p></p>'+
'</div>';
if(!document.getElementById("id_div3dMapMain0"))
{body.appendChild(DivEditeLeg);
document.getElementById("id_3dJSON").onchange=function (){onchangeid_3dJSON();}
 }
document.getElementById("id_div3dMapMain0").onmousedown=function(event){drags(event)};
document.getElementById("id_div3dMapMain0").onmouseup=function(e){enddrag()};

},
displayClass: "olControl3dFeatures"
});
var OsmBuild = new OpenLayers.Control.Button({
title: "OSM Buildings (OSM здания). Щёлкните для визуализации OpenStreetMaps геометрии зданий на интерактивных картах.'OSM Buildings' создаёт 3D вид зданий по данным OpenStreetMap (OSM) на 2D карте. 'OSM Buildings' не создаёт  настоящую 3D модель но использует   специальную технологию наложения тени для того что бы изображения зданий казались трёхмерными ‘3D’.Copyright (c) 2014, OSM Buildings, Jan Marsch <mail@osmbuildings.org> All rights reserved.",
trigger: function() {
if(!document.getElementById("OSMscript_script_id"))
{var scriptB = document.createElement("script"); 
scriptB.src = 'openlayers/OSMBuildings-OpenLayers.js'; 
 scriptB.type = 'text/javascript'; 
 scriptB.id="OSMscript_script_id";
scriptB.async=false;document.body.appendChild(scriptB)
scriptB.onload= function(){;osmb = new OSMBuildings(map).load();if(map.zoom<=14){alert("Новый слой с именем 'OSM Buildings' был успешно добавлен. Для того что бы увидеть 3D представление зданий OpenStreetMap вы должны увеличить карту до интересующего вас города")}
osmb.click(function(e) {informationOSM(e)});;map.events.listeners.click[map.events.listeners.click.length-1].obj.clickosmowg='clickosmowg';osmb.onMapResize=function(){OSMBonMapResize(osmb)};
};
}
else{ var yesOSMLayer=0;
for(var io=0;io<map.layers.length;io++)
{if(!map.layers[io].customJson&&map.layers[io].attribution&&map.layers[io].attribution=='&copy; <a href="http://osmbuildings.org">OSM Buildings</a>')
{yesOSMLayer=1;} }
if(yesOSMLayer==0){
if(document.getElementById("OSMscript_script_id"))
{document.getElementById("OSMscript_script_id").parentNode.removeChild(document.getElementById("OSMscript_script_id"));OSMBuildings='';}
var scriptB = document.createElement("script"); scriptB.src = 'openlayers/OSMBuildings-OpenLayers.js'; 
 scriptB.type = 'text/javascript';  scriptB.id="OSMscript_script_id";scriptB.async=false;document.body.appendChild(scriptB)
scriptB.onload= function(){
try{osmb = new OSMBuildings(map).load();}catch(e){alert(e)}
osmb.click(function(e) {informationOSM(e)});map.events.listeners.click[map.events.listeners.click.length-1].obj.clickosmowg='clickosmowg';osmb.onMapResize=function(){OSMBonMapResize(osmb)};}

}


}

},
displayClass: "olControlOSMB"
});
var link = new OpenLayers.Control.Button({
title: "Получить ссылку на вашу карту или код для встраивания(добавления) карты в ваш сайт",
trigger: function() {

var bbox = document.getElementById("map").getBoundingClientRect();
 var body = document.body
 var docElem = document.documentElement
 var scrollTop = window.pageYOffset || docElem.scrollTop || body.scrollTop
 var scrollLeft = window.pageXOffset || docElem.scrollLeft || body.scrollLeft
 var clientTop = docElem.clientTop || body.clientTop || 0
 var clientLeft = docElem.clientLeft || body.clientLeft || 0
 var topTop = bbox.top + scrollTop - clientTop
 var leftLeft = bbox.left + scrollLeft - clientLeft
var DivEditeLeg=document.createElement("div");
DivEditeLeg.id="id_divLinkLegMain2";
DivEditeLeg.className="id_divRoutLegMain";
DivEditeLeg.style.position="relative";
DivEditeLeg.innerHTML='<div id="id_divLinkWebGisLeg" style="background:#ffffff; color:#0000ff;z-index: 6000;position:absolute;left:'+Math.round(leftLeft+50)+'px;top:'+Math.round(topTop-120)+
'px;overflow:hidden; border: 1px solid black;"><img onclick="closeLinkWin()" src="openlayers/theme/default/img/close.gif" style="position:relative; top:10px;float:right; cursor:pointer"><a style="position:relative; top:20px"><br>'+
'<a>Вы хотите получить ссылку?</a><br>'+
'<input type="checkbox" id="id_LinkSaveInterface" title="" value="checkbox"/>сохранить интерфейс<input type="checkbox" id="id_LinkSaveErrorNocode" title="Если ссылка или код для встраивания в сайт, созданные вами не работают, то поставьте здесь галочку и заново нажмите кнопку /Да/ или /Да -получить код/" value="checkbox"/><a style="font-size: 11px;">активируйте если ссылка или код встраивания не работает</a><div id=id_saveTimeLinelink></div>'+
'<p> <button title="нажмите чтобы получить ссылку" type=button onclick=GetLinkOpenWebGis()>Да</button><button type=button onclick=closeLinkWin()>Закрыть</button></p>'+
'link:<textarea id="LinkOpenwebgisTextArea" style="width: 300px; height: 40px;font-size:11px"></textarea><br>'+
'<a>Автор:</a><input type="text" size="15" id="id_LinkOpenWebGisAuth" value="name"/><br>'+
'<a>Описание:</a><input type="text" size="35" id="id_LinkOpenWebGisSum" value=""/><br>'+
'<a>Получить код для встраивания(добавления) карты в ваш сайт?</a><br>'+
'<input type="checkbox" id="id_EmbSaveClearMap" title="" value="checkbox"/>только карта <input type="checkbox" id="id_EmbSaveAllSite" title="Вы получите код для встраивания всего интерфейса OpenWebGIS в ваш сайт. Установите ширину и высоту в пикселах охвата интерфейса." value="checkbox"/>весь сайт:<a>ширина:</a><input type="text" size="3" id="id_EmbedClearsite_w" value="800"/><a>высота:</a><input type="text" size="3" id="id_EmbedClearsite_h" value="600"/><br>'+
'<button title="нажмите, чтобы получить код" type=button onclick=GetEmbedOpenWebGis()>Да- получить код</button><br>'+
'код для добавления:<textarea id="EmbedOpenwebgisTextArea" style="width: 300px; height: 30px;font-size:11px"></textarea>'+
'</div>';
if(!document.getElementById("id_divLinkWebGisLeg"))
{body.appendChild(DivEditeLeg); }
document.getElementById("id_divLinkLegMain2").onmousedown=function(event){drags(event)};
document.getElementById("id_divLinkLegMain2").onmouseup=function(e){enddrag()};
if(document.getElementById("id_TimeLineLegMain2"))
{var timesli=document.createElement('input');timesli.id='timsaveTimeLinelink';timesli.type='checkbox';document.getElementById("id_saveTimeLinelink").appendChild(timesli);var timeslia=document.createElement('a');timeslia.innerHTML="сохранить шкалу времени";document.getElementById("id_saveTimeLinelink").appendChild(timeslia);}

},
displayClass: "olControlLinkFeatures"
});
var GetGeoloc = new OpenLayers.Control.Button({
title: "Геолокация. Щёлкните чтобы увидеть ваше, или чьё-либо другое местоположение на карте",
trigger: function() {
creatDialogGeolocation();
},
displayClass: "olControlGeoLoc"
});
 panel.addControls(
 [new OpenLayers.Control.Navigation(),drawLine,drawPoint,drawPolygon,save,drag,select,edit,del,rout,drawLineRule,drawPolygonSq,link,OsmBuild,GetGeoloc,m3dContAdd]
 );
var EditLayerList;
 var defaultEditLayerList = {
 url: "/geoserver/wfs?",
 geometryName: "the_geom"
 };

var mLayers=map.layers;
 for(var ab = 0; ab < mLayers.length; ab++ )
{if(mLayers[ab].isBaseLayer==false){var t=this.document.createElement('option');
t.value=mLayers[ab].name;
t.text=mLayers[ab].name;
this.document.getElementById("editL1").appendChild(t);}}

 map.addControl(panel);
for(var pa=0;pa<panel.controls.length;pa++){panel.controls[pa].panel_div.style.cursor="pointer";}
var mLayers = map.layers;
for(var aa = 0; aa < mLayers.length; aa++ )
{if (mLayers[aa].name=="Страны"){ edilayerMainLayer=mLayers[aa];} }
highlightCtrl = new OpenLayers.Control.SelectFeature(edilayerMainLayer, {
 hover: true,
 highlightOnly: true,
 renderIntent: "temporary",
 });
 selectCtrl = new OpenLayers.Control.SelectFeature(edilayerMainLayer,
 {clickout: true}
 );
 map.addControl(highlightCtrl);
 map.addControl(selectCtrl);
 highlightCtrl.activate();
 selectCtrl.activate();
map.addControl(new OpenLayers.Control.Attribution());
if(typeof window.location.search.split('?openwebgis=')[1]!=='undefined'&&window.location.search.split('?openwebgis=')[1].length>0)
{var strlink=window.location.search.split('?openwebgis=')[1];


if(strlink!=='')
{try {var xmlhttp =new XMLHttpRequest();}
catch (e) {alert("error");}
xmlhttp.open('GET','/temp.php?l='+strlink+'&rand='+Math.random(), true);
xmlhttp.setRequestHeader("Cache-Control", "no-cache");
xmlhttp.setRequestHeader("Content-type", "text/xml");
xmlhttp.onreadystatechange = function()
{if(xmlhttp.readyState == 4&&xmlhttp.status == 200) {
if(xmlhttp==''){alert("нет данных");return;}
var varlinkres=xmlhttp.responseText;
if(varlinkres!=='')
{

if( varlinkres.split(" noCodeOpenWebGISlzw ")[1])
{localStorageOpenWebGIS=varlinkres;}
else{localStorageOpenWebGIS=lzw_decode(varlinkres);}
loadfree=true;LoadProject(loadfree);}



}}
alert("Эта функция работает только в онлайн веб-версии OpenWebGIS")
{return;xmlhttp.send(null);}

localStorageOpenWebGIS='';}
}

}
function lzw_encode(s) {
var dict = {};
var data = (s + "").split("");
var out = [];
var currChar;
var phrase = data[0];
//var code = 256;
var code = 1300;
for (var i=1; i<data.length; i++) {
currChar=data[i];
if (dict[phrase + currChar] != null) {
phrase += currChar;
}
else {
out.push(phrase.length > 1 ? dict[phrase] : phrase.charCodeAt(0));
dict[phrase + currChar] = code;
code++;
phrase=currChar;
}
}
out.push(phrase.length > 1 ? dict[phrase] : phrase.charCodeAt(0));
for (var i=0; i<out.length; i++) {
out[i] = String.fromCharCode(out[i]);
}
return out.join("");

}
// Decompress an LZW-encoded string
function lzw_decode(s) {
var dict = {};
var data = (s + "").split("");
var currChar = data[0];
var oldPhrase = currChar;
var out = [currChar];
var code = 1300;
var phrase;
for (var i=1; i<data.length; i++) {
var currCode = data[i].charCodeAt(0);
if (currCode < 1300) {
phrase = data[i];
}
else {
phrase = dict[currCode] ? dict[currCode] : (oldPhrase + currChar);
}
out.push(phrase);
currChar = phrase.charAt(0);
dict[code] = oldPhrase + currChar;
code++;
oldPhrase = phrase;
}
return out.join("");
}
function comp(uncompressed) {
var i,
dictionary = {},
c,
wc,
w = "",
result = [],
dictSize = 256;
for (i = 0; i < 256; i += 1) {
dictionary[String.fromCharCode(i)] = i;
}
rtt=dictionary;

for (i = 0; i < uncompressed.length; i += 1) {

try{c = uncompressed.charAt(i)}catch(e){rtt=uncompressed;alert("error");};
wc = w + c;
if (dictionary.hasOwnProperty(wc)) {
w = wc;
} else {
result.push(dictionary[w]);
dictionary[wc] = dictSize++;
w = String(c);
}
}
 
if (w !== "") {
result.push(dictionary[w]);
}

return result;
}

function getRandomArbitary()
{
  return parseInt(Math.random() * (32 - 0) + 0);
}
function comp2(compressed) {
        "use strict";
        // Build the dictionary.
        var i,
            dictionary = [],
            w,
            result,
            k,
            entry = "",
            dictSize = 256;
        for (i = 0; i < 256; i += 1) {
            dictionary[i] = String.fromCharCode(i);
        }
 
        w = String.fromCharCode(compressed[0]);
        result = w;
        for (i = 1; i < compressed.length; i += 1) {
            k = compressed[i];
            if (dictionary[k]) {
                entry = dictionary[k];
            } else {
                if (k === dictSize) {
                    entry = w + w.charAt(0);
                } else {
                    return null;
                }
            }
 
            result += entry;
 
            // Add w+entry[0] to the dictionary.
            dictionary[dictSize++] = w + entry.charAt(0);
 
            w = entry;
        }
        return result;
    }
function addSelectBaseType(layer,labelSpan)
{
if(layer.name=="Google Maps....")
{var sel=document.createElement("select");
sel.id = 'selGoggletypOpenGis';
sel.title= "select type of Google map";
var option = document.createElement('option');
option.value = 'satellite';
option.text = 'satellite';
sel.appendChild(option);
var option = document.createElement('option');
option.value = 'roadmap';
option.text = 'roadmap';
sel.appendChild(option);

var option = document.createElement('option');
option.value = 'hybrid';
option.text = 'hybrid';
sel.appendChild(option);
var option = document.createElement('option');
option.value = 'terrain';
option.text = 'terrain';
sel.appendChild(option);

labelSpan.parentNode.appendChild(sel);
sel.onchange=function(){ChangeGooglType(layer);}
document.getElementById("selGoggletypOpenGis").onclick=function(){OpenLayers.Event.stopObservingElement(document.getElementById("external_control2"));document.getElementById("selGoggletypOpenGis").focus();}
}
if(layer.name=="OpenStreetMap")
{
var sel=document.createElement("select");
sel.id = 'selOSMtypOpenGis';
sel.title= "select type of OSM map";
var option = document.createElement('option');
option.value = 'http://tile.openstreetmap.org/${z}/${x}/${y}.png';
option.text = 'standart';
sel.appendChild(option);
var option = document.createElement('option');
option.value = 'http://a.tile.opencyclemap.org/cycle/${z}/${x}/${y}.png';
option.text = 'cycle';
sel.appendChild(option);

var option = document.createElement('option');
option.value = 'http://a.tile2.opencyclemap.org/transport/${z}/${x}/${y}.png';
option.text = 'transport';
sel.appendChild(option);
var option = document.createElement('option');
option.value = 'http://otile1.mqcdn.com/tiles/1.0.0/osm/${z}/${x}/${y}.png';
option.text = 'mapquest';
sel.appendChild(option);
var option = document.createElement('option');
option.value = 'http://a.tile.openstreetmap.fr/hot/${z}/${x}/${y}.png';
option.text = 'humanitarian';
sel.appendChild(option);

labelSpan.parentNode.appendChild(sel);
sel.onchange=function(){ChangeOSMType(layer);}
document.getElementById("selOSMtypOpenGis").onclick=function(){OpenLayers.Event.stopObservingElement(document.getElementById("external_control2"));document.getElementById("selOSMtypOpenGis").focus();}

}

}
function ChangeOSMType(layer)
{
layer.url=document.getElementById("selOSMtypOpenGis").value;

if(document.getElementById("selOSMtypOpenGis").value=='http://otile1.mqcdn.com/tiles/1.0.0/osm/${z}/${x}/${y}.png')
{layer.attribution="© <a href='http://www.openstreetmap.org/'>OpenStreetMap</a> and contributors, under an <a href='http://www.openstreetmap.org/copyright' title='ODbL'>open license</a>. Tiles Courtesy of <a href='http://www.mapquest.com/'>MapQuest</a> <img src='http://developer.mapquest.com/content/osm/mq_logo.png'>"}
if(document.getElementById("selOSMtypOpenGis").value=='http://tile.openstreetmap.org/${z}/${x}/${y}.png')
{layer.attribution="© <a href='http://www.openstreetmap.org/copyright'>OpenStreetMap</a> contributors";}
if(document.getElementById("selOSMtypOpenGis").value=='http://a.tile2.opencyclemap.org/transport/${z}/${x}/${y}.png')
{layer.attribution="© <a href='http://www.openstreetmap.org/copyright'>OpenStreetMap</a> contributors. Tiles courtesy of <a href='http://www.thunderforest.com/'>Andy Allan</a>";}
if(document.getElementById("selOSMtypOpenGis").value=='http://a.tile.openstreetmap.fr/hot/${z}/${x}/${y}.png')
{layer.attribution="© <a href='http://www.openstreetmap.org/'>OpenStreetMap</a> and contributors, under an <a href='http://www.openstreetmap.org/copyright' title='ODbL'>open license</a>. Humanitarian style by <a href='http://hot.openstreetmap.org'>H.O.T.</a>";}
if(document.getElementById("selOSMtypOpenGis").value=='http://a.tile.opencyclemap.org/cycle/${z}/${x}/${y}.png')
{layer.attribution="© <a href='http://www.openstreetmap.org/copyright'>OpenStreetMap</a> contributors. Tiles courtesy of <a href='http://www.thunderforest.com/'>Andy Allan</a>";}
layer.redraw();

for(var i=0;i<map.controls.length;i++)
{if(map.controls[i].CLASS_NAME=="OpenLayers.Control.Attribution"){map.controls[i].updateAttribution();}}

}
function ChangeGooglType(layer)
{
layer.type=document.getElementById("selGoggletypOpenGis").value;
layer.redraw();
}
 function setHTML(response){
 document.getElementById('nodelist').innerHTML = response.responseText;
 };
 function toggleControlPanel(event){
 var toolbar = document.getElementById("toolbar");
var toolbar2 = document.getElementById("dragToolbar_opt");
 if (toolbar.style.display == "none") {
 toolbar.style.display = "block";
toolbar2.style.display = "block";
 }
 else {
 toolbar.style.display = "none";
toolbar2.style.display = "none";
 }
 event.stopPropagation();
 map.updateSize()
 }
 function setTileMode(tilingMode){
 if (tilingMode == 'ams2') {
 ams.setVisibility(false);
 ams2.setVisibility(true);
 }
 else {
 ams.setVisibility(true);
 ams2.setVisibility(false);
 }
 }
 function setTransitionMode(transitionEffect){
 if (transitionEffect === 'resize') {
 ams2.transitionEffect = transitionEffect;
 ams.transitionEffect = transitionEffect;
 }
 else {
 ams2.transitionEffect = null;
 ams.transitionEffect = null;
 }
 }
 function setImageFormat(mime){
var mLayers=map.layers;
 for(var ab = 0; ab < mLayers.length; ab++ )
{
if(mLayers[ab].name==edilayerMainLayer.name+'_Interpolation')
{
 if( mLayers[ab] == null)
 return;
 mLayers[ab].mergeNewParams({
 format: mime
 });
}
 }//end for(var ab = 0;

 }
function setImageFormat2(inter){
var mLayers=map.layers;
 for(var ab = 0; ab < mLayers.length; ab++ )
{
if(mLayers[ab].name==edilayerMainLayer.name+'_Interpolation')
{
 if( mLayers[ab] == null)
 return;
 mLayers[ab].mergeNewParams({
 INTERPOLATION_STRATEGY: inter
 });
}
 }//end for(var ab = 0;
}
function setSimplify(simpl){
var mLayers=map.layers;
 for(var ab = 0; ab < mLayers.length; ab++ )
{
if(mLayers[ab].name==edilayerMainLayer.name+'_Interpolation')
{
 if( mLayers[ab]== null)
 return;
 mLayers[ab].mergeNewParams({
 SIMPLIFY_METHOD: simpl
 });
 }
 }//end for(var ab = 0;
}
function SetRendererType(render_inter)
{
var mLayers=map.layers;
 for(var ab = 0; ab < mLayers.length; ab++ )
{
if(mLayers[ab].name==edilayerMainLayer.name+'_Interpolation')
{
 if( mLayers[ab]== null)
 return;
 mLayers[ab].mergeNewParams({
 RENDERER_TYPE: render_inter
 });
 }
 }//end for(var ab = 0;
}
 function setStyle(style){
 if(ams2 == null)
 return;
 ams2.mergeNewParams({
 styles: style
 });
 ams.mergeNewParams({
 styles: style
 });
 }
 function setAntialiasMode(mode){
 ams2.mergeNewParams({
 format_options: 'antialias:' + mode
 });
 ams.mergeNewParams({
 format_options: 'antialias:' + mode
 });
 }
 function setPalette(mode){
 if (mode == '') {
 ams2.mergeNewParams({
 palette: null
 });
 ams.mergeNewParams({
 palette: null
 });
 }
 else {
 ams2.mergeNewParams({
 palette: mode
 });
 ams.mergeNewParams({
 palette: mode
 });
 }
 }
 function setWidth(size){
 var mapDiv = document.getElementById('map');
 var wrapper = document.getElementById('wrapper');
 if (size == "auto") {
 mapDiv.style.width = null;
 wrapper.style.width = null;
 }
 else {
 mapDiv.style.width = size + "px";
 wrapper.style.width = size + "px";
 }
 map.updateSize();
 }
 function setHeight(size){
 var mapDiv = document.getElementById('map');
 if (size == "auto") {
 mapDiv.style.height = null;
 }
 else {
 mapDiv.style.height = size + "px";
 }
 map.updateSize();
 }
function EditmapSizeFree()
{
var mapDiv = document.getElementById('map');
var hei=document.getElementById('heightSelectorInput_web').value;
var wid=document.getElementById('widthSelectorInput_web').value;
if(isNaN(parseFloat(hei))||isNaN(parseFloat(wid))){alert("error in value");return;}
mapDiv.style.height = hei + "px";
mapDiv.style.width = wid + "px";
map.updateSize();
}
 function updateFilter(){
if(this.document.getElementById("editL1").value=="0")
{alert ("Выберете название слоя в списке 'Редактируемый слой'"); return;}
var format = new OpenLayers.Format.CQL();

                if(pureCoverage)
                  return;
                 var filterType = document.getElementById('filterType').value;
                var filter = document.getElementById('filter').value;
                
                // by default, reset all filters
                var filterParams = {
                    filter: null,
                    cql_filter: null,
                    featureId: null
                };
                if (OpenLayers.String.trim(filter) != "") {
                    if (filterType == "cql") 
                        filterParams["cql_filter"] = filter;
                    if (filterType == "ogc") 
                        filterParams["filter"] = filter;
                    if (filterType == "fid") 
                        filterParams["featureId"] = filter;
                }
                // merge the new filter definitions
                mergeNewParams(filterParams);
//var rule = new OpenLayers.Rule({  });
if(edilayerMainLayer.styleMap.styles.default.rules[0]&&edilayerMainLayer.styleMap.styles.default.rules[0].filter.property)
{filterStartG2=1;filterStartGArr2=[];}
var rule2 = new OpenLayers.Rule({
    name: "date",
    filter: new OpenLayers.Filter.Logical({
        type: OpenLayers.Filter.Logical.AND,
        filters: [
        ]
    }) ,symbolizer: {
                   pointRadius: 3,fillColor: "#FFFF3F",
                strokeColor: "#666666", strokeWidth: 1,
                fillOpacity:1,strokeOpacity:1
    }    
    });
if(filterStartG2==1)
{var arF=filterStartGArr2;
if(arF&&arF.length==0)
{for(var ghi=0;ghi<edilayerMainLayer.styleMap.styles.default.rules.length;ghi++)
{var parserF = new OpenLayers.Format.Filter();
var filter1 = parserF.write(edilayerMainLayer.styleMap.styles.default.rules[ghi].filter);
var filter1 = parserF.read(filter1);
arF.push(filter1)}}
for(var f=0;f<arF.length;f++)
{var parserF = new OpenLayers.Format.Filter();
var filter1 = parserF.write(rule2.filter);
var filterRul2 = parserF.read(filter1);
edilayerMainLayer.styleMap.styles.default.rules[f].filter=filterRul2;
var filterInput=format.read(filter);
edilayerMainLayer.styleMap.styles.default.rules[f].filter.filters.push(filterInput);

edilayerMainLayer.styleMap.styles.default.rules[f].filter.filters.push(arF[f]);
}
edilayerMainLayer.redraw();

}
else{
var rule2 = new OpenLayers.Rule({
 title:"jkkkkk",
 symbolizer: {
 pointRadius: 3,
 fillColor: "#FFFF3F",
 strokeColor: "#666666",
 strokeWidth: 1,
 fillOpacity:1,
 strokeOpacity:1
 } 
});

rule2.filter=format.read(filter);
//edilayerMainLayer.styleMap.styles.default=new OpenLayers.Style(null, {rules: [rule2]});
edilayerMainLayer.styleMap.styles.default.rules=[rule2];
edilayerMainLayer.redraw();
}

            }
            
function resetFilter() {
if(pureCoverage)
return;
    if(filterStartG2==10)
{

}              
else{                  
           if(edilayerMainLayer.styleMap.styles.default.rules&&edilayerMainLayer.styleMap.styles.default.rules.length>1)
           {if(edilayerMainLayer.styleMap.styles.default.rules[0].filter.filters)
           {
           for(var ghi=0;ghi<edilayerMainLayer.styleMap.styles.default.rules.length;ghi++)
{edilayerMainLayer.styleMap.styles.default.rules[ghi].filter=edilayerMainLayer.styleMap.styles.default.rules[ghi].filter.filters[1]}
           }
           else
           {}
           }
           else{}
           if(edilayerMainLayer.styleMap.styles.default.rules.length==1){edilayerMainLayer.styleMap.styles.default.rules=[]}
           filterStartG2=0; filterStartGArr2=[];
}
edilayerMainLayer.redraw();

            //    updateFilter();
            }
 function mergeNewParams(params){
 ams2.mergeNewParams(params);
 ams.mergeNewParams(params);
}
 function updateSZ(sz){
 if(pureCoverage)
 return;
 var mLayers=map.layers;
 for(var ab = 0; ab < mLayers.length; ab++ )
{
if(mLayers[ab].name==edilayerMainLayer.name+'_Interpolation')
{
 sz = document.getElementById('SZ').value;
 mLayers[ab].mergeNewParams({SIMPLIFY_SIZE:sz});
}//end if
}
 }
 function updateIntervals(){
 if(pureCoverage)
 return;
 var mLayers=map.layers;
 for(var ab = 0; ab < mLayers.length; ab++ )
{
if(mLayers[ab].name==edilayerMainLayer.name+'_Interpolation')
{
 intervals = document.getElementById('INTERVALS[]').value;
 mLayers[ab].mergeNewParams({'INTERVALS[]':intervals});
}//end if
}
 }
 function updateRadius(radius_inter){
 if(pureCoverage)
 return;
 var mLayers=map.layers;
 for(var ab = 0; ab < mLayers.length; ab++ )
{
if(mLayers[ab].name==edilayerMainLayer.name+'_Interpolation')
{
 radius_inter = document.getElementById('Radius_inter').value;
 mLayers[ab].mergeNewParams({RADIUS:radius_inter});
}//end if
}
 }
function clearSelecWin1()
{document.getElementById("CQLfilter_id_Web").value='';resetFilter2();}

function closeSelecWin()
{
document.getElementById("id_divSelecMain2").parentNode.removeChild(document.getElementById("id_divSelecMain2"));
}
function clearRoutWin1()
{document.getElementById("RoutId_start").value='';}
function clearRoutWin2()
{document.getElementById("RoutId_end").value='';}
function closeSelectLenAreaWin()
{document.getElementById("id_div"+"ControlSelectLenArea_id"+"2").parentNode.removeChild(document.getElementById("id_div"+"ControlSelectLenArea_id"+"2"));
selectLenAreaMain.deactivate();}
function closeMeasureSqWin()
{
document.getElementById("id_divControlmeasureGisSq2").parentNode.removeChild(document.getElementById("id_divControlmeasureGisSq2"));
drawPolygonSqMain.deactivate();
}
function DeleteSelectedControl()
{for (var i=0;i<edilayerMainLayer.selectedFeatures.length;i++)
{var feature2=edilayerMainLayer.selectedFeatures[i];
//edilayerMainLayer.destroyFeatures([feature2]); 
if(feature2.fid == undefined) {edilayerMainLayer.destroyFeatures([feature2]);i=i-1;} 
else {feature2.state = OpenLayers.State.DELETE;edilayerMainLayer.events.triggerEvent("afterfeaturemodified",{feature2: feature2});
feature2.style ={ fillColor: "red", strokeColor: "red", fillOpacity: 0.2, strokeOpacity: 0.3,display:"none"}
edilayerMainLayer.drawFeature(feature2);}
}
}
function closeDelSelConWin(del)
{
document.getElementById("id_divControlDel2").parentNode.removeChild(document.getElementById("id_divControlDel2"));
del.deactivate();
}
function closeMeasureWin()
{
document.getElementById("id_divControlmeasureGis2").parentNode.removeChild(document.getElementById("id_divControlmeasureGis2"));
drawLineRuleMain.deactivate();
}
function close3dFirstWin()
{document.getElementById("id_div3dMapMain0").parentNode.removeChild(document.getElementById("id_div3dMapMain0"));}
function closeGeoLocFirstWin()
{document.getElementById("id_divMyLocation").parentNode.removeChild(document.getElementById("id_divMyLocation"));if(intervaTimeGeoLoc){clearInterval(intervaTimeGeoLoc);intervaTimeGeoLoc=0;}
for(var b=0;b<intervaTimeLocateOthArray.length;b++){clearInterval(intervaTimeLocateOthArray[b]);}intervaTimeLocateOthArray=[];
}
function close3dMapWin()
{document.getElementById("id_div3dMapMain2").parentNode.removeChild(document.getElementById("id_div3dMapMain2"));primitive3D=[];wmsArray3d=[];globalwidg3dowg=0;globalwidg3dEntity=0;globalwidg3dWMS=0;}
function close3dSkyWin()
{document.getElementById("id_div3dSky2").parentNode.removeChild(document.getElementById("id_div3dSky2"));}
function closeLinkWin()
{document.getElementById("id_divLinkLegMain2").parentNode.removeChild(document.getElementById("id_divLinkLegMain2"));}
function closeWearherLegendWin(win)
{win.parentNode.parentNode.parentNode.removeChild(win.parentNode.parentNode);}

function closePointPolWin()
{document.getElementById("id_divPointPolLegMain2").parentNode.removeChild(document.getElementById("id_divPointPolLegMain2"));}
function closeTableImageWin()
{document.getElementById("id_divTableImage").parentNode.removeChild(document.getElementById("id_divTableImage"));}
function closeGeoMathpopUpWin()
{document.getElementById("id_divPopGeoMLegMain2").parentNode.removeChild(document.getElementById("id_divPopGeoMLegMain2"));}
function closeWMSpopUpWin()
{document.getElementById("id_divWMSLegMain2").parentNode.removeChild(document.getElementById("id_divWMSLegMain2"));}
function closeFileurlWin()
{document.getElementById("id_FileUrlLegMain2").parentNode.removeChild(document.getElementById("id_FileUrlLegMain2"));}
function closeTimeLineWin()
{if(typeof intervaTime!=="undefined"){clearInterval(intervaTime)}; 
if(stoprotateWebGisRul.length>0){var reload=2;reloadEdiLaPlayRotate(reload);for(var ty=0;ty<stoprotateWebGisRul.length;ty++)
{clearInterval(stoprotateWebGisRul[ty]);}} 
document.getElementById("id_TimeLineLegMain2").parentNode.removeChild(document.getElementById("id_TimeLineLegMain2"));}
function closeFishFaoWin()
{document.getElementById("id_FAObasLegMain2").parentNode.removeChild(document.getElementById("id_FAObasLegMain2"));}
function closeSumKvadrLLegWin()
{document.getElementById("id_SumKvadrLLegMain2").parentNode.removeChild(document.getElementById("id_SumKvadrLLegMain2"));}
function closePaleoBioWin()
{document.getElementById("id_PaleBioLegMain2").parentNode.removeChild(document.getElementById("id_PaleBioLegMain2"));}
function closeImageFileWin()
{document.getElementById("id_divImageFileLegMain2").parentNode.removeChild(document.getElementById("id_divImageFileLegMain2"));
for(var i=0;i<map.controls.length;i++){if(map.controls[i].title=="click to get coordinates of ImageLayer"){ map.controls[i].destroy();}} delete OpenLayers.Control.Click;
}
function closeImageFileWin2()
{document.getElementById("id_divImageFileURLLegMain2").parentNode.removeChild(document.getElementById("id_divImageFileURLLegMain2"));
for(var i=0;i<map.controls.length;i++){if(map.controls[i].title=="click to get coordinates of ImageLayer URL"){ map.controls[i].destroy();}} delete OpenLayers.Control.Click;
}
function closeSatelliteWin2()
{document.getElementById("id_divISSLegMain2").parentNode.removeChild(document.getElementById("id_divISSLegMain2"));
for(var b=0;b<intervaTimeSpaceArray.length;b++){clearInterval(intervaTimeSpaceArray[b]);}intervaTimeSpaceArray=[];
for(var ff=0;ff<map.layers.length;ff++)
{if(map.layers[ff].SateliteString1){delete map.layers[ff].SateliteString1; delete map.layers[ff].SateliteString2;delete map.layers[ff].SatelName;}}
}
function closeEarthQWin()
{document.getElementById("id_EarthQLegMain2").parentNode.removeChild(document.getElementById("id_EarthQLegMain2"));
for(var i=0;i<map.controls.length;i++){if(map.controls[i].title=="click to get coordinates for EarthQuake"){ map.controls[i].destroy();}} delete OpenLayers.Control.Click;
}
function closeSSAWin()
{document.getElementById("id_SSALegMain2").parentNode.removeChild(document.getElementById("id_SSALegMain2"));}
function closeCorrWin()
{document.getElementById("id_CorrLegMain2").parentNode.removeChild(document.getElementById("id_CorrLegMain2"));}
function closeFractWin()
{document.getElementById("id_FractLegMain2").parentNode.removeChild(document.getElementById("id_FractLegMain2"));}
function closeSSAWin2()
{document.getElementById("id_SSA2LegMain2").parentNode.removeChild(document.getElementById("id_SSA2LegMain2"));}
function closeOSMLayWin()
{document.getElementById("id_divOSMLayMain2").parentNode.removeChild(document.getElementById("id_divOSMLayMain2"));}
function closeRoutWin()
{for(var i=0;i<map.controls.length;i++){if(map.controls[i].title=="click to routing"){ map.controls[i].destroy();}} delete OpenLayers.Control.Click;
document.getElementById("id_divRoutLegMain2").parentNode.removeChild(document.getElementById("id_divRoutLegMain2"));
for(var l=0;l<map.layers.length;l++)
{if(map.layers[l].name=='MarkersRout'&&map.layers[l].CLASS_NAME=='OpenLayers.Layer.Markers'){map.layers[l].destroy();}}
}
function SetNameLayerListAsName()
{
var StrConnect=''; var StrConnect2='';
 var seldel = document.getElementById("SelectorAddLayer");
 while (seldel.childNodes.length) {
 if (seldel.firstChild.tagName == 'OPTGROUP') {
 while (seldel.firstChild.childNodes.length) {
 seldel.firstChild.removeChild(seldel.firstChild.firstChild);
 }
 }
 seldel.removeChild(seldel.firstChild);
 }
 var t=document.createElement('option');
t.value="0";
t.text=".";
document.getElementById("SelectorAddLayer").appendChild(t);
 var WFSLayerList;
 var defaultWFSProperty = {
 url: "/geoserver/wfs?",
 featureNS: "http://localhost:8080/data/webgis/curonian",
 geometryName: "the_geom"
 };
 alert("Эта функция работает только в онлайн веб-версии OpenWebGIS")
 { return;OpenLayers.Request.GET({
 url: defaultWFSProperty.url+'SERVICE=WFS&VERSION=1.1.0&REQUEST=GetCapabilities',
 async: false,
 success: function(e) {
 WFSLayerList = new OpenLayers.Format.WFSCapabilities().read(e.responseText);
 }
 }); }
 WFSLayerList.featureTypeList.featureTypes.forEach(function(l) {
var s1 =l.featureNS;
if(document.getElementById("NameAsAbstract").checked==true)
{var s2=l.abstract;} else{var s2=l.name;}
if(document.getElementById("id_LayerUserName")&&document.getElementById("id_LayerUserName").checked==true)
{if(GlobalUN!==''){StrConnect="http://localhost:8080/data/"+GlobalUN+"/"+GlobalUN;StrConnect2=GlobalUN;}}
else{ StrConnect="http://localhost:8080/data/webgis/curonian";StrConnect2='webgis';}
if(s1==StrConnect)
{ var t=document.createElement('option');
t.value=s2;
t.text=s2;
document.getElementById('SelectorAddLayer').appendChild(t);
}
 });
var layCount=document.getElementById('SelectorAddLayer').length;
 var defaultWMSProperty = {
 url: "/geoserver/wms?",
 featureNS: StrConnect,
 geometryName: "the_geom"
 };
var wmsL = new OpenLayers.Format.WMSCapabilities();
 alert("Эта функция работает только в онлайн веб-версии OpenWebGIS")
 {return;
OpenLayers.Request.GET({
url:defaultWMSProperty.url+'SERVICE=WMS&request=GetCapabilities',
success: function(e){
var response = wmsL.read(e.responseText);
var capability = response.capability;
for (var i=0, len=capability.layers.length; i<len; i++) { 
 var layerObj = capability.layers[i];
if(layerObj.name.split(':')[0]==StrConnect2)
{ var counter=0;
for (var ii=0;ii<layCount;ii++)
{ 
if(document.getElementById('SelectorAddLayer')[ii].value==layerObj.name.split(':')[1])
{counter=1; }else{if(ii==layCount-1&&counter!=1){ var t=document.createElement('option');t.value=layerObj.name.split(':')[1]+"_WMSLayer";t.text=layerObj.name.split(':')[1];
document.getElementById('SelectorAddLayer').appendChild(t);
}}
}
}
}
}
}); }
}
function WaitWindow()
{
popup_Wait = new OpenLayers.Popup.FramedCloud("WaitPopup",
 map.getCenter(),
 new OpenLayers.Size(100,100),
 "<div style='color:#000080;'>Подождите...<div>" ,
 null, true, onPopupClose);
 map.addPopup(popup_Wait);
}
function addLayer(map){

var bbox = document.getElementById("mapResize").parentNode.getBoundingClientRect();
bbox.top=0;
bbox.left=0;
 var body = document.body
 var docElem = document.documentElement
 var scrollTop = window.pageYOffset || docElem.scrollTop || body.scrollTop
 var scrollLeft = window.pageXOffset || docElem.scrollLeft || body.scrollLeft
 var clientTop = docElem.clientTop || body.clientTop || 0
 var clientLeft = docElem.clientLeft || body.clientLeft || 0
 var topTop = bbox.top + scrollTop - clientTop
 var leftLeft = bbox.left + scrollLeft - clientLeft
var DivEditeLeg=document.createElement("div");
DivEditeLeg.id="id_divAddLayer2";
DivEditeLeg.style.width=600;
DivEditeLeg.style.height=400;
DivEditeLeg.className="id_divAddLayer";
DivEditeLeg.style.position="absolute";

DivEditeLeg.style.left=Math.round(document.body.clientWidth/2-300);
DivEditeLeg.style.top=Math.round(document.body.clientHeight/2-200);
DivEditeLeg.innerHTML='<div id="id_divControlAddLayerLeg" style="background:#ffffff; color:#0000ff;z-index: 600000;position:relative;'+
'px;overflow:hidden; border: 1px solid black; width:600px;height:200px;"><img onclick="closeAddLayerWin()" src="openlayers/theme/default/img/close.gif" style="position:relative; top:3px left:50px;float:right; cursor:pointer"><a style="position:relative; top:20px"></a>'+'<div id="id_divControlAddLayerLeg2" style="top:10px;position:relative"></div>'+'</div>';

var htmlRemL='<a>.Добавить слой</a><br><li> <a>Список слоев:</a>'+
'<select id="SelectorAddLayer" onchange="setSelAdd(value)"><br>'+
' <option value="0">.</option> </select> </li>';
 var StrStr='';
 if(GlobalUN!=='')
{StrStr="<br><input type='checkbox' id='id_LayerUserName' title='' onchange='setLayerUserName()' value='checkbox'/>Показать слои "+GlobalUN+"<br>";}
htmlRemL+="<br><input type='checkbox' id='LayerAsBase' title='Для того что бы сделать слой базовым: Вы должны поставить галочку напротив этой опции и только потом выбрать интересующий Вас слой' onchange='setLayer_Base()' value='checkbox'/>Сделать слой базовым<br>";
 if(GlobalUN!=='')
{htmlRemL+=StrStr;}
htmlRemL+="<br><input type='checkbox' id='NameAsAbstract' title='Set name of layer in list from abstract or name (for WMS layers always set name in list, but load in Layer Switcher by layer abstract)' onchange='setSelAdd2()' value='checkbox'/>Set name in list from abstract or name <br>";
htmlRemL+="<div> <p>";
htmlRemL+=' <button type="button" onclick="AddLayerOK()">OK</button></p></div>' ;
htmlRemL+="<center><font size=+3>";
htmlRemL+="</font></center>";
if(!document.getElementById("id_divControlAddLayerLeg"))
{body.appendChild(DivEditeLeg);document.getElementById("id_divControlAddLayerLeg2").innerHTML=htmlRemL;MarkAsBaseLayer=false; }
document.getElementById("id_divAddLayer2").onmousedown=function(event){drags(event)};
document.getElementById("id_divAddLayer2").onmouseup=function(e){enddrag()};
var StrConnectLayer=''; var StrConnectLayer2='';
StrConnectLayer="http://localhost:8080/data/webgis/curonian";StrConnectLayer2='webgis';
var WFSLayerList;
 var defaultWFSProperty = {
 url: "/geoserver/wfs?",
 featureNS: StrConnectLayer,
 geometryName: "the_geom"
 };
  alert("Эта функция работает только в онлайн веб-версии OpenWebGIS")
 {return;
 OpenLayers.Request.GET({
 url: defaultWFSProperty.url+'SERVICE=WFS&VERSION=1.1.0&REQUEST=GetCapabilities',
 async: false,
 success: function(e) {
 WFSLayerList = new OpenLayers.Format.WFSCapabilities().read(e.responseText);
 }
 }); }
 WFSLayerList.featureTypeList.featureTypes.forEach(function(l) {
 window[l.name] = new OpenLayers.Layer.Vector(l.abstract, {
 strategies: [new OpenLayers.Strategy.Fixed(), new OpenLayers.Strategy.Save()],
 visibility: false,
projection : new OpenLayers.Projection("EPSG:4326"),
 protocol: new OpenLayers.Protocol.WFS(OpenLayers.Util.applyDefaults({featureType: l.name}, defaultWFSProperty))
 });
var s1 =l.featureNS;
var s2=l.name;
if(s1==StrConnectLayer)
{ var t=document.createElement('option');
t.value=s2;
t.text=s2;
document.getElementById('SelectorAddLayer').appendChild(t);
}
 });
var layCount=document.getElementById('SelectorAddLayer').length;
 var defaultWMSProperty = {
 url: "/geoserver/wms?",
 featureNS: StrConnectLayer,
 geometryName: "the_geom"
 };
var wmsL = new OpenLayers.Format.WMSCapabilities();
 alert("Эта функция работает только в онлайн веб-версии OpenWebGIS")
 {return;
OpenLayers.Request.GET({
url:defaultWMSProperty.url+'SERVICE=WMS&request=GetCapabilities',
success: function(e){
var response = wmsL.read(e.responseText);
var capability = response.capability;
for (var i=0, len=capability.layers.length; i<len; i++) { 
 var layerObj = capability.layers[i];
if(layerObj.name.split(':')[0]==StrConnectLayer2)
{ var counter=0;
for (var ii=0;ii<layCount;ii++)
{ 
if(document.getElementById('SelectorAddLayer')[ii].value==layerObj.name.split(':')[1])
{counter=1; }else{if(ii==layCount-1&&counter!=1){ var t=document.createElement('option');t.value=layerObj.name.split(':')[1]+"_WMSLayer";t.text=layerObj.name.split(':')[1];document.getElementById('SelectorAddLayer').appendChild(t);
}}
}
}
}
}
}); }
}
function closeAddLayerWin()
{document.getElementById("id_divAddLayer2").parentNode.removeChild(document.getElementById("id_divAddLayer2"));}
function AddLayerOK(){document.getElementById("id_divAddLayer2").parentNode.removeChild(document.getElementById("id_divAddLayer2"));} 
function setLayer_Base(){ if(document.getElementById("LayerAsBase").checked==true){MarkAsBaseLayer=true} if(document.getElementById("LayerAsBase").checked==false){MarkAsBaseLayer=false;}} 
function setSelAdd(value){var layerSel=value; sellayer3=layerSel; addLayer2(map); }
function setSelAdd2(){if(document.getElementById("NameAsAbstract").checked==true){nameAbstract=true; SetNameLayerListAsName();}else{nameAbstract=false; SetNameLayerListAsName();}} 
function setLayerUserName(){if(document.getElementById("id_LayerUserName")&&document.getElementById("id_LayerUserName").checked==true){UnameYes=true; SetNameLayerListAsName();}else{UnameYes=false; SetNameLayerListAsName();}}
function addLayer2(map){
var StrConnectLayer=''; var StrConnectLayer2='';
if(document.getElementById('id_LayerUserName')&&document.getElementById('id_LayerUserName').checked==true)
{ if(GlobalUN!=='')
{StrConnectLayer="http://localhost:8080/data/"+GlobalUN+"/"+GlobalUN;StrConnectLayer2=GlobalUN;}
else
{StrConnectLayer="http://localhost:8080/data/webgis/curonian";StrConnectLayer2='webgis';}}
if(!document.getElementById('id_LayerUserName'))
{StrConnectLayer="http://localhost:8080/data/webgis/curonian";StrConnectLayer2='webgis';}
if(document.getElementById('id_LayerUserName')&&document.getElementById('id_LayerUserName').checked==false)
{StrConnectLayer="http://localhost:8080/data/webgis/curonian";StrConnectLayer2='webgis';}
if(MarkAsBaseLayer==true)
{MarkAsBaseLayer=true}else{MarkAsBaseLayer=false; }
var lenSelLayer3=sellayer3.split('_');
if (sellayer3.split('_')[lenSelLayer3.length-1]=='WMSLayer')
{
var wmsL = new OpenLayers.Format.WMSCapabilities();
alert("Эта функция работает только в онлайн веб-версии OpenWebGIS")
 {return;}
OpenLayers.Request.GET({
url:'/geoserver/wms?'+'SERVICE=WMS&request=GetCapabilities',
success: function(e){
var response = wmsL.read(e.responseText);
var capability = response.capability;
for (var i=0, len=capability.layers.length; i<len; i++) { 
 var layerObj = capability.layers[i];
if(layerObj.name.split(':')[0]==StrConnectLayer2&&layerObj.name.split(':')[1]==sellayer3.substring(0,sellayer3.lastIndexOf('_WMSLayer')))
{ 
if(document.getElementById("NameAsAbstract").checked==false)
{
abstractWMS=layerObj.name.split(':')[1]; 
}else{if (layerObj.abstract=='')
{abstractWMS=layerObj.name.split(':')[1];} else{abstractWMS=layerObj.abstract}}

 InterInterpBB=layerObj.llbbox;
}
}
if(MarkAsBaseLayer==false)
{
window[sellayer3]= new OpenLayers.Layer.WMS(
 abstractWMS, "/geoserver/wms",
 {
transparent: true,
LAYERS: StrConnectLayer2+':'+ sellayer3.substring(0,sellayer3.lastIndexOf('_WMSLayer')),
 STYLES: '',
 },
 { buffer: 0,opacity:0.5,
 displayOutsideMaxExtent: true,
 isBaseLayer: MarkAsBaseLayer,queryable: true,
projection: new OpenLayers.Projection("EPSG:900913")
 }
 );
 }
else
{
window[sellayer3]= new OpenLayers.Layer.WMS(
 abstractWMS, "/geoserver/wms",
 {
transparent: true,
LAYERS: StrConnectLayer2+':'+ sellayer3.substring(0,sellayer3.lastIndexOf('_WMSLayer')),
 STYLES: '',
 },
 { buffer: 0,opacity:0.5,
 displayOutsideMaxExtent: true,
 isBaseLayer: MarkAsBaseLayer,queryable: true,
projection: new OpenLayers.Projection("EPSG:900913"),
minResolution: null,
maxResolution: 156543.03390625,
numZoomLevels : 32,
maxScale: null,
minScale: null,
maxExtent: new OpenLayers.Bounds(-20037508.34, -20037508.34, 20037508.34, 20037508.34),
minExtent : null,
 }
 );
}
window[sellayer3].events.register("loadstart",window[sellayer3], function() {WaitWindow();});
map.addLayer(window[sellayer3]);
window[sellayer3].events.register("loadend",window[sellayer3], function() {if(popup_Wait){try{popup_Wait.destroy();}catch(e){};} });
}//end function(e)
});
}
var WFSLayerList;
 var defaultWFSProperty = {
 url: "/geoserver/wfs?",
 featureNS: StrConnectLayer,
 geometryName: "the_geom"
 };
 alert("Эта функция работает только в онлайн веб-версии OpenWebGIS")
 {return;}
 OpenLayers.Request.GET({
 url: defaultWFSProperty.url+'SERVICE=WFS&VERSION=1.1.0&REQUEST=GetCapabilities',
 async: false,
 success: function(e) {
 WFSLayerList = new OpenLayers.Format.WFSCapabilities().read(e.responseText);
 }
 });
 WFSLayerList.featureTypeList.featureTypes.forEach(function(l) {
 var styleL = new OpenLayers.Style({
 pointRadius: 3,
 fillColor: "#FF693F",
strokeColor: "#FFC300",
 strokeWidth: 1,
 fillOpacity:1,
 strokeOpacity:1
});
 var SelectstyleL = new OpenLayers.Style({
 pointRadius: 5, 
 fillColor: "#ffaa00",
 strokeColor: "#00DDFF",
 strokeWidth:2,
 fillOpacity:1,
 strokeOpacity:1
});
if(MarkAsBaseLayer==false)
{
 window[l.name] = new OpenLayers.Layer.Vector(l.abstract, {
strategies: [new OpenLayers.Strategy.Fixed(), saveStrategy],
 visibility: false,styleMap: new OpenLayers.StyleMap({'default':styleL,'select':SelectstyleL}),
projection : new OpenLayers.Projection("EPSG:4326"),
 isBaseLayer: MarkAsBaseLayer, renderers:["Canvas", "SVG", "VML"],
 protocol: new OpenLayers.Protocol.WFS(OpenLayers.Util.applyDefaults({featureType: l.name}, defaultWFSProperty))
 });
}
else
{
window[l.name] =new OpenLayers.Layer.WMS(
 l.abstract, "/geoserver/wms",
 {
transparent: true,
LAYERS: StrConnectLayer2+':'+l.name,
 STYLES: '',
 },
 { buffer: 0,opacity:0.5,
 displayOutsideMaxExtent: true,
 isBaseLayer: MarkAsBaseLayer,queryable: true,
projection: new OpenLayers.Projection("EPSG:900913"),
minResolution: null,
maxResolution: 156543.03390625,
numZoomLevels : 32,
maxScale: null,
minScale: null,
maxExtent: new OpenLayers.Bounds(-20037508.34, -20037508.34, 20037508.34, 20037508.34),
minExtent : null,
 }
 );
}
var s1 =l.featureNS;
var s2=l.name;
var AbsNameLayer='';
if(document.getElementById("NameAsAbstract").checked==true)
{AbsNameLayer=l.abstract}else{AbsNameLayer=l.name}
if((s1==StrConnectLayer) && (sellayer3==AbsNameLayer ))
{ 
if (l.abstract==undefined)
{window[l.name].name=l.name;} 
 if(document.getElementById("NameAsAbstract").checked==false)
{window[l.name].name=l.name;}
window[l.name].events.register("loadstart",window[l.name], function() {WaitWindow();}); 
map.addLayer(window[l.name]);
window[l.name].events.register("loadend",window[l.name], function() {if(popup_Wait){try{popup_Wait.destroy();}catch(e){};} });
 if(MarkAsBaseLayer==false)
 {
if(s1==StrConnectLayer)
{ var t=this.document.createElement('option');
t.value=window[l.name].name;
t.text=window[l.name].name;
this.document.getElementById("editL1").appendChild(t);
}
 }
}
 });
}
function handler(request) {
 alert(request.responseXML);
 alert(request.responseText);
 alert(request.status);
 alert(request.getAllResponseHeaders());
}
function Export_LayerOSM()
{
if(document.getElementById("editL1").value=="0")
{alert ("Выберите название слоя в списке 'Редактируемый слой'"); return;}

var format1= new OpenLayers.Format.OSM({'externalProjection': new OpenLayers.Projection("EPSG:4326"),'internalProjection': new OpenLayers.Projection("EPSG:900913") });
doc=format1.write(edilayerMainLayer.features);
kmlText2='';kmlText2=doc;init_download();
//myWinExport= open("download.html", "Export vector layer","width=900,height=500,status=no,toolbar=no,menubar=no,scrollbars=yes");myWinExport.focus();
}
function Export_Layer()
{if(document.getElementById("editL1").value=="0")
{alert ("Выберите название слоя в списке 'Редактируемый слой'"); return;}
var format;
 format = new OpenLayers.Format.KML({
 'extractStyles':true,
'extractAttributes':true,
'foldersName':'OpenWebGIS',
'maxDepth':3,
 'internalProjection': new OpenLayers.Projection("EPSG:900913"),
 'externalProjection': new OpenLayers.Projection("EPSG:4326")
 });
 var kmlText=format.write(edilayerMainLayer.features);
kmlText2='';
var format2 = new OpenLayers.Format.XML({});
 for (var i = 0; i < edilayerMainLayer.features.length; i++) {
var t=format2.createElementNSPlus("ExtendedData", {});
for (var ii in edilayerMainLayer.features[i].attributes)
{var name = ii
var tt=format2.createElementNSPlus("Data", {});tt.setAttribute('name',ii);
var tDisp=format2.createElementNSPlus("displayName", {value: ' '+ii+' '});
tt.appendChild(tDisp);
var ttt=format2.createElementNSPlus("value", {value: edilayerMainLayer.features[i].attributes[name]});
tt.appendChild(ttt);
t.appendChild(tt);
var t_final=format2.write(t);
}
kmlText=kmlText.replace(new RegExp('<Placemark id="'+edilayerMainLayer.features[i].fid+'"><name>'+edilayerMainLayer.features[i].id+'</name><description>No description available</description>','g'),'<Placemark id="'+edilayerMainLayer.features[i].fid+'"><name>'+edilayerMainLayer.features[i].fid+'</name><description>'+t_final+'</description>');
}
kmlText2=kmlText;init_download();
//myWinExport= open("download.html", "Export vector layer","width=900,height=500,status=no,toolbar=no,menubar=no,scrollbars=yes");myWinExport.focus();
}
function DelAttribute()
{
if(this.document.getElementById("editL1").value=="0")
{alert ("Выберите название слоя в списке 'Редактируемый слой'"); return;}
var htmlTextDel=" ";
htmlTextDel+='<a>Please select name and value of attribute:</a><br>'+
'<select id="DelAttr_id" >'+
 '<option selected value="0" >.</option>'+
'</select><br>'+
'<p> <button type=button onclick=OK_DelAttrubute()>OK</button></p>';
popup_attr_del = new OpenLayers.Popup.FramedCloud("AttrubutePopup",
 map.getCenter(),
 new OpenLayers.Size(400,400),
 htmlTextDel ,
 null, true, onPopupClose);
 map.addPopup(popup_attr_del);
 var seldel = document.getElementById("DelAttr_id");
 while (seldel.childNodes.length) {
 if (seldel.firstChild.tagName == 'OPTGROUP') {
 while (seldel.firstChild.childNodes.length) {
 seldel.firstChild.removeChild(seldel.firstChild.firstChild);
 }
 }
 seldel.removeChild(seldel.firstChild);
 }
 var t=document.createElement('option');
t.value="0";
t.text=".";
document.getElementById("DelAttr_id").appendChild(t);
 if(edilayerMainLayer.features.length<1){alert("Please activate Layer");popup_attr_del.destroy();return;}
 for (var a in edilayerMainLayer.features[0].attributes)
 {var t=document.createElement('option');
 t.value=a;
 t.text=a;
 document.getElementById("DelAttr_id").appendChild(t);} 
}
function OK_DelAttrubute()
{
for (var i = 0; i < edilayerMainLayer.features.length; i++) 
 { var g=document.getElementById("DelAttr_id").value;
 delete edilayerMainLayer.features[i].attributes[g]
 }
popup_attr_del.destroy();
alert("All done");
}
function AddAttribute()
{
if(this.document.getElementById("editL1").value=="0")
{alert ("Выберите название слоя в списке 'Редактируемый слой'"); return;}
var htmlText1=" ";
htmlText1+='<a>Please insert name and value of attribute:</a><br>'+
'<input type="text" size="8" id="attribute_name" value="attribute"/>name<br>'+
'<input type="text" size="8" id="attribute_value" value="0"/>value<br>'+
'<p> <button type=button onclick=OK_Attrubute()>OK</button></p>';
popup_attr_new = new OpenLayers.Popup.FramedCloud("AttrubutePopup",
 map.getCenter(),
 new OpenLayers.Size(400,400),
 htmlText1 ,
 null, true, onPopupClose);
 map.addPopup(popup_attr_new);}
function OK_Attrubute()
{
for (var i = 0; i < edilayerMainLayer.features.length; i++) 
 { var g=document.getElementById("attribute_name").value;
 edilayerMainLayer.features[i].attributes[g]=document.getElementById("attribute_value").value;
 }
popup_attr_new.destroy();
}
function parseOb (Obj,xy) {
var x,y;
for(var key in Obj)
{
if(key=='x'){
x = Obj[key]

var new_pos=new OpenLayers.LonLat(x,0).transform(
map.getProjectionObject(),new OpenLayers.Projection("EPSG:4326"));
xy[0].push(new_pos.lon);
}

if(key=='y'){var y = Obj[key];
var new_pos=new OpenLayers.LonLat(0,y).transform(
map.getProjectionObject(),new OpenLayers.Projection("EPSG:4326"));
xy[1].push(new_pos.lat);}

if (key!=='parent'&&typeof(Obj[key])=='object')
{parseOb(Obj[key],xy)
}
 }
rtt=xy;

return xy;
}
function parseOb2(rulobj )
{
for ( ph in rulobj )
{if (ph=='filters')
{var ty=new OpenLayers.Filter.Logical(rulobj);
var g1=new OpenLayers.Filter.Comparison(rulobj.filters[0]);
for ( ph2 in rulobj.filters[0] ){
{if (ph2=='filters')
var g1=parseOb2(rulobj.filters[0] )}}
var g2=new OpenLayers.Filter.Comparison(rulobj.filters[1]);
ty.filters[0]=g1;ty.filters[1]=g2;
fifi1=ty;return fifi1;
}
}
}
function OnBlurtDistMeasureGisaL()
{
nameMeaslayerMain=document.getElementById("DistMeasureGisaL_id").value;
}
function OnBlurtDistMeasureGisaSqL()
{
nameMeaslayerMainSq=document.getElementById("DistMeasureGisaSqL_id").value;
}

function DistMeasDelL()
{
if(document.getElementById("Id_CheckDistMeas").checked==true)
{checkMeasDistMain=true}
if(document.getElementById("Id_CheckDistMeas").checked==false)
{checkMeasDistMain=false}
}
function DistMeasDelLSq()
{
if(document.getElementById("Id_CheckSqMeas").checked==true)
{checkMeasSqMain=true}
if(document.getElementById("Id_CheckSqMeas").checked==false)
{checkMeasSqMain=false}

}
function OptionSqMeas()
{if(document.getElementById("DistMeasureGisaSqDiv_id").style.display=="block")
{document.getElementById("DistMeasureGisaSqDiv_id").style.display="none";}
else{document.getElementById("DistMeasureGisaSqDiv_id").style.display="block";}}
function OptionDistMeas()
{if(document.getElementById("DistMeasureGisaDiv_id").style.display=="block")
{document.getElementById("DistMeasureGisaDiv_id").style.display="none";}
else{document.getElementById("DistMeasureGisaDiv_id").style.display="block";}}
function Export_Layer_CSV()
{if(document.getElementById("editL1").value=="0")
{alert ("Выберите название слоя в списке 'Редактируемый слой'"); return;}
htmlCSV='';
htmlCSV+='<a>Select parameters of the csv file:</a><br>'+
'<input type="text" size="6" id="id_CSVlonG" value="longitude"/>name of the longitude field<br>'+
'<input type="text" size="6" id="id_CSVlatG" value="latitude"/>name of the latitude field<br>'+
'<select id=TypeSeparate_idCSV>'+
'<option selected value=";">; semicolon</option>'+
'<option selected value=",">, comma</option>'+
'</select>Please select separation symbol in CSV file<br>'+
'<p> <button type=button onclick=Export_Layer_CSV_OK()>OK</button></p>';
popup_new_ExpCSV = new OpenLayers.Popup.FramedCloud("PopupCSVExport",
 map.getCenter(),
 new OpenLayers.Size(400,400),
 htmlCSV , null, true, onPopupClose);
 map.addPopup(popup_new_ExpCSV);
popup_new_ExpCSV.updateSize();
document.getElementById("PopupCSVExport").onmousedown=function(event){drags(event)};
document.getElementById("PopupCSVExport").onmouseup=function(e){enddrag()};
}
function Export_Layer_CSV_OK()
{
var fieldsArr=[document.getElementById("id_CSVlonG").value,document.getElementById("id_CSVlatG").value];
var csvArray=[]
for(var key in edilayerMainLayer.features[0].attributes)
{fieldsArr.push(key);}
csvArray.push([fieldsArr]);
rtt=csvArray;
for(var i=0;i<edilayerMainLayer.features.length;i++)
{
var attr=[]
var xy=[];
var x1=[];
var y1=[];
xy.push(x1);xy.push(y1);
var xy=parseOb (edilayerMainLayer.features[i].geometry,xy);
for(var j=0;j<xy[0].length;j++)
{
attr.push([xy[0][j],xy[1][j]])
for(var key in edilayerMainLayer.features[i].attributes)
{attr[attr.length-1].push(edilayerMainLayer.features[i].attributes[key])

}
}
var datastr='';
var datastr2='';
csvArray.push(attr);
}
rtt=csvArray;
for(var g=0;g<csvArray.length;g++)
{
for(var gg=0;gg<csvArray[g].length;gg++)
{datastr = csvArray[g][gg].join(document.getElementById("TypeSeparate_idCSV").value)+ "\n";datastr2+=datastr;}
}
popup_new_ExpCSV.destroy();
kmlText2=datastr2;init_download();
//var myWinExport= open("download.html", "Export to csv","width=900,height=500,status=no,toolbar=no,menubar=no,scrollbars=yes");myWinExport.focus();
}
function Export_Layer_GML()
{if(document.getElementById("editL1").value=="0")
{alert ("Выберите название слоя в списке 'Редактируемый слой'"); return;}
var format;
 format = new OpenLayers.Format.GML({
 'extractStyles':true,
'extractAttributes':true,
 'internalProjection': new OpenLayers.Projection("EPSG:900913"),
 'externalProjection': new OpenLayers.Projection("EPSG:4326")
 });
 var gmlText=format.write(edilayerMainLayer.features);
kmlText2='';
kmlText2=gmlText;init_download();
 //myWinExport= open("download.html", "Export vector layer","width=900,height=500,status=no,toolbar=no,menubar=no,scrollbars=yes");myWinExport.focus();
}
function Export_Layer_GML()
{
var format;
 format = new OpenLayers.Format.GML({
 'extractStyles':true,
'extractAttributes':true,
 'internalProjection': new OpenLayers.Projection("EPSG:900913"),
 'externalProjection': new OpenLayers.Projection("EPSG:4326")
 });
 var gmlText=format.write(edilayerMainLayer.features);
kmlText2='';
kmlText2=gmlText;init_download();
 //myWinExport= open("download.html", "Export vector layer","width=900,height=500,status=no,toolbar=no,menubar=no,scrollbars=yes");myWinExport.focus();
}
function readSingleFileJSON(evt)
{
fileZIP = evt.target.files[0]; 
}
function New_LayerJSON2()
{
var lines = [];
var headers;
var contents2;
var contents;
 if (fileZIP) {
 var r = new FileReader();
 r.onload = function(e) { 
 contents = e.target.result;
loadlayerJSON(contents);
 }
 r.readAsText(fileZIP);
 } else { 
 alert("Ошибка загрузки файла");
 }
}
function Export_Layer_JSON()
{if(document.getElementById("editL1").value=="0")
{alert ("Выберите название слоя в списке 'Редактируемый слой'"); return;}
var format;
 format = new OpenLayers.Format.GeoJSON({ 'internalProjection': new OpenLayers.Projection("EPSG:900913"),
'externalProjection': new OpenLayers.Projection("EPSG:4326")});
 var jsonText=format.write(edilayerMainLayer.features);
kmlText2='';
kmlText2=jsonText;init_download();
 //myWinExport= open("download.html", "Export vector layer","width=900,height=500,status=no,toolbar=no,menubar=no,scrollbars=yes");myWinExport.focus();
}
function loadlayerJSON(contents)
{
var format;
 format = new OpenLayers.Format.GeoJSON({ 'internalProjection': new OpenLayers.Projection("EPSG:900913"),
'externalProjection': new OpenLayers.Projection("EPSG:4326")});
var new_layer_JSON = new OpenLayers.Layer.Vector(fileZIP.name.split('.')[0],{renderers:["Canvas", "SVG", "VML"]});
var jsonFeatures=format.read(contents); 
new_layer_JSON.addFeatures(jsonFeatures);
var new_style_layer= new OpenLayers.Style({
 pointRadius: 3,
 fillColor: "#FF9000",
 strokeColor: "#FF9000",
 strokeWidth: 1,
fillOpacity:1,
 strokeOpacity:1
 });
 var selStyle = new OpenLayers.Style({
 pointRadius: 5, 
 fillColor: "#ffaa00",
 strokeColor: "#00DDFF",
 strokeWidth:2,
fillOpacity:1,
 strokeOpacity:1
 }); 
new_layer_JSON.styleMap=new OpenLayers.StyleMap({'default':new_style_layer,'select': selStyle});
map.addLayer(new_layer_JSON);
var t=this.document.createElement('option');
t.value=new_layer_JSON.name;
t.text=new_layer_JSON.name;
this.document.getElementById("editL1").appendChild(t);
popup_new_fileJSON.destroy();
}
function New_LayerJSON()
{
var htmlLayerJSON='';
htmlLayerJSON+='<a>Пожалуйста, выберите файл:</a><br>'+
 '<input title="выберите JSON file" type="file" id="file_idJSON"><br>'+
'<p> <button type=button onclick=New_LayerJSON2()>OK</button></p>';
popup_new_fileJSON = new OpenLayers.Popup.FramedCloud("NewFilePopupJSON",
 map.getCenter(),
 new OpenLayers.Size(400,400),
 htmlLayerJSON ,
 null, true, onPopupClose);
 map.addPopup(popup_new_fileJSON);
document.getElementById('file_idJSON').addEventListener('change', readSingleFileGML, false);

}
function OpenSreetMapdatabase()
{
var bbox = document.getElementById("map").getBoundingClientRect();
 var body = document.body
 var docElem = document.documentElement
 var scrollTop = window.pageYOffset || docElem.scrollTop || body.scrollTop
 var scrollLeft = window.pageXOffset || docElem.scrollLeft || body.scrollLeft
 var clientTop = docElem.clientTop || body.clientTop || 0
 var clientLeft = docElem.clientLeft || body.clientLeft || 0
 var topTop = bbox.top + scrollTop - clientTop
 var leftLeft = bbox.left + scrollLeft - clientLeft
var DivEditeLeg=document.createElement("div");
DivEditeLeg.id="id_OpenStreetMapMain2";
DivEditeLeg.className="id_divRoutLegMain";
DivEditeLeg.style.position="relative";
DivEditeLeg.innerHTML='<div id="id_divOSMDBLeg" style="background:#ffffff; color:#0000ff;z-index: 6000;position:absolute;left:'+Math.round(leftLeft+50)+'px;top:'+Math.round(topTop-150)+
'px;overflow:hidden; border: 1px solid black;"><img onclick="closeOSMDBWin()" src="openlayers/theme/default/img/close.gif" style="position:relative; top:10px;float:right; cursor:pointer"><a style="position:relative; top:20px"></a>'+
'<a style="font-size: 9px;"> Вы можете перемещать это окно если щёлкните по пункту меню: Интерфейс->переключить режим интерфейса</a><br>'+
'<a>Информация:</a><br> <a href="http://www.openstreetmap.org/" target="_blank">OpenStreetMap</a> данные под лицензией <br><a href="http://opendatacommons.org/licenses/odbl/1.0/" target="_blank">Open Data Commons Open Database Licence (ODbL).</a><br>'+
'<a>Data download with help of:</a><a href="http://overpass-api.de/" target="_blank">overpass-api.de</a><br>'+
'<a>Географический регион:</a><br>'+
'<input title="координата нижнего левого угла. Вы можете щёлкнуть по карте или ввести координаты сами. Координаты вводятся после клика по карте, если в этом поле указан ноль или пусто." type="text" size="8" id="first_longOSM" value="0"/>нижняя левая долгота, вы можете щёлкнуть по карте<br>'+
'<input title="coordinate of the lower left corner" type="text" size="8" id="first_latOSM" value="0"/>нижняя левая широта<br>'+
'<input title="координата верхнего правого угла. Вы можете щёлкнуть по карте или ввести координаты сами. Координаты вводятся после клика по карте, если в этом поле указан ноль или пусто." type="text" size="8" id="sec_longOSM" value="0"/>верхняя правая долгота<br>'+'<input title="coordinate of the upper-right corner" type="text" size="8" id="sec_latOSM" value="0"/>верхняя правая широта<br>'+

'<a>Введите название слоя:</a><input type="text" size="35" id="id_textOSMDBLayer" title="Insert name of layer" value="OSM_DB"/>'+
'<p> <button type=button onclick=OpenSreetMapdatabase2()>OK</button></p><div id="waitOSMDB"></div>'+
'<div id="id_OSMtypetags2" ; style="overflow: auto;height: 150px;display:none; border: 1px #000;"></div>'+
'<p> <button id="id_New_LayerOSMdb1" type=button style="display:none;" onclick=New_LayerOSM2()>Загрузить всю информацию</button><button id="id_New_LayerOSMdb2" style="display:none;" type=button onclick=New_LayerOSM3()>создать слой из выбранных тегов </button></p>'+
'</div>';
if(!document.getElementById("id_OpenStreetMapMain2"))
{body.appendChild(DivEditeLeg); 
OpenLayers.Control.Click = OpenLayers.Class(OpenLayers.Control, {                
defaultHandlerOptions: {'single': true,'double': false,'pixelTolerance': 0,'stopSingle': false,'stopDouble': false},
initialize: function(options) {this.handlerOptions = OpenLayers.Util.extend({}, this.defaultHandlerOptions);OpenLayers.Control.prototype.initialize.apply(this, arguments); 
this.handler = new OpenLayers.Handler.Click(this, {'click': this.trigger}, this.handlerOptions);}, 
trigger: function(e) {var lonlat = map.getLonLatFromPixel(e.xy);
var new_pos=new OpenLayers.LonLat(lonlat.lon,lonlat.lat).transform(
map.getProjectionObject(),new OpenLayers.Projection("EPSG:4326"));
if(document.getElementById("first_longOSM"))
{if(document.getElementById("first_longOSM").value==''||document.getElementById("first_longOSM").value=='0')
{document.getElementById("first_longOSM").value=new_pos.lon;
document.getElementById("first_latOSM").value=new_pos.lat;}
else{
if(document.getElementById("sec_longOSM").value==''||document.getElementById("sec_longOSM").value=='0')
{document.getElementById("sec_longOSM").value=new_pos.lon;
document.getElementById("sec_latOSM").value=new_pos.lat;}}
}  }
});
var clickOSMDBCoordinates = new OpenLayers.Control.Click();
clickOSMDBCoordinates.title="Download this bounding box from the OpenStreetMap database";
 map.addControl(clickOSMDBCoordinates);
clickOSMDBCoordinates.activate();

document.getElementById("id_OpenStreetMapMain2").onmousedown=function(event){drags(event)};
document.getElementById("id_OpenStreetMapMain2").onmouseup=function(e){enddrag()};
}  }
function OpenSreetMapdatabase2()
{
var waitosm=document.createElement('a');waitosm.id="id_waitOSM2";waitosm.innerHTML="Wait...";document.getElementById("waitOSMDB").appendChild(waitosm);waitosm.style.fontSize="15px";

var l1=document.getElementById("first_longOSM").value;var lat1=document.getElementById("first_latOSM").value;var l2=document.getElementById("sec_longOSM").value;var lat2=document.getElementById("sec_latOSM").value
myUrl='http://api.openstreetmap.org/api/0.6/map?bbox='+l1+","+lat1+","+l2+","+lat2;
myUrl2="overpass-api.de/api/map?bbox="+l1+","+lat1+","+l2+","+lat2;

myUrl=encodeURIComponent(myUrl);myUrl2=encodeURIComponent(myUrl2);
try {var xmlhttp =new XMLHttpRequest();}
catch (e) {alert("error");}
xmlhttp.open('GET','/temp.php?c='+myUrl2+'&rand='+Math.random(), true);
xmlhttp.setRequestHeader("Cache-Control", "no-cache");
xmlhttp.setRequestHeader("Content-type", "text/xml");
xmlhttp.onreadystatechange = function()
{if(xmlhttp.readyState == 4&&xmlhttp.status == 200) {if(xmlhttp.responseText=="cURL Error: "){alert("Выбранный вами регион слишком большой для экспорта в файл OpenStreetMap XML Data. Пожалуйста, выберите меньший регион. Или возможно наличие другой ошибки.");return;}
if(xmlhttp.responseText!==''){
var format;var doc='';var contents=xmlhttp.responseText;
var format1= new OpenLayers.Format.OSM({'internalProjection': new OpenLayers.Projection("EPSG:900913"),'externalProjection': new OpenLayers.Projection("EPSG:4326") });
doc=format1.read(contents); var attribOSM={};
for (var i=0; i<doc.length;i++)
{for (h in doc[i].attributes){attribOSM[h]=[]} }
var listNew = [];for (var ih in attribOSM) {  listNew.push(ih);}
listNew.sort();attribOSM={};
for (var ut=0; ut<listNew.length;ut++){attribOSM[listNew[ut]]=[];}
for (var i=0; i<doc.length;i++)
{for (h in doc[i].attributes){attribOSM[h].push(doc[i].attributes[h])}  }
var indtag=0;document.getElementById("id_OSMtypetags2").innerHTML='';document.getElementById("id_OSMtypetags2").style.border="1px double black";
for(h in attribOSM)
{
var objosm={};for(var j=0;j<attribOSM[h].length;j++){objosm[attribOSM[h][j]]='';};attribOSM[h]=[];for(g in objosm){attribOSM[h].push(g);}
var check=document.createElement("input");check.type="checkbox";check.id="idosm2_"+h;document.getElementById("id_OSMtypetags2").appendChild(check);
var a=document.createElement("a");a.innerHTML=h;document.getElementById("id_OSMtypetags2").appendChild(a);var sel=document.createElement("select");sel.id="idosmsel2_"+h;
var t=document.createElement('option');t.value="";t.text=".";sel.appendChild(t);
for(var jj=0;jj<attribOSM[h].length;jj++){var t=document.createElement('option');t.style.fontSize="10px";t.value=attribOSM[h][jj];t.text=attribOSM[h][jj];sel.appendChild(t);}
document.getElementById("id_OSMtypetags2").appendChild(sel);
indtag++; if(indtag==2){var br=document.createElement("br");document.getElementById("id_OSMtypetags2").appendChild(br);indtag=0;}
}
document.getElementById("id_OSMtypetags2").style.display="block";
document.getElementById("id_New_LayerOSMdb1").style.display="block";document.getElementById("id_New_LayerOSMdb1").onclick=function(){var bb=1;loadlayerOSM(contents,bb)}
document.getElementById("id_New_LayerOSMdb2").style.display="block";document.getElementById("id_New_LayerOSMdb2").onclick=function(){New_LayerOSMDB3(contents)}
if(document.getElementById("id_waitOSM2")){document.getElementById("id_waitOSM2").parentNode.removeChild(document.getElementById("id_waitOSM2"))}
} }if(xmlhttp.status!==200){alert("Выбранный вами регион слишком большой для экспорта в файл OpenStreetMap XML Data. Пожалуйста, выберите меньший регион. Или возможно наличие другой ошибки.");if(document.getElementById("id_waitOSM2")){document.getElementById("id_waitOSM2").parentNode.removeChild(document.getElementById("id_waitOSM2"))}  }

}
alert("Эта функция работает только в онлайн веб-версии OpenWebGIS")
{return;
xmlhttp.send(null);}
}
function New_LayerOSM()
{var htmlLayerOSM='';
var bbox = document.getElementById("map").getBoundingClientRect();
 var body = document.body; var docElem = document.documentElement;
  var scrollTop = window.pageYOffset || docElem.scrollTop || body.scrollTop;
 var scrollLeft = window.pageXOffset || docElem.scrollLeft || body.scrollLeft;
 var clientTop = docElem.clientTop || body.clientTop || 0; var clientLeft = docElem.clientLeft || body.clientLeft || 0;
 var topTop = bbox.top + scrollTop - clientTop; var leftLeft = bbox.left + scrollLeft - clientLeft;
var DivEditeLeg=document.createElement("div");DivEditeLeg.id="id_divOSMLayMain2";
DivEditeLeg.className="id_divRoutLegMain";DivEditeLeg.style.position="relative";
DivEditeLeg.innerHTML='<div id="id_divOSMLay" style="background:#ffffff; color:#0000ff;z-index: 6000;position:absolute;left:'+Math.round(leftLeft+50)+'px;top:'+Math.round(topTop-150)+
'px;overflow:hidden; border: 1px solid black;"><img onclick="closeOSMLayWin()" src="openlayers/theme/default/img/close.gif" style="position:relative; top:10px;float:right; cursor:pointer"><a style="position:relative; top:20px"></a>'+
'<a style="font-size: 9px;">Вы можете перемещать это окно если щёлкните по пункту меню: Интерфейс->переключить режим интерфейса</a><br>'+
'<a>Выберите файл <a href="http://wiki.openstreetmap.org/wiki/OSM_XML" target="_blank">OSM file</a>:</a><br>'+
 '<input title="Select OSM file" type="file" id="file_idOSM"><br>'+
 'Введите название слоя:<input type="text" size="20" id="NameOSM_newLay" value="OSM_layer"/><br>'+
'<p> <button type=button onclick=New_LayerOSM2()>Загрузить всю информацию</button><button type=button onclick=New_LayerOSMTag()>Выбрать информацию(теги)</button></p>'+
'<div id="id_OSMtypetags" ; style="overflow: auto;height: 150px;display:none; border: 1px #000;"></div>'+
'<p> <button id="id_New_LayerOSM3" style="display:none;" type=button onclick=New_LayerOSM3()>создать слой из выбранных тегов </button></p>'+
'</div>';
if(!document.getElementById("id_divOSMLayMain2"))
{body.appendChild(DivEditeLeg); 
document.getElementById("id_divOSMLayMain2").onmousedown=function(event){drags(event)};document.getElementById("id_divOSMLayMain2").onmouseup=function(e){enddrag()};
document.getElementById('file_idOSM').addEventListener('change', readSingleFileOSM, false);
}
}
function readSingleFileOSM(evt)
{fileZIP = evt.target.files[0]; }

function New_LayerOSM2()
{var lines = [];var headers;
var contents2;var contents;
 if (fileZIP) { var r = new FileReader();
 r.onload = function(e) {  contents = e.target.result;
var bb=0;loadlayerOSM(contents,bb); }
 r.readAsText(fileZIP); } else {  alert("Failed to load file"); }
}
function New_LayerOSMTag()
{
var lines = [];var headers;
var contents2;var contents;
 if (fileZIP) { var r = new FileReader();
 r.onload = function(e) {  contents = e.target.result;
var format;var doc='';
var format1= new OpenLayers.Format.OSM({'internalProjection': new OpenLayers.Projection("EPSG:900913"),'externalProjection': new OpenLayers.Projection("EPSG:4326") });
doc=format1.read(contents); var attribOSM={};
for (var i=0; i<doc.length;i++)
{for (h in doc[i].attributes){attribOSM[h]=[]} }
var listNew = [];for (var ih in attribOSM) {  listNew.push(ih);}
listNew.sort();attribOSM={};
for (var ut=0; ut<listNew.length;ut++){attribOSM[listNew[ut]]=[];}
for (var i=0; i<doc.length;i++)
{for (h in doc[i].attributes){attribOSM[h].push(doc[i].attributes[h])}  }
var indtag=0;document.getElementById("id_OSMtypetags").innerHTML='';document.getElementById("id_OSMtypetags").style.border="1px double black";
for(h in attribOSM)
{
var objosm={};for(var j=0;j<attribOSM[h].length;j++){objosm[attribOSM[h][j]]='';};attribOSM[h]=[];for(g in objosm){attribOSM[h].push(g);}
var check=document.createElement("input");check.type="checkbox";check.id="idosm_"+h;document.getElementById("id_OSMtypetags").appendChild(check);
var a=document.createElement("a");a.innerHTML=h;document.getElementById("id_OSMtypetags").appendChild(a);var sel=document.createElement("select");sel.id="idosmsel_"+h;
var t=document.createElement('option');t.value="";t.text=".";sel.appendChild(t);
for(var jj=0;jj<attribOSM[h].length;jj++){var t=document.createElement('option');t.style.fontSize="10px";t.value=attribOSM[h][jj];t.text=attribOSM[h][jj];sel.appendChild(t);}
document.getElementById("id_OSMtypetags").appendChild(sel);
indtag++; if(indtag==2){var br=document.createElement("br");document.getElementById("id_OSMtypetags").appendChild(br);indtag=0;}
}
document.getElementById("id_OSMtypetags").style.display="block";
document.getElementById("id_New_LayerOSM3").style.display="block";document.getElementById("id_New_LayerOSM3").onclick=function(){New_LayerOSM3(contents);}


}
 r.readAsText(fileZIP); } else {  alert("Failed to load file"); }
 

}
function loadlayerOSM(contents,bb)
{
var format; var doc='';
var format1= new OpenLayers.Format.OSM({'internalProjection': new OpenLayers.Projection("EPSG:900913"),'externalProjection': new OpenLayers.Projection("EPSG:4326") });

doc=format1.read(contents); 
if(bb==0)
{var new_layer_OSM = new OpenLayers.Layer.Vector(document.getElementById("NameOSM_newLay").value,{renderers:["Canvas", "SVG", "VML"]});}
if(bb==1)
{var new_layer_OSM = new OpenLayers.Layer.Vector(document.getElementById("id_textOSMDBLayer").value,{renderers:["Canvas", "SVG", "VML"]});}
var arfeatAtrr={}
 for(var ty=0;ty<doc.length;ty++)
 { for(h in  doc[ty].attributes){arfeatAtrr[h] = true; } }
 for(var a = 0; a < doc.length; a++ )
{ var NewAttr={}; for(h in arfeatAtrr){NewAttr[h]='';}
delete NewAttr.undefined;
for(h in arfeatAtrr)
{ for (ag in doc[a].attributes) 
{  if(h==ag) 
{NewAttr[h]=doc[a].attributes[ag]; rtt=NewAttr; }
else{if(NewAttr[h]){}else{NewAttr[h]=''};} ;  
}     }
 doc[a].attributes=NewAttr;  }

new_layer_OSM.addFeatures(doc);
var new_style_layer= new OpenLayers.Style({ pointRadius: 3, fillColor: "#FF9000", strokeColor: "#FF9000", strokeWidth: 2,fillOpacity:1, strokeOpacity:1 });
var new_style_layer2= new OpenLayers.Style({ pointRadius: 3, fillColor: "#FF9000", strokeColor: "#FF9000", strokeWidth: 3,fillOpacity:1, strokeOpacity:1 });
 var selStyle = new OpenLayers.Style({ pointRadius: 5,  fillColor: "#ffaa00", strokeColor: "#00DDFF", strokeWidth:2,fillOpacity:1, strokeOpacity:1 }); 
new_layer_OSM.styleMap=new OpenLayers.StyleMap({'default':new_style_layer2,'select': selStyle});new_layer_OSM.styleMap=new OpenLayers.StyleMap({'default':new_style_layer,'select': selStyle});
new_layer_OSM.projection=new OpenLayers.Projection("EPSG:4326"); map.addLayer(new_layer_OSM);var t=this.document.createElement('option');
t.value=new_layer_OSM.name;t.text=new_layer_OSM.name;this.document.getElementById("editL1").appendChild(t);
}
function New_LayerOSMDB3(contents)
{var arfeat=[];
var doc='';
var format1= new OpenLayers.Format.OSM({'internalProjection': new OpenLayers.Projection("EPSG:900913"),'externalProjection': new OpenLayers.Projection("EPSG:4326") });
doc=format1.read(contents);
for (var i=0; i<doc.length;i++)
{
for (h in doc[i].attributes)
{  if(document.getElementById("idosm2_"+h).checked==true) {if(document.getElementById("idosmsel2_"+h).value!==""){ if(document.getElementById("idosmsel2_"+h).value==doc[i].attributes[h]){arfeat.push(doc[i])}  }else{arfeat.push(doc[i])}  }      }  }
 if(arfeat.length==0){alert("Nothing is selected or no data"); return;}
 var arfeatAtrr={} ; for(var ty=0;ty<arfeat.length;ty++)
 { for(h in  arfeat[ty].attributes){arfeatAtrr[h] = true; } }
 for(var a = 0; a < arfeat.length; a++ )
{ var NewAttr={};for(h in arfeatAtrr){NewAttr[h]='';}
delete NewAttr.undefined;
for(h in arfeatAtrr){ for (ag in arfeat[a].attributes) 
{  if(h==ag) 
{NewAttr[h]=arfeat[a].attributes[ag]; rtt=NewAttr; }
else{if(NewAttr[h]){}else{NewAttr[h]=''};} ;  
}     } arfeat[a].attributes=NewAttr;  
}
 var new_layer_OSM = new OpenLayers.Layer.Vector(document.getElementById("id_textOSMDBLayer").value,{renderers:["Canvas", "SVG", "VML"]});new_layer_OSM.addFeatures(arfeat);
var new_style_layer= new OpenLayers.Style({ pointRadius: 3, fillColor: "#FF9000", strokeColor: "#FF9000", strokeWidth: 2,fillOpacity:1, strokeOpacity:1 });var new_style_layer2= new OpenLayers.Style({ pointRadius: 3, fillColor: "#FF9000", strokeColor: "#FF9000", strokeWidth: 3,fillOpacity:1, strokeOpacity:1 });
 var selStyle = new OpenLayers.Style({ pointRadius: 5,  fillColor: "#ffaa00", strokeColor: "#00DDFF", strokeWidth:2,fillOpacity:1, strokeOpacity:1 }); new_layer_OSM.styleMap=new OpenLayers.StyleMap({'default':new_style_layer2,'select': selStyle});new_layer_OSM.styleMap=new OpenLayers.StyleMap({'default':new_style_layer,'select': selStyle});
new_layer_OSM.projection=new OpenLayers.Projection("EPSG:4326");map.addLayer(new_layer_OSM);var t=this.document.createElement('option');
t.value=new_layer_OSM.name;t.text=new_layer_OSM.name;this.document.getElementById("editL1").appendChild(t);

}
function New_LayerOSM3(contents)
{var arfeat=[];var doc='';
var format1= new OpenLayers.Format.OSM({'internalProjection': new OpenLayers.Projection("EPSG:900913"),'externalProjection': new OpenLayers.Projection("EPSG:4326") });
doc=format1.read(contents); 
for (var i=0; i<doc.length;i++)
{
for (h in doc[i].attributes)
{  if(document.getElementById("idosm_"+h).checked==true) {if(document.getElementById("idosmsel_"+h).value!==""){ if(document.getElementById("idosmsel_"+h).value==doc[i].attributes[h]){arfeat.push(doc[i])}  }else{arfeat.push(doc[i])}  }                   }
 }
 if(arfeat.length==0){alert("Nothing is selected or no data"); return;}
 var arfeatAtrr={}
 for(var ty=0;ty<arfeat.length;ty++)
 { for(h in  arfeat[ty].attributes){arfeatAtrr[h] = true; } }
 for(var a = 0; a < arfeat.length; a++ )
{ var NewAttr={};
for(h in arfeatAtrr){NewAttr[h]='';}
delete NewAttr.undefined;
for(h in arfeatAtrr)
{ for (ag in arfeat[a].attributes) 
{  if(h==ag) 
{NewAttr[h]=arfeat[a].attributes[ag]; rtt=NewAttr; }
else{if(NewAttr[h]){}else{NewAttr[h]=''};} ;  
}    
 }
 arfeat[a].attributes=NewAttr;  
}
 var new_layer_OSM = new OpenLayers.Layer.Vector(document.getElementById("NameOSM_newLay").value,{renderers:["Canvas", "SVG", "VML"]});new_layer_OSM.addFeatures(arfeat);
var new_style_layer= new OpenLayers.Style({ pointRadius: 3, fillColor: "#FF9000", strokeColor: "#FF9000", strokeWidth: 2,fillOpacity:1, strokeOpacity:1 });
var new_style_layer2= new OpenLayers.Style({ pointRadius: 3, fillColor: "#FF9000", strokeColor: "#FF9000", strokeWidth: 3,fillOpacity:1, strokeOpacity:1 });
 var selStyle = new OpenLayers.Style({ pointRadius: 5,  fillColor: "#ffaa00", strokeColor: "#00DDFF", strokeWidth:2,fillOpacity:1, strokeOpacity:1 }); 
new_layer_OSM.styleMap=new OpenLayers.StyleMap({'default':new_style_layer2,'select': selStyle});new_layer_OSM.styleMap=new OpenLayers.StyleMap({'default':new_style_layer,'select': selStyle});
new_layer_OSM.projection=new OpenLayers.Projection("EPSG:4326");
map.addLayer(new_layer_OSM);var t=this.document.createElement('option');
t.value=new_layer_OSM.name;t.text=new_layer_OSM.name;this.document.getElementById("editL1").appendChild(t);

}
function New_LayerGPX()
{
var htmlLayerGPX='';
htmlLayerGPX+='<a>Пожалуйста, выберите <a href="http://ru.wikipedia.org/wiki/GPX" target="_blank">GPX файл</a>:</a><br>'+
 '<input title="выберите GPX file" type="file" id="file_idGPX"><br>'+
'<p> <button type=button onclick=New_LayerGPX2()>OK</button></p>';
popup_new_fileGPX = new OpenLayers.Popup.FramedCloud("NewFilePopupGPX",
 map.getCenter(),
 new OpenLayers.Size(400,400),
 htmlLayerGPX ,
 null, true, onPopupClose);
 map.addPopup(popup_new_fileGPX);
document.getElementById("NewFilePopupGPX").onmousedown=function(event){drags(event)};
document.getElementById("NewFilePopupGPX").onmouseup=function(e){enddrag()};
document.getElementById('file_idGPX').addEventListener('change', readSingleFileGPX, false);

}
function readSingleFileGPX(evt)
{
fileZIP = evt.target.files[0]; 
}
function New_LayerGPX2()
{
var lines = [];
var headers;
var contents2;
var contents;
 if (fileZIP) {
 var r = new FileReader();
 r.onload = function(e) { 
 contents = e.target.result;
loadlayerGPX(contents);
 }
 r.readAsText(fileZIP);
 } else { 
 alert("Ошибка загрузки файла");
 }
}
function loadlayerGPX(contents)
{
var format;
var doc='';
var format1= new OpenLayers.Format.XML({});
var format2= new OpenLayers.Format.GPX({});
doc=format1.read(contents);
var value1=false;
var value2=false;
var value3=false;
var value4=false;

var tracks=doc.getElementsByTagName("trk");
if (tracks.length>0)
{value1=true;
try{attrs=format2.parseAttributes(tracks[0]);rtt=attrs; value4=true;}catch(e){}

var trkpt=doc.getElementsByTagName("trkpt");

var points=[];
for(var s=0;s<trkpt.length;s++)
{for(var jkl=0; jkl<trkpt[s].attributes.length;jkl++)
{if(trkpt[s].attributes[jkl].nodeName=="lon"){var lon=trkpt[s].attributes[jkl].nodeValue}
if(trkpt[s].attributes[jkl].nodeName=="lat"){var lat=trkpt[s].attributes[jkl].nodeValue}
}
var new_pos2=new OpenLayers.LonLat(lon,lat).transform(new OpenLayers.Projection("EPSG:4326"),map.getProjectionObject());
var attributes={};
for(var i=0;i<trkpt[s].children.length;i++)
{ var n=trkpt[s].children[i].localName;attributes[n]=trkpt[s].children[i].innerHTML}
var first_point= new OpenLayers.Feature.Vector(new OpenLayers.Geometry.Point(new_pos2.lon, new_pos2.lat));
first_point.attributes=attributes;
points.push(first_point);
}
if(trkpt&&trkpt.length>0)
{var new_layer_GPXpoint = new OpenLayers.Layer.Vector(fileZIP.name.split('.')[0]+'_Point',{renderers:["Canvas", "SVG", "VML"]});new_layer_GPXpoint.addFeatures(points);}
};
var routes=doc.getElementsByTagName("rte");
if (routes.length>0)
{value2=true;try{attrs=format2.parseAttributes(routes[0]);rtt=attrs; value4=true;}catch(e){}
var rtept=doc.getElementsByTagName("rtept");
var points=[];
for(var s=0;s<rtept.length;s++)
{for(var jkl=0; jkl<rtept[s].attributes.length;jkl++)
{if(rtept[s].attributes[jkl].nodeName=="lon"){var lon=rtept[s].attributes[jkl].nodeValue}
if(rtept[s].attributes[jkl].nodeName=="lat"){var lat=rtept[s].attributes[jkl].nodeValue}
}
var new_pos2=new OpenLayers.LonLat(lon,lat).transform(new OpenLayers.Projection("EPSG:4326"),map.getProjectionObject());
var attributes={};
for(var i=0;i<rtept[s].children.length;i++)
{ var n=rtept[s].children[i].localName;attributes[n]=rtept[s].children[i].innerHTML}
var first_point= new OpenLayers.Feature.Vector(new OpenLayers.Geometry.Point(new_pos2.lon, new_pos2.lat));
first_point.attributes=attributes;
points.push(first_point);
}
if(rtept&&rtept.length>0)
{var new_layer_GPXpoint = new OpenLayers.Layer.Vector(fileZIP.name.split('.')[0]+'_Point',{renderers:["Canvas", "SVG", "VML"]});new_layer_GPXpoint.addFeatures(points);}
};
var waypoints=doc.getElementsByTagName("wpt");
if (waypoints.length>0)
{value3=true;
try{attrs=format2.parseAttributes(waypoints[0]);value4=true;}catch(e){}
var points=[];
for(var s=0;s<waypoints.length;s++)
{for(var jkl=0; jkl<waypoints[s].attributes.length;jkl++)
{if(waypoints[s].attributes[jkl].nodeName=="lon"){var lon=waypoints[s].attributes[jkl].nodeValue}
if(waypoints[s].attributes[jkl].nodeName=="lat"){var lat=waypoints[s].attributes[jkl].nodeValue}
}
var new_pos2=new OpenLayers.LonLat(lon,lat).transform(new OpenLayers.Projection("EPSG:4326"),map.getProjectionObject());
var attributes={};
for(var i=0;i<waypoints[s].children.length;i++)
{ var n=waypoints[s].children[i].localName;attributes[n]=waypoints[s].children[i].innerHTML}
var first_point= new OpenLayers.Feature.Vector(new OpenLayers.Geometry.Point(new_pos2.lon, new_pos2.lat));
first_point.attributes=attributes;
points.push(first_point);
}
if(waypoints&&waypoints.length>0)
{var new_layer_GPXpoint = new OpenLayers.Layer.Vector(fileZIP.name.split('.')[0]+'_Point',{renderers:["Canvas", "SVG", "VML"]});new_layer_GPXpoint.addFeatures(points);}
};
format = new OpenLayers.Format.GPX({ 'internalProjection': new OpenLayers.Projection("EPSG:900913"),
'externalProjection': new OpenLayers.Projection("EPSG:4326"),extractTracks:value1,extractRoutes: value2,extractWaypoints: value3, extractAttributes: value4});
var new_layer_GPX = new OpenLayers.Layer.Vector(fileZIP.name.split('.')[0],{renderers:["Canvas", "SVG", "VML"]});
var gpxFeatures=format.read(contents); 

new_layer_GPX.addFeatures(gpxFeatures);
var new_style_layer= new OpenLayers.Style({
 pointRadius: 3, fillColor: "#FF9000", strokeColor: "#FF9000",
 strokeWidth: 2,fillOpacity:1, strokeOpacity:1 });
var new_style_layer2= new OpenLayers.Style({
 pointRadius: 3, fillColor: "#FF9000", strokeColor: "#FF9000",
 strokeWidth: 3,fillOpacity:1, strokeOpacity:1 });
 var selStyle = new OpenLayers.Style({
 pointRadius: 5,  fillColor: "#ffaa00", strokeColor: "#00DDFF",
 strokeWidth:2,fillOpacity:1, strokeOpacity:1 }); 

new_layer_GPX.styleMap=new OpenLayers.StyleMap({'default':new_style_layer2,'select': selStyle});
if((trkpt&&trkpt.length>0)||(rtept&&rtept.length>0)||(waypoints&&waypoints.length>0))
{new_layer_GPXpoint.styleMap=new OpenLayers.StyleMap({'default':new_style_layer,'select': selStyle});
map.addLayer(new_layer_GPXpoint);
var t=this.document.createElement('option');
t.value=new_layer_GPXpoint.name;
t.text=new_layer_GPXpoint.name;
this.document.getElementById("editL1").appendChild(t);
}
map.addLayer(new_layer_GPX);
var tt=this.document.createElement('option');
tt.value=new_layer_GPX.name;
tt.text=new_layer_GPX.name;
this.document.getElementById("editL1").appendChild(tt);
popup_new_fileGPX.destroy();
}
function Export_Layer_GPX()
{if(document.getElementById("editL1").value=="0")
{alert ("Выберите название слоя в списке 'Редактируемый слой'"); return;}
var htmlTextSep='';
htmlTextSep+='<a>выберите тип <a href="http://ru.wikipedia.org/wiki/GPX" target="_blank">GPX файла</a> в который будет экспортирован слой :</a><br>'+
 '<select id="sepTgpx_id"> '+
 '<option selected value="waypoint">Waypoint(точка)</option>'+
'<option value="route">Route(маршрут)</option>'+
'<option value="track">Track(трек)</option>'+
'</select><br>'+
'<a>Если необходимо добавить waypoints(точки)</a><br><a> с дополнительными данными</a><br><a>к треку или маршруту,</a><a>выберите слой с этой информацией :</a><br>'+
 '<select id="sepLayerTgpx_id"> '+
 '<option selected value="0"></option>'+
'</select><br>'+
'<p> <button type=button onclick=Export_Layer_GPX2()>OK</button></p>';
popup_new_SelGPX = new OpenLayers.Popup.FramedCloud("SelGPXfile",
 map.getCenter(),
 new OpenLayers.Size(400,400),
 htmlTextSep ,
 null, true, onPopupClose);
 map.addPopup(popup_new_SelGPX);
document.getElementById("SelGPXfile").onmousedown=function(event){drags(event)};
document.getElementById("SelGPXfile").onmouseup=function(e){enddrag()};
for(var y=0;y<map.layers.length;y++)
{if(map.layers[y].CLASS_NAME=='OpenLayers.Layer.Vector')
{var tt=this.document.createElement('option');
tt.value=map.layers[y].name;
tt.text=map.layers[y].name;
this.document.getElementById("sepLayerTgpx_id").appendChild(tt);}}
}
function Export_Layer_GPX2()
{
var format1= new OpenLayers.Format.XML({});
var format;
 format = new OpenLayers.Format.GPX({ 'internalProjection': new OpenLayers.Projection("EPSG:900913"),
'externalProjection': new OpenLayers.Projection("EPSG:4326")});
var gpxMain=format1.createElementNSPlus('gpx');
var obj={'version':"1.1",'creator':"OpenWebGIS-http://opengis.dlinkddns.com"};
format1.setAttributes(gpxMain,obj);
gpxMain.setAttribute('xmlns:xs',"http://www.w3.org/2001/XMLSchema-instance");
gpxMain.setAttribute('xsi:schemaLocation',"http://www.topografix.com/GPX/1/1 http://www.topografix.com/GPX/1/0/gpx.xsd");
if(document.getElementById("sepTgpx_id").value=='track')
{var node1=format.buildFeatureNode(edilayerMainLayer.features[0]);
if(node1.localName=='wpt')
{var gpxTrack=format1.createElementNSPlus('trk');var gpxTrack2=format1.createElementNSPlus('trkseg');
gpxTrack.appendChild(gpxTrack2);
for(var g=0;g<edilayerMainLayer.features.length;g++)
{var node22=format.buildFeatureNode(edilayerMainLayer.features[g]);gpxTrack3=format1.createElementNSPlus('trkpt');
for(var jkl=0; jkl<node22.attributes.length;jkl++)
{if(node22.attributes[jkl].nodeName=="lon"){gpxTrack3.setAttribute('lon',node22.attributes[jkl].nodeValue)}
if(node22.attributes[jkl].nodeName=="lat"){gpxTrack3.setAttribute('lat',node22.attributes[jkl].nodeValue)}}
for (var ii in edilayerMainLayer.features[g].attributes)
{var ttt=format1.createElementNSPlus(ii, {value: edilayerMainLayer.features[g].attributes[ii]});
gpxTrack3.appendChild(ttt);
}
gpxTrack2.appendChild(gpxTrack3)
}
gpxMain.appendChild(gpxTrack);
}
if(node1.localName=='trk')
{ var dopLayer='';
if(document.getElementById("sepLayerTgpx_id").value!==0)
{for(var y=0;y<map.layers.length;y++)
{if(map.layers[y].name==document.getElementById("sepLayerTgpx_id").value)
{dopLayer=map.layers[y]}}

}
var NumfeatDoplayer=0;
for(var g=0;g<edilayerMainLayer.features.length;g++)
{var node22=format.buildFeatureNode(edilayerMainLayer.features[g]);
if(dopLayer!==''){
for(var jkl=0; jkl<node22.children.length;jkl++)
{if(node22.children[jkl].nodeName=="trkseg")
{for(var jkl2=0; jkl2<node22.children[jkl].children.length;jkl2++)
{if(node22.children[jkl].children[jkl2].nodeName=="trkpt")
{for (var ii in dopLayer.features[NumfeatDoplayer].attributes)
{var ttt=format1.createElementNSPlus(ii, {value: dopLayer.features[NumfeatDoplayer].attributes[ii]});
node22.children[jkl].children[jkl2].appendChild(ttt);
}NumfeatDoplayer++;if(NumfeatDoplayer==dopLayer.features.length){NumfeatDoplayer--};}}


}
}}
gpxMain.appendChild(node22);

}
}
}

if(document.getElementById("sepTgpx_id").value=='route')
{var node1=format.buildFeatureNode(edilayerMainLayer.features[0]);
if(node1.localName=='wpt')
{var gpxTrack=format1.createElementNSPlus('rte');
for(var g=0;g<edilayerMainLayer.features.length;g++)
{var node22=format.buildFeatureNode(edilayerMainLayer.features[g]);gpxTrack3=format1.createElementNSPlus('rtept');
for(var jkl=0; jkl<node22.attributes.length;jkl++)
{if(node22.attributes[jkl].nodeName=="lon"){gpxTrack3.setAttribute('lon',node22.attributes[jkl].nodeValue)}
if(node22.attributes[jkl].nodeName=="lat"){gpxTrack3.setAttribute('lat',node22.attributes[jkl].nodeValue)}}
for (var ii in edilayerMainLayer.features[g].attributes)
{var ttt=format1.createElementNSPlus(ii, {value: edilayerMainLayer.features[g].attributes[ii]});
gpxTrack3.appendChild(ttt);
}
gpxTrack.appendChild(gpxTrack3)
}
gpxMain.appendChild(gpxTrack);
}
if(node1.localName=='trk')
{ var dopLayer='';var gpxRoute=format1.createElementNSPlus('rte');
if(document.getElementById("sepLayerTgpx_id").value!==0)
{for(var y=0;y<map.layers.length;y++)
{if(map.layers[y].name==document.getElementById("sepLayerTgpx_id").value)
{dopLayer=map.layers[y]}}

}
var NumfeatDoplayer=0;
for(var g=0;g<edilayerMainLayer.features.length;g++)
{var node22=format.buildFeatureNode(edilayerMainLayer.features[g]);
for(var jkl=0; jkl<node22.children.length;jkl++)
{if(node22.children[jkl].nodeName=="trkseg")
{for(var jkl2=0; jkl2<node22.children[jkl].children.length;jkl2++)
{if(node22.children[jkl].children[jkl2].nodeName=="trkpt")
{gpxTrack3=format1.createElementNSPlus('rtept');for(var jkl3=0; jkl3<node22.children[jkl].children[jkl2].attributes.length;jkl3++)
{if(node22.children[jkl].children[jkl2].attributes[jkl3].nodeName=="lon"){gpxTrack3.setAttribute('lon',node22.children[jkl].children[jkl2].attributes[jkl3].nodeValue)}
if(node22.children[jkl].children[jkl2].attributes[jkl3].nodeName=="lat"){gpxTrack3.setAttribute('lat',node22.children[jkl].children[jkl2].attributes[jkl3].nodeValue)} } 
if(dopLayer!==''){

for (var ii in dopLayer.features[NumfeatDoplayer].attributes)
{var ttt=format1.createElementNSPlus(ii, {value: dopLayer.features[NumfeatDoplayer].attributes[ii]});
gpxTrack3.appendChild(ttt);
}NumfeatDoplayer++;if(NumfeatDoplayer==dopLayer.features.length){NumfeatDoplayer--};


}
gpxRoute.appendChild(gpxTrack3); 

 } } } }


} }gpxMain.appendChild(gpxRoute); }

if(document.getElementById("sepTgpx_id").value=='waypoint')
{ var dopLayer='';
if(document.getElementById("sepLayerTgpx_id").value!==0)
{for(var y=0;y<map.layers.length;y++)
{if(map.layers[y].name==document.getElementById("sepLayerTgpx_id").value)
{dopLayer=map.layers[y]}}

}
var node1=format.buildFeatureNode(edilayerMainLayer.features[0]);
if(node1.localName=='wpt')
{var NumfeatDoplayer=0;for(var g=0;g<edilayerMainLayer.features.length;g++)
{var node=format.buildFeatureNode(edilayerMainLayer.features[g]);
node.removeChild(node.childNodes[0]);
node.removeChild(node.childNodes[0]);
for (var ii in edilayerMainLayer.features[g].attributes)
{var ttt=format1.createElementNSPlus(ii, {value: edilayerMainLayer.features[g].attributes[ii]});
node.appendChild(ttt);
}
if(dopLayer!==''){
for (var ii in dopLayer.features[NumfeatDoplayer].attributes)
{var ttt=format1.createElementNSPlus(ii, {value: dopLayer.features[NumfeatDoplayer].attributes[ii]});
node.appendChild(ttt);
}NumfeatDoplayer++;if(NumfeatDoplayer==dopLayer.features.length){NumfeatDoplayer--};
}
gpxMain.appendChild(node);

}}
if(node1.localName=='trk')
{
var gpxPoint=format1.createElementNSPlus('wpt');
var dopLayer='';var gpxRoute=format1.createElementNSPlus('rte');
if(document.getElementById("sepLayerTgpx_id").value!==0)
{for(var y=0;y<map.layers.length;y++)
{if(map.layers[y].name==document.getElementById("sepLayerTgpx_id").value)
{dopLayer=map.layers[y]}}

}
var NumfeatDoplayer=0;
for(var g=0;g<edilayerMainLayer.features.length;g++)
{var node22=format.buildFeatureNode(edilayerMainLayer.features[g]);
for(var jkl=0; jkl<node22.children.length;jkl++)
{if(node22.children[jkl].nodeName=="trkseg")
{for(var jkl2=0; jkl2<node22.children[jkl].children.length;jkl2++)
{if(node22.children[jkl].children[jkl2].nodeName=="trkpt")
{gpxTrack3=format1.createElementNSPlus('wpt');for(var jkl3=0; jkl3<node22.children[jkl].children[jkl2].attributes.length;jkl3++)
{if(node22.children[jkl].children[jkl2].attributes[jkl3].nodeName=="lon"){gpxTrack3.setAttribute('lon',node22.children[jkl].children[jkl2].attributes[jkl3].nodeValue)}
if(node22.children[jkl].children[jkl2].attributes[jkl3].nodeName=="lat"){gpxTrack3.setAttribute('lat',node22.children[jkl].children[jkl2].attributes[jkl3].nodeValue)} } 
if(dopLayer!==''){

for (var ii in dopLayer.features[NumfeatDoplayer].attributes)
{var ttt=format1.createElementNSPlus(ii, {value: dopLayer.features[NumfeatDoplayer].attributes[ii]});
gpxTrack3.appendChild(ttt);
}NumfeatDoplayer++;if(NumfeatDoplayer==dopLayer.features.length){NumfeatDoplayer--};


}
//gpxRoute.appendChild(gpxTrack3); 
gpxMain.appendChild(gpxTrack3); 

 } } } }


} 
}
}
var gpxText=format1.write(gpxMain);
gpxText=gpxText.replace(new RegExp(' xmlns="http://www.topografix.com/GPX/1/1"','g'),"");
gpxText=gpxText.replace(new RegExp(' xmlns=""','g'),"");

var c=' version="1.0"\r\n'+
' creator="OpenWebGIS - http://opengis.dlinkddns.com"\r\n'+
' xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"\r\n'+
' xmlns="http://www.topografix.com/GPX/1/1"\r\n'+
' xsi:schemaLocation="http://www.topografix.com/GPX/1/0 http://www.topografix.com/GPX/1/0/gpx.xsd"';
gpxText=gpxText.replace(new RegExp(' version="1.1" creator="OpenWebGIS-http://opengis.dlinkddns.com" xmlns:xs="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.topografix.com/GPX/1/1 http://www.topografix.com/GPX/1/0/gpx.xsd"','g'),c);
gpxText=gpxText.replace(new RegExp('><','g'),'>\r\n<');
gpxText='<?xml version="1.0" encoding="UTF-8"?>\r\n'+gpxText;
kmlText2='';
kmlText2=gpxText;init_download();
//myWinExport= open("download.html", "Export vector layer","width=900,height=500,status=no,toolbar=no,menubar=no,scrollbars=yes"); myWinExport.focus();
//myWinExport.onload=function(){myWinExport.document.getElementById('data').value = };
popup_new_SelGPX.destroy();
}
function New_LayerGML()
{
var htmlLayerGML='';
htmlLayerGML+='<a>Please select file:</a><br>'+
 '<input title="Select GML file" type="file" id="file_idGML"><br>'+
'<p> <button type=button onclick=New_LayerGML2()>OK</button></p>';
if (VarPostGISfromGML==1)
{htmlLayerGML='';
var dopStr='';
if(GlobalUN!=='')
{dopStr='<input type="checkbox" id="id_UseForAllPostGis" title="Если галочка не поставлена, то слой загрузится только в папку пользователя и будет доступен только ему." value="checkbox"/>Сделать слой общедоступным<br>';}
htmlLayerGML+='<a>Please select file:</a><br>'+
 '<input title="Select GML file" type="file" id="file_idGML"><br>'+
dopStr+
'<input type="checkbox" id="Exp_to_Shape" title="Export result to Shapefile" value="checkbox"/>Export result to Shapefile<br>'+
'<p> <button type=button onclick=New_LayerPostGISfromGML()>OK</button></p>';}
popup_new_fileGML = new OpenLayers.Popup.FramedCloud("NewFilePopupGML",
 map.getCenter(),
 new OpenLayers.Size(400,400),
 htmlLayerGML ,
 null, true, onPopupClose);
 map.addPopup(popup_new_fileGML);
document.getElementById('file_idGML').addEventListener('change', readSingleFileGML, false);
}
function New_LayerWMS()
{
var bbox = document.getElementById("map").getBoundingClientRect();
 var body = document.body
 var docElem = document.documentElement
 var scrollTop = window.pageYOffset || docElem.scrollTop || body.scrollTop
 var scrollLeft = window.pageXOffset || docElem.scrollLeft || body.scrollLeft
 var clientTop = docElem.clientTop || body.clientTop || 0
 var clientLeft = docElem.clientLeft || body.clientLeft || 0
 var topTop = bbox.top + scrollTop - clientTop
 var leftLeft = bbox.left + scrollLeft - clientLeft
var DivEditeLeg=document.createElement("div");
DivEditeLeg.id="id_divWMSLegMain2";
DivEditeLeg.className="id_divRoutLegMain";
DivEditeLeg.style.position="relative";
DivEditeLeg.innerHTML='<div id="id_divWMSLeg" style="background:#ffffff; color:#0000ff;z-index: 6000;position:absolute;left:'+Math.round(leftLeft+50)+'px;top:'+Math.round(topTop)+
'px;overflow:hidden; border: 1px solid black;"><img onclick="closeWMSpopUpWin()" src="openlayers/theme/default/img/close.gif" style="position:relative; top:10px;float:right; cursor:pointer"><a style="position:relative; top:20px"></a>'+
'<a style="font-size: 9px;">Вы можете перемещать это окно если щёлкните по пункту меню Интерфейс/переключить режим интерфейса/</a><br>'+
'<a>Введите URL адрес</a> <a href="http://ru.wikipedia.org/wiki/Web_Map_Service" target="_blank">WMS </a><a>сервера,</a><br>'+
'<a>который поддерживают технологию</a><a href="http://ru.wikipedia.org/wiki/Cross-origin_resource_sharing" target="_blank"> (Cross-origin resource sharing:CORS)</a><br>'+
'<a>Список WMS серверов:</a>'+ 
'<select id="id_selectWMSServer" >'+
 '<option selected value="0" >.</option>'+
 '<option value="http://maps.ngdc.noaa.gov/arcgis/services/nosa/MapServer/WmsServer" >http://maps.ngdc.noaa.gov/arcgis/services/nosa</option>'+
'<option value="http://maps.ngdc.noaa.gov/soap/web_mercator/sediment_thickness/MapServer/WMSServer" >http://maps.ngdc.noaa.gov/soap/sediment_thickness</option>'+
'<option value="http://mapserver.ngdc.noaa.gov/cgi-bin/public/mosaic" >http://mapserver.ngdc.noaa.gov/cgi-bin/public/mosaic</option>'+
'</select><br>'+
'<a>вы можете ввести</a><br><a>URL другого WMS сервера:</a>'+
'<textarea title="Введите URL WMS сервера который поддерживает технологию CORS. WMS сервер должен предоставлять слои в Системе координат WGS84 (ESPG 900913,EPSG:3857). Если слой в другой проекции то его нужно сохранить и добавить на карту через пункт меню /Добавить слой/. Строка может выглядеть например так: http://maps.ngdc.noaa.gov/soap/web_mercator/sediment_thickness/MapServer/WMSServer. WMS сервер КОТОРЫЙ НЕ поддерживает технологию CORS вы можете добавить ниже." type="text" size="18" id="id_UrlWMSAtl" value="" style="height:20px; width:300px"></textarea>url<br>'+
'<p> <button type=button onclick=OK_WMSlayer()>OK</button></p>'+
'<div id="Div_id_selectWMSServer"></div><br>'+
'<a>Введите URL WMS сервера без CORS<a><br>'+
'<textarea title="Введите WMS сервер который не поддерживает технологию CORS. Например: http://cga6.cga.harvard.edu/arcgis/services/darmc/roman/MapServer/WMSServer?request=GetCapabilities&service=WMS . WMS сервер ДОЛЖЕН предоставлять слои в Системе координат WGS84 (ESPG 900913,EPSG:3857). Если слой в другой проекции то его нужно сохранить и добавить на карту через пункт меню /Добавить слой/." type="text" size="45" id="id_UrlWMSAtl2" value="" style="height:20px; width:300px"></textarea>url<br>'+
'<p> <button type=button onclick=OK_WMSlayer2()>Получить список</button></p>'+
'<div id="Div_id_selectWMSServer2"></div><br>'+
'</div>';


;
rtt=DivEditeLeg;
if(!document.getElementById("id_divWMSLeg"))
{body.appendChild(DivEditeLeg); }
document.getElementById("id_divWMSLegMain2").onmousedown=function(event){drags(event)};
document.getElementById("id_divWMSLegMain2").onmouseup=function(e){enddrag()};
}
function OK_WMSlayer2()
{StrConnect="/geoserver/rest/workspaces/webgis/wmsstores";
var varUrl=document.getElementById('id_UrlWMSAtl2').value
try {var xmlhttp =new XMLHttpRequest();}
catch (e) {alert("error");}
var wmsstr=encodeURIComponent(document.getElementById("id_UrlWMSAtl2").value);
xmlhttp.open('GET','/temp.php?c='+wmsstr+'&rand='+Math.random(), true);
xmlhttp.setRequestHeader("Cache-Control", "no-cache");
xmlhttp.setRequestHeader("Content-type", "text/xml");
xmlhttp.onreadystatechange = function()
{if(xmlhttp.readyState == 4&&xmlhttp.status == 200) {
if(xmlhttp==''){alert("нет данных");return;}
var varlinkres=xmlhttp.responseText;
if(varlinkres!=='')
{

rtt=xmlhttp;
 if(xmlhttp==''){return;}
var strXml = xmlhttp.text;
 var oXmlDoc = null;
strXml = xmlhttp.responseText;
 if ( window.DOMParser ) {
 var oXmlParser = new DOMParser();
 oXmlDoc = oXmlParser.parseFromString( strXml, "text/xml" );
 } else {
 oXmlDoc = new ActiveXObject( "Microsoft.XMLDOM" );
 oXmlDoc.async = "false";
 oXmlDoc.loadXML( strXml );
 }
ListNameWMS = oXmlDoc.getElementsByTagName('Layer');
ListNameWMS = ListNameWMS[0].getElementsByTagName('Layer');
if(!document.getElementById("wms_dop_select2")){
var wms_dop_selectL=document.createElement('a');
var wms_dop_checkL=document.createElement('input');
wms_dop_checkL.type='checkbox';
wms_dop_checkL.id="id_wms_dop_checkL";

var wms_dop_checkSaveL=document.createElement('input');
wms_dop_checkSaveL.type='checkbox';
wms_dop_checkSaveL.id="id_wms_dop_checkSaveL";
wms_dop_checkSaveL.onclick=function(){saveWMSonClicknotCors();}
var wms_dop_DivcheckSaveL=document.createElement('div');
wms_dop_DivcheckSaveL.id="id_wms_dop_DivcheckSaveL";
var wms_dop_StrselectLT=document.createElement('a');
wms_dop_StrselectLT.innerHTML="Сохранить слой на сервере";

wms_dop_checkL.onclick=function(){if(document.getElementById("id_wms_dop_checkL").checked==true){var seldel = document.getElementById("wms_dop_select2");rtt=seldel;for(var ee=0;ee<seldel.childNodes.length;ee++){seldel.childNodes[ee].text=seldel.childNodes[ee].title;}}else{var seldel = document.getElementById("wms_dop_select2");rtt=seldel;for(var ee=0;ee<seldel.childNodes.length;ee++){seldel.childNodes[ee].text=seldel.childNodes[ee].value.split('{onlineUrlwebgis}')[0];}}}
var wms_dop_checkLT=document.createElement('a');
wms_dop_selectL.innerHTML="Слои:"
wms_dop_checkLT.innerHTML="Показать в списке описание(title) слоёв";

var wms_dop_select2=document.createElement('select');
wms_dop_select2.id="wms_dop_select2";
var wms_dop_button2=document.createElement('div');
wms_dop_button2.innerHTML='<br><input type="text" size="5" id="id_UrlWMSAtlopacity" value="0.5"/>opacity<br><p> <button id="id_wms_dop_button2" type=button onclick=OK_WMSlayerSelect2()>Добавить слой</button></p>';
if(document.getElementById("Div_id_selectWMSServer2"))
{document.getElementById("Div_id_selectWMSServer2").appendChild(wms_dop_selectL);
document.getElementById("Div_id_selectWMSServer2").appendChild(wms_dop_select2);
document.getElementById("Div_id_selectWMSServer2").appendChild(wms_dop_checkL);
document.getElementById("Div_id_selectWMSServer2").appendChild(wms_dop_checkLT);
document.getElementById("Div_id_selectWMSServer2").appendChild(document.createElement('br'));
document.getElementById("Div_id_selectWMSServer2").appendChild(wms_dop_checkSaveL);
document.getElementById("Div_id_selectWMSServer2").appendChild(wms_dop_StrselectLT);
document.getElementById("Div_id_selectWMSServer2").appendChild(wms_dop_DivcheckSaveL);

document.getElementById("Div_id_selectWMSServer2").appendChild(wms_dop_button2);
}
}
else
{
 var seldel = document.getElementById("wms_dop_select2");
 while (seldel.childNodes.length) {
 if (seldel.firstChild.tagName == 'OPTGROUP') {
 while (seldel.firstChild.childNodes.length) {
 seldel.firstChild.removeChild(seldel.firstChild.firstChild); } }
 seldel.removeChild(seldel.firstChild); }
var t=document.createElement('option');
t.value="0";
t.text=" ";
document.getElementById("wms_dop_select2").appendChild(t);
}
document.getElementById("id_wms_dop_button2").onclick=function(){OK_WMSlayerSelect2(varUrl.split('?')[0])}
for (var a=0; a<ListNameWMS.length; a++)
{ 
var tagNames=ListNameWMS[a].getElementsByTagName("Name");
var tagTitles=ListNameWMS[a].getElementsByTagName("Title");
var tagStyle=ListNameWMS[a].getElementsByTagName("Style");
var styleUrl='';
for(var ee=0;ee<tagStyle.length;ee++)
{
if(tagStyle[ee].getElementsByTagName("OnlineResource")[0])
{
var onlinwUrl=tagStyle[ee].getElementsByTagName("OnlineResource")[0];
for(var atr=0;atr<onlinwUrl.attributes.length;atr++)
{if(onlinwUrl.attributes[atr].nodeName.indexOf('href')!=-1){styleUrl=onlinwUrl.attributes[atr].nodeValue;}}}
}
var count=0;
if(tagNames){
for(var aa=0; aa<tagNames.length; aa++)
{
if(tagNames[aa].parentNode.nodeName!=='Style'){
var tagStyle2=tagNames[aa].parentNode.getElementsByTagName("Style");
if(tagStyle2[0]){
if(tagStyle2[0].getElementsByTagName("OnlineResource")[0])
{
var onlinwUrl=tagStyle2[0].getElementsByTagName("OnlineResource")[0];
for(var atr=0;atr<onlinwUrl.attributes.length;atr++)
{if(onlinwUrl.attributes[atr].nodeName.indexOf('href')!=-1){styleUrl=onlinwUrl.attributes[atr].nodeValue;}}}}
var t=document.createElement('option');
 t.value=tagNames[aa].textContent+'{onlineUrlwebgis}'+styleUrl;
 t.text=tagNames[aa].textContent;
if(tagNames[aa].nextElementSibling.nodeName=='Title'){if(tagNames[aa].nextElementSibling.textContent.split('<![CDATA[')[1]){
 t.title=tagNames[aa].nextElementSibling.textContent.split('<![CDATA[')[1].split(']]>')[0];}
else{ t.title=tagNames[aa].nextElementSibling.textContent;}}
 document.getElementById("wms_dop_select2").appendChild(t);}
}}}



}}
}
alert("Эта функция работает только в онлайн веб-версии OpenWebGIS")
{return;
xmlhttp.send(null);}
}
function saveWMSonClicknotCors()
{//if(document.getElementById("Div_id_selectWMSServer2"))
if(document.getElementById("id_wms_dop_checkSaveL").checked==true)
{if(!document.getElementById("id_wms_dop_WMSSave3")){
var wms_dop_WMSSave2=document.createElement('a');
wms_dop_WMSSave2.innerHTML="Название хранилища слоёв:"
var wms_dop_WMSSave3=document.createElement('input');
wms_dop_WMSSave3.style.width=85;
wms_dop_WMSSave3.type='text';
wms_dop_WMSSave3.value="WMSwebgis";
wms_dop_WMSSave3.id="id_wms_dop_WMSSave3";

var wms_dop_WMSSave4=document.createElement('a');
wms_dop_WMSSave4.innerHTML="Название слоя:"
var wms_dop_WMSSave5=document.createElement('input');
wms_dop_WMSSave5.style.width=75;
wms_dop_WMSSave5.type='text';
wms_dop_WMSSave5.value="name";
wms_dop_WMSSave5.id="id_wms_dop_WMSSave5";

var wms_dop_WMSSave6=document.createElement('a');
wms_dop_WMSSave6.innerHTML="Проекция слоя"
var wms_dop_WMSSave7=document.createElement('input');
wms_dop_WMSSave7.style.width=85;
wms_dop_WMSSave7.type='text';
wms_dop_WMSSave7.value="ESPG:4326";
wms_dop_WMSSave7.id="id_wms_dop_WMSSave6";

var wms_dop_WMSSave1=document.createElement('div');
wms_dop_WMSSave1.innerHTML='<br><p> <button id="wms_dop_WMSSave1B" type=button onclick=OK_wms_WMSSave1()>Сохранить слой</button></p>';
document.getElementById("id_wms_dop_DivcheckSaveL").appendChild(wms_dop_WMSSave2);
document.getElementById("id_wms_dop_DivcheckSaveL").appendChild(wms_dop_WMSSave3);
document.getElementById("id_wms_dop_DivcheckSaveL").appendChild(wms_dop_WMSSave4);
document.getElementById("id_wms_dop_DivcheckSaveL").appendChild(wms_dop_WMSSave5);
document.getElementById("id_wms_dop_DivcheckSaveL").appendChild(document.createElement('br'));
document.getElementById("id_wms_dop_DivcheckSaveL").appendChild(wms_dop_WMSSave1);
}
}
}
function OK_wms_WMSSave1()
{
var StrConnect="/geoserver/rest/workspaces/webgis/wmsstores";
alert("Эта функция работает только в онлайн веб-версии OpenWebGIS")
 {return;}
var putRequest = OpenLayers.Request.POST({
url: StrConnect,
async:false,
data:'<wmsStore>'+
'<name>'+document.getElementById('id_wms_dop_WMSSave3').value+'</name>'+
'<description>'+document.getElementById('id_wms_dop_WMSSave3').value+'</description>'+
'<type>WMS</type>'+
'<enabled>true</enabled>'+
'<metadata>'+
'<entry key="useConnectionPooling">true</entry>'+
'</metadata>'+
'<__default>false</__default>'+
'<capabilitiesURL>'+document.getElementById("id_UrlWMSAtl2").value.replace(/&/g,"&amp;")+'</capabilitiesURL>'+
'<maxConnections>6</maxConnections>'+
'<readTimeout>60</readTimeout>'+
'<connectTimeout>30</connectTimeout>'+
'</wmsStore>',
headers: {
 "Content-Type": "application/xml"
 },
 callback: function (response) {
rtt=response.responseText;
alert("Эта функция работает только в онлайн веб-версии OpenWebGIS")
 {return;}
var putRequest2 = OpenLayers.Request.POST({
url: StrConnect+'/'+document.getElementById('id_wms_dop_WMSSave3').value+'/wmslayers',
async:false,
data:'<wmsLayer>'+
   '<name>'+document.getElementById('id_wms_dop_WMSSave5').value+'</name>'+
  '<nativeName>'+document.getElementById('wms_dop_select2').value.split('{onlineUrlwebgis}')[0]+'</nativeName>'+
  '<projectionPolicy>FORCE_DECLARED</projectionPolicy>'+
  '<enabled>true</enabled> '+
'</wmsLayer>',
headers: {
 "Content-Type": "application/xml"
 },
 callback: function (response) {alert("Сохранено");},
failure: function (response) {
 alert(""+response.responseText);
 }
});

},
failure: function (response) {
 alert(""+response.responseText);
 }
}); 
}
function OK_WMSlayerSelect2(varurl)
{map.baseLayer.projection=new OpenLayers.Projection("EPSG:3857");
var wms = new OpenLayers.Layer.WMS(document.getElementById("wms_dop_select2").value.split('{onlineUrlwebgis}')[0],
 varurl,
 {transparent: true,layers: document.getElementById("wms_dop_select2").value.split('{onlineUrlwebgis}')[0]},
 {isBaseLayer: false,queryable: true,
projection: new OpenLayers.Projection("EPSG:3857"),
minResolution: null,
maxResolution: 156543.03390625,
numZoomLevels : 32,
maxScale: null,
minScale: null,
opacity:document.getElementById("id_UrlWMSAtlopacity").value,
displayOutsideMaxExtent: true,
maxExtent: new OpenLayers.Bounds(-20037508.34, -20037508.34, 20037508.34, 20037508.34),
minExtent : null}
);
map.addLayer(wms);
 var htmlText2='<a>legend</a><br><a><img id="Img_'+document.getElementById("wms_dop_select2").value.split('{onlineUrlwebgis}')[0]+'" src="'+document.getElementById("wms_dop_select2").value.split('{onlineUrlwebgis}')[1]+'" alt="legend"/></a>';
var new_pos2=new OpenLayers.LonLat(1,0).transform(
new OpenLayers.Projection("EPSG:4326"),
new OpenLayers.Projection("EPSG:900913")).clone();
var new_lon=new_pos2.lon;
var new_lat=new_pos2.lat;
var new_new_pos=new OpenLayers.LonLat(map.getCenter().lon+new_lon+2,map.getCenter().lat);
popup_interWms = new OpenLayers.Popup("WmsPopup"+document.getElementById("wms_dop_select2").value.split('{onlineUrlwebgis}')[0],
 new_new_pos,
new OpenLayers.Size(100,100),
 htmlText2 ,
 true, onPopupClose);
 map.addPopup(popup_interWms);
var image = document.getElementById("Img_"+document.getElementById("wms_dop_select2").value.split('{onlineUrlwebgis}')[0]).onload=function(){ 
 var NewImage=document.getElementById("Img_"+document.getElementById("wms_dop_select2").value.split('{onlineUrlwebgis}')[0]);
popup_interWms.setSize(new OpenLayers.Size(parseInt(NewImage.width+30),parseInt(NewImage.height+30)));
}
rtt=document.getElementById("WmsPopup"+document.getElementById("wms_dop_select2").value.split('{onlineUrlwebgis}')[0]);
document.getElementById("WmsPopup"+document.getElementById("wms_dop_select2").value.split('{onlineUrlwebgis}')[0]).onmousedown=function(event){drags(event)};
document.getElementById("WmsPopup"+document.getElementById("wms_dop_select2").value.split('{onlineUrlwebgis}')[0]).onmouseup=function(e){enddrag()};
}
function OK_WMSlayer()
{
var varUrl='';
if(document.getElementById('id_selectWMSServer').value!=="0")
{varUrl=document.getElementById('id_selectWMSServer').value+'?service=wms&request=GetCapabilities';}
else{if(document.getElementById('id_UrlWMSAtl').value!==''){if(document.getElementById('id_UrlWMSAtl').value.indexOf('?')!=-1){varUrl=document.getElementById('id_UrlWMSAtl').value;}else{varUrl=document.getElementById('id_UrlWMSAtl').value+'?service=wms&request=GetCapabilities'}}}
if(varUrl==''){alert("Please insert URL of the WMS server");return;}
var xmlhttp =new XMLHttpRequest();
xmlhttp.open('GET',varUrl, false);
var ListNameWMS;
xmlhttp.onreadystatechange = function()
{if(xmlhttp.readyState == 4&&xmlhttp.status == 200) {
rtt=xmlhttp;
 if(xmlhttp==''){return;}
var strXml = xmlhttp.text;
 var oXmlDoc = null;
strXml = xmlhttp.responseText;
 if ( window.DOMParser ) {
 var oXmlParser = new DOMParser();
 oXmlDoc = oXmlParser.parseFromString( strXml, "text/xml" );
 } else {
 oXmlDoc = new ActiveXObject( "Microsoft.XMLDOM" );
 oXmlDoc.async = "false";
 oXmlDoc.loadXML( strXml );
 }
ListNameWMS = oXmlDoc.getElementsByTagName('Layer');
ListNameWMS = ListNameWMS[0].getElementsByTagName('Layer');
if(!document.getElementById("wms_dop_select")){
var wms_dop_select=document.createElement('select');
wms_dop_select.id="wms_dop_select";
var wms_dop_button=document.createElement('div');
wms_dop_button.innerHTML='<br><input type="text" size="5" id="id_UrlWMSAtlopacity" value="0.5"/>opacity<br><p> <button id="id_wms_dop_button" type=button onclick=OK_WMSlayerSelect()>Добавить слой</button></p>';
if(document.getElementById("Div_id_selectWMSServer"))
{document.getElementById("Div_id_selectWMSServer").appendChild(wms_dop_select);
document.getElementById("Div_id_selectWMSServer").appendChild(wms_dop_button);
}
}
else
{
 var seldel = document.getElementById("wms_dop_select");
 while (seldel.childNodes.length) {
 if (seldel.firstChild.tagName == 'OPTGROUP') {
 while (seldel.firstChild.childNodes.length) {
 seldel.firstChild.removeChild(seldel.firstChild.firstChild); } }
 seldel.removeChild(seldel.firstChild); }
var t=document.createElement('option');
t.value="0";
t.text=" ";
document.getElementById("wms_dop_select").appendChild(t);
}
document.getElementById("id_wms_dop_button").onclick=function(){OK_WMSlayerSelect(varUrl.split('?service=wms&request=GetCapabilities')[0])}
for (var a=0; a<ListNameWMS.length; a++)
{ 
var tagNames=ListNameWMS[a].getElementsByTagName("Name");
var tagTitles=ListNameWMS[a].getElementsByTagName("Title");
var tagStyle=ListNameWMS[a].getElementsByTagName("Style");
var styleUrl='';
for(var ee=0;ee<tagStyle.length;ee++)
{
if(tagStyle[ee].getElementsByTagName("OnlineResource")[0])
{var onlinwUrl=tagStyle[ee].getElementsByTagName("OnlineResource")[0];
for(var atr=0;atr<onlinwUrl.attributes.length;atr++)
{if(onlinwUrl.attributes[atr].nodeName.indexOf('href')!=-1){styleUrl=onlinwUrl.attributes[atr].nodeValue;}}}
}
var count=0;
if(tagNames){
for(var aa=0; aa<tagNames.length; aa++)
{
if(tagNames[aa].parentNode.nodeName!=='Style'){
var tagStyle2=tagNames[aa].parentNode.getElementsByTagName("Style");
if(tagStyle2[0]){
if(tagStyle2[0].getElementsByTagName("OnlineResource")[0])
{
var onlinwUrl=tagStyle2[0].getElementsByTagName("OnlineResource")[0];
for(var atr=0;atr<onlinwUrl.attributes.length;atr++)
{if(onlinwUrl.attributes[atr].nodeName.indexOf('href')!=-1){styleUrl=onlinwUrl.attributes[atr].nodeValue;}}}}
var t=document.createElement('option');
 t.value=tagNames[aa].textContent+'{onlineUrlwebgis}'+styleUrl;
 t.text=tagNames[aa].textContent;
if(tagNames[aa].nextElementSibling.nodeName=='Title'){if(tagNames[aa].nextElementSibling.textContent.split('<![CDATA[')[1]){
 t.title=tagNames[aa].nextElementSibling.textContent.split('<![CDATA[')[1].split(']]>')[0];}
else{ t.title=tagNames[aa].nextElementSibling.textContent;}}
 document.getElementById("wms_dop_select").appendChild(t);}
}}}
//popup_WMS_new.updateSize();
}}
alert("Эта функция работает только в онлайн веб-версии OpenWebGIS")
{return;
xmlhttp.send(null);}

}
function OK_WMSlayerSelect(varurl)
{
if(varurl.indexOf('.ngdc.noaa.gov')!=-1)
{map.baseLayer.projection=new OpenLayers.Projection("EPSG:3857");}
var wms = new OpenLayers.Layer.WMS(document.getElementById("wms_dop_select").value.split('{onlineUrlwebgis}')[0],
 varurl,
 {transparent: true,layers: document.getElementById("wms_dop_select").value.split('{onlineUrlwebgis}')[0]},
 {isBaseLayer: false,queryable: true,
projection: new OpenLayers.Projection("EPSG:3857"),
minResolution: null,
maxResolution: 156543.03390625,
numZoomLevels : 32,
maxScale: null,
minScale: null,
opacity:document.getElementById("id_UrlWMSAtlopacity").value,
maxExtent: new OpenLayers.Bounds(-20037508.34, -20037508.34, 20037508.34, 20037508.34),
minExtent : null}
);
map.addLayer(wms);
 var htmlText2='<a>legend</a><br><a><img id="Img_'+document.getElementById("wms_dop_select").value.split('{onlineUrlwebgis}')[0]+'" src="'+document.getElementById("wms_dop_select").value.split('{onlineUrlwebgis}')[1]+'" alt="legend"/></a>';
var new_pos2=new OpenLayers.LonLat(1,0).transform(
new OpenLayers.Projection("EPSG:4326"),
new OpenLayers.Projection("EPSG:900913")).clone();
var new_lon=new_pos2.lon;
var new_lat=new_pos2.lat;
var new_new_pos=new OpenLayers.LonLat(map.getCenter().lon+new_lon+2,map.getCenter().lat);
popup_interWms = new OpenLayers.Popup("WmsPopup"+document.getElementById("wms_dop_select").value.split('{onlineUrlwebgis}')[0],
 new_new_pos,
new OpenLayers.Size(100,100),
 htmlText2 ,
 true, onPopupClose);
 map.addPopup(popup_interWms);
var image = document.getElementById("Img_"+document.getElementById("wms_dop_select").value.split('{onlineUrlwebgis}')[0]).onload=function(){ 
 var NewImage=document.getElementById("Img_"+document.getElementById("wms_dop_select").value.split('{onlineUrlwebgis}')[0]);
popup_interWms.setSize(new OpenLayers.Size(parseInt(NewImage.width+30),parseInt(NewImage.height+30)));
}
rtt=document.getElementById("WmsPopup"+document.getElementById("wms_dop_select").value.split('{onlineUrlwebgis}')[0]);
document.getElementById("WmsPopup"+document.getElementById("wms_dop_select").value.split('{onlineUrlwebgis}')[0]).onmousedown=function(event){drags(event)};
document.getElementById("WmsPopup"+document.getElementById("wms_dop_select").value.split('{onlineUrlwebgis}')[0]).onmouseup=function(e){enddrag()};
}
function New_LayerKML()
{
var htmlLayerKML='';
htmlLayerKML+='<a>Please select file:</a><br>'+
 '<input title="Select KML file" type="file" id="file_idKML"><br>'+
'<p> <button type=button onclick=New_LayerKML2()>OK</button></p>';
popup_new_fileKML = new OpenLayers.Popup.FramedCloud("NewFilePopupKML",
 map.getCenter(),
 new OpenLayers.Size(400,400),
 htmlLayerKML ,
 null, true, onPopupClose);
 map.addPopup(popup_new_fileKML);
document.getElementById('file_idKML').addEventListener('change', readSingleFileKML, false);
}
function New_LayerKML2()
{ 
var lines = [];
var headers;
var contents2;
var contents;
 if (fileZIP) {
 var r = new FileReader();
 r.onload = function(e) { 
 contents = e.target.result;
 loadlayerKML(contents);
 }
 r.readAsText(fileZIP);
 } else { 
 alert("Ошибка загрузки файла");
 }
}
function loadlayerKML(contents)
{
var kmlFeatures;
var format;
 format = new OpenLayers.Format.KML({
 'extractStyles':true,
'extractAttributes':true,
'foldersName':'OpenWebGIS',
'maxDepth':3,
 'internalProjection': new OpenLayers.Projection("EPSG:900913"),
 'externalProjection': new OpenLayers.Projection("EPSG:4326")
 });
var new_layer_KML = new OpenLayers.Layer.Vector(fileZIP.name.split('.')[0],{renderers:["Canvas", "SVG", "VML"]});
var kmlFeatures=format.read(contents); 
new_layer_KML.addFeatures(kmlFeatures);
var new_style_layer= new OpenLayers.Style({
 pointRadius: 3,
 fillColor: "#FF9000",
 strokeColor: "#FF9000",
 strokeWidth: 1,
fillOpacity:1,
 strokeOpacity:1
 });
 var selStyle = new OpenLayers.Style({
 pointRadius: 5, 
 fillColor: "#ffaa00",
 strokeColor: "#00DDFF",
 strokeWidth:2,
fillOpacity:1,
 strokeOpacity:1
 }); 
new_layer_KML.styleMap=new OpenLayers.StyleMap({'default':new_style_layer,'select': selStyle});
for(var v=0;v<new_layer_KML.features.length;v++)
{for (h in new_layer_KML.features[v].attributes)
{ if(typeof (new_layer_KML.features[v].attributes[h])=='object')
{new_layer_KML.features[v].attributes[h]=new_layer_KML.features[v].attributes[h].value; }
} }
map.addLayer(new_layer_KML);
var t=this.document.createElement('option');
t.value=new_layer_KML.name;
t.text=new_layer_KML.name;
this.document.getElementById("editL1").appendChild(t);
popup_new_fileKML.destroy();
}
function New_LayerFileUrl()
{
var bbox = document.getElementById("map").getBoundingClientRect();
 var body = document.body
 var docElem = document.documentElement
 var scrollTop = window.pageYOffset || docElem.scrollTop || body.scrollTop
 var scrollLeft = window.pageXOffset || docElem.scrollLeft || body.scrollLeft
 var clientTop = docElem.clientTop || body.clientTop || 0
 var clientLeft = docElem.clientLeft || body.clientLeft || 0
 var topTop = bbox.top + scrollTop - clientTop
 var leftLeft = bbox.left + scrollLeft - clientLeft
var DivEditeLeg=document.createElement("div");
DivEditeLeg.id="id_FileUrlLegMain2";
DivEditeLeg.className="id_divRoutLegMain";
DivEditeLeg.style.position="relative";

DivEditeLeg.innerHTML='<div id="id_divFileurlLeg" style="background:#ffffff; color:#0000ff;z-index: 6000;position:absolute;left:'+Math.round(leftLeft+50)+'px;top:'+Math.round(topTop-50)+
'px;overflow:hidden; border: 1px solid black;"><img onclick="closeFileurlWin()" src="openlayers/theme/default/img/close.gif" style="position:relative; top:10px;float:right; cursor:pointer"><a style="position:relative; top:20px"></a>'+
'<a style="font-size: 9px;"> Вы можете перемещать это окно если щёлкните по пункту меню: переключить режим интерфейса</a><br>'+
'<a>введите url файла:</a><textarea type="text" size="40" id="urlFileurlpopUp" value="" title="например: http://host.com/data.kml" style="width: 200px; height: 20px;"></textarea><br>'+
'<a>географическая проекция:<a></a><input type="text" size="20" id="urlFileurlpopUp2" value="EPSG:4326"/><br>'+
'<a>название слоя:<a></a><input type="text" size="20" id="urlFileurlpopUp3" value="name"/><br>'+
'<a>установите формат файла:</a><input type="checkbox" id="id_urlFileurlpopUpKML" title="" value="checkbox"/>kml'+
'<input type="checkbox" id="id_urlFileurlpopUpGML" title="" value="checkbox"/>gml<br>'+
'<p> <button type=button onclick=New_LayerFileUrl2()>OK</button></p></div>';
if(!document.getElementById("id_FileUrlLegMain2"))
{body.appendChild(DivEditeLeg); }
document.getElementById("id_FileUrlLegMain2").onmousedown=function(event){drags(event)};
document.getElementById("id_FileUrlLegMain2").onmouseup=function(e){enddrag()};
}
function New_LayerFileUrl2(){myUrl=document.getElementById("urlFileurlpopUp").value;
if(document.getElementById("id_urlFileurlpopUpKML").checked==false&&document.getElementById("id_urlFileurlpopUpGML").checked==false)
{alert('Пожалуйста, установите формат файла');return;}
try {var xmlhttp =new XMLHttpRequest();}
catch (e) {alert("error");}
//var wmsstr=encodeURIComponent(document.getElementById("id_UrlWMSAtl2").value);
xmlhttp.open('GET','/temp.php?c='+myUrl+'&rand='+Math.random(), true);
xmlhttp.setRequestHeader("Cache-Control", "no-cache");
xmlhttp.setRequestHeader("Content-type", "text/xml");
xmlhttp.onreadystatechange = function()
{if(xmlhttp.readyState == 4&&xmlhttp.status == 200) {myUrl=xmlhttp.responseText;
var kmlFeatures;
var format;
 format = new OpenLayers.Format.KML({
'extractAttributes':true,
 'internalProjection': new OpenLayers.Projection("EPSG:900913"),
 'externalProjection': new OpenLayers.Projection(document.getElementById("urlFileurlpopUp2").value)
 });
 formatgml = new OpenLayers.Format.GML({
 'extractStyles':true,'extractAttributes':true,
 'internalProjection': new OpenLayers.Projection("EPSG:900913"),
 'externalProjection': new OpenLayers.Projection(document.getElementById("urlFileurlpopUp2").value)
 });
var new_layer_KML = new OpenLayers.Layer.Vector(document.getElementById("urlFileurlpopUp3").value,{renderers:["Canvas", "SVG", "VML"]});
if(document.getElementById("id_urlFileurlpopUpKML").checked==true)
{var kmlFeatures=format.read(myUrl); }
if(document.getElementById("id_urlFileurlpopUpGML").checked==true)
{var kmlFeatures=formatgml.read(myUrl);}
new_layer_KML.addFeatures(kmlFeatures);
var new_style_layer= new OpenLayers.Style({
 pointRadius: 3, fillColor: "#FF9000",
 strokeColor: "#FF9000", strokeWidth: 1,
fillOpacity:1, strokeOpacity:1 });
 var selStyle = new OpenLayers.Style({
 pointRadius: 5,  fillColor: "#ffaa00",
 strokeColor: "#00DDFF", strokeWidth:2,
fillOpacity:1, strokeOpacity:1 }); 
new_layer_KML.styleMap=new OpenLayers.StyleMap({'default':new_style_layer,'select': selStyle});

var t=document.createElement('option');
t.value=new_layer_KML.name;
t.text=new_layer_KML.name;

document.getElementById("editL1").appendChild(t);
map.addLayer(new_layer_KML);
new_layer_KML.events.register("loadstart",new_layer_KML, function() {WaitWindow();}); 
new_layer_KML.events.register("loadend",new_layer_KML, function() {if(popup_Wait){try{popup_Wait.destroy();}catch(e){};} });

}}
alert("Эта функция работает только в онлайн веб-версии OpenWebGIS")
{return;
xmlhttp.send(null);}

}
function New_LayerImageUrl ()
{
var bbox = document.getElementById("map").getBoundingClientRect();
 var body = document.body
 var docElem = document.documentElement
 var scrollTop = window.pageYOffset || docElem.scrollTop || body.scrollTop
 var scrollLeft = window.pageXOffset || docElem.scrollLeft || body.scrollLeft
 var clientTop = docElem.clientTop || body.clientTop || 0
 var clientLeft = docElem.clientLeft || body.clientLeft || 0
 var topTop = bbox.top + scrollTop - clientTop
 var leftLeft = bbox.left + scrollLeft - clientLeft
var DivEditeLeg=document.createElement("div");
DivEditeLeg.id="id_divImageFileURLLegMain2";
DivEditeLeg.className="id_divRoutLegMain";
DivEditeLeg.style.position="relative";
//DivEditeLeg.onmouseup="enddrag()";DivEditeLeg.onmousedown="drags(event)"
DivEditeLeg.innerHTML='<div id="id_divImageFileURLLeg" style="background:#ffffff; color:#0000ff;z-index: 6000;position:absolute;left:'+Math.round(leftLeft+50)+'px;top:'+Math.round(topTop-100)+
'px;overflow:hidden; border: 1px solid black;"><img onclick="closeImageFileWin2()" src="openlayers/theme/default/img/close.gif" style="position:relative; top:10px;float:right; cursor:pointer"><a style="position:relative; top:20px"></a>'+
'<a style="font-size: 9px;">Вы можете перемещать это окно если щёлкните по пункту меню: Интерфейс->переключить режим интерфейса</a><br>'+
'<a>Пожалуйста введите URL файла изображения</a><br>'+
 '<textarea title="Введите url картинки" id="URL_idImage" style="height:50px; width:200px"></textarea><br>'+
'<input title="координата нижнего левого угла. Вы можете щёлкнуть по карте или ввести координаты сами. Координаты вводятся после клика по карте, если в этом поле указан ноль или пусто." type="text" size="8" id="first_longI" value="0"/>нижняя левая долгота, вы можете щёлкнуть по карте<br>'+
'<input title="coordinate of the lower left corner" type="text" size="8" id="first_latI" value="0"/>нижняя левая широта<br>'+
'<input title="координата верхнего правого угла. Вы можете щёлкнуть по карте или ввести координаты сами. Координаты вводятся после клика по карте, если в этом поле указан ноль или пусто." type="text" size="8" id="sec_longI" value="0"/>верхняя правая долгота<br>'+
'<input title="coordinate of the upper-right corner" type="text" size="8" id="sec_latI" value="0"/>верхняя правая широта<br>'+
'<a>Название слоя:</a><input type="text" size="35" id="id_textImageURLLayer" title="Введите название слоя:" value="ImageURL"/>'+
'<p> <button type=button onclick=OK_fileImageURL()>OK</button></p></div>';
if(!document.getElementById("id_divImageFileURLLeg"))
{body.appendChild(DivEditeLeg); 
OpenLayers.Control.Click = OpenLayers.Class(OpenLayers.Control, {                
defaultHandlerOptions: {'single': true,'double': false,'pixelTolerance': 0,'stopSingle': false,'stopDouble': false},
initialize: function(options) {
this.handlerOptions = OpenLayers.Util.extend(
{}, this.defaultHandlerOptions);
OpenLayers.Control.prototype.initialize.apply(
this, arguments); 
this.handler = new OpenLayers.Handler.Click(
                        this, {'click': this.trigger}, this.handlerOptions
                    );
                }, 
trigger: function(e) {
var lonlat = map.getLonLatFromPixel(e.xy);
var new_pos=new OpenLayers.LonLat(lonlat.lon,lonlat.lat).transform(
map.getProjectionObject(),new OpenLayers.Projection("EPSG:4326"));
if(document.getElementById("first_longI"))
{if(document.getElementById("first_longI").value==''||document.getElementById("first_longI").value=='0')
{document.getElementById("first_longI").value=new_pos.lon;
document.getElementById("first_latI").value=new_pos.lat;}
else{
if(document.getElementById("sec_longI").value==''||document.getElementById("sec_longI").value=='0')
{document.getElementById("sec_longI").value=new_pos.lon;
document.getElementById("sec_latI").value=new_pos.lat;}}
}

    }

});
var clickImageCoordinates2 = new OpenLayers.Control.Click();
clickImageCoordinates2.title="click to get coordinates of ImageLayer URL";
 map.addControl(clickImageCoordinates2);
clickImageCoordinates2.activate();

document.getElementById("id_divImageFileURLLegMain2").onmousedown=function(event){drags(event)};
document.getElementById("id_divImageFileURLLegMain2").onmouseup=function(e){enddrag()};
}



}
function New_LayerGML2()
{ 
var lines = [];
var headers;
var contents2;
var contents;
 if (fileZIP) {
 var r = new FileReader();
 r.onload = function(e) { 
 contents = e.target.result;
loadlayerGML(contents);
 }
 r.readAsText(fileZIP);
 } else { 
 alert("Ошибка загрузки файла");
 }
}
function loadlayerGML(contents)
{
var gmlFeatures;
var format;
 format = new OpenLayers.Format.GML({
 'extractStyles':true,
'extractAttributes':true,
 'internalProjection': new OpenLayers.Projection("EPSG:900913"),
 'externalProjection': new OpenLayers.Projection("EPSG:4326")
 });
var new_layer_GML = new OpenLayers.Layer.Vector(fileZIP.name.split('.')[0],{renderers:["Canvas", "SVG", "VML"]});
var gmlFeatures=format.read(contents); 
new_layer_GML.addFeatures(gmlFeatures);
var new_style_layer= new OpenLayers.Style({
 pointRadius: 3,
 fillColor: "#FF9000",
 strokeColor: "#FF9000",
 strokeWidth: 1,
fillOpacity:1,
 strokeOpacity:1
 });
 var selStyle = new OpenLayers.Style({
 pointRadius: 5, 
 fillColor: "#ffaa00",
 strokeColor: "#00DDFF",
 strokeWidth:2,
fillOpacity:1,
 strokeOpacity:1
 }); 
new_layer_GML.styleMap=new OpenLayers.StyleMap({'default':new_style_layer,'select': selStyle});
map.addLayer(new_layer_GML);
var t=this.document.createElement('option');
t.value=new_layer_GML.name;
t.text=new_layer_GML.name;
this.document.getElementById("editL1").appendChild(t);
popup_new_fileGML.destroy();
}
function onChangeTimeKvadr()
{var fieldDateTime=document.getElementById("TimeAggreg_kvadr").value;
var minDistC = edilayerMainLayer.features[0].attributes[fieldDateTime];
if(edilayerMainLayer.features[0].attributes[fieldDateTime].split('T')[1]){
 var a1= edilayerMainLayer.features[0].attributes[fieldDateTime].split('T')[0].split('-').join ('');
var a2= edilayerMainLayer.features[0].attributes[fieldDateTime].split('T')[1].split(':').join ('');}
else{alert("Error date format. You can use the option 'Change date/time format' in the bottom of this popup window");return;}
var b=a1+a2;
b=parseInt(b);
minDistC=b;var minDistC2=edilayerMainLayer.features[0].attributes[fieldDateTime];
 var maxDistC = parseInt(minDistC); var maxDistC2=edilayerMainLayer.features[0].attributes[fieldDateTime];;
 for (ia = 1; ia < edilayerMainLayer.features.length; ++ia) { var NumSS2=edilayerMainLayer.features[ia].attributes[fieldDateTime];

 var a1= edilayerMainLayer.features[ia].attributes[fieldDateTime].split('T')[0].split('-').join ('');
var a2= edilayerMainLayer.features[ia].attributes[fieldDateTime].split('T')[1].split(':').join ('');
b=a1+a2;
b=parseInt(b);
var NumSS=b
 if (NumSS>parseFloat(maxDistC) ){ maxDistC = NumSS;maxDistC2=edilayerMainLayer.features[ia].attributes[fieldDateTime];}
 if( NumSS<parseFloat(minDistC) ) {minDistC = NumSS; minDistC2=edilayerMainLayer.features[ia].attributes[fieldDateTime];}
 }
var minDate=minDistC2;
var minDate11=minDate.split('T')[0];
document.getElementById("PrhtmlTimeYear1").value=minDate11.split('-')[0];
document.getElementById("PrhtmlTimeMonth1").value=minDate11.split('-')[1];
document.getElementById("PrhtmlTimeDay1").value=minDate11.split('-')[2];

var maxDate=maxDistC2;
var maxDate11=maxDate.split('T')[0];
document.getElementById("PrhtmlTimeYear2").value=maxDate11.split('-')[0];
document.getElementById("PrhtmlTimeMonth2").value=maxDate11.split('-')[1];
document.getElementById("PrhtmlTimeDay2").value=maxDate11.split('-')[2];
}
function onChangeTimeLine()
{
var fieldDateTime=document.getElementById("TimeLayerField").value;
var minDistC = edilayerMainLayer.features[0].attributes[fieldDateTime];
var err=(edilayerMainLayer.features[0].attributes[fieldDateTime]/edilayerMainLayer.features[0].attributes[fieldDateTime]) ? true : false; 
if(err==true){TimeFieldowg="number";document.getElementById("id_timeinterNum").style.display="block";document.getElementById("id_timeinterStr").style.display="none";
var minDistC = parseFloat(edilayerMainLayer.features[0].attributes[fieldDateTime]);
 var maxDistC = parseFloat(minDistC) ;
 for (var ia = 1; ia < edilayerMainLayer.features.length; ++ia) { var NumSS= parseFloat(edilayerMainLayer.features[ia].attributes[fieldDateTime]);
 if (NumSS>parseFloat(maxDistC) ) {maxDistC = parseFloat(NumSS);}
 if( NumSS<parseFloat(minDistC) ) {minDistC = parseFloat(NumSS);}  }
document.getElementById("htmlTimeNum1").value=minDistC;document.getElementById("htmlTimeNum2").value=maxDistC;

return;}
else{TimeFieldowg="timestr";document.getElementById("id_timeinterNum").style.display="none";document.getElementById("id_timeinterStr").style.display="block";}
if(edilayerMainLayer.features[0].attributes[fieldDateTime].split('T')[1]){
 var a1= edilayerMainLayer.features[0].attributes[fieldDateTime].split('T')[0].split('-').join ('');
var a2= edilayerMainLayer.features[0].attributes[fieldDateTime].split('T')[1].split(':').join ('');}
else{alert("Ошибка формата даты.времени. Вы можете использовать опцию 'Изменить формат даты/времени' внизу этого окна");return;}
var b=a1+a2;
b=parseInt(b);
edilayerMainLayer.features[0].attributes["NumDateTimeAtl"]=b;
minDistC=b;var minDistC2=edilayerMainLayer.features[0].attributes[fieldDateTime];
 var maxDistC = parseInt(minDistC); var maxDistC2=edilayerMainLayer.features[0].attributes[fieldDateTime];;
 for (ia = 1; ia < edilayerMainLayer.features.length; ++ia) { var NumSS2=edilayerMainLayer.features[ia].attributes[fieldDateTime];

 var a1= edilayerMainLayer.features[ia].attributes[fieldDateTime].split('T')[0].split('-').join ('');
var a2= edilayerMainLayer.features[ia].attributes[fieldDateTime].split('T')[1].split(':').join ('');
b=a1+a2;
b=parseInt(b);
var NumSS=b
 if (NumSS>parseFloat(maxDistC) ){ maxDistC = NumSS;maxDistC2=edilayerMainLayer.features[ia].attributes[fieldDateTime];}
 if( NumSS<parseFloat(minDistC) ) {minDistC = NumSS; minDistC2=edilayerMainLayer.features[ia].attributes[fieldDateTime];}
 }
var minDate=minDistC2;
var minDate11=minDate.split('T')[0];
document.getElementById("htmlTimeYear1").value=minDate11.split('-')[0];
document.getElementById("htmlTimeMonth1").value=minDate11.split('-')[1];
document.getElementById("htmlTimeDay1").value=minDate11.split('-')[2];
var minDate12=minDate.split('T')[1];
document.getElementById("htmlTimeHour1").value=minDate12.split(':')[0];
document.getElementById("htmlTimeMin1").value=minDate12.split(':')[1];
document.getElementById("htmlTimeSec1").value=minDate12.split(':')[2];
var maxDate=maxDistC2;
var maxDate11=maxDate.split('T')[0];
document.getElementById("htmlTimeYear2").value=maxDate11.split('-')[0];
document.getElementById("htmlTimeMonth2").value=maxDate11.split('-')[1];
document.getElementById("htmlTimeDay2").value=maxDate11.split('-')[2];
var maxDate12=maxDate.split('T')[1];
document.getElementById("htmlTimeHour2").value=maxDate12.split(':')[0];
document.getElementById("htmlTimeMin2").value=maxDate12.split(':')[1];
document.getElementById("htmlTimeSec2").value=maxDate12.split(':')[2];
edilayerMainLayer.features.sort(function(a, b) {
 return (a.attributes["NumDateTimeAtl"] - b.attributes["NumDateTimeAtl"]) ;});
}
function CreateDateTime2_5D()
{
if(!document.getElementById("id_newDate")&&document.getElementById("id_25dDateTime").checked==true)
{OK_OSMeditLayer();}
}
function CreateDateTimeHeat()
{
if(!document.getElementById("id_newDate")&&document.getElementById("id_heatmapDateTime").checked==true)
{HeatmapCanvas2()}
}
function TimeLine()
{
if(this.document.getElementById("editL1").value=="0")
{alert ("выберите название слоя в списке 'Редактируемый слой'");return;}
var bbox = document.getElementById("map").getBoundingClientRect();
 var body = document.body
 var docElem = document.documentElement
 var scrollTop = window.pageYOffset || docElem.scrollTop || body.scrollTop
 var scrollLeft = window.pageXOffset || docElem.scrollLeft || body.scrollLeft
 var clientTop = docElem.clientTop || body.clientTop || 0
 var clientLeft = docElem.clientLeft || body.clientLeft || 0
 var topTop = bbox.top + scrollTop - clientTop
 var leftLeft = bbox.left + scrollLeft - clientLeft
var DivEditeLeg=document.createElement("div");
DivEditeLeg.id="id_TimeLineLegMain2";
DivEditeLeg.className="id_divRoutLegMain";
DivEditeLeg.style.position="relative";

var htmlTime=" ";
htmlTime+='<div id="id_divRoutTimeLeg" style="background:#ffffff; color:#0000ff;z-index: 6000;position:absolute;left:'+Math.round(leftLeft+50)+'px;top:'+Math.round(topTop+20)+
'px;overflow:hidden; border: 1px solid black;"><img onclick="closeTimeLineWin()" src="openlayers/theme/default/img/close.gif" style="position:relative; top:10px;float:right; cursor:pointer"><a style="position:relative; top:20px"></a>'+
'<a style="font-size: 9px;"> Вы можете перемещать это окно если щёлкните по пункту меню Интерфейс/переключить режим интерфейса</a><br>'+'<a>выберите поле с датой:</a>'+
'<select onchange="onChangeTimeLine()" id="TimeLayerField" title="Дата должна быть в формате: гггг-мм-ддTчч:мм:сс. Например: 2007-06-20T12:30:00, где (T) буква латинского алфавита">'+
 '<option selected value="0" >.</option>'+
 '</select><br>'+'<div id="id_timeinterNum" style="display:none">'+
'<a>Введите интервал дат:</a><br>'+
'от:<input type="text" size="6" id="htmlTimeNum1" value=""/>'+
'интервал:<input type="text" size="6" id="htmlTimeInterN" value="0.5"/> '+
'до<input type="text" size="6" id="htmlTimeNum2" value=""/></div>'+
 '<div id="id_timeinterStr" style="display:block">'+
'<a>Введите интервал дат:</a><br>'+
'<input type="text" size="6" id="htmlTimeYear1" value=""/>год1 '+
'<input type="text" size="6" id="htmlTimeMonth1" value=""/>месяц1 '+
'<input type="text" size="6" id="htmlTimeDay1" value=""/>день1<br>'+
'<input type="text" size="6" id="htmlTimeHour1" value=""/>час1'+
'<input type="text" size="6" id="htmlTimeMin1" value=""/>минута1'+
'<input type="text" size="6" id="htmlTimeSec1" value=""/>секунда1<br>'+
'<input type="text" size="6" id="htmlTimeYear2" value=""/>год2 '+
'<input type="text" size="6" id="htmlTimeMonth2" value=""/>месяц2 '+
'<input type="text" size="6" id="htmlTimeDay2" value=""/>день2<br>'+
'<input type="text" size="6" id="htmlTimeHour2" value=""/>час2'+
'<input type="text" size="6" id="htmlTimeMin2" value=""/>минута2'+
'<input type="text" size="6" id="htmlTimeSec2" value=""/>секунда2<br>'+
'</div>'+
'<select id="TimeInterField">'+
 '<option selected value="0" >.</option>'+
'<option selected value="1" >секунда</option>'+
'<option selected value="2" >минута</option>'+
'<option selected value="3" >час</option>'+
'<option selected value="4" >день</option>'+
'<option selected value="5" >месяц</option>'+
'<option selected value="6" >год</option>'+
 '</select>интервал '+'<input type="text" size="8" id="id_milisecAtl" value="1000"/>задержка в миллисекундах (ms) '+'<br>'+
'<button type=button title="Play" id="id_OK_PlayTimeLine" onclick=OK_PlayTimeLine()>Play</button>'+
'<button type=button title="Pause" onclick=OK_PauseTimeLine()>Pause</button>'+
'<button type=button title="Stop" onclick=OK_StopTimeLine()>Stop</button><div id="div_id_TimeTec"></div><br>'+
//'<p> <button type=button onclick=OK_TimeLine()>OK</button></p>'+
'<input type="checkbox" id="id_MoveTimeWmap" title="" value="checkbox"/><a style="font-size: 11px;">перемещать экстент карты за объектами. размер экстента в градусах</a><input type="text" style="font-size: 11px;" title="размер квадрата экстента в градусах" size="2" id="id_MoveTimeWmap_val" value="20"/><br>'+
'<input type="checkbox" id="id_convertRotDateTime" title="" value="checkbox"/>вращать <input type="checkbox" id="id_heatmapDateTime" onclick=CreateDateTimeHeat() title="create heatmap" value="checkbox"/>тепловая карта<input type="checkbox" id="id_25dDateTime" onclick=CreateDateTime2_5D() title="создать 2.5D (почти как 3D) элементы на основе точек и полигонов вашего слоя" value="checkbox"/>2_5D<br>'+
'<input type="checkbox" id="id_previousDateTime" title="" value="checkbox"/>оставлять предыдущее<br>'+
'<input type="checkbox" id="id_convertDateTime" onchange=setDivTimeLine() title="Используйте эту опцию если  поле(аттрибут) с датой/временем в Слое не имеет  правильный формат  (гггг-мм-ддTчч:мм:сс), а имеет вид например: (гггг-мм-дд) или (мм-дд) и т.п.Щёлкните для изменения формата поля(аттрибута) даты/времени для того что бы сделать корректной дату/время согласно OpenWebGIS формату:(гггг-мм-ддTчч:мм:сс). Когда вы меняете формат  поля даты/времени , в Слой добавляется новое поле(аттрибут) с именем=ИмяВашегоПоля+2. Потом Вы можете удалить это новое поле в меню Редактирование->Удалить атрибут из cлоя" value="checkbox"/>Изменить формат  даты/времени<br>'+
'<div id="id_DivconvertDatetime" style="display:none"><a title="Введите строку(если это необходимо) для того, что бы добавить слева к Вашему значению поля даты/времени ">добавить слева</a>'+
'<input type="text" size="5" id="id_TimeleftGIS" value=""/><button type=button title="Изменить формат даты/времени" onclick=ChangeDateTimeFunc()>Изменить</button>'+
'<input type="text" size="5" id="id_TimerightGIS" value="T00:00:00"/><a title="Введите строку(если это необходимо) для того, что бы добавить справа к Вашему значению поля даты/времени ">добавить справа</a><br>'+
'Если Дата в формате "месяц/день/год", например "7/20/99"<button type=button title="Изменить формат даты/времени" onclick=ChangeDateTimeFunc2()>Изменить</button></div>'+'</div>';;
DivEditeLeg.innerHTML=htmlTime;
if(!document.getElementById("id_TimeLineLegMain2"))
{body.appendChild(DivEditeLeg); }

document.getElementById("id_TimeLineLegMain2").onmousedown=function(event){drags(event)};
document.getElementById("id_TimeLineLegMain2").onmouseup=function(e){enddrag()};

for (var a in edilayerMainLayer.features[0].attributes)
{var t=document.createElement('option');
 t.value=a;
 t.text=a;
 document.getElementById("TimeLayerField").appendChild(t);}
}
function setDivTimeLine()
{
if(document.getElementById("id_convertDateTime").checked==true){document.getElementById("id_DivconvertDatetime").style.display="block";}
else{document.getElementById("id_DivconvertDatetime").style.display="none";}
}
function ChangeDateTimeFunc()
{
for(var i=0;i<edilayerMainLayer.features.length;i++)
{edilayerMainLayer.features[i].attributes[document.getElementById("TimeLayerField").value+'2']=document.getElementById("id_TimeleftGIS").value+edilayerMainLayer.features[i].attributes[document.getElementById("TimeLayerField").value]+document.getElementById("id_TimerightGIS").value;}
var t=document.createElement('option');
t.value=document.getElementById("TimeLayerField").value+'2';
 t.text=document.getElementById("TimeLayerField").value+'2';
t.defaultSelected = true
 document.getElementById("TimeLayerField").appendChild(t);
onChangeTimeLine()
alert("поле Дата/время конвертировано в "+document.getElementById("TimeLayerField").value+" поле");
}
function ChangeDateTimeFunc2()
{
for(var i=0;i<edilayerMainLayer.features.length;i++)
{
var d= new Date()
d.setTime(Date.parse(edilayerMainLayer.features[i].attributes[document.getElementById("TimeLayerField").value]));
var Y=d.getFullYear();
var M=d.getMonth()+1;
if(parseInt(M)<10){M='0'+M;}
var D=d.getDate();
if(parseInt(D)<10){D='0'+D;}
var H=d.getHours();
if(parseInt(H)<10){H='0'+H;}
var MM=d.getMinutes();
if(parseInt(MM)<10){MM='0'+MM;}
var S=d.getSeconds();
if(parseInt(S)<10){S='0'+S;}
var neD=Y+'-'+M+'-'+D+'T'+H+':'+MM+':'+S;
edilayerMainLayer.features[i].attributes[document.getElementById("TimeLayerField").value+'2']=neD;
}

var t=document.createElement('option');
t.value=document.getElementById("TimeLayerField").value+'2';
 t.text=document.getElementById("TimeLayerField").value+'2';
t.defaultSelected = true
 document.getElementById("TimeLayerField").appendChild(t);
onChangeTimeLine();
alert("поле Дата/время конвертировано в "+document.getElementById("TimeLayerField").value+" поле");
}
function OK_StopTimeLine()
{clearInterval(intervaTime); if(stoprotateWebGisRul.length>0){var reload=2;reloadEdiLaPlayRotate(reload);for(var ty=0;ty<stoprotateWebGisRul.length;ty++){clearInterval(stoprotateWebGisRul[ty]);}} var objstyle=edilayerMainLayer.styleMap.styles.default.rules[0].symbolizer;
new_style_layer= new OpenLayers.Style(objstyle);
 var selStyle = new OpenLayers.Style({
 pointRadius: 5, fillColor: "#ffaa00", strokeColor: "#00DDFF",
 strokeWidth:2,fillOpacity:1,trokeOpacity:1
 }); 
startTimefromPause=false;
if(document.getElementById("div_id_TimeTec")){document.getElementById("div_id_TimeTec").innerHTML='';}
if(filterStartG==1)
{filterStartG=0;for(var ghi=0;ghi<edilayerMainLayer.styleMap.styles.default.rules.length;ghi++)
{edilayerMainLayer.styleMap.styles.default.rules[ghi].filter=filterStartGArr[ghi];}
}
else{
edilayerMainLayer.styleMap=new OpenLayers.StyleMap({'default':new_style_layer,'select': selStyle,'rules': []});}
edilayerMainLayer.redraw();filterStartGArr=[]}
function OK_PauseTimeLine()
{
clearInterval(intervaTime);

if(stoprotateWebGisRul.length>0){for(var ty=0;ty<stoprotateWebGisRul.length;ty++){clearInterval(stoprotateWebGisRul[ty]);}}
startTimefromPause=true;edilayerMainLayer.redraw();
}
function reloadEdiLaPlayRotate(reload)
{var reload1=reload;
var jsonstring='';
var format = new OpenLayers.Format.GeoJSON({ 'internalProjection': new OpenLayers.Projection("EPSG:900913"),
'externalProjection': new OpenLayers.Projection("EPSG:900913")});
if(edilayerMainLayer.features)
 {
if(edilayerMainLayer.protocol&&edilayerMainLayer.protocol.featureType){jsonstring ='';}
if(!edilayerMainLayer.protocol||!edilayerMainLayer.protocol.featureType){jsonstring = format.write(edilayerMainLayer.features);}
}
var rules='';
for(var k=0;k<edilayerMainLayer.styleMap.styles.default.rules.length;k++)
{rules+=" count="+edilayerMainLayer.styleMap.styles.default.rules.length+" endCon "+" filt_"+k+" "+JSON.stringify(edilayerMainLayer.styleMap.styles.default.rules[k].filter,function(key, value) { 
 if (typeof key !== 'function'&& key !=='__proto__') {return value;}} ) 
rules+=" sym_"+k+" "+JSON.stringify(edilayerMainLayer.styleMap.styles.default.rules[k].symbolizer)+" Esym_"+k+" "
}
var ObjProtocol='';
if(edilayerMainLayer.protocol)
{
ObjProtocol={ "url": edilayerMainLayer.protocol.url,"featurePrefix":edilayerMainLayer.protocol.featurePrefix,
"geometryName":edilayerMainLayer.protocol.geometryName,"featureNS":edilayerMainLayer.protocol.featureNS,"featureType":edilayerMainLayer.protocol.featureType}
}
var proj=edilayerMainLayer.projection.projCode;
rtt=edilayerMainLayer.strategies;
var strag=0;
strag=0;
if(edilayerMainLayer.strategies){
for(var n=0;n<edilayerMainLayer.strategies.length;n++)
{
strag++;;
}}
var EditTextLegendWebGis=''
if(typeof edilayerMainLayer.EditTextLegendWebGis!=="undefined")
{EditTextLegendWebGis=edilayerMainLayer.EditTextLegendWebGis;}
var centrMapLon=map.getCenter().lon;
var centrMapLat=map.getCenter().lat;
var MapProj=map.baseLayer.projection.projCode;
var DataProjectWebGis1='';
DataProjectWebGis1=" LayerWMSWFS "+" StartlayerWebgisName "+edilayerMainLayer.name+" EndlayerWebgisName "+" visL "+edilayerMainLayer.visibility+" visLE "+jsonstring+" SstyleDef "+JSON.stringify(edilayerMainLayer.styleMap.styles.default.defaultStyle)+
" rulWeb "+rules+
" SstyleSel "+JSON.stringify(edilayerMainLayer.styleMap.styles.select.defaultStyle)+" Endstyle "+" Startprotocol "+JSON.stringify(ObjProtocol)+" Endprotocol "+" projW "+proj+" Eproj "+" strag "+strag+" Estrag "+" editLeg "+
EditTextLegendWebGis+" EeditLeg ";
rtt=DataProjectWebGis1;

var LisLayer=DataProjectWebGis1.split(" LayerWMSWFS ");
for(var i=1;i<LisLayer.length;i++)
 {
if(LisLayer[i].split(" StartlayerWebgisName ")[1]){
var newSaved_layer = new OpenLayers.Layer.Vector(LisLayer[i].split(" StartlayerWebgisName ")[1].split(" EndlayerWebgisName ")[0],{renderers:["Canvas", "SVG", "VML"]});
var format2 = new OpenLayers.Format.GeoJSON({ 
 'internalProjection': new OpenLayers.Projection("EPSG:900913"),
'externalProjection': new OpenLayers.Projection("EPSG:900913")
});
var strFeature=LisLayer[i].split(" visLE ")[1].split(" SstyleDef ")[0];
if(strFeature!=='')
{features=format2.read(strFeature);}
else
{features=[];}
var ObjProtocol;
var strObjProtocol=null;
ObjProtocol=JSON.parse(LisLayer[i].split(" Startprotocol ")[1].split(" Endprotocol ")[0]);
if(ObjProtocol.featureType)
{newSaved_layer.protocol=new OpenLayers.Protocol.WFS(OpenLayers.Util.applyDefaults({featureType:ObjProtocol.featureType}, ObjProtocol));strObjProtocol=new OpenLayers.Protocol.WFS(OpenLayers.Util.applyDefaults({featureType:ObjProtocol.featureType}, ObjProtocol));}
newSaved_layer.projection=new OpenLayers.Projection(LisLayer[i].split(" projW ")[1].split(" Eproj ")[0]);
var StrStrat=null;
if(LisLayer[i].split(" strag ")[1].split(" Estrag ")[0]==1)
{newSaved_layer.strategies=[saveStrategy];StrStrat=[saveStrategy];}
if(LisLayer[i].split(" strag ")[1].split("Estrag ")[0]==2)
{newSaved_layer.strategies=[new OpenLayers.Strategy.Fixed(),saveStrategy];StrStrat=[saveStrategy,new OpenLayers.Strategy.Fixed()];}
var bool='';
if(LisLayer[i].split(" visL ")[1].split(" visLE ")[0]=="true")
{bool=true;}else{bool=false;}
newSaved_layer.setVisibility(bool);
newSaved_layer.styleMap.styles.default.defaultStyle=JSON.parse(LisLayer[i].split(" SstyleDef ")[1].split(" rulWeb ")[0]);
newSaved_layer.styleMap.styles.select.defaultStyle=JSON.parse(LisLayer[i].split(" SstyleSel ")[1].split(" Endstyle ")[0]);
rtt=newSaved_layer.styleMap.styles.default;
var renderevar=["SVG","Canvas","VML"];
if(reload1==1){renderevar=["SVG","Canvas","VML"];}
if(reload1==2){renderevar=["Canvas","SVG","VML"];}
newSaved_layer= new OpenLayers.Layer.Vector(LisLayer[i].split(" StartlayerWebgisName ")[1].split(" EndlayerWebgisName ")[0], {
strategies:StrStrat,
 visibility: bool,styleMap: new OpenLayers.StyleMap({'default':newSaved_layer.styleMap.styles.default.defaultStyle,'select':newSaved_layer.styleMap.styles.select.defaultStyle}),
projection : new OpenLayers.Projection(LisLayer[i].split(" projW ")[1].split(" Eproj ")[0]),
 isBaseLayer: false, renderers:renderevar,
 protocol: strObjProtocol
 });
newSaved_layer.addFeatures(features);
if(LisLayer[i].split(" rulWeb ")[1].split(" count=")[1])
{
var CountRules=LisLayer[i].split(" rulWeb ")[1].split(" count=")[1].split(" endCon ");
CountRules=parseInt(CountRules);
var rulesEl= new Array();
for (var h=0;h<CountRules;h++)
{
var obj=JSON.parse(LisLayer[i].split(" filt_"+h+" ")[1].split(" sym_"+h+" ")[0])
if(obj)
{
if(obj.type==".."){obj.type=OpenLayers.Filter.Comparison.BETWEEN;}
if(obj.type=="=="){obj.type=OpenLayers.Filter.Comparison.EQUAL_TO;} }
var obj2=JSON.parse(LisLayer[i].split(" sym_"+h+" ")[1].split(" Esym_"+h+" ")[0])
rulesEl[h]=new OpenLayers.Rule( {title: "< 15.182 grad",filter:new OpenLayers.Filter.Comparison(obj),symbolizer: obj2 });
newSaved_layer.styleMap.styles.default.addRules([rulesEl[h]]);
}
 }//end if(LisLayer[i].split(" rulWeb ")[1].split(" count=")[1])
var EditTextLegendWebGis=LisLayer[i].split(" editLeg ")[1].split(" EeditLeg ")[0];
if(EditTextLegendWebGis!=='')
{newSaved_layer["EditTextLegendWebGis"]=EditTextLegendWebGis;}
map.removeLayer(edilayerMainLayer);
map.addLayer(newSaved_layer);
SeteditlayerMain(newSaved_layer.name);
if(newSaved_layer.visibility==true){newSaved_layer.redraw();}
}

}
}
function OK_PlayTimeLine()
{if(typeof intervaTime!=='undefined'){clearInterval(intervaTime);}
if (document.getElementById("id_convertRotDateTime").checked==true)
{var reload=1;reloadEdiLaPlayRotate(reload);}
if (document.getElementById("id_convertRotDateTime").checked==true){stoprotateWebGisRul=[];
if(edilayerMainLayer.styleMap.styles.default.rules.length>0)
{
var minDist;
var maxDist;
var tt=edilayerMainLayer.styleMap.styles.default.rules[0].filter.property
var DistArr=[];
 for (var i=0; i <edilayerMainLayer.features.length; i++)
{ for (var a in edilayerMainLayer.features[i].attributes)
{if(a==tt&&edilayerMainLayer.features[i].attributes[a]!='') {  DistArr.push(parseFloat(edilayerMainLayer.features[i].attributes[a]));} }
} minDist = parseFloat(DistArr[0]);maxDist = parseFloat(minDist) ;
           for (i = 1; i <  DistArr.length; ++i) {
           if (DistArr[i] > parseFloat(maxDist) ) maxDist =  parseFloat(DistArr[i]);
           if( DistArr[i] < parseFloat(minDist) ) minDist  = parseFloat(DistArr[i]); }
}
for (var f=0;f<edilayerMainLayer.styleMap.styles.default.rules.length;f++)
{

var x=(edilayerMainLayer.styleMap.styles.default.rules[f].filter.upperBoundary*100)/maxDist;
var speedX=Math.abs(105-x); 

edilayerMainLayer.styleMap.styles.default.rules[f].symbolizer.rotation=0;
(function(e,tu){
v=setInterval(
function(){edilayerMainLayer.styleMap.styles.default.rules[e].symbolizer.rotation=edilayerMainLayer.styleMap.styles.default.rules[e].symbolizer.rotation+1;edilayerMainLayer.redraw(); 
if(edilayerMainLayer.styleMap.styles.default.rules[e].symbolizer.rotation==360)
{edilayerMainLayer.styleMap.styles.default.rules[e].symbolizer.rotation=0};
},tu);})(f,speedX)

stoprotateWebGisRul.push(v);
}
}

var zaderMiliSecAtl=document.getElementById("id_milisecAtl").value;
var format = new OpenLayers.Format.CQL();
var TYear1=document.getElementById("htmlTimeYear1").value;
var TMonth1=document.getElementById("htmlTimeMonth1").value;
var TDay1=document.getElementById("htmlTimeDay1").value;
var THour1=document.getElementById("htmlTimeHour1").value;
var TMin1=document.getElementById("htmlTimeMin1").value;
var TSec1=document.getElementById("htmlTimeSec1").value;
var TYear2=document.getElementById("htmlTimeYear2").value;
var TMonth2=document.getElementById("htmlTimeMonth2").value;
var TDay2=document.getElementById("htmlTimeDay2").value;
var THour2=document.getElementById("htmlTimeHour2").value;
var TMin2=document.getElementById("htmlTimeMin2").value;
var TSec2=document.getElementById("htmlTimeSec2").value;
var DateV2=TYear2+'-'+TMonth2+'-'+TDay2+'T'+THour2+':'+TMin2+':'+TSec2+'.'+'000Z';
var DateV1= TYear1+'-'+TMonth1+'-'+TDay1+'T'+THour1+':'+TMin1+':'+TSec1+'.'+'000Z';
var fieldDateTime=document.getElementById("TimeLayerField").value;
var month1=parseInt(TMonth1)-parseInt(1); if(month1==parseInt(-1)){month1=0;}
var month2=parseInt(TMonth2)-parseInt(1); if(month2==parseInt(-1)){month2=0;}
var startDate=new Date(TYear1,month1,TDay1,THour1,TMin1,TSec1);
if(TimeFieldowg=="number"){startDate=parseFloat(document.getElementById("htmlTimeNum1").value);}
if(startTimefromPause==true&&document.getElementById("id_newDate"))
{startDate=new Date(document.getElementById("id_newDate").innerHTML);if(TimeFieldowg=="number"){startDate=parseFloat(document.getElementById("id_newDate").innerHTML)}}
var endDate=new Date(TYear2,month2,TDay2,THour2,TMin2,TSec2);
var NumF=0;var newDate=startDate;
var newDateStart=startDate;
var timeInterval=document.getElementById("TimeInterField").value;if(TimeFieldowg=="number"){timeInterval=parseFloat(document.getElementById("htmlTimeInterN").value);}
if(startTimefromPause==false){var filterDef0 = JSON.stringify(edilayerMainLayer.styleMap.styles.default.defaultStyle,function(key, value) { 
 if (typeof key !== 'function'&& key !=='__proto__') {return value;}});
var filterDef = JSON.parse(filterDef0);}
else{var filterDef=edilayerMainLayer.styleMap.styles.default.rules[0].symbolizer;}
intervaTime=setInterval( function(){if(TimeFieldowg!=="number"){
monthNN=startDate.getMonth()+1;if(monthNN<10){monthNN='0'+monthNN;}
dayNN=startDate.getDate(); if(dayNN<10){dayNN='0'+dayNN;}
hoursNN=startDate.getHours();if(hoursNN<10){hoursNN='0'+hoursNN;}
minNN=startDate.getMinutes();if(minNN<10){minNN='0'+minNN;}
secNN=startDate.getSeconds();if(secNN<10){secNN='0'+secNN;}
var Datert1=startDate.getFullYear()+"-"+monthNN+'-'+dayNN+'T'+hoursNN+':'+minNN+':'+secNN;}
if(TimeFieldowg=="number"){Datert1=startDate};
var startDate1=startDate;

var strD='от: '+'<a id=id_startDate>'+startDate1+'</a><br>';
if(TimeFieldowg!=="number"){
if(document.getElementById("TimeInterField"))
{
if(document.getElementById("TimeInterField").value==1)
{newDate= new Date(newDate.valueOf()+1000);} 
if(document.getElementById("TimeInterField").value==2)
{newDate= new Date(newDate.valueOf()+60*1000);} 
if(document.getElementById("TimeInterField").value==3)
{newDate= new Date(newDate.valueOf()+60*60*1000);} 
if(document.getElementById("TimeInterField").value==4)
{newDate= new Date(newDate.valueOf()+24*60*60*1000);} 
if(document.getElementById("TimeInterField").value==5)
{var MonOfYear = newDate.getMonth();
newDate.setMonth(MonOfYear +1);}
if(document.getElementById("TimeInterField").value==6)
{var YearY= newDate.getFullYear();
newDate.setYear(YearY +1);}
 }//end if(document.getElementById("TimeInterField")
else
{
if(timeInterval==1)
{newDate= new Date(newDate.valueOf()+1000);} 
if(timeInterval==2)
{newDate= new Date(newDate.valueOf()+60*1000);} 
if(timeInterval==3)
{newDate= new Date(newDate.valueOf()+60*60*1000);} 
if(timeInterval==4)
{newDate= new Date(newDate.valueOf()+24*60*60*1000);} 
if(timeInterval==5)
{var MonOfYear = newDate.getMonth();
newDate.setMonth(MonOfYear +1);}
if(timeInterval==6)
{var YearY= newDate.getFullYear();
newDate.setYear(YearY +1);}
 } }else{newDate=startDate+parseFloat(document.getElementById("htmlTimeInterN").value);}
strD+='до: '+'<a id=id_newDate>'+newDate+'</a>';
if(document.getElementById("div_id_TimeTec")){document.getElementById("div_id_TimeTec").innerHTML=strD;}
popup_htmlTime=document.getElementById("id_TimeLineLegMain2");
if(popup_htmlTime){}
if(TimeFieldowg!=="number"){
monthNN=newDate.getMonth()+1;if(monthNN<10){monthNN='0'+monthNN;}
dayNN=newDate.getDate(); if(dayNN<10){dayNN='0'+dayNN;}
newDate.getFullYear(); 
hoursNN=newDate.getHours();if(hoursNN<10){hoursNN='0'+hoursNN;}
minNN=newDate.getMinutes();if(minNN<10){minNN='0'+minNN;}
secNN=newDate.getSeconds();if(secNN<10){secNN='0'+secNN;}
var Datert2=newDate.getFullYear()+"-"+monthNN+'-'+dayNN+'T'+hoursNN+':'+minNN+':'+secNN;}
if(TimeFieldowg=="number"){Datert1=startDate;Datert2=newDate;}
if(document.getElementById("id_previousDateTime").checked==true){Datert1=DateV1;}
var timeInterval2;
if(TimeFieldowg!=="number"){if(document.getElementById("TimeInterField")){timeInterval2=document.getElementById("TimeInterField").value}else{timeInterval2=timeInterval;}}
else{timeInterval2=parseFloat(document.getElementById("htmlTimeInterN").value)}
if(timeInterval2==0)
{var rule2 = new OpenLayers.Rule({
 name: "date",
 filter: new OpenLayers.Filter.Logical({
 type: OpenLayers.Filter.Logical.OR,
 filters: [
 new OpenLayers.Filter.Comparison({
 type: OpenLayers.Filter.Comparison.EQUAL_TO,
 property:fieldDateTime,
 value:edilayerMainLayer.features[NumF].attributes[fieldDateTime],
 })
 ]
 }) ,symbolizer: { } 
 });
rule2.symbolizer=filterDef;
}

else
{if(TimeFieldowg!=="number"){
var rule2 = new OpenLayers.Rule({
 name: "date",
 filter: new OpenLayers.Filter.Logical({
 type: OpenLayers.Filter.Logical.AND,
 filters: [
 new OpenLayers.Filter.Comparison({
 type: OpenLayers.Filter.Comparison.GREATER_THAN_OR_EQUAL_TO,
 property:fieldDateTime,
 value:Datert1,
 }),
 new OpenLayers.Filter.Comparison({
 type: OpenLayers.Filter.Comparison.LESS_THAN,
 property:fieldDateTime,
 value:Datert2,
 })
 ]
 }) ,symbolizer: {

 } 
 });}
 else
 {if(Datert2<Datert1)
 {
 var rule2 = new OpenLayers.Rule({
 name: "date", filter: new OpenLayers.Filter.Logical({
 type: OpenLayers.Filter.Logical.AND, filters: [
 new OpenLayers.Filter.Comparison({ type: OpenLayers.Filter.Comparison.GREATER_THAN,
 property:fieldDateTime, value:Datert2, }),
 new OpenLayers.Filter.Comparison({ type: OpenLayers.Filter.Comparison.LESS_THAN_OR_EQUAL_TO,
 property:fieldDateTime, value:Datert1, }) ] }) ,symbolizer: { }  });
  }
  if(Datert2>Datert1)
 {
 var rule2 = new OpenLayers.Rule({
 name: "date", filter: new OpenLayers.Filter.Logical({
 type: OpenLayers.Filter.Logical.AND, filters: [
 new OpenLayers.Filter.Comparison({ type: OpenLayers.Filter.Comparison.GREATER_THAN_OR_EQUAL_TO,
 property:fieldDateTime, value:Datert1, }),
 new OpenLayers.Filter.Comparison({ type: OpenLayers.Filter.Comparison.LESS_THAN,
 property:fieldDateTime, value:Datert2, }) ] }) ,symbolizer: { }  });
  }
  
 
 
 } 
rule2.symbolizer=filterDef;
}
if(edilayerMainLayer.styleMap.styles.default.rules[0]&&edilayerMainLayer.styleMap.styles.default.rules[0].filter.property)
{filterStartG=1;filterStartGArr=[];}
if(filterStartG==1)
{var arF=filterStartGArr;
if(arF&&arF.length==0)
{for(var ghi=0;ghi<edilayerMainLayer.styleMap.styles.default.rules.length;ghi++)
{var parserF = new OpenLayers.Format.Filter();
var filter1 = parserF.write(edilayerMainLayer.styleMap.styles.default.rules[ghi].filter);
var filter1 = parserF.read(filter1);
arF.push(filter1)}}

for(var f=0;f<arF.length;f++)
{var parserF = new OpenLayers.Format.Filter();
var filter1 = parserF.write(rule2.filter);
var filterRul2 = parserF.read(filter1);
edilayerMainLayer.styleMap.styles.default.rules[f].filter=filterRul2;
edilayerMainLayer.styleMap.styles.default.rules[f].filter.filters.push(arF[f]);




}

}
if(filterStartG==1){}
else{edilayerMainLayer.styleMap.styles.default=new OpenLayers.Style(null, {rules: [rule2]});}
edilayerMainLayer.redraw();
if(document.getElementById("id_25dDateTime")){if(document.getElementById("id_25dDateTime").checked==true&&document.getElementById("id_25dDateTime").layer25D)
{
for(var laheat=0;laheat<map.layers.length;laheat++)
{if(map.layers[laheat].name==document.getElementById("id_25dDateTime").layer25D&&map.layers[laheat].customJson){var new_layer_Heat=map.layers[laheat];
var jsonnew25dfeat=new_layer_Heat.customJson;
var format = new OpenLayers.Format.GeoJSON({ 'internalProjection': new OpenLayers.Projection("EPSG:4326"),'externalProjection': new OpenLayers.Projection("EPSG:900913")});
jsonnew25dfeat = format.read(jsonnew25dfeat);
}}
var l25datr="height";if(jsonnew25dfeat[0].attributes[fieldDateTime]){l25datr=fieldDateTime;}
var arrFor25dmap=[];
if(rule2.filter.filters.length==1)
{for(var heat=0;heat<edilayerMainLayer.features.length;heat++)
{if(jsonnew25dfeat[heat].attributes[l25datr]==edilayerMainLayer.features[NumF].attributes[fieldDateTime])
{arrFor25dmap.push(jsonnew25dfeat[heat])} }
}
if(rule2.filter.filters.length==2)
{for(var heat=0;heat<edilayerMainLayer.features.length;heat++)
{if(TimeFieldowg!=="number"){if(jsonnew25dfeat[heat].attributes[l25datr]>=Datert1&&jsonnew25dfeat[heat].attributes[l25datr]<Datert2)
{arrFor25dmap.push(jsonnew25dfeat[heat])} }else
{if(Datert2>Datert1)
{if(jsonnew25dfeat[heat].attributes[l25datr]>=Datert1&&jsonnew25dfeat[heat].attributes[l25datr]<Datert2)
{arrFor25dmap.push(jsonnew25dfeat[heat])}
} 
if(Datert2<Datert1)
{if(jsonnew25dfeat[heat].attributes[l25datr]>Datert2&&jsonnew25dfeat[heat].attributes[l25datr]<=Datert1)
{arrFor25dmap.push(jsonnew25dfeat[heat])}
} 
 } }
}
var jsonstringH = format.write(arrFor25dmap);
OK_OSMExtrudeLayerTimeLine(new_layer_Heat,jsonstringH);
}}
if(document.getElementById("id_heatmapDateTime")){if(document.getElementById("id_heatmapDateTime").checked==true&&document.getElementById("id_heatmapDateTime").heatmaplayer)
{var arrForHeatmap=[];var new_layer_Heat=0;
var format = new OpenLayers.Format.GeoJSON({ 'internalProjection': new OpenLayers.Projection("EPSG:900913"),
'externalProjection': new OpenLayers.Projection("EPSG:900913")});
if(rule2.filter.filters.length==1)
{for(var heat=0;heat<edilayerMainLayer.features.length;heat++)
{if(edilayerMainLayer.features[heat].attributes[fieldDateTime]==edilayerMainLayer.features[NumF].attributes[fieldDateTime])
{arrForHeatmap.push(edilayerMainLayer.features[heat])} }
}
if(rule2.filter.filters.length==2)
{for(var heat=0;heat<edilayerMainLayer.features.length;heat++)
{if(TimeFieldowg!=="number"){if(edilayerMainLayer.features[heat].attributes[fieldDateTime]>=Datert1&&edilayerMainLayer.features[heat].attributes[fieldDateTime]<Datert2)
{arrForHeatmap.push(edilayerMainLayer.features[heat])} }else
{if(Datert2>Datert1)
{if(edilayerMainLayer.features[heat].attributes[fieldDateTime]>=Datert1&&edilayerMainLayer.features[heat].attributes[fieldDateTime]<Datert2)
{arrForHeatmap.push(edilayerMainLayer.features[heat])}
} 
if(Datert2<Datert1)
{if(edilayerMainLayer.features[heat].attributes[fieldDateTime]>Datert2&&edilayerMainLayer.features[heat].attributes[fieldDateTime]<=Datert1)
{arrForHeatmap.push(edilayerMainLayer.features[heat])}
} 
 } }
}
var jsonstringH = format.write(arrForHeatmap);
for(var laheat=0;laheat<map.layers.length;laheat++)
{if(map.layers[laheat].name==document.getElementById("id_heatmapDateTime").heatmaplayer){new_layer_Heat=map.layers[laheat]}}
new_layer_Heat.featuresH=JSON.parse(jsonstringH).features;
HeatmapCanvas(new_layer_Heat)
}}


if(document.getElementById("TimeInterField")){timeInterval2=document.getElementById("TimeInterField").value}else{timeInterval2=timeInterval;}
if(timeInterval2==0)
{NumF=NumF+1; if(NumF==edilayerMainLayer.features.length-1){NumF=0}}
else
{if(TimeFieldowg=="number"){newDate=startDate+parseFloat(document.getElementById("htmlTimeInterN").value);startDate=newDate;
if(parseFloat(document.getElementById("htmlTimeInterN").value)>0){if(newDate>=parseFloat(document.getElementById("htmlTimeNum2").value)){startDate=parseFloat(document.getElementById("htmlTimeNum1").value)}}
if(parseFloat(document.getElementById("htmlTimeInterN").value)<0){if(newDate<=parseFloat(document.getElementById("htmlTimeNum2").value)){startDate=parseFloat(document.getElementById("htmlTimeNum1").value)}}
}else{
var a1= DateV2.split('T')[0].split('-').join ('');
var a2= DateV2.split('T')[1].split(':').join ('');
var b1=a1+a2;
b1=parseInt(b1);
var a1= Datert2.split('T')[0].split('-').join ('');
var a2= Datert2.split('T')[1].split(':').join ('');
var b2=a1+a2;
b2=parseInt(b2);
if(b2>=b1){startDate=new Date(TYear1,month1,TDay1,THour1,TMin1,TSec1);newDate=startDate}
startDate=newDate;}} 
if (document.getElementById("id_MoveTimeWmap").checked==true)
{
var valg=parseFloat(document.getElementById("id_MoveTimeWmap_val").value)
var featArrMove=[];
for(var th=0;th<edilayerMainLayer.features.length;th++)
{if(edilayerMainLayer.features[th].attributes[document.getElementById("TimeLayerField").value]>=edilayerMainLayer.styleMap.styles.default.rules[0].filter.filters[0].value&&edilayerMainLayer.features[th].attributes[document.getElementById("TimeLayerField").value]<edilayerMainLayer.styleMap.styles.default.rules[0].filter.filters[1].value)
{featArrMove.push(edilayerMainLayer.features[th]);}
 }
 if(featArrMove[0]){
var minDistC = parseFloat(featArrMove[0].geometry.bounds.left);
 var maxDistC = parseFloat(minDistC) ;
 for (var ia = 1; ia < featArrMove.length; ++ia) { var NumSS=featArrMove[ia].geometry.bounds.left;
 if (NumSS>parseFloat(maxDistC) ) {maxDistC = parseFloat(NumSS);}
 if( NumSS<parseFloat(minDistC) ) {minDistC = parseFloat(NumSS);}
 }
var left=minDistC;
var minDistC = parseFloat(featArrMove[0].geometry.bounds.right);
 var maxDistC = parseFloat(minDistC) ;
 for (var ia = 1; ia < featArrMove.length; ++ia) { var NumSS=featArrMove[ia].geometry.bounds.right;
 if (NumSS>parseFloat(maxDistC) ) {maxDistC = parseFloat(NumSS);}
 if( NumSS<parseFloat(minDistC) ) {minDistC = parseFloat(NumSS);}
 }
var right=maxDistC;
var minDistC = parseFloat(featArrMove[0].geometry.bounds.bottom);
 var maxDistC = parseFloat(minDistC) ;
 for (var ia = 1; ia < featArrMove.length; ++ia) { var NumSS=featArrMove[ia].geometry.bounds.bottom;
 if (NumSS>parseFloat(maxDistC) ) {maxDistC = parseFloat(NumSS);}
 if( NumSS<parseFloat(minDistC) ) {minDistC = parseFloat(NumSS);}
}
var bottom=minDistC;

var minDistC = parseFloat(featArrMove[0].geometry.bounds.top);
 var maxDistC = parseFloat(minDistC) ;
 for (var ia = 1; ia < featArrMove.length; ++ia) { var NumSS=featArrMove[ia].geometry.bounds.top;
 if (NumSS>parseFloat(maxDistC) ) {maxDistC = parseFloat(NumSS);}
 if( NumSS<parseFloat(minDistC) ) {minDistC = parseFloat(NumSS);}
}
var top=maxDistC;

var bounds=new OpenLayers.Bounds(left,bottom,right,top);
var bounds2=bounds.transform(map.getProjectionObject(),new OpenLayers.Projection("EPSG:4326"));
var bounds3=new OpenLayers.Bounds(bounds2.left-valg,bounds2.bottom-valg,bounds2.right+valg,bounds2.top+valg);
bounds3.transform(new OpenLayers.Projection("EPSG:4326"),map.getProjectionObject());
map.zoomToExtent(bounds3);}



}

},zaderMiliSecAtl);
}
function osrmR(encoded, precision) {
var precision=6;
precision = Math.pow(10, -precision);
var len = encoded.length, index=0, lat=0, lng = 0, array = [];
while (index < len) {
var b, shift = 0, result = 0;
do {
b = encoded.charCodeAt(index++) - 63;
result |= (b & 0x1f) << shift;
shift += 5;
} while (b >= 0x20);
var dlat = ((result & 1) ? ~(result >> 1) : (result >> 1));
lat += dlat;
shift = 0;
result = 0;
do {
b = encoded.charCodeAt(index++) - 63;
result |= (b & 0x1f) << shift;
shift += 5;
} while (b >= 0x20);
var dlng = ((result & 1) ? ~(result >> 1) : (result >> 1));
lng += dlng;
//array.push( {lat: lat * precision, lng: lng * precision} );
array.push( [lat * precision, lng * precision] );
}

return array;
}
function Routing()
{
var varUrl='http://router.project-osrm.org/viaroute?z=10&output=json&jsonp=OSRM.JSONP.callbacks.route&loc=54.728585,20.492249&loc=54.725413,20.501862&instructions=true';
if(document.getElementById("RoutId_start").value.split(';')[0]&&document.getElementById("RoutId_start").value.split(';')[1]&&document.getElementById("RoutId_end").value.split(';')[1]&&document.getElementById("RoutId_end").value.split(';')[0])
{varUrl='http://router.project-osrm.org/viaroute?z=18&output=json&jsonp=OSRM.JSONP.callbacks.route&loc='+document.getElementById("RoutId_start").value.split(';')[1]+','+document.getElementById("RoutId_start").value.split(';')[0]+'&loc='+document.getElementById("RoutId_end").value.split(';')[1]+','+document.getElementById("RoutId_end").value.split(';')[0]+'&instructions=true';
}
else
{alert('Error in coordinates'); return;}
var xmlhttpR =new XMLHttpRequest();
xmlhttpR.open('GET',varUrl, false);
xmlhttpR.onreadystatechange = function()
{if(xmlhttpR.readyState == 4&&xmlhttpR.status == 200) {
var coorP='';
coorP=JSON.parse(xmlhttpR.responseText.split('OSRM.JSONP.callbacks.route(')[1].split('})')[0]+"}");
var arP=osrmR(coorP.route_geometry, 6);
styleRout = new OpenLayers.Style({
 pointRadius: 3, fillColor: "#FF693F", strokeColor: "#00F53D",
 strokeWidth: 2,fillOpacity:1, strokeOpacity:1});
selStyleRout = new OpenLayers.Style({
 pointRadius: 3, fillColor: "#FF693F", strokeColor: "#003DF5",
 strokeWidth: 3,fillOpacity:1, strokeOpacity:1});

var newRout_layer = new OpenLayers.Layer.Vector(document.getElementById('NameRoutId_web').value,{renderers:["Canvas", "SVG", "VML"],styleMap: new OpenLayers.StyleMap({'default':styleRout,'select': selStyleRout})});

var points = new Array();

if(document.getElementById("id_RoutCheckGis").checked==false)
{

for(var i=0;i<arP.length;i++)
 {   for(var ii=0;ii<arP[i].length;ii++)
{
var new_pos2=new OpenLayers.LonLat(arP[i][1],arP[i][0]).transform(
new OpenLayers.Projection("EPSG:4326"),
map.getProjectionObject());
points.push(new OpenLayers.Geometry.Point(new_pos2.lon, new_pos2.lat))
}
for(var y=1;y<coorP.route_instructions.length;y++){
if(i!=0){
if(i==coorP.route_instructions[y][3])
{var line = new OpenLayers.Geometry.LineString(points);points=[points[points.length-1]];
var first_line= new OpenLayers.Feature.Vector(line);
for(var c=0;c<coorP.route_instructions[y-1].length;c++){
first_line.attributes[c]=coorP.route_instructions[y-1][c];}
first_line.attributes["driving_direction"]=first_line.attributes["0"];
if(first_line.attributes["driving_direction"]=='0'){first_line.attributes["driving_direction"]="Неизвестная инструкция по "+first_line.attributes["1"]}
if(first_line.attributes["driving_direction"]=='1'){first_line.attributes["driving_direction"]="Продолжайте движение по "+first_line.attributes["1"]}
if(first_line.attributes["driving_direction"]=='2'){first_line.attributes["driving_direction"]="Примите вправо на "+first_line.attributes["1"]}
if(first_line.attributes["driving_direction"]=='3'){first_line.attributes["driving_direction"]="Поверните направо на "+first_line.attributes["1"]}
if(first_line.attributes["driving_direction"]=='4'){first_line.attributes["driving_direction"]="Поверните резко направо на "+first_line.attributes["1"]}
if(first_line.attributes["driving_direction"]=='5'){first_line.attributes["driving_direction"]="U-образный разворот "+first_line.attributes["1"]}
if(first_line.attributes["driving_direction"]=='6'){first_line.attributes["driving_direction"]="Поверните резко налево на "+first_line.attributes["1"]}
if(first_line.attributes["driving_direction"]=='7'){first_line.attributes["driving_direction"]="Поверните налево на "+first_line.attributes["1"]}
if(first_line.attributes["driving_direction"]=='8'){first_line.attributes["driving_direction"]="Примите влево на "+first_line.attributes["1"]}
if(first_line.attributes["driving_direction"]=='10'){first_line.attributes["driving_direction"]="Направляйтесь на "+first_line.attributes["1"]}
if(first_line.attributes["driving_direction"]=='11-1'){first_line.attributes["driving_direction"]="На кольцевой дороге выполните 1-ый съезд на "+first_line.attributes["1"]}
if(first_line.attributes["driving_direction"]=='11-2'){first_line.attributes["driving_direction"]="На кольцевой дороге выполните 2-ой съезд на "+first_line.attributes["1"]}
if(first_line.attributes["driving_direction"]=='11-3'){first_line.attributes["driving_direction"]="На кольцевой дороге выполните 3-ий съезд на "+first_line.attributes["1"]}
if(first_line.attributes["driving_direction"]=='11-4'){first_line.attributes["driving_direction"]="На кольцевой дороге выполните 4-ый съезд на "+first_line.attributes["1"]}
if(first_line.attributes["driving_direction"]=='11-5'){first_line.attributes["driving_direction"]="На кольцевой дороге выполните 5-ый съезд на "+first_line.attributes["1"]}
if(first_line.attributes["driving_direction"]=='11-6'){first_line.attributes["driving_direction"]="На кольцевой дороге выполните 6-ой съезд на "+first_line.attributes["1"]}
if(first_line.attributes["driving_direction"]=='11-7'){first_line.attributes["driving_direction"]="На кольцевой дороге выполните 7-ой съезд на "+first_line.attributes["1"]}
if(first_line.attributes["driving_direction"]=='11-8'){first_line.attributes["driving_direction"]="На кольцевой дороге выполните 8-ой съезд на "+first_line.attributes["1"]}
if(first_line.attributes["driving_direction"]=='11-9'){first_line.attributes["driving_direction"]="На кольцевой дороге выполните 9-ый съезд на "+first_line.attributes["1"]}
if(first_line.attributes["driving_direction"]=='11-x'){first_line.attributes["driving_direction"]="На кольцевой дороге выполните съезд на "+first_line.attributes["1"]}


delete first_line.attributes["0"]
first_line.attributes["way_name"]=first_line.attributes["1"];
delete first_line.attributes["1"]
first_line.attributes["length_m"]=first_line.attributes["2"];
delete first_line.attributes["2"]
first_line.attributes["time_sec"]=first_line.attributes["4"];
delete first_line.attributes["4"];
delete first_line.attributes["3"];
delete first_line.attributes["5"];
first_line.attributes["direction"]=first_line.attributes["6"];
delete first_line.attributes["6"];
first_line.attributes["azimuth"]=first_line.attributes["7"];
delete first_line.attributes["7"];
first_line.attributes["total_dist"]=coorP.route_summary.total_distance;
first_line.attributes["total_time"]=coorP.route_summary.total_time;

first_line.attributes.source_routes='<a href="http://project-osrm.org/" target="_blank">OSRM</a>';
first_line.attributes.data_license='<a href="http://opendatacommons.org/licenses/odbl/" target="_blank">ODbL</a>';
newRout_layer.addFeatures(first_line);}}}
}

}
else
{
for(var i=0;i<arP.length;i++)
 {   for(var ii=0;ii<arP[i].length;ii++)
{
var new_pos2=new OpenLayers.LonLat(arP[i][1],arP[i][0]).transform(
new OpenLayers.Projection("EPSG:4326"),
map.getProjectionObject());
points.push(new OpenLayers.Geometry.Point(new_pos2.lon, new_pos2.lat)) 
}
}

var line = new OpenLayers.Geometry.LineString(points);
var first_line= new OpenLayers.Feature.Vector(line);
first_line.attributes=coorP.route_summary;
first_line.attributes.source_routes='<a href="http://project-osrm.org/" target="_blank">OSRM</a>';
 first_line.attributes.data_license='<a href="http://opendatacommons.org/licenses/odbl/" target="_blank">ODbL</a>';
newRout_layer.addFeatures(first_line);
}


//id_RoutCheckGis route_instructions
newRout_layer.projection=new OpenLayers.Projection("EPSG:900913");
map.addLayer(newRout_layer);
var t=document.createElement('option');
t.value=newRout_layer.name;
t.text=newRout_layer.name;
document.getElementById("editL1").appendChild(t);
var textDiv='';
if(document.getElementById("id_RoutCheckGis").checked==false)
{
textDiv+='Distance: '+parseFloat(newRout_layer.features[0].attributes["total_dist"])/1000+'km'+'<br>'+
'total time: '+(parseFloat(newRout_layer.features[0].attributes["total_time"])/60).toFixed(2)+'min<br>';
for (var u=0; u<newRout_layer.features.length;u++)
{textDiv+=newRout_layer.features[u].attributes['driving_direction']+': '+parseFloat(newRout_layer.features[u].attributes["length_m"])/1000+'km'+'<br>';}
}
else
{textDiv+='Distance: '+parseFloat(newRout_layer.features[0].attributes["total_distance"])/1000+'km'+'<br>'+
'total time: '+(parseFloat(newRout_layer.features[0].attributes["total_time"])/60).toFixed(2)+'min<br>';}

document.getElementById("instructRourwebgis").style.height="60px";
document.getElementById("instructRourwebgis").innerHTML=textDiv;



}}
alert("Эта функция работает только в онлайн веб-версии OpenWebGIS")
{return;
xmlhttpR.send(null);}

}
function OK_TimeLine()
{
var format = new OpenLayers.Format.CQL();
var TYear1=document.getElementById("htmlTimeYear1").value;
var TMonth1=document.getElementById("htmlTimeMonth1").value;
var TDay1=document.getElementById("htmlTimeDay1").value;
var THour1=document.getElementById("htmlTimeHour1").value;
var TMin1=document.getElementById("htmlTimeMin1").value;
var TSec1=document.getElementById("htmlTimeSec1").value;
var TYear2=document.getElementById("htmlTimeYear2").value;
var TMonth2=document.getElementById("htmlTimeMonth2").value;
var TDay2=document.getElementById("htmlTimeDay2").value;
var THour2=document.getElementById("htmlTimeHour2").value;
var TMin2=document.getElementById("htmlTimeMin2").value;
var TSec2=document.getElementById("htmlTimeSec2").value;
var DateV2=TYear2+'-'+TMonth2+'-'+TDay2+'T'+THour2+':'+TMin2+':'+TSec2+'.'+'000Z';
var DateV1= TYear1+'-'+TMonth1+'-'+TDay1+'T'+THour1+':'+TMin1+':'+TSec1+'.'+'000Z';
var rule2 = new OpenLayers.Rule({
 name: "date",
 filter: new OpenLayers.Filter.Logical({
 type: OpenLayers.Filter.Logical.AND,
 filters: [
 new OpenLayers.Filter.Comparison({
 type: OpenLayers.Filter.Comparison.GREATER_THAN_OR_EQUAL_TO,
 property:document.getElementById("TimeLayerField").value,
 value:DateV1,
 }),
 new OpenLayers.Filter.Comparison({
 type: OpenLayers.Filter.Comparison.LESS_THAN,
 property:document.getElementById("TimeLayerField").value,
 value:DateV2,
 })
 ]
 }) ,symbolizer: {
 pointRadius: 3,
 fillColor: "#FFFF3F",
 strokeColor: "#666666",
 strokeWidth: 1,
 fillOpacity:1,
 strokeOpacity:1
 } 
 });
edilayerMainLayer.styleMap.styles.default=new OpenLayers.Style(null, {rules: [rule2]});
edilayerMainLayer.redraw();
}
function CloseMapExport()
{
document.getElementById("id_exportMapOWG").parentNode.removeChild(document.getElementById("id_exportMapOWG"));
}
function PrintMap()
{var georef=map.calculateBounds();
georef.transform(map.getProjectionObject(),new OpenLayers.Projection("EPSG:4326"));
var R = 6372795;
var lat1=georef.bottom;var lat2=georef.top;var long1=georef.left;var long2=georef.right;
lat1 *= Math.PI / 180;lat2 *= Math.PI / 180;
long1 *= Math.PI / 180;long2 *= Math.PI / 180;
var cl1 = Math.cos(lat1);var cl2 = Math.cos(lat2);var sl1 = Math.sin(lat1);var sl2 = Math.sin(lat2);
var delta = long2 - long1;var cdelta = Math.cos(delta);var sdelta = Math.sin(delta);var y = Math.sqrt(Math.pow(cl2 * sdelta, 2) + Math.pow(cl1 * sl2 - sl1 * cl2 * cdelta, 2));
var x = sl1 * sl2 + cl1 * cl2 * cdelta;var ad = Math.atan2(y, x);
var distY = ad * R;
var lat1=georef.top;var lat2=georef.top;var long1=georef.left;var long2=georef.right;
lat1 *= Math.PI / 180;lat2 *= Math.PI / 180;long1 *= Math.PI / 180;long2 *= Math.PI / 180;
var cl1 = Math.cos(lat1);var cl2 = Math.cos(lat2);var sl1 = Math.sin(lat1);var sl2 = Math.sin(lat2);var delta = long2 - long1;var cdelta = Math.cos(delta);var sdelta = Math.sin(delta);
var y = Math.sqrt(Math.pow(cl2 * sdelta, 2) + Math.pow(cl1 * sl2 - sl1 * cl2 * cdelta, 2));var x = sl1 * sl2 + cl1 * cl2 * cdelta;var ad = Math.atan2(y, x);
var distX = ad * R;
var masY=distY/map.size.h;
var masX=distX/map.size.w;
var divMap=document.getElementById("map");
/*var myWin= open("", "displayWindow",
 "width=400,height=300,status=yes,toolbar=yes,menubar=yes,scrollbars=yes");
 myWin.document.open();
 myWin.document.write("<html><head><title>Print map");
 myWin.document.write("</title>");
 myWin.document.write("</head><body>");
myWin.document.write("<div id='printWebGis'><a>Щёлкните правой клавишей по картинке и сохраните её. Если некоторые слои не появляются на картинке, пожалуйста, подождите пока они не появятся или закройте и снова откройте окно (не обновляйте, а откройте заново)</a><div><br>");
myWin.document.write("<div id='georef'><table style='font-size:11px'><tr><td>нижняя левая долгота</td><td>"+georef.left+"</td></tr>");
myWin.document.write("<tr><td>нижняя левая широта</td><td>"+georef.bottom+"</td></tr>");
myWin.document.write("<tr><td>верхняя правая долгота</td><td>"+georef.right+"</td></tr>");
myWin.document.write("<tr><td>верхняя правая широта</td><td>"+georef.top+"</td></tr>");
myWin.document.write("<tr><td title='масштаб картинки по оси X; размер пиксела по оси X (например в 1 пикселе картинки - 20 метров)'>X метр/пиксел</td><td title='масштаб картинки по оси X; размер пиксела по оси X (например в 1 пикселе картинки - 20 метров)'>"+masX+"</td></tr>");
myWin.document.write("<tr><td title='масштаб картинки по оси Y; размер пиксела по оси Y (например в 1 пикселе картинки - 20 метров)'>Y метр/пиксел</td><td title='масштаб картинки по оси Y; размер пиксела по оси Y (например в 1 пикселе картинки - 20 метров)'>"+(-1)*masY+"</td></tr>");
myWin.document.write("<tr><td>ширина в метрах</td><td>"+distX+"</td></tr>");
myWin.document.write("<tr><td>высота в метрах</td><td>"+distY+"</td></tr></table></div>");
myWin.document.write("<div id='printmapWebGis'><canvas id='exportedImage'></canvas></div>");
 myWin.document.write("</body></html>");
 myWin.document.close();
myWin.focus();*/
var htmlDivExpMap="<div id='printWebGis'><a>Щёлкните правой клавишей по картинке и сохраните её. Если некоторые слои не появляются на картинке, пожалуйста, подождите пока они не появятся или закройте и снова откройте это окно </a><div><br><button type=button onclick=CloseMapExport()>Close</button>"+
"<div id='georef'><table style='font-size:11px'><tr style='color:#000000'><td>нижняя левая долгота</td><td>"+georef.left+"</td></tr>"+
"<tr style='color:#000000'><td>нижняя левая широта</td><td>"+georef.bottom+"</td></tr>"+
"<tr style='color:#000000'><td>верхняя правая долгота</td><td>"+georef.right+"</td></tr>"+
"<tr style='color:#000000'><td>верхняя правая широта</td><td>"+georef.top+"</td></tr>"+
"<tr style='color:#000000'><td title='масштаб картинки по оси X; размер пиксела по оси X (например в 1 пикселе картинки - 20 метров)'>X метр/пиксел</td><td title='масштаб картинки по оси X; размер пиксела по оси X (например в 1 пикселе картинки - 20 метров)'>"+masX+"</td></tr>"+
"<tr style='color:#000000'><td title='масштаб картинки по оси Y; размер пиксела по оси Y (например в 1 пикселе картинки - 20 метров)'>Y метр/пиксел</td><td title='масштаб картинки по оси Y; размер пиксела по оси Y (например в 1 пикселе картинки - 20 метров)'>"+(-1)*masY+"</td></tr>"+
"<tr style='color:#000000'><td>ширина в метрах</td><td>"+distX+"</td></tr>"+
"<tr style='color:#000000'><td>высота в метрах</td><td>"+distY+"</td></tr></table></div>"+
"<div id='printmapWebGis'><canvas id='exportedImage'></canvas></div>";
var body = document.body; var docElem = document.documentElement;
 var scrollTop = window.pageYOffset || docElem.scrollTop || body.scrollTop; var scrollLeft = window.pageXOffset || docElem.scrollLeft || body.scrollLeft
 var clientTop = docElem.clientTop || body.clientTop || 0; var clientLeft = docElem.clientLeft || body.clientLeft || 0
 var topTop = 0 + scrollTop - clientTop; var leftLeft =0 + scrollLeft - clientLeft
var DivEditeLeg=document.createElement("div");DivEditeLeg.id="id_exportMapOWG";
DivEditeLeg.style.width=screen.width;DivEditeLeg.style.height=screen.height;
DivEditeLeg.className="id_divRoutLegMain";DivEditeLeg.style.position="absolute";DivEditeLeg.style.display="block";DivEditeLeg.style.zIndex = 300000;DivEditeLeg.style.background="#ffffff";DivEditeLeg.style.border="2px solid black";DivEditeLeg.style.color="#000000";
DivEditeLeg.style.left=Math.round(document.body.clientWidth/2-100);DivEditeLeg.style.top="0px";
DivEditeLeg.innerHTML=htmlDivExpMap;
if(!document.getElementById("id_exportMapOWG"))
{body.appendChild(DivEditeLeg); 
document.getElementById("id_exportMapOWG").onmousedown=function(event){drags(event)};
document.getElementById("id_exportMapOWG").onmouseup=function(e){enddrag()};}
var canvas = document.getElementById("exportedImage");
var canvasContext =canvas.getContext('2d'); 
 canvas.width =map.viewPortDiv.clientWidth;
 canvas.height =map.viewPortDiv.clientHeight;
if (document.getElementById("map").style.backgroundColor=='rgb(165, 204, 221)'||document.getElementById("map").style.backgroundColor=="rgba(204,204,204,0.5)"){}else{
var cbm=document.getElementById("map").style.backgroundColor.split("rgb(")[1].split(")")[0];
canvasContext.fillStyle = "rgb("+cbm+")";canvasContext.fillRect(0, 0, canvas.width, canvas.height); }

for(var j=0; j<map.layers.length;j++)
{
 if(map.layers[j].CLASS_NAME=="OpenLayers.Layer.Google"&&map.layers[j]==map.baseLayer)
 {
var centerG=map.getCenter();
var newLonLat=centerG.transform(
map.getProjectionObject(),new OpenLayers.Projection("EPSG:4326")
)
var LonX=newLonLat.lon;
var LatY=newLonLat.lat;
var imgNG=document.createElement("img");
var MapGw=map.viewPortDiv.clientWidth;
var MapGh=map.viewPortDiv.clientHeight;
var Warray=[];var Harray=[];var WHarray=[];
if (MapGw>640)
{
var countMapW=Math.ceil(MapGw/640);
for (var m=0;m<countMapW-1;m++){Warray.push(640)};Warray.push(MapGw-(640*(countMapW-1)));
}
else
{Warray.push(MapGw);}
if (MapGh>640)
{
var countMapH=Math.ceil(map.viewPortDiv.clientHeight/640);
for (var m=0;m<countMapH-1;m++){Harray.push(640)};Harray.push(MapGh-(640*(countMapH-1)));
}
else
{Harray.push(MapGh);}
for(var r=0;r<Warray.length;r++)
{var strWH='';
for(var rr=0;rr<Harray.length;rr++)
{strWH=Warray[r]+";"+Harray[rr];
WHarray.push(strWH);
rtt=WHarray;} }
var centS=map.calculateBounds();
var aVar=Math.abs((centS.left-centS.right))/MapGw;
var gL=centS.left;var CentX=[];var CentY=[];
for(var r=0;r<Warray.length;r++)
{ 
var centW=(Warray[r]/2)*aVar+gL;
var CentTrans=map.getCenter();
CentTrans.lon=centW;
var t=CentTrans.transform(map.getProjectionObject(),new OpenLayers.Projection("EPSG:4326"))
var centWx=t.lon;
CentX.push(centWx);
gL=gL+2*(Warray[r]/2)*aVar;
}
var aVar=Math.abs((centS.top-centS.bottom))/MapGh;
var gL=centS.bottom;
for(var r=0;r<Harray.length;r++)
{ 
var centW=(Harray[r]/2)*map.getResolution()+gL;
var CentTrans=map.getCenter();
CentTrans.lat=centW;
var t=CentTrans.transform(map.getProjectionObject(),new OpenLayers.Projection("EPSG:4326"))
var centWy=t.lat;
CentY.push(centWy);
gL=gL+2*(Harray[r]/2)*map.getResolution();
}
var CentXY=[];
for(var r=0;r<CentX.length;r++)
{var strWH='';
for(var rr=0;rr<CentY.length;rr++)
{
strWH=CentX[r]+";"+CentY[rr];
CentXY.push(strWH); }
}
rtt=CentXY;
var ImgArray=[];
for(var k=0; k<WHarray.length;k++)
 {
 {
var imgNG=document.createElement("img");
var typG=map.layers[j].type;
imgNG.src="http://maps.googleapis.com/maps/api/staticmap?sensor=false&maptype="+typG+"&scale=1&center="+CentXY[k].split(';')[1]+","+CentXY[k].split(';')[0]+"&zoom="+map.zoom+"&size="+WHarray[k].split(';')[0]+"x"+WHarray[k].split(';')[1];
imgNG.width=WHarray[k].split(';')[0];
imgNG.height=WHarray[k].split(';')[1];
ImgArray.push(imgNG);
 }
 }
var countMapW=Math.ceil(MapGw/640);
var countMapH=Math.ceil(MapGh/640);
var WidL=0; var nj=0; var HiegL=MapGh;
canvas.width =map.viewPortDiv.clientWidth;
 canvas.height =map.viewPortDiv.clientHeight;
for(var ng=0; ng<ImgArray.length; ng++)
{ 
HiegL=HiegL-ImgArray[ng].height;
var aa=canvasContext; var a=ImgArray[ng]; var b=WidL; var c=HiegL; var d=ImgArray[ng].width; var e=ImgArray[ng].height; var canvasW=canvas.width; var canvasH=canvas.height;
if(ng==ImgArray.length-1){ImgArray[ng].onload=function (aa,a,b,c,d,e,canvasW,canvasH){return function() {aa.drawImage(a,b,c,d,e);PrintWMSlayer(aa,canvasW,canvasH);
setTimeout(function(canvasContext,canvasW,canvasH) {printGraticule(canvasContext,canvasW,canvasH)}(canvasContext,canvasW,canvasH),2500);
}}(aa,a,b,c,d,e,canvasW,canvasH);}
else
{ImgArray[ng].onload=function (aa,a,b,c,d,e){return function() {aa.drawImage(a,b,c,d,e);}}(aa,a,b,c,d,e);}
var Newsrc=ImgArray[ng].src;ImgArray[ng].src='';
ImgArray[ng].src=Newsrc;
nj++; 
if(nj==countMapH)
{HiegL=MapGh;nj=0;WidL=WidL+ImgArray[ng].width;}
}
 } 
}
if(map.baseLayer.CLASS_NAME!="OpenLayers.Layer.Google")
{ 
 var totalTile=0; var countYj=0;var countY=0; var totalTile2=0;
for(var jj=0;jj<map.layers.length; jj++)
 { if(map.layers[jj].visibility==true)
{ if(map.layers[jj].CLASS_NAME=="OpenLayers.Layer.WMS"||map.layers[jj].CLASS_NAME=="OpenLayers.Layer.XYZ")
{ 
for(var y=0; y<map.layers[jj].grid.length;y++)
 { 
 for(var yj=1; yj<=map.layers[jj].grid[y].length;yj++)
 { countYj=yj; }
 countY=countY+countYj;
 }totalTile=totalTile+countY; countY=0;
 } } }
 for(var jj=0;jj<map.layers.length; jj++)
if(map.layers[jj].visibility==true)
{
 { if(map.layers[jj].CLASS_NAME=="OpenLayers.Layer.WMS"||map.layers[jj].CLASS_NAME=="OpenLayers.Layer.XYZ")
 { if(map.baseLayer.CLASS_NAME!=="OpenLayers.Layer.Vector"&&map.baseLayer.CLASS_NAME!=="OpenLayers.Layer.Image"){
 for(var y=0; y<map.layers[jj].grid.length;y++)
 {
 for(var yj=0; yj<map.layers[jj].grid[y].length;yj++)
 { var imgN=document.createElement("img");
 imgN.src=map.layers[jj].grid[y][yj].url;
 imgN.width=map.layers[jj].tileSize.w;
 imgN.height=map.layers[jj].tileSize.h;
if(map.layers[jj].visibility==true)
 {
var aa=canvasContext; var a=imgN; var b=map.layers[jj].grid[y][yj].position.x; var c=map.layers[jj].grid[y][yj].position.y; var d=map.layers[jj].tileSize.w; var e=map.layers[jj].tileSize.h;var lae=map.layers[jj];var index=jj;
b=parseInt(document.getElementById("OpenLayers.Map_13_OpenLayers_Container").style.left.split('px')[0])+parseInt(b);
c=parseInt(document.getElementById("OpenLayers.Map_13_OpenLayers_Container").style.top.split('px')[0])+parseInt(c);
countLayerTileExport=0;aa.globalAlpha=1// imgN.opacity=map.layers[jj].opacity;
if(y==map.layers[jj].grid.length-1&&yj==map.layers[jj].grid[y].length-1)
{imgN.onload=function (aa,a,b,c,d,e,totalTile,lae,index){return function() {
if(lae.CLASS_NAME=="OpenLayers.Layer.WMS"&&lae==map.baseLayer){
 var canvas = document.getElementById("exportedImage");var canvasW=canvas.width; var canvasH=canvas.height;aa.drawImage(a,b,c,d,e); PrintWMSlayer(aa,canvasW,canvasH);
setTimeout(function(aa,canvasW,canvasH) {printGraticule(aa,canvasW,canvasH)}(aa,canvasW,canvasH),2500)};
alert("Map export is completed");}   }  (aa,a,b,c,d,e,totalTile,lae,index);
}
else{
imgN.onload=function (aa,a,b,c,d,e,totalTile,lae,index){return function() {aa.globalAlpha=parseFloat(lae.opacity);aa.drawImage(a,b,c,d,e);
}   }  (aa,a,b,c,d,e,totalTile,lae,index);}
var Newsrc2=imgN.src;imgN.src='';
imgN.src=Newsrc2;
 } 
 }
 } }
 } 
 if(map.layers[jj].CLASS_NAME=="OpenLayers.Layer.WMS"&&map.layers[jj]!==map.baseLayer&&map.baseLayer.CLASS_NAME!=="OpenLayers.Layer.Vector"&&map.baseLayer.CLASS_NAME!=="OpenLayers.Layer.Image")
{ var canvasW=canvas.width; var canvasH=canvas.height; PrintWMSlayer(aa,canvasW,canvasH);
setTimeout(function(canvasContext,canvasW,canvasH) {printGraticule(canvasContext,canvasW,canvasH)}(canvasContext,canvasW,canvasH),2500)} 
 if(map.layers[jj].CLASS_NAME=="OpenLayers.Layer.Image"&&map.layers[jj]==map.baseLayer)
{ var canvasW=canvas.width; var canvasH=canvas.height; PrintWMSlayer(canvasContext,canvasW,canvasH);
setTimeout(function(canvasContext,canvasW,canvasH) {printGraticule(canvasContext,canvasW,canvasH)}(canvasContext,canvasW,canvasH),2500)} 
 if(map.layers[jj].CLASS_NAME=="OpenLayers.Layer.Vector"&&map.layers[jj]==map.baseLayer)
{ var canvas = document.getElementById("exportedImage");var canvasContext =canvas.getContext('2d'); 
var canvasW=canvas.width; var canvasH=canvas.height; PrintWMSlayer(canvasContext,canvasW,canvasH);
setTimeout(function(canvasContext,canvasW,canvasH) {printGraticule(canvasContext,canvasW,canvasH)}(canvasContext,canvasW,canvasH),2500)} 

}  }
 }
for(var a=0; a<map.layers.length;a++)
{
if(map.layers[a].CLASS_NAME=="OpenLayers.Layer.OSM"&&map.layers[a]==map.baseLayer)
 {
 for(var y=0; y<map.layers[a].grid.length;y++)
 {
 for(var yj=0; yj<map.layers[a].grid[y].length;yj++)
 { var imgN=document.createElement("img");
 imgN.src=map.layers[a].grid[y][yj].url;
 imgN.width=map.layers[a].tileSize.w;
 imgN.height=map.layers[a].tileSize.h;
 var aa=canvasContext; aa.globalAlpha=1;var ab=imgN; var b=map.layers[a].grid[y][yj].position.x; var c=map.layers[a].grid[y][yj].position.y; var d=map.layers[a].tileSize.w; var e=map.layers[a].tileSize.h;var canvasW=canvas.width; var canvasH=canvas.height; 
b=parseInt(document.getElementById("OpenLayers.Map_13_OpenLayers_Container").style.left.split('px')[0])+parseInt(b);
c=parseInt(document.getElementById("OpenLayers.Map_13_OpenLayers_Container").style.top.split('px')[0])+parseInt(c);
if(y==map.layers[a].grid.length-1&&yj==map.layers[a].grid[y].length-1){imgN.onload=function (aa,ab,b,c,d,e){return function() {aa.drawImage(ab,b,c,d,e);PrintWMSlayer(aa,canvasW,canvasH);
setTimeout(function(aa,canvasW,canvasH) {printGraticule(aa,canvasW,canvasH)}(aa,canvasW,canvasH),2500)
}}(aa,ab,b,c,d,e,canvasW,canvasH);}
else
{imgN.onload=function (aa,ab,b,c,d,e){return function() {aa.drawImage(ab,b,c,d,e);}}(aa,ab,b,c,d,e);}
var Newsrc2=imgN.src;imgN.src='';
imgN.src=Newsrc2;
 }
 }
 }
}

}
function printGraticule(canvasContext,canvasW,canvasH)
{
var gratLa=0;
if(typeof graticuleCtl2!=="undefined"){
map.removeLayer(graticuleCtl2.gratLayer);
graticuleCtl2.gratLayer.renderers=["Canvas", "SVG", "VML"];graticuleCtl2.gratLayer.assignRenderer();gratLa=graticuleCtl2.gratLayer; map.addLayer(gratLa);graticuleCtl2.gratLayer.redraw();
}
if(gratLa!==0)
{if(gratLa.visibility==true)
{ var aa=canvasContext; var a=gratLa; var b=canvasW; var c=canvasH;aa.globalAlpha=1;
if(gratLa.styleMap.styles.default.rules[0])
{aa.globalAlpha=parseFloat(gratLa.styleMap.styles.default.rules[0].symbolizer.fillOpacity);}
else
{aa.globalAlpha=parseFloat(gratLa.styleMap.styles.default.defaultStyle.fillOpacity);}
aa.drawImage(a.renderer.canvas.canvas, 0, 0,b,c);
}  }

if(typeof graticuleCtl2!=="undefined"){
graticuleCtl2.gratLayer.events.unregister("featureadded",graticuleCtl2.gratLayer, function() {});
map.removeLayer(graticuleCtl2.gratLayer);map.removeControl(graticuleCtl2);
graticuleCtl2 = new OpenLayers.Control.Graticule({
 labelled: true,
 targetSize: 200
 });map.addControl( graticuleCtl2);
filterA=new OpenLayers.Filter.Comparison({
 type: OpenLayers.Filter.Comparison.BETWEEN,
 property: "value",
 upperBoundary: parseInt(180.0),
 lowerBoundary: parseInt(-180.0)
 })
graticuleCtl2.gratLayer.styleMap.styles.default.rules[0].filter=filterA;
graticuleCtl2.gratLayer.styleMap.styles.default.defaultStyle={};
graticuleCtl2.gratLayer.setVisibility(false);
graticuleCtl2.gratLayer.setVisibility(true);
for(var i=0;i<graticuleCtl2.gratLayer.features.length;i++)
{if(!graticuleCtl2.gratLayer.features[i].attributes['value']){graticuleCtl2.gratLayer.features[i].attributes['value']=0}};graticuleCtl2.gratLayer.redraw();
graticuleCtl2.gratLayer.events.register("featureadded",graticuleCtl2.gratLayer, function() {for(var i=0;i<graticuleCtl2.gratLayer.features.length;i++)
{if(!graticuleCtl2.gratLayer.features[i].attributes['value']){graticuleCtl2.gratLayer.features[i].attributes['value']=0}};graticuleCtl2.gratLayer.redraw();})
graticuleCtl2.gratLayer.redraw()
GraticulePropertyStyles=graticuleCtl2.gratLayer.styleMap.styles.default.propertyStyles;
GraticuleRule=filterA; 
 }

}
function PrintVectorlayer(canvasContext,canvasW,canvasH,laeb)
{ 
 if(laeb&&laeb.CLASS_NAME=="OpenLayers.Layer.Image"&&laeb.visibility==true)
{var img = new Image();img.src=laeb.url;canvasContext.globalAlpha=parseFloat(laeb.opacity);// img.opacity=map.layers[i].opacity;
var bbox = document.getElementById("map").getBoundingClientRect();
 var body = document.body;
 var docElem = document.documentElement;
 var scrollTop = window.pageYOffset || docElem.scrollTop || body.scrollTop;
 var scrollLeft = window.pageXOffset || docElem.scrollLeft || body.scrollLeft;
 var clientTop = docElem.clientTop || body.clientTop || 0;
 var clientLeft = docElem.clientLeft || body.clientLeft || 0;
 var topTop = bbox.top + scrollTop - clientTop;
 var leftLeft = bbox.left + scrollLeft - clientLeft;

var imageDivG=laeb.div.children[0];
var bbox = imageDivG.getBoundingClientRect();
 var body = document.body;
 var docElem = document.documentElement;
 var scrollTop = window.pageYOffset || docElem.scrollTop || body.scrollTop;
 var scrollLeft = window.pageXOffset || docElem.scrollLeft || body.scrollLeft;
 var clientTop = docElem.clientTop || body.clientTop || 0;
 var clientLeft = docElem.clientLeft || body.clientLeft || 0;
 var topTop2 = bbox.top + scrollTop - clientTop;
 var leftLeft2 = bbox.left + scrollLeft - clientLeft;
var posImY=topTop2-topTop-1;
var posImX=leftLeft2-leftLeft-1;
canvasContext.drawImage(img, posImX, posImY,laeb.tileSize.w,laeb.tileSize.h);
}
if(laeb&&laeb.renderer&&laeb.renderer.canvas){if(laeb.visibility==true)
{ var aa=canvasContext; var a=laeb; var b=canvasW; var c=canvasH;
if(laeb.styleMap.styles.default.rules[0])
{aa.globalAlpha=parseFloat(laeb.styleMap.styles.default.rules[0].symbolizer.fillOpacity);}
else
{aa.globalAlpha=parseFloat(laeb.styleMap.styles.default.defaultStyle.fillOpacity);}
aa.drawImage(a.renderer.canvas.canvas, 0, 0,b,c);aa.globalAlpha=1;
} } 



}
function PrintOSMlayer(aa,canvasW,canvasH,canva)
{var a=canva; aa.drawImage(a.childNodes[0],0,0,canvasW,canvasH);aa.drawImage(a.childNodes[1],0,0,canvasW,canvasH);aa.drawImage(a.childNodes[2],0,0,canvasW,canvasH);
}
function PrintWMSlayer(canvasContext,canvasW,canvasH)
{ 
for(var j=0;j<map.layers.length; j++)
 { var laeb=map.layers[j];
var totalTile=0; var countYj=0;var countY=0; var totalTile2=0;
if(laeb.renderer&&laeb.renderer.canvas){
/*setTimeout(function(canvasContext,canvasW,canvasH,laeb) { */PrintVectorlayer(canvasContext,canvasW,canvasH,laeb)/*}(canvasContext,canvasW,canvasH,laeb),500)*/
}
if(laeb.attribution&&laeb.attribution=='&copy; <a href="http://osmbuildings.org">OSM Buildings</a>'&&laeb.visibility==true)
{ var aaosm=canvasContext;PrintOSMlayer(aaosm,canvasW,canvasH,laeb.div.childNodes[0]);}
if(laeb.heatmapparams&&laeb.visibility==true){canvasContext.drawImage(laeb.div.childNodes[0],0,0,canvasW,canvasH);}
if(laeb.idwmapparams&&laeb.visibility==true){canvasContext.drawImage(laeb.div.childNodes[0],0,0,canvasW,canvasH);}
if(laeb.CLASS_NAME=="OpenLayers.Layer.Image")
{PrintVectorlayer(canvasContext,canvasW,canvasH,laeb)}

 if(laeb.CLASS_NAME=="OpenLayers.Layer.WMS"||laeb.CLASS_NAME=="OpenLayers.Layer.XYZ")
{ if(laeb!==map.baseLayer)
{for(var y=0; y<laeb.grid.length;y++)
 { 
 for(var yj=1; yj<=laeb.grid[y].length;yj++)
 { countYj=yj; }
 countY=countY+countYj;
 }totalTile=totalTile+countY; countY=0;
}  } 

 if(laeb.CLASS_NAME=="OpenLayers.Layer.WMS"||laeb.CLASS_NAME=="OpenLayers.Layer.XYZ")
 { if(laeb!==map.baseLayer) {
 for(var y=0; y<laeb.grid.length;y++)
 {
 for(var yj=0; yj<laeb.grid[y].length;yj++)
 { var imgN=document.createElement("img");
 imgN.src=laeb.grid[y][yj].url;
 imgN.width=laeb.tileSize.w;
 imgN.height=laeb.tileSize.h;
if(laeb.visibility==true)
 {
var aa=canvasContext; var a=imgN; var b=laeb.grid[y][yj].position.x; var c=laeb.grid[y][yj].position.y; var d=laeb.tileSize.w; var e=laeb.tileSize.h; var index=j
b=parseInt(document.getElementById("OpenLayers.Map_13_OpenLayers_Container").style.left.split('px')[0])+parseInt(b);
c=parseInt(document.getElementById("OpenLayers.Map_13_OpenLayers_Container").style.top.split('px')[0])+parseInt(c);
countLayerTileExport=0;aa.globalAlpha=1;
if(y==laeb.grid.length-1&&yj==laeb.grid[y].length-1)
{
imgN.onload=function (aa,a,b,c,d,e,totalTile,index){return function() {aa.globalAlpha=parseFloat(map.layers[index].opacity);aa.drawImage(a,b,c,d,e);if(map.layers[index+1]&&map.layers[index+1].renderer&&map.layers[index+1].renderer.canvas)
{aa.globalAlpha=1;PrintVectorlayer(aa,canvasW,canvasH,map.layers[index+1]);}
/*alert("Map export is completed");*/} }(aa,a,b,c,d,e,totalTile,index)
}
else
{
imgN.onload=function (aa,a,b,c,d,e,totalTile,index){return function() { aa.globalAlpha=parseFloat(map.layers[index].opacity);aa.drawImage(a,b,c,d,e);} }(aa,a,b,c,d,e,totalTile,index);
}


var Newsrc2=imgN.src;imgN.src='';
imgN.src=Newsrc2;
 } 
 }
 }
     }    } 
     }
}
function ZoomCur()
{
var htmlTextN='';
htmlTextN+='<a>Please select city name:</a><br>'+
'<a></a>'+
'<select id=cityCoordNameOpen_id >'+
 '<option selected value="0">.</option>'+
'</select><br>'+ 
'<input type="text" size="18" id="idZoom_to_city" value="10">zoom<br>'+
'<p> <button type=button onclick=OK_ZoomToCity()>OK</button></p>';
popup_ZoomToCity= new OpenLayers.Popup.FramedCloud("popup_ZoomToCity_id",
 map.getCenter(),
 new OpenLayers.Size(400,400),
 htmlTextN ,
 null, true, onPopupClose);
 map.addPopup(popup_ZoomToCity);
document.getElementById("popup_ZoomToCity_id").onmousedown=function(event){drags(event)};
document.getElementById("popup_ZoomToCity_id").onmouseup=function(e){enddrag()};
WaitWindow();
alert("Эта функция работает только в онлайн веб-версии OpenWebGIS")
 {return;}
var oXml=OpenLayers.Request.GET({
 url: '/geoserver/wfs?service=wfs&version=1.1.0&request=GetFeature&typeName=webgis:Cities&propertyName=NAME,the_geom&sortBy=NAME+A',
 async: false,
success: function(e){
 oXml=e;
var strXml = oXml.text;
 var oXmlDoc = null;
strXml = oXml.responseText;
 if ( window.DOMParser ) {
 var oXmlParser = new DOMParser();
 oXmlDoc = oXmlParser.parseFromString( strXml, "text/xml" );
 } else {
 oXmlDoc = new ActiveXObject( "Microsoft.XMLDOM" );
 oXmlDoc.async = "false";
 oXmlDoc.loadXML( strXml );
 }
var arrFeaturesTable = oXmlDoc.getElementsByTagName('webgis:Cities');
if(arrFeaturesTable.length==0)
{arrFeaturesTable = oXmlDoc.getElementsByTagName('Cities');}
for (var i = 0; i < arrFeaturesTable.length; i++) 
{ var t=this.document.createElement('option');
for (var a=0; a<arrFeaturesTable[i].childNodes.length; a++)
 { 
 if( arrFeaturesTable[i].childNodes[a].nodeName=="webgis:NAME")
 {t.text=arrFeaturesTable[i].childNodes[a].childNodes[0].nodeValue;}
if( arrFeaturesTable[i].childNodes[a].nodeName=="webgis:the_geom")
 {t.value=arrFeaturesTable[i].childNodes[a].childNodes[0].childNodes[0].textContent;}
 }
this.document.getElementById("cityCoordNameOpen_id").appendChild(t);
}
if(popup_Wait){try{popup_Wait.destroy();}catch(e){};}
 }
 });
}
function OK_ZoomToCity()
{
popup_ZoomToCity.hide();
map.setCenter(new OpenLayers.LonLat(document.getElementById("cityCoordNameOpen_id").value.split(' ')[1], document.getElementById("cityCoordNameOpen_id").value.split(' ')[0]).transform(
new OpenLayers.Projection("EPSG:4326"),
map.getProjectionObject()), document.getElementById("idZoom_to_city").value);
popup_ZoomToCity.destroy();
}
function PreView()
{
map.setCenter(mapCenterPan[0]);
map.zoomTo(mapCenterZoom[0]);
}
function ZoomCoord()
{
var htmlTextN='';
htmlTextN+='<a>Введите долготу и широту:</a><br>'+
 '<input type="text" size="8" id="new_longZomm_id" value="">долгота<br>'+
 '<input type="text" size="8" id="new_latZomm_id" value="">широта<br>'+
 '<input type="text" size="8" id="new_ZoomZomm_id" value="10">увеличение<br>'+
'<p> <button type=button onclick=OK_New_LonLatZoom()>OK</button></p>';
popup_new_LonLatZoom = new OpenLayers.Popup.FramedCloud("LonLatZoomPopup_id",
 map.getCenter(),
 new OpenLayers.Size(400,400),
 htmlTextN ,
 null, true, onPopupClose);
 map.addPopup(popup_new_LonLatZoom);
document.getElementById("LonLatZoomPopup_id").onmousedown=function(event){drags(event)};
document.getElementById("LonLatZoomPopup_id").onmouseup=function(e){enddrag()};
}
function OK_New_LonLatZoom()
{
popup_new_LonLatZoom.hide();
map.setCenter(new OpenLayers.LonLat(document.getElementById("new_longZomm_id").value, document.getElementById("new_latZomm_id").value).transform(
new OpenLayers.Projection("EPSG:4326"),
map.getProjectionObject()), document.getElementById("new_ZoomZomm_id").value);
popup_new_LonLatZoom.destroy();
}
function New_Layer()
{
var htmlTextN='';
htmlTextN+='<a>Please insert name New Layer:</a><br>'+
 '<input type="text" size="18" id="new_layer_id" value="new_layer" title="Новый слой создаётся без атрибутов(без атрибутивной таблицы).  Вы можете добавить атрибут через пункт меню Редактирование-> Добавить атрибут в слой, но после создания полигона, точки или линии. Важно: в одном слое может быть только один тип геометрии — точка, полигон или линия."><br>'+
'<a>Please select type of layer:</a>'+
'<select id=geom_method_id title="Новый слой создаётся без атрибутов(без атрибутивной таблицы).  Вы можете добавить атрибут через пункт меню Редактирование-> Добавить атрибут в слой, но после создания полигона, точки или линии. Важно: в одном слое может быть только один тип геометрии — точка, полигон или линия.">'+
 '<option  value="1">Point</option>'+
'<option  value="2">Line</option>'+
'<option selected value="3">Polygon</option>'+
'</select><br>'+
'<p> <button type=button onclick=OK_New_Layer()>OK</button></p>';
popup_new_layer = new OpenLayers.Popup.FramedCloud("NewLayerPopup",
 map.getCenter(),
 new OpenLayers.Size(400,400),
 htmlTextN ,
 null, true, onPopupClose);
 map.addPopup(popup_new_layer);
}
function OK_New_Layer()
{
var new_style_layer= new OpenLayers.Style({
 pointRadius: 3,
 fillColor: "#FF9000",
 strokeColor: "#FF9000",
 strokeWidth: 1,
fillOpacity:1,
 strokeOpacity:1
 });
 var selStyle = new OpenLayers.Style({
 pointRadius: 5, 
 fillColor: "#ffaa00",
 strokeColor: "#00DDFF",
 strokeWidth:2,
fillOpacity:1,
 strokeOpacity:1
 }); 
var new_layer_n = new OpenLayers.Layer.Vector(document.getElementById("new_layer_id").value,{renderers:["Canvas", "SVG", "VML"]});
var box_extents = [
 [21.08, 55.19]
 ];
var new_pos=new OpenLayers.LonLat(21.08,55.19).transform(
new OpenLayers.Projection("EPSG:4326"),
map.getProjectionObject());
var new_lon=new_pos.lon;
var new_lat=new_pos.lat;
if(document.getElementById("geom_method_id").value==1)
{
var first_point =new OpenLayers.Geometry.Point(new_lon, new_lat);
first_point= new OpenLayers.Feature.Vector(first_point);
new_layer_n.projection=new OpenLayers.Projection("EPSG:900913");
new_layer_n.addFeatures(first_point);
first_point.attributes.id="0";
first_point.data.id="0";
first_point.fid=new_layer_n.name+"."+"1";
}
if(document.getElementById("geom_method_id").value==2)
{
var new_pos2=new OpenLayers.LonLat(21.15,55.19).transform(
new OpenLayers.Projection("EPSG:4326"),
map.getProjectionObject());
var new_pos3=new OpenLayers.LonLat(21.30,55.30).transform(
new OpenLayers.Projection("EPSG:4326"),
map.getProjectionObject());
var new_lon2=new_pos2.lon;
var new_lat2=new_pos2.lat;
var new_lat3=new_pos3.lat;
var first_point1=new OpenLayers.Geometry.Point(new_lon, new_lat);
var first_point2=new OpenLayers.Geometry.Point(new_lon2, new_lat2);
var first_point3=new OpenLayers.Geometry.Point(new_lon2, new_lat3);
var first_line1=new OpenLayers.Geometry.LineString([first_point1,first_point2]);
var first_line2=new OpenLayers.Geometry.LineString([first_point2,first_point3]);
var first_multiline = new OpenLayers.Geometry.MultiLineString([first_line1,first_line2]);
first_multiline= new OpenLayers.Feature.Vector(first_multiline);
new_layer_n.projection=new OpenLayers.Projection("EPSG:900913");
new_layer_n.addFeatures(first_multiline);
first_multiline.attributes.id="0";
first_multiline.data.id="0";
first_multiline.fid=new_layer_n.name+"."+"1";
}
if(document.getElementById("geom_method_id").value==3)
{
var new_pos2=new OpenLayers.LonLat(21.15,55.19).transform(
new OpenLayers.Projection("EPSG:4326"),
map.getProjectionObject());
var new_pos3=new OpenLayers.LonLat(21.30,55.30).transform(
new OpenLayers.Projection("EPSG:4326"),
map.getProjectionObject());
var new_lon2=new_pos2.lon;
var new_lat2=new_pos2.lat;
var new_lat3=new_pos3.lat;
 var box_extents = [
 [new_lon, new_lat,new_lon2, new_lat3]
 ];
 for (var i = 0; i < box_extents.length; i++) {
 var ext = box_extents[i];
 var bounds = OpenLayers.Bounds.fromArray(ext);
 var box = new OpenLayers.Feature.Vector(bounds.toGeometry());
 new_layer_n.addFeatures(box);
 }
box.attributes.id="0";
box.data.id="0";
box.fid=new_layer_n.name+"."+"1";
}
new_layer_n.styleMap=new OpenLayers.StyleMap({'default':new_style_layer,'select': selStyle});
map.addLayer(new_layer_n);
 var t=this.document.createElement('option');
t.value=new_layer_n.name;
t.text=new_layer_n.name;
this.document.getElementById("editL1").appendChild(t);
new_layer_n.projection=new OpenLayers.Projection("EPSG:4326");
popup_new_layer.destroy();
new_layer_n.features[0].destroy();

}
function closeOrderlayerWin()
{
document.getElementById("id_divOrderLayer").parentNode.removeChild(document.getElementById("id_divOrderLayer"));
}
function ChangeOrderlayersOpen()
{
var listStart=map.layers;
var listEnd=[];
var re = /\n*\s*;\s*\n*/
var str=document.getElementById("textarea_orderlayer_id").value.split(re);
var index=0;
for(var i=0;i<map.layers.length;i++)
{if(map.layers[i].isBaseLayer==true)
{index++;}
}

for(var i=0;i<map.layers.length;i++)
{
if(map.layers[i].isBaseLayer==false)
{
listEnd.push(map.layers[i].getZIndex());
}
}

for(var ii=0;ii<str.length;ii++)
{for(var i=0;i<map.layers.length;i++)
{
if(map.layers[i].isBaseLayer==false)
{if(map.layers[i].name==str[ii])
{map.setLayerIndex(map.layers[i],index+ii);}
}
}}

for(var i=0;i<map.layers.length;i++)
{
if(map.layers[i].isBaseLayer==false)
{
map.layers[i].setZIndex(listEnd[i-index]);
}
}
}
function OK_OSMeditLayer()
{
var bbox = document.getElementById("map").getBoundingClientRect();
 var body = document.body
 var docElem = document.documentElement
 var scrollTop = window.pageYOffset || docElem.scrollTop || body.scrollTop
 var scrollLeft = window.pageXOffset || docElem.scrollLeft || body.scrollLeft
 var clientTop = docElem.clientTop || body.clientTop || 0
 var clientLeft = docElem.clientLeft || body.clientLeft || 0
 var topTop = bbox.top + scrollTop - clientTop
 var leftLeft = bbox.left + scrollLeft - clientLeft
var DivEditeLeg=document.createElement("div");
DivEditeLeg.id="id_divOSMeditLayer";
DivEditeLeg.className="id_divRoutLegMain";
DivEditeLeg.style.position="relative";
DivEditeLeg.innerHTML='<div id="id_divOSMeditLayerLeg" style="background:#ffffff; color:#0000ff;z-index: 6000;position:absolute;left:'+Math.round(leftLeft+50)+'px;top:'+Math.round(topTop-90)+
'px;overflow:hidden; border: 1px solid black;"><img onclick="closeOSMeditLayerWin()" src="openlayers/theme/default/img/close.gif" style="position:relative; top:10px;float:right; cursor:pointer"><a style="position:relative; top:20px"></a>'+
'<a style="font-size: 9px;">вы можете перемещать это окно если щёлкните по пункту меню: /переключить режим интерфейса/</a><br>'+
'Выберите слой OSM Buildings: <select id="OSMBLayerName_id" >.'+
 '<option selected value="0">.</option>'+
'</select><br>'+
'цвет стен:<div id=divcolor_osmbWall style="width:364px; height:20px;"></div>'+'<div id="blockOSMcolW" style="width:30px; height:20px; background:#ccc;border: solid 1px black;float:left;"></div><input size="6" title=""введите цвет в шестнадцатиричном формате. Например: #00FFFF" type="text" id="blockOSMcolWh_id" style="float:left;border: solid 1px black;"><button type=button onclick=OK_blockOSMcolWh_id()><a style="font-size: 10px;">применить</a></button><br>'+
'<a style="position:relative;left:-30px">цвет крыш:</a><div id=divcolor_osmbroof style="width:364px; height:20px;"></div>'+'<div id="blockOSMcolR" style="width:30px; height:20px; background:#ccc;border: solid 1px black;float:left;"></div>'+'<input size="6" title="введите цвет в шестнадцатиричном формате. Например: #00FFFF" type="text" id="blockOSMcolWr_id" style="float:left;border: solid 1px black;"><button type=button onclick=OK_blockOSMcolWr_id()><a style="font-size: 10px;">применить</a></button><br>'+
'<input style="position:relative;left:-30px" type="checkbox" id="id_OSMBMapSh" title="" value="checkbox"/><a style="position:relative;left:-30px">Тени</a>opacity:<input type="text" size="5" id="dopOSMBpointjsonOpac" title="" value="0.95"/>'+
'<p> <button type=button onclick=OK_OSMeditLayer2()>OK</button></p>'+
'<a style="font-size: 11px;">Выберете названия слоя для 3D:</a> <select onchange=chanNameOSMBextrude() id="OSMBLayerNameEx_id" >.'+
 '<option selected value="0">.</option>'+
'</select><br>Выберете атрибут с высотой: <select id="OSMBLayerNameExH_id" >.'+
 '<option selected value="0">.</option>'+
'</select><br>'+
'<a>введите название нового слоя:</a><input type="text" size="25" id="id_customOSMbLayer" title="введите название нового слоя, который будет показывать 3d(объёмное) представление слоя, указанного выше" value="customOSMbuildings"/><br>'+
'<a title="Только для слоя точек" style="font-size: 11px;">размер полигона в градусах:</a><input type="text" size="5" id="dopOSMBpointjson" title="Только для слоя точек.Точки будут преобразованы в правильный многоугольник и нарисованы в 3d. Установите радиус в градусах. Результатом будут правильные многоугольники вокруг радиуса" value="0.0001"/><a title="Только для слоя точек" style="font-size: 11px;">количество углов:</a><input type="text" size="5" id="dopOSMBpointjsonsides" title="" value="20"/><br>'+
'<p> <button type=button onclick=OK_OSMExtrudeLayer2()>создать 3d</button></p>'+
'</div>';

if(!document.getElementById("id_divOSMeditLayer"))
{body.appendChild(DivEditeLeg); 

document.getElementById("id_divOSMeditLayer").onmousedown=function(event){drags(event)};
document.getElementById("id_divOSMeditLayer").onmouseup=function(e){enddrag()};
for(var i=0;i<map.layers.length;i++)
{ if(map.layers[i].CLASS_NAME=="OpenLayers.Layer")
{var t=document.createElement('option');t.value=map.layers[i].name;t.text=map.layers[i].name;
document.getElementById("OSMBLayerName_id").appendChild(t);} } 
for(var i=0;i<map.layers.length;i++)
{ if(map.layers[i].CLASS_NAME=="OpenLayers.Layer.Vector")
{var t=document.createElement('option');t.value=map.layers[i].name;t.text=map.layers[i].name;
document.getElementById("OSMBLayerNameEx_id").appendChild(t);} } 
var out = "";
for (var i = 0; i < 360; i++) {
out += "<div onclick='selectColorOSMw(this);' style='width:1px;height:20px;float:left;background-color:" + HSLToRGB(i, 100, 100) + "'><\/div>";
}
out += "<div onclick='selectColorOSMw(this);' style='background-color:#FFFFFF; width:2px;height:20px;float:left;'><\/div>";
out += "<div onclick='selectColorOSMw(this);' style='background-color:#000000; width:2px;height:20px;float:left;'><\/div>";
document.getElementById("divcolor_osmbWall").innerHTML = out;

var out = "";
for (var i = 0; i < 360; i++) {
out += "<div onclick='selectColorOSMr(this);' style='width:1px;height:20px;float:left;background-color:" + HSLToRGB(i, 100, 100) + "'><\/div>";}
out += "<div onclick='selectColorOSMr(this);' style='background-color:#FFFFFF; width:2px;height:20px;float:left;'><\/div>";
out += "<div onclick='selectColorOSMr(this);' style='background-color:#000000; width:2px;height:20px;float:left;'><\/div>";
document.getElementById("divcolor_osmbroof").innerHTML = out;
} }
function closeOSMeditLayerWin()
{document.getElementById("id_divOSMeditLayer").parentNode.removeChild(document.getElementById("id_divOSMeditLayer"));}
function selectColorOSMw(div) {colorLeg = div.style.backgroundColor;colorLeg = rgbNormal(colorLeg);
document.getElementById("blockOSMcolW").style.background=colorLeg; }
function selectColorOSMr(div) {colorLeg = div.style.backgroundColor;colorLeg = rgbNormal(colorLeg);
document.getElementById("blockOSMcolR").style.background=colorLeg; }
function OK_OSMeditLayer2()
{if(document.getElementById("OSMBLayerName_id").value=="0"){alert("Please, select layer's name");return;}
for(var i=0;i<map.layers.length;i++)
{
if(map.layers[i].name==document.getElementById("OSMBLayerName_id").value&&map.layers[i].CLASS_NAME=="OpenLayers.Layer")
{opacityOSMbuild=parseFloat(document.getElementById("dopOSMBpointjsonOpac").value);map.layers[i].style({ wallColor:document.getElementById("blockOSMcolW").style.backgroundColor, roofColor:document.getElementById("blockOSMcolR").style.backgroundColor, shadows:document.getElementById("id_OSMBMapSh").checked});
map.layers[i].wallColor=document.getElementById("blockOSMcolW").style.backgroundColor;map.layers[i].roofColor=document.getElementById("blockOSMcolR").style.backgroundColor;
map.layers[i].shadow=document.getElementById("id_OSMBMapSh").checked;map.layers[i].opacityOSMbuild=opacityOSMbuild;
map.layers[i].setVisibility(false);map.layers[i].setVisibility(true);
}
}  }
function OK_OSMExtrudeLayer2()
{var t=document.createElement('option');t.value=document.getElementById("id_customOSMbLayer").value;t.text=document.getElementById("id_customOSMbLayer").value;document.getElementById("OSMBLayerName_id").appendChild(t);
if(document.getElementById("id_25dDateTime")){if(document.getElementById("id_25dDateTime").checked==true){document.getElementById("id_25dDateTime").layer25D=document.getElementById("id_customOSMbLayer").value}}

for(var i=0;i<map.layers.length;i++)
{
if(map.layers[i].name==document.getElementById("OSMBLayerNameEx_id").value&&map.layers[i].CLASS_NAME=="OpenLayers.Layer.Vector")
{var format = new OpenLayers.Format.GeoJSON({ 'internalProjection': new OpenLayers.Projection("EPSG:900913"),'externalProjection': new OpenLayers.Projection("EPSG:4326")});
jsonstringosm = format.write(map.layers[i].features);
if(map.layers[i].features[0].geometry.CLASS_NAME=="OpenLayers.Geometry.Point")
{jsonstringosm=OK_OSMExtrudeLayerPoint(jsonstringosm,map.layers[i]);}
var jsparse=JSON.parse(jsonstringosm);
for(var y=0;y<jsparse.features.length;y++)
{var atr=document.getElementById("OSMBLayerNameExH_id").value;var c=jsparse.features[y].properties[atr];
var varcolor=setcolorOSMBfeature(jsparse.features[y],map.layers[i])
jsparse.features[y].properties["color"]=varcolor;
delete jsparse.features[y].properties[atr];jsparse.features[y].properties["height"]=parseFloat(c);}
var jsonstringosm2 = JSON.stringify(jsparse);
if(!document.getElementById("OSMscript_script_id"))
{var scriptB = document.createElement("script"); 
scriptB.src = 'openlayers/OSMBuildings-OpenLayers.js';  scriptB.type = 'text/javascript';  scriptB.id="OSMscript_script_id";
scriptB.async=false;document.body.appendChild(scriptB);
scriptB.onload= function(){var osmbjson = new OSMBuildings(map).set(jsparse);osmbjson.name=document.getElementById("id_customOSMbLayer").value;osmbjson.customJson=jsonstringosm2;osmbjson.setVisibility(false);osmbjson.setVisibility(true); osmbjson.onMapResize=function(){OSMBonMapResize(osmbjson)};;}}
else
{document.getElementById("OSMscript_script_id").parentNode.removeChild(document.getElementById("OSMscript_script_id"));OSMBuildings='';
var scriptB = document.createElement("script"); scriptB.src = 'openlayers/OSMBuildings-OpenLayers.js'; 
 scriptB.type = 'text/javascript';  scriptB.id="OSMscript_script_id";scriptB.async=false;document.body.appendChild(scriptB)
scriptB.onload= function(){var osmbjson = new OSMBuildings(map).set(jsparse);osmbjson.name=document.getElementById("id_customOSMbLayer").value;osmbjson.customJson=jsonstringosm2;osmbjson.setVisibility(false);osmbjson.setVisibility(true);osmbjson.onMapResize=function(){OSMBonMapResize(osmbjson)};;}
}
   }
} }
function OK_OSMExtrudeLayerTimeLine(new_layer_Heat,json25dfeat)
{json25dfeat=JSON.parse(json25dfeat);
new_layer_Heat.set(json25dfeat);new_layer_Heat.onMapResize=function(){OSMBonMapResize(json25dfeat)};

}
function setcolorOSMBfeature(featosmb,layerosmb)
{
var color='';
var entity = featosmb;
if(layerosmb.styleMap.styles.default.rules.length==0)
{if(layerosmb.features[0].geometry.CLASS_NAME=="OpenLayers.Geometry.Point"||layerosmb.features[0].geometry.CLASS_NAME=="OpenLayers.Geometry.Polygon"||layerosmb.features[0].geometry.CLASS_NAME=="OpenLayers.Geometry.MultiPolygon")
{ color=layerosmb.styleMap.styles.default.defaultStyle.fillColor;}
else
{color=layerosmb.styleMap.styles.default.defaultStyle.strokeColor;}
}
else
{
for(var tt=0;tt<layerosmb.styleMap.styles.default.rules.length;tt++)
{ 
if(layerosmb.styleMap.styles.default.rules[tt].filter.CLASS_NAME=="OpenLayers.Filter.Comparison"&&parseFloat(entity.properties[layerosmb.styleMap.styles.default.rules[tt].filter.property])>=parseFloat(layerosmb.styleMap.styles.default.rules[tt].filter.lowerBoundary)&&parseFloat(entity.properties[layerosmb.styleMap.styles.default.rules[tt].filter.property])<=parseFloat(layerosmb.styleMap.styles.default.rules[tt].filter.upperBoundary))
{if(layerosmb.features[0].geometry.CLASS_NAME=="OpenLayers.Geometry.Point"||layerosmb.features[0].geometry.CLASS_NAME=="OpenLayers.Geometry.Polygon"||layerosmb.features[0].geometry.CLASS_NAME=="OpenLayers.Geometry.MultiPolygon")
{color=layerosmb.styleMap.styles.default.rules[tt].symbolizer.fillColor}
else{color=layerosmb.styleMap.styles.default.rules[tt].symbolizer.strokeColor}
}
if(layerosmb.styleMap.styles.default.rules[tt].filter.CLASS_NAME=="OpenLayers.Filter.Logical"&&layerosmb.styleMap.styles.default.rules[0].filter.filters)
{ if(layerosmb.styleMap.styles.default.rules.length==1)
{if(entity.properties[layerosmb.styleMap.styles.default.rules[tt].filter.filters[0].property]>=layerosmb.styleMap.styles.default.rules[tt].filter.filters[0].value&&entity.properties[layerosmb.styleMap.styles.default.rules[tt].filter.filters[0].property]<layerosmb.styleMap.styles.default.rules[tt].filter.filters[1].value)
{if(layerosmb.features[0].geometry.CLASS_NAME=="OpenLayers.Geometry.Point"||layerosmb.features[0].geometry.CLASS_NAME=="OpenLayers.Geometry.Polygon"||layerosmb.features[0].geometry.CLASS_NAME=="OpenLayers.Geometry.MultiPolygon")
{if(layerosmb.styleMap.styles.default.rules[tt].symbolizer.fillColor.split('rgb(')[1])
{color=layerosmb.styleMap.styles.default.rules[tt].symbolizer.fillColor}else{color=layerosmb.styleMap.styles.default.rules[tt].symbolizer.fillColor;}
}else{
if(layerosmb.styleMap.styles.default.rules[tt].symbolizer.fillColor.split('rgb(')[1])
{color=layerosmb.styleMap.styles.default.rules[tt].symbolizer.strokeColor;}else{color=layerosmb.styleMap.styles.default.rules[tt].symbolizer.strokeColor;}
}  }  }
if(layerosmb.styleMap.styles.default.rules.length>1)
{if(entity.properties[layerosmb.styleMap.styles.default.rules[tt].filter.filters[0].property]>=layerosmb.styleMap.styles.default.rules[tt].filter.filters[0].value&&entity.properties[layerosmb.styleMap.styles.default.rules[tt].filter.filters[0].property]<layerosmb.styleMap.styles.default.rules[tt].filter.filters[1].value&&entity.properties[layerosmb.styleMap.styles.default.rules[tt].filter.filters[2].property]>=layerosmb.styleMap.styles.default.rules[tt].filter.filters[2].lowerBoundary&&entity.properties[layerosmb.styleMap.styles.default.rules[tt].filter.filters[2].property]<=layerosmb.styleMap.styles.default.rules[tt].filter.filters[2].upperBoundary)
{if(layerosmb.features[0].geometry.CLASS_NAME=="OpenLayers.Geometry.Point"||layerosmb.features[0].geometry.CLASS_NAME=="OpenLayers.Geometry.Polygon"||layerosmb.features[0].geometry.CLASS_NAME=="OpenLayers.Geometry.MultiPolygon")
{if(layerosmb.styleMap.styles.default.rules[tt].symbolizer.fillColor.split('rgb(')[1])
{color=layerosmb.styleMap.styles.default.rules[tt].symbolizer.fillColor;}
else{color=layerosmb.styleMap.styles.default.rules[tt].symbolizer.fillColor;}
}else{ if(layerosmb.styleMap.styles.default.rules[tt].symbolizer.fillColor.split('rgb(')[1])
{color=layerosmb.styleMap.styles.default.rules[tt].symbolizer.strokeColor;}
else{color=layerosmb.styleMap.styles.default.rules[tt].symbolizer.strokeColor;}
} } }
}
if(layerosmb.styleMap.styles.default.rules[tt].filter.type=="==")
{if(entity.properties[layerosmb.styleMap.styles.default.rules[tt].filter.property]==layerosmb.styleMap.styles.default.rules[tt].filter.value)
{if(layerosmb.features[0].geometry.CLASS_NAME=="OpenLayers.Geometry.Point"||layerosmb.features[0].geometry.CLASS_NAME=="OpenLayers.Geometry.Polygon"||layerosmb.features[0].geometry.CLASS_NAME=="OpenLayers.Geometry.MultiPolygon")
{color=layerosmb.styleMap.styles.default.rules[tt].symbolizer.fillColor;}
else{color=layerosmb.styleMap.styles.default.rules[tt].symbolizer.strokeColor;}
}  }
}
}


return color;

}
function chanNameOSMBextrude()
{
for(var i=0;i<map.layers.length;i++)
{
if(map.layers[i].name==document.getElementById("OSMBLayerNameEx_id").value)
{ document.getElementById("OSMBLayerNameExH_id").innerHTML='';for(h in map.layers[i].features[0].attributes){var t=document.createElement('option');t.value=h;t.text=h;
document.getElementById("OSMBLayerNameExH_id").appendChild(t); } }

}
}
function OK_OSMExtrudeLayerPoint(jsonstringosm,layerosmbp)
{var format = new OpenLayers.Format.GeoJSON({});
var newFeat=format.read(jsonstringosm);var multcoefSq=parseFloat(document.getElementById("dopOSMBpointjson").value);
for (var v=0;v<layerosmbp.features.length;v++)
{ var br=new OpenLayers.Bounds(layerosmbp.features[v].geometry.bounds.left, layerosmbp.features[v].geometry.bounds.bottom,layerosmbp.features[v].geometry.bounds.right,layerosmbp.features[v].geometry.bounds.top);
var lonlat=br.transform(map.getProjectionObject(),new OpenLayers.Projection("EPSG:4326"));
var pointsiz=1;
if(layerosmbp.styleMap.styles.default.rules.length==0){pointsiz=layerosmbp.styleMap.styles.default.defaultStyle.pointRadius;}
else{
for(var tt=0;tt<layerosmbp.styleMap.styles.default.rules.length;tt++)
{ 
if(layerosmbp.styleMap.styles.default.rules[tt].filter.CLASS_NAME=="OpenLayers.Filter.Comparison"&&parseFloat(layerosmbp.features[v].attributes[layerosmbp.styleMap.styles.default.rules[tt].filter.property])>=parseFloat(layerosmbp.styleMap.styles.default.rules[tt].filter.lowerBoundary)&&parseFloat(layerosmbp.features[v].attributes[layerosmbp.styleMap.styles.default.rules[tt].filter.property])<=parseFloat(layerosmbp.styleMap.styles.default.rules[tt].filter.upperBoundary)){pointsiz=layerosmbp.styleMap.styles.default.rules[tt].symbolizer.pointRadius;}
if(layerosmbp.styleMap.styles.default.rules[tt].filter.type=="==")
{if(layerosmbp.features[v].attributes[layerosmbp.styleMap.styles.default.rules[tt].filter.property]==layerosmbp.styleMap.styles.default.rules[tt].filter.value)
{pointsiz=layerosmbp.styleMap.styles.default.rules[tt].symbolizer.pointRadius;}

}
    }
}
var atrn=newFeat[v].attributes;
newFeatn=new OpenLayers.Feature.Vector(new OpenLayers.Geometry.MultiPolygon ([new OpenLayers.Geometry.Polygon.createRegularPolygon(new OpenLayers.Geometry.Point(newFeat[v].geometry.x, newFeat[v].geometry.y), pointsiz*multcoefSq, document.getElementById("dopOSMBpointjsonsides").value, 0)]));var fr=newFeatn.geometry.components[0].components[0].components; var arrpn=[];
for(var cf=fr.length-1; cf>-1;cf--){arrpn.push(fr[cf])} newFeatn.geometry.components[0].components[0].components=arrpn; 
newFeatn.attributes=atrn;
newFeat[v]=newFeatn;


}
rtt=newFeat; 
var jsonstrpoint = format.write(newFeat);
return jsonstrpoint;

}
function OK_OrderLayer()
{
var bbox = document.getElementById("map").getBoundingClientRect();
 var body = document.body
 var docElem = document.documentElement
 var scrollTop = window.pageYOffset || docElem.scrollTop || body.scrollTop
 var scrollLeft = window.pageXOffset || docElem.scrollLeft || body.scrollLeft
 var clientTop = docElem.clientTop || body.clientTop || 0
 var clientLeft = docElem.clientLeft || body.clientLeft || 0
 var topTop = bbox.top + scrollTop - clientTop
 var leftLeft = bbox.left + scrollLeft - clientLeft
var DivEditeLeg=document.createElement("div");
DivEditeLeg.id="id_divOrderLayer";
DivEditeLeg.className="id_divRoutLegMain";
DivEditeLeg.style.position="relative";
DivEditeLeg.innerHTML='<div id="id_divOrderLayerLeg" style="background:#ffffff; color:#0000ff;z-index: 6000;position:absolute;left:'+Math.round(leftLeft+50)+'px;top:'+Math.round(topTop+20)+
'px;overflow:hidden; border: 1px solid black;"><img onclick="closeOrderlayerWin()" src="openlayers/theme/default/img/close.gif" style="position:relative; top:10px;float:right; cursor:pointer"><a style="position:relative; top:20px"></a>'+
'<a style="font-size: 9px;"> вы можете перемещать это окно если щёлкните по пункту меню: /переключить режим интерфейса/</a><br><div ><textarea id="textarea_orderlayer_id" title="Названия слоёв в списке должны быть отделены точкой с запятой!!!" style="height:100px; width:200px"></textarea></div>'+
'<p> <button type=button onclick=ChangeOrderlayersOpen()>OK</button></p>'+
'</div>';

if(!document.getElementById("id_divOrderLayerLeg"))
{body.appendChild(DivEditeLeg); 

document.getElementById("id_divOrderLayer").onmousedown=function(event){drags(event)};
document.getElementById("id_divOrderLayer").onmouseup=function(e){enddrag()};
}
var layernames='';
for(var i=0;i<map.layers.length;i++)
{
if(map.layers[i].isBaseLayer==false)
{
layernames+=map.layers[i].name+';\n';
}
}
document.getElementById("textarea_orderlayer_id").value=layernames;
}
function UploadFile()
{
var htmlTextF=''; var dopStr='';
if(GlobalUN!=='')
{dopStr='<input type="checkbox" id="id_UseForAll" title="Если галочка не поставлена, то слой загрузится только в папку пользователя и будет доступен только ему." value="checkbox"/>Сделать слой общедоступным<br>';}
htmlTextF+='<a>Please select file:</a><br>'+
 '<input title="Select shapefile packed in zip format" type="file" id="file_id"><br>'+
dopStr+
'<p> <button type=button onclick=OK_file()>OK</button></p>';
popup_new_file = new OpenLayers.Popup.FramedCloud("NewFilePopup",
 map.getCenter(),
 new OpenLayers.Size(400,400),
 htmlTextF ,
 null, true, onPopupClose);
 map.addPopup(popup_new_file);
document.getElementById('file_id').addEventListener('change', readSingleFile, false);
}
function readSingleFile(evt)
{
fileZIP = evt.target.files[0]; 
rtt=document.getElementById('file_id');
}
function readSingleFileTXT(evt)
{
fileZIP = evt.target.files[0]; 
}
function readSingleFileRasterFileWeb(evt)
{fileZIP = evt.target.files[0]; 
var field=document.getElementById("id_fieldRasterFileWeb");
var  contents;
 if (fileZIP) {
 var r = new FileReader();
 r.onload = function(e) { 
 contents = e.target.result;
field.click();
field.focus();
field.value="kk";
field.value=contents;
field.focus();

      }
if(document.getElementById("selRaster_WebGIS").value=='image/tiff')
{r.readAsBinaryString(fileZIP);}
else {r.readAsText(fileZIP);}

    } else { 
      alert("Ошибка загрузки файла");
    }

}
function readSingleFileGML(evt)
{
fileZIP = evt.target.files[0]; 
}
function readSingleFileProject(evt)
{
fileZIP = evt.target.files[0]; 
}
function readSingleFileKML(evt)
{
fileZIP = evt.target.files[0]; 
}
function readSingleFileAsc(evt)
{
fileZIP = evt.target.files[0]; 
rtt=document.getElementById('file_id');
}
function readSingleFileTiff(evt)
{
fileZIP = evt.target.files[0];

}
function readSingleFileImage(evt)
{
fileZIP = evt.target.files[0]; 
}

function New_LayerImage()
{
var bbox = document.getElementById("map").getBoundingClientRect();
 var body = document.body
 var docElem = document.documentElement
 var scrollTop = window.pageYOffset || docElem.scrollTop || body.scrollTop
 var scrollLeft = window.pageXOffset || docElem.scrollLeft || body.scrollLeft
 var clientTop = docElem.clientTop || body.clientTop || 0
 var clientLeft = docElem.clientLeft || body.clientLeft || 0
 var topTop = bbox.top + scrollTop - clientTop
 var leftLeft = bbox.left + scrollLeft - clientLeft
var DivEditeLeg=document.createElement("div");
DivEditeLeg.id="id_divImageFileLegMain2";
DivEditeLeg.className="id_divRoutLegMain";
DivEditeLeg.style.position="relative";
DivEditeLeg.innerHTML='<div id="id_divImageFileLeg" style="background:#ffffff; color:#0000ff;z-index: 6000;position:absolute;left:'+Math.round(leftLeft+50)+'px;top:'+Math.round(topTop-120)+
'px;overflow:hidden; border: 1px solid black;"><img onclick="closeImageFileWin()" src="openlayers/theme/default/img/close.gif" style="position:relative; top:10px;float:right; cursor:pointer"><a style="position:relative; top:20px"></a>'+
'<a style="font-size: 9px;"> Вы можете перемещать это окно,если щёлкните по пункту меню Интерфейс/переключить режим интерфейса/</a><br>'+
'<a>выберите файл изображения:</a><br>'+
 '<input title="Select image file" type="file" id="file_idImage"><br>'+
'<input title="координата нижнего левого угла. Вы можете щёлкнуть по карте или ввести координаты сами. Координаты вводятся после клика по карте, если в этом поле указан ноль или пусто." type="text" size="8" id="first_long" value="0"/>нижняя левая долгота. Вы можете щёлкнуть по карте<br>'+
'<input title="координата нижнего левого угла" type="text" size="8" id="first_lat" value="0"/>нижняя левая широта<br>'+
'<input title="координата верхнего правого угла. Вы можете щёлкнуть по карте или ввести координаты сами. Координаты вводятся после клика по карте, если в этом поле указан ноль или пусто." type="text" size="8" id="sec_long" value="0"/>верхняя правая долгота<br>'+
'<input title="координата верхнего правого угла" type="text" size="8" id="sec_lat" value="0"/>верхняя правая широта<br>'+
'<p> <button type=button onclick=OK_fileImage()>OK</button></p>';
if(!document.getElementById("id_divImageFileLeg"))
{body.appendChild(DivEditeLeg); 
OpenLayers.Control.Click = OpenLayers.Class(OpenLayers.Control, {                
defaultHandlerOptions: {'single': true,'double': false,'pixelTolerance': 0,'stopSingle': false,'stopDouble': false},
initialize: function(options) {
this.handlerOptions = OpenLayers.Util.extend(
{}, this.defaultHandlerOptions);
OpenLayers.Control.prototype.initialize.apply(
this, arguments); 
this.handler = new OpenLayers.Handler.Click(
                        this, {'click': this.trigger}, this.handlerOptions
                    );
                }, 
trigger: function(e) {
var lonlat = map.getLonLatFromPixel(e.xy);
var new_pos=new OpenLayers.LonLat(lonlat.lon,lonlat.lat).transform(
map.getProjectionObject(),new OpenLayers.Projection("EPSG:4326"));
if(document.getElementById("file_idImage")&&document.getElementById("first_long"))
{if(document.getElementById("first_long").value==''||document.getElementById("first_long").value=='0')
{document.getElementById("first_long").value=new_pos.lon;
document.getElementById("first_lat").value=new_pos.lat;}
else{
if(document.getElementById("sec_long").value==''||document.getElementById("sec_long").value=='0')
{document.getElementById("sec_long").value=new_pos.lon;
document.getElementById("sec_lat").value=new_pos.lat;}}
}

    }

});
var clickImageCoordinates = new OpenLayers.Control.Click();
clickImageCoordinates.title="click to get coordinates of ImageLayer";
 map.addControl(clickImageCoordinates);
clickImageCoordinates.activate();

document.getElementById("id_divImageFileLegMain2").onmousedown=function(event){drags(event)};
document.getElementById("id_divImageFileLegMain2").onmouseup=function(e){enddrag()};
}
document.getElementById('file_idImage').addEventListener('change', readSingleFileImage, false);
}
function OK_BoundImage2()
{
var first_long=parseFloat(document.getElementById("first_long2").value);
var first_lat=parseFloat(document.getElementById("first_lat2").value);
var sec_long=parseFloat(document.getElementById("sec_long2").value);
var sec_lat=parseFloat(document.getElementById("sec_lat2").value);
var boundImage=new OpenLayers.Bounds(first_long, first_lat, sec_long, sec_lat)
 boundImage.transform(new OpenLayers.Projection("EPSG:4326"), map.getProjectionObject());
for(var i=0;i<map.layers.length;i++)
{
if(map.layers[i].name==document.getElementById("ImageLayerBound_id").value)
{map.layers[i].extent=boundImage;map.layers[i].redraw();
if(map.layers[i].CLASS_NAME=="OpenLayers.Layer.Image"){map.layers[i].div.childNodes[0].style.display="block";}
}
}
}
function ChangeBoundImageSel()
{
for(var i=0;i<map.layers.length;i++)
{
if(map.layers[i].name==document.getElementById("ImageLayerBound_id").value)
{var oldBoundImage=map.layers[i].extent.clone();
oldBoundImage.transform(map.getProjectionObject(),new OpenLayers.Projection("EPSG:4326"));
rtt=oldBoundImage;
document.getElementById("first_long2").value=oldBoundImage.left;
document.getElementById("first_lat2").value=oldBoundImage.bottom;
document.getElementById("sec_long2").value=oldBoundImage.right;
document.getElementById("sec_lat2").value=oldBoundImage.top;
}
}
}
function OK_ImageAnalysis()
{
var bbox = document.getElementById("map").getBoundingClientRect();
 var body = document.body
 var docElem = document.documentElement
 var scrollTop = window.pageYOffset || docElem.scrollTop || body.scrollTop
 var scrollLeft = window.pageXOffset || docElem.scrollLeft || body.scrollLeft
 var clientTop = docElem.clientTop || body.clientTop || 0
 var clientLeft = docElem.clientLeft || body.clientLeft || 0
 var topTop = bbox.top + scrollTop - clientTop
 var leftLeft = bbox.left + scrollLeft - clientLeft
var DivEditeLeg=document.createElement("div");
DivEditeLeg.id="id_divImageAnalys";
DivEditeLeg.className="id_divRoutLegMain";
DivEditeLeg.style.position="relative";
//DivEditeLeg.onmouseup="enddrag()";DivEditeLeg.onmousedown="drags(event)"
DivEditeLeg.innerHTML='<div id="id_divImageAnalys2" style="background:#ffffff; color:#0000ff;z-index: 6000;position:absolute;left:'+Math.round(leftLeft+50)+'px;top:'+Math.round(topTop-150)+
'px;overflow:hidden; border: 1px solid black;"><img onclick="closeAnalysImageWin()" src="openlayers/theme/default/img/close.gif" style="position:relative; top:10px;float:right; cursor:pointer"><a style="position:relative; top:20px"></a>'+
'<a style="font-size: 9px;"> Вы можете перемещать это окно,</a><a style="font-size: 9px;">если щёлкните по пункту меню Интерфейс/переключить режим интерфейса</a><br>'+'<div id="id_waitImageAn"></div>'+
'Выберите слой с изображением: <select id="ImageLayerAnalys_id" >.'+
 '<option selected value="0">.</option>'+
'</select><br><a title="Идентифицирйте объекты (дороги, леса, здания, и т.п.) на изображении(картинке) " href="https://ru.wikipedia.org/wiki/%D0%92%D1%8B%D0%B4%D0%B5%D0%BB%D0%B5%D0%BD%D0%B8%D0%B5_%D0%B3%D1%80%D0%B0%D0%BD%D0%B8%D1%86" target="_blank" style="font-size: 11px;">Сегментируйте слой с изображением по цвету:</a><br>'+ 
'<a href="https://ru.wikipedia.org/wiki/RGB" target="_blank">Интервал цветов:</a><input title="Введите число для получения интервала цветов (в формате RGB) для сегментирования слоя с Изображением(фото, спутникового снимок).&#013; Например, если цвет интересующих вас точек имеет  значения красного, зеленого и синего каналов, равные 230, и вы ввели в это поле 10, то тогда набор цветов, который будет анализироваться при сегментации, будет лежать в интервале от 220 до 240. &#013; Для того чтобы увидеть этот интервал цветов перед анализом, нажмите кнопку /обновить/." type="text" id="VectorIm_colInt_id" value="10" size=3>'+'<button type=button onclick=OK_ImageColorAnalysRefresh()>обновить</button>'+
'<div id="id_coloaddIm" title="Щёлкните по изображению и цвет точки, по которой вы щёлкнули, появится в этом квадрате. Изображение будет сегментировано по этому цвету" style="background:#ffffff; width:20px; height:20px; border: solid 1px black;"></div><div id="id_coloaddIm2" ></div><br>'+
'<input type="checkbox" id="id_checkCoordImAn" title="" value="checkbox"/><a style="font-size: 12px;">Анализировать прямоугольную область</a><br>'+
'<input title="координата нижнего левого угла прямогуольной области. Вы можете ввести координаты вручную или щёлкнуть по карте. Координаты вводятся щелчком по карте, если в этом поле ноль или пусто" type="text" size="5" id="first_longIm" value="0"/><a style="font-size: 11px;">нижняя левая долгота, вы можете щёлкнуть по карте</a>'+
'<input title="координата нижнего левого угла" type="text" size="5" id="first_latIm" value="0"/><a style="font-size: 11px;">нижняя левая широта</a><br>'+
'<input title="Координаты верхнего правого угла прямогуольной области. Вы можете ввести координаты вручную или щёлкнуть по карте. Координаты вводятся щелчком по карте, если в этом поле ноль или пусто" type="text" size="5" id="sec_longIm" value="0"/><a style="font-size: 11px;">верхняя правая долгота</a>'+
'<input title="координата верхнего правого угла" type="text" size="5" id="sec_latIm" value="0"/><a style="font-size: 11px;">верхняя правая широта</a><br>'+
'Выберите тип результата: <select id="ImageLayerAnalysRes_id" >.'+
 '<option selected value="convexpolygon">выпуклые полигоны</option>'+
'<option value="polygon">полигоны</option>'+
'<option value="point">точки</option>'+
'<option value="convexline">выпуклые линии</option>'+
'<option value="line">линии</option>'+
'</select><br>'+ '<a> соседство точек:</a><input title="Точки, расстояние между которыми не превышает указанной вами величины, будут объединяться в один полигон или линию " type="text" id="VectorIm_vicinity_id" value="3" size=3>пикселей<br>'+
'<a>Название слоя:</a><input title="название векторного слоя с результатами сегментации" type="text" id="VectorIm_layer_name_id" value="ImageVector" size=15>'+
'<a> или добавить результаты к:</a><select id="AddVectorIm_layer_name_id" >'+ '<option selected value="0">.</option>'+'</select><br>'+ 
'<p> <button id="id_but_ImageAn" type=button onclick=OK_ImageAnalys2()>OK - сегментировать</button></p>'+
'Методы выделения границ: <select title="Методы выделения границ изображения" id="ImageEdgAnalys_id" >.'+
 '<option selected value="Roberts">Робертса</option>'+
'<option value="Sobel">Собеля</option>'+
'</select>'+'<a> коэфф:</a><input type="text" id="AddCoefEdg_id" title="Добавочный коэффициент, чем он больше, тем больше границ может быть выделено, но тем ярче(белее) будет  фон" value="0" size=3>'+
'<button type=button onclick=OK_ImageEdgeAnalys()>получить границы</button><br>'+ 
'<button title="Инвертировать цвета изображения" type=button onclick=OK_ImageInvertColor()>Инвертировать</button><button title="преобразовать цвета изображения в оттенки серого" type=button onclick=OK_ImageGrayColor()>оттенки серого</button><br>'+
'<button type=button onclick=OK_ImageBinariAnalys()>Бинаризация</button><a>порог:</a><input type="text" id="VectorIm_layer_Threshold_id" value="100" size=5><button type=button onclick=OK_ImageSharpenAnalys()>Резкость</button><a><a>порог:</a><input type="text" id="VectorIm_layer_Threshold_id2" value="10" size=5><br>'+
'<button title="Отмена только последней операции" type=button onclick=OK_ImageEdgeAnalysUnDo()>отменить</button><br>'+
'</div>';

if(!document.getElementById("id_divImageAnalys"))
{body.appendChild(DivEditeLeg); 
document.getElementById("id_divImageAnalys").onmousedown=function(event){drags(event)};
document.getElementById("id_divImageAnalys").onmouseup=function(e){enddrag()};

for(var i=0;i<map.layers.length;i++)
{
if(map.layers[i].CLASS_NAME=="OpenLayers.Layer.Vector")
{var t=this.document.createElement('option');t.value=map.layers[i].name;t.text=map.layers[i].name;document.getElementById("AddVectorIm_layer_name_id").appendChild(t);}}

OpenLayers.Control.Click = OpenLayers.Class(OpenLayers.Control, {                
defaultHandlerOptions: {'single': true,'double': false,'pixelTolerance': 0,'stopSingle': false,'stopDouble': false},
initialize: function(options) {
this.handlerOptions = OpenLayers.Util.extend(
{}, this.defaultHandlerOptions);OpenLayers.Control.prototype.initialize.apply(this, arguments); 
this.handler = new OpenLayers.Handler.Click( this, {'click': this.trigger}, this.handlerOptions );                }, 
trigger: function(e) {if(document.getElementById("ImageLayerAnalys_id").value=='0'){alert("Выберите название слоя"); return;}
var lonlat = map.getLonLatFromPixel(e.xy);
var new_pos=new OpenLayers.LonLat(lonlat.lon,lonlat.lat).transform(
map.getProjectionObject(),new OpenLayers.Projection("EPSG:4326")); 
var idDiv=''
for(var i=0;i<map.layers.length;i++)
{if(document.getElementById("ImageLayerAnalys_id").value=='0'){alert("Выберите название слоя"); return;}
if(map.layers[i].name==document.getElementById("ImageLayerAnalys_id").value)
{idDiv=map.layers[i].div.children[0].children[0].id;
var DivobjA=document.getElementById(idDiv);
var bbox = DivobjA.getBoundingClientRect();
 var body = document.body;
 var docElem = document.documentElement;
 var scrollTop = window.pageYOffset || docElem.scrollTop || body.scrollTop;
 var scrollLeft = window.pageXOffset || docElem.scrollLeft || body.scrollLeft;
 var clientTop = docElem.clientTop || body.clientTop || 0;
 var clientLeft = docElem.clientLeft || body.clientLeft || 0;
 var topTop = bbox.top + scrollTop - clientTop;
 var leftLeft = bbox.left + scrollLeft - clientLeft;

var bbox2 = map.div.getBoundingClientRect();
 var body = document.body;
 var docElem2 = document.documentElement;
 var scrollTop2 = window.pageYOffset || docElem.scrollTop || body.scrollTop;
 var scrollLeft2 = window.pageXOffset || docElem.scrollLeft || body.scrollLeft;
 var clientTop2 = docElem.clientTop || body.clientTop || 0;
 var clientLeft2 = docElem.clientLeft || body.clientLeft || 0;
 var topTop2 = bbox2.top + scrollTop2 - clientTop2;
 var leftLeft2 = bbox2.left + scrollLeft2 - clientLeft2;

//var yIm=Math.abs(topTop-e.xy.y-topTop2);
var yIm=Math.abs(e.xy.y+topTop2-topTop);
var xIm=Math.abs(e.xy.x+leftLeft2-leftLeft);
//rtt=leftLeft; alert("1"); rtt=e.xy.x; alert("2");rtt=leftLeft2; alert("3");
var img = new Image(); img.src=map.layers[i].url; var lay=map.layers[i];
img.onload=function(lay,yIm,xIm){var can00=document.createElement("canvas");
can00.width=lay.tileSize.w;can00.height=lay.tileSize.h;
var ctx00 = can00.getContext("2d");ctx00.drawImage(img, 0, 0,lay.tileSize.w,lay.tileSize.h);
try{var imageData = ctx00.getImageData(xIm,yIm,1,1);}catch(e){alert(e);return;}
document.getElementById("id_coloaddIm").style.background="rgba("+imageData.data[0]+","+imageData.data[1]+","+imageData.data[2]+","+"1)";
//rtt=[imageData.data[0],imageData.data[1],imageData.data[2]]; alert("ghh00000000");
}(lay,yIm,xIm)
} 

} }

});

var clickImageAnalys=new OpenLayers.Control.Click();
clickImageAnalys.title="control for image analys";
 map.addControl(clickImageAnalys);
clickImageAnalys.activate();
///////////////
OpenLayers.Control.Click = OpenLayers.Class(OpenLayers.Control, {                
defaultHandlerOptions: {'single': true,'double': false,'pixelTolerance': 0,'stopSingle': false,'stopDouble': false},
initialize: function(options) {this.handlerOptions = OpenLayers.Util.extend(
{}, this.defaultHandlerOptions);OpenLayers.Control.prototype.initialize.apply(
this, arguments); 
this.handler = new OpenLayers.Handler.Click( this, {'click': this.trigger}, this.handlerOptions );    }, 
trigger: function(e) {if(document.getElementById("id_checkCoordImAn")){if(document.getElementById("id_checkCoordImAn").checked==true){
var lonlat = map.getLonLatFromPixel(e.xy);var new_pos=new OpenLayers.LonLat(lonlat.lon,lonlat.lat).transform(
map.getProjectionObject(),new OpenLayers.Projection("EPSG:4326"));
if(document.getElementById("first_longIm"))
{if(document.getElementById("first_longIm").value==''||document.getElementById("first_longIm").value=='0')
{document.getElementById("first_longIm").value=new_pos.lon;
document.getElementById("first_latIm").value=new_pos.lat;}
else{if(document.getElementById("sec_longIm").value==''||document.getElementById("sec_longIm").value=='0')
{document.getElementById("sec_longIm").value=new_pos.lon;document.getElementById("sec_latIm").value=new_pos.lat;}}
}   }}}
});
var clickImageAnCoordinates2 = new OpenLayers.Control.Click();clickImageAnCoordinates2.title="click to get coordinates for ImageAnalyse";
 map.addControl(clickImageAnCoordinates2);clickImageAnCoordinates2.activate();
/////////////////////////////////////

for(var i=0;i<map.layers.length;i++)
{ if(map.layers[i].CLASS_NAME=="OpenLayers.Layer.Image")
{
var t=document.createElement('option');t.value=map.layers[i].name;t.text=map.layers[i].name;
document.getElementById("ImageLayerAnalys_id").appendChild(t);}
}}
}
function OK_ImageColorAnalysRefresh()
{for(var i=0;i<document.getElementById('id_coloaddIm2').children.length;i++){document.getElementById('id_coloaddIm2').removeChild(document.getElementById('id_coloaddIm2').children[i]);i--;}
var imcolor=document.getElementById("id_coloaddIm").style.backgroundColor;
imcolor=imcolor.split("rgb(")[1].split(")")[0];
imcolor=imcolor.split(",");imcolor[0]=parseInt(imcolor[0]);imcolor[1]=parseInt(imcolor[1]);imcolor[2]=parseInt(imcolor[2]);
var pr=(-1)*parseInt(document.getElementById("VectorIm_colInt_id").value);
while(pr!==Math.abs(pr))
{var c1m=imcolor[0]+pr;var c2m=imcolor[1]+pr;var c3m=imcolor[2]+pr;
var nd=document.createElement("div");nd.style.width=2;nd.style.height=20;nd.style.background="rgba("+c1m+","+c2m+","+c3m+","+"1)";nd.style.cssFloat="left";
document.getElementById("id_coloaddIm2").appendChild(nd);pr++;
}
}
function OK_ExtrudeImage()
{
var bbox = document.getElementById("map").getBoundingClientRect();
 var body = document.body; var docElem = document.documentElement; var scrollTop = window.pageYOffset || docElem.scrollTop || body.scrollTop
 var scrollLeft = window.pageXOffset || docElem.scrollLeft || body.scrollLeft; var clientTop = docElem.clientTop || body.clientTop || 0
 var clientLeft = docElem.clientLeft || body.clientLeft || 0; var topTop = bbox.top + scrollTop - clientTop
 var leftLeft = bbox.left + scrollLeft - clientLeft;var DivEditeLeg=document.createElement("div");
DivEditeLeg.id="id_divImageExtrMain2";
DivEditeLeg.className="id_divRoutLegMain";
DivEditeLeg.style.position="relative";
//DivEditeLeg.onmouseup="enddrag()";DivEditeLeg.onmousedown="drags(event)"
DivEditeLeg.innerHTML='<div id="id_divImageExtrLeg" style="background:#ffffff; color:#0000ff;z-index: 6000;position:absolute;left:'+Math.round(leftLeft+50)+'px;top:'+Math.round(topTop-80)+
'px;overflow:hidden; border: 1px solid black;"><img onclick="closeExtrude25ImageWin()" src="openlayers/theme/default/img/close.gif" style="position:relative; top:10px;float:right; cursor:pointer"><a style="position:relative; top:20px"></a><br>'+
'<a style="font-size: 9px;"> you can move this window,</a><a style="font-size: 9px;"> if you select menu item Interface/switch to interface drag</a><br>'+
'Select Image Layer: <select id="ImageLayerExtr25_id" >.'+
 '<option selected value="0">.</option></select><br>'+
 
 '<input type="checkbox" id="id_checkCoordImAn25" title="" value="checkbox"/><a style="font-size: 12px;">Analyse rectangle region</a><br>'+
'<input title="coordinate of the lower left corner.You can click on the map or type manually. Coordinates are inserted after clicking on the map if this value is equal to zero or empty" type="text" size="5" id="first_long25" value="0"/><a style="font-size: 11px;">lower left longitude, you can click on the map</a>'+
'<input title="coordinate of the lower left corner" type="text" size="5" id="first_lat25" value="0"/><a style="font-size: 11px;">lower left latitude</a><br>'+
'<input title="coordinate of the upper-right corner.You can click on the map or type manually. Coordinates are inserted after clicking on the map if this value is equal to zero or empty" type="text" size="5" id="sec_long25" value="0"/><a style="font-size: 11px;">upper right longitude</a>'+
'<input title="coordinate of the upper-right corner" type="text" size="5" id="sec_lat25" value="0"/><a style="font-size: 11px;">upper right latitude</a><br>'+
 
 'create Vector Layer<input type="checkbox" id="VectorExtr25_id" value="true" checked/><a>Layer Name:</a><input type="text" size="15" id="VectorExtr25ln_id" value="ImageExtrude"/>create color legend:<input type="checkbox" id="VectorExtr25Leg_id" value="false" /><br>'+
 'create 2.5D Layer<input type="checkbox" id="VectorExtr25d_id" value="true" checked/><a>Layer Name:</a><input type="text" size="15" id="VectorExtr25lnd_id" value="2_5DExtrude"/><br>'+
 'size of polygons<input type="text" size="15" id="sizeExtr25lnd_id" value="0.5"/><br>'+
 '<a>set Height&nbsp;&nbsp;&nbsp;from:</a><input type="text" size="5" id="VectorExtr25H1_id" value="0"/>to:<input type="text" size="5" id="VectorExtr25H2_id" value="100000"/>meters<br>'+
'<a>set Altitude from:</a><input type="text" size="5" id="VectorExtr25A1_id" value="0"/>to:<input type="text" size="5" id="VectorExtr25A2_id" value="100000"/>meters<br>'+
 'invert luminance<input type="checkbox" id="VectorExtr25inv_id" value="true" /><br>'+
'<a>step by:</a><input type="text" size="3" id="VectorExtr25px_id" value="1"/>pixels'+'<a>.&nbsp;&nbsp;precision:</a><input type="text" title="The number of digits after the decimal point" size="3" id="VectorExtr25pres_id" value="4"/>digits<br>'+
'attribute for color legend: <select id="ImageLayerExtrAttr_id" >.'+
 '<option selected value="height">height</option><option value="altitude">altitude</option><option value="roofColor">roofColor</option><option value="color">color</option><option value="luminance">luminance</option>'+
 '<option value="lon_cent">lon_cent</option><option value="lat_cent">lat_cent</option></select>'+
 '<p> <button type=button onclick=OK_ImageAnalys25D()>OK-extrude</button></p>';
'</div>';
if(!document.getElementById("id_divImageExtrMain2"))
{body.appendChild(DivEditeLeg); }
document.getElementById("id_divImageExtrMain2").onmousedown=function(event){drags(event)};document.getElementById("id_divImageExtrMain2").onmouseup=function(e){enddrag()};


///////////////
OpenLayers.Control.Click = OpenLayers.Class(OpenLayers.Control, {                
defaultHandlerOptions: {'single': true,'double': false,'pixelTolerance': 0,'stopSingle': false,'stopDouble': false},
initialize: function(options) {this.handlerOptions = OpenLayers.Util.extend(
{}, this.defaultHandlerOptions);OpenLayers.Control.prototype.initialize.apply(
this, arguments); 
this.handler = new OpenLayers.Handler.Click( this, {'click': this.trigger}, this.handlerOptions );    }, 
trigger: function(e) {if(document.getElementById("id_checkCoordImAn25")){if(document.getElementById("id_checkCoordImAn25").checked==true){
var lonlat = map.getLonLatFromPixel(e.xy);var new_pos=new OpenLayers.LonLat(lonlat.lon,lonlat.lat).transform(
map.getProjectionObject(),new OpenLayers.Projection("EPSG:4326"));
if(document.getElementById("first_long25"))
{if(document.getElementById("first_long25").value==''||document.getElementById("first_long25").value=='0')
{document.getElementById("first_long25").value=new_pos.lon;
document.getElementById("first_lat25").value=new_pos.lat;}
else{if(document.getElementById("sec_long25").value==''||document.getElementById("sec_long25").value=='0')
{document.getElementById("sec_long25").value=new_pos.lon;document.getElementById("sec_lat25").value=new_pos.lat;}}
}   }}}
});
var clickImageAnalys25=new OpenLayers.Control.Click();
clickImageAnalys25.title="control for image extrude";
 map.addControl(clickImageAnalys25);
clickImageAnalys25.activate();
for(var i=0;i<map.layers.length;i++)
{
if(map.layers[i].CLASS_NAME=="OpenLayers.Layer.Image")
{var t=document.createElement('option');t.value=map.layers[i].name;t.text=map.layers[i].name;
document.getElementById("ImageLayerExtr25_id").appendChild(t);}
}

}
function OK_ImageAnalys25D()
{
for(var i=0;i<map.layers.length;i++)
{
if(map.layers[i].name==document.getElementById("ImageLayerExtr25_id").value)
{
var img = new Image(); img.src=map.layers[i].url; var lay=map.layers[i];
img.onload=function(lay){var can00=document.createElement("canvas");
can00.width=lay.tileSize.w;can00.height=lay.tileSize.h;
var ctx00 = can00.getContext("2d");ctx00.drawImage(img, 0, 0,lay.tileSize.w,lay.tileSize.h);
var idDiv=lay.div.children[0].children[0].id;
var DivobjA=document.getElementById(idDiv);var bbox = DivobjA.getBoundingClientRect();
var body = document.body; var docElem = document.documentElement; var scrollTop = window.pageYOffset || docElem.scrollTop || body.scrollTop;
 var scrollLeft = window.pageXOffset || docElem.scrollLeft || body.scrollLeft; var clientTop = docElem.clientTop || body.clientTop || 0; var clientLeft = docElem.clientLeft || body.clientLeft || 0;
 var topTop = bbox.top + scrollTop - clientTop; var leftLeft = bbox.left + scrollLeft - clientLeft;
var bbox2 = map.div.getBoundingClientRect();
 var body = document.body; var docElem2 = document.documentElement; var scrollTop2 = window.pageYOffset || docElem.scrollTop || body.scrollTop;
 var scrollLeft2 = window.pageXOffset || docElem.scrollLeft || body.scrollLeft; var clientTop2 = docElem.clientTop || body.clientTop || 0; var clientLeft2 = docElem.clientLeft || body.clientLeft || 0;
 var topTop2 = bbox2.top + scrollTop2 - clientTop2; var leftLeft2 = bbox2.left + scrollLeft2 - clientLeft2;
 var imageData2 = ctx00.getImageData(0,0,1,1);
 var minDistC = 0.299*imageData2.data[0]+0.587*imageData2.data[1]+0.114*imageData2.data[2]; var maxDistC = parseFloat(minDistC) ; var arris=[];
 
 var first_long=parseFloat(document.getElementById("first_long25").value);var first_lat=parseFloat(document.getElementById("first_lat25").value);
var sec_long=parseFloat(document.getElementById("sec_long25").value);var sec_lat=parseFloat(document.getElementById("sec_lat25").value);
var boundImage=new OpenLayers.Bounds(first_long, first_lat, sec_long, sec_lat); boundImage.transform(new OpenLayers.Projection("EPSG:4326"), map.getProjectionObject());

 var addpx=parseFloat(document.getElementById("VectorExtr25px_id").value);
var imageData2 = ctx00.getImageData(0,0,can00.width,can00.height);var iD=imageData2;
 for(var h=0;h<can00.height;h=h+addpx)
{for(var w=0;w<can00.width;w=w+addpx)
{
if(document.getElementById("id_checkCoordImAn25").checked==true)
{var xn=leftLeft-leftLeft2+w;var yn=topTop-topTop2+h;
var ext1 = new OpenLayers.Pixel(xn, yn);var new_pos = map.getLonLatFromPixel(ext1);
var new_lon=new_pos.lon; var new_lat=new_pos.lat;
if(boundImage.left<=new_lon&&boundImage.right>=new_lon&&boundImage.bottom<=new_lat&&boundImage.top>=new_lat)
 {

var is1=0.299*iD.data[((h*(iD.width*4)) + (w*4)) + 0]+0.587*iD.data[((h*(iD.width*4)) + (w*4)) + 1]+0.114*iD.data[((h*(iD.width*4)) + (w*4)) + 2];
var xn=leftLeft-leftLeft2+w;var yn=topTop-topTop2+h;
 var NumSS=is1;arris.push([is1,xn,yn,iD.data[((h*(iD.width*4)) + (w*4)) + 0],iD.data[((h*(iD.width*4)) + (w*4)) + 1],iD.data[((h*(iD.width*4)) + (w*4)) + 2]])
 if (NumSS>parseFloat(maxDistC) ) {maxDistC = parseFloat(NumSS);}
 if( NumSS<parseFloat(minDistC) ) {minDistC = parseFloat(NumSS);}
   }
 }
 else
 {
var is1=0.299*iD.data[((h*(iD.width*4)) + (w*4)) + 0]+0.587*iD.data[((h*(iD.width*4)) + (w*4)) + 1]+0.114*iD.data[((h*(iD.width*4)) + (w*4)) + 2];
var xn=leftLeft-leftLeft2+w;var yn=topTop-topTop2+h;
 var NumSS=is1;arris.push([is1,xn,yn,iD.data[((h*(iD.width*4)) + (w*4)) + 0],iD.data[((h*(iD.width*4)) + (w*4)) + 1],iD.data[((h*(iD.width*4)) + (w*4)) + 2]])
 if (NumSS>parseFloat(maxDistC) ) {maxDistC = parseFloat(NumSS);}
 if( NumSS<parseFloat(minDistC) ) {minDistC = parseFloat(NumSS);}
 
 }
 } }
 var arrFeatjs=[]; var arrRuls=[];var spx=parseFloat(document.getElementById("sizeExtr25lnd_id").value);var minH=parseFloat(document.getElementById("VectorExtr25H1_id").value);
var presDig=parseInt(document.getElementById("VectorExtr25pres_id").value); var legAttr=document.getElementById("ImageLayerExtrAttr_id").value;
 var maxH=parseFloat(document.getElementById("VectorExtr25H2_id").value);var minA=parseFloat(document.getElementById("VectorExtr25A1_id").value);var maxA=parseFloat(document.getElementById("VectorExtr25A2_id").value);
var opac=map.layers[i].opacity;if (opac==null){opac=1;};
 for (var t=0;t<arris.length;t++)
 {var xnl1=map.getLonLatFromPixel(new OpenLayers.Pixel(arris[t][1]-spx,arris[t][2])).lon;var ynl1=map.getLonLatFromPixel(new OpenLayers.Pixel(arris[t][1],arris[t][2]+spx)).lat;var p1=new OpenLayers.Geometry.Point(xnl1, ynl1);
 var xnl2=map.getLonLatFromPixel(new OpenLayers.Pixel(arris[t][1]-spx,arris[t][2])).lon;var ynl2=map.getLonLatFromPixel(new OpenLayers.Pixel(arris[t][1],arris[t][2]-spx)).lat;var p2=new OpenLayers.Geometry.Point(xnl2, ynl2);
 var xnl3=map.getLonLatFromPixel(new OpenLayers.Pixel(arris[t][1]+spx,arris[t][2])).lon;var ynl3=map.getLonLatFromPixel(new OpenLayers.Pixel(arris[t][1],arris[t][2]-spx)).lat;var p3=new OpenLayers.Geometry.Point(xnl3, ynl3);
 var xnl4=map.getLonLatFromPixel(new OpenLayers.Pixel(arris[t][1]+spx,arris[t][2])).lon;var ynl4=map.getLonLatFromPixel(new OpenLayers.Pixel(arris[t][1],arris[t][2]+spx)).lat;var p4=new OpenLayers.Geometry.Point(xnl4, ynl4);
var xyCen=map.getLonLatFromPixel(new OpenLayers.Pixel(arris[t][1],arris[t][2]));xyCen.transform(map.getProjectionObject(),new OpenLayers.Projection("EPSG:4326"));
 var newFeatn=new OpenLayers.Feature.Vector(new OpenLayers.Geometry.MultiPolygon ([new OpenLayers.Geometry.Polygon([new OpenLayers.Geometry.LinearRing([p1,p2,p3,p4]) ]) ] ) );
  if(document.getElementById("VectorExtr25inv_id").checked==false)
  {var scale = ((Math.abs(arris[t][0]-minH)*(maxH-minH))/(maxDistC-minDistC))+minH;var scale2 = (((arris[t][0]-minA)*(maxA-minA))/(maxDistC-minDistC))+minA;}
  else
  {var xarr=maxDistC-arris[t][0];var scale = ((Math.abs(xarr-minH)*(maxH-minH))/(maxDistC-minDistC))+minH;var scale2 = (((xarr-minA)*(maxA-minA))/(maxDistC-minDistC))+minA;}
 newFeatn.attributes["height"]=parseFloat(scale.toFixed(presDig));newFeatn.attributes["altitude"]=parseFloat(scale2.toFixed(presDig));  newFeatn.attributes["color"]="rgb("+arris[t][3]+","+arris[t][4]+","+arris[t][5]+")";
newFeatn.attributes["roofColor"]="rgb("+arris[t][3]+","+arris[t][4]+","+arris[t][5]+")";
  newFeatn.attributes["luminance"]=parseFloat(arris[t][0].toFixed(presDig));newFeatn.attributes["lon_cent"]=parseFloat(xyCen.lon.toFixed(presDig));newFeatn.attributes["lat_cent"]=parseFloat(xyCen.lat.toFixed(presDig));
 arrFeatjs.push(newFeatn);
if(document.getElementById("VectorExtr25Leg_id").checked==true)
 {var valAttr='';
 if(legAttr=="height"){valAttr=parseFloat(scale.toFixed(presDig))};if(legAttr=="altitude"){valAttr=parseFloat(scale2.toFixed(presDig));};
 if(legAttr=="color"||legAttr=="roofColor"){valAttr="rgb("+arris[t][3]+","+arris[t][4]+","+arris[t][5]+")";}
  if(legAttr=="luminance"){valAttr=parseFloat(arris[t][0].toFixed(presDig));};if(legAttr=="lon_cent"){valAttr=parseFloat(xyCen.lon.toFixed(presDig));};if(legAttr=="lat_cent"){valAttr=parseFloat(xyCen.lat.toFixed(presDig));};
 var rulesIm= new OpenLayers.Rule({ title: "img_rul", filter: new OpenLayers.Filter.Comparison({
 type: OpenLayers.Filter.Comparison.EQUAL_TO, property: legAttr, value:valAttr }),
 symbolizer: { pointRadius: 1, fillOpacity:opac,strokeOpacity:opac, fillColor: "rgb("+arris[t][3]+","+arris[t][4]+","+arris[t][5]+")",
 strokeColor: "rgb("+arris[t][3]+","+arris[t][4]+","+arris[t][5]+")", strokeWidth: 1,label:"" } });
 arrRuls.push(rulesIm);}
 }
 if (document.getElementById("VectorExtr25_id").checked==true)
 {var new_layer_imagep = new OpenLayers.Layer.Vector(document.getElementById("VectorExtr25ln_id").value,{renderers:["Canvas", "SVG", "VML"]});
 var t=this.document.createElement('option');t.value=new_layer_imagep.name;t.text=new_layer_imagep.name;this.document.getElementById("editL1").appendChild(t);
 new_layer_imagep.addFeatures(arrFeatjs); 
if(document.getElementById("VectorExtr25Leg_id").checked==true){ for (var iu=0;iu<=arrRuls.length-1;++iu)
{new_layer_imagep.styleMap.styles.default.addRules([arrRuls[iu]]);} }
else
{var new_stlayer= new OpenLayers.Style({pointRadius: 3, fillColor: "#FF0000", strokeColor: "#ee9900", strokeWidth: 1,fillOpacity:0.4, strokeOpacity:0.6 });
new_layer_imagep.styleMap.styles.default=new_stlayer;}
new_layer_imagep.opacity=opac;
 map.addLayer(new_layer_imagep); }
 if (document.getElementById("VectorExtr25d_id").checked==true)
 {var format = new OpenLayers.Format.GeoJSON({ 'internalProjection': new OpenLayers.Projection("EPSG:900913"),'externalProjection': new OpenLayers.Projection("EPSG:4326")});
 var jsonstringosmn = format.write(arrFeatjs);
 var jsparse=JSON.parse(jsonstringosmn);
 var jsonstringosm2 = JSON.stringify(jsparse);
 if(!document.getElementById("OSMscript_script_id"))
{var scriptB = document.createElement("script"); 
scriptB.src = 'openlayers/OSMBuildings-OpenLayers.js';  scriptB.type = 'text/javascript';  scriptB.id="OSMscript_script_id";
scriptB.async=false;document.body.appendChild(scriptB);
scriptB.onload= function(jsparse,opac){return function(){var osmbjson = new OSMBuildings(map).set('');osmbjson.set(jsparse);osmbjson.name=document.getElementById("VectorExtr25lnd_id").value;osmbjson.customJson=jsonstringosm2;osmbjson.opacityOSMbuild=opac;
/*osmbjson.style({ wallColor:"#00FF00", roofColor:"#FF0000", shadows:true});*/osmbjson.setVisibility(false);osmbjson.setVisibility(true);
osmbjson.onMapResize=function(){OSMBonMapResize(osmbjson)}; ; }}(jsparse,opac)}
else
{document.getElementById("OSMscript_script_id").parentNode.removeChild(document.getElementById("OSMscript_script_id"));OSMBuildings='';
var scriptB = document.createElement("script"); scriptB.src = 'openlayers/OSMBuildings-OpenLayers.js'; 
 scriptB.type = 'text/javascript';  scriptB.id="OSMscript_script_id";scriptB.async=false;document.body.appendChild(scriptB)
scriptB.onload= function(jsparse,opac){return function(){var osmbjson = new OSMBuildings(map).set('');osmbjson.set(jsparse);osmbjson.name=document.getElementById("VectorExtr25lnd_id").value;osmbjson.customJson=jsonstringosm2;osmbjson.opacityOSMbuild=opac;osmbjson.setVisibility(false);osmbjson.setVisibility(true);
osmbjson.onMapResize=function(){OSMBonMapResize(osmbjson)}; ; }}(jsparse,opac);
}  }
iD='';imageData2='';arris='';
}(lay)
}  } 

}
function OK_ImageAnalys2()
{if(document.getElementById("ImageLayerAnalys_id").value=='0'){alert("Выберите название слоя"); return;}
else{var waitT=document.createElement('a');waitT.id="id_waitImageAn2";waitT.innerHTML="Wait...";document.getElementById("id_waitImageAn").appendChild(waitT);}
var imcolor=document.getElementById("id_coloaddIm").style.backgroundColor;
imcolor=imcolor.split("rgb(")[1].split(")")[0];
imcolor=imcolor.split(",");imcolor[0]=parseInt(imcolor[0]);imcolor[1]=parseInt(imcolor[1]);imcolor[2]=parseInt(imcolor[2]);


for(var i=0;i<map.layers.length;i++)
{
if(map.layers[i].name==document.getElementById("ImageLayerAnalys_id").value)
{
var img = new Image(); img.src=map.layers[i].url; var lay=map.layers[i];
img.onload=function(lay){var can00=document.createElement("canvas");
can00.width=lay.tileSize.w;can00.height=lay.tileSize.h;
var ctx00 = can00.getContext("2d");ctx00.drawImage(img, 0, 0,lay.tileSize.w,lay.tileSize.h);
try{var new_layer_imagep = new OpenLayers.Layer.Vector(document.getElementById("VectorIm_layer_name_id").value,{renderers:["Canvas", "SVG", "VML"]});
var new_style_layer= new OpenLayers.Style({ pointRadius: 2, fillColor: "#FF9000", strokeColor: "#FF9000", strokeWidth: 1,fillOpacity:1, strokeOpacity:1 });
 var selStyle = new OpenLayers.Style({ pointRadius: 5,  fillColor: "#ffaa00", strokeColor: "#00DDFF", strokeWidth:2,fillOpacity:1, strokeOpacity:1 }); 
new_layer_imagep.styleMap=new OpenLayers.StyleMap({'default':new_style_layer,'select': selStyle});
if(document.getElementById("AddVectorIm_layer_name_id").value=='0')
{var t=this.document.createElement('option');t.value=new_layer_imagep.name;t.text=new_layer_imagep.name;this.document.getElementById("editL1").appendChild(t);
var t=this.document.createElement('option');t.value=new_layer_imagep.name;t.text=new_layer_imagep.name;this.document.getElementById("AddVectorIm_layer_name_id").appendChild(t);
}
map.addLayer(new_layer_imagep);var first_pointArr=[];
idDiv=lay.div.children[0].children[0].id;
var DivobjA=document.getElementById(idDiv);var bbox = DivobjA.getBoundingClientRect();
 var body = document.body; var docElem = document.documentElement; var scrollTop = window.pageYOffset || docElem.scrollTop || body.scrollTop;
 var scrollLeft = window.pageXOffset || docElem.scrollLeft || body.scrollLeft;
 var clientTop = docElem.clientTop || body.clientTop || 0; var clientLeft = docElem.clientLeft || body.clientLeft || 0;
 var topTop = bbox.top + scrollTop - clientTop; var leftLeft = bbox.left + scrollLeft - clientLeft;
var bbox2 = map.div.getBoundingClientRect();
 var body = document.body; var docElem2 = document.documentElement; var scrollTop2 = window.pageYOffset || docElem.scrollTop || body.scrollTop;
 var scrollLeft2 = window.pageXOffset || docElem.scrollLeft || body.scrollLeft;
 var clientTop2 = docElem.clientTop || body.clientTop || 0; var clientLeft2 = docElem.clientLeft || body.clientLeft || 0;
 var topTop2 = bbox2.top + scrollTop2 - clientTop2; var leftLeft2 = bbox2.left + scrollLeft2 - clientLeft2;
var start = performance.now(); 
var imageData2 = ctx00.getImageData(0,0,can00.width,can00.height);
var intc=parseInt(document.getElementById("VectorIm_colInt_id").value);

var first_long=parseFloat(document.getElementById("first_longIm").value);var first_lat=parseFloat(document.getElementById("first_latIm").value);
var sec_long=parseFloat(document.getElementById("sec_longIm").value);var sec_lat=parseFloat(document.getElementById("sec_latIm").value);
var boundImage=new OpenLayers.Bounds(first_long, first_lat, sec_long, sec_lat); boundImage.transform(new OpenLayers.Projection("EPSG:4326"), map.getProjectionObject());

for(var h=0;h<can00.height;h++)
{for(var w=0;w<can00.width;w++)
{

var xn=leftLeft-leftLeft2+w;var yn=topTop-topTop2+h;
var ext1 = new OpenLayers.Pixel(xn, yn);var new_pos = map.getLonLatFromPixel(ext1);
var new_lon=new_pos.lon; var new_lat=new_pos.lat;
var first_point =new OpenLayers.Geometry.Point(new_lon, new_lat);
first_point= new OpenLayers.Feature.Vector(first_point);
if(document.getElementById("id_checkCoordImAn").checked==true)
{
if(boundImage.left<=first_point.geometry.x&&boundImage.right>=first_point.geometry.x&&boundImage.bottom<=first_point.geometry.y&&boundImage.top>=first_point.geometry.y)
{ EdgeInputDataImage(w,h,imageData2,first_pointArr,imcolor,intc,leftLeft,leftLeft2,topTop,topTop2,can00)} 
}  else{EdgeInputDataImage(w,h,imageData2,first_pointArr,imcolor,intc,leftLeft,leftLeft2,topTop,topTop2,can00)}

} 
}
var end =  performance.now()  // log end timestamp
var diff = end - start;console.log("time1:"+diff);
var start =  performance.now()  // log end timestamp
/*alert(first_pointArr.length);
 first_pointArr.sort(function(a, b) {      return a.geometry.x == b.geometry.x ? a.geometry.y - b.geometry.y : a.geometry.x - b.geometry.x;   });
for(var er=0;er<first_pointArr.length;er++)
{if(first_pointArr[er+1]){if((first_pointArr[er].geometry.x==first_pointArr[er+1].geometry.x)&&(first_pointArr[er].geometry.y==first_pointArr[er+1].geometry.y)){first_pointArr.splice(er+1,1);}}}
first_pointArr.sort(function(a, b) {      return (a.geometry.y - b.geometry.y);   });
var nv=0; for(var er=0;er<first_pointArr.length;er++){
if(first_pointArr[er+1]){if((first_pointArr[er].geometry.x==first_pointArr[er+1].geometry.x)&&(first_pointArr[er].geometry.y==first_pointArr[er+1].geometry.y)){first_pointArr.splice(er+1,1);}}}
alert(first_pointArr.length);*/
if(document.getElementById("ImageLayerAnalysRes_id").value=='convexpolygon'||document.getElementById("ImageLayerAnalysRes_id").value=='polygon'||document.getElementById("ImageLayerAnalysRes_id").value=='line'||document.getElementById("ImageLayerAnalysRes_id").value=='convexline')
{var pr=parseFloat(document.getElementById("VectorIm_vicinity_id").value);
 var arrMain=[];var arrMaini=[]; var arrMain2=[];

first_pointArr.sort(function(a, b) {
      return a.geometry.x == b.geometry.x ? a.geometry.y - b.geometry.y : a.geometry.x - b.geometry.x;
   });
   var first_pointArr2=first_pointArr; var arpc=[];var po=first_pointArr2[0]; var pox=first_pointArr2[0].geometry.x;var poy=first_pointArr2[0].geometry.y;var endv=0;var t1_orig=map.getPixelFromLonLat(new OpenLayers.LonLat(pox,poy));
 var pox2=first_pointArr2[0].geometry.x;var poy2=first_pointArr2[0].geometry.y;
//alert("stop1 "+first_pointArr2.length);
while(first_pointArr2.length>0)
 {

var tg=0;
 for(var gp=0;gp<first_pointArr2.length;gp++)
 {var t1=map.getPixelFromLonLat(new OpenLayers.LonLat(pox,poy));   
  var t2=map.getPixelFromLonLat(new OpenLayers.LonLat(first_pointArr2[gp].geometry.x,first_pointArr2[gp].geometry.y));
  var xa=t2.x-t1.x;var ya=t2.y-t1.y; var dist=(Math.abs(xa)+Math.abs(xa))+(Math.abs(ya)+Math.abs(ya));//alert("coord t1 "+t1.y+" ,"+t1.x+" : "+t2.y);
 //////// impl
 /* var start = performance.now();  // log start timestamp
  function1(xa,ya);var end =  performance.now()  // log end timestamp
var diff = end - start;console.log("add:"+diff);
///////////////////////////////////
var start = performance.now();  // log start timestamp
  function1(xa,ya);var end =  performance.now()  // log end timestamp
var diff = end - start;console.log("mult:"+diff);
alert("stop");*/
if(dist<pr*pr){arpc.push(first_pointArr2[gp]) 
pox=first_pointArr2[gp].geometry.x;poy=first_pointArr2[gp].geometry.y;
first_pointArr2.splice(gp,1);gp=-1;} }
arrMain.push(arpc);arpc=[];if(first_pointArr2[tg]){pox=first_pointArr2[tg].geometry.x;poy=first_pointArr2[tg].geometry.y; }
 
 }
 arrMaini=[];
var nl='';var obj2={}
if(document.getElementById("AddVectorIm_layer_name_id").value!=='0')
{map.removeLayer(new_layer_imagep); for(var tt=0;tt<map.layers.length;tt++)
{if(map.layers[tt].name==document.getElementById("AddVectorIm_layer_name_id").value)
{if(map.layers[tt].features[0])
{;for (jk in map.layers[tt].features[0].attributes){obj2[jk]='';}
} }nl=map.layers[tt]; } }
if(document.getElementById("ImageLayerAnalysRes_id").value=='convexpolygon'||document.getElementById("ImageLayerAnalysRes_id").value=='convexline')
{
  for(var df=0;df<arrMain.length;df++)
 {var arp=convexHull(arrMain[df]);
 var arp2=[];
if(arp.length>1){
 for(var gs=0;gs<arp.length;gs++)
 {arp2.push(arp[gs].geometry);}
 if(document.getElementById("ImageLayerAnalysRes_id").value=='convexpolygon')
 {if(arp.length>=3){var linr=new OpenLayers.Geometry.Polygon([new OpenLayers.Geometry.LinearRing(arp2)]);}else{var linr='';}}
 if(document.getElementById("ImageLayerAnalysRes_id").value=='convexline')
 {var linr=new OpenLayers.Geometry.LineString(arp2);}
if(linr!==''){var sp=new OpenLayers.Feature.Vector(linr);sp.attributes.number=df;}else{var sp='';}
first_pointArr=[];
if(sp!==''){if(document.getElementById("AddVectorIm_layer_name_id").value!=='0')
{if(obj2!=={}){sp.attributes=obj2;nl.addFeatures(sp);}
else{nl.addFeatures(sp)}  }else{new_layer_imagep.addFeatures(sp)}}
} } }
if(document.getElementById("ImageLayerAnalysRes_id").value=='polygon'||document.getElementById("ImageLayerAnalysRes_id").value=='line')
{
 for(var df=0;df<arrMain.length;df++)
 {if(arrMain[df].length>1){var sp=polygonHull(arrMain[df]);
 if(sp!=='')
 {sp=new OpenLayers.Feature.Vector(sp);
sp.attributes.number=df;first_pointArr=[];
if(document.getElementById("AddVectorIm_layer_name_id").value!=='0')
{if(obj2!=={}){sp.attributes=obj2;nl.addFeatures(sp);}
else{nl.addFeatures(sp)}  }else{new_layer_imagep.addFeatures(sp)}} }
}
}
arrMain=[];arrMain2=[];
}
if(document.getElementById("ImageLayerAnalysRes_id").value=='point')
{
if(document.getElementById("AddVectorIm_layer_name_id").value!=='0')
{map.removeLayer(new_layer_imagep); for(var tt=0;tt<map.layers.length;tt++)
{if(map.layers[tt].name==document.getElementById("AddVectorIm_layer_name_id").value)
{if(map.layers[tt].features[0])
{var obj={};for (jk in map.layers[tt].features[0].attributes){obj[jk]='';}if(obj!=={}){for (var sdf=0;sdf<first_pointArr.length;sdf++){first_pointArr[sdf].attributes=obj;}map.layers[tt].addFeatures(first_pointArr)}
}else{map.layers[tt].addFeatures(first_pointArr)} map.layers[tt].addFeatures(first_pointArr)} } }
else{new_layer_imagep.addFeatures(first_pointArr);}
first_pointArr=[];
}//////////////////////////////////////////////////new_layer_imagep.addFeatures(first_pointArr); 
var end =  performance.now()
var diff = end - start;console.log("time2:"+diff);
/*var bounds = new OpenLayers.Bounds();
for (var x in first_pointArr) {    bounds.extend(first_pointArr[x].geometry.getBounds());}
var center = bounds.getCenterLonLat();
var first_point =new OpenLayers.Geometry.Point(center.lon, center.lat);
first_point= new OpenLayers.Feature.Vector(first_point);
new_layer_imagep.addFeatures(first_point); */
if(document.getElementById("id_waitImageAn2")){document.getElementById("id_waitImageAn2").parentNode.removeChild(document.getElementById("id_waitImageAn2"))}

}catch(e){alert(e);if(document.getElementById("id_waitImageAn2")){document.getElementById("id_waitImageAn2").parentNode.removeChild(document.getElementById("id_waitImageAn2"))}return;}
}(lay) } }
}
function EdgeInputDataImage(w,h,imageData2,first_pointArr,imcolor,intc,leftLeft,leftLeft2,topTop,topTop2,can00)
{
var cr=imageData2.data[((h*(imageData2.width*4)) + (w*4)) + 0];
var cg=imageData2.data[((h*(imageData2.width*4)) + (w*4)) + 1];
var cb=imageData2.data[((h*(imageData2.width*4)) + (w*4)) + 2];
///////////////////////////////////////////////////
if((imcolor[0]<=cr+intc&&imcolor[0]>=cr-intc)&&(imcolor[1]<=cg+intc&&imcolor[1]>=cg-intc)&&(imcolor[2]<=cb+intc&&imcolor[2]>=cb-intc))
{var r=imcolor[0];var g=imcolor[1];var b=imcolor[2];

 var is1,is2,is3;var neis=0;
if(w+1<can00.width&&w-1>=0&&h+1<can00.height&&h-1>=0)
{
var cr1=imageData2.data[((h*(imageData2.width*4)) + ((w-1)*4)) + 0];var cg1=imageData2.data[((h*(imageData2.width*4)) + ((w-1)*4)) + 1];var cb1=imageData2.data[((h*(imageData2.width*4)) + ((w-1)*4)) + 2];
var cr2=imageData2.data[((h*(imageData2.width*4)) + ((w+1)*4)) + 0];var cg2=imageData2.data[((h*(imageData2.width*4)) + ((w+1)*4)) + 1];var cb2=imageData2.data[((h*(imageData2.width*4)) + ((w+1)*4)) + 2];
var cr3=imageData2.data[(((h+1)*(imageData2.width*4)) + ((w)*4)) + 0];var cg3=imageData2.data[(((h+1)*(imageData2.width*4)) + ((w)*4)) + 1];var cb3=imageData2.data[(((h+1)*(imageData2.width*4)) + ((w)*4)) + 2];
var cr4=imageData2.data[(((h-1)*(imageData2.width*4)) + ((w)*4)) + 0];var cg4=imageData2.data[(((h-1)*(imageData2.width*4)) + ((w)*4)) + 1];var cb4=imageData2.data[(((h-1)*(imageData2.width*4)) + ((w)*4)) + 2];
if((imcolor[0]<=cr1+intc&&imcolor[0]>=cr1-intc)&&(imcolor[1]<=cg1+intc&&imcolor[1]>=cg1-intc)&&(imcolor[2]<=cb1+intc&&imcolor[2]>=cb1-intc))
{}
else{var xn=leftLeft-leftLeft2+w;var yn=topTop-topTop2+h;
var ext1 = new OpenLayers.Pixel(xn, yn);var new_pos = map.getLonLatFromPixel(ext1);;
var new_lon=new_pos.lon; var new_lat=new_pos.lat;
var first_point =new OpenLayers.Geometry.Point(new_lon, new_lat);
first_point= new OpenLayers.Feature.Vector(first_point);first_point.attributes.numberW=w;first_point.attributes.numberH=h;
if(first_pointArr[first_pointArr.length-1])
{if(first_pointArr[first_pointArr.length-1].geometry.x==first_point.geometry.x&&first_pointArr[first_pointArr.length-1].geometry.y==first_point.geometry.y){}else{first_pointArr.push(first_point);}}
else{first_pointArr.push(first_point)};
}
if((imcolor[0]<=cr2+intc&&imcolor[0]>=cr2-intc)&&(imcolor[1]<=cg2+intc&&imcolor[1]>=cg2-intc)&&(imcolor[2]<=cb2+intc&&imcolor[2]>=cb2-intc))
{}else{var xn=leftLeft-leftLeft2+w;var yn=topTop-topTop2+h;
var ext1 = new OpenLayers.Pixel(xn, yn);var new_pos = map.getLonLatFromPixel(ext1);;
var new_lon=new_pos.lon; var new_lat=new_pos.lat;
var first_point =new OpenLayers.Geometry.Point(new_lon, new_lat);
first_point= new OpenLayers.Feature.Vector(first_point);
first_point.attributes.numberW=w;first_point.attributes.numberH=h;
if(first_pointArr[first_pointArr.length-1])
{if(first_pointArr[first_pointArr.length-1].geometry.x==first_point.geometry.x&&first_pointArr[first_pointArr.length-1].geometry.y==first_point.geometry.y){}else{first_pointArr.push(first_point);}}
else{first_pointArr.push(first_point)};
}
if((imcolor[0]<=cr3+intc&&imcolor[0]>=cr3-intc)&&(imcolor[1]<=cg3+intc&&imcolor[1]>=cg3-intc)&&(imcolor[2]<=cb3+intc&&imcolor[2]>=cb3-intc))
{}
else{var xn=leftLeft-leftLeft2+w;var yn=topTop-topTop2+h;
var ext1 = new OpenLayers.Pixel(xn, yn);var new_pos = map.getLonLatFromPixel(ext1);;
var new_lon=new_pos.lon; var new_lat=new_pos.lat;
var first_point =new OpenLayers.Geometry.Point(new_lon, new_lat);
first_point= new OpenLayers.Feature.Vector(first_point);first_point.attributes.numberW=w;first_point.attributes.numberH=h;
if(first_pointArr[first_pointArr.length-1])
{if(first_pointArr[first_pointArr.length-1].geometry.x==first_point.geometry.x&&first_pointArr[first_pointArr.length-1].geometry.y==first_point.geometry.y){}else{first_pointArr.push(first_point);}}
else{first_pointArr.push(first_point)};
}
if((imcolor[0]<=cr4+intc&&imcolor[0]>=cr4-intc)&&(imcolor[1]<=cg4+intc&&imcolor[1]>=cg4-intc)&&(imcolor[2]<=cb4+intc&&imcolor[2]>=cb4-intc))
{}else{var xn=leftLeft-leftLeft2+w;var yn=topTop-topTop2+h;
var ext1 = new OpenLayers.Pixel(xn, yn);var new_pos = map.getLonLatFromPixel(ext1);;
var new_lon=new_pos.lon; var new_lat=new_pos.lat;
var first_point =new OpenLayers.Geometry.Point(new_lon, new_lat);
first_point= new OpenLayers.Feature.Vector(first_point);
first_point.attributes.numberW=w;first_point.attributes.numberH=h;
if(first_pointArr[first_pointArr.length-1])
{if(first_pointArr[first_pointArr.length-1].geometry.x==first_point.geometry.x&&first_pointArr[first_pointArr.length-1].geometry.y==first_point.geometry.y){}else{first_pointArr.push(first_point);}}
else{first_pointArr.push(first_point)};
} }

/////////////////////
} return first_pointArr;}
function CreatePoLfromPoint()
{
var points=edilayerMainLayer.selectedFeatures;
if(edilayerMainLayer.selectedFeatures.length<2){alert("ничего не выделено или количество выделенных элементов на карте меньше двух "); return;}
if(document.getElementById("id_checkLinepointnum").checked==true){if(document.getElementById("PointPolnum_id").value==0){alert("выберите атрибут с порядковым номером");return;} }
if(document.getElementById("id_checkPolpointnum").checked==true){if(document.getElementById("PointPolnum_id").value==0){alert("выберите атрибут с порядковым номером");return;} }

var new_layer_imagep = new OpenLayers.Layer.Vector(document.getElementById("PointP_layer_name_id").value,{renderers:["Canvas", "SVG", "VML"]});
var new_style_layer= new OpenLayers.Style({ pointRadius: 2, fillColor: "#FF9000", strokeColor: "#FF9000", strokeWidth: 1,fillOpacity:1, strokeOpacity:1 });
 var selStyle = new OpenLayers.Style({ pointRadius: 5,  fillColor: "#ffaa00", strokeColor: "#00DDFF", strokeWidth:2,fillOpacity:1, strokeOpacity:1 }); 
new_layer_imagep.styleMap=new OpenLayers.StyleMap({'default':new_style_layer,'select': selStyle});
if(document.getElementById("AddPointP_layer_name_id").value=='0')
{var t=this.document.createElement('option');t.value=new_layer_imagep.name;t.text=new_layer_imagep.name;this.document.getElementById("editL1").appendChild(t);
var t=this.document.createElement('option');t.value=new_layer_imagep.name;t.text=new_layer_imagep.name;this.document.getElementById("AddPointP_layer_name_id").appendChild(t);}
map.addLayer(new_layer_imagep);
var nl='';var obj2={}
if(document.getElementById("AddPointP_layer_name_id").value!=='0')
{map.removeLayer(new_layer_imagep); for(var tt=0;tt<map.layers.length;tt++)
{if(map.layers[tt].name==document.getElementById("AddPointP_layer_name_id").value)
{if(map.layers[tt].features[0]){for (jk in map.layers[tt].features[0].attributes){obj2[jk]='';}
} }nl=map.layers[tt]; } }
if (document.getElementById("id_checkPolyMergenum").checked==true)
{var xy=[];var xy2=[];var xypoint=[];
for(var jj=0;jj<points.length;jj++)
{xypoint=parseObjPolp(points[jj].geometry,xy,xy2); }
var poiForPol=[];
for(var jj=0;jj<xypoint.length;jj++)
{var n_point= new OpenLayers.Geometry.Point(xypoint[jj][0], xypoint[jj][1]);poiForPol.push(new OpenLayers.Feature.Vector(n_point));}
 var arp=convexHull(poiForPol); var arp2=[];
if(arp.length>1){ for(var gs=0;gs<arp.length;gs++)
 {arp2.push(arp[gs].geometry);}}
var sp=new OpenLayers.Geometry.Polygon([new OpenLayers.Geometry.LinearRing(arp2)]);
if(sp!=='')  {sp=new OpenLayers.Feature.Vector(sp);
if(document.getElementById("AddPointP_layer_name_id").value!=='0')
{if(obj2!=={}){sp.attributes=obj2;nl.addFeatures(sp);}
else{nl.addFeatures(sp)}  }else{new_layer_imagep.addFeatures(sp)}} 

if (document.getElementById("id_checkPolyMergenumrep").checked==true)
{for(var j=0;j<edilayerMainLayer.features.length;j++)
{for(var jj=0;jj<edilayerMainLayer.selectedFeatures.length;jj++)
{if(edilayerMainLayer.selectedFeatures[jj]==edilayerMainLayer.features[j])
{edilayerMainLayer.removeFeatures(edilayerMainLayer.features[j])}
}} }
return;}


if(document.getElementById("id_checkLinepointnum").checked==true)
{try{var pointsn=[];
var format = new OpenLayers.Format.GeoJSON({ });var jsonFeatures=format.write(points);var nf=format.read(jsonFeatures);
var atrrn=document.getElementById("PointPolnum_id").value;
nf.sort(function(a, b) {return (a.attributes[atrrn] - b.attributes[atrrn]);   });
for(var j=0;j<nf.length;j++){pointsn.push(nf[j].geometry.clone());}
var linrn=new OpenLayers.Geometry.LineString(pointsn);var sp=linrn;
if(sp!=='')  {sp=new OpenLayers.Feature.Vector(sp);
if(document.getElementById("AddPointP_layer_name_id").value!=='0')
{if(obj2!=={}){sp.attributes=obj2;nl.addFeatures(sp);}
else{nl.addFeatures(sp)}  }else{new_layer_imagep.addFeatures(sp)}  }
return;}catch(e){alert(e);} }


if(document.getElementById("id_checkPolpointnum").checked==true)
{try{var pointsn=[];
var format = new OpenLayers.Format.GeoJSON({ });var jsonFeatures=format.write(points);var nf=format.read(jsonFeatures);
var atrrn=document.getElementById("PointPolnum_id").value;
nf.sort(function(a, b) {return (a.attributes[atrrn] - b.attributes[atrrn]);   });
for(var j=0;j<nf.length;j++){pointsn.push(nf[j].geometry.clone());}
var linrn=new OpenLayers.Geometry.Polygon([new OpenLayers.Geometry.LinearRing(pointsn)]);var sp=linrn;
if(sp!=='')  {sp=new OpenLayers.Feature.Vector(sp);
if(document.getElementById("AddPointP_layer_name_id").value!=='0')
{if(obj2!=={}){sp.attributes=obj2;nl.addFeatures(sp);}
else{nl.addFeatures(sp)}  }else{new_layer_imagep.addFeatures(sp)}  }
}catch(e){alert(e);} }
else{
 if(document.getElementById("PointPolRes_id").value=='convexpolygon')
 { var arp=convexHull(points); var arp2=[];
if(arp.length>1){ for(var gs=0;gs<arp.length;gs++)
 {arp2.push(arp[gs].geometry);}
if(arp.length>=3){var linr=new OpenLayers.Geometry.Polygon([new OpenLayers.Geometry.LinearRing(arp2)]);}else{var linr='';}
if(linr!==''){var sp=new OpenLayers.Feature.Vector(linr);}else{var sp='';}
if(sp!==''){if(document.getElementById("AddPointP_layer_name_id").value!=='0')
{if(obj2!=={}){sp.attributes=obj2;nl.addFeatures(sp);}else{nl.addFeatures(sp)}  }else{new_layer_imagep.addFeatures(sp)}}
} }
  if(document.getElementById("PointPolRes_id").value=='polygon')
 { var sp=polygonHull(points); if(sp!=='')  {sp=new OpenLayers.Feature.Vector(sp);
if(document.getElementById("AddPointP_layer_name_id").value!=='0')
{if(obj2!=={}){sp.attributes=obj2;nl.addFeatures(sp);}
else{nl.addFeatures(sp)}  }else{new_layer_imagep.addFeatures(sp)}}  }
}
if (document.getElementById("id_checkPolyMergenumrep").checked==true)
{for(var j=0;j<edilayerMainLayer.features.length;j++)
{for(var jj=0;jj<edilayerMainLayer.selectedFeatures.length;jj++)
{if(edilayerMainLayer.selectedFeatures[jj]==edilayerMainLayer.features[j])
{edilayerMainLayer.removeFeatures(edilayerMainLayer.features[j])}
}} }
}
function parseObjPolp(obj,xy,xy2)
{xy2=[]; for(var key in obj)
{if(key=='x'){x = obj[key];xy2.push(x)};if(key=='y'){y = obj[key];xy2.push(y)}
if (key!=='parent'&&typeof(obj[key])=='object')
{if(xy2.length==2){xy.push(xy2);}parseObjPolp(obj[key],xy,xy2)}
}
 return xy;}
function cross(o, a, b) {
   return (a.geometry.x - o.geometry.x) * (b.geometry.y - o.geometry.y) - (a.geometry.y - o.geometry.y) * (b.geometry.x - o.geometry.x)
}
function convexHull(points) {
   points.sort(function(a, b) {
      return a.geometry.x == b.geometry.x ? a.geometry.y - b.geometry.y : a.geometry.x - b.geometry.x;
   });
 
   var lower = [];
   for (var i = 0; i < points.length; i++) {
      while (lower.length >= 2 && cross(lower[lower.length - 2], lower[lower.length - 1], points[i]) <= 0) {
         lower.pop();
      }
      lower.push(points[i]);
   }
 
   var upper = [];
   for (var i = points.length - 1; i >= 0; i--) {
      while (upper.length >= 2 && cross(upper[upper.length - 2], upper[upper.length - 1], points[i]) <= 0) {
         upper.pop();
      }
      upper.push(points[i]);
   }
 
   upper.pop();
   lower.pop();
   return lower.concat(upper);
}
function polygonHull(points)
{
var sumx=0;var sumy=0;for(var j=0;j<points.length;j++)
{sumx=sumx+points[j].geometry.x;sumy=sumy+points[j].geometry.y;}
sumx=sumx/points.length;sumy=sumy/points.length;var center = new OpenLayers.LonLat(sumx,sumy);

var distArr=[];
for(var p=0; p<points.length;p++)
{var t1=map.getPixelFromLonLat(new OpenLayers.LonLat(center.lon,center.lat));   
  var t2=map.getPixelFromLonLat(new OpenLayers.LonLat(points[p].geometry.x,points[p].geometry.y));
  var xa=t2.x-t1.x;var ya=t2.y-t1.y; var dist=Math.abs(xa)+Math.abs(xa)+Math.abs(ya)*Math.abs(ya); var distO={};distO.dist=dist;distO.point=points[p].clone();var a=GetPolarAngle(points[p],center );distO.a=a;distArr.push(distO);}
distArr.sort(function(a, b) {return (a.dist - b.dist);   });var linr2='';
 if(distArr[distArr.length-3])
{var arp2=[];arp2.push(distArr[distArr.length-1].point.geometry);arp2.push(distArr[distArr.length-2].point.geometry);arp2.push(distArr[distArr.length-3].point.geometry);

 var linr=new OpenLayers.Geometry.Polygon([new OpenLayers.Geometry.LinearRing(arp2)]);
arp2=[]; 
var ob={};ob.p=distArr[distArr.length-1].point.geometry; var a=GetPolarAngle(distArr[distArr.length-1].point,center) ; ob.a=a;arp2.push(ob);var ob={};
ob.p=distArr[distArr.length-2].point.geometry; var a=GetPolarAngle(distArr[distArr.length-2].point,center );ob.a=a;arp2.push(ob);var ob={};ob.p=distArr[distArr.length-3].point.geometry; var a=GetPolarAngle(distArr[distArr.length-3].point,center );ob.a=a;arp2.push(ob);

distArr.sort(function(a, b) {return (a.a - b.a);   });

for(var t=0;t<distArr.length;t++)
 {var intersect1 = (linr.intersects(distArr[t].point.geometry));
 if(intersect1==false) 
 { var a=GetPolarAngle(distArr[t].point,center );  var ob={};ob.p=distArr[t].point.geometry; ob.a=a;arp2.push(ob);
 arp2.sort(function(a, b) {return (a.a - b.a);   });var tArr=[];for(var we=0;we<arp2.length;we++){tArr.push(arp2[we].p)}
 if(document.getElementById("ImageLayerAnalysRes_id")&&document.getElementById("ImageLayerAnalysRes_id").value=='polygon')
 {if(tArr.length>=3){linr=new OpenLayers.Geometry.Polygon([new OpenLayers.Geometry.LinearRing(tArr)]);}else{linr='';}}
  if(document.getElementById("PointPolRes_id")&&document.getElementById("PointPolRes_id").value=='polygon')
 {if(tArr.length>=3){linr=new OpenLayers.Geometry.Polygon([new OpenLayers.Geometry.LinearRing(tArr)]);}else{linr='';}}
  if(document.getElementById("ImageLayerAnalysRes_id")&&document.getElementById("ImageLayerAnalysRes_id").value=='line')
  {linr=new OpenLayers.Geometry.LineString(tArr);  }
 }
 
 }

}
 return linr;
}
function GetPolarAngle(p,center )
    {
    var t1=map.getPixelFromLonLat(new OpenLayers.LonLat(center.lon,center.lat));  center= t1;
  var t2=map.getPixelFromLonLat(new OpenLayers.LonLat(p.geometry.x,p.geometry.y));p=t2;
  a = 0, x = p.x - center.x, y = p.y - center.y;
      if (x > 0 && y >= 0) {
a = Math.atan(y / x);       
}
      else if (x > 0 && y < 0)
{a = (Math.atan(y / x) + 2 * Math.PI);
}
      else if (x < 0) { a = (Math.atan(y / x) + Math.PI); 
      }
else if (x == 0 && y > 0){        a = (Math.PI * .5); }
else if (x == 0 && y < 0){        a = (Math.PI * 1.5);      }
else if (x == 0 && y == 0){  a = 0;}
return (a * 180 / Math.PI);
    }

function OK_ImageBinariAnalys()
{
if(document.getElementById("ImageLayerAnalys_id").value=='0'){alert("Select name of the Layer"); return;}
for(var i=0;i<map.layers.length;i++)
{ if(map.layers[i].name==document.getElementById("ImageLayerAnalys_id").value)
{ var img = new Image(); img.src=map.layers[i].url; var lay=map.layers[i];
img.onload=function(lay){var can00=document.createElement("canvas");
can00.width=lay.tileSize.w;can00.height=lay.tileSize.h;
var ctx00 = can00.getContext("2d");ctx00.drawImage(img, 0, 0,lay.tileSize.w,lay.tileSize.h);
var img2 = new Image(); img2.src=lay.url; 
img2.onload=function(lay){var can002=document.createElement("canvas");
can002.width=lay.tileSize.w;can002.height=lay.tileSize.h;
var ctx002 = can002.getContext("2d");ctx002.drawImage(img, 0, 0,lay.tileSize.w,lay.tileSize.h);
MainImageData2=can002;rtt=MainImageData2;}(lay);
var imageData2 = ctx00.getImageData(0,0,can00.width,can00.height);
for (var i = 0; i < imageData2.data.length; i += 4) {var iD1=imageData2;
var is1=0.299*iD1.data[i + 0]+0.587*iD1.data[i + 1]+0.114*iD1.data[i + 2];
if(is1>parseInt(document.getElementById("VectorIm_layer_Threshold_id").value)){ imageData2.data[i] = 255; imageData2.data[i + 1] = 255 ;imageData2.data[i + 2]=255; }
else{imageData2.data[i] = 0; imageData2.data[i + 1] = 0 ;imageData2.data[i + 2]=0;}
}
ctx00.putImageData(imageData2, 0, 0);  lay.url=can00.toDataURL();lay.redraw();
}(lay)
} }

}
function OK_ImageSharpenAnalys()
{
if(document.getElementById("ImageLayerAnalys_id").value=='0'){alert("Select name of the Layer"); return;}
for(var i=0;i<map.layers.length;i++)
{ if(map.layers[i].name==document.getElementById("ImageLayerAnalys_id").value)
{ var img = new Image(); img.src=map.layers[i].url; var lay=map.layers[i];
img.onload=function(lay){var can00=document.createElement("canvas");
can00.width=lay.tileSize.w;can00.height=lay.tileSize.h;
var ctx00 = can00.getContext("2d");ctx00.drawImage(img, 0, 0,lay.tileSize.w,lay.tileSize.h);
var img2 = new Image(); img2.src=lay.url; 
img2.onload=function(lay){var can002=document.createElement("canvas");
can002.width=lay.tileSize.w;can002.height=lay.tileSize.h;
var ctx002 = can002.getContext("2d");ctx002.drawImage(img, 0, 0,lay.tileSize.w,lay.tileSize.h);
MainImageData2=can002;rtt=MainImageData2;}(lay);

var imageData2 = ctx00.getImageData(0,0,can00.width,can00.height);var imageData3 = ctx00.getImageData(0,0,can00.width,can00.height);
var tre=parseInt(document.getElementById("VectorIm_layer_Threshold_id2").value)* 0.1;
weights= [  0, -1,  0,-1,  5, -1,0, -1,  0 ]
var side = Math.round(Math.sqrt(weights.length));
  var halfSide = Math.floor(side/2);
  var src = imageData2.data;
  var sw = imageData2.width;
  var sh = imageData2.height;

  var w = sw;
  var h = sh;dst=imageData3.data;
for (var y=0; y<h; y++) {
for (var x=0; x<w; x++) {
var sy = y;var sx = x;var dstOff = (y*w+x)*4;var r=0, g=0, b=0, a=0;
for (var cy=0; cy<side; cy++) {
for (var cx=0; cx<side; cx++) {
var scy = sy + cy - halfSide; var scx = sx + cx - halfSide;
if (scy >= 0 && scy < sh && scx >= 0 && scx < sw) {
var srcOff = (scy*sw+scx)*4;var wt = weights[cy*side+cx];
r += src[srcOff] * wt; g += src[srcOff+1] * wt;b += src[srcOff+2] * wt;//a += src[srcOff+3] * wt;
}        }      }
dst[dstOff] = r*tre+src[dstOff]*(1-tre);      dst[dstOff+1] = g*tre+src[dstOff+1]*(1-tre);
dst[dstOff+2] = b*tre+src[dstOff+2]*(1-tre);
      //dst[dstOff] = r;      //dst[dstOff+1] = g;      //dst[dstOff+2] = b;      //dst[dstOff+3] = a + alphaFac*(255-a);
    }
  }
ctx00.putImageData(imageData3, 0, 0);  lay.url=can00.toDataURL();lay.redraw();
}(lay)
} }


}
function OK_ImageEdgeAnalysUnDo()
{if(document.getElementById("ImageLayerAnalys_id").value=='0'){alert("Select name of the Layer"); return;}
for(var i=0;i<map.layers.length;i++)
{if(map.layers[i].name==document.getElementById("ImageLayerAnalys_id").value)
{if(MainImageData2!==''){map.layers[i].url=MainImageData2.toDataURL();map.layers[i].redraw();} }
} }
function OK_ImageInvertColor()
{ if(document.getElementById("ImageLayerAnalys_id").value=='0'){alert("Select name of the Layer"); return;}
for(var i=0;i<map.layers.length;i++)
{ if(map.layers[i].name==document.getElementById("ImageLayerAnalys_id").value)
{ var img = new Image(); img.src=map.layers[i].url; var lay=map.layers[i];
img.onload=function(lay){var can00=document.createElement("canvas");
can00.width=lay.tileSize.w;can00.height=lay.tileSize.h;
var ctx00 = can00.getContext("2d");ctx00.drawImage(img, 0, 0,lay.tileSize.w,lay.tileSize.h);
var img2 = new Image(); img2.src=lay.url; 
img2.onload=function(lay){var can002=document.createElement("canvas");
can002.width=lay.tileSize.w;can002.height=lay.tileSize.h;
var ctx002 = can002.getContext("2d");ctx002.drawImage(img, 0, 0,lay.tileSize.w,lay.tileSize.h);
MainImageData2=can002;rtt=MainImageData2;}(lay);
var imageData2 = ctx00.getImageData(0,0,can00.width,can00.height);
for (var i = 0; i < imageData2.data.length; i += 4) {
      imageData2.data[i]     = 255 - imageData2.data[i];     // red
      imageData2.data[i + 1] = 255 - imageData2.data[i + 1]; // green
      imageData2.data[i + 2] = 255 - imageData2.data[i + 2]; // blue
    }
    ctx00.putImageData(imageData2, 0, 0);  lay.url=can00.toDataURL();lay.redraw();
}(lay)
 } } 
}
function OK_ImageGrayColor()
{
if(document.getElementById("ImageLayerAnalys_id").value=='0'){alert("Select name of the Layer"); return;}
for(var i=0;i<map.layers.length;i++)
{ if(map.layers[i].name==document.getElementById("ImageLayerAnalys_id").value)
{ var img = new Image(); img.src=map.layers[i].url; var lay=map.layers[i];
img.onload=function(lay){var can00=document.createElement("canvas");
can00.width=lay.tileSize.w;can00.height=lay.tileSize.h;
var ctx00 = can00.getContext("2d");ctx00.drawImage(img, 0, 0,lay.tileSize.w,lay.tileSize.h);
var img2 = new Image(); img2.src=lay.url; 
img2.onload=function(lay){var can002=document.createElement("canvas");
can002.width=lay.tileSize.w;can002.height=lay.tileSize.h;
var ctx002 = can002.getContext("2d");ctx002.drawImage(img, 0, 0,lay.tileSize.w,lay.tileSize.h);
MainImageData2=can002;rtt=MainImageData2;}(lay);
var imageData2 = ctx00.getImageData(0,0,can00.width,can00.height);
for (var i = 0; i < imageData2.data.length; i += 4) {
      var avg = (imageData2.data[i] + imageData2.data[i +1] + imageData2.data[i +2]) / 3;
      imageData2.data[i]     = avg; // red
      imageData2.data[i + 1] = avg; // green
      imageData2.data[i + 2] = avg; // blue
    }
     ctx00.putImageData(imageData2, 0, 0);  lay.url=can00.toDataURL();lay.redraw();
}(lay)} }

}
function OK_ImageEdgeAnalys()
{if(document.getElementById("ImageLayerAnalys_id").value=='0'){alert("Select name of the Layer"); return;}
for(var i=0;i<map.layers.length;i++)
{
if(map.layers[i].name==document.getElementById("ImageLayerAnalys_id").value)
{
var img = new Image(); img.src=map.layers[i].url; var lay=map.layers[i];
img.onload=function(lay){var can00=document.createElement("canvas");
can00.width=lay.tileSize.w;can00.height=lay.tileSize.h;
var ctx00 = can00.getContext("2d");ctx00.drawImage(img, 0, 0,lay.tileSize.w,lay.tileSize.h);
var imageData2 = ctx00.getImageData(0,0,can00.width,can00.height);

var img2 = new Image(); img2.src=lay.url; 
img2.onload=function(lay){var can002=document.createElement("canvas");
can002.width=lay.tileSize.w;can002.height=lay.tileSize.h;
var ctx002 = can002.getContext("2d");ctx002.drawImage(img, 0, 0,lay.tileSize.w,lay.tileSize.h);
MainImageData2=can002;}(lay);
if(document.getElementById("ImageEdgAnalys_id").value=="Roberts"){
for(var h=0;h<can00.height;h++)
{for(var w=0;w<can00.width;w++)
{//if(w+1<can00.width&&h+1<can00.height)
//{
var is0=0.299*imageData2.data[((h*(imageData2.width*4)) + (w*4)) + 0]+0.587*imageData2.data[((h*(imageData2.width*4)) + (w*4)) + 1]+0.114*imageData2.data[((h*(imageData2.width*4)) + (w*4)) + 2]; var is1,is2,is3;var neis=0;
//var iD1 = ctx00.getImageData(w+1,h,1,1);var iD2 = ctx00.getImageData(w,h+1,1,1);var iD3 = ctx00.getImageData(w+1,h+1,1,1);
var iD1=imageData2;var iD2=imageData2; var iD3=imageData2;
is1=0.299*iD1.data[((h*(imageData2.width*4)) + ((w+1)*4)) + 0]+0.587*iD1.data[((h*(imageData2.width*4)) + ((w+1)*4)) + 1]+0.114*iD1.data[((h*(imageData2.width*4)) + ((w+1)*4)) + 2];
is2=0.299*iD2.data[(((h+1)*(imageData2.width*4)) + (w*4)) + 0]+0.587*iD2.data[(((h+1)*(imageData2.width*4)) + (w*4)) + 1]+0.114*iD2.data[(((h+1)*(imageData2.width*4)) + (w*4)) + 2];
is3=0.299*iD3.data[(((h+1)*(imageData2.width*4)) + ((w+1)*4)) + 0]+0.587*iD3.data[(((h+1)*(imageData2.width*4)) + ((w+1)*4)) + 1]+0.114*iD3.data[(((h+1)*(imageData2.width*4)) + ((w+1)*4)) + 2];//}else{is0=0;is1=0;is2=0;is3=0;}
var aa=is0-is3;var bb=is2-is1; neis=Math.sqrt(aa*aa+bb*bb)+parseInt(document.getElementById("AddCoefEdg_id").value); if (neis>255){neis=255; };imageData2.data[((h*(imageData2.width*4)) + (w*4)) + 0]=neis;imageData2.data[((h*(imageData2.width*4)) + (w*4)) + 1]=neis;imageData2.data[((h*(imageData2.width*4)) + (w*4)) + 2]=neis;/*ctx00.fillStyle='rgb('+neis+','+neis+','+neis+')'; ctx00.fillRect(w, h, 1, 1);*/
} }
 ctx00.putImageData(imageData2, 0, 0);
}
if(document.getElementById("ImageEdgAnalys_id").value=="Sobel"){
for(var h=0;h<can00.height;h++)
{for(var w=0;w<can00.width;w++)
{if(w+2<can00.width&&h+2<can00.height)
{
/*var iD1 = ctx00.getImageData(w,h,1,1);
var iD2 = ctx00.getImageData(w+1,h,1,1); 
var iD3 = ctx00.getImageData(w+2,h,1,1); 
var iD4 = ctx00.getImageData(w+2,h+1,1,1);
var iD5 = ctx00.getImageData(w+2,h+2,1,1);
var iD6 = ctx00.getImageData(w+1,h+2,1,1);*/
var iD1=imageData2;
//var iD7 = ctx00.getImageData(w,h+2,1,1);var iD8 = ctx00.getImageData(w,h+1,1,1);
var is1,is2,is3,is4,is5,is6,is7,is8;var neis=0;
var is1=0.299*iD1.data[((h*(imageData2.width*4)) + ((w)*4)) + 0]+0.587*iD1.data[((h*(imageData2.width*4)) + ((w)*4)) + 1]+0.114*iD1.data[((h*(imageData2.width*4)) + ((w)*4)) + 2];
var is2=0.299*iD1.data[((h*(imageData2.width*4)) + ((w+1)*4)) + 0]+0.587*iD1.data[((h*(imageData2.width*4)) + ((w+1)*4)) + 1]+0.114*iD1.data[((h*(imageData2.width*4)) + ((w+1)*4)) + 2];
var is3=0.299*iD1.data[((h*(imageData2.width*4)) + ((w+2)*4)) + 0]+0.587*iD1.data[((h*(imageData2.width*4)) + ((w+2)*4)) + 1]+0.114*iD1.data[((h*(imageData2.width*4)) + ((w+2)*4)) + 2];; 
var is4=0.299*iD1.data[(((h+1)*(imageData2.width*4)) + ((w+2)*4)) + 0]+0.587*iD1.data[(((h+1)*(imageData2.width*4)) + ((w+2)*4)) + 1]+0.114*iD1.data[(((h+1)*(imageData2.width*4)) + ((w+2)*4)) + 2];
var is5=0.299*iD1.data[(((h+2)*(imageData2.width*4)) + ((w+2)*4)) + 0]+0.587*iD1.data[(((h+2)*(imageData2.width*4)) + ((w+2)*4)) + 1]+0.114*iD1.data[(((h+2)*(imageData2.width*4)) + ((w+2)*4)) + 2]; 
var is6=0.299*iD1.data[(((h+2)*(imageData2.width*4)) + ((w+1)*4)) + 0]+0.587*iD1.data[(((h+2)*(imageData2.width*4)) + ((w+1)*4)) + 1]+0.114*iD1.data[(((h+2)*(imageData2.width*4)) + ((w+1)*4)) + 2]; 

var is7=0.299*iD1.data[(((h+2)*(imageData2.width*4)) + ((w)*4)) + 0]+0.587*iD1.data[(((h+2)*(imageData2.width*4)) + ((w)*4)) + 1]+0.114*iD1.data[(((h+2)*(imageData2.width*4)) + ((w)*4)) + 2];
var is8=0.299*iD1.data[(((h+1)*(imageData2.width*4)) + ((w)*4)) + 0]+0.587*iD1.data[(((h+1)*(imageData2.width*4)) + ((w)*4)) + 1]+0.114*iD1.data[(((h+1)*(imageData2.width*4)) + ((w)*4)) + 2];
var xt=(is3+2*is4+is5)-(is1+2*is8+is7);var yt=(is7+2*is6+is5)-(is1+2*is2+is3); neis=Math.sqrt(xt*xt+yt*yt)+parseInt(document.getElementById("AddCoefEdg_id").value);}else{is0=0;is1=0;is2=0;is3=0;is4=0;is5=0;is6=0;is7=0;is8=0}
if (neis>255){neis=255; };
imageData2.data[(((h)*(imageData2.width*4)) + ((w)*4)) + 0]=neis;imageData2.data[(((h)*(imageData2.width*4)) + ((w)*4)) + 1]=neis;imageData2.data[(((h)*(imageData2.width*4)) + ((w)*4)) + 2]=neis;
} }
ctx00.putImageData(imageData2, 0, 0);
}
lay.url=can00.toDataURL();
lay.redraw();



}(lay);
}
}

}
function OK_BoundImage()
{


var bbox = document.getElementById("map").getBoundingClientRect();
 var body = document.body
 var docElem = document.documentElement
 var scrollTop = window.pageYOffset || docElem.scrollTop || body.scrollTop
 var scrollLeft = window.pageXOffset || docElem.scrollLeft || body.scrollLeft
 var clientTop = docElem.clientTop || body.clientTop || 0
 var clientLeft = docElem.clientLeft || body.clientLeft || 0
 var topTop = bbox.top + scrollTop - clientTop
 var leftLeft = bbox.left + scrollLeft - clientLeft
var DivEditeLeg=document.createElement("div");
DivEditeLeg.id="id_divImageMain2";
DivEditeLeg.className="id_divImageMain";
DivEditeLeg.style.position="relative";
DivEditeLeg.innerHTML='<div id="id_divImageLeg" style="background:#ffffff; color:#0000ff;z-index: 6000;position:absolute;left:'+Math.round(leftLeft+50)+'px;top:'+Math.round(topTop-120)+
'px;overflow:hidden; border: 1px solid black;"><img onclick="closeImageWin()" src="openlayers/theme/default/img/close.gif" style="position:relative; top:10px;float:right; cursor:pointer"><a style="position:relative; top:20px"></a><br>'+
'<a style="font-size: 9px;">Вы можете перемещать это окно,</a><br><a style="font-size: 9px;"> если вы щёлкните по пункту меню Интерфейс/переключить режим интерфейса/</a><br>'+
'.выберите слой изображения: <select id="ImageLayerBound_id" onchange="ChangeBoundImageSel()">.'+
 '<option selected value="0">.</option>'+
'</select>.<br>'+ 
'.<a>Введите новые границы слоя:</a><br>'+
'.<input title="координата нижнего левого угла" type="text" size="8" id="first_long2" value="0"/>нижняя левая долгота<br>'+
'.<input title="координата нижнего левого угла" type="text" size="8" id="first_lat2" value="0"/>нижняя левая широта<br>'+
'.<input title="координата верхнего правого угла" type="text" size="8" id="sec_long2" value="0"/>верхняя правая долгота<br>'+
'.<input title="координата верхнего правого угла" type="text" size="8" id="sec_lat2" value="0"/>верхняя правая широта<br>'+
'<p> <button type=button onclick=OK_BoundImage2()>OK</button></p>'+
'<p> <button type=button title="Редактировать мышью - касанием и перемещением.После нажатия кнопки /Редактировать мышью/ для перетаскивания картинки в любое место карты вы должны щелкнуть (левой клавишей мыши) один раз по соответствующей картинке, после этого за перемещающимся курсором будет двигаться картинка, после  перенесения её в необходимое место нужно щёлкнуть ещё раз и перемещение закончится. Для изменения границ картинки (растяжения и сужения) нужно подвести курсор мыши к интересующему краю, при этом курсор изменит свой вид и после изменения вида курсора начать его двигать. При этом если подвели к правому краю, то в зависимости от направления движения картинка будет либо уменьшаться, либо увеличиваться по ширине. Если подвели к нижнему краю, то в зависимости от направления движения картинка будет либо уменьшаться, либо увеличиваться по высоте. Если подвели к левому краю, то картинка будет только увеличиваться по ширине вправо, если подвели к верхнему краю, то картинка будет только увеличиваться по высоте вниз. Во всех перечисленных случаях во время перемещения курсора происходит автоматическое изменение значений координат в полях ввода, соответствующее текущему положению и размеру картинки.Важно: для использования этой функции все векторные слои, лежащие выше слоя изображения, должны быть отключены, т.е. убрана галочка напротив них в списке слоёв карты." onclick=OK_BoundImage3()>Редактировать мышью</button></p>'+
'<p> <button type=button title="Отключить редактирование мышью - касанием и перемещением" onclick=OK_BoundImage4()>Stop редактирование мышью</button></p></div>';

if(!document.getElementById("id_divImageLeg"))
{body.appendChild(DivEditeLeg); }
document.getElementById("id_divImageMain2").onmousedown=function(event){drags(event)};
document.getElementById("id_divImageMain2").onmouseup=function(e){enddrag()};

for(var i=0;i<map.layers.length;i++)
{
if(map.layers[i].CLASS_NAME=="OpenLayers.Layer.Image")
{
var t=document.createElement('option');
t.value=map.layers[i].name;
t.text=map.layers[i].name;
document.getElementById("ImageLayerBound_id").appendChild(t);}
}

}
function OK_BoundImage3()
{ var idDiv=''
for(var i=0;i<map.layers.length;i++)
{
if(map.layers[i].name==document.getElementById("ImageLayerBound_id").value)
{idDiv=map.layers[i].div.children[0].children[0].id;
document.getElementById(idDiv).onclick=function(){ClickdragImage(document.getElementById(idDiv))};
ImageLayerMoveL=[];
ImageLayerMoveL2=[];
document.getElementById(idDiv).parentNode.onmousemove=moveImageGran;


}}

}

function moveImageGran(e)
{
var Divobj=(!is_ie)? e.target : event.srcElement;
ImageLayerMoveL.push(e.pageX);
ImageLayerMoveL2.push(e.pageY);

if(ImageLayerMoveL.length>2)
{ImageLayerMoveL.splice(0,1);}
if(ImageLayerMoveL2.length>2)
{ImageLayerMoveL2.splice(0,1);}

var bbox = Divobj.getBoundingClientRect();
 var body = document.body
 var docElem = document.documentElement
 var scrollTop = window.pageYOffset || docElem.scrollTop || body.scrollTop
 var scrollLeft = window.pageXOffset || docElem.scrollLeft || body.scrollLeft
 var clientTop = docElem.clientTop || body.clientTop || 0
 var clientLeft = docElem.clientLeft || body.clientLeft || 0
 var topTop = bbox.top + scrollTop - clientTop
 var leftLeft = bbox.left + scrollLeft - clientLeft
if(e.pageX>(leftLeft+parseFloat(Divobj.style.width.split('px')[0])-4)||e.pageX<(leftLeft+4))
{
Divobj.style.cursor="e-resize";
}
if(e.pageX<(leftLeft+parseFloat(Divobj.style.width.split('px')[0])-4)&&e.pageX>leftLeft+4)
{
Divobj.style.cursor="default";
}
if(e.pageY>(topTop+parseFloat(Divobj.style.height.split('px')[0])-4)||e.pageY<(topTop+4))
{
Divobj.style.cursor="n-resize";
}
if(Divobj.style.cursor=="e-resize")
{
if((e.pageX-leftLeft+4)<parseFloat(Divobj.style.width.split('px')[0]))
{Divobj.style.width=parseFloat(Divobj.style.width.split('px')[0])+(e.pageX-leftLeft);
Divobj.parentNode.style.width=parseFloat(Divobj.style.width.split('px')[0])+(e.pageX-leftLeft);}
else
{if(ImageLayerMoveL[1]<ImageLayerMoveL[0])
{Divobj.style.width=parseFloat(Divobj.style.width.split('px')[0])+((e.pageX-leftLeft)-parseFloat(Divobj.style.width.split('px')[0]));
Divobj.parentNode.style.width=parseFloat(Divobj.style.width.split('px')[0])+((e.pageX-leftLeft)-parseFloat(Divobj.style.width.split('px')[0]));}
if(ImageLayerMoveL[1]>ImageLayerMoveL[0])
{Divobj.style.width=parseFloat(Divobj.style.width.split('px')[0])+((e.pageX-leftLeft)+2-parseFloat(Divobj.style.width.split('px')[0]));
Divobj.parentNode.style.width=parseFloat(Divobj.style.width.split('px')[0])+((e.pageX-leftLeft)+2-parseFloat(Divobj.style.width.split('px')[0]));}
}
}

if(Divobj.style.cursor=="n-resize")
{
if((e.pageY-topTop+4)<parseFloat(Divobj.style.height.split('px')[0]))
{Divobj.style.height=parseFloat(Divobj.style.height.split('px')[0])+(e.pageY-topTop);
Divobj.parentNode.style.height=parseFloat(Divobj.style.height.split('px')[0])+(e.pageY-topTop);}
else
{if(ImageLayerMoveL2[1]<ImageLayerMoveL2[0])
{Divobj.style.height=parseFloat(Divobj.style.height.split('px')[0])+((e.pageY-topTop)-parseFloat(Divobj.style.height.split('px')[0]));
Divobj.parentNode.style.height=parseFloat(Divobj.style.height.split('px')[0])+((e.pageY-topTop)-parseFloat(Divobj.style.height.split('px')[0]));}
if(ImageLayerMoveL2[1]>ImageLayerMoveL2[0])
{Divobj.style.height=parseFloat(Divobj.style.height.split('px')[0])+((e.pageY-topTop)+2-parseFloat(Divobj.style.height.split('px')[0]));
Divobj.parentNode.style.height=parseFloat(Divobj.style.height.split('px')[0])+((e.pageY-topTop)+2-parseFloat(Divobj.style.height.split('px')[0]));}

}
}

var obj2=Divobj.parentNode;
var dopLeft=obj2.parentNode.parentNode.style.left.split("px")[0];
var dopTop=obj2.parentNode.parentNode.style.top.split("px")[0];
var ext1 = new OpenLayers.Pixel(parseFloat(obj2.style.left.split('px')[0])+parseFloat(obj2.style.width.split('px')[0])+parseFloat(dopLeft), parseFloat(obj2.style.top.split('px')[0])+parseFloat(dopTop));
var ext2 = new OpenLayers.Pixel(parseFloat(obj2.style.left.split('px')[0])+parseFloat(dopLeft), parseFloat(obj2.style.top.split('px')[0])+parseFloat(obj2.style.height.split('px')[0])+parseFloat(dopTop));//left,bottom
var lonlat1 = map.getLonLatFromPixel(ext1);
var lonlat2 = map.getLonLatFromPixel(ext2);
var boundImage=new OpenLayers.Bounds(lonlat2.lon, lonlat2.lat, lonlat1.lon, lonlat1.lat);
var oldBoundImage=boundImage.clone();
oldBoundImage.transform(map.getProjectionObject(),new OpenLayers.Projection("EPSG:4326"));
document.getElementById("first_long2").value=oldBoundImage.left;
document.getElementById("first_lat2").value=oldBoundImage.bottom;
document.getElementById("sec_long2").value=oldBoundImage.right;
document.getElementById("sec_lat2").value=oldBoundImage.top;
for(var i=0;i<map.layers.length;i++)
{
if(map.layers[i].name==document.getElementById("ImageLayerBound_id").value)
{map.layers[i].extent=boundImage;
map.layers[i].tileSize.w=map.layers[i].extent.getWidth()/map.layers[i].map.getResolution();
map.layers[i].tileSize.h=map.layers[i].extent.getHeight()/map.layers[i].map.getResolution();
map.layers[i].tile.position.x=parseFloat(obj2.style.left.split('px')[0]);
map.layers[i].tile.position.y=parseFloat(obj2.style.top.split('px')[0]);
}
}

}
function ClickdragImage(obj)
{ 
var obj=obj.parentNode;
ImageLayerMove=obj;

if(ImageLayerMoveT==1)
{ImageLayerMoveL3=1;document.onmousemove=moveImage; }else{document.onmousemove=stopmove;}
if(ImageLayerMoveT==1){ImageLayerMoveT=0}else{ImageLayerMoveT=1}
}
function closeImageWin()
{
for(var i=0;i<map.layers.length;i++)
{
if(map.layers[i].name==document.getElementById("ImageLayerBound_id").value)
{var idDiv=map.layers[i].div.children[0].children[0].id;
document.getElementById(idDiv).parentNode.onmousemove=function(){};
document.getElementById(idDiv).onclick=function(){}
document.getElementById(idDiv).style.cursor="default"
document.getElementById(idDiv).parentNode.style.cursor="default"
}
}
document.onmousemove=function(){};
ImageLayerMove='';
document.getElementById("id_divImageMain2").parentNode.removeChild(document.getElementById("id_divImageMain2"));
}
function closeAnalysImageWin()
{document.getElementById("id_divImageAnalys").parentNode.removeChild(document.getElementById("id_divImageAnalys"));

for(var i=0;i<map.controls.length;i++){if(map.controls[i].title=="control for image analys"){ map.controls[i].destroy();}} delete OpenLayers.Control.Click;
for(var i=0;i<map.controls.length;i++){if(map.controls[i].title=="click to get coordinates for ImageAnalyse"){ map.controls[i].destroy();}} delete OpenLayers.Control.Click;


}
function closeExtrude25ImageWin()
{document.getElementById("id_divImageExtrMain2").parentNode.removeChild(document.getElementById("id_divImageExtrMain2"));
for(var i=0;i<map.controls.length;i++){if(map.controls[i].title=="control for image extrude"){ map.controls[i].destroy();}} delete OpenLayers.Control.Click;
}
function OK_BoundImage4()
{
for(var i=0;i<map.layers.length;i++)
{
if(map.layers[i].name==document.getElementById("ImageLayerBound_id").value)
{var idDiv=map.layers[i].div.children[0].children[0].id;
document.getElementById(idDiv).parentNode.onmousemove=function(){};
document.getElementById(idDiv).onclick=function(){}
document.getElementById(idDiv).style.cursor="default"
document.getElementById(idDiv).parentNode.style.cursor="default"
}}
document.onmousemove=function(){};
ImageLayerMove='';

}
function stopmove()
{ImageLayerMove.onmousemove=moveImageGran;}
function moveImage(e)
{ImageLayerMove.onmousemove=function(){};
var obj=ImageLayerMove;
temp1=0;
temp2=0;
var obj2=obj;
var bbox = obj.getBoundingClientRect();
 var body = document.body
 var docElem = document.documentElement
 var scrollTop = window.pageYOffset || docElem.scrollTop || body.scrollTop
 var scrollLeft = window.pageXOffset || docElem.scrollLeft || body.scrollLeft
 var clientTop = docElem.clientTop || body.clientTop || 0
 var clientLeft = docElem.clientLeft || body.clientLeft || 0
 var topTop = bbox.top + scrollTop - clientTop;
 var leftLeft = bbox.left + scrollLeft - clientLeft;

if(ImageLayerMoveL3==1)
{dopImagex=e.pageX-leftLeft;dopImagey=e.pageY-topTop;}
ImageLayerMoveL3++;if(ImageLayerMoveL3>20){ImageLayerMoveL3=2;}
var tmpXpos = (!is_ie)? parseFloat(obj2.style.left.split('px')[0])+(e.pageX-leftLeft)-dopImagex: parseFloat(obj2.style.left.split('px')[0])+(event.pageX-leftLeft)-dopImagex;
 var tmpYpos = (!is_ie)? parseFloat(obj2.style.top.split('px')[0])+(e.pageY-topTop)-dopImagey: parseFloat(obj2.style.top.split('px')[0])+(event.pageY-topTop)-dopImagey;
obj2.style.left=tmpXpos;
obj2.style.top=tmpYpos;

var dopLeft=obj2.parentNode.parentNode.style.left.split("px")[0];
var dopTop=obj2.parentNode.parentNode.style.top.split("px")[0];

var ext1 = new OpenLayers.Pixel(parseFloat(tmpXpos)+parseFloat(obj2.style.width.split('px')[0])+parseFloat(dopLeft), parseFloat(tmpYpos)+parseFloat(dopTop));
var ext2 = new OpenLayers.Pixel(parseFloat(tmpXpos)+parseFloat(dopLeft), parseFloat(tmpYpos)+parseFloat(obj2.style.height.split('px')[0])+parseFloat(dopTop));//left,bottom
var lonlat1 = map.getLonLatFromPixel(ext1);
var lonlat2 = map.getLonLatFromPixel(ext2);
var boundImage=new OpenLayers.Bounds(lonlat2.lon, lonlat2.lat, lonlat1.lon, lonlat1.lat);
var oldBoundImage=boundImage.clone();
oldBoundImage.transform(map.getProjectionObject(),new OpenLayers.Projection("EPSG:4326"));
document.getElementById("first_long2").value=oldBoundImage.left;
document.getElementById("first_lat2").value=oldBoundImage.bottom;
document.getElementById("sec_long2").value=oldBoundImage.right;
document.getElementById("sec_lat2").value=oldBoundImage.top;
for(var i=0;i<map.layers.length;i++)
{
if(map.layers[i].name==document.getElementById("ImageLayerBound_id").value)
{map.layers[i].extent=boundImage;/*map.layers[i].redraw();*/
map.layers[i].tileSize.w=map.layers[i].extent.getWidth()/map.layers[i].map.getResolution();
map.layers[i].tileSize.h=map.layers[i].extent.getHeight()/map.layers[i].map.getResolution();
map.layers[i].tile.position.x=parseFloat(obj2.style.left.split('px')[0]);
map.layers[i].tile.position.y=parseFloat(obj2.style.top.split('px')[0]);
}
}


}
function OK_fileImageURL()
{var first_long=parseFloat(document.getElementById("first_longI").value);
var first_lat=parseFloat(document.getElementById("first_latI").value);
var sec_long=parseFloat(document.getElementById("sec_longI").value);
var sec_lat=parseFloat(document.getElementById("sec_latI").value);
var boundImage=new OpenLayers.Bounds(first_long, first_lat, sec_long, sec_lat)
var bound2=new OpenLayers.Bounds(-20037508.34, -20037508.34, 20037508.34, 20037508.34);
 boundImage.transform(new OpenLayers.Projection("EPSG:4326"), map.getProjectionObject());
if(URL_idImage.value==''){alert("Insert url");return;}
var graphic = new OpenLayers.Layer.Image(
document.getElementById("id_textImageURLLayer").value,
 URL_idImage.value,
 boundImage,
new OpenLayers.Size(1, 1),
 {numZoomLevels: 21, 'isBaseLayer': false,'alwaysInRange': true
}
 ); 

graphic.events.register("loadstart",graphic, 
function() {popup_Wait = new OpenLayers.Popup.FramedCloud("WaitPopup_"+graphic.id,
 map.getCenter(),
 new OpenLayers.Size(100,100),
 "<div style='color:#000080;'>Please wait...<div>" ,
 null, true, onPopupClose);
 map.addPopup(popup_Wait);
}); 
graphic.events.register("loadend",graphic, function() {if(document.getElementById("WaitPopup_"+graphic.id))
{document.getElementById("WaitPopup_"+graphic.id).parentNode.removeChild(document.getElementById("WaitPopup_"+graphic.id));}});
 map.addLayer(graphic);


}
function OK_fileImage()
{
var contents;
 if (fileZIP) {
 var r = new FileReader();
 r.onload = function(e) { 
contents = e.target.result;
var first_long=parseFloat(document.getElementById("first_long").value);
var first_lat=parseFloat(document.getElementById("first_lat").value);
var sec_long=parseFloat(document.getElementById("sec_long").value);
var sec_lat=parseFloat(document.getElementById("sec_lat").value);
var boundImage=new OpenLayers.Bounds(first_long, first_lat, sec_long, sec_lat)
var bound2=new OpenLayers.Bounds(-20037508.34, -20037508.34, 20037508.34, 20037508.34);
 boundImage.transform(new OpenLayers.Projection("EPSG:4326"), map.getProjectionObject());
/*var new_pos=new OpenLayers.LonLat(parseFloat(-179.99), parseFloat(-89.999)).transform(
new OpenLayers.Projection("EPSG:4326"),
map.getProjectionObject());
var new_lon=new_pos.lon;
var new_lat=new_pos.lat;
alert(new_lon+","+new_lat);
var new_pos2=new OpenLayers.LonLat(parseFloat(179.99), parseFloat(88.759)).transform(
new OpenLayers.Projection("EPSG:4326"),
map.getProjectionObject());
var new_lon2=new_pos2.lon;
var new_lat2=new_pos2.lat;
alert(new_lon2+","+new_lat2);*/
 var graphic = new OpenLayers.Layer.Image(
 fileZIP.name,
 contents,
 boundImage,
new OpenLayers.Size(1,1),
 {numZoomLevels: 21, 'isBaseLayer': false,'alwaysInRange': true
}
 ); 
/*alert(
 'Image ratio: ' + 
 (431/599).toString() +
 ' Bounds ratio: ' +
 (boundImage.getWidth() / boundImage.getHeight()).toString()
);*/
graphic.events.register("loadstart",graphic, 
function() {popup_Wait = new OpenLayers.Popup.FramedCloud("WaitPopup_"+graphic.id,
 map.getCenter(),
 new OpenLayers.Size(100,100),
 "<div style='color:#000080;'>Подождите...<div>" ,
 null, true, onPopupClose);
 map.addPopup(popup_Wait);
}); 
graphic.events.register("loadend",graphic, function() {if(document.getElementById("WaitPopup_"+graphic.id))
{document.getElementById("WaitPopup_"+graphic.id).parentNode.removeChild(document.getElementById("WaitPopup_"+graphic.id));}});
graphic.events.register("visibilitychanged",graphic, function() {graphic.div.childNodes[0].style.display="block";if(document.getElementById("WaitPopup_"+graphic.id))
{document.getElementById("WaitPopup_"+graphic.id).parentNode.removeChild(document.getElementById("WaitPopup_"+graphic.id));}});
 map.addLayer(graphic);
//if(popup_new_fileImage){popup_new_fileImage.destroy()};
graphic.div.childNodes[0].childNodes[0].src=contents;
graphic.url=contents;
 }
 r.readAsDataURL(fileZIP);
 } else { 
 alert("Ошибка загрузки файла");
 }
}
function OK_file()
{
if (fileZIP.name.split('.')[1]!="zip")
{alert("File is not in zip format");return;}
var urlStr='';
if(!document.getElementById("id_UseForAll"))
{
urlStr="/geoserver/rest/workspaces/webgis/datastores/curonian_new/file.shp?configure=all";
popup_new_file.destroy();
alert("Эта функция работает только в онлайн веб-версии OpenWebGIS")
 {return;}
var request = OpenLayers.Request.PUT({
url: urlStr,
async: false,
data: fileZIP,
headers: {
 'Content-Type': 'application/zip',
'WWW-Authenticate': 'Basic realm="Authentication System"'
 },
 callback: alert ("it's OK")
});
alert("Эта функция работает только в онлайн веб-версии OpenWebGIS")
 {return;}
var request = OpenLayers.Request.PUT({
url: urlStr.split('file.shp?configure=all')[0]+"featuretypes/"+fileZIP.name.split('.')[0],
async: false,
data:'<featureType><name>'+fileZIP.name.split('.')[0]+'</name> <srs>EPSG:4326</srs><enabled>true</enabled></featureType>',
headers: {
 "Content-Type": "application/xml"
 },
success: function(e){},
failure: function (e) {}
}); 
return;
}
if(document.getElementById("id_UseForAll")&&document.getElementById("id_UseForAll").checked==true)
{urlStr="/geoserver/rest/workspaces/webgis/datastores/curonian_new/file.shp?configure=all";
popup_new_file.destroy();
alert("Эта функция работает только в онлайн веб-версии OpenWebGIS")
 {return;}
var request = OpenLayers.Request.PUT({
url: urlStr,
async: false,
data: fileZIP,
headers: {
 'Content-Type': 'application/zip',
 },
 callback: alert ("it's OK")
});}
else
 { popup_new_file.destroy();urlStr="/geoserver/rest/workspaces/"+GlobalUN+"/datastores";
if(GlobalUN!=='')
{alert("Эта функция работает только в онлайн веб-версии OpenWebGIS")
 {return;}
var request = OpenLayers.Request.POST({
url: urlStr,
async: false,
data:'<dataStore>'+
 '<name>'+GlobalUN+'</name>'+
 '<type>Shapefile</type>'+
 '<enabled>true</enabled>'+
 '<connectionParameters>'+
 '<entry key="url">file:data/'+GlobalUN+'/'+GlobalUN+'/</entry>'+
 '<entry key="namespace">http://localhost:8080/data/'+GlobalUN+'/'+GlobalUN+'</entry>'+
 '</connectionParameters>'+
 ' <__default>false</__default>'+
'</dataStore>',
headers: {
 "Content-Type": "application/xml"
 },
success: function(e){},
failure: function (e) {}
}); 
urlStr="/geoserver/rest/workspaces/"+GlobalUN+"/datastores/"+GlobalUN+"/file.shp?configure=all";
alert("Эта функция работает только в онлайн веб-версии OpenWebGIS")
 {return;}
var request2 = OpenLayers.Request.PUT({
url: urlStr,
async: false,
data: fileZIP,
headers: {
 'Content-Type': 'application/zip',
 },
 callback: alert ("it's OK")
});
 }
 }
 alert("Эта функция работает только в онлайн веб-версии OpenWebGIS")
 {return;}
var request = OpenLayers.Request.PUT({
url: urlStr.split('file.shp?configure=all')[0]+"featuretypes/"+fileZIP.name.split('.')[0],
async: false,
data:'<featureType><name>'+fileZIP.name.split('.')[0]+'</name> <srs>EPSG:4326</srs><enabled>true</enabled></featureType>',
headers: {
 "Content-Type": "application/xml"
 },
success: function(e){},
failure: function (e) {}
}); 
}
function SumKvadrLayer()
{
var layerName=edilayerMainLayer.name+"Квадр";
var htmlKvadrProm='';
if(this.document.getElementById("editL1").value=="0")
{alert ("выберите название слоя в списке 'Редактируемый слой'");return;} 
var bbox = document.getElementById("map").getBoundingClientRect();
 var body = document.body
 var docElem = document.documentElement
 var scrollTop = window.pageYOffset || docElem.scrollTop || body.scrollTop
 var scrollLeft = window.pageXOffset || docElem.scrollLeft || body.scrollLeft
 var clientTop = docElem.clientTop || body.clientTop || 0
 var clientLeft = docElem.clientLeft || body.clientLeft || 0
 var topTop = bbox.top + scrollTop - clientTop
 var leftLeft = bbox.left + scrollLeft - clientLeft
var DivEditeLeg=document.createElement("div");
DivEditeLeg.id="id_SumKvadrLLegMain2";
DivEditeLeg.className="id_divRoutLegMain";
DivEditeLeg.style.position="relative";

htmlKvadrProm+='<div id="id_divSumKvadrLLeg" style="background:#ffffff; color:#0000ff;z-index: 6000;position:absolute;left:'+Math.round(leftLeft+50)+'px;top:'+Math.round(topTop-50)+
'px;overflow:hidden; border: 1px solid black;"><img onclick="closeSumKvadrLLegWin()" src="openlayers/theme/default/img/close.gif" style="position:relative; top:10px;float:right; cursor:pointer"><a style="position:relative; top:20px"></a>'+
'<a style="font-size: 9px;"> Вы можете перемещать это окно если щёлкните по пункту меню: Интерфейс->переключить режим интерфейса</a><br>';
htmlKvadrProm+='<a>Введите параметры выборки:</a><br>'+
'<select id=TimeAggreg_kvadr onchange="onChangeTimeKvadr()" title="date must be in format: yyyy-mm-ddThh:mm:ss. for example: 2007-06-20T12:30:00. This is Format ISO8601:yyyy-mm-ddThh:mm:ss. Implicity UTC timezone, and time at start of the day (00:00:00)">'+
 '<option selected value="0"></option>'+
'</select>поле с датой<br>'+
'<a >Введите интервал дат (дата1<=дата<=дата2):</a><br>'+
'<input title="дата в слое должно быть в формате соглано стандарту ISO8601. Например: 2013-12-22" type="text" size="6" id="PrhtmlTimeYear1" value=""/>год1 '+
'<input type="text" size="6" id="PrhtmlTimeMonth1" value=""/>месяц1 '+
'<input type="text" size="6" id="PrhtmlTimeDay1" value=""/>день1<br>'+
'<input type="text" size="6" id="PrhtmlTimeYear2" value=""/>год2 '+
'<input type="text" size="6" id="PrhtmlTimeMonth2" value=""/>месяц2 '+
'<input type="text" size="6" id="PrhtmlTimeDay2" value=""/>день2<br>';
htmlKvadrProm+='<select id=TypeAggreg_idSQL>'+
 '<option selected value="sum">сумма</option>'+
'<option value="avg">среднее</option>'+
'<option value="count">количество</option>'+
'<option value="countUn">количествоУникальных</option>'+
'</select>тип обработки(агрегации)<br>'+
'<select id=fieldPr_idSQL>'+
 '<option selected value="0"></option>'+
'</select>поле для агрегации<br>'+
'<a>min Latitude: </a><input type="text" size="6" id="id_PrLatMin" value=""/>'+
'<a>max Latitude: </a><input type="text" size="6" id="id_PrLatMax" value=""/><br>'+
'<a>min Longitude: </a><input type="text" size="6" id="id_PrLonMin" value=""/>'+
'<a>max Longitude: </a><input type="text" size="6" id="id_PrLonMax" value=""/><br>'+
'<a>размер квадрата (град): </a><input title="если заполнено только это поле, то при расчёте  используется квадрат у которого сторона равна этой величине, если заполнено поле - размер прямоугольника по широте, то значение учитывается как размер по долготе " type="text" size="4" id="id_PrRazmrKvadr" value=""/><br>'+
'<a>размер прямоугольника по широте (град): </a><input type="text" size="4" id="id_PrRazmrKvadr2" value=""/><br>'+
'<a>Временная дискретность:</a><br>'+
'<input type="checkbox" id="Id_MonthPr_Stat"  onchange="" value="checkbox"/>по месяцам<br>'+
'<a>дискретность в днях: </a><input type="text" size="4" id="Id_DayPr_Stat" value=""/>дни<br>'+
'<input type="checkbox" id="Id_KvadrLayerPr_Stat"  onchange="" value="checkbox"/>создать Слой прямоугольников(квадратов)<br>'+
'<input type="text" size="15" id="Id_SQL_layerName" value="'+layerName+'"/>название слоя<br>'+
'<p> <button type=button onclick= SumKvadrLayer_OK()>OK</button></p></div>';
DivEditeLeg.innerHTML=htmlKvadrProm;
if(!document.getElementById("id_SumKvadrLLegMain2"))
{body.appendChild(DivEditeLeg); }
document.getElementById("id_SumKvadrLLegMain2").onmousedown=function(event){drags(event)};
document.getElementById("id_SumKvadrLLegMain2").onmouseup=function(e){enddrag()};

for (var a in edilayerMainLayer.features[0].attributes)
{var t=document.createElement('option');
 t.value=a;
 t.text=a;
 document.getElementById("fieldPr_idSQL").appendChild(t);}
for (var a in edilayerMainLayer.features[0].attributes)
{var t=document.createElement('option');
 t.value=a;
 t.text=a;
 document.getElementById("TimeAggreg_kvadr").appendChild(t);}
var minDistC = parseFloat(edilayerMainLayer.features[0].geometry.x);
 var maxDistC = parseFloat(minDistC) ;
 for (var ia = 1; ia < edilayerMainLayer.features.length; ++ia) { var NumSS=edilayerMainLayer.features[ia].geometry.x;
 if (NumSS>parseFloat(maxDistC) ) {maxDistC = parseFloat(NumSS);}
 if( NumSS<parseFloat(minDistC) ) {minDistC = parseFloat(NumSS);}
 }
var new_pos2=new OpenLayers.LonLat(parseFloat(minDistC), parseFloat(edilayerMainLayer.features[0].geometry.y)).transform(
map.getProjectionObject(),new OpenLayers.Projection("EPSG:4326"));
var new_lon2=new_pos2.lon;
document.getElementById("id_PrLonMin").value=new_pos2.lon;
var new_pos2=new OpenLayers.LonLat(parseFloat(maxDistC), parseFloat(edilayerMainLayer.features[0].geometry.y)).transform(
map.getProjectionObject(),new OpenLayers.Projection("EPSG:4326"));
document.getElementById("id_PrLonMax").value=new_pos2.lon;
var minDistC = parseFloat(edilayerMainLayer.features[0].geometry.y);
 var maxDistC = parseFloat(minDistC) ;
 for (var ia = 1; ia < edilayerMainLayer.features.length; ++ia) { var NumSS=edilayerMainLayer.features[ia].geometry.y;
 if (NumSS>parseFloat(maxDistC) ) {maxDistC = parseFloat(NumSS);}
 if( NumSS<parseFloat(minDistC) ){ minDistC = parseFloat(NumSS);}
 }
var new_pos2=new OpenLayers.LonLat(parseFloat(edilayerMainLayer.features[0].geometry.x), parseFloat(minDistC)).transform(
map.getProjectionObject(),new OpenLayers.Projection("EPSG:4326"));
document.getElementById("id_PrLatMin").value=new_pos2.lat;
var new_pos2=new OpenLayers.LonLat(parseFloat(edilayerMainLayer.features[0].geometry.x), parseFloat(maxDistC)).transform(
map.getProjectionObject(),new OpenLayers.Projection("EPSG:4326"));
document.getElementById("id_PrLatMax").value=new_pos2.lat;
}
function SumKvadrLayer_OK()
{
WaitWindow();
var TYear1=document.getElementById("PrhtmlTimeYear1").value
var TMonth1=document.getElementById("PrhtmlTimeMonth1").value
var TDay1=document.getElementById("PrhtmlTimeDay1").value
var TYear2=document.getElementById("PrhtmlTimeYear2").value
var TMonth2=document.getElementById("PrhtmlTimeMonth2").value
var TDay2=document.getElementById("PrhtmlTimeDay2").value
/*
if(TMin2==''){TMin2='59';}
if(THour1==''){THour1='00';}
if(TMin1==''){TMin1='00';}*/
var DateV2=TYear2+'-'+TMonth2+'-'+TDay2+'T'
var DateV1= TYear1+'-'+TMonth1+'-'+TDay1+'T'
if(TYear1==''&&TMonth1==''&&TDay1==''&&TYear2==''&&TMonth2==''&&TDay2=='')
{DateV2='';DateV1='';}
else
{
if(TYear1==''||TMonth1==''||TDay1==''||TYear2==''||TMonth2==''||TDay2=='')
{alert("Дата ошибочна"); if(popup_Wait){try{popup_Wait.destroy();}catch(e){};}
return;}}
if(document.getElementById("Id_DayPr_Stat").value!==''&&document.getElementById("Id_MonthPr_Stat").checked==true)
{alert("Выберете что-то одно: Временная дискретность по месяцам или дням"); return;}
var varMilat=parseFloat(document.getElementById("id_PrLatMin").value);
var varMalat=parseFloat(document.getElementById("id_PrLatMax").value);
var varMilon=parseFloat(document.getElementById("id_PrLonMin").value);
var varMalon=parseFloat(document.getElementById("id_PrLonMax").value);

var kvadrL=parseFloat(document.getElementById("id_PrRazmrKvadr").value);
var kvadrL2=parseFloat(document.getElementById("id_PrRazmrKvadr2").value);
if(document.getElementById("id_PrRazmrKvadr2").value==''){kvadrL2=kvadrL;}
vectorLayerRec = new OpenLayers.Layer.Vector("rectangle");
if(kvadrL==''||isNaN(kvadrL)==true){alert("Введите размер квадрата");if(popup_Wait){try{popup_Wait.destroy();}catch(e){};}
 return;}
if(varMilat==''||isNaN(varMilat)==true||varMalat==''||isNaN(varMalat)==true||varMilon==''||isNaN(varMilon)==true||varMalon==''||isNaN(varMalon)==true)
{alert("Введите корректно координаты");rtt=popup_Wait; alert("popup_Wait");if(popup_Wait){try{popup_Wait.destroy();}catch(e){};}
 return;}
var nameL=document.getElementById("Id_SQL_layerName").value;
var new_layerSumPr = new OpenLayers.Layer.Vector(nameL,{renderers:["Canvas", "SVG", "VML"]});
new_layerSumPr.projection=new OpenLayers.Projection("EPSG:900913");
var numKvadr=0;
var ArrayKvadFeat=[]
for(var lat=varMilat; lat<=varMalat; lat=parseFloat(lat+kvadrL))
{
for(var lon=varMilon; lon<=varMalon; lon=parseFloat(lon+kvadrL))
 {if(document.getElementById("Id_MonthPr_Stat").checked==true||document.getElementById("Id_DayPr_Stat").value!=='')
 {ArrayKvadFeat=[];}
 var SumCatch=0; var count=0;var UniqVal={}
 for(var i=0; i<edilayerMainLayer.features.length; i++)
 {
 var new_pos2=new OpenLayers.LonLat(parseFloat(edilayerMainLayer.features[i].geometry.x), parseFloat(edilayerMainLayer.features[i].geometry.y)).transform(
map.getProjectionObject(),new OpenLayers.Projection("EPSG:4326"));
var new_lon2=new_pos2.lon;
var new_lat2=new_pos2.lat;
if(parseFloat(new_lat2)<parseFloat(lat+kvadrL)&&parseFloat(new_lat2)>=lat&&parseFloat(new_lon2)<parseFloat(lon+kvadrL)&&parseFloat(new_lon2)>=lon)
 { 
 if(document.getElementById("Id_MonthPr_Stat").checked==true||document.getElementById("Id_DayPr_Stat").value!=='')
 { ArrayKvadFeat.push(edilayerMainLayer.features[i])}
var field=document.getElementById("fieldPr_idSQL").value;
if(field==0){alert("Select aggregation field");return;}
 SumCatch=parseFloat(SumCatch)+parseFloat(edilayerMainLayer.features[i].attributes[field]);count++;
 }
 }
numKvadr++;
 if(document.getElementById("Id_MonthPr_Stat").checked==false)
{var NewAttr={};
if(document.getElementById("TypeAggreg_idSQL").value=='avg')
{if(count!=parseFloat(0))
{
SumCatch=SumCatch/count
}
else{SumCatch=0}
}
if(document.getElementById("TypeAggreg_idSQL").value=='count'){if(count!=parseFloat(0)){SumCatch=count}else{SumCatch=0}}
if(document.getElementById("TypeAggreg_idSQL").value=='countUn'){var sc=0;for (var thh in UniqVal) {sc++;}SumCatch=sc;}

if(document.getElementById("Id_LnPromStatKvadr")&&document.getElementById("Id_LnPromStatKvadr").checked==true){if(SumCatch2!==0){SumCatch2=Math.log(SumCatch2);}}
 NewAttr["AggregValueGIS"]=SumCatch; 
 NewAttr["NumberKvadr"]=numKvadr; 
 var y=(lat)+((kvadrL)/2); var x=(lon)+((kvadrL)/2);
 var new_pos=new OpenLayers.LonLat(x,y).transform(
new OpenLayers.Projection("EPSG:4326"),
map.getProjectionObject());
 var new_lon=new_pos.lon;
 var new_lat=new_pos.lat;
 var first_point =new OpenLayers.Geometry.Point(new_lon, new_lat);
 first_point= new OpenLayers.Feature.Vector(first_point);
 first_point.attributes=NewAttr;
 if(document.getElementById("Id_DayPr_Stat").value=='')
{new_layerSumPr.addFeatures(first_point);}
if(document.getElementById("Id_KvadrLayerPr_Stat").checked==true)
{
var y1=(lat); var x1=(lon);
var y2=lat+kvadrL2; var x2=(lon)+kvadrL;
var new_pos22=new OpenLayers.LonLat(x1,y1).transform(
new OpenLayers.Projection("EPSG:4326"),
map.getProjectionObject());
var new_lon1=new_pos22.lon;
var new_lat1=new_pos22.lat;
  var new_pos33=new OpenLayers.LonLat(x2,y2).transform(
new OpenLayers.Projection("EPSG:4326"),
map.getProjectionObject());
var new_lon2=new_pos33.lon;
var new_lat2=new_pos33.lat;

var pointList = [];
var newPoint1 = new OpenLayers.Geometry.Point(new_lon1,new_lat1);
var newPoint2 = new OpenLayers.Geometry.Point(new_lon2,new_lat1);
var newPoint3 = new OpenLayers.Geometry.Point(new_lon1,new_lat2);
var newPoint4 = new OpenLayers.Geometry.Point(new_lon2,new_lat2);
 pointList=[newPoint1,newPoint3,newPoint4,newPoint2];
 var linearRing = new OpenLayers.Geometry.LinearRing(pointList);

 var new_style_layerw= new OpenLayers.Style({ pointRadius: 4, fillColor: "#FF9000", strokeColor: "#EEF527", strokeWidth: 1,fillOpacity:0.3, strokeOpacity:1 });
 var selStylew = new OpenLayers.Style({ pointRadius: 5,  fillColor: "#ffaa00", strokeColor: "#00DDFF", strokeWidth:2,fillOpacity:0.3, strokeOpacity:1 }); 
vectorLayerRec.styleMap=new OpenLayers.StyleMap({'default':new_style_layerw,'select': selStylew});
var fatr=new OpenLayers.Feature.Vector(new OpenLayers.Geometry.Polygon([linearRing]));
fatr.attributes=NewAttr;
vectorLayerRec.addFeatures(fatr);
}
 }
if(document.getElementById("Id_DayPr_Stat").value!=='')
{
if(isNaN(parseInt(document.getElementById("Id_DayPr_Stat").value))){alert("Введите корректное значение количества дней"); return;}
var st1=new Date(DateV1+'00:00:00'); var st2=new Date(DateV2+'00:00:00');

st1=st1.getTime();st2=st2.getTime();
//var RazstDay=(Math.abs(st2-st1)/1000)/60/24;
var interDay=parseInt(document.getElementById("Id_DayPr_Stat").value);
//interDay=interDay*24*60*60*1000;
var er=new Date(st1);
er.setDate(er.getDate()+interDay);
rtt=er;

//console.log("st1 "+st1+" interDay "+interDay);
var er1=st1;
var yii=new Date(er1);
yii.setDate(yii.getDate()+interDay);
 for(var yi=er1;yi<=st2;yi=yii.getTime())
{/*console.log("er1 "+new Date(er1));*/var SumCatch2=0; var count2=0; var UniqVal2={};

for(var igi=0; igi<ArrayKvadFeat.length; igi++)
{
 var dateValue=document.getElementById("TimeAggreg_kvadr").value;
if(dateValue==0){ alert("введите поле с датой"); return;}
//var ndd=new Date(ArrayKvadFeat[i].attributes[dateValue]);
//ndd=ndd.getTime();
var newr=new Date(ArrayKvadFeat[igi].attributes[dateValue]);
newr=newr.getTime();
var bbb=new Date(er1);var bbb2=new Date(er1);var bbb3=new Date(er1);
if(yi!==er1)
{bbb3.setDate(bbb3.getDate()+1);}
else{}
bbb.setDate(bbb.getDate()+interDay);
bbb2.setDate(bbb2.getDate()+interDay+1);
if(newr<bbb2.getTime()&&newr>=bbb3.getTime())
{SumCatch2=parseFloat(SumCatch2)+parseFloat(ArrayKvadFeat[igi].attributes[field]);count2++;var unv=ArrayKvadFeat[igi].attributes[field];UniqVal2[unv]=true;}

}
var ter1=new Date(er1);
ter1.setDate(ter1.getDate()+interDay);
er1=ter1;rtt=er1;er1=er1.getTime();
yii.setDate(yii.getDate()+interDay);
 var NewAttr={};
if(document.getElementById("TypeAggreg_idSQL").value=='avg')
{
if(count2!=parseFloat(0))
{
SumCatch2=SumCatch2/count2;
}
else{SumCatch2=0}
}
if(document.getElementById("TypeAggreg_idSQL").value=='count'){if(count2!=parseFloat(0)){SumCatch2=count2}else{SumCatch2=0}}
if(document.getElementById("TypeAggreg_idSQL").value=='countUn'){var sc=0;for (var thh in UniqVal2) {sc++;}SumCatch2=sc;}
if(document.getElementById("Id_LnPromStatKvadr")&&document.getElementById("Id_LnPromStatKvadr").checked==true){if(SumCatch2!==0){SumCatch2=Math.log(SumCatch2);}}
 NewAttr["AggregValueGIS"]=SumCatch2; 
 NewAttr["NumberKvadr"]=numKvadr; 
var ttimedate=new Date(bbb);
//rtt=ttimedate;alert("rtyu");rtt=SumCatch2;alert("rtyu1");
NewAttr["Year"]=ttimedate.getFullYear();
var M=ttimedate.getMonth()+1;if(parseInt(M)<10){M='0'+M;}
NewAttr["Month"]=M;
NewAttr["OWGdate"]=ttimedate.toDateString()

 var yk=(lat)+((kvadrL)/2); var x=(lon)+((kvadrL)/2);
 var new_pos=new OpenLayers.LonLat(x,yk).transform(
new OpenLayers.Projection("EPSG:4326"),
map.getProjectionObject());
 var new_lon=new_pos.lon;
 var new_lat=new_pos.lat;
 var first_point =new OpenLayers.Geometry.Point(new_lon, new_lat);
 first_point= new OpenLayers.Feature.Vector(first_point);
 first_point.attributes=NewAttr;
new_layerSumPr.addFeatures(first_point);
if(document.getElementById("Id_KvadrLayerPr_Stat").checked==true)
{
var y1=(lat); var x1=(lon);
var y2=lat+kvadrL2; var x2=(lon)+kvadrL;
var new_pos22=new OpenLayers.LonLat(x1,y1).transform(
new OpenLayers.Projection("EPSG:4326"),
map.getProjectionObject());
var new_lon1=new_pos22.lon;
var new_lat1=new_pos22.lat;
  var new_pos33=new OpenLayers.LonLat(x2,y2).transform(
new OpenLayers.Projection("EPSG:4326"),
map.getProjectionObject());
var new_lon2=new_pos33.lon;
var new_lat2=new_pos33.lat;

var pointList = [];
var newPoint1 = new OpenLayers.Geometry.Point(new_lon1,new_lat1);
var newPoint2 = new OpenLayers.Geometry.Point(new_lon2,new_lat1);
var newPoint3 = new OpenLayers.Geometry.Point(new_lon1,new_lat2);
var newPoint4 = new OpenLayers.Geometry.Point(new_lon2,new_lat2);
 pointList=[newPoint1,newPoint3,newPoint4,newPoint2];
 var linearRing = new OpenLayers.Geometry.LinearRing(pointList);

 var new_style_layerg= new OpenLayers.Style({ pointRadius: 4, fillColor: "#FF9000", strokeColor: "#EEF527", strokeWidth: 1,fillOpacity:0.3, strokeOpacity:1 });
 var selStyleg = new OpenLayers.Style({ pointRadius: 5,  fillColor: "#ffaa00", strokeColor: "#00DDFF", strokeWidth:2,fillOpacity:0.3, strokeOpacity:1 }); 
vectorLayerRec.styleMap=new OpenLayers.StyleMap({'default':new_style_layerg,'select': selStyleg});
var fatr=new OpenLayers.Feature.Vector(new OpenLayers.Geometry.Polygon([linearRing]));
fatr.attributes=NewAttr;
vectorLayerRec.addFeatures(fatr);
}
SumCatch2=0;

/////////////////////////////////////////////////////////////////////////////////////////////////////////////
}
  }

 if(document.getElementById("Id_MonthPr_Stat").checked==true)
{var StartM;if(parseInt(TMonth1)>=10){StartM=TMonth1;}else{StartM=parseInt(TMonth1.split('0')[1])} ;
var startYear=parseInt(TYear1);
 for(var y=startYear;y<=TYear2;y++)
{ var monthProm=0; 
 for(var yy=StartM;yy<100;yy++)
{ if(yy==13){StartM=1;startYear=startYear+1;break;};
var SumCatch2=0; var count2=0; var UniqVal2={};
var monS='0'+yy; 
if(yy>=10){ monS=yy;};
 if(y==TYear2&&monS==TMonth2)
{yy=100;};
for(var i=0; i<ArrayKvadFeat.length; i++)
 {
 var field=document.getElementById("fieldPr_idSQL").value;
if(field==0){alert("Select aggregation field");return;}
var dateValue=document.getElementById("TimeAggreg_kvadr").value;
if(dateValue==0){ alert("введите поле с датой"); return;}
if(ArrayKvadFeat[i].attributes[dateValue].split('-')[0]==y&&ArrayKvadFeat[i].attributes[dateValue].split('-')[1]==monS)
 {SumCatch2=parseFloat(SumCatch2)+parseFloat(ArrayKvadFeat[i].attributes[field]);count2++;var unv=ArrayKvadFeat[i].attributes[field];UniqVal2[unv]=true;}
 }
 var NewAttr={};
if(document.getElementById("TypeAggreg_idSQL").value=='avg'){if(count2!=parseFloat(0)){SumCatch2=SumCatch2/count2}else{SumCatch2=0}}
if(document.getElementById("TypeAggreg_idSQL").value=='count'){if(count2!=parseFloat(0)){SumCatch2=count2}else{SumCatch2=0}}
if(document.getElementById("TypeAggreg_idSQL").value=='countUn'){var sc=0;for (var thh in UniqVal2) {sc++;}SumCatch2=sc;}
if(document.getElementById("Id_LnPromStatKvadr")&&document.getElementById("Id_LnPromStatKvadr").checked==true){if(SumCatch2!==0){SumCatch2=Math.log(SumCatch2);}}
 NewAttr["AggregValueGIS"]=SumCatch2; 
 NewAttr["NumberKvadr"]=numKvadr; 
NewAttr["Year"]=y;
NewAttr["Month"]=monS;
 var yk=(lat)+((kvadrL)/2); var x=(lon)+((kvadrL)/2);
 var new_pos=new OpenLayers.LonLat(x,yk).transform(
new OpenLayers.Projection("EPSG:4326"),
map.getProjectionObject());
 var new_lon=new_pos.lon;
 var new_lat=new_pos.lat;
 var first_point =new OpenLayers.Geometry.Point(new_lon, new_lat);
 first_point= new OpenLayers.Feature.Vector(first_point);
 first_point.attributes=NewAttr;
new_layerSumPr.addFeatures(first_point);
if(document.getElementById("Id_KvadrLayerPr_Stat").checked==true)
{
var y1=(lat); var x1=(lon);
var y2=lat+kvadrL2; var x2=(lon)+kvadrL;
var new_pos22=new OpenLayers.LonLat(x1,y1).transform(
new OpenLayers.Projection("EPSG:4326"),
map.getProjectionObject());
var new_lon1=new_pos22.lon;
var new_lat1=new_pos22.lat;
  var new_pos33=new OpenLayers.LonLat(x2,y2).transform(
new OpenLayers.Projection("EPSG:4326"),
map.getProjectionObject());
var new_lon2=new_pos33.lon;
var new_lat2=new_pos33.lat;

var pointList = [];
var newPoint1 = new OpenLayers.Geometry.Point(new_lon1,new_lat1);
var newPoint2 = new OpenLayers.Geometry.Point(new_lon2,new_lat1);
var newPoint3 = new OpenLayers.Geometry.Point(new_lon1,new_lat2);
var newPoint4 = new OpenLayers.Geometry.Point(new_lon2,new_lat2);
 pointList=[newPoint1,newPoint3,newPoint4,newPoint2];
 var linearRing = new OpenLayers.Geometry.LinearRing(pointList);

 var new_style_layere= new OpenLayers.Style({ pointRadius: 4, fillColor: "#FF9000", strokeColor: "#EEF527", strokeWidth: 1,fillOpacity:0.3, strokeOpacity:1 });
 var selStylee = new OpenLayers.Style({ pointRadius: 5,  fillColor: "#ffaa00", strokeColor: "#00DDFF", strokeWidth:2,fillOpacity:0.3, strokeOpacity:1 }); 
vectorLayerRec.styleMap=new OpenLayers.StyleMap({'default':new_style_layere,'select': selStylee});
var fatr=new OpenLayers.Feature.Vector(new OpenLayers.Geometry.Polygon([linearRing]));
fatr.attributes=NewAttr;
vectorLayerRec.addFeatures(fatr);
}
SumCatch2=0;
 }
 }//end year
}
 }
}
var new_style_layer= new OpenLayers.Style({
 pointRadius: 3, fillColor: "#FF9000",
 strokeColor: "#FF9000", strokeWidth: 1,
fillOpacity:1, strokeOpacity:1
 });
 var selStyle = new OpenLayers.Style({
 pointRadius: 5, fillColor: "#ffaa00",
 strokeColor: "#00DDFF", strokeWidth:2,
fillOpacity:1, strokeOpacity:1
 }); 
new_layerSumPr.styleMap=new OpenLayers.StyleMap({'default':new_style_layer,'select': selStyle});
map.addLayer(new_layerSumPr);
var t=this.document.createElement('option');
t.value=new_layerSumPr.name;
t.text=new_layerSumPr.name;
this.document.getElementById("editL1").appendChild(t);
if(document.getElementById("Id_KvadrLayerPr_Stat").checked==true)
{map.addLayer(vectorLayerRec);
var t=this.document.createElement('option');
t.value=vectorLayerRec.name;
t.text=vectorLayerRec.name;
this.document.getElementById("editL1").appendChild(t);}
if(typeof(ChartKvadr)=="undefined"){
ChartKvadr = new OpenLayers.Control.ModifyFeature(edilayerMainLayer, {
title: "Show chart and table aggregation data",
displayClass: "olControlDrawFeatureCoord"
});
panel2 = new OpenLayers.Control.Panel({
 displayClass: 'customEditingToolbar',
 allowDepress: true
 });
 panel2.addControls([ChartKvadr]);
map.addControls([panel2]);
panel2.div.style.top="60px";
panel2.div.style.left="35px";}
if(popup_Wait){try{popup_Wait.destroy();}catch(e){};}
}

function creatChartKvadr(lay)
{var feature = lay.feature
var htmlText="";
htmlText+='select field to create chart:'+'<select id="ChartKv_Selector"><option value="">.</option> </select>'+'<br>';
htmlText +='<button id="selecClickChartKvadr" type="button" onclick="creatChartKvadr2;">OK</button>'; 
    popupKvadr = new OpenLayers.Popup.FramedCloud("featureKvadrPopup",
                             feature.geometry.getBounds().getCenterLonLat(),
                             new OpenLayers.Size(20,100),
                            htmlText ,
                             null, true, onPopupClose);
    feature.popup = popupKvadr;
    popupKvadr.feature = feature;
popupKvadr.id="popup_"+feature.id
popupKvadr.minSize=new OpenLayers.Size(150,100);
popupKvadr.maxSize=new OpenLayers.Size(450,260);
setTimeout(function() {map.addPopup(popupKvadr)
document.getElementById("selecClickChartKvadr").onclick=function(){creatChartKvadr2(lay)};
document.getElementById("featureKvadrPopup").onmousedown=function(event){drags(event)};
document.getElementById("featureKvadrPopup").onmouseup=function(e){enddrag()};
for(h in edilayerMainLayer.features[0].attributes)
{var t=this.document.createElement('option');
t.value=h;
t.text=h;
this.document.getElementById("ChartKv_Selector").appendChild(t); 
};popupKvadr.updateSize();
},300);

}
function creatChartKvadr2(lay)
{
if(!edilayerMainLayer.features[0].attributes.NumberKvadr){alert("ошибочный слой");return;}
var feature = lay.feature;

var myWinChartKV= open("", "_blank",
       "width=400,height=300,status=yes,toolbar=yes,menubar=no,scrollbars=yes");
       myWinChartKV.document.open();
       myWinChartKV.document.write("<html><head><title>Chart Aggregation");
       myWinChartKV.document.write("</title>");
       myWinChartKV.document.write("</head><body>");//feature.attributes.NumberKvadr
var strChart="<div id=id_WindowDivSSAchart3><canvas id=chartKvadrSumMain width='1000' height='440'></canvas><br></div><div id=Table></div>";
       myWinChartKV.document.write(strChart);
       myWinChartKV.document.write("</body></html>");
       myWinChartKV.document.close(); 
var arrayFeat=[];
for (var i=0;i<edilayerMainLayer.features.length;i++)
{if(edilayerMainLayer.features[i].attributes.NumberKvadr==feature.attributes.NumberKvadr)
{arrayFeat.push(edilayerMainLayer.features[i]);}
}

////creat table data by kvadr
htmlTableD='';
htmlTableD+='<a>Table</a><br><a>Квадрат номер '+feature.attributes.NumberKvadr+'</a><br><table>';
htmlTableD+='<tr align="center" bgcolor="#FFDB73">';
for(var j in arrayFeat[0].attributes){htmlTableD+='<td><font size=2>'+j+'</font></td>';}
htmlTableD+='</tr>';
   for(var i=0; i<arrayFeat.length; i++){
    htmlTableD+='<tr align="center" bgcolor="#E5FB71">';
    for(var j in arrayFeat[i].attributes){
 htmlTableD+='<td><font size=2>'+arrayFeat[i].attributes[j]+'</font></td>';
    }
htmlTableD+='</tr>';
     } 
htmlTableD+='</table><a> .</a><br>';
myWinChartKV.document.getElementById("Table").innerHTML=htmlTableD;

///end create table by kvadr

 var drawingCanvas0 = myWinChartKV.document.getElementById('chartKvadrSumMain');
var context = drawingCanvas0.getContext('2d');
context.lineWidth = 1.5;
          context.lineCap = 'butt';
        context.beginPath();
          context.moveTo(30, 0);
   context.lineTo(30, 420);
    context.lineWidth = 1.5;
    context.lineTo(1000, 420);
     context.stroke();
////find min and max on charts
var sumCatch=document.getElementById("ChartKv_Selector").value;
popupKvadr.destroy();
  var minDistC = parseFloat(arrayFeat[0].attributes[sumCatch]);
            var  maxDistC = parseFloat(minDistC) ;
           for (ia = 1; ia <  arrayFeat.length; ++ia) { var NumSS=arrayFeat[ia].attributes[sumCatch];
           if (NumSS>parseFloat(maxDistC) ) maxDistC =  parseFloat(NumSS);
           if( NumSS<parseFloat(minDistC) ) minDistC  = parseFloat(NumSS);
          }
var cenDel=(maxDistC-minDistC)/(myWinChartKV.document.getElementById('chartKvadrSumMain').height-20);
///mark axis Y
context.font = "bold 8px sans-serif";
context.textAlign = "right";
context.textBaseline = "bottom";
var YtextP1=(maxDistC-minDistC)/10
for( var Yt=0;Yt<=11;Yt++){YtextP=(maxDistC-(minDistC+(YtextP1*Yt)))/cenDel
context.fillText((minDistC+(YtextP1*Yt)).toFixed(2), 30,YtextP+11);context.lineWidth=1;context.beginPath();context.moveTo(20,YtextP);context.lineTo(35,YtextP);context.stroke();}
//end mark axis Y
///mark axis X
var Xa=0 //mark spustja 3 interval
for(var i=0; i<arrayFeat.length; i++)
{context.font = "bold 8px sans-serif";
context.textAlign = "right";
context.textBaseline = "bottom";
var AxY=myWinChartKV.document.getElementById('chartKvadrSumMain').height-10;
var LenX=(myWinChartKV.document.getElementById('chartKvadrSumMain').width-30)/arrayFeat.length;
//LenX=LenX-0.35;
Xa=Xa+1;var TextMy1=arrayFeat[i].attributes["Month"];
var TextMy2=arrayFeat[i].attributes["Year"];
if(Xa==0||Xa==2||i==arrayFeat.length-1)
{context.fillText(TextMy1, parseFloat(LenX*i+30), AxY); context.fillText(TextMy2, parseFloat(LenX*i+30), parseFloat(AxY+7));}
if(Xa==2){Xa=0;}
context.lineWidth = 1;
context.beginPath()
context.moveTo(LenX*i+30, myWinChartKV.document.getElementById('chartKvadrSumMain').height-20);
context.lineTo(LenX*i+30, myWinChartKV.document.getElementById('chartKvadrSumMain').height-24);context.stroke();}
////end mark axis X

for(var h=0; h<arrayFeat.length;h++)
{    var ad=arrayFeat[h].attributes[sumCatch];
     if(arrayFeat[h+1])
{ var ad2=parseFloat(arrayFeat[h+1].attributes[sumCatch]);}
     var NumberChart=(maxDistC-ad)/parseFloat(cenDel);
     context.fillRect(LenX*h+30, NumberChart, 3, 3);context.lineWidth =1;context.beginPath();
context.moveTo(LenX*h+30, NumberChart);
if(ad2||ad2==0)
{var NumberChart2=(parseFloat(maxDistC)-parseFloat(ad2))/parseFloat(cenDel);context.lineTo(LenX*(h+1)+30, NumberChart2);};
context.stroke();}

}


function New_PostGIScsv()
{
VarPostGISfromCSV=1;
New_LayerTXT();
}
function New_PostGIS()
{
VarPostGISfromGML=1;
New_LayerGML();
VarPostGISfromGML=0;
}
function New_LayerPostGISfromGML()
{
var lines = [];
var headers;
var contents2;
var contents;
 if (fileZIP) {
 var r = new FileReader();
 r.onload = function(e) { 
 contents = e.target.result;
loadlayerGML2(contents);
 }
 r.readAsText(fileZIP);WaitWindow();
 } else { 
 alert("Ошибка загрузки файла");
 }
}
function loadlayerGML2(contents)
{var new_layer_GML;
if(VarPostGISfromCSV==0)
 {
var gmlFeatures;
var format;
 format = new OpenLayers.Format.GML({
 'extractStyles':true,
'extractAttributes':true,
 'internalProjection': new OpenLayers.Projection("EPSG:900913"),
 'externalProjection': new OpenLayers.Projection("EPSG:4326")
 });
var new_layer_GML = new OpenLayers.Layer.Vector(fileZIP.name.split('.')[0],{
renderers:["Canvas", "SVG", "VML"]});
var gmlFeatures=format.read(contents); 
new_layer_GML.addFeatures(gmlFeatures);
var new_style_layer= new OpenLayers.Style({
 pointRadius: 3,
 fillColor: "#FF9000",
 strokeColor: "#FF9000",
 strokeWidth: 1,
fillOpacity:1,
 strokeOpacity:1
 });
 var selStyle = new OpenLayers.Style({
 pointRadius: 5, 
 fillColor: "#ffaa00",
 strokeColor: "#00DDFF",
 strokeWidth:2,
fillOpacity:1,
 strokeOpacity:1
 }); 
new_layer_GML.styleMap=new OpenLayers.StyleMap({'default':new_style_layer,'select': selStyle});
var t=this.document.createElement('option');
t.value=new_layer_GML.name;
t.text=new_layer_GML.name;
this.document.getElementById("editL1").appendChild(t);
Export_to_shapefile=false;
if(document.getElementById("Exp_to_Shape").checked==true)
{Export_to_shapefile=true;}
new_layer_GML.setVisibility(true);
map.addLayer(new_layer_GML);
 }
if(VarPostGISfromCSV==1){new_layer_GML=PostGISLayerCSV; WaitWindow();};
var strGMLPostGIS='';
for (var a in new_layer_GML.features[0].attributes)
 {
var typeField='';
if(typeof(new_layer_GML.features[0].attributes[a])=="string"){typeField="java.lang.String"} 
else{typeField="java.lang.String"}; 
//if(new_layer_GML.features[0].attributes[a]=='')
if(isNaN(parseFloat(new_layer_GML.features[0].attributes[a])))
{for(var hjk=1;hjk<new_layer_GML.features.length;hjk++)
{if(new_layer_GML.features[hjk].attributes[a]==''){}else{
//if(typeof(new_layer_GML.features[hjk].attributes[a]*1)=="number"){typeField="java.lang.Float"}; 
if(!isNaN(parseFloat(new_layer_GML.features[hjk].attributes[a]))){typeField="java.lang.Float"}; 
//if(isNaN(new_layer_GML.features[hjk].attributes[a]*1)==true){typeField="java.lang.String"} ;break;}}
if(isNaN(parseFloat(new_layer_GML.features[hjk].attributes[a]))){typeField="java.lang.String"} ;break;}}
}else{
if(typeof(new_layer_GML.features[0].attributes[a]*1)=="number"){typeField="java.lang.Float"}; 
if(isNaN(new_layer_GML.features[0].attributes[a]*1)==true){typeField="java.lang.String"} ;}
strGMLPostGIS+='<attribute><name>'+a+'</name><nillable>true</nillable><binding>'+typeField+'</binding></attribute>';//alert(strGMLPostGIS);
}
for(var ty=0;ty<new_layer_GML.features.length;ty++)
{
new_layer_GML.features[ty].state=OpenLayers.State.INSERT;
}
var strTypeGeometryPostGIS='';
if(new_layer_GML.features[0].geometry.CLASS_NAME=="OpenLayers.Geometry.Point")
{strTypeGeometryPostGIS="com.vividsolutions.jts.geom.Point"}
if(new_layer_GML.features[0].geometry.CLASS_NAME=="OpenLayers.Geometry.LinearRing")
{strTypeGeometryPostGIS="com.vividsolutions.jts.geom.LinearRing"}
if(new_layer_GML.features[0].geometry.CLASS_NAME=="OpenLayers.Geometry.LineString")
{strTypeGeometryPostGIS="com.vividsolutions.jts.geom.LineString";}
if(new_layer_GML.features[0].geometry.CLASS_NAME=="OpenLayers.Geometry.MultiLineString")
{strTypeGeometryPostGIS="com.vividsolutions.jts.geom.MultiLineString";}
if(new_layer_GML.features[0].geometry.CLASS_NAME=="OpenLayers.Geometry.MultiPoint")
{strTypeGeometryPostGIS="com.vividsolutions.jts.geom.MultiPoint";}
if(new_layer_GML.features[0].geometry.CLASS_NAME=="OpenLayers.Geometry.MultiPolygon")
{strTypeGeometryPostGIS="com.vividsolutions.jts.geom.MultiPolygon";}
if(new_layer_GML.features[0].geometry.CLASS_NAME=="OpenLayers.Geometry.Polygon")
{strTypeGeometryPostGIS="com.vividsolutions.jts.geom.Polygon";}
var MINbottomArraybox=new_layer_GML.features[0].geometry.bounds.bottom;
var MINleftArraybox=new_layer_GML.features[0].geometry.bounds.left;
var MAXrightArraybox=new_layer_GML.features[0].geometry.bounds.right;
var MAXtopArraybox=new_layer_GML.features[0].geometry.bounds.top;
for(var sd=1;sd<new_layer_GML.features.length;sd++)
{
if(new_layer_GML.features[sd].geometry.bounds.bottom<MINbottomArraybox){MINbottomArraybox=new_layer_GML.features[sd].geometry.bounds.bottom}
if(new_layer_GML.features[sd].geometry.bounds.left<MINleftArraybox){MINleftArraybox=new_layer_GML.features[sd].geometry.bounds.left}
if(new_layer_GML.features[sd].geometry.bounds.right>MAXrightArraybox){MAXrightArraybox=new_layer_GML.features[sd].geometry.bounds.right}
if(new_layer_GML.features[sd].geometry.bounds.top>MAXtopArraybox){MAXtopArraybox=new_layer_GML.features[sd].geometry.bounds.top}
}
var newlayerGMLBounds=new OpenLayers.Bounds(MINleftArraybox,MINbottomArraybox,MAXrightArraybox,MAXtopArraybox);
var newlayerGMLBounds4326=newlayerGMLBounds.transform(map.getProjectionObject(),new OpenLayers.Projection("EPSG:4326"));
map.removeLayer(new_layer_GML);
var StrConnect=''; var StrConnect2=''; var StrConnect3='';
if(!document.getElementById("id_UseForAllPostGis"))
{StrConnect="/geoserver/rest/workspaces/webgis/datastores/postgis/featuretypes";StrConnect2="http://localhost:8080/data/webgis/curonian";StrConnect3='webgis';}
if(document.getElementById("id_UseForAllPostGis")&&document.getElementById("id_UseForAllPostGis").checked==false)
{StrConnect="/geoserver/rest/workspaces/"+GlobalUN+"/datastores/postgis/featuretypes";StrConnect2="http://localhost:8080/data/"+GlobalUN+"/"+GlobalUN; StrConnect3=GlobalUN;}
if(document.getElementById("id_UseForAllPostGis")&&document.getElementById("id_UseForAllPostGis").checked==true)
{StrConnect="/geoserver/rest/workspaces/webgis/datastores/postgis/featuretypes";StrConnect2="http://localhost:8080/data/webgis/curonian";StrConnect3='webgis';}
if(typeof(popup_new_fileGML)!=='undefined'){popup_new_fileGML.destroy();}
alert("Эта функция работает только в онлайн веб-версии OpenWebGIS")
 {return;}
var putRequest = OpenLayers.Request.POST({
url: StrConnect,
async:false,
data:'<featureType> <name>'+fileZIP.name.split(".")[0]+'</name> <nativeName>'+fileZIP.name.split(".")[0]+'</nativeName>'+
 '<title>'+fileZIP.name.split(".")[0]+'</title> <srs>EPSG:4326</srs>'+
'<latLonBoundingBox><minx>'+newlayerGMLBounds4326.left+'</minx><maxx>'+newlayerGMLBounds4326.right+'</maxx><miny>'+newlayerGMLBounds4326.bottom+'</miny><maxy>'+newlayerGMLBounds4326.top+'</maxy><crs>EPSG:4326</crs></latLonBoundingBox>'+
'<attributes> <attribute> <name>the_geom</name>'+'<nillable>true</nillable>'+
 '<binding>'+strTypeGeometryPostGIS+'</binding> </attribute> '+strGMLPostGIS+
'</attributes>'+
'</featureType>',
headers: {
 "Content-Type": "application/xml"
 },
failure: function (response) {
 alert("Error "+response.responseText);
 }
}); 
var defaultWFSProperty = {
 url: "/geoserver/wfs?",
 featureNS: StrConnect2,
 geometryName: "the_geom"
 };
 var styleL = new OpenLayers.Style({
 pointRadius: 3,
 fillColor: "#FF693F",
 strokeColor: "#666666",
 strokeWidth: 1,
 fillOpacity:1,
 strokeOpacity:1 });
 var SelectstyleL = new OpenLayers.Style({
 pointRadius: 5, 
 fillColor: "#ffaa00",
 strokeColor: "#00DDFF",
 strokeWidth:2,
 fillOpacity:1,
 strokeOpacity:1 });
var new_layer_GMLPostGIS= new OpenLayers.Layer.Vector(fileZIP.name.split('.')[0], {
 strategies: [new OpenLayers.Strategy.Fixed(), saveStrategy],
 visibility: false,styleMap: new OpenLayers.StyleMap({'default':styleL,'select':SelectstyleL}),
projection : new OpenLayers.Projection("EPSG:4326"),
 isBaseLayer: false, renderers:["Canvas", "SVG", "VML"],
 protocol: new OpenLayers.Protocol.WFS(OpenLayers.Util.applyDefaults({featureType: fileZIP.name.split('.')[0]}, defaultWFSProperty))
 });
new_layer_GMLPostGIS.features=new_layer_GML.features;
map.addLayer(new_layer_GMLPostGIS);
saveStrategy.layer=new_layer_GMLPostGIS;
 saveStrategy.events.register('success', saveStrategy, function(){if(popup_Wait){try{popup_Wait.destroy();}catch(e){};}});
rtt=saveStrategy;
saveStrategy.onCommit=function(){if(Export_to_shapefile==true){var myWinTable= open("/geoserver/"+StrConnect3+"/ows?service=WFS&version=1.0.0&request=GetFeature&typeName="+StrConnect3+":"+fileZIP.name.split('.')[0]+"&outputFormat=SHAPE-ZIP", "WindowExportShapefile",
 "width=900,height=500,status=no,toolbar=no,menubar=no,scrollbars=yes");}if(popup_Wait){try{popup_Wait.destroy();}catch(e){};}}
saveStrategy.save();
saveStrategy.onCommit=function(){};

}
function New_LayerTXT()
{
var htmlLayerTXT='';
htmlLayerTXT+='<a>Please select file:</a><br>'+
 '<input title="Select text file" type="file" id="file_idTXT"><br>'+
'<p> <button type=button onclick=OK_fileTXT()>OK</button></p>';
if(VarPostGISfromCSV==1)
{
var htmlLayerTXT=''; var dopStr='';
if(GlobalUN!=='')
{dopStr='<input type="checkbox" id="id_UseForAllPostGis" title="Если галочка не поставлена, то слой загрузится только в папку пользователя и будет доступен только ему." value="checkbox"/>Сделать слой общедоступным<br>';}
htmlLayerTXT+='<a>Please select file:</a><br>'+
 '<input title="Select text file" type="file" id="file_idTXT"><br>'+
dopStr+
'<input type="checkbox" id="Exp_to_Shape" title="Export result to Shapefile" value="checkbox"/>Export result to Shapefile<br>'+
'<p> <button type=button onclick=OK_fileTXT()>OK</button></p>';
}
popup_new_fileTXT = new OpenLayers.Popup.FramedCloud("NewFilePopupTXT",
 map.getCenter(),
 new OpenLayers.Size(400,400),
 htmlLayerTXT ,
 null, true, onPopupClose);
 map.addPopup(popup_new_fileTXT);
document.getElementById('file_idTXT').addEventListener('change', readSingleFileTXT, false);
}
function OK_fileTXT()
{
var htmlTextSep='';
htmlTextSep+='<a>Please select separation symbol in CSV file :</a><br>'+
 '<select id="sepTXTcsv_id"> '+
 '<option selected value=";">; semicolon</option>'+
'<option selected value=",">, comma</option>'+
'</select><br>'+
'<input type="checkbox" id="Id_KavikIsInFileWeb" value="checkbox"/>выберите если столбцы содержат кавычки(" ")<br>'+
'<p> <button type=button onclick=OK_fileTXT2()>OK</button></p>';
popup_new_SepSymTXT = new OpenLayers.Popup.FramedCloud("SepSymPopupTXT",
 map.getCenter(),
 new OpenLayers.Size(400,400),
 htmlTextSep ,
 null, true, onPopupClose);
 map.addPopup(popup_new_SepSymTXT);
}
function OK_fileTXT2()
{
var SepSym=document.getElementById("sepTXTcsv_id").value;
var checkPop=document.getElementById("Id_KavikIsInFileWeb").checked;
popup_new_SepSymTXT.destroy();
var lines = [];
var headers;
 if (fileZIP) {
 var r = new FileReader();
 r.onload = function(e) { 
 var contents = e.target.result;
 /* alert( "Got the file.n" 
 +"name: " + fileZIP.name + "n"
 +"type: " + fileZIP.type + "n"
 +"size: " + fileZIP.size + " bytesn"
 + "starts with: " + contents
 ); */
var allTextLines = contents.split(/\r\n|\n/);
 headers = allTextLines[0].split(SepSym);
 for (var i=1; i<allTextLines.length; i++) {
if(checkPop==true)
{var dataS = allTextLines[i].split('"');
if(dataS[1])
{var c=dataS[1].replace(/,/g,'a;=;a');
var dataSS=dataS[0]+c+dataS[2];}
if(dataS[1])
{var data = dataSS.split(SepSym);}
else
{var data = allTextLines[i].split(SepSym);}
}
else
{
 var data = allTextLines[i].split(SepSym);
}
 if (data.length == headers.length) {
 var tarr = []; 
 for (var j=0; j<headers.length; j++) {
 //tarr.push(headers[j]+"_:_"+data[j]);
tarr.push(headers[j]+"_:_"+data[j].replace(/a;=;a/g,','));
 }
 lines.push(tarr); contentsTXTfile=lines; 
 }
 }
Export_to_shapefile=false;if(document.getElementById("Exp_to_Shape")){if(document.getElementById("Exp_to_Shape").checked==true)
{Export_to_shapefile=true;}}
popup_new_fileTXT.hide();
var htmlTextLonLat='';
htmlTextLonLat+='<a>Please select longitude:</a><br>'+
 '<select id="longTXT_id"> '+
 '<option selected value="0">.</option>'+
'</select><br>'+
'<a>Please select latitude:</a><br>'+
 '<select id="latTXT_id"> '+
 '<option selected value="0">.</option>'+
'</select><br>'+
'<input type="checkbox" id="id_convertCoordCSV" title="if coordinates are in format ISO6709(DD.DDS\N\W\E), then they must be converted in number. Example: latitude=24.80S will be converted in latitude=-24.80" value="checkbox"/>Convert coordinate to number<br>'+
'<p> <button type=button onclick=OK_LonLatTXT()>OK</button></p>';
popup_LonLatTXT = new OpenLayers.Popup.FramedCloud("NewLonLatTXT",
 map.getCenter(),
 new OpenLayers.Size(400,400),
 htmlTextLonLat ,
 null, true, onPopupClose);
 map.addPopup(popup_LonLatTXT);
 for(var ab = 0; ab < headers.length; ab++ )
{var t=document.createElement('option');
t.value=headers[ab];
t.text=headers[ab];
document.getElementById("longTXT_id").appendChild(t);
}
 for(var ab = 0; ab < headers.length; ab++ )
{var t=document.createElement('option');
t.value=headers[ab];
t.text=headers[ab];
document.getElementById("latTXT_id").appendChild(t);
}
popup_LonLatTXT.updateSize();
document.getElementById("NewLonLatTXT").onmousedown=function(event){drags(event)};
document.getElementById("NewLonLatTXT").onmouseup=function(e){enddrag()};
 }
 r.readAsText(fileZIP);
 } else { 
 alert("Failed to load file");
 }
}
function OK_LonLatTXT()
{
var new_layer_TXT = new OpenLayers.Layer.Vector(fileZIP.name.split('.')[0],{renderers:["Canvas", "SVG", "VML"]});
 for(var ab = 0; ab < contentsTXTfile.length; ab++ )
{var x; var y;
for(var a = 0; a < contentsTXTfile[ab].length; a++ )
{ if (document.getElementById("longTXT_id").value==contentsTXTfile[ab][a].split('_:_')[0])
{ x=contentsTXTfile[ab][a].split('_:_')[1].replace(/,/g,".");
if(document.getElementById("id_convertCoordCSV").checked==true)
{var x1=x;if(x.split('W')[1]==''){x=x.split('W')[0]*parseInt(-1);}if(x1.split('E')[1]==''){x=x1.split('E')[0]}}
}
if (document.getElementById("latTXT_id").value==contentsTXTfile[ab][a].split('_:_')[0])
{ y=contentsTXTfile[ab][a].split('_:_')[1].replace(/,/g,".");
if(document.getElementById("id_convertCoordCSV").checked==true)
{var y1=y;if(y.split('S')[1]==''){y=y.split('S')[0]*parseInt(-1);}if(y1.split('N')[1]==''){y=y1.split('N')[0]}}
}
}//end for(var a = 0; a < contentsTXTfile[ab].length; a++ )
var new_pos=new OpenLayers.LonLat(x,y).transform(
new OpenLayers.Projection("EPSG:4326"),
map.getProjectionObject());
var new_lon=new_pos.lon;
var new_lat=new_pos.lat;
var first_point =new OpenLayers.Geometry.Point(new_lon, new_lat);
first_point= new OpenLayers.Feature.Vector(first_point);
new_layer_TXT.projection=new OpenLayers.Projection("EPSG:900913");
for(var a = 0; a < contentsTXTfile[ab].length; a++ )
{
first_point.attributes[contentsTXTfile[ab][a].split('_:_')[0]]=contentsTXTfile[ab][a].split('_:_')[1].replace(/,/g,".");
}
first_point.fid=new_layer_TXT.name+"."+ab;
new_layer_TXT.addFeatures(first_point);
}//end for(var ab = 0; ab < contentsTXTfile.length; ab++ )
var new_style_layer= new OpenLayers.Style({
 pointRadius: 3,
 fillColor: "#FF9000",
 strokeColor: "#FF9000",
 strokeWidth: 1,
fillOpacity:1,
 strokeOpacity:1
 });
 var selStyle = new OpenLayers.Style({
 pointRadius: 5, 
 fillColor: "#ffaa00",
 strokeColor: "#00DDFF",
 strokeWidth:2,
fillOpacity:1,
 strokeOpacity:1
 }); 
new_layer_TXT.styleMap=new OpenLayers.StyleMap({'default':new_style_layer,'select': selStyle});
map.addLayer(new_layer_TXT);
var t=this.document.createElement('option');
t.value=new_layer_TXT.name;
t.text=new_layer_TXT.name;
this.document.getElementById("editL1").appendChild(t);
popup_LonLatTXT.destroy();
if(VarPostGISfromCSV==1)
{PostGISLayerCSV=new_layer_TXT;loadlayerGML2();
VarPostGISfromCSV=0;}
popup_new_fileTXT.destroy();
}
function UploadTiffFile()
{
var htmlTextAsc='';
var dopStr='';
if(GlobalUN!=='')
{dopStr='<input type="checkbox" id="id_UseForAllTiff" title="Если галочка не поставлена, то слой загрузится только в папку пользователя и будет доступен только ему." value="checkbox"/>Сделать слой общедоступным<br>';}

htmlTextAsc+='<a>Please select file:</a><br>'+
 '<input title="Select GeoTiff file" type="file" id="file_idTiff"><br>'+
dopStr+
'<p> <button type=button onclick=OK_fileTiff()>OK</button></p>';

popup_new_fileTiff = new OpenLayers.Popup.FramedCloud("NewFilePopupTiff",
map.getCenter(),
new OpenLayers.Size(400,400),
htmlTextAsc ,
null, true, onPopupClose);
map.addPopup(popup_new_fileTiff);
document.getElementById("NewFilePopupTiff").onmousedown=function(event){drags(event)};
document.getElementById("NewFilePopupTiff").onmouseup=function(e){enddrag()};
document.getElementById('file_idTiff').addEventListener('change', readSingleFileTiff, false);
}
function OK_fileTiff()
{
nameDataS=fileZIP.name.split('.')[0]
var StrConnect='';
if(!document.getElementById("id_UseForAllTiff"))
{StrConnect='webgis';}
if(document.getElementById("id_UseForAllTiff")&&document.getElementById("id_UseForAllTiff").checked==false)
{StrConnect=GlobalUN;}
if(document.getElementById("id_UseForAllTiff")&&document.getElementById("id_UseForAllTiff").checked==true)
{StrConnect='webgis';}
alert("Эта функция работает только в онлайн веб-версии OpenWebGIS")
 {return;}
OpenLayers.Request.POST({
    url: "/geoserver/rest/workspaces/"+StrConnect+"/coveragestores?configure=all",
async: false,
data:'<coverageStore>'+
         '<name>'+nameDataS+'</name>'+
         '<enabled>true</enabled>'+
         '<type>GeoTIFF</type>'+
         '<url>file:data/'+StrConnect+'/'+nameDataS+'/'+nameDataS+'.tiff</url>'+
'<workspace>'+
    '<name>'+StrConnect+'</name>'+
  '</workspace>'+
         '</coverageStore>',
headers: {
        "Content-Type": "application/xml"
        }//,
//callback: alert ("it's OK2")
})
alert("Эта функция работает только в онлайн веб-версии OpenWebGIS")
 {return;}
var putRequest = OpenLayers.Request.PUT({
   url: "/geoserver/rest/workspaces/"+StrConnect+"/coveragestores/"+nameDataS+"/file.geotiff?configure=all",
async: false,
data: fileZIP,
headers: {
        "Content-Type": "image/tiff"
    },
callback: alert ("it's OK")
});

}
function UploadFileAsc()
{
var htmlTextAsc='';
var dopStr='';
if(GlobalUN!=='')
{dopStr='<input type="checkbox" id="id_UseForAllAsc" title="Если галочка не поставлена, то слой загрузится только в папку пользователя и будет доступен только ему." value="checkbox"/>Сделать слой общедоступным<br>';}
htmlTextAsc+='<a>Please select file:</a><br>'+
 '<input title="Select ArcGrid file" type="file" id="file_idAsc"><br>'+
dopStr+
'<p> <button type=button onclick=OK_fileAsc()>OK</button></p>';
popup_new_fileAsc = new OpenLayers.Popup.FramedCloud("NewFilePopup",
 map.getCenter(),
 new OpenLayers.Size(400,400),
 htmlTextAsc ,
 null, true, onPopupClose);
 map.addPopup(popup_new_fileAsc);
document.getElementById("NewFilePopup").onmousedown=function(event){drags(event)};
document.getElementById("NewFilePopup").onmouseup=function(e){enddrag()};
document.getElementById('file_idAsc').addEventListener('change', readSingleFileAsc, false);
}
function OK_fileAsc()
{nameDataS=fileZIP.name.split('.')[0]
var StrConnect='';
if(!document.getElementById("id_UseForAllAsc"))
{StrConnect='webgis';}
if(document.getElementById("id_UseForAllAsc")&&document.getElementById("id_UseForAllAsc").checked==false)
{StrConnect=GlobalUN;}
if(document.getElementById("id_UseForAllAsc")&&document.getElementById("id_UseForAllAsc").checked==true)
{StrConnect='webgis';}
alert("Эта функция работает только в онлайн веб-версии OpenWebGIS")
 {return;}
var putRequest = OpenLayers.Request.PUT({
 url: "/geoserver/rest/workspaces/"+StrConnect+"/coveragestores/"+nameDataS+"/file.arcgrid?configure=all",
async: false,
data: fileZIP,
headers: {
 "Content-Type": "application/xml",
'WWW-Authenticate': 'Basic realm="Authentication System"'
 },
callback: alert ("it's OK")
});
alert("Эта функция работает только в онлайн веб-версии OpenWebGIS")
 {return;}
setTimeout(OpenLayers.Request.DELETE({
 url: "/geoserver/rest/layers/"+nameDataS,
async: false
}),5000);
setTimeout(OpenLayers.Request.DELETE({
 url: "/geoserver/rest/workspaces/"+StrConnect+"/coveragestores/"+nameDataS+"/coverages/"+nameDataS,
async: false,
}), 14000);
setTimeout(OpenLayers.Request.DELETE({
 url: "/geoserver/rest/workspaces/"+StrConnect+"/coveragestores/"+nameDataS,
async: false,
}), 24000);
setTimeout(OpenLayers.Request.POST({
 url: "/geoserver/rest/workspaces/"+StrConnect+"/coveragestores?configure=all",
async: false,
data:'<coverageStore>'+
 '<name>'+nameDataS+'</name>'+
 '<enabled>true</enabled>'+
 '<type>ArcGrid</type>'+
 '<url>file:data/'+StrConnect+'/'+nameDataS+'/'+nameDataS+'.arcgrid</url>'+
'<workspace>'+
 '<name>'+StrConnect+'</name>'+
 '</workspace>'+
 '</coverageStore>',
headers: {
 "Content-Type": "application/xml"
 }
}), 36000);
alert("Эта функция работает только в онлайн веб-версии OpenWebGIS")
 {return;}
setTimeout(OpenLayers.Request.POST({
 url: " /geoserver/rest/workspaces/"+StrConnect+"/coveragestores/"+nameDataS+"/coverages",
async: false,
 data: 
"<coverage>"+
 "<name>"+nameDataS+"</name>"+
 "<title>"+nameDataS+"</title>"+
 "<abstract>"+nameDataS+"</abstract>"+
 "<nativeCRS>GEOGCS[&quot;WGS 84&quot;,DATUM[&quot;World Geodetic System 1984&quot;,SPHEROID[&quot;WGS 84&quot;,6378137.0, 298.257223563, "+" AUTHORITY[&quot;EPSG&quot;,&quot;7030&quot;]],AUTHORITY[&quot;EPSG&quot;,&quot;6326&quot;]],PRIMEM[&quot;Greenwich&quot;, 0.0, "+" AUTHORITY[&quot;EPSG&quot;,&quot;8901&quot;]],UNIT[&quot;degree&quot;, 0.017453292519943295],AXIS[&quot;Geodetic longitude&quot;, EAST],AXIS[&quot;Geodetic latitude&quot;, "+" NORTH],AUTHORITY[&quot;EPSG&quot;,&quot;4326&quot;]]</nativeCRS>"+
 "<srs>EPSG:4326</srs>"+
"<projectionPolicy>FORCE_DECLARED</projectionPolicy>"+
 "<supportedFormats>"+
" <string>GIF</string>"+
 " <string>PNG</string>"+
 " <string>TIFF</string>"+
 " <string>JPEG</string>"+
 "<string>GEOTIFF</string>"+
 "</supportedFormats>"+
 "<interpolationMethods>"+
 " <string>bilinear</string>"+
 "<string>bicubic</string>"+
 "</interpolationMethods>"+
 "<requestSRS>"+
 " <string>EPSG:4326</string>"+
 "</requestSRS>"+
 "<responseSRS>"+
 " <string>EPSG:4326</string>"+
 "</responseSRS> "+
"</coverage>",
headers: {
 "Content-Type": "application/xml"
 }
}), 44000);
popup_new_fileAsc.destroy();
}
function clickDivColor3d(elem)
{


var bbox = elem.getBoundingClientRect();
var body = document.body
var docElem = document.documentElement
 var scrollTop = window.pageYOffset || docElem.scrollTop || body.scrollTop
var scrollLeft = window.pageXOffset || docElem.scrollLeft || body.scrollLeft
var clientTop = docElem.clientTop || body.clientTop || 0
var clientLeft = docElem.clientLeft || body.clientLeft || 0
var topTop  = bbox.top +  scrollTop - clientTop
var leftLeft = bbox.left + scrollLeft - clientLeft
var DivEditeLeg=document.createElement("div");
DivEditeLeg.id="id_divEditeLegColor";
DivEditeLeg.innerHTML='<div id="id_divColorc" style="background:#97d9e0; color:#0000ff;width:384px;z-index: 1400;height:40px;position:absolute;left:'+Math.round(leftLeft+10)+'px;top:'+Math.round(topTop+10)+
'px;overflow:hidden; border: 1px solid black;"><img onclick="closeColor()" src="openlayers/theme/default/img/close.gif" style="position:relative; top:5px;float:right; cursor:pointer"><a style="position:relative; top:20px"></a><div id="paletteC"></div></div>';
if(!document.getElementById("id_divEditeLegColor"))
{body.appendChild(DivEditeLeg);drawPalette(elem); }

}
function closeColor()
{if(document.getElementById('id_divEditeLegColor'))
{document.getElementById('id_divEditeLegColor').parentNode.removeChild(document.getElementById('id_divEditeLegColor'));}
}
function drawPalette(elem) {var out = "";
	for (var i = 0; i < 360; i++) {
		out += "<div id='id_palettcolortable_"+i+"' onclick='selectColor(this);' style='background-color:" + HSLToRGB(i, 100, 100) + "'><\/div>";
	}	
	out += "<div id='id_palettcolortable_360' onclick='selectColor(this);' style='background-color:#FFFFFF;width:2px;'><\/div>";
out += "<div id='id_palettcolortable_361' onclick='selectColor(this);' style='background-color:#000000;width:2px;'><\/div>";
	document.getElementById("paletteC").innerHTML = out;


for(var i = 0; i < 362; i++)
{document.getElementById("id_palettcolortable_"+i).onclick=function(){var nelem=elem;selectColor(this,nelem);}}

}
function selectColor(div,nelem) {
	colorElemWin = div.style.backgroundColor;
	colorElemWin = rgbNormal(colorElemWin);
nelem.style.background=colorElemWin; 
nelem.tempColorGIS=colorElemWin;
}

function rgbNormal(color) {
color = color.toString();
var re = /rgb\((.*?)\)/i;
if(re.test(color)) {
compose = RegExp.$1.split(",");
var hex = ['0','1','2','3','4','5','6','7','8','9','A','B','C','D','E','F'];
var result = "#";	for (var i = 0; i < compose.length; i++) {
rgb = parseInt(compose[i]);result += hex[parseInt(rgb / 16)] + hex[rgb % 16];
}
return result;
} else return color;
}
function HSLToRGB(Hue, Saturation, Luminance) {
var R, G, B;
var nH, nS, nL;
var nF, nP, nQ, nT;
var lH;
if (Saturation > 0) {
nH = Hue / 60;nL = Luminance / 100;nS = Saturation / 100;

lH = parseInt(nH);	nF = nH - lH;nP = nL * (1 - nS);
nQ = nL * (1 - nS * nF);nT = nL * (1 - nS * (1 - nF));
switch (lH) {
case 0:
R = nL * 255;G = nT * 255;B = nP * 255;
break;
case 1:
R = nQ * 255;G = nL * 255;B = nP * 255;
break;
case 2:
R = nP * 255;G = nL * 255;B = nT * 255;
break;
case 3:
R = nP * 255;G = nQ * 255;B = nL * 255;
break;
case 4:
R = nT * 255;G = nP * 255;B = nL * 255;
break;
case 5:
R = nL * 255;G = nP * 255;B = nQ * 255;
break;
}
	} else {
		R = (Luminance * 255) / 100;	G = R;B = R;
	}
	return RGBToLongSafe(R, G, B);
}
	
function RGBToLongSafe(R, G, B) {
	R = parseInt(xLimit(R, 0, 255));
	G = parseInt(xLimit(G, 0, 255));
	B = parseInt(xLimit(B, 0, 255));
	return decToHex([R,G,B]);
}
function decToHex(decArray) {
	var hex = ['0','1','2','3','4','5','6','7','8','9','A','B','C','D','E','F'];
	var out = "#";	for (var i = 0; i < decArray.length; i++) {
		dec = parseInt(decArray[i]);out += hex[parseInt(dec / 16)] + hex[dec % 16];
	}
	return out;
}
function xLimit(Value, Lower, Higher) {
if (Value < Lower) Value = Lower;
if (Value > Higher) Value = Higher;
return Value;
}
function ChangeRasterclassification()
{
if(document.getElementById('Id_Chart3dClass_inputs'))
{document.getElementById('Id_Chart3dClass_inputs').parentNode.removeChild(document.getElementById('Id_Chart3dClass_inputs'));}
if(document.getElementById("Id_Chart3dClass_GIS"))
{var count=document.getElementById("Id_Chart3dClass_GIS").value;}
var arrayclass=document.createElement('div');
arrayclass.id="Id_Chart3dClass_inputs";
document.getElementById('id_Chart3dbutton_GIS').appendChild(arrayclass);
for(var i=0;i<count;i++)
      {
           var inputv=this.document.createElement('input');
inputv.type='text';
inputv.size="4";
inputv.id="IdChart3dClass_"+i+"_1";
var inputv2=this.document.createElement('input');
inputv2.type='text';
inputv2.size="4"
inputv2.id="IdChart3dClass_"+i+"_2";
var inputva=this.document.createElement('a');
 inputva.innerHTML="from ";
document.getElementById("Id_Chart3dClass_inputs").appendChild(inputva);
document.getElementById("Id_Chart3dClass_inputs").appendChild(inputv);
var inputva=this.document.createElement('a');
 inputva.innerHTML="to ";
document.getElementById("Id_Chart3dClass_inputs").appendChild(inputva);
document.getElementById("Id_Chart3dClass_inputs").appendChild(inputv2);
var inputDiv=this.document.createElement('div');
inputDiv.id="IdChart3dClassDivColor_"+i;
inputDiv.style.width="10px";
inputDiv.style.height="10px";
inputDiv.onclick=function(){clickDivColor3d(this);}
inputDiv.style.border="1px double black";
inputDiv.style.cursor="pointer";
inputDiv.style.background="#bbbbbb";

var inputvS=this.document.createElement('a');
 inputvS.innerHTML=" size ";
var inputvSize=this.document.createElement('input');
inputvSize.type='text';
inputvSize.size="3";
inputvSize.value="2";
inputvSize.id="IdChart3dLabSize_"+i;
document.getElementById("Id_Chart3dClass_inputs").appendChild(inputvS);
document.getElementById("Id_Chart3dClass_inputs").appendChild(inputvSize);
document.getElementById("Id_Chart3dClass_inputs").appendChild(inputDiv);
var br1=this.document.createElement('br');

document.getElementById("Id_Chart3dClass_inputs").appendChild(br1);
     }

}
function LegendAsc()
{var htmlTextLegArc=" ";
htmlTextLegArc+='<a>Please select only ArcGrid Layer:</a>'+
'<select id=leg_arc_id onchange="setMethod_Interp(value)">'+
 '<option selected value="1">.</option>'+
'</select><br>'+
'<input type="text" size="8" id="LegArc_nodata_from" value="0"/>nodata from<br>'+
'<input type="text" size="8" id="LegArc_nodata_to" value="0"/>nodata to<br>'+
'<select id=Id_Chart3dClass_GIS onchange="ChangeRasterclassification()">'+
'</select>number of classification<br>'+
'<div id="id_Chart3dbutton_GIS"></div><br>'+
'<p> <button type=button onclick=OK_Legend_Arc()>OK</button></p>';

popup_leg_arc = new OpenLayers.Popup.FramedCloud("InterpolationPopup1",
                             map.getCenter(),
                             new OpenLayers.Size(400,400),
                           htmlTextLegArc ,
                             null, true, onPopupClose);

    map.addPopup(popup_leg_arc);  
document.getElementById("InterpolationPopup1").onmousedown=function(event){drags(event)};
document.getElementById("InterpolationPopup1").onmouseup=function(e){enddrag()};
for(var ii=0; ii<=20;ii++)
{
  var tt2=document.createElement('option');tt2.value=ii;tt2.text=ii;
document.getElementById("Id_Chart3dClass_GIS").appendChild(tt2);
}


   var mLayers=map.layers;
         for(var ab = 0; ab < mLayers.length; ab++ )
{
 if(mLayers[ab].CLASS_NAME=="OpenLayers.Layer.WMS"&&mLayers[ab].url=="/geoserver/wms")
   { var t=document.createElement('option');
    t.value=mLayers[ab].name;
    t.text=mLayers[ab].name;
    document.getElementById("leg_arc_id").appendChild(t);}

}
popup_leg_arc.autoSize=true;
popup_leg_arc.updateSize();
}

function OK_Legend_Arc()
{ 


var LegArc_from_value=0;
var LegArc_to_value=1;
//var LegArc_class=document.getElementById("LegArc_class").value;
var LegArc_class=4;
var count_class_plus=parseFloat((LegArc_to_value-LegArc_from_value)/LegArc_class);
var ColorString='';
var start_LegArc_from_value=parseFloat(LegArc_from_value);

//alert(parseInt(204, 10).toString(16));
var r_color=254;255
var g_color=255;0
var b_color=255;0
r_color1=parseInt(r_color, 10).toString(16); 
g_color1=parseInt(g_color, 10).toString(16);
b_color1=parseInt(b_color, 10).toString(16);
if(parseFloat(start_LegArc_from_value).toFixed(3)<=parseFloat(document.getElementById("LegArc_nodata_to").value).toFixed(3)&&parseFloat(start_LegArc_from_value).toFixed(3)>=parseFloat(document.getElementById("LegArc_nodata_from").value).toFixed(3))
{ColorString+='<ColorMapEntry color="#0'+r_color1+g_color1+b_color1+'" quantity="'+parseFloat(start_LegArc_from_value).toFixed(3)+'" label="'+parseFloat(start_LegArc_from_value).toFixed(3)+'" opacity="0"'+'/>'}
else
{ColorString+='<ColorMapEntry color="#0'+r_color1+g_color1+b_color1+'" quantity="'+parseFloat(start_LegArc_from_value).toFixed(3)+'" label="'+parseFloat(start_LegArc_from_value).toFixed(3)+'"/>'}
var LegArc_class=document.getElementById("Id_Chart3dClass_GIS").value;
for(var i=0; i<LegArc_class; ++i) 
{   
var r_color2=r_color+Math.round(0.5*((i+1)/LegArc_class));
var g_color2=g_color-Math.round(255*((i+1)/LegArc_class)); 
var b_color2=b_color-Math.round(255*((i+1)/LegArc_class));
var F_color=''+parseInt(r_color2, 10).toString(16)+''+parseInt(g_color2, 10).toString(16)+''+parseInt(b_color2, 10).toString(16); 
start_LegArc_from_value=start_LegArc_from_value+count_class_plus 
if(parseFloat(start_LegArc_from_value).toFixed(3)<=parseFloat(document.getElementById("LegArc_nodata_to").value).toFixed(3)&&parseFloat(start_LegArc_from_value).toFixed(3)>=parseFloat(document.getElementById("LegArc_nodata_from").value).toFixed(3))
{ColorString+='<ColorMapEntry color="#'+F_color+'" quantity="'+parseFloat(start_LegArc_from_value).toFixed(3)+'" label="'+parseFloat(start_LegArc_from_value).toFixed(3)+'" opacity="0"'+'/>'}
else
{var val1=document.getElementById("IdChart3dClass_"+i+"_2").value;
if(!document.getElementById("IdChart3dClassDivColor_"+i).tempColorGIS)
{document.getElementById("IdChart3dClassDivColor_"+i).tempColorGIS="#bbbbbb";}
var col1=document.getElementById("IdChart3dClassDivColor_"+i).tempColorGIS;
ColorString+='<ColorMapEntry color="'+col1+'" quantity="'+parseFloat(val1).toFixed(3)+'" label="'+parseFloat(val1).toFixed(3)+'"/>'}
}
var ArcLeg_Name;
var Legend_Arc_layer=document.getElementById("leg_arc_id").value
var mLayers=map.layers;
         for(var ab = 0; ab < mLayers.length; ab++ )
        {
           if(mLayers[ab].name==Legend_Arc_layer) 
              {ArcLeg_Name=mLayers[ab].params.LAYERS}
                }
//alert(ColorString);
var sld_arc='<?xml version="1.0" encoding="ISO-8859-1"?>'+
'<StyledLayerDescriptor version="1.0.0" xmlns="http://www.opengis.net/sld" xmlns:ogc="http://www.opengis.net/ogc"'+
 ' xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"'+
 ' xsi:schemaLocation="http://www.opengis.net/sld http://schemas.opengis.net/sld/1.0.0/StyledLayerDescriptor.xsd">'+
  '<NamedLayer>'+
    '<Name>'+ArcLeg_Name+'</Name>'+
    '<UserStyle>'+
      '<Name>dem</Name>'+
     ' <Title>Simple DEM style</Title>'+
      '<Abstract>Classic elevation color progression</Abstract>'+
      '<FeatureTypeStyle>'+
        '<Rule>'+
        '  <RasterSymbolizer>'+
         '   <Opacity>0.6</Opacity>'+
                     '<ColorMap type="ramp" >'+
                     ColorString+
               //'<ColorMapEntry color="#FFFFFF" quantity="0" label="nodata" opacity="0"/>'+
               //'<ColorMapEntry color="#FFFFFF" quantity="0.02" label="nodata" opacity="0"/>'+
               //'<ColorMapEntry color="#4444FF" quantity=".1" label="nodata"/>'+
                //'<ColorMapEntry color="#FF0000" quantity=".5" label="values" />'+
               //'<ColorMapEntry color="#FFFF00" quantity="1.0" label="values" />'+
            '</ColorMap>'+
         ' </RasterSymbolizer>'+
       ' </Rule>'+
     ' </FeatureTypeStyle>'+
    '</UserStyle>'+
 ' </NamedLayer>'+
'</StyledLayerDescriptor>';

var Legend_Arc_layer=document.getElementById("leg_arc_id").value
var mLayers=map.layers;
         for(var ab = 0; ab < mLayers.length; ab++ )
        {
           if(mLayers[ab].name==Legend_Arc_layer) 
              {rtt=mLayers[ab];mLayers[ab].params.SLD_BODY=sld_arc;mLayers[ab].tileOptions={maxGetUrlLength: 20},mLayers[ab].redraw();}


           }
popup_leg_arc.destroy();

}
function Interpolation()
{if(this.document.getElementById("editL1").value=="0")
{alert ("выберите название слоя в списке 'Редактируемый слой'");}
else
 { 

var bbox = document.getElementById("map").getBoundingClientRect();
 var body = document.body; var docElem = document.documentElement; var scrollTop = window.pageYOffset || docElem.scrollTop || body.scrollTop;
 var scrollLeft = window.pageXOffset || docElem.scrollLeft || body.scrollLeft; var clientTop = docElem.clientTop || body.clientTop || 0; var clientLeft = docElem.clientLeft || body.clientLeft || 0; var topTop = bbox.top + scrollTop - clientTop; var leftLeft = bbox.left + scrollLeft - clientLeft;
var DivEditeLeg=document.createElement("div");DivEditeLeg.id="InterpolationPopupF";DivEditeLeg.className="id_divRoutLegMain";
DivEditeLeg.style.position="relative";
DivEditeLeg.innerHTML='<div id="id_divHeatInterMainwg_Leg" style="background:#ffffff; color:#0000ff;z-index: 1400;position:absolute;left:'+Math.round(leftLeft+50)+'px;top:'+Math.round(topTop-180)+
'px;overflow:hidden; border: 1px solid black;"><img onclick="closeWearherLegendWin(this)" src="openlayers/theme/default/img/close.gif" style="position:relative; top:10px;float:right; cursor:pointer"><a style="position:relative; top:20px"></a>'+
'<a style="font-size: 9px;">Вы можете перемещать это окно если щёлкните по пункту меню: Интерфейс->переключить режим интерфейса</a><br>'+
'<a>Выберите метод:</a>'+
'<select id=interp_method_id >'+
 '<option value="3">Heatmap</option>'+
'<option value="1">Heatmap (additional)</option>'+
'<option value="4">Inverse Distance Weighting (IDW)</option>'+
//'<option value="5">Kriging</option>'+
'<option value="2">Barnes Surface</option>'+
'</select><br>'+
'<p> <button type=button onclick=OK_Interpolation_First()>OK</button></p>';
'</div>';
if(!document.getElementById("InterpolationPopupF"))
{body.appendChild(DivEditeLeg); 
document.getElementById("InterpolationPopupF").onmousedown=function(event){drags(event)};
document.getElementById("InterpolationPopupF").onmouseup=function(e){enddrag()};
}  }
}
function ContourGrid()
 { 
 var htmlTextContGrid=" ";
htmlTextContGrid+='<a>Please select only ArcGrid Layer:</a>'+
'<select id=ContGrid_id >'+
 '<option selected value="0">.</option></select>'+
'<p> <button type=button onclick=OK_ContourGrid()>OK</button></p>';
popupContour_Grid = new OpenLayers.Popup.FramedCloud("ContGridPopup",
 map.getCenter(),
 new OpenLayers.Size(500,500),
 htmlTextContGrid,
 null, true, onPopupClose);
 map.addPopup(popupContour_Grid);
document.getElementById("ContGridPopup").onmousedown=function(event){drags(event)};
document.getElementById("ContGridPopup").onmouseup=function(e){enddrag()};
var mLayers=map.layers;
 for(var ab = 0; ab < mLayers.length; ab++ )
{var t=document.createElement('option');
t.value=mLayers[ab].name;
t.text=mLayers[ab].name;
document.getElementById("ContGrid_id").appendChild(t);
}
popupContour_Grid.autoSize=true;
popupContour_Grid.updateSize();
 }
 function OK_ContourGrid()
 {
var Contour_Arc_layer=document.getElementById("ContGrid_id").value;
var ContLeg_Name;
var mLayers=map.layers;
 for(var ab = 0; ab < mLayers.length; ab++ )
 {
 if(mLayers[ab].name==Contour_Arc_layer) 
 {ContLeg_Name=mLayers[ab].params.LAYERS;}
 }
var wmsL = new OpenLayers.Format.WMSCapabilities();
alert("Эта функция работает только в онлайн веб-версии OpenWebGIS")
 {return;}
OpenLayers.Request.GET({
url:'/geoserver/wms?'+'SERVICE=WMS&request=GetCapabilities',
success: function(e){
var response = wmsL.read(e.responseText);
var capability = response.capability;
for (var i=0, len=capability.layers.length; i<len; i++) { 
 var layerObj = capability.layers[i];
if(layerObj.name==ContLeg_Name)
{ 
abstractWMS=layerObj.abstract;
 InterInterpBB=layerObj.llbbox;
}
}
}
});
 var htmlTextContGrid2=" ";
 htmlTextContGrid2+=
'<input type="text" size="8" id="pixelContour_Grid" value="10"/>pixel_per_cell<br>'+
'<input type="text" size="8" id="IntervalContour_Grid" value="10"/>Interval<br>'+
'<a><font size=2>before loading resulted shapefile to WebGis you must rename it, </font><a><br><a><font size=2>because its default name is the name of existent arcgrid layer</font><a><br>'+
'<p> <button type=button onclick=OK_ContourGrid_Final()>OK</button></p>';
popupContour_Grid2 = new OpenLayers.Popup.FramedCloud("ContGridPopup2",
 map.getCenter(),
 new OpenLayers.Size(500,500),
 htmlTextContGrid2,
 null, true, onPopupClose);
 map.addPopup(popupContour_Grid2);
document.getElementById("ContGridPopup2").onmousedown=function(event){drags(event)};
document.getElementById("ContGridPopup2").onmouseup=function(e){enddrag()};
popupContour_Grid2.autoSize=true;
popupContour_Grid2.updateSize();
popupContour_Grid.hide();
 }
function OK_ContourGrid_Final()
 {
var Contour_Arc_layer=document.getElementById("ContGrid_id").value;
var ContLeg_Name;
var mLayers=map.layers;
 for(var ab = 0; ab < mLayers.length; ab++ )
 {
 if(mLayers[ab].name==Contour_Arc_layer) 
 {ContLeg_Name=mLayers[ab].params.LAYERS}
 }
popupContour_Grid.destroy();
var strUnion="'form'";
var StrinContour='<html><body onload="document.getElementById('+strUnion+').submit();return false;">'+
'<form id="form" action="../geoserver/TestWfsPost" method="post"><div style="width:0px;height:0px;position:absolute;left:-100px;top:-100px;overflow:hidden"><input type="hidden" name="form_hf_0" id="form_hf_0" /></div>'+
 '<input type="hidden" name="url" value="http://localhost:8080/geoserver/ows?strict=true"/>'+
 '<textarea style="visibility:hidden" name="body">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;'+
'&lt;wps:Execute version=&quot;1.0.0&quot; service=&quot;WPS&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xmlns=&quot;http://www.opengis.net/wps/1.0.0&quot; xmlns:wfs=&quot;http://www.opengis.net/wfs&quot; xmlns:wps=&quot;http://www.opengis.net/wps/1.0.0&quot; xmlns:ows=&quot;http://www.opengis.net/ows/1.1&quot; xmlns:gml=&quot;http://www.opengis.net/gml&quot; xmlns:ogc=&quot;http://www.opengis.net/ogc&quot; xmlns:wcs=&quot;http://www.opengis.net/wcs/1.1.1&quot; xmlns:xlink=&quot;http://www.w3.org/1999/xlink&quot; xsi:schemaLocation=&quot;http://www.opengis.net/wps/1.0.0 http://schemas.opengis.net/wps/1.0.0/wpsAll.xsd&quot;&gt;'+
 '&lt;ows:Identifier&gt;gs:Contour&lt;/ows:Identifier&gt;'+
 '&lt;wps:DataInputs&gt;'+
 '&lt;wps:Input&gt;'+
 '&lt;ows:Identifier&gt;data&lt;/ows:Identifier&gt;'+
 ' &lt;wps:Reference mimeType=&quot;image/tiff&quot; xlink:href=&quot;http://geoserver/wcs&quot; method=&quot;POST&quot;&gt;'+
 ' &lt;wps:Body&gt;'+
 ' &lt;wcs:GetCoverage service=&quot;WCS&quot; version=&quot;1.1.1&quot;&gt;'+
 '&lt;ows:Identifier&gt;'+ContLeg_Name+'&lt;/ows:Identifier&gt;'+
 '&lt;wcs:DomainSubset&gt;'+
 '&lt;gml:BoundingBox crs=&quot;http://www.opengis.net/gml/srs/epsg.xml#404000&quot;&gt;'+
 '&lt;ows:LowerCorner&gt;'+InterInterpBB[0]+' '+InterInterpBB[1]+'&lt;/ows:LowerCorner&gt;'+
 ' &lt;ows:UpperCorner&gt;'+InterInterpBB[2]+' '+InterInterpBB[3]+'&lt;/ows:UpperCorner&gt;'+
 '&lt;/gml:BoundingBox&gt;'+
 '&lt;/wcs:DomainSubset&gt;'+
 '&lt;wcs:Output format=&quot;image/tiff&quot;/&gt;'+
 '&lt;/wcs:GetCoverage&gt;'+
 '&lt;/wps:Body&gt;'+
 '&lt;/wps:Reference&gt;'+
 '&lt;/wps:Input&gt;'+
 '&lt;wps:Input&gt;'+
 '&lt;ows:Identifier&gt;band&lt;/ows:Identifier&gt;'+
 '&lt;wps:Data&gt;'+
 '&lt;wps:LiteralData&gt;GRAY_INDEX&lt;/wps:LiteralData&gt;'+
 '&lt;/wps:Data&gt;'+
 '&lt;/wps:Input&gt;'+
 '&lt;wps:Input&gt;'+
 '&lt;ows:Identifier&gt;interval&lt;/ows:Identifier&gt;'+
 '&lt;wps:Data&gt;'+
 '&lt;wps:LiteralData&gt;'+document.getElementById("IntervalContour_Grid").value+'&lt;/wps:LiteralData&gt;'+
 '&lt;/wps:Data&gt;'+
 '&lt;/wps:Input&gt;'+
 '&lt;wps:Input&gt;'+
 '&lt;ows:Identifier&gt;simplify&lt;/ows:Identifier&gt;'+
 '&lt;wps:Data&gt;'+
 '&lt;wps:LiteralData&gt;true&lt;/wps:LiteralData&gt;'+
 '&lt;/wps:Data&gt;'+
 '&lt;/wps:Input&gt;'+
 '&lt;/wps:DataInputs&gt;'+
 '&lt;wps:ResponseForm&gt;'+
 '&lt;wps:RawDataOutput mimeType=&quot;application/zip&quot;&gt;'+
 '&lt;ows:Identifier&gt;result&lt;/ows:Identifier&gt;'+
 '&lt;/wps:RawDataOutput&gt;'+
 '&lt;/wps:ResponseForm&gt;'+
'&lt;/wps:Execute&gt;'+
'</textarea>'+
 '<input type="hidden" name="username" value=""/>'+
 ' <input type="hidden" name="password" value=""/>'+
'</form>'+
'<div>'+
 '<span>Loading............</span>'+
'</div>'+
'</body>'+
'</html>';
var myWinInter=open("", "displayWindow","width=400,height=300,status=no,toolbar=no,menubar=no");
myWinInter.document.open();
myWinInter.document.write(StrinContour);
myWinInter.document.close();
popupContour_Grid2.destroy();
 }
function Contour()
{ if(this.document.getElementById("editL1").value=="0")
{alert ("Please select name of Layer in combobox 'Editable Layer'");}
else
 { 
if(edilayerMainLayer.features.length==0){alert('Layer is not activated.Please activate Layer (click on checkbox near name of Layer) and reopen interpolation window. Or it may be other Layer error');return;}
var htmlTextCont=" ";
var valueName=edilayerMainLayer.name+"_Contour";
htmlTextCont+='<a>Field for isoline:</a>'+
'<select id=interp_idC onchange="setField_Interp(value)">'+
 '<option selected value="0">.</option>'+
'</select><br>'+'<li> <a id="MinimumValueLayerInter">Minimum:</a>'+
'</li><br><li> <a id="MaximumValueLayerInter">Maximum:</a></li><br>'+
'<a>Scale for interpolation:</a>'+
'<select id=interp_id_scale title="Length scale for the interpolation, in units of the source data CRS" onchange="setScale_Interp(value)">'+
 '<option selected value="0">.</option></select><br>'+
'<input type="text" size="8" id="pixelContour_inter" value="10"/>pixel_per_cell<br>'+
'<input type="text" size="8" id="IntervalContour_inter" value="10"/>Interval<br>'+
'<input type="text" size="15" id="Id_InterlayerNameAtlC" value="'+valueName+'"/>name new Layer<br>'+
'<input type="text" title="This parameter is a number of columns of raster(arcgrid). It is used to interpolate point layer to raster before isoline calculating " size="8" id="Count_Col2" value="300"/>number of columns(important if you want to get Vector layer)<br>'+
'<input type="checkbox" id="ContVect" style="display:none" title="click here to create contour as vector(WFS) layer. In other case WMS layer will be created " value="checkbox"/><a id="aContVect" style="display:none"><font size="2">create Contour as vector(WFS) layer</font></a><br>'+
'<textarea id="ContVectTA" title="Alert: IN THIS VERSION SYSTEM IT DOES NOT WORK. Insert here Geometry delineating the region of interest. Select feature(only Polygon), then click field).This option not used for WMS layer(only if you want to create Vector Layer of isoline)" rows="1" cols="25" name="text" style="display:none"></textarea><a id="aaContVect" style="display:none">Geometry delineating the region of interest. Select feature(line or polygon), then click field)</a><br>'+
'<p> <button type=button onclick=OK_Contour()>OK</button></p>';
popupContour_inter = new OpenLayers.Popup.FramedCloud("InterpolationPopupC",
 map.getCenter(),
 new OpenLayers.Size(500,500),
 htmlTextCont,
 null, true, onPopupClose);
 map.addPopup(popupContour_inter);
document.getElementById("ContVectTA").onclick = function () {
 if (edilayerMainLayer.selectedFeatures.length) {
this.value = new OpenLayers.Format.WKT().write(edilayerMainLayer.selectedFeatures[0] );}
}
if(edilayerMainLayer.options.protocol)
{document.getElementById("ContVect").style.display='block';document.getElementById("aaContVect").style.display='block';document.getElementById("ContVectTA").style.display='block';document.getElementById("aContVect").style.display='block';}
if(!edilayerMainLayer.options.protocol)
{document.getElementById("ContVectTA").style.display='block';document.getElementById("aaContVect").style.display='block';}
var WFSLayerList;
 for (var a in edilayerMainLayer.features[0].attributes)
{var t=document.createElement('option');
 t.value=a;
 t.text=a;
 document.getElementById("interp_idC").appendChild(t); }

var new_layer_n = new OpenLayers.Layer.Vector("fg");
var box_extents = [ [21.08, 55.19] ];
var new_pos=new OpenLayers.LonLat(21.08,55.19).transform(
new OpenLayers.Projection("EPSG:4326"),
map.getProjectionObject());
var new_lon=new_pos.lon;
var new_lat=new_pos.lat;
var first_point =new OpenLayers.Geometry.Point(new_lon, new_lat);
first_point= new OpenLayers.Feature.Vector(first_point);
new_layer_n.projection=new OpenLayers.Projection("EPSG:900913");
new_layer_n.addFeatures(first_point);
map.addLayer(new_layer_n);
for(var i=0; i<new_layer_n.scales.length; ++i) { 
 var t=document.createElement('option');
t.value=new_layer_n.scales[i];
t.text=new_layer_n.scales[i];
document.getElementById("interp_id_scale").appendChild(t);
 }
map.removeLayer(new_layer_n)
/*for(var i=0; i<edilayerMainLayer.scales.length; ++i) { 
 var t=document.createElement('option');
t.value=edilayerMainLayer.scales[i];
t.text=edilayerMainLayer.scales[i];
document.getElementById("interp_id_scale").appendChild(t);
 }*/
popupContour_inter.autoSize=true;
popupContour_inter.updateSize();
}
}
function OK_Contour()
{
var Interval_contour=document.getElementById("IntervalContour_inter").value; 
var interp_scale=document.getElementById("interp_id_scale").value;
var pixelContour_inter=document.getElementById("pixelContour_inter").value;
if(!edilayerMainLayer.options.protocol||document.getElementById("ContVect").checked==true){
var FeaturesForStat=[];
popup_interW = new OpenLayers.Popup.FramedCloud("InterpolationPopup",
 map.getCenter(), new OpenLayers.Size(100,100), "Please wait.." , null, true, onPopupClose);
 map.addPopup(popup_interW);
for (var i=0; i<edilayerMainLayer.features.length; i++)
{if(isNaN(parseFloat(edilayerMainLayer.features[i].attributes[field_interpolation_Main]))==false)
{FeaturesForStat.push(edilayerMainLayer.features[i]);FeaturesForStat[FeaturesForStat.length-1].attributes[field_interpolation_Main]=parseFloat(edilayerMainLayer.features[i].attributes[field_interpolation_Main]);}
 }
if(FeaturesForStat.length==0){alert("selected field is not numeric. The total number of elements in the layer:"+edilayerMainLayer.features.length); if(popupContour_inter){popupContour_inter.destroy();};return;}
var crcformat = new OpenLayers.Format.GeoJSON({}).createCRSObject(edilayerMainLayer.features[0]);
var format = new OpenLayers.Format.GeoJSON({});
var jsonstring = format.write(FeaturesForStat);
var DopStr='}],"crs":{ "type":"name","properties":{"name":"EPSG:900913"}}}';
var formatExp = new OpenLayers.Format.GeoJSON({'internalProjection': new OpenLayers.Projection("EPSG:900913"),
'externalProjection': new OpenLayers.Projection("EPSG:4326")
});
var DopStr2='}],"crs":{ "type":"name","properties":{"name":"EPSG:4326"}}}';
var jsonstringExp = formatExp.write(FeaturesForStat);
var NewjsonstringExp = jsonstringExp.replace(/}]}/,DopStr2);
 jsonstringExp=NewjsonstringExp;
jsonstringExpReadyExport='![CDATA['+jsonstringExp+']]'

var Newjsonstring = jsonstring.replace(/}]}/,DopStr);
jsonstring=Newjsonstring;
InterInterpBB=[];
InterInterpBBExp=[];
var minDistC = parseFloat(edilayerMainLayer.features[0].geometry.y);
 var maxDistC = parseFloat(minDistC) ;
 for (ia = 1; ia < edilayerMainLayer.features.length; ++ia) { var NumSS=edilayerMainLayer.features[ia].geometry.y;
 if (NumSS>parseFloat(maxDistC) ) {maxDistC = parseFloat(NumSS);}
 if( NumSS<parseFloat(minDistC) ) {minDistC = parseFloat(NumSS);}
 }
var minY=minDistC;
var maxY=maxDistC;
var minDistC = parseFloat(edilayerMainLayer.features[0].geometry.x);
 var maxDistC = parseFloat(minDistC) ;
 for (ia = 1; ia < edilayerMainLayer.features.length; ++ia) { var NumSS=edilayerMainLayer.features[ia].geometry.x;
 if (NumSS>parseFloat(maxDistC) ){ maxDistC = parseFloat(NumSS);}
 if( NumSS<parseFloat(minDistC) ) {minDistC = parseFloat(NumSS);}
 }
var minX=minDistC;
var maxX=maxDistC;
InterInterpBB.push(minX);
InterInterpBB.push(minY);
InterInterpBB.push(maxX);
InterInterpBB.push(maxY);
var pos=new OpenLayers.LonLat(minX, minY).transform(map.getProjectionObject(),new OpenLayers.Projection("EPSG:4326"));
var pos2=new OpenLayers.LonLat(maxX, maxY).transform(map.getProjectionObject(),new OpenLayers.Projection("EPSG:4326"));
InterInterpBBExp.push(pos.lon);
InterInterpBBExp.push(pos.lat);
InterInterpBBExp.push(pos2.lon);
InterInterpBBExp.push(pos2.lat);
var Count_Col2=document.getElementById("Count_Col2").value;
var t1=parseFloat((InterInterpBB[2]-InterInterpBB[0])/Count_Col2);
var CountRowst2=parseInt((InterInterpBB[3]-InterInterpBB[1])/t1);
var resulArcGridnotInGeoserver=0;
var dopStrC='';
if(document.getElementById("ContVectTA").value!=='')
{dopStrC='<wps:Input><ows:Identifier>roi</ows:Identifier>'+
'<wps:Data><wps:ComplexData mimeType="application/wkt"><![CDATA['+document.getElementById("ContVectTA").value+']]></wps:ComplexData>'+
'</wps:Data>'+'</wps:Input>';
}
var WPSContour='<?xml version="1.0" encoding="UTF-8"?>'+
'<wps:Execute version="1.0.0" service="WPS" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" '+
'xmlns="http://www.opengis.net/wps/1.0.0" xmlns:wfs="http://www.opengis.net/wfs" '+
'xmlns:wps="http://www.opengis.net/wps/1.0.0" xmlns:ows="http://www.opengis.net/ows/1.1" '+
'xmlns:gml="http://www.opengis.net/gml" '+
'xmlns:ogc="http://www.opengis.net/ogc" '+
'xmlns:wcs="http://www.opengis.net/wcs/1.1.1" '+
'xmlns:xlink="http://www.w3.org/1999/xlink" xsi:schemaLocation="http://www.opengis.net/wps/1.0.0 http://schemas.opengis.net/wps/1.0.0/wpsAll.xsd">'+
'<ows:Identifier>gs:BarnesSurface</ows:Identifier>'+
'<wps:DataInputs>'+'<wps:Input>'+'<ows:Identifier>data</ows:Identifier>'+
'<wps:Data>'+'<wps:ComplexData mimeType="application/json"><![CDATA['+jsonstring+']]></wps:ComplexData>'+
' </wps:Data>'+'</wps:Input>'+'<wps:Input>'+
'<ows:Identifier>valueAttr</ows:Identifier>'+'<wps:Data>'+'<wps:LiteralData>'+field_interpolation_Main+'</wps:LiteralData>'+
'</wps:Data>'+'</wps:Input>'+'<wps:Input>'+'<ows:Identifier>scale</ows:Identifier>'+
'<wps:Data>'+'<wps:LiteralData>'+parseFloat(interp_scale*1000000)+'</wps:LiteralData>'+
'</wps:Data>'+'</wps:Input>'+'<wps:Input>'+
'<ows:Identifier>noDataValue</ows:Identifier>'+
'<wps:Data>'+'<wps:LiteralData>-999</wps:LiteralData>'+
'</wps:Data>'+'</wps:Input>'+'<wps:Input>'+'<ows:Identifier>pixelsPerCell</ows:Identifier>'+
'<wps:Data>'+'<wps:LiteralData>'+pixelContour_inter+'</wps:LiteralData>'+
'</wps:Data>'+'</wps:Input>'+'<wps:Input>'+'<ows:Identifier>outputBBOX</ows:Identifier>'+
'<wps:Data>'+'<wps:BoundingBoxData crs="EPSG:900913" dimensions="2">'+
'<ows:LowerCorner>'+InterInterpBB[0]+' '+InterInterpBB[1]+'</ows:LowerCorner>'+
'<ows:UpperCorner>'+InterInterpBB[2]+' '+InterInterpBB[3]+'</ows:UpperCorner>'+
'</wps:BoundingBoxData>'+'</wps:Data>'+'</wps:Input>'+'<wps:Input>'+'<ows:Identifier>outputWidth</ows:Identifier>'+
'<wps:Data>'+'<wps:LiteralData>'+CountRowst2+'</wps:LiteralData>'+
'</wps:Data>'+'</wps:Input>'+'<wps:Input>'+
'<ows:Identifier>outputHeight</ows:Identifier>'+
'<wps:Data>'+'<wps:LiteralData>'+Count_Col2+'</wps:LiteralData>'+
'</wps:Data>'+'</wps:Input>'+'</wps:DataInputs>'+
'<wps:ResponseForm>'+'<wps:RawDataOutput mimeType="application/arcgrid">'+
'<ows:Identifier>result</ows:Identifier>'+'</wps:RawDataOutput>'+
'</wps:ResponseForm>'+
'</wps:Execute>';
alert("Эта функция работает только в онлайн веб-версии OpenWebGIS")
 {return;}
var request = OpenLayers.Request.POST({
 url: "/geoserver/wps",
 async: false,
 data: WPSContour,
 headers: {
 "Content-Type": "text/xml;charset=utf-8"
 },
 callback: function (response) {
resulArcGridnotInGeoserver=response.responseText;
 },
 failure: function (response) {
 alert("Something went wrong in the request");
 }});
var strEndCont='<?xml version="1.0" encoding="UTF-8"?>'+
'<wps:Execute version="1.0.0" service="WPS" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns="http://www.opengis.net/wps/1.0.0" xmlns:wfs="http://www.opengis.net/wfs" xmlns:wps="http://www.opengis.net/wps/1.0.0" xmlns:ows="http://www.opengis.net/ows/1.1" xmlns:gml="http://www.opengis.net/gml" xmlns:ogc="http://www.opengis.net/ogc" xmlns:wcs="http://www.opengis.net/wcs/1.1.1" xmlns:xlink="http://www.w3.org/1999/xlink" xsi:schemaLocation="http://www.opengis.net/wps/1.0.0 http://schemas.opengis.net/wps/1.0.0/wpsAll.xsd">'+
'<ows:Identifier>gs:Contour</ows:Identifier>'+
'<wps:DataInputs>'+'<wps:Input>'+'<ows:Identifier>data</ows:Identifier>'+
'<wps:Data>'+
'<wps:ComplexData mimeType="application/arcgrid"><![CDATA['+resulArcGridnotInGeoserver+']]></wps:ComplexData>'+
'</wps:Data>'+'</wps:Input>'+'<wps:Input>'+
' <ows:Identifier>band</ows:Identifier>'+
'<wps:Data>'+'<wps:LiteralData>GRAY_INDEX</wps:LiteralData>'+
'</wps:Data>'+'</wps:Input>'+
'<wps:Input>'+'<ows:Identifier>interval</ows:Identifier>'+
' <wps:Data>'+'<wps:LiteralData>'+Interval_contour+'</wps:LiteralData>'+
'</wps:Data>'+'</wps:Input>'+'<wps:Input>'+
'<ows:Identifier>simplify</ows:Identifier>'+
' <wps:Data>'+'<wps:LiteralData>false</wps:LiteralData>'+
'</wps:Data>'+'</wps:Input>'+dopStrC+'</wps:DataInputs>'+
'<wps:ResponseForm>'+
'<wps:RawDataOutput mimeType="application/json">'+
'<ows:Identifier>result</ows:Identifier>'+
'</wps:RawDataOutput>'+
'</wps:ResponseForm>'+
'</wps:Execute>';
alert("Эта функция работает только в онлайн веб-версии OpenWebGIS")
 {return;}
var request = OpenLayers.Request.POST({
 url: "/geoserver/wps",
 async: false,
 data: strEndCont,
 headers: {
 "Content-Type": "text/xml;charset=utf-8"
 },
 callback: function (response) {
resulArcGridnotInGeoserver=response.responseText;endPart();
 },
 failure: function (response) {
 alert("Something went wrong in the request");
 }});
var nameL=document.getElementById("Id_InterlayerNameAtlC").value;
var new_layer_G = new OpenLayers.Layer.Vector(nameL,{renderers:["Canvas", "SVG", "VML"]});
var format2 = new OpenLayers.Format.GeoJSON({ 
});
var newfeatures=format2.read(resulArcGridnotInGeoserver)
new_layer_G.addFeatures(newfeatures);
new_layer_G.projection=new OpenLayers.Projection("EPSG:900913");
new_layer_G.events.register("loadstart",new_layer_G, function() {WaitWindow();});
map.addLayer(new_layer_G);
new_layer_G.events.register("loadend",new_layer_G, function() {if(popup_Wait){try{popup_Wait.destroy();}catch(e){};} });
 var t=this.document.createElement('option');
t.value=new_layer_G.name;
t.text=new_layer_G.name;
this.document.getElementById("editL1").appendChild(t);
}


if(edilayerMainLayer.options.protocol&&document.getElementById("ContVect").checked==false){
var sld_contour='<?xml version="1.0" encoding="ISO-8859-1"?>'+
'<StyledLayerDescriptor version="1.0.0" '+
 'xsi:schemaLocation="http://www.opengis.net/sld StyledLayerDescriptor.xsd" '+
 'xmlns="http://www.opengis.net/sld" '+
 'xmlns:ogc="http://www.opengis.net/ogc" '+
 'xmlns:xlink="http://www.w3.org/1999/xlink" '+
 'xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">'+
 '<NamedLayer>'+
 '<Name>'+edilayerMainLayer.options.protocol.featureNS.split('/data/')[1].split('/')[0]+':'+edilayerMainLayer.options.protocol.featureType+'</Name>'+
 '<UserStyle>'+
 '<Title>Barnes Surface Contours</Title>'+
 '<Abstract>Extracts contours from a computed surface</Abstract>'+
 '<FeatureTypeStyle>'+
'<Transformation>'+
 '<ogc:Function name="gs:Contour">'+
 '<ogc:Function name="parameter">'+
 '<ogc:Literal>data</ogc:Literal>'+
 '<ogc:Function name="gs:BarnesSurface">'+
 ' <ogc:Function name="parameter">'+
 ' <ogc:Literal>data</ogc:Literal>'+
 ' </ogc:Function>'+
 ' <ogc:Function name="parameter">'+
 ' <ogc:Literal>valueAttr</ogc:Literal>'+
 ' <ogc:Literal>'+field_interpolation_Main+'</ogc:Literal>'+
 ' </ogc:Function>'+
 '<ogc:Function name="parameter">'+
 ' <ogc:Literal>scale</ogc:Literal>'+
 ' <ogc:Literal>'+interp_scale+'</ogc:Literal>'+
 ' </ogc:Function>'+
 ' <ogc:Function name="parameter">'+
 ' <ogc:Literal>convergence</ogc:Literal>'+
 ' <ogc:Literal>0.3</ogc:Literal>'+
 ' </ogc:Function><ogc:Function name="parameter">'+
 ' <ogc:Literal>passes</ogc:Literal>'+
 ' <ogc:Literal>2</ogc:Literal>'+
 '</ogc:Function>'+
 '<ogc:Function name="parameter">'+
 ' <ogc:Literal>minObservations</ogc:Literal>'+
 ' <ogc:Literal>2</ogc:Literal>'+
 '</ogc:Function>'+
 ' <ogc:Function name="parameter">'+
 ' <ogc:Literal>maxObservationDistance</ogc:Literal>'+
 ' <ogc:Literal>0</ogc:Literal>'+
 '</ogc:Function>'+
 '<ogc:Function name="parameter">'+
 ' <ogc:Literal>pixelsPerCell</ogc:Literal>'+
 ' <ogc:Literal>'+pixelContour_inter+'</ogc:Literal>'+
 '</ogc:Function>'+
 '<ogc:Function name="parameter">'+
 ' <ogc:Literal>outputBBOX</ogc:Literal>'+
 ' <ogc:Function name="env">'+
 '<ogc:Literal>wms_bbox</ogc:Literal>'+
 '</ogc:Function>'+
 '</ogc:Function>'+
 '<ogc:Function name="parameter">'+
 '<ogc:Literal>outputWidth</ogc:Literal>'+
 '<ogc:Function name="env">'+
 ' <ogc:Literal>wms_width</ogc:Literal>'+
 ' </ogc:Function>'+
 ' </ogc:Function>'+
 '<ogc:Function name="parameter">'+
 ' <ogc:Literal>outputHeight</ogc:Literal>'+
 ' <ogc:Function name="env">'+
 ' <ogc:Literal>wms_height</ogc:Literal>'+
 '</ogc:Function>'+
 ' </ogc:Function>'+
 ' <ogc:Function name="parameter">'+
 ' <ogc:Literal>queryBuffer</ogc:Literal>'+
 ' <ogc:Literal>40</ogc:Literal>'+
 '</ogc:Function>'+
 ' </ogc:Function>'+
 '</ogc:Function>'+
'<ogc:Function name="parameter">'+
 '<ogc:Literal>interval</ogc:Literal>'+
 '<ogc:Literal>'+Interval_contour+'</ogc:Literal>'+
 ' </ogc:Function>'+
 '<ogc:Function name="parameter">'+
 ' <ogc:Literal>simplify</ogc:Literal>'+
 ' <ogc:Literal>true</ogc:Literal>'+
 '</ogc:Function>'+
 ' </ogc:Function>'+
'</Transformation>'+
'<Rule>'+
 '<Name>rule1</Name>'+
 '<Title>Isotherm</Title>'+
 '<LineSymbolizer>'+
 '<Stroke>'+
 '<CssParameter name="stroke">#000000</CssParameter>'+
 '<CssParameter name="stroke-width">1</CssParameter>'+
 '</Stroke>'+
 '</LineSymbolizer>'+
 '<TextSymbolizer>'+
 '<Label>'+
 '<ogc:Function name="round">'+
 '<ogc:PropertyName>value</ogc:PropertyName>'+
 '</ogc:Function>'+
 '</Label>'+
 '<Font>'+
 '<CssParameter name="font-family">Arial</CssParameter>'+
 '<CssParameter name="font-style">Normal</CssParameter>'+
 '<CssParameter name="font-size">12</CssParameter>'+
 '</Font>'+
 '<LabelPlacement>'+
 '<LinePlacement/>'+
 '</LabelPlacement>'+
 '<Halo>'+
 '<Radius>'+
 '<ogc:Literal>2</ogc:Literal>'+
 '</Radius>'+
 '<Fill>'+
 '<CssParameter name="fill">#FFFFFF</CssParameter>'+
 '<CssParameter name="fill-opacity">0.6</CssParameter>'+ 
 '</Fill>'+
 '</Halo>'+
 '<Fill>'+
 '<CssParameter name="fill">#000000</CssParameter>'+
 '</Fill>'+
 '<Priority>2000</Priority>'+
 '<VendorOption name="followLine">true</VendorOption>'+
 '<VendorOption name="repeat">100</VendorOption>'+
 '<VendorOption name="maxDisplacement">50</VendorOption>'+
 '<VendorOption name="maxAngleDelta">30</VendorOption>'+
 '</TextSymbolizer>'+
 '</Rule>'+
 '</FeatureTypeStyle>'+
 '</UserStyle>'+
 '</NamedLayer>'+
'</StyledLayerDescriptor>';
stylewfs_Vbathim = new OpenLayers.Style({
 pointRadius: 3,
 fillColor: "#FFC300",
 strokeColor: "#FFC300",
 strokeWidth: 1,
fillOpacity:1,
 strokeOpacity:1
 });
var nameL=document.getElementById("Id_InterlayerNameAtlC").value;
var new_layer_G= new OpenLayers.Layer.WMS(nameL,'/geoserver/wms',{ layers:edilayerMainLayer.options.protocol.featureNS.split('/data/')[1].split('/')[0]+':'+edilayerMainLayer.options.protocol.featureType,transparent:true,sld_body:sld_contour,STYLES:''},
{ buffer: 0,
singleTile:true, 
tileOptions: {maxGetUrlLength: 20},
opacity:0.5,
displayOutsideMaxExtent: true,
 isBaseLayer:false,
projection: new OpenLayers.Projection("EPSG:900913"),
displayProjection : new OpenLayers.Projection("EPSG:4326")
 });
new_layer_G.events.register("loadstart",new_layer_G, function() {WaitWindow();});
map.addLayer(new_layer_G);
new_layer_G.events.register("loadend",new_layer_G, function() {if(popup_Wait){try{popup_Wait.destroy();}catch(e){};} });

}
popupContour_inter.destroy();
popup_interW = new OpenLayers.Popup.FramedCloud("InterpolationPopupCC",
 map.getCenter(),
 new OpenLayers.Size(100,100),
 "Please wait.." ,
 null, true, onPopupClose);
 map.addPopup(popup_interW);
setTimeout("endPart()", 7000);
var t=this.document.createElement('option');
t.value=new_layer_G.name;
t.text=new_layer_G.name;
//this.document.getElementById("editL1").appendChild(t);
}
function setInterBound_Exp()
{ InterInterpBB=[];
InterInterpBBExp=[];
var minDistC = parseFloat(edilayerMainLayer.features[0].geometry.y);
 var maxDistC = parseFloat(minDistC) ;
 for (ia = 1; ia < edilayerMainLayer.features.length; ++ia) { var NumSS=edilayerMainLayer.features[ia].geometry.y;
 if (NumSS>parseFloat(maxDistC) ) {maxDistC = parseFloat(NumSS);}
 if( NumSS<parseFloat(minDistC) ) {minDistC = parseFloat(NumSS);}
 }
var minY=minDistC;
var maxY=maxDistC;
var minDistC = parseFloat(edilayerMainLayer.features[0].geometry.x);
 var maxDistC = parseFloat(minDistC) ;
 for (ia = 1; ia < edilayerMainLayer.features.length; ++ia) { var NumSS=edilayerMainLayer.features[ia].geometry.x;
 if (NumSS>parseFloat(maxDistC) ){ maxDistC = parseFloat(NumSS);}
 if( NumSS<parseFloat(minDistC) ) {minDistC = parseFloat(NumSS);}
 }
var minX=minDistC;
var maxX=maxDistC;
InterInterpBB.push(minX);
InterInterpBB.push(minY);
InterInterpBB.push(maxX);
InterInterpBB.push(maxY);
var pos=new OpenLayers.LonLat(minX, minY).transform(map.getProjectionObject(),new OpenLayers.Projection("EPSG:4326"));
var pos2=new OpenLayers.LonLat(maxX, maxY).transform(map.getProjectionObject(),new OpenLayers.Projection("EPSG:4326"));
InterInterpBBExp.push(pos.lon);
InterInterpBBExp.push(pos.lat);
InterInterpBBExp.push(pos2.lon);
InterInterpBBExp.push(pos2.lat);
InterInterpBB=InterInterpBBExp;
}

function aboutSoftware()
{
myWinTable= open("software.htm", "_blank",
 "status=yes,toolbar=yes,menubar=yes,scrollbars=yes");
}
function closeContact()
{
document.getElementById("id_divEditeLegMain").parentNode.removeChild(document.getElementById("id_divEditeLegMain"));
}
function Contact()
{
var bbox = document.getElementById("id_ContactsOpenGis").getBoundingClientRect();
 var body = document.body
 var docElem = document.documentElement
 var scrollTop = window.pageYOffset || docElem.scrollTop || body.scrollTop
 var scrollLeft = window.pageXOffset || docElem.scrollLeft || body.scrollLeft
 var clientTop = docElem.clientTop || body.clientTop || 0
 var clientLeft = docElem.clientLeft || body.clientLeft || 0
 var topTop = bbox.top + scrollTop - clientTop
 var leftLeft = bbox.left + scrollLeft - clientLeft
var DivEditeLeg=document.createElement("div");
DivEditeLeg.id="id_divEditeLegMain";
DivEditeLeg.innerHTML='<div id="id_divEditeLeg" style="background:#efe4b0; color:#0000ff;width:250px;z-index: 1400;height:180px;position:absolute;left:'+Math.round(leftLeft+50)+'px;top:'+Math.round(topTop+20)+
'px;overflow:hidden; border: 1px solid black;"><img onclick="closeContact()" src="openlayers/theme/default/img/close.gif" style="position:relative; top:10px;float:right; cursor:pointer"><a style="position:relative; top:20px">openwebgis@yandex.ru</a><br><a style="position:relative; top:40px" href="https://www.facebook.com/openwebgisPage" target="_blank">facebook</a><br><a style="position:relative; top:40px" href="http://vk.com/openwebgis" target="_blank">vk.com</a></div>';
if(!document.getElementById("id_divEditeLeg"))
{body.appendChild(DivEditeLeg); }
}
function Help()
 {
 var htmlHelp=" ";
 htmlHelp+='<a><font size="4">Здесь, на данный момент описаны только</font></a><br><a><font size="4">наиболее важные моменты работы с OpenWebGIS.</font></a><br><br>';
htmlHelp+='<a><font size="2">Система адаптирована для работы в браузере Mozilla Firefox (работоспсобность в Google Chrome пока ещё тестируется).</font></a><br><a><font size="2"> В других браузерах работа системы может быть некорректной!</font></a><br>';
htmlHelp+='<a><font size="2">1.Все географические слои и добавляемые данные должны быть в Системе координат WGS84 (EPSG 4326)!</font></a><br>';
htmlHelp+='<a><font size="2">2.В настройках браузера должны быть разрешены всплывающие окна</font></a><br>';
htmlHelp+='<a><font size="2">3.Во время работы с интерполяцией и растрами расчёты занимают некоторое (иногда длительное) время</font></a><br><a><font size="2">поэтому необходимо подождать результаты</font></a><br>';
htmlHelp+='<a><font size="2">4.Все десятичные числа должны быть написаны с разделителем ТОЧКОЙ &mdash; &laquo;<font size=4> . </font>&raquo;</font></a><br>';
htmlHelp+='<a><font size="2">5.Shape файлы перед загрузкой на сервер (пункт меню:Редактирование&rarr;загрузить shapefile) должны быть упакованы одним файлом в zip-format </font></a><br>';
var bbox = document.getElementById("map").getBoundingClientRect();
 var body = document.body; var docElem = document.documentElement; var scrollTop = window.pageYOffset || docElem.scrollTop || body.scrollTop;
 var scrollLeft = window.pageXOffset || docElem.scrollLeft || body.scrollLeft; var clientTop = docElem.clientTop || body.clientTop || 0; var clientLeft = docElem.clientLeft || body.clientLeft || 0; var topTop = bbox.top + scrollTop - clientTop; var leftLeft = bbox.left + scrollLeft - clientLeft;
var DivEditeLeg=document.createElement("div");DivEditeLeg.id="HelpPopupFowg";
DivEditeLeg.className="id_divRoutLegMain";DivEditeLeg.style.position="relative";
DivEditeLeg.innerHTML='<div id="id_divHeatInterMainwg_Leg" style="background:#ffffff; color:#0000ff;z-index: 1400;position:absolute;left:'+Math.round(leftLeft+50)+'px;top:'+Math.round(topTop-180)+
'px;overflow:hidden; border: 1px solid black;"><img onclick="closeWearherLegendWin(this)" src="openlayers/theme/default/img/close.gif" style="position:relative; top:10px;float:right; cursor:pointer"><a style="position:relative; top:20px"></a>'+
'<a style="font-size: 9px;"> Вы можете перемещать это окно если щёлкните по пункту меню: Интерфейс->переключить режим интерфейса</a><br>'+
htmlHelp+'</div>';
if(!document.getElementById("HelpPopupFowg"))
{body.appendChild(DivEditeLeg); 
document.getElementById("HelpPopupFowg").onmousedown=function(event){drags(event)};
document.getElementById("HelpPopupFowg").onmouseup=function(e){enddrag()};
 }
 }
 function FAObase()
{
var bbox = document.getElementById("map").getBoundingClientRect();
 var body = document.body
 var docElem = document.documentElement
 var scrollTop = window.pageYOffset || docElem.scrollTop || body.scrollTop
 var scrollLeft = window.pageXOffset || docElem.scrollLeft || body.scrollLeft
 var clientTop = docElem.clientTop || body.clientTop || 0
 var clientLeft = docElem.clientLeft || body.clientLeft || 0
 var topTop = bbox.top + scrollTop - clientTop
 var leftLeft = bbox.left + scrollLeft - clientLeft
var DivEditeLeg=document.createElement("div");
DivEditeLeg.id="id_FAObasLegMain2";
DivEditeLeg.className="id_divRoutLegMain";
DivEditeLeg.style.position="relative";

DivEditeLeg.innerHTML='<div id="id_divFAObasLeg" style="background:#ffffff; color:#0000ff;z-index: 6000;position:absolute;left:'+Math.round(leftLeft+50)+'px;top:'+Math.round(topTop-50)+
'px;overflow:hidden; border: 1px solid black;"><img onclick="closeFishFaoWin()" src="openlayers/theme/default/img/close.gif" style="position:relative; top:10px;float:right; cursor:pointer"><a style="position:relative; top:20px"></a>'+
'<a style="font-size: 9px;">Вы можете перемещать это окно если щёлкните по пункту меню: Интерфейс->переключить режим интерфейса</a><br>'+
'<a>Information provided by: <a href="http://www.fao.org" target="_blank">Food and Agriculture Organization of the United Nations.</a></a><br>'+
'<a><a href="http://www.fao.org/fishery/en" target="_blank">Fisheries and Aquaculture Department</a></a><br>'+
'<a><a href="http://www.fao.org/figis/geoserver/factsheets/species.html" target="_blank">powered by FIGIS<a></a><br>'+
'<a>выберите Вид:</a><select title="" id="id_FishFao">'+
 '<option selected value="0" >.</option>'+
 '</select><br><p> <button type=button onclick=OK_FAOfish()>OK</button></p><div id="waitFAOBio"></div></div>';
var myUrl='http://www.fao.org/figis/geoserver/factsheets/js/specieslist.xml';
if(!document.getElementById("id_FAObasLegMain2"))
{body.appendChild(DivEditeLeg); }
document.getElementById("id_FAObasLegMain2").onmousedown=function(event){drags(event)};
document.getElementById("id_FAObasLegMain2").onmouseup=function(e){enddrag()};
try {var xmlhttp =new XMLHttpRequest();}
catch (e) {alert("error");return;}
xmlhttp.open('GET','/temp.php?c='+myUrl+'&rand='+Math.random(), true);
xmlhttp.setRequestHeader("Cache-Control", "no-cache");
xmlhttp.setRequestHeader("Content-type", "text/xml");
xmlhttp.onreadystatechange = function()
{if(xmlhttp.readyState == 4&&xmlhttp.status == 200) {//myUrl=xmlhttp.responseText;

if(xmlhttp==''){alert('нет данных');return;}
var strXml = xmlhttp.text;
 var oXmlDoc = null;
strXml = xmlhttp.responseText;
 if ( window.DOMParser ) {
 var oXmlParser = new DOMParser();
 oXmlDoc = oXmlParser.parseFromString( strXml, "text/xml" );
 } else {
 oXmlDoc = new ActiveXObject( "Microsoft.XMLDOM" );
 oXmlDoc.async = "false";
 oXmlDoc.loadXML( strXml );
 }
var nameFish = oXmlDoc.getElementsByTagName('item');
for (var a=0; a<nameFish.length; a++)
{ var t=document.createElement('option');t.value=nameFish[a].attributes[0].nodeValue+';'+nameFish[a].attributes[1].nodeValue;
t.text=nameFish[a].attributes[3].nodeValue;
document.getElementById("id_FishFao").appendChild(t);}

  var wrapper = document.getElementById("id_FishFao"),
nodes = wrapper.getElementsByTagName("OPTION"),
len = nodes.length,
sorted = [];
while (nodes[0]) {
sorted.push(new String(nodes[0].text));
sorted[sorted.length-1].element = nodes[0];
wrapper.removeChild(nodes[0]);
}
sorted = sorted.sort();
for (var i = 0; i < len; i++) {
wrapper.appendChild(sorted[i].element);
}
document.getElementById("id_FishFao")[0].selected=true;

}
}
alert("Эта функция работает только в онлайн веб-версии OpenWebGIS")
{return;
xmlhttp.send(null);} }
function OK_FAOfish()
{if(document.getElementById("id_FishFao").value=="0"){alert('Please select species' );return;}
var waitT=document.createElement('a');
waitT.id="a_waitFAOBio";
waitT.innerHTML="Wait...";
document.getElementById("waitFAOBio").appendChild(waitT);
var myUrl='http://www.fao.org/figis/geoserver/ows?SERVICE=WFS&VERSION=1.0.0&REQUEST=GetFeature&TYPENAME=species:SPECIES_DIST_'+document.getElementById("id_FishFao").value.split(';')[0]+'&SRSNAME=EPSG:4326';
myUrl=encodeURIComponent(myUrl);
try {var xmlhttp =new XMLHttpRequest();}
catch (e) {alert("error");}
xmlhttp.open('GET','/temp.php?c='+myUrl+'&rand='+Math.random(), true);
xmlhttp.setRequestHeader("Cache-Control", "no-cache");
xmlhttp.setRequestHeader("Content-type", "text/xml");
xmlhttp.onreadystatechange = function()
{if(xmlhttp.readyState == 4&&xmlhttp.status == 200) {
var datafish=xmlhttp.responseText;
if(datafish==''){alert("нет данных");return;}
if(document.getElementById("a_waitFAOBio")){document.getElementById("a_waitFAOBio").parentNode.removeChild(document.getElementById("a_waitFAOBio"))}
 formatgml = new OpenLayers.Format.GML({
 'extractStyles':true,'extractAttributes':true,
 'internalProjection': new OpenLayers.Projection("EPSG:900913"),
 'externalProjection': new OpenLayers.Projection("EPSG:4326")
 });
var new_layer_KML = new OpenLayers.Layer.Vector(document.getElementById("id_FishFao").selectedOptions[0].textContent,{renderers:["Canvas", "SVG", "VML"]});
{var kmlFeatures=formatgml.read(datafish);for(var bn=0;bn<kmlFeatures.length;bn++){kmlFeatures[bn].attributes["informationFAO"]="<a href='http://www.fao.org/fishery/species/"+document.getElementById('id_FishFao').value.split(';')[1]+"' target='_blank'>"+document.getElementById('id_FishFao').selectedOptions[0].textContent+"</a>";
kmlFeatures[bn].attributes["informationFAO2"]="(c) FAO, 2013. Aquatic Species Distribution Maps. FAO aquatic species distribution map of "+ document.getElementById('id_FishFao').selectedOptions[0].textContent+" . In: FAO Fisheries and Aquaculture Department [online]. Rome. http://www.fao.org/fishery/collection/fish_dist_map";}}
new_layer_KML.addFeatures(kmlFeatures);

var new_style_layer= new OpenLayers.Style({
 pointRadius: 3, fillColor: "#FF9000",
 strokeColor: "#FF9000", strokeWidth: 1,
fillOpacity:0.7, strokeOpacity:1 });
 var selStyle = new OpenLayers.Style({
 pointRadius: 5,  fillColor: "#ffaa00",
 strokeColor: "#00DDFF", strokeWidth:2,
fillOpacity:1, strokeOpacity:1 }); 
new_layer_KML.styleMap=new OpenLayers.StyleMap({'default':new_style_layer,'select': selStyle});

var t=document.createElement('option');
t.value=new_layer_KML.name;
t.text=new_layer_KML.name;

document.getElementById("editL1").appendChild(t);
map.addLayer(new_layer_KML);
new_layer_KML.events.register("loadstart",new_layer_KML, function() {WaitWindow();}); 
new_layer_KML.events.register("loadend",new_layer_KML, function() {if(popup_Wait){try{popup_Wait.destroy();}catch(e){};} });

}
}

alert("Эта функция работает только в онлайн веб-версии OpenWebGIS")
{return;xmlhttp.send(null);}
}
function Paleobiology()
{var bbox = document.getElementById("map").getBoundingClientRect();
 var body = document.body
 var docElem = document.documentElement
 var scrollTop = window.pageYOffset || docElem.scrollTop || body.scrollTop
 var scrollLeft = window.pageXOffset || docElem.scrollLeft || body.scrollLeft
 var clientTop = docElem.clientTop || body.clientTop || 0
 var clientLeft = docElem.clientLeft || body.clientLeft || 0
 var topTop = bbox.top + scrollTop - clientTop
 var leftLeft = bbox.left + scrollLeft - clientLeft
var DivEditeLeg=document.createElement("div");
DivEditeLeg.id="id_PaleBioLegMain2";
DivEditeLeg.className="id_divRoutLegMain";
DivEditeLeg.style.position="relative";

DivEditeLeg.innerHTML='<div id="id_divPaleBioLeg" style="background:#ffffff; color:#0000ff;z-index: 6000;position:absolute;left:'+Math.round(leftLeft+50)+'px;top:'+Math.round(topTop-50)+
'px;overflow:hidden; border: 1px solid black;"><img onclick="closePaleoBioWin()" src="openlayers/theme/default/img/close.gif" style="position:relative; top:10px;float:right; cursor:pointer"><a style="position:relative; top:20px"></a>'+
'<a style="font-size: 9px;">Вы можете перемещать это окно если щёлкните по пункту меню: Интерфейс->переключить режим интерфейса</a><br>'+
'<a>Information provided by: <a href="http://paleobiodb.org" target="_blank">Paleobiology Database</a></a><br>'+
'<a><a href="http://geoscience.wisc.edu/geoscience/" target="_blank"> hosted by the Department of Geoscience</a></a><br>'+
'<a><a href="http://www.wisc.edu/" target="_blank">at the University of Wisconsin-Madison<a></a><br>'+
'<a><a href="http://creativecommons.org/licenses/by/4.0/legalcode" target="_blank">Paleobiology Database is licensed under a CC BY 4.0 International License<a></a><br>'+
'<a>Палеонтологические находки:</a><br>'+
'<a title="название отряда, семейства, рода или вида ">Введите таксон:<textarea id="id_textPaleoBiol" style="width: 100px; height: 20px;font-size:11px"></textarea>'+
'<a>выберите временной интервал:</a><select title="" id="id_TimePaleoB">'+
 '<option selected value="0" >.</option></select><br>'+
'<a>количество результатов</a><input type="text" size="15" id="id_countPaleoBiolLayer" title="if empty it will display all results" value="100"/><br>'+
'<a>укажите полигон:</a><textarea title="Выбирается только та информация, которая ограничена указанным полигоном, который должен быть задан в формате WKT format. Вы можете нарисовать полигон на карте, потом выделить его и затем щёлкнуть по этому полю." id="id_PolyPaleoBiol" style="width: 200px; height: 20px;font-size:11px"></textarea><br>'+
'<a>Введите ограничение во времени (в Млн.лет):</a><br>'+
'<a>from: </a><input type="text" size="5" id="id_fromPaleoBiolEarly_age" title="Будут выбраны записи которые моложе указанного значения в Млн.лет. Вводить надо например так: 440.5 или 0.017" value="5000"/>'+
'<a> to: </a><input type="text" size="5" id="id_toPaleoBiolEarly_age" title="Будут выбраны записи которые старше указанного значения в Млн.лет. Вводить надо например так: 440.5 или 0.017" value="0"/><br>'+
'<a>Введите название Слоя:</a><input type="text" size="35" id="id_textPaleoBiolLayer" title="Insert name of layer" value="Paleobiology"/><br>'+
'<input type="checkbox" id="Id_PaleolinkWiki" value="checkbox"/>добавить к атрибутам ссылку на википедию <br>'+
'<input type="checkbox" id="Id_PaleolinkWiki1" value="checkbox"/>add general comments about the geology of the collection site<br>'+
'<input type="checkbox" id="Id_PaleolinkWiki2" value="checkbox"/>add detailed description of the collection site in terms of lithology<br>'+
'<p> <button type=button onclick=OK_PaleoBase()>OK</button></p><div id="waitPaleoBio"></div></div>';
if(!document.getElementById("id_PaleBioLegMain2"))
{body.appendChild(DivEditeLeg); }
document.getElementById("id_PaleBioLegMain2").onmousedown=function(event){drags(event)};
document.getElementById("id_PaleBioLegMain2").onmouseup=function(e){enddrag()};

 document.getElementById("id_PolyPaleoBiol").onclick = function () {
 if (edilayerMainLayer.selectedFeatures.length) {var FeatClone=edilayerMainLayer.selectedFeatures[0].clone();
FeatClone.geometry.transform(map.getProjectionObject(),new OpenLayers.Projection("EPSG:4326"));
this.value = new OpenLayers.Format.WKT().write(FeatClone)}}

try {var xmlhttp =new XMLHttpRequest();}
catch (e) {alert("error");return;}
myUrl='http://paleobiodb.org/data1.1/intervals/list.json?scale=all&limit=all&showsource';
myUrl=encodeURIComponent(myUrl);
xmlhttp.open('GET','/temp.php?c='+myUrl+'&rand='+Math.random(), true);
xmlhttp.setRequestHeader("Cache-Control", "no-cache");
xmlhttp.setRequestHeader("Content-type", "text/xml");
xmlhttp.onreadystatechange = function()
{if(xmlhttp.readyState == 4&&xmlhttp.status == 200) {
if(xmlhttp.responseText==''){alert("нет данных");return;}
var nameTime=JSON.parse(xmlhttp.responseText); 
for (var a=0; a<nameTime.records.length; a++)
{ var t=document.createElement('option');t.value=nameTime.records[a].nam;
t.text=nameTime.records[a].nam;
t.title='The early age boundary of this interval (in Ma): '+nameTime.records[a].eag+', The late age boundary of this interval (in Ma): '+nameTime.records[a].lag;
document.getElementById("id_TimePaleoB").appendChild(t);}
  var wrapper = document.getElementById("id_TimePaleoB"),
nodes = wrapper.getElementsByTagName("OPTION"),
len = nodes.length,
sorted = [];
while (nodes[0]) {
sorted.push(new String(nodes[0].text));
sorted[sorted.length-1].element = nodes[0];
wrapper.removeChild(nodes[0]);
}
sorted = sorted.sort();
for (var i = 0; i < len; i++) {
wrapper.appendChild(sorted[i].element);
}
document.getElementById("id_TimePaleoB")[1].selected=true;
} }
alert("Эта функция работает только в онлайн веб-версии OpenWebGIS")
{return;
xmlhttp.send(null);}


}
function OK_PaleoBase()
{var waitT=document.createElement('a');
waitT.id="a_waitPaleoBio";
waitT.innerHTML="Wait...";
document.getElementById("waitPaleoBio").appendChild(waitT);
try {var xmlhttp =new XMLHttpRequest();}
catch (e) {rtt=e;alert(e);return;}
var taxaP=''; var timeinter=''; var dpstr='&';var resultC=''; var GeomLoc='';var dpstr2='&';var earlyAge1='';var earlyAge2='';var dpstr3='&';var dpstr4='&';
var arrayStrPaleo=[];
if(document.getElementById("id_textPaleoBiol").value!=='')
{taxaP='base_name='+document.getElementById("id_textPaleoBiol").value;arrayStrPaleo.push(taxaP);}
if(document.getElementById("id_TimePaleoB").value!=='0')
{timeinter='interval='+document.getElementById("id_TimePaleoB").value;arrayStrPaleo.push(timeinter);}
if(document.getElementById("id_countPaleoBiolLayer").value=='')
{resultC='all';}else{resultC=document.getElementById("id_countPaleoBiolLayer").value;}
if(document.getElementById("id_PolyPaleoBiol").value!=='')
{GeomLoc='loc="'+document.getElementById("id_PolyPaleoBiol").value+'"';arrayStrPaleo.push(GeomLoc);}
if(document.getElementById("id_fromPaleoBiolEarly_age").value!=='')
{earlyAge1='max_ma='+document.getElementById("id_fromPaleoBiolEarly_age").value;arrayStrPaleo.push(earlyAge1);}
if(document.getElementById("id_toPaleoBiolEarly_age").value!=='')
{earlyAge2='min_ma='+document.getElementById("id_toPaleoBiolEarly_age").value;arrayStrPaleo.push(earlyAge2);}
if(earlyAge1!==''&&timeinter!==''){alert("you can not include more than one of 'interval'.Select only Time Interval or temporal locality (in Ma)");return;}
var queryStr=arrayStrPaleo.join('&');
myUrl='http://paleobiodb.org/data1.1/occs/list.json?limit='+resultC+'&'+queryStr+'&show=loc,time,prot,ident,strat,phylo,coords,entname,lith,geo';

myUrl=encodeURIComponent(myUrl);

xmlhttp.open('GET','/temp.php?c='+myUrl+'&rand='+Math.random(), true);
xmlhttp.setRequestHeader("Cache-Control", "no-cache");
xmlhttp.setRequestHeader("Content-type", "text/xml");
xmlhttp.onreadystatechange = function()
{if(xmlhttp.readyState == 4&&xmlhttp.status == 200) {//myUrl=xmlhttp.responseText;
if(document.getElementById("a_waitPaleoBio")){document.getElementById("a_waitPaleoBio").parentNode.removeChild(document.getElementById("a_waitPaleoBio"))}
if(xmlhttp==''){alert('нет данных');return;}
var format2 = new OpenLayers.Format.GeoJSON({'internalProjection': new OpenLayers.Projection("EPSG:900913"),
'externalProjection': new OpenLayers.Projection("EPSG:4326") });
try {var arrPointj=JSON.parse(xmlhttp.responseText); }
catch (e) {alert(e);return;}
if(arrPointj.records.length==0){alert('нет данных');return;}
var obj = {};
   for(var g=0; g<arrPointj.records.length; g++) {
for(h in arrPointj.records[g]){var str=h;
obj[str] = true; }
  }
var arrfirst_point=[];
for(var bb=0;bb<arrPointj.records.length;bb++)
{ 
var new_pos2=new OpenLayers.LonLat(arrPointj.records[bb].lng,arrPointj.records[bb].lat).transform(
new OpenLayers.Projection("EPSG:4326"),
map.getProjectionObject());
var point=new OpenLayers.Geometry.Point(new_pos2.lon, new_pos2.lat)
var first_point= new OpenLayers.Feature.Vector(point);
///////////////
var NewAttr={};
for(h in obj)
{ for (ag in arrPointj.records[bb]) 
{
if(h==ag) 
{NewAttr[h]=arrPointj.records[bb][ag]; }
else{if(NewAttr[h]){}else{NewAttr[h]=''};} ;  
}    
 }
/////////////////////
first_point.attributes=NewAttr;
if(document.getElementById("Id_PaleolinkWiki1").checked==false){delete first_point.attributes["gcm"]};if(document.getElementById("Id_PaleolinkWiki2").checked==false){delete first_point.attributes["ldc"]}
first_point.attributes["formation"]=first_point.attributes["sfm"];
first_point.attributes["stratgroup"]=first_point.attributes["sgr"];
first_point.attributes["matched_rank"]=first_point.attributes["mra"];
first_point.attributes["stratmember"]=first_point.attributes["smb"];
first_point.attributes["order_no"]=first_point.attributes["odn"];
first_point.attributes["order"]=first_point.attributes["odl"];
first_point.attributes["subgenus_name"]=first_point.attributes["idf"];
first_point.attributes["occurrence_no"]=first_point.attributes["oid"];first_point.attributes["record_type"]=first_point.attributes["typ"];
first_point.attributes["reid_no"]=first_point.attributes["eid"];first_point.attributes["collection_no"]=first_point.attributes["cid"];
first_point.attributes["taxon_name"]=first_point.attributes["tna"];first_point.attributes["taxon_rank"]=first_point.attributes["rnk"];
first_point.attributes["taxon_no"]=first_point.attributes["tid"];first_point.attributes["early_interval"]=first_point.attributes["oei"];
first_point.attributes["early_age"]=first_point.attributes["eag"];first_point.attributes["late_age"]=first_point.attributes["lag"];
first_point.attributes["reference_no"]=first_point.attributes["rid"];first_point.attributes["country"]=first_point.attributes["cc2"];
first_point.attributes["state"]=first_point.attributes["sta"];first_point.attributes["geogscale"]=first_point.attributes["gsc"];
first_point.attributes["cx_int_no"]=first_point.attributes["cxi"];first_point.attributes["early_int_no"]=first_point.attributes["ein"];
first_point.attributes["late_int_no"]=first_point.attributes["lin"];first_point.attributes["genus_name"]=first_point.attributes["idt"];
first_point.attributes["species_name"]=first_point.attributes["ids"];first_point.attributes["family"]=first_point.attributes["fml"];
first_point.attributes["family_no"]=first_point.attributes["fmn"];first_point.attributes["class"]=first_point.attributes["cll"];
first_point.attributes["class_no"]=first_point.attributes["cln"];first_point.attributes["phylum"]=first_point.attributes["phl"];
first_point.attributes["phylum_no"]=first_point.attributes["phn"];first_point.attributes["lng"]=first_point.attributes["lng"];
first_point.attributes["lat"]=first_point.attributes["lat"];first_point.attributes["authorizer"]=first_point.attributes["ath"];
first_point.attributes["enterer"]=first_point.attributes["ent"];first_point.attributes["modifier"]=first_point.attributes["mdf"];
first_point.attributes["genus_reso"]=first_point.attributes["rst"];first_point.attributes["county"]=first_point.attributes["cny"];
first_point.attributes["matched_name"]=first_point.attributes["mna"];first_point.attributes["protected"]=first_point.attributes["ptd"];
first_point.attributes["species_reso"]=first_point.attributes["rss"];first_point.attributes["late_interval"]=first_point.attributes["oli"];
first_point.attributes["lithology2"]=first_point.attributes["lt2"];
first_point.attributes["lithology1"]=first_point.attributes["lt1"];
first_point.attributes["environment"]=first_point.attributes["env"];
first_point.attributes["lithification1"]=first_point.attributes["lf1"];
first_point.attributes["lithification2"]=first_point.attributes["lf2"];
first_point.attributes["minor_lithology1"]=first_point.attributes["lm1"];
first_point.attributes["minor_lithology1"]=first_point.attributes["lm1"];
first_point.attributes["tectonic_setting"]=first_point.attributes["tec"];
if(document.getElementById("Id_PaleolinkWiki1").checked==true){first_point.attributes["geology_comments"]=first_point.attributes["gcm"]}
if(document.getElementById("Id_PaleolinkWiki2").checked==true){first_point.attributes["lithdescript"]=first_point.attributes["ldc"]}

first_point.attributes["minor_lithology1"]=first_point.attributes["lm1"];
delete first_point.attributes["oid"];delete first_point.attributes["typ"];delete first_point.attributes["eid"];delete first_point.attributes["cid"];
delete first_point.attributes["tna"];delete first_point.attributes["rnk"];delete first_point.attributes["tid"];delete first_point.attributes["oei"];
delete first_point.attributes["eag"];delete first_point.attributes["lag"];delete first_point.attributes["rid"];delete first_point.attributes["cc2"];
delete first_point.attributes["sta"];delete first_point.attributes["gsc"];delete first_point.attributes["cxi"];delete first_point.attributes["ein"];
delete first_point.attributes["lin"];delete first_point.attributes["idt"];delete first_point.attributes["ids"];delete first_point.attributes["fml"];
delete first_point.attributes["fmn"];delete first_point.attributes["cll"];delete first_point.attributes["cln"];delete first_point.attributes["phl"];
delete first_point.attributes["phn"];delete first_point.attributes["lng"];delete first_point.attributes["lat"];delete first_point.attributes["ath"];
delete first_point.attributes["ent"];delete first_point.attributes["mdf"];delete first_point.attributes["rst"];delete first_point.attributes["cny"];
delete first_point.attributes["mna"];delete first_point.attributes["ptd"];delete first_point.attributes["rss"];delete first_point.attributes["oli"];
delete first_point.attributes["sfm"]; delete first_point.attributes["sgr"];
delete first_point.attributes["smb"];delete first_point.attributes["odn"];delete first_point.attributes["odl"];delete first_point.attributes["idf"];
delete first_point.attributes["mra"];
delete first_point.attributes["lt2"];delete first_point.attributes["lt1"];delete first_point.attributes["env"];delete first_point.attributes["lf1"];delete first_point.attributes["lf2"]; delete first_point.attributes["lm1"];delete first_point.attributes["lm2"];
delete first_point.attributes["tec"];
delete first_point.attributes["gcm"]
delete first_point.attributes["ldc"]
if(document.getElementById("Id_PaleolinkWiki").checked==true)
{for (var i in first_point.attributes)
{if(i=="order"||i=="subgenus_name"||i=="taxon_name"||i=="stratgroup"||i=="early_interval"||i=="state"||i=="country"||i=="species_name"||i=="family"||i=="class"||i=="late_interval"||i=="matched_name"||i=="county"||i=="phylum"||i=="genus_name"||i=="lithology2")
{if (typeof first_point.attributes[i]=='undefined'){}else{ if(first_point.attributes[i]&&typeof(first_point.attributes[i])=="string"){var paleoStr=first_point.attributes[i].replace(/\s+/g, '_');}
first_point.attributes[i]="<a href=https://en.wikipedia.org/wiki/"+paleoStr+" target=_blank>"+first_point.attributes[i]+'</a>';}}}

}
arrfirst_point.push(first_point);
}

var new_paleoBio = new OpenLayers.Layer.Vector(document.getElementById("id_textPaleoBiolLayer").value,{renderers:["Canvas", "SVG", "VML"]});
new_paleoBio.addFeatures(arrfirst_point);
var new_style_layer= new OpenLayers.Style({
 pointRadius: 3, fillColor: "#FF9000", strokeColor: "#FF9000", strokeWidth: 1,fillOpacity:1, strokeOpacity:1 });
 var selStyle = new OpenLayers.Style({ pointRadius: 5,  fillColor: "#ffaa00",
 strokeColor: "#00DDFF", strokeWidth:2,fillOpacity:1, strokeOpacity:1 }); 
new_paleoBio.styleMap=new OpenLayers.StyleMap({'default':new_style_layer,'select': selStyle});
new_paleoBio.events.register("loadstart",new_paleoBio, function() {WaitWindow();});
map.addLayer(new_paleoBio);
new_paleoBio.events.register("loadend",new_paleoBio, function() {if(popup_Wait){try{popup_Wait.destroy();}catch(e){};} });
 var t=document.createElement('option');
t.value=new_paleoBio.name;
t.text=new_paleoBio.name;
document.getElementById("editL1").appendChild(t);

}
}

alert("Эта функция работает только в онлайн веб-версии OpenWebGIS")
{return;
xmlhttp.send(null);}

}
function EarthquakesB()
{
var bbox = document.getElementById("map").getBoundingClientRect();
 var body = document.body
 var docElem = document.documentElement
 var scrollTop = window.pageYOffset || docElem.scrollTop || body.scrollTop
 var scrollLeft = window.pageXOffset || docElem.scrollLeft || body.scrollLeft
 var clientTop = docElem.clientTop || body.clientTop || 0
 var clientLeft = docElem.clientLeft || body.clientLeft || 0
 var topTop = bbox.top + scrollTop - clientTop
 var leftLeft = bbox.left + scrollLeft - clientLeft
var DivEditeLeg=document.createElement("div");
DivEditeLeg.id="id_EarthQLegMain2";
DivEditeLeg.className="id_divRoutLegMain";
DivEditeLeg.style.position="relative";

DivEditeLeg.innerHTML='<div id="id_divEarthQLeg" style="background:#ffffff; color:#0000ff;z-index: 6000;position:absolute;left:'+Math.round(leftLeft+50)+'px;top:'+Math.round(topTop-100)+
'px;overflow:hidden; border: 1px solid black;"><img onclick="closeEarthQWin()" src="openlayers/theme/default/img/close.gif" style="position:relative; top:10px;float:right; cursor:pointer"><a style="position:relative; top:20px"></a>'+
'<a style="font-size: 9px;"> Вы можете перемещать это окно если щёлкните по пункту меню: Интерфейс->переключить режим интерфейса</a><br>'+
'<a>Information provided by:</a><br> <a href="http://www.usgs.gov" target="_blank">USGS. USGS is a science bureau within the United States Department of the Interior;</a><br>'+
'<a><a href="http://www.usgs.gov/faq/" target="_blank"> USGS FAQs;</a></a>'+
'<a><a href="http://earthquake.usgs.gov/earthquakes/search/" target="_blank">Earthquake Archive Search;<a></a><br>'+
'<a>Дата и время.</a>'+
'<a>Start (UTC): </a><input type="text" size="18" id="id_startTimeEarthQ" value="2014-01-01T00:00:00" title="Формат даты согласно стандарту ISO8601:гггг-мм-ддTчч:мм:сс. Implicity UTC timezone, and time at start of the day (00:00:00)"/>'+
'<a>End (UTC): </a><input type="text" size="18" id="id_endTimeEarthQ" value="2014-08-25T23:59:59" title="Формат даты согласно стандарту ISO8601:гггг-мм-ддTчч:мм:сс. Implicity UTC timezone, and time at start of the day (00:00:00)"/><br>'+
'<a>Магнитуда.</a>'+
'<a>Minimum:</a><input type="text" size="5" id="id_minMagEarthQ" value="6" title="The magnitude for the event. interval:[-1.0, 10.0]"/>'+
'<a>Maximum:</a><input type="text" size="5" id="id_maxMagEarthQ" value="10"/><br>'+
'<a>Глубина(km).</a>'+
'<a>Minimum:</a><input type="text" size="5" id="id_minDepEarthQ" title="Decimal kilometers: [-100, 1000]"/>'+
'<a>Maximum:</a><input type="text" size="5" id="id_maxDepEarthQ" title="Decimal kilometers: [-100, 1000]"/><br>'+
'<a>Azimuthal Gap.</a>'+
'<a>Minimum:</a><input type="text" size="5" id="id_minAzEarthQ" title="Decimal degrees [0,360]" />'+
'<a>Maximum:</a><input type="text" size="5" id="id_maxAzEarthQ" title="Decimal degrees [0,360]"/><br>'+
'<a>Количество результатов:</a><input type="text" size="5" id="id_RezEarthQ" value="100" title="Максимальное количество результатов: 20000. " /><br>'+
'<a>Географический регион(прямоугольник):</a><br>'+
'<input title="Координаты левого нижнего угла.Вы можете ввести вручную или щёлкнуть по карте. Координаты вводятся щелчком по карте, если в этом поле ноль или пусто" type="text" size="8" id="first_longE" value="0"/>нижняя левая долгота, вы можете щёлкнуть по карте<br>'+
'<input title="coordinate of the lower left corner" type="text" size="8" id="first_latE" value="0"/>нижняя левая широта<br>'+
'<input title="Координаты верхнего правого угла. Вы можете ввести вручную или щёлкнуть по карте. Координаты вводятся щелчком по карте, если в этом поле ноль или пусто" type="text" size="8" id="sec_longE" value="0"/>верхняя правая долгота<br>'+
'<input title="coordinate of the upper-right corner" type="text" size="8" id="sec_latE" value="0"/>верхняя правая широта<br>'+
'<a>Введите название Слоя:</a><input type="text" size="35" id="id_textEarthQuaLayer" title="Insert name of layer" value="EarthQuake"/>'+
'<p> <button type=button onclick=OK_EarthquakesB()>OK</button></p><div id="waitEarthQuake"></div></div>'
if(!document.getElementById("id_divEarthQLeg"))
{body.appendChild(DivEditeLeg); 
OpenLayers.Control.Click = OpenLayers.Class(OpenLayers.Control, {                
defaultHandlerOptions: {'single': true,'double': false,'pixelTolerance': 0,'stopSingle': false,'stopDouble': false},
initialize: function(options) {
this.handlerOptions = OpenLayers.Util.extend(
{}, this.defaultHandlerOptions);
OpenLayers.Control.prototype.initialize.apply(
this, arguments); 
this.handler = new OpenLayers.Handler.Click(
                        this, {'click': this.trigger}, this.handlerOptions
                    );
                }, 
trigger: function(e) {
var lonlat = map.getLonLatFromPixel(e.xy);
var new_pos=new OpenLayers.LonLat(lonlat.lon,lonlat.lat).transform(
map.getProjectionObject(),new OpenLayers.Projection("EPSG:4326"));
if(document.getElementById("first_longE"))
{if(document.getElementById("first_longE").value==''||document.getElementById("first_longE").value=='0')
{document.getElementById("first_longE").value=new_pos.lon;
document.getElementById("first_latE").value=new_pos.lat;}
else{
if(document.getElementById("sec_longE").value==''||document.getElementById("sec_longE").value=='0')
{document.getElementById("sec_longE").value=new_pos.lon;
document.getElementById("sec_latE").value=new_pos.lat;}}
}

    }

});
var clickEarthQCoordinates = new OpenLayers.Control.Click();
clickEarthQCoordinates.title="click to get coordinates for EarthQuake";
 map.addControl(clickEarthQCoordinates);
clickEarthQCoordinates.activate();

document.getElementById("id_EarthQLegMain2").onmousedown=function(event){drags(event)};
document.getElementById("id_EarthQLegMain2").onmouseup=function(e){enddrag()};
}
var d=new Date();
var Y=d.getFullYear();var M=d.getMonth()+1;if(parseInt(M)<10){M='0'+M;}
var D=d.getDate();if(parseInt(D)<10){D='0'+D;}var H=d.getHours();if(parseInt(H)<10){H='0'+H;}
var MM=d.getMinutes();if(parseInt(MM)<10){MM='0'+MM;}var S=d.getSeconds();if(parseInt(S)<10){S='0'+S;}
var neD=Y+'-'+M+'-'+D+'T'+H+':'+MM+':'+S;

document.getElementById("id_endTimeEarthQ").value=neD;
}
function InternationalSpace()
{
var scriptWMS = document.createElement("script"); 
scriptWMS.src = 'satellite.js'; 
 scriptWMS.type = 'text/javascript'; 
 scriptWMS.id="InternSpace_script_id";
scriptWMS.async=false;

//scriptWMS.onload= func1();
if(!document.getElementById("InternSpace_script_id"))
 {document.body.appendChild(scriptWMS);}

var bbox = document.getElementById("map").getBoundingClientRect();
 var body = document.body
 var docElem = document.documentElement
 var scrollTop = window.pageYOffset || docElem.scrollTop || body.scrollTop
 var scrollLeft = window.pageXOffset || docElem.scrollLeft || body.scrollLeft
 var clientTop = docElem.clientTop || body.clientTop || 0
 var clientLeft = docElem.clientLeft || body.clientLeft || 0
 var topTop = bbox.top + scrollTop - clientTop
 var leftLeft = bbox.left + scrollLeft - clientLeft
var DivEditeLeg=document.createElement("div");
DivEditeLeg.id="id_divISSLegMain2";
DivEditeLeg.className="id_divRoutLegMain";
DivEditeLeg.style.position="relative";
//DivEditeLeg.onmouseup="enddrag()";DivEditeLeg.onmousedown="drags(event)"
DivEditeLeg.innerHTML='<div id="id_divISSLeg" style="background:#ffffff; color:#0000ff;z-index: 6000;position:absolute;left:'+Math.round(leftLeft+50)+'px;top:'+Math.round(topTop-100)+
'px;overflow:hidden; border: 1px solid black;"><img onclick="closeSatelliteWin2()" src="openlayers/theme/default/img/close.gif" style="position:relative; top:10px;float:right; cursor:pointer"><a style="position:relative; top:20px"></a>'+
'<a style="font-size: 9px;"> Вы можете перемещать это окно если щёлкните по пункту меню: Интерфейс->переключить режим интерфейса</a><br>'+
'<a>Установить интервал обновления в миллисекундах:</a>'+
'<input  type="text" size="8" id="interval_refreshISS_id" value="1000"/><br>'+
'<button id="OK_PlaySpace_id" type=button title="Показать траекторию спутника Земли в реальном времени( в том числе с любой указанной даты)" onclick=OK_PlaySpace()>Траектория в реальном времени</button>'+
'<button type=button title="Pause" onclick=OK_PauseSpace()>Пауза</button>'+
'<button type=button title="Stop" onclick=OK_StopTimeSpace()>Стоп</button><div id="div_id_TimeTec"></div>'+
'<input type="checkbox" id="id_DelIssFeature" title="" value="checkbox"/>оставлять последние: <input  type="text" size="6" id="leaveISS_id" value="10"/>точек<br>'+
'<input type="checkbox" id="id_StartDateISS" title="Если здесь не поставлена галочка, то трек будет рассчитываться с текущего времени UTC/GMT date/time (Всемирное координированное время).UTC (Universal Coordinated Time).GMT (Greenwich Mean Time)" value="checkbox"/><a>Начать с даты/времени:</a><br>'+
'<input type="text" size="2" id="SaTimeYear1" value="2010"/><a style="font-size: 11px;">год</a> '+
'<input type="text" size="1" id="SaTimeMonth1" value="11"/><a style="font-size: 11px;">месяц</a> '+
'<input type="text" size="1" id="SaTimeDay1" value="01"/><a style="font-size: 11px;">день</a>'+
'<input type="text" size="1" id="SaTimeHour1" value="02"/><a style="font-size: 11px;">час</a>'+
'<input type="text" size="1" id="SaTimeMin1" value="20"/><a style="font-size: 11px;">минута</a>'+
'<input type="text" size="1" id="SaTimeSec1" value="30"/><a style="font-size: 11px;">секунда UTC/GMT date/time</a><br>'+
'<input type="checkbox" id="id_endDateSatel" title="Конечная дата учитывается только при рассчёте функций /Ok слой точек/ and /Ok слой линий/" value="checkbox"/>конечная дата:'+
'<input type="text" size="2" id="SaTimeYear2" title="Конечная дата учитывается только при рассчёте функций /Ok слой точек/ and /Ok слой линий/" value="2010" style="font-size: 10px;"/><a style="font-size: 11px;">год</a> '+
'<input type="text" size="1" id="SaTimeMonth2" value="11" style="font-size: 10px;"/><a style="font-size: 11px;">месяц</a> '+
'<input type="text" size="1" id="SaTimeDay2" value="01" style="font-size: 10px;"/><a style="font-size: 11px;">день</a>'+
'<input type="text" size="1" id="SaTimeHour2" value="02" style="font-size: 10px;"/><a style="font-size: 11px;">час</a>'+
'<input type="text" size="1" id="SaTimeMin2" value="20" title="Конечная дата учитывается только при рассчёте функций /Ok слой точек/ and /Ok слой линий/" style="font-size: 10px;"/><a style="font-size: 11px;">минута</a>'+
'<input type="text" size="1" id="SaTimeSec2" value="40" style="font-size: 10px;"/><a style="font-size: 11px;">секунда </a><br>'+
'<a style="font-size: 11px;">Создать трек с начальной по конечную дату?:</a><button id="OK_SatelB1" type=button title="Щёлкните для создания трека от начальной даты до конечной в виде набора точек. В этом случае долгота, широта, скорость, высота и время рассчитываются для каждой точкиt. Эти величины добавляются в слой в виде атрибутов" onclick=OK_SatelTrackLP()><a style="font-size: 9px;">Ok слой точек</a></button><button type=button id="OK_SatelB2" title="Щёлкните для создания трека от начальной даты до конечной в виде набора линий. В этом случае средняя скорость, средняя высота будут расчитаны для всего трека.Эти величины добавляются в слой в виде атрибутов." onclick=OK_SatelTrackLP()><a style="font-size: 9px;">Ok слой линий</a></button><br>'+

'<a>Название слоя:</a><input  type="text" size="6" id="namesatellite_id" value="Satellite"/><a>; Название спутника:</a><textarea  id="nameLsatellite_id" style="width: 240px; height: 20px;font-size:11px" value="Международная космическая станция">Международная космическая станция</textarea><br>'+
'<a>Введите TLE-файл или его url:</a><textarea id="SatelliteTextArea" style="width: 300px; height: 20px;font-size:11px" value="http://wsn.spaceflight.esa.int/iss/tledata.txt" title="Введите url TLE-файла в таком формате: http://wsn.spaceflight.esa.int/iss/tledata.txt или введите содержимое TLE-файла в таком формате: ISS (ZARYA)\n 1 25544U 98067A   08264.51782528 -.00002182  00000-0 -11606-4 0  2927\n 2 25544  51.6416 247.4627 0006703 130.5360 325.0288 15.72125391563537\n TLE (аббр. от англ. two-line element set, двухстрочный набор элементов) — двухстрочный формат данных, представляющий собой набор элементов орбиты для спутника Земли.">http://wsn.spaceflight.esa.int/iss/tledata.txt</textarea><br>'+
'<input type="checkbox" id="id_MoveSatelmap" title="" value="checkbox"/><a style="font-size: 11px;">перемещать экстент карты за спутником. размер экстента в градусах</a><input type="text" style="font-size: 11px;" title="size square in degrees" size="2" id="satelmovemap_val" value="20"/><br>'+
'<a>информация:</a><div id="SatelInf0" style="font-size: 10px;"></div>'+
//+'<div id="SatelInf2" style="font-size: 10px;"></div>'+'<div id="SatelInf3" style="font-size: 10px;"></div>'+'<div id="SatelInf4" style="font-size: 10px;"></div>'+
'</div>';
//'<p> <button type=button onclick=InternationalSpace2()>OK</button></p>'
if(!document.getElementById("id_divISSLegMain2"))
{body.appendChild(DivEditeLeg); }
document.getElementById("id_divISSLegMain2").onmousedown=function(event){drags(event)};
document.getElementById("id_divISSLegMain2").onmouseup=function(e){enddrag()};
var typeL=0;
document.getElementById("OK_SatelB1").onclick=function(){typeL=1;OK_SatelTrackLP(typeL)}
document.getElementById("OK_SatelB2").onclick=function(){typeL=2;OK_SatelTrackLP(typeL)} 
}
function OK_SatelTrackLP2(tle_line_1,tle_line_2,typeL)
{
var ISS = new OpenLayers.Layer.Vector(document.getElementById("namesatellite_id").value,{renderers:["Canvas", "SVG", "VML"]});
var new_style_layer= new OpenLayers.Style({
 pointRadius: 3, fillColor: "#FF9000", strokeColor: "#FF9000",
 strokeWidth: 1,fillOpacity:1, strokeOpacity:1 });
 var selStyle = new OpenLayers.Style({ pointRadius: 5,  fillColor: "#ffaa00", strokeColor: "#00DDFF", strokeWidth:2,fillOpacity:1, strokeOpacity:1 }); 
ISS.styleMap=new OpenLayers.StyleMap({'default':new_style_layer,'select': selStyle});
ISS.projection=new OpenLayers.Projection("EPSG:900913");map.addLayer(ISS);
var t=document.createElement('option');
t.value=ISS.name;t.text=ISS.name;
document.getElementById("editL1").appendChild(t);
var TYear1=document.getElementById("SaTimeYear1").value;var TMonth1=document.getElementById("SaTimeMonth1").value;
var TDay1=document.getElementById("SaTimeDay1").value;var THour1=document.getElementById("SaTimeHour1").value;
var TMin1=document.getElementById("SaTimeMin1").value;var TSec1=document.getElementById("SaTimeSec1").value;
var now1=new Date(Date.UTC(TYear1,TMonth1-1,TDay1,THour1,TMin1,TSec1));var st1=now1.getTime();var yii=new Date(st1);
var TYear2=document.getElementById("SaTimeYear2").value;var TMonth2=document.getElementById("SaTimeMonth2").value;
var TDay2=document.getElementById("SaTimeDay2").value;var THour2=document.getElementById("SaTimeHour2").value;
var TMin2=document.getElementById("SaTimeMin2").value;var TSec2=document.getElementById("SaTimeSec2").value;
var now2=new Date(Date.UTC(TYear2,TMonth2-1,TDay2,THour2,TMin2,TSec2));var st2=now2.getTime();var yii2=new Date(st2);
var Y=now1.getUTCFullYear();var M=now1.getUTCMonth()+1;if(parseInt(M)<10){M='0'+M;}var D=now1.getUTCDate();if(parseInt(D)<10){D='0'+D;}
var H=now1.getUTCHours();if(parseInt(H)<10){H='0'+H;}var MM=now1.getUTCMinutes();if(parseInt(MM)<10){MM='0'+MM;}var S=now1.getUTCSeconds();if(parseInt(S)<10){S='0'+S;}
var neD1=Y+'-'+M+'-'+D+'T'+H+':'+MM+':'+S;
var Y=now2.getUTCFullYear();var M=now2.getUTCMonth()+1;if(parseInt(M)<10){M='0'+M;}var D=now2.getUTCDate();if(parseInt(D)<10){D='0'+D;}
var H=now2.getUTCHours();if(parseInt(H)<10){H='0'+H;}var MM=now2.getUTCMinutes();if(parseInt(MM)<10){MM='0'+MM;}var S=now2.getUTCSeconds();if(parseInt(S)<10){S='0'+S;}
var neD2=Y+'-'+M+'-'+D+'T'+H+':'+MM+':'+S;
var sumH=0;var SumVel=0;var ArrP=[];
while(yii.getTime()<yii2.getTime())
{
yii.setUTCMilliseconds(yii.getUTCMilliseconds()+parseInt(document.getElementById("interval_refreshISS_id").value))
var now=yii;
var satrec = satellite.twoline2satrec (tle_line_1, tle_line_2);
var nM=now.getUTCMonth()+1;
var position_and_velocity = satellite.propagate (satrec,
now.getUTCFullYear(), 
nM, // Note, this function requires months in range 1-12. 
now.getUTCDate(),now.getUTCHours(), 
now.getUTCMinutes(), now.getUTCSeconds());var Y=now.getUTCFullYear();
var M=now.getUTCMonth()+1;if(parseInt(M)<10){M='0'+M;}
var D=now.getUTCDate();if(parseInt(D)<10){D='0'+D;}
var H=now.getUTCHours();if(parseInt(H)<10){H='0'+H;}
var MM=now.getUTCMinutes();if(parseInt(MM)<10){MM='0'+MM;}
var S=now.getUTCSeconds();if(parseInt(S)<10){S='0'+S;}
var neD=Y+'-'+M+'-'+D+'T'+H+':'+MM+':'+S;

var position_eci = position_and_velocity["position"];
var velocity_eci = position_and_velocity["velocity"];
var nM=now.getUTCMonth()+1;
var gmst = satellite.gstime_from_date (now.getUTCFullYear(), 
nM, // Note, this function requires months in range 1-12. 
now.getUTCDate(),now.getUTCHours(), 
now.getUTCMinutes(),now.getUTCSeconds());
// You can get ECF, Geodetic, Look Angles, and Doppler Factor.
var position_ecf   = satellite.eci_to_ecf (position_eci, gmst);
//var observer_ecf   = satellite.geodetic_to_ecf (observer_gd);
var position_gd    = satellite.eci_to_geodetic (position_eci, gmst);
var velocity = Math.sqrt(velocity_eci["x"]*velocity_eci["x"]+velocity_eci["y"]*velocity_eci["y"]+velocity_eci["z"]*velocity_eci["z"])*60*60;

var satellite_x = position_eci["x"];var satellite_y = position_eci["y"];var satellite_z = position_eci["z"];
// Geodetic coords are accessed via "longitude", "latitude", "height".
var longitude = position_gd["longitude"];
var latitude = position_gd["latitude"];
var height = position_gd["height"];

//  Convert the RADIANS to DEGREES for pretty printing (appends "N", "S", "E", "W". etc).
var longitude_str = satellite.degrees_long (longitude);
var latitude_str  = satellite.degrees_lat  (latitude);


var new_pos2=new OpenLayers.LonLat(longitude_str, latitude_str).transform(new OpenLayers.Projection("EPSG:4326"),map.getProjectionObject());
var n_point= new OpenLayers.Geometry.Point(new_pos2.lon, new_pos2.lat);
if(typeL==2)
{ ArrP.push(n_point);sumH=sumH+height;SumVel=SumVel+velocity;}
if(typeL==1)
{var n_point= new OpenLayers.Feature.Vector(new OpenLayers.Geometry.Point(new_pos2.lon, new_pos2.lat));
n_point.attributes.name=document.getElementById("nameLsatellite_id").value; n_point.attributes.longitude=longitude_str;n_point.attributes.latitude=latitude_str;n_point.attributes.height=height;n_point.attributes.Date=neD;n_point.attributes.velocity=velocity;
ISS.addFeatures(n_point);}

}
if(typeL==2)
{
// Build the splitting line based on the min and max coordinates of the vector to split
var pointList = [];   var lastPoint = ArrP[0];
for(var iu=1;iu<ArrP.length;iu++)
{
  //Extract the minimum X from the data as bounds seems to be rounded.
if (Math.abs(ArrP[iu].x - lastPoint.x) > 10000000) {
pointList.push(ArrP[iu]);
        }
        lastPoint = ArrP[iu];
}
    var lineList = [];
    for(var i=0; i<pointList.length; i++) {
        lineList.push(new OpenLayers.Geometry.LineString([
            new OpenLayers.Geometry.Point(pointList[i].x, pointList[i].y-0.00001), 
            new OpenLayers.Geometry.Point(pointList[i].x, pointList[i].y+0.00001)
        ]));
    }

var featDateLine = new OpenLayers.Feature.Vector(new OpenLayers.Geometry.MultiLineString(lineList));

 var first_line1=new OpenLayers.Geometry.LineString(ArrP);
var resultsDateLine = first_line1.splitWith(featDateLine.geometry);
var features=[]; 
if(resultsDateLine)
    {for (var i = 0; i < resultsDateLine.length; i++) {
        // Remove the first (or last) point of the line, the one that cross the dateline
        if(resultsDateLine[i].components[1]){
        if (Math.abs(resultsDateLine[i].components[0].x - resultsDateLine[i].components[1].x) > 10000000) {
            resultsDateLine[i].removeComponent(resultsDateLine[i].components[0]);
        }
        if (Math.abs(resultsDateLine[i].components[resultsDateLine[i].components.length - 1].x - resultsDateLine[i].components[resultsDateLine[i].components.length - 2].x) > 10000000) {
            resultsDateLine[i].removeComponent(resultsDateLine[i].components[resultsDateLine[i].components.length - 1]);
        }}
        features.push(new OpenLayers.Feature.Vector(resultsDateLine[i]));
    }}
    else
    {
    var first_line1Feat=new OpenLayers.Feature.Vector(first_line1);
    features.push(first_line1Feat);
    }

    ISS.addFeatures(features);
for(var e=0;e<ISS.features.length;e++)
{ISS.features[e].attributes.name=document.getElementById("nameLsatellite_id").value;ISS.features[e].attributes.averageVelocity=SumVel/(ArrP.length);
ISS.features[e].attributes.averageheight=sumH/(ArrP.length);ISS.features[e].attributes.startDate=neD1;ISS.features[e].attributes.endDate=neD2;}
ArrP=[];
}
}
function OK_SatelTrackLP(typeL)
{
myUrl=document.getElementById("SatelliteTextArea").value;
if(myUrl.search(/http:/g)==-1)
{
var strSatel=myUrl;strSatel=strSatel.split('\n');
 var tle_line_1='';var tle_line_2='';
 for(var st=0;st<strSatel.length;st++)
 {if(strSatel[st].substring(0, 1)==1){tle_line_1=strSatel[st];}
 if(strSatel[st].substring(0, 1)==2){tle_line_2=strSatel[st];}
 }
if(tle_line_1=='')
{alert("error");return;}
if(tle_line_2.split(/\r/)[0]){tle_line_2=tle_line_2.split(/\r/)[0];}
if(tle_line_1.split(/\r/)[0]){tle_line_1=tle_line_1.split(/\r/)[0];}
if(tle_line_1.substr(53,1)=='-'){var arttle=tle_line_1.split('');arttle[53]=' ';tle_line_1=arttle.join('');}
OK_SatelTrackLP2(tle_line_1,tle_line_2,typeL)
}
else
{
xmlhttp.open('GET','/temp.php?c='+myUrl+'&rand='+Math.random(), true);
xmlhttp.setRequestHeader("Cache-Control", "no-cache");
xmlhttp.setRequestHeader("Content-type", "text/xml");
xmlhttp.onreadystatechange = function()
{if(xmlhttp.readyState == 4&&xmlhttp.status == 200) {
if(xmlhttp.responseText==''){alert("нет данных"); return;}var strSatel=xmlhttp.responseText;strSatel=strSatel.split('\n');
/* satellite.js is Modular set of functions for SGP4 and SDP4 propagation of TLEs. 
satellite-js v1.1  * (c) 2013 Shashwat Kandadai and UCSC
 * https://github.com/shashwatak/satellite-js  * License: MIT*/
 var tle_line_1='';var tle_line_2='';
 for(var st=0;st<strSatel.length;st++)
 {if(strSatel[st].substring(0, 1)==1){tle_line_1=strSatel[st];}
 if(strSatel[st].substring(0, 1)==2){tle_line_2=strSatel[st];}
 }
if(tle_line_1=='')
{alert("error");return;}
if(tle_line_2.split(/\r/)[0]){tle_line_2=tle_line_2.split(/\r/)[0];}
if(tle_line_1.split(/\r/)[0]){tle_line_1=tle_line_1.split(/\r/)[0];}
if(tle_line_1.substr(53,1)=='-'){var arttle=tle_line_1.split('');arttle[53]=' ';tle_line_1=arttle.join('');}
OK_SatelTrackLP2(tle_line_1,tle_line_2,typeL);
}else{if (xmlhttp.status== 404) {alert("нет данных"); return;}}}
alert("Эта функция работает только в онлайн веб-версии OpenWebGIS")
{return;
xmlhttp.send(null);}


}


}

function SatelitOpenwebgis(tle_line_1, tle_line_2,satelname)
{
if(tle_line_2.split(/\r/)[0]){tle_line_2=tle_line_2.split(/\r/)[0];}
if(tle_line_1.split(/\r/)[0]){tle_line_1=tle_line_1.split(/\r/)[0];}
if(tle_line_1.substr(53,1)=='-'){var arttle=tle_line_1.split('');arttle[53]=' ';tle_line_1=arttle.join('');}
  if(pauseSatellite!==1)
{var ISS = new OpenLayers.Layer.Vector(document.getElementById("namesatellite_id").value,{renderers:["Canvas", "SVG", "VML"]});
var new_style_layer= new OpenLayers.Style({
 pointRadius: 3, fillColor: "#FF9000", strokeColor: "#FF9000",
 strokeWidth: 1,fillOpacity:1, strokeOpacity:1 });
 var selStyle = new OpenLayers.Style({ pointRadius: 5,  fillColor: "#ffaa00", strokeColor: "#00DDFF", strokeWidth:2,fillOpacity:1, strokeOpacity:1 }); 
ISS.styleMap=new OpenLayers.StyleMap({'default':new_style_layer,'select': selStyle});
ISS.projection=new OpenLayers.Projection("EPSG:900913");map.addLayer(ISS);
var t=document.createElement('option');
t.value=ISS.name;t.text=ISS.name;
document.getElementById("editL1").appendChild(t);
ISS.SateliteString1=tle_line_1;
ISS.SateliteString2=tle_line_2;
ISS.SatelName=satelname;
}
var intervaTimeSpace=0;
var TYear1=document.getElementById("SaTimeYear1").value;var TMonth1=document.getElementById("SaTimeMonth1").value;
var TDay1=document.getElementById("SaTimeDay1").value;var THour1=document.getElementById("SaTimeHour1").value;
var TMin1=document.getElementById("SaTimeMin1").value;var TSec1=document.getElementById("SaTimeSec1").value;
if(document.getElementById("id_StartDateISS").checked==true)
{var now=new Date(Date.UTC(TYear1,TMonth1-1,TDay1,THour1,TMin1,TSec1));var st1=now.getTime();var yii=new Date(st1);}
intervaTimeSpace=setInterval( function(){
var satrec = satellite.twoline2satrec (tle_line_1, tle_line_2);
if(document.getElementById("id_StartDateISS").checked!==true)
{var now = new Date();}
else
{yii.setUTCMilliseconds(yii.getUTCMilliseconds()+parseInt(document.getElementById("interval_refreshISS_id").value));now=yii;}
// NOTE: while Javascript Date returns months in range 0-11, all satellite.js methods require months in range 1-12.
var nM=now.getUTCMonth() + 1;
var position_and_velocity = satellite.propagate (satrec,
now.getUTCFullYear(), 
nM, // Note, this function requires months in range 1-12. }
now.getUTCDate(),
now.getUTCHours(), 
now.getUTCMinutes(), 
now.getUTCSeconds());
var Y=now.getUTCFullYear();
var M=now.getUTCMonth()+1;if(parseInt(M)<10){M='0'+M;}
var D=now.getUTCDate();if(parseInt(D)<10){D='0'+D;}
var H=now.getUTCHours();if(parseInt(H)<10){H='0'+H;}
var MM=now.getUTCMinutes();if(parseInt(MM)<10){MM='0'+MM;}
var S=now.getUTCSeconds();if(parseInt(S)<10){S='0'+S;}
var neD=Y+'-'+M+'-'+D+'T'+H+':'+MM+':'+S;

// The position_velocity result is a key-value pair of ECI coordinates.
// These are the base results from which all other coordinates are derived.
var position_eci = position_and_velocity["position"];
var velocity_eci = position_and_velocity["velocity"];
// You will need GMST for some of the coordinate transforms
// Also, be aware that the month range is 1-12, not 0-11.
var nM=now.getUTCMonth() + 1;
var gmst = satellite.gstime_from_date (now.getUTCFullYear(), 
nM, // Note, this function requires months in range 1-12. 
now.getUTCDate(),now.getUTCHours(), 
now.getUTCMinutes(),now.getUTCSeconds());
// You can get ECF, Geodetic, Look Angles, and Doppler Factor.
var position_ecf   = satellite.eci_to_ecf (position_eci, gmst);
//var observer_ecf   = satellite.geodetic_to_ecf (observer_gd);
var position_gd    = satellite.eci_to_geodetic (position_eci, gmst);
var velocity = Math.sqrt(velocity_eci["x"]*velocity_eci["x"]+velocity_eci["y"]*velocity_eci["y"]+velocity_eci["z"]*velocity_eci["z"])*60*60;
//var look_angles    = satellite.ecf_to_look_angles (observer_gd, position_ecf);
//var doppler_factor = satellite.doppler_factor (observer_coords_ecf, position_ecf, velocity_ecf);

// The coordinates are all stored in key-value pairs.
// ECI and ECF are accessed by "x", "y", "z".
var satellite_x = position_eci["x"];
var satellite_y = position_eci["y"];
var satellite_z = position_eci["z"];

// Look Angles may be accessed by "azimuth", "elevation", "range_sat".
//var azimuth   = look_angles["azimuth"];
//var elevation = look_angles["elevation"];
//var rangeSat  = look_angles["rangeSat"];

// Geodetic coords are accessed via "longitude", "latitude", "height".
var longitude = position_gd["longitude"];
var latitude = position_gd["latitude"];
var height = position_gd["height"];

//  Convert the RADIANS to DEGREES for pretty printing (appends "N", "S", "E", "W". etc).
var longitude_str = satellite.degrees_long (longitude);
var latitude_str  = satellite.degrees_lat  (latitude);

var new_pos2=new OpenLayers.LonLat(longitude_str, latitude_str).transform(
new OpenLayers.Projection("EPSG:4326"),
map.getProjectionObject());
var n_point= new OpenLayers.Feature.Vector(new OpenLayers.Geometry.Point(new_pos2.lon, new_pos2.lat));
n_point.attributes.name=satelname; n_point.attributes.longitude=longitude_str;n_point.attributes.latitude=latitude_str;n_point.attributes.height=height;n_point.attributes.Date=neD;n_point.attributes.velocity=velocity;
var SatelInf1=document.createElement('div');var SatelInf2=document.createElement('div');var SatelInf3=document.createElement('div');var SatelInf4=document.createElement('div');var SatelInf00=document.createElement('div');var SatelInf5=document.createElement('div');
if(ISS&&pauseSatellite!==1)
{
SatelInf1.id="SatelInf1"+ISS.name;SatelInf2.id="SatelInf2"+ISS.name;SatelInf3.id="SatelInf3"+ISS.name;SatelInf4.id="SatelInf4"+ISS.name;SatelInf00.id="SatelInf00"+ISS.name;SatelInf5.id="SatelInf5"+ISS.name;
if(!document.getElementById(SatelInf1.id))
{ document.getElementById("SatelInf0").appendChild(SatelInf00);document.getElementById("SatelInf0").appendChild(SatelInf1);document.getElementById("SatelInf0").appendChild(SatelInf2); document.getElementById("SatelInf0").appendChild(SatelInf3);document.getElementById("SatelInf0").appendChild(SatelInf4);document.getElementById("SatelInf0").appendChild(SatelInf5);}
document.getElementById(SatelInf00.id).innerHTML=ISS.name+":";
document.getElementById(SatelInf1.id).innerHTML='долгота: '+longitude_str;document.getElementById(SatelInf2.id).innerHTML='широта: '+latitude_str;
document.getElementById(SatelInf3.id).innerHTML='высота: '+height+" км";document.getElementById(SatelInf4.id).innerHTML='Дата: '+neD;document.getElementById(SatelInf5.id).innerHTML="скорость:"+velocity+" км/ч";}
if(pauseSatellite==1)
{
for(var ff=0;ff<map.layers.length;ff++)
{
if(map.layers[ff].SateliteString1&&(map.layers[ff].SateliteString1==tle_line_1&&map.layers[ff].SateliteString2==tle_line_2))
{if (document.getElementById("id_MoveSatelmap").checked==true)
{var valg=parseFloat(document.getElementById("satelmovemap_val").value);var x1s=longitude_str-valg;var y1s=latitude_str-valg;var x2s=longitude_str+valg;var y2s=latitude_str+valg;var bounds=new OpenLayers.Bounds(x1s,y1s,x2s,y2s);
bounds.transform(new OpenLayers.Projection("EPSG:4326"),map.getProjectionObject());
map.zoomToExtent(bounds);}
if(document.getElementById("SatelInf1"+map.layers[ff].name))
{document.getElementById("SatelInf00"+map.layers[ff].name).innerHTML=map.layers[ff].name+":";document.getElementById("SatelInf1"+map.layers[ff].name).innerHTML='долгота: '+longitude_str;document.getElementById("SatelInf2"+map.layers[ff].name).innerHTML='широта: '+latitude_str;
document.getElementById("SatelInf3"+map.layers[ff].name).innerHTML='высота: '+height+" км";document.getElementById("SatelInf4"+map.layers[ff].name).innerHTML='Дата: '+neD;document.getElementById("SatelInf5"+map.layers[ff].name).innerHTML="скорость:"+velocity+" км/ч";}
map.layers[ff].addFeatures(n_point);var u=parseInt(document.getElementById("leaveISS_id").value)+1;if(document.getElementById("id_DelIssFeature").checked==true){if(map.layers[ff].features.length==u){if(map.layers[ff].features[0]){map.layers[ff].removeFeatures(map.layers[ff].features[0])}}}}

}
}
else
{if(!ISS)
{for(var ff=0;ff<map.layers.length;ff++)
{if(map.layers[ff].SateliteString1&&(map.layers[ff].SateliteString1==tle_line_1&&map.layers[ff].SateliteString2==tle_line_2))
{
if (document.getElementById("id_MoveSatelmap").checked==true)
{var valg=parseFloat(document.getElementById("satelmovemap_val").value);var x1s=longitude_str-valg;var y1s=latitude_str-valg;var x2s=longitude_str+valg;var y2s=latitude_str+valg;var bounds=new OpenLayers.Bounds(x1s,y1s,x2s,y2s);
bounds.transform(new OpenLayers.Projection("EPSG:4326"),map.getProjectionObject());
map.zoomToExtent(bounds);}
if(document.getElementById("SatelInf1"+map.layers[ff].name))
{document.getElementById("SatelInf00"+map.layers[ff].name).innerHTML=map.layers[ff].name+":";document.getElementById("SatelInf1"+map.layers[ff].name).innerHTML='долгота: '+longitude_str;document.getElementById("SatelInf2"+map.layers[ff].name).innerHTML='широта: '+latitude_str;
document.getElementById("SatelInf3"+map.layers[ff].name).innerHTML='высота: '+height +" км";document.getElementById("SatelInf4"+map.layers[ff].name).innerHTML='Дата: '+neD;document.getElementById("SatelInf5"+map.layers[ff].name).innerHTML="скорость:"+velocity+" км/ч";}
map.layers[ff].addFeatures(n_point);var u=parseInt(document.getElementById("leaveISS_id").value)+1;if(document.getElementById("id_DelIssFeature").checked==true){if(map.layers[ff].features.length==u){if(map.layers[ff].features[0]){map.layers[ff].removeFeatures(map.layers[ff].features[0])}}}}}
}
else
{if (document.getElementById("id_MoveSatelmap").checked==true)
{var valg=parseFloat(document.getElementById("satelmovemap_val").value);var x1s=longitude_str-valg;var y1s=latitude_str-valg;var x2s=longitude_str+valg;var y2s=latitude_str+valg;var bounds=new OpenLayers.Bounds(x1s,y1s,x2s,y2s);
bounds.transform(new OpenLayers.Projection("EPSG:4326"),map.getProjectionObject());
map.zoomToExtent(bounds);}
ISS.addFeatures(n_point);var u=parseInt(document.getElementById("leaveISS_id").value)+1;if(document.getElementById("id_DelIssFeature").checked==true){if(ISS.features.length==u){if(ISS.features[0]){ISS.removeFeatures(ISS.features[0])}}}}}
},document.getElementById("interval_refreshISS_id").value);
intervaTimeSpaceArray.push(intervaTimeSpace);

}
function OK_StopTimeSpace()
{if (confirm("Остановить и сбросить все настройки слоёв с треками?"))
{pauseSatellite=0;for(var b=0;b<intervaTimeSpaceArray.length;b++){clearInterval(intervaTimeSpaceArray[b]);}intervaTimeSpaceArray=[];
for(var ff=0;ff<map.layers.length;ff++)
{
if(map.layers[ff].SateliteString1){delete map.layers[ff].SateliteString1; delete map.layers[ff].SateliteString2;delete map.layers[ff].SatelName;}
}
}
else{return;}
}
function OK_PauseSpace()
{
for(var b=0;b<intervaTimeSpaceArray.length;b++){clearInterval(intervaTimeSpaceArray[b]);}intervaTimeSpaceArray=[]; pauseSatellite=1;
}
function OK_PlaySpace()
{

myUrl=document.getElementById("SatelliteTextArea").value;
if(pauseSatellite==1)
{
for(var ff=0;ff<map.layers.length;ff++)
{
if(map.layers[ff].SateliteString1)
{tle_line_1=map.layers[ff].SateliteString1;tle_line_2=map.layers[ff].SateliteString2;satelname=map.layers[ff].SatelName;SatelitOpenwebgis(tle_line_1,tle_line_2,satelname);}
}
if(pauseSatellite==1){pauseSatellite=0;}return;
}

if (confirm("Добавить слой с именем:"+document.getElementById("namesatellite_id").value+"?"))
{}
else{return;}
if(myUrl.search(/http:/g)==-1)
{
var strSatel=myUrl;strSatel=strSatel.split('\n');
 var tle_line_1='';var tle_line_2='';
 for(var st=0;st<strSatel.length;st++)
 {if(strSatel[st].substring(0, 1)==1){tle_line_1=strSatel[st];}
 if(strSatel[st].substring(0, 1)==2){tle_line_2=strSatel[st];}
 }
if(tle_line_1=='')
{alert("error");return;}
satelname=document.getElementById("nameLsatellite_id").value;
SatelitOpenwebgis(tle_line_1,tle_line_2,satelname);
return;
}
xmlhttp.open('GET','/temp.php?c='+myUrl+'&rand='+Math.random(), true);
xmlhttp.setRequestHeader("Cache-Control", "no-cache");
xmlhttp.setRequestHeader("Content-type", "text/xml");
xmlhttp.onreadystatechange = function()
{if(xmlhttp.readyState == 4&&xmlhttp.status == 200) {
if(xmlhttp.responseText==''){alert("нет данных"); return;}var strSatel=xmlhttp.responseText;strSatel=strSatel.split('\n');
/* satellite.js is Modular set of functions for SGP4 and SDP4 propagation of TLEs. 
satellite-js v1.1
 * (c) 2013 Shashwat Kandadai and UCSC
 * https://github.com/shashwatak/satellite-js
 * License: MIT*/
 var tle_line_1='';var tle_line_2='';
 for(var st=0;st<strSatel.length;st++)
 {if(strSatel[st].substring(0, 1)==1){tle_line_1=strSatel[st];}
 if(strSatel[st].substring(0, 1)==2){tle_line_2=strSatel[st];}
 }
if(tle_line_1=='')
{alert("error");return;}
satelname=document.getElementById("nameLsatellite_id").value;
SatelitOpenwebgis(tle_line_1,tle_line_2,satelname)
//var tle_line_1 ='1 25544U 98067A   14301.57885083  .00007989  00000-0  14430-3 0  3175';
//var tle_line_2='2 25544  51.6479 158.3557 0003625 328.9431  52.7021 15.50691486912020';

// Initialize a satellite record

}else{if (xmlhttp.status== 404) {alert("нет данных"); return;}}}
alert("Эта функция работает только в онлайн веб-версии OpenWebGIS")
{return;
xmlhttp.send(null);}

}
function MonTemperature()
{
var bbox = document.getElementById("map").getBoundingClientRect();
 var body = document.body
 var docElem = document.documentElement
 var scrollTop = window.pageYOffset || docElem.scrollTop || body.scrollTop
 var scrollLeft = window.pageXOffset || docElem.scrollLeft || body.scrollLeft
 var clientTop = docElem.clientTop || body.clientTop || 0
 var clientLeft = docElem.clientLeft || body.clientLeft || 0
 var topTop = bbox.top + scrollTop - clientTop
 var leftLeft = bbox.left + scrollLeft - clientLeft
var DivEditeLeg=document.createElement("div");
DivEditeLeg.id="id_MonTempLegMain2";
DivEditeLeg.className="id_divRoutLegMain";
DivEditeLeg.style.position="relative";
// Reyn_SmithOI v1  Sea surface temperature fields blended from ship, buoy and bias-corrected satellite data (Reynolds and Smith 1994)
//dataset Reyn_SmithOI v2 IGOSS nmc Reyn_SmithOIv2: SST fields updated from version v1 with more COADS data, new sea-ice to SST conversion algorithm, and 1971-2000 climatology

DivEditeLeg.innerHTML='<div id="id_divMonTempLeg" style="background:#ffffff; color:#0000ff;z-index: 6000;position:absolute;left:'+Math.round(leftLeft+50)+'px;top:'+Math.round(topTop-100)+
'px;overflow:hidden; border: 1px solid black;"><img onclick="closeMTempWin()" src="openlayers/theme/default/img/close.gif" style="position:relative; top:10px;float:right; cursor:pointer"><a style="position:relative; top:20px"></a>'+
'<a style="font-size: 9px;"> Вы можете перемещать это окно если щёлкните по пункту меню: Интерфейс->переключить режим интерфейса</a><br>'+
'<a>Данные представлены:</a><br> <a href="http://iridl.ldeo.columbia.edu" target="_blank">International Research Institute for Climate and Society (IGOSS);</a><br>'+
'<a href="http://iridl.ldeo.columbia.edu/SOURCES/.IGOSS/.nmc/overview.html" target="_blank">Разрешение: 1x1(одноградусные квадраты); Период: [с Ноября 1981]; по месяцам</a><br>'+
'<a>Дата </a>'+
'<a>начало: </a>'+
'<select id="month1_Montemp" style="background:#f5f7fa;border: 1px solid black" style="font-size: 11px;">'+
'<option value="Jan">Январь</option><option value="Feb">Февраль</option><option value="Mar">Март</option><option value="Apr">Апрель</option><option value="May">Май</option><option value="Jun">Июнь</option><option value="Jul">Июль</option><option value="Aug">Август</option><option value="Sep">Сентябрь</option><option value="Oct">Октябрь</option><option value="Nov">Ноябрь</option><option value="Dec">Декабрь</option>'+
'</select>'+
'<input type="text" size="5" id="id_startYearMonTemp" value="2015" title="Format: insert only year(for example: 2015)"/>'+
'<a>конец: </a>'+'<select id="month2_Montemp" style="background:#f5f7fa;border: 1px solid black" style="font-size: 11px;">'+
'<option value="Jan">Январь</option><option value="Feb">Февраль</option><option value="Mar">Март</option><option value="Apr">Апрель</option><option value="May">Май</option><option value="Jun">Июнь</option><option value="Jul">Июль</option><option value="Aug">Август</option><option value="Sep">Сентябрь</option><option value="Oct">Октябрь</option><option value="Nov">Ноябрь</option><option value="Dec">Декабрь</option>'+
'</select>'+'<input type="text" size="5" id="id_endYearMonTemp" value="2015" title="Формат: вводите только год(например: 2015)"/><br>'+
'<a>Географический регион(прямоугольник):</a><br>'+
'<input title="Координаты левого нижнего угла.Вы можете ввести вручную или щёлкнуть по карте. Координаты вводятся щелчком по карте, если в этом поле ноль или пусто" type="text" size="8" id="first_longEm" value="0"/>нижняя левая долгота, вы можете щёлкнуть по карте<br>'+
'<input title="coordinate of the lower left corner" type="text" size="8" id="first_latEm" value="0"/>нижняя левая широта<br>'+
'<input title="Координаты верхнего правого угла. Вы можете ввести вручную или щёлкнуть по карте. Координаты вводятся щелчком по карте, если в этом поле ноль или пусто" type="text" size="8" id="sec_longEm" value="0"/>верхняя правая долгота<br>'+'<input title="coordinate of the upper-right corner" type="text" size="8" id="sec_latEm" value="0"/>верхняя правая широта<br>'+

'<a>insert name of Layer:</a><input type="text" size="35" id="id_textMtemperLayer" title="Insert name of layer" value="MontlyTemperature"/>'+
'<p> <button type=button onclick=OK_MonTemperature()>OK</button></p><div id="waitMonTemp"></div>'
if(!document.getElementById("id_divMonTempLeg"))
{body.appendChild(DivEditeLeg); 
OpenLayers.Control.Click = OpenLayers.Class(OpenLayers.Control, {                
defaultHandlerOptions: {'single': true,'double': false,'pixelTolerance': 0,'stopSingle': false,'stopDouble': false},
initialize: function(options) {this.handlerOptions = OpenLayers.Util.extend({}, this.defaultHandlerOptions);OpenLayers.Control.prototype.initialize.apply(this, arguments); 
this.handler = new OpenLayers.Handler.Click(this, {'click': this.trigger}, this.handlerOptions);}, 
trigger: function(e) {var lonlat = map.getLonLatFromPixel(e.xy);
var new_pos=new OpenLayers.LonLat(lonlat.lon,lonlat.lat).transform(
map.getProjectionObject(),new OpenLayers.Projection("EPSG:4326"));
if(document.getElementById("first_longEm"))
{if(document.getElementById("first_longEm").value==''||document.getElementById("first_longEm").value=='0')
{document.getElementById("first_longEm").value=new_pos.lon;
document.getElementById("first_latEm").value=new_pos.lat;}
else{
if(document.getElementById("sec_longEm").value==''||document.getElementById("sec_longEm").value=='0')
{document.getElementById("sec_longEm").value=new_pos.lon;
document.getElementById("sec_latEm").value=new_pos.lat;}}
}  }
});
var clickEarthQCoordinates = new OpenLayers.Control.Click();
clickEarthQCoordinates.title="click to get coordinates for MontlyTemperature";
 map.addControl(clickEarthQCoordinates);
clickEarthQCoordinates.activate();

document.getElementById("id_MonTempLegMain2").onmousedown=function(event){drags(event)};
document.getElementById("id_MonTempLegMain2").onmouseup=function(e){enddrag()};
}

}
function closeOSMDBWin()
{document.getElementById("id_OpenStreetMapMain2").parentNode.removeChild(document.getElementById("id_OpenStreetMapMain2"));
for(var i=0;i<map.controls.length;i++){if(map.controls[i].title=="Download this bounding box from the OpenStreetMap database"){ map.controls[i].destroy();}} delete OpenLayers.Control.Click;
}
function closeMTempWin()
{document.getElementById("id_MonTempLegMain2").parentNode.removeChild(document.getElementById("id_MonTempLegMain2"));
for(var i=0;i<map.controls.length;i++){if(map.controls[i].title=="click to get coordinates for MontlyTemperature"){ map.controls[i].destroy();}} delete OpenLayers.Control.Click;
}
function OK_MonTemperature()
{ var lat1=document.getElementById("first_latEm").value; var lat2=document.getElementById("sec_latEm").value;
var lon1=document.getElementById("first_longEm").value; var lon2=document.getElementById("sec_longEm").value;
var mon1=document.getElementById("month1_Montemp").value; var mon2=document.getElementById("month2_Montemp").value;
var year1=document.getElementById("id_startYearMonTemp").value;var year2=document.getElementById("id_endYearMonTemp").value;
var d1=mon1+year1;var d2=mon2+year2;
var myUrl='http://iridl.ldeo.columbia.edu/SOURCES/.IGOSS/.nmc/.Reyn_SmithOIv2/.monthly/.sst/Y/%28'+
lat1+'%29%28'+lat2+'%29RANGEEDGES/X/%28'+lon1+'+%29%28'+lon2+'%29RANGEEDGES/T/%28'+mon1+'%20'+year1+'%29%28'+mon2+'%20'+year2+'%29RANGEEDGES/ngridtable+table-+skipanyNaN+4+-table+.html';
if(d1==d2){
var myUrl='http://iridl.ldeo.columbia.edu/SOURCES/.IGOSS/.nmc/.Reyn_SmithOIv2/.monthly/.sst/Y/%28'+
lat1+'%29%28'+lat2+'%29RANGEEDGES/X/%28'+lon1+'+%29%28'+lon2+'%29RANGEEDGES/T/%28'+mon1+'%20'+year1+'%29%28'+mon2+'%20'+year2+'%29RANGEEDGES/ngridtable+table-+skipanyNaN+3+-table+.html';
}
//myUrl=encodeURIComponent(myUrl);
try {var xmlhttp =new XMLHttpRequest();}
catch (e) {rtt=e;alert(e);return;}
var waitT=document.createElement('a');
waitT.id="a_waitMonTemper";
waitT.innerHTML="Wait...";
document.getElementById("waitMonTemp").appendChild(waitT);

xmlhttp.open('GET','/temp.php?c='+myUrl+'&rand='+Math.random(), true);
xmlhttp.setRequestHeader("Cache-Control", "no-cache");
xmlhttp.setRequestHeader("Content-type", "text/xml");
xmlhttp.onreadystatechange = function()
{if(xmlhttp.readyState == 4&&xmlhttp.status == 200) 
{if(document.getElementById("a_waitMonTemper")){document.getElementById("a_waitMonTemper").parentNode.removeChild(document.getElementById("a_waitMonTemper"))}
if(xmlhttp.responseText=="cURL Error: "){alert("no data");return;}
if(xmlhttp.responseText==""){alert("error");return;}
if(xmlhttp.responseText!=='')
{
var res=xmlhttp.responseText; 
var resarray=res.split('<tr>');var arrFeaturest=[];
for(var i=3;i<resarray.length;i++)
{var r1=resarray[i].split('<td>');
var l=r1[1].split('</td>')[0]; var l2=r1[2].split('</td>')[0]; 
if(l.split('W')[0]!==l){l=parseFloat(l.split('E')[0])*(-1)}else{if(l.split('E')[0]!==l){l=parseFloat(l.split('W')[0])*(1);}}
if(l2.split('S')[0]!==l2){l2=parseFloat(l2.split('N')[0])*(-1)}else{if(l2.split('N')[0]!==l2){l2=parseFloat(l2.split('S')[0])*(1);}}
var new_pos2=new OpenLayers.LonLat(l,l2).transform(new OpenLayers.Projection("EPSG:4326"),map.getProjectionObject());
var point=new OpenLayers.Geometry.Point(new_pos2.lon, new_pos2.lat)
var first_point= new OpenLayers.Feature.Vector(point);
first_point.attributes.longitude=l;first_point.attributes.latitude=l2;
if(r1.length==5){first_point.attributes.temperature=r1[4].split('</td></tr>\n')[0];}
if(r1.length==4){first_point.attributes.temperature=r1[3].split('</td></tr>\n')[0];}
if(r1.length==5){var datestr=r1[3].split('</td>')[0];}
if(r1.length==4)
{var year1=document.getElementById("id_startYearMonTemp").value;var d1=mon1+" "+year1;
var datestr=d1;}
datestr=datestr.replace('Jan ','-01-01T00:00:00;');datestr=datestr.replace('Feb ','-02-01T00:00:00;');datestr=datestr.replace('Mar ','-03-01T00:00:00;');datestr=datestr.replace('Apr ','-04-01T00:00:00;');
datestr=datestr.replace('May ','-05-01T00:00:00;');datestr=datestr.replace('Jun ','-06-01T00:00:00;');datestr=datestr.replace('Jul ','-07-01T00:00:00;');datestr=datestr.replace('Aug ','-08-01T00:00:00;');
datestr=datestr.replace('Sep ','-09-01T00:00:00;');
datestr=datestr.replace('Oct ','-10-01T00:00:00;');datestr=datestr.replace('Nov ','-11-01T00:00:00;');datestr=datestr.replace('Dec ','-12-01T00:00:00;');
datestr=datestr.split(';')[1]+datestr.split(';')[0]


first_point.attributes.date=datestr;
arrFeaturest.push(first_point)
}
var new_Temper = new OpenLayers.Layer.Vector(document.getElementById("id_textMtemperLayer").value,{renderers:["Canvas", "SVG", "VML"]});
new_Temper.addFeatures(arrFeaturest);
var new_style_layer= new OpenLayers.Style({
 pointRadius: 3, fillColor: "#FF9000", strokeColor: "#FF9000", strokeWidth: 1,fillOpacity:1, strokeOpacity:1 });
 var selStyle = new OpenLayers.Style({ pointRadius: 5,  fillColor: "#ffaa00",
 strokeColor: "#00DDFF", strokeWidth:2,fillOpacity:1, strokeOpacity:1 }); 
new_Temper.styleMap=new OpenLayers.StyleMap({'default':new_style_layer,'select': selStyle});
new_Temper.events.register("loadstart",new_Temper, function() {WaitWindow();});
map.addLayer(new_Temper);
new_Temper.events.register("loadend",new_Temper, function() {if(popup_Wait){try{popup_Wait.destroy();}catch(e){};} });
 var t=document.createElement('option');
t.value=new_Temper.name;t.text=new_Temper.name;
document.getElementById("editL1").appendChild(t);

}
}


}
alert("Эта функция работает только в онлайн веб-версии OpenWebGIS")
{return;
xmlhttp.send(null);}
}
function OSMBonMapResize(osmb)
{osmb.div.childNodes[0].childNodes[0].width=map.size.w;osmb.div.childNodes[0].childNodes[0].height=map.size.h;
osmb.div.childNodes[0].childNodes[1].width=map.size.w;osmb.div.childNodes[0].childNodes[1].height=map.size.h;
osmb.div.childNodes[0].childNodes[2].width=map.size.w;osmb.div.childNodes[0].childNodes[2].height=map.size.h;var indexb=0;
for(var tg=0;tg<map.layers.length;tg++){if(map.layers[tg]==osmb){indexb=tg;}}
map.removeLayer(osmb);
for(var mpv=0;mpv<map.events.listeners.click.length;mpv++)
{if(map.events.listeners.click[mpv].obj.clickosmowg&&map.events.listeners.click[mpv].obj.clickosmowg=='clickosmowg'){map.events.listeners.click.splice(mpv,1);mpv--;}}
map.addLayer(osmb); map.setLayerIndex(osmb,indexb)}
function informationOSM(e)
{
  var popupOSM = new OpenLayers.Popup.FramedCloud("popupOSMowg",
 new OpenLayers.LonLat(e.lon,e.lat),
 new OpenLayers.Size(120,120),
 '<b>OSM ID '+ e.feature +'</b>',
 null,
 true
 );
 map.addPopup(popupOSM);
var url = 'http://data.osmbuildings.org/0.2/rkc8ywdl/feature/'+ e.feature +'.json';
ajaxOSM(url, function(json) {
var content = '<b>OSM ID '+ e.feature +'</b>';
for (var i = 0; i < json.features.length; i++) {
content += '<br><em><a style="font-size: 11px;">OSM Part ID</a></em> '+ '<a style="font-size: 11px;">'+json.features[i].id+'</a>';
content += '<br><a style="font-size: 11px;">'+ formatJSONOSM(json.features[i].properties.tags)+'</a>';
    }

    popupOSM.contentHTML=content;popupOSM.contentDiv.innerHTML=content;
popupOSM.autoSize=true;popupOSM.updateSize();
  });

}
function ajaxOSM(url, callback) {
  var req = new XMLHttpRequest();
  req.onreadystatechange = function() {
    if (req.readyState !== 4) {
      return;
    }
    if (!req.status || req.status < 200 || req.status > 299) {
      return;
    }

    callback(JSON.parse(req.responseText));
  };
  req.open('GET', url);
  alert("Эта функция работает только в онлайн веб-версии OpenWebGIS")
{return;
  req.send(null);}
}

function formatJSONOSM(json) {
  var html = '';
  for (var key in json) {
    html += '<em>'+ key +'</em> '+ json[key] +'<br>';
  }
  return html;
}
function OK_EarthquakesB()
{
var waitT=document.createElement('a');
waitT.id="a_waitEarthQuake";
waitT.innerHTML="Wait...";
document.getElementById("waitEarthQuake").appendChild(waitT);
try {var xmlhttp =new XMLHttpRequest();}
catch (e) {rtt=e;alert(e);return;}
var time1=''; var time2='';var Mag1=''; var Mag2='';var Dep1=''; var Dep2='';var Az1='';var Az2='';var Limit='';var lat1="";var lat2="";
var lon1="";var lon2="";
var arrayStrEarthQ=[];
if(document.getElementById("id_startTimeEarthQ").value!=='')
{time1='starttime='+document.getElementById("id_startTimeEarthQ").value;arrayStrEarthQ.push(time1);}
if(document.getElementById("id_endTimeEarthQ").value!=='')
{time2='endtime='+document.getElementById("id_endTimeEarthQ").value;arrayStrEarthQ.push(time2);}

if(document.getElementById("id_minMagEarthQ").value!=='')
{Mag1='minmagnitude='+document.getElementById("id_minMagEarthQ").value;arrayStrEarthQ.push(Mag1);}
if(document.getElementById("id_maxMagEarthQ").value!=='')
{Mag2='maxmagnitude='+document.getElementById("id_maxMagEarthQ").value;arrayStrEarthQ.push(Mag2);}

if(document.getElementById("id_minDepEarthQ").value!=='')
{Dep1='mindepth='+document.getElementById("id_minDepEarthQ").value;arrayStrEarthQ.push(Dep1);}
if(document.getElementById("id_maxDepEarthQ").value!=='')
{Dep2='maxdepth='+document.getElementById("id_maxDepEarthQ").value;arrayStrEarthQ.push(Dep2);}

if(document.getElementById("first_latE").value!==''&&document.getElementById("first_latE").value!=="0")
{lat1='minlatitude='+document.getElementById("first_latE").value;arrayStrEarthQ.push(lat1);}
if(document.getElementById("sec_latE").value!==''&&document.getElementById("sec_latE").value!=="0")
{lat2='maxlatitude='+document.getElementById("sec_latE").value;arrayStrEarthQ.push(lat2);}

if(document.getElementById("first_longE").value!==''&&document.getElementById("first_longE").value!=="0")
{lon1='minlongitude='+document.getElementById("first_longE").value;arrayStrEarthQ.push(lon1);}
if(document.getElementById("sec_longE").value!==''&&document.getElementById("sec_longE").value!=="0")
{lon2='maxlongitude='+document.getElementById("sec_longE").value;arrayStrEarthQ.push(lon2);}


if(document.getElementById("id_minAzEarthQ").value!=='')
{Az1='mingap='+document.getElementById("id_minAzEarthQ").value;arrayStrEarthQ.push(Az1);}
if(document.getElementById("id_maxAzEarthQ").value!=='')
{Az2='maxgap='+document.getElementById("id_maxAzEarthQ").value;arrayStrEarthQ.push(Az2);}
if(document.getElementById("id_RezEarthQ").value!=='')
{Limit='limit='+document.getElementById("id_RezEarthQ").value;arrayStrEarthQ.push(Limit);}
var queryStr=arrayStrEarthQ.join('&');
myUrl='http://earthquake.usgs.gov/fdsnws/event/1/query?'+queryStr+'&format=geojson&orderby=time';

myUrl=encodeURIComponent(myUrl);

xmlhttp.open('GET','/temp.php?c='+myUrl+'&rand='+Math.random(), true);
xmlhttp.setRequestHeader("Cache-Control", "no-cache");
xmlhttp.setRequestHeader("Content-type", "text/xml");
xmlhttp.onreadystatechange = function()
{if(xmlhttp.readyState !== 4&&xmlhttp.status !== 200)
{rtt=xmlhttp;alert("Возможно ошибка, пожалуйста попробуйте ещё раз");if(document.getElementById("a_waitEarthQuake")){document.getElementById("a_waitEarthQuake").parentNode.removeChild(document.getElementById("a_waitEarthQuake"))}return;};
if(xmlhttp.readyState == 4&&xmlhttp.status == 200) {
if(document.getElementById("a_waitEarthQuake")){document.getElementById("a_waitEarthQuake").parentNode.removeChild(document.getElementById("a_waitEarthQuake"))}
if(xmlhttp.responseText!=='')
{ var arrPointj={}
try {arrPointj=JSON.parse(xmlhttp.responseText); }
catch (e) {alert(e);return;}
var arrP=[];
for(var tt=0;tt<arrPointj.features.length;tt++)
{var new_pos2=new OpenLayers.LonLat(arrPointj.features[tt].geometry.coordinates[0],arrPointj.features[tt].geometry.coordinates[1]).transform(
new OpenLayers.Projection("EPSG:4326"),
map.getProjectionObject());
var point=new OpenLayers.Geometry.Point(new_pos2.lon, new_pos2.lat)
var first_point= new OpenLayers.Feature.Vector(point);first_point.attributes=arrPointj.features[tt].properties;
first_point.attributes.Depth=arrPointj.features[tt].geometry.coordinates[2];
var d=new Date(arrPointj.features[tt].properties["time"])
var Y=d.getFullYear();
var M=d.getMonth()+1;if(parseInt(M)<10){M='0'+M;}
var D=d.getDate();if(parseInt(D)<10){D='0'+D;}
var H=d.getHours();if(parseInt(H)<10){H='0'+H;}
var MM=d.getMinutes();if(parseInt(MM)<10){MM='0'+MM;}
var S=d.getSeconds();if(parseInt(S)<10){S='0'+S;}
var neD=Y+'-'+M+'-'+D+'T'+H+':'+MM+':'+S;
first_point.attributes.Date_time=neD;
first_point.attributes["Magnitude"]=first_point.attributes["mag"];delete first_point.attributes["mag"];
first_point.attributes["about"]="Объяснение названий атрибутов см. здесь:<br>http://earthquake.usgs.gov/earthquakes/feed/v1.0/glossary.php#net"
arrP.push(first_point)}
var new_Earth = new OpenLayers.Layer.Vector(document.getElementById("id_textEarthQuaLayer").value,{renderers:["Canvas", "SVG", "VML"]});
new_Earth.addFeatures(arrP);
var new_style_layer= new OpenLayers.Style({
 pointRadius: 3, fillColor: "#FF9000", strokeColor: "#FF9000", strokeWidth: 1,fillOpacity:1, strokeOpacity:1 });
 var selStyle = new OpenLayers.Style({ pointRadius: 5,  fillColor: "#ffaa00",
 strokeColor: "#00DDFF", strokeWidth:2,fillOpacity:1, strokeOpacity:1 }); 
new_Earth.styleMap=new OpenLayers.StyleMap({'default':new_style_layer,'select': selStyle});
new_Earth.events.register("loadstart",new_Earth, function() {WaitWindow();});
map.addLayer(new_Earth);
new_Earth.events.register("loadend",new_Earth, function() {if(popup_Wait){try{popup_Wait.destroy();}catch(e){};} });
 var t=document.createElement('option');
t.value=new_Earth.name;
t.text=new_Earth.name;
document.getElementById("editL1").appendChild(t);


}
}

}
alert("Эта функция работает только в онлайн веб-версии OpenWebGIS")
{return;
xmlhttp.send(null);}
}
function NewArcGridLayer()
{
var bbox = document.getElementById("map").getBoundingClientRect();
 var body = document.body; var docElem = document.documentElement; var scrollTop = window.pageYOffset || docElem.scrollTop || body.scrollTop;
 var scrollLeft = window.pageXOffset || docElem.scrollLeft || body.scrollLeft; var clientTop = docElem.clientTop || body.clientTop || 0; var clientLeft = docElem.clientLeft || body.clientLeft || 0;
 var topTop = bbox.top + scrollTop - clientTop; var leftLeft = bbox.left + scrollLeft - clientLeft; var DivEditeLeg=document.createElement("div");
DivEditeLeg.id="id_NewGridOWGLegMain2";DivEditeLeg.className="id_divRoutLegMain";
DivEditeLeg.style.position="relative";
var dopstry='onclick=clickDivColor3d(this) style="float:right;width:25px;height: 10px; border: 1px double black;cursor:pointer;background:';
DivEditeLeg.innerHTML='<div id="id_divEGrmpowg_Leg" style="background:#ffffff; color:#0000ff;z-index: 1400;position:absolute;left:'+Math.round(leftLeft+50)+'px;top:'+Math.round(topTop-150)+
'px;overflow:hidden; border: 1px solid black;"><img onclick="closeWearherLegendWin(this)" src="openlayers/theme/default/img/close.gif" style="position:relative; top:10px;float:right; cursor:pointer"><a style="position:relative; top:20px"></a>'+'<a style="font-size: 9px;"> you can move this window if you select menu item Interface/switch to interface drag</a><br>'+
'<a>Select ArcGris ASCII File</a>: <input title="Select ArcGris ASCII File" type="file" id="file_newArcGridlayer"><br>'+
'Layer name:<input type="text" size="25" id="Id_NewGridLayerFile_Name" value="NewGrid_layer"/><br>'+
'opacity:<input type="text" size="5" id="Id_opNewGridLayerFile" value="0.5"/><br>'+
'Set color:<br>set gradient from to:<div id="color2grtmp" '+dopstry+'#FF0000"></div><div id="color1grtmp" '+dopstry+'#0000FF"></div><br>'+
'<div id="id_minmaxgrd1"><a>min: </a></div>'+'<div id="id_minmaxgrd2"><a>max:</a></div>'+
'or set number of classification:<select id=Id_coloGrnClass onchange="ChangeGrnclassification()">'+
'</select><br><div id="id_ChangeGrdAbutton"></div>'+
'<p> <button id="okNewArcGridOWG_id" type=button onclick=NewArcGridLayer2()>OK</button></p>'+'</div>';
'</div>';
if(!document.getElementById("id_NewGridOWGLegMain2"))
{body.appendChild(DivEditeLeg); 
document.getElementById("id_NewGridOWGLegMain2").onmousedown=function(event){drags(event)};document.getElementById("id_NewGridOWGLegMain2").onmouseup=function(e){enddrag()};
for(var ii=0; ii<=20;ii++)
{  var tt2=document.createElement('option');tt2.value=ii;tt2.text=ii;document.getElementById("Id_coloGrnClass").appendChild(tt2); }

}
document.getElementById('file_newArcGridlayer').addEventListener('change', readSingleFileArcneL, false);  }
function readSingleFileArcneL(evt)
{fileZIP = evt.target.files[0];
var lines = [];var headers;var contents2;var contents;
 if (fileZIP) { var r = new FileReader();
 r.onload = function(e) {  contents = e.target.result;
var Arcgcont=contents;NewArcGridLayerMinMax(Arcgcont); }
 r.readAsText(fileZIP); } else {  alert("Failed to load file"); }
}
function NewArcGridLayer2()
{
NewArcGridLayer3();
 }
function NewArcGridLayerMinMax(Arcgcont)
{
var novalue=Arcgcont.split('NODATA_VALUE ')[1].split(/\s/)[0];
var dopstrn='NODATA_VALUE '+novalue+'\n';var arrayvalue=Arcgcont.split(dopstrn)[1].split(/\s/); 
var indnoval=0
for(var v=0;v<arrayvalue.length;v++){if(arrayvalue[v]!=novalue){var minDistC = parseFloat(arrayvalue[v]);indnoval=v;break;}}
var  maxDistC = parseFloat(minDistC) ;
for (var ia = indnoval+1; ia < arrayvalue.length; ++ia) 
{ if(arrayvalue[ia]!=novalue&&isNaN(parseFloat(arrayvalue[ia]))!=true)
{var NumSS=arrayvalue[ia];
if (NumSS>parseFloat(maxDistC) ) {maxDistC =  parseFloat(NumSS);}if( NumSS<parseFloat(minDistC) ) {minDistC  = parseFloat(NumSS);} 
}  }  
var inputmin=this.document.createElement('input');inputmin.type='text';inputmin.size="5";inputmin.id="IdminGRD_val_1";inputmin.value=minDistC;
if(document.getElementById('IdminGRD_val_1')){document.getElementById('IdminGRD_val_1').parentNode.removeChild(document.getElementById('IdminGRD_val_1'));}
if(document.getElementById('IdminGRD_val_2')){document.getElementById('IdminGRD_val_2').parentNode.removeChild(document.getElementById('IdminGRD_val_2'));}
document.getElementById("id_minmaxgrd1").appendChild(inputmin);
inputmin.ArcgInf=Arcgcont;
var inputmax=this.document.createElement('input');inputmax.type='text';inputmax.size="5";inputmax.id="IdminGRD_val_2";inputmax.value=maxDistC;document.getElementById("id_minmaxgrd2").appendChild(inputmax);
}
function NewArcGridLayer3()
{
var Arcgcont=document.getElementById("IdminGRD_val_1").ArcgInf;

 var col=parseInt(Arcgcont.split('NCOLS ')[1].split(/\s/)[0]);var row=Arcgcont.split('NROWS ')[1].split(/\s/)[0];var lonx=parseFloat(Arcgcont.split('XLLCORNER ')[1].split(/\s/)[0]);var laty=parseFloat(Arcgcont.split('YLLCORNER ')[1].split(/\s/)[0]);
var novalue=Arcgcont.split('NODATA_VALUE ')[1].split(/\s/)[0];
var lotatxy=new OpenLayers.LonLat(lonx,laty).transform(new OpenLayers.Projection("EPSG:4326"),map.getProjectionObject())
var s=map.getPixelFromLonLat(lotatxy); var dopstrn='NODATA_VALUE '+novalue+'\n';
var arrayvalue=Arcgcont.split(dopstrn)[1].split(/\s{1,}/); 
 var strcolor1='';
 var brushCanvasF = document.createElement('canvas');
//brushCanvasF.width=document.getElementById("map").style.width.split('px')[0];brushCanvasF.height=document.getElementById("map").style.height.split('px')[0];;
brushCanvasF.width=col;brushCanvasF.height=row;
var ctx = brushCanvasF.getContext('2d');ctx.globalAlpha = document.getElementById("Id_opNewGridLayerFile").value;
if(document.getElementById("Id_coloGrnClass").value!=="0")
{var indiv=document.getElementById("id_ChangeGrdAbutton");
for(var d=0;d<indiv.childNodes[0].childNodes.length;d++)
{   if(indiv.childNodes[0].childNodes[d].id.split("_val_")[1]){strcolor1+=indiv.childNodes[0].childNodes[d].value+";";}
if(indiv.childNodes[0].childNodes[d].id.split("_col_")[1]){strcolor1+=indiv.childNodes[0].childNodes[d].style.backgroundColor+"/";}
}  }
if(document.getElementById("Id_coloGrnClass").value=="0")
{tcolor1=document.getElementById("color1grtmp").style.backgroundColor;tcolor2=document.getElementById("color2grtmp").style.backgroundColor;
var levels = 100;var canvasc = document.createElement('canvas');canvasc.width = 1;canvasc.height = levels;var ctx2 = canvasc.getContext('2d');
var gradient = ctx2.createLinearGradient(0, 0, 0, levels);gradient.addColorStop(0, tcolor1);gradient.addColorStop(1, tcolor2);
ctx2.fillStyle = gradient;ctx2.fillRect(0, 0, 1, levels);var gradientPixels = ctx2.getImageData(0, 0, 1, levels).data;}

var minDistC = parseFloat(document.getElementById("IdminGRD_val_1").value);var  maxDistC = parseFloat(document.getElementById("IdminGRD_val_2").value) ;
 var x=0; var y=0; var ind=0; var delt=brushCanvasF.width/col;
for(var et=0;et<arrayvalue.length;et++)
{
   if(arrayvalue[et]!=novalue)
{
  if(strcolor1!=='')
{
var arcolor=strcolor1.split("/");
for(var b=0;b<arcolor.length-1;b++)
{
if(parseFloat(arrayvalue[et])>=parseFloat(arcolor[b].split(";")[0])&&parseFloat(arrayvalue[et])<parseFloat(arcolor[b].split(";")[1]))
{ctx.fillStyle=arcolor[b].split(";")[2]; }
 }
}  
else
{
var scale = (parseFloat(arrayvalue[et])-parseFloat(minDistC))/(parseFloat(maxDistC)-parseFloat(minDistC));
scale=Math.round(scale*100);
for (var ie = 0; ie < gradientPixels.length; ie += 4)
{var sv='';if(ie==0){sv=ie;}
else{
sv=ie/4 
} 
if(scale==sv)
{ctx.fillStyle="rgb("+gradientPixels[ie]+","+gradientPixels[ie + 1]+","+gradientPixels[ie + 2]+")";}
}  }

}
else{if(arrayvalue[et]!=""){ctx.fillStyle="rgba("+255+","+255+","+255+","+"0)"} }
xn=s.x+(x-s.x); //yn=s.y-y;
if(x<col-1)
{ctx.fillRect(xn, y, 1, 1);ind++;x++;}
else
{y=ind/(col-1);/*alert(ind+" y "+y+" len "+arrayvalue.length);*/x=0;
ctx.fillRect(xn, y, 1, 1);
}
}

var imgN=document.createElement("img");imgN.src=brushCanvasF.toDataURL("image/png");if(Arcgcont.split('DX ')[1]){var dx=parseFloat(Arcgcont.split('DX ')[1].split(/\s/)[0]);var dy=parseFloat(Arcgcont.split('DY ')[1].split(/\s/)[0]);}
if(Arcgcont.split('CELLSIZE ')[1]){var dxc=parseFloat(Arcgcont.split('CELLSIZE ')[1].split(/\s/)[0]); if(dxc){dx=dxc;dy=dxc} }
if(dx){ dx=dx*col;}if(dy){ dy=dy*row;}var sec_long=lonx+dx; var sec_lat=laty+dy;
var boundImage=new OpenLayers.Bounds(lonx, laty, sec_long, sec_lat);
boundImage.transform(new OpenLayers.Projection("EPSG:4326"), map.getProjectionObject());
var new_layer_Heat = new OpenLayers.Layer.Image(
document.getElementById("Id_NewGridLayerFile_Name").value,
imgN.src, boundImage, new OpenLayers.Size(1, 1),
{ 'isBaseLayer': false,'alwaysInRange': true
} );

map.addLayer(new_layer_Heat);
}
function ChangeGrnclassification()
{
var minDistC = parseFloat(document.getElementById("IdminGRD_val_1").value);var  maxDistC = parseFloat(document.getElementById("IdminGRD_val_2").value) ;
if(document.getElementById('Id_GRDdClass_inputs'))
{document.getElementById('Id_GRDdClass_inputs').parentNode.removeChild(document.getElementById('Id_GRDdClass_inputs'));}
if(document.getElementById("Id_coloGrnClass"))
{var count=parseInt(document.getElementById("Id_coloGrnClass").value);}
var arrayclass=document.createElement('div');
arrayclass.id="Id_GRDdClass_inputs";
document.getElementById('id_ChangeGrdAbutton').appendChild(arrayclass);var stv= minDistC; dopstv=(maxDistC-minDistC)/(count);
for(var i=0;i<count;i++)
      {         var inputv=this.document.createElement('input');
inputv.type='text';inputv.size="5";inputv.id="IdChartGRDClass1_val_"+i;inputv.value=parseFloat(minDistC)+dopstv*i;
var inputv2=this.document.createElement('input');
inputv2.type='text';inputv2.size="5";inputv2.id="IdChartGRDClass2_val_"+i;inputv2.value=parseFloat(inputv.value)+dopstv;
var inputva=this.document.createElement('a');
 inputva.innerHTML="from ";
document.getElementById("Id_GRDdClass_inputs").appendChild(inputva);document.getElementById("Id_GRDdClass_inputs").appendChild(inputv);
var inputva=this.document.createElement('a'); inputva.innerHTML="to ";
document.getElementById("Id_GRDdClass_inputs").appendChild(inputva);document.getElementById("Id_GRDdClass_inputs").appendChild(inputv2);
var inputDiv=this.document.createElement('div');
inputDiv.id="IdChartGRDlassDivColor_col_"+i;inputDiv.style.width="10px";inputDiv.style.height="10px";
inputDiv.onclick=function(){clickDivColor3d(this);} ;inputDiv.style.border="1px double black";
inputDiv.style.cursor="pointer";inputDiv.style.background="#bbbbbb";document.getElementById("Id_GRDdClass_inputs").appendChild(inputDiv);
var br1=this.document.createElement('br');

document.getElementById("Id_GRDdClass_inputs").appendChild(br1);
     }

}
function ExportFileAsc()
{
var bbox = document.getElementById("map").getBoundingClientRect();
 var body = document.body; var docElem = document.documentElement; var scrollTop = window.pageYOffset || docElem.scrollTop || body.scrollTop;
 var scrollLeft = window.pageXOffset || docElem.scrollLeft || body.scrollLeft; var clientTop = docElem.clientTop || body.clientTop || 0; var clientLeft = docElem.clientLeft || body.clientLeft || 0;
 var topTop = bbox.top + scrollTop - clientTop; var leftLeft = bbox.left + scrollLeft - clientLeft; var DivEditeLeg=document.createElement("div");
DivEditeLeg.id="id_ExpGridOWGLegMain2";DivEditeLeg.className="id_divRoutLegMain";
DivEditeLeg.style.position="relative";
var dopstry='onclick=clickDivColor3d(this) style="float:right;width:15px;height: 10px; border: 1px double black;cursor:pointer;background:';
DivEditeLeg.innerHTML='<div id="id_divEGrmpowg_Leg" style="background:#ffffff; color:#0000ff;z-index: 1400;position:absolute;left:'+Math.round(leftLeft+50)+'px;top:'+Math.round(topTop-150)+
'px;overflow:hidden; border: 1px solid black;"><img onclick="closeWearherLegendWin(this)" src="openlayers/theme/default/img/close.gif" style="position:relative; top:10px;float:right; cursor:pointer"><a style="position:relative; top:20px"></a>'+'<a style="font-size: 9px;"> you can move this window if you select menu item Interface/switch to interface drag</a><br>'+
'<a>Select Layer:</a>'+'<select id="Expgrselectatrowg_id" >'+ '<option selected value="0">.</option></select><br>'+
'no data value:<input type="text" size="5" id="Id_noExgrtowgLayerName_val" value="-9999"/>'+
'<p> <button id="okExpGridOWG_id" type=button onclick=ExportFileAsc2()>OK</button></p>'+'</div>';
'</div>';
if(!document.getElementById("id_ExpGridOWGLegMain2"))
{body.appendChild(DivEditeLeg); 
document.getElementById("id_ExpGridOWGLegMain2").onmousedown=function(event){drags(event)};
document.getElementById("id_ExpGridOWGLegMain2").onmouseup=function(e){enddrag()};
} var ind=0;
for(var i=0;i<map.layers.length;i++)
{ if(map.layers[i].featuresH||map.layers[i].featuresIn)
{var t=document.createElement('option');t.value=map.layers[i].name;t.text=map.layers[i].name;
document.getElementById("Expgrselectatrowg_id").appendChild(t);ind=1;} } 
if(ind==0){alert("no layer that can be exported to ArcGrid format")}
}
function ExportFileAsc2()
{for(var i=0;i<map.layers.length;i++)
{ if((map.layers[i].featuresH||map.layers[i].featuresIn)&&map.layers[i].name==document.getElementById("Expgrselectatrowg_id").value)
{ exportGridOWG=1;
var zoomH=map.layers[i];if(map.layers[i].featuresH){HeatmapCanvas(zoomH)}if(map.layers[i].featuresIn){IDWCanvas2(zoomH)}
exportGridOWG=0;
}
}


}
function SplineCanvas()
{
if(document.getElementById("InterpolationPopupF")){document.getElementById("InterpolationPopupF").parentNode.removeChild(document.getElementById("InterpolationPopupF"));}
var bbox = document.getElementById("map").getBoundingClientRect();
 var body = document.body; var docElem = document.documentElement; var scrollTop = window.pageYOffset || docElem.scrollTop || body.scrollTop;
 var scrollLeft = window.pageXOffset || docElem.scrollLeft || body.scrollLeft; var clientTop = docElem.clientTop || body.clientTop || 0; var clientLeft = docElem.clientLeft || body.clientLeft || 0
 var topTop = bbox.top + scrollTop - clientTop; var leftLeft = bbox.left + scrollLeft - clientLeft;var DivEditeLeg=document.createElement("div");
DivEditeLeg.id="id_SplineOWGLegMain2";
DivEditeLeg.className="id_divRoutLegMain";
DivEditeLeg.style.position="relative";
var dopstry='onclick=clickDivColor3d(this) style="float:right;width:15px;height: 10px; border: 1px double black;cursor:pointer;background:';
DivEditeLeg.innerHTML='<div id="id_divKrigmpowg_Leg" style="background:#ffffff; color:#0000ff;z-index: 1400;position:absolute;left:'+Math.round(leftLeft+50)+'px;top:'+Math.round(topTop-150)+
'px;overflow:hidden; border: 1px solid black;"><img onclick="closeWearherLegendWin(this)" src="openlayers/theme/default/img/close.gif" style="position:relative; top:10px;float:right; cursor:pointer"><a style="position:relative; top:20px"></a>'+
'<a style="font-size: 9px;"> you can move this window if you select menu item Interface/switch to interface drag</a><br>'+
'opacity:<input type="text" size="3" id="Id_opIDWowgLayerNameAtl" title="set from 0 to 1" value="0.6"/><br>'+
'<a>Field for Spline:</a>'+
'<select id="Splineselectatrowg_id" >'+ '<option selected value="0">.</option>'+
'</select><br>'+
'Layer name:<input type="text" size="25" id="Id_SplowgLayerNameAtl_Name" value="Spl_'+edilayerMainLayer.name+'"/><br>'+
'Set color:<br>set gradient from to:<div id="color2idwtmp" '+dopstry+'#FF0000"></div><div id="color1idwtmp" '+dopstry+'#0000FF"></div><br>'+
'or set number of classification:<select id=Id_coloSplClass onchange="ChangeSplclassification()">'+
'</select><br><div id="id_ChangeSplbutton"></div>'+
'<p> <button id="okSplineOWG_id" type=button onclick=SplineCanvas2()>OK</button></p>'+'</div>';
'</div>';
if(!document.getElementById("id_SplineOWGLegMain2"))
{body.appendChild(DivEditeLeg); 
document.getElementById("id_SplineOWGLegMain2").onmousedown=function(event){drags(event)};
document.getElementById("id_SplineOWGLegMain2").onmouseup=function(e){enddrag()};

if(edilayerMainLayer.features&&edilayerMainLayer.features[0])
{for (h in edilayerMainLayer.features[0].attributes){var t=document.createElement('option');t.value=h;t.text=h;document.getElementById("Splineselectatrowg_id").appendChild(t);} }  
for(var ii=0; ii<=20;ii++)
{
  var tt2=document.createElement('option');tt2.value=ii;tt2.text=ii;
document.getElementById("Id_coloSplClass").appendChild(tt2);
}

}

}
function SplineCanvas2()
{var data=[];
var new_layer_Heat = new OpenLayers.Layer(document.getElementById("Id_SplowgLayerNameAtl_Name").value,{});
if(edilayerMainLayer.features&&edilayerMainLayer.features[0]&&edilayerMainLayer.features[0].geometry&&edilayerMainLayer.features[0].geometry.CLASS_NAME=="OpenLayers.Geometry.Point")
{
var format = new OpenLayers.Format.GeoJSON({ 'internalProjection': new OpenLayers.Projection("EPSG:900913"),
'externalProjection': new OpenLayers.Projection("EPSG:900913")});
var jsonstringH = format.write(edilayerMainLayer.features);
new_layer_Heat.featuresSp=JSON.parse(jsonstringH).features;
for (var i=0;i<new_layer_Heat.featuresSp.length;i++)
{var pix=map.getPixelFromLonLat(new OpenLayers.LonLat(new_layer_Heat.featuresSp[i].geometry.coordinates[0],new_layer_Heat.featuresSp[i].geometry.coordinates[1]));
data.push([pix.x, pix.y, new_layer_Heat.featuresSp[i].properties[document.getElementById("Splineselectatrowg_id").value]]);}
//data.sort(function(a, b) {return (a[0] - b[0]);   })
//rtt=data; alert("s")
}
else{alert("No Vector Layer and no Point Layer. Select other Layer"); return;}
var brushCanvasF = document.createElement('canvas');
brushCanvasF.width=document.getElementById("map").style.width.split('px')[0];brushCanvasF.height=document.getElementById("map").style.height.split('px')[0];;
var ctx = brushCanvasF.getContext('2d');
var minDistC = parseFloat(data[0][0]);
var  maxDistC = parseFloat(minDistC) ;
for (var ia = 1; ia <  data.length; ++ia) { var NumSS=data[ia][0];
if (NumSS>parseFloat(maxDistC) ) {maxDistC =  parseFloat(NumSS);}if( NumSS<parseFloat(minDistC) ) {minDistC  = parseFloat(NumSS);}}
var splines=buildSplineInterpol(data); var er=[];
for(var w=0;w<brushCanvasF.width;w++)
{if(w<=maxDistC&&w>=minDistC)
{er.push(SplineInterpol(splines,w));rtt=er;}
}
rtt=er;alert("start")
}
function buildSplineInterpol(data)
{var temparr={};var datan=[]
for (var tw=0;tw<data.length;tw++)
{temparr[data[tw][0]]=data[tw];}
for(h in temparr){datan.push(temparr[h])}
data=datan;rtt=data; alert("s1")
// Инициализация массива сплайнов
var n=data.length-1;
        splinesx = new Array(n);splinesa = new Array(n);splinesc=new Array(n);;var splinesd=new Array(n);var splinesb=new Array(n);
        for (var i = 0; i < data.length; ++i)
        {
            splinesx[i] = data[i][0];
            splinesa[i] = parseFloat(data[i][2]);
        }

        //splinesc[0]= splines[n - 1].c = 0.0;
        splinesc[0]=0;splinesd[0]=0;splinesb[0]=0;
splinesc[n - 1]=0;
        // solve linear equations
            var alpha = new Array(n-1);
         var beta  = new Array(n-1);
        alpha[0] = beta[0] = 0.0;
        for (var i = 1; i < n - 1; ++i)
        {
            var hi  = data[i][0] - data[i - 1][0];
            var hi1 = data[i + 1][0] - data[i][0];
            var A = hi;
            var C = 2.0 * (hi + hi1);
            var B = hi1;
            var F = 6.0 * ((data[i + 1][2] - data[i][2]) / hi1 - (data[i][2] - data[i - 1][2]) / hi);
            var z = (A * alpha[i - 1] + C);
            alpha[i] = -B / z;
            beta[i] = (F - A * beta[i - 1]) / z;
        }
        // \
        for (var i = n - 2; i > 0; --i)
        {
            splinesc[i] = alpha[i] * splinesc[i + 1] + beta[i];    
        }
   
        // 
        for (var i = n - 1; i > 0; --i)
        {
            var hi = data[i][0] - data[i - 1][0];
            splinesd[i] = (splinesc[i] - splinesc[i - 1]) / hi;
            splinesb[i] = hi * (2.0 * splinesc[i] + splinesc[i - 1]) / 6.0 + (data[i][2] - data[i - 1][2]) / hi;
        }
var arrspl=[splinesx,splinesa,splinesc,splinesd,splinesb];
return arrspl;
//rtt=splinesb;alert("g")
}
function SplineInterpol(splines,w)
{x=w;
  if (splines[1] == null)
        {            return NaN;         }
        
        var n = splines[2].length;
        var s=splines; var sj=0;
        
        if (x <= splines[0][0]) //
        {            sj=0;        }
        else if (x >= splines[0][n - 1]) // 
        {            sj = n - 1;        }
        else // 
        {
            var i = 0;            var j = n - 1;
            while (i + 1 < j)
            {
                var k = i + (j - i) / 2;
                if (x <= splines[0][k])
                {                    j = k;                }
                else
                {                    i = k;                }
            }
            sj = j;
        }
        
        var dx = x - s[0][sj];
        // 
        return s[1][sj] + (s[4][sj] + (s[2][sj] / 2.0 + s[3][sj] * dx / 6.0) * dx) * dx; 


}
function HeatmapCanvas2()
{if(document.getElementById("InterpolationPopupF")){document.getElementById("InterpolationPopupF").parentNode.removeChild(document.getElementById("InterpolationPopupF"));}
var bbox = document.getElementById("map").getBoundingClientRect();
 var body = document.body
 var docElem = document.documentElement
 var scrollTop = window.pageYOffset || docElem.scrollTop || body.scrollTop;
 var scrollLeft = window.pageXOffset || docElem.scrollLeft || body.scrollLeft;
 var clientTop = docElem.clientTop || body.clientTop || 0; var clientLeft = docElem.clientLeft || body.clientLeft || 0
 var topTop = bbox.top + scrollTop - clientTop; var leftLeft = bbox.left + scrollLeft - clientLeft
var DivEditeLeg=document.createElement("div");
DivEditeLeg.id="id_HeatmapOWGLegMain2";
DivEditeLeg.className="id_divRoutLegMain";
DivEditeLeg.style.position="relative";
var dopstry='onclick=clickDivColor3d(this) style="float:right;width:15px;height: 10px; border: 1px double black;cursor:pointer;background:';
DivEditeLeg.innerHTML='<div id="id_divHtmpowg_Leg" style="background:#ffffff; color:#0000ff;z-index: 1400;position:absolute;left:'+Math.round(leftLeft+50)+'px;top:'+Math.round(topTop-180)+
'px;overflow:hidden; border: 1px solid black;"><img onclick="closeWearherLegendWin(this)" src="openlayers/theme/default/img/close.gif" style="position:relative; top:10px;float:right; cursor:pointer"><a style="position:relative; top:20px"></a>'+
'<a style="font-size: 9px;"> you can move this window if you select menu item Interface/switch to interface drag</a><br>'+
'set Radius:<input type="text" size="3" id="Id_radHeatowgLayerNameAtl" title="set radius in pixels" value="10"/>'+
'set Radius blur:<input type="text" size="3" id="Id_blurHeatowgLayerNameAtl" title="set radius in pixels" value="10"/><br>'+
'<a>Field for heatmap:</a>'+
'<select id="htmpselectatrowg_id" >'+ '<option selected value="0">.</option>'+
'</select><br><a>set intensity:</a><input type="text" size="3" id="Id_intenHeatowgLayerNameAtl" title="set index of intensity.The less index the more intense field for heatmap value on the map" value="20"/>'+
'opacity:<input type="text" size="5" id="Id_opasHeatowgLayerNameAtl" value="0.5"/><br>'+
'<div style=""><a>set color:</a><a>1.0,</a><div id="color1Heatmp" '+dopstry+'blue"></div>'+
'<a>0.8,</a><div id="color2Heatmp" '+dopstry+'cyan"></div>'+'<a>0.6,</a><div id="color3Heatmp" '+dopstry+'lime"></div>'+'<a>0.5,</a><div id="color4Heatmp" '+dopstry+'yellow"></div>'+
'<a>0.4</a><div id="color5Heatmp" '+dopstry+'red"></div>'+
'</div>'+
'Layer name:<input type="text" size="25" id="Id_HeatowgLayerNameAtl_Name" value="HeatMap_'+edilayerMainLayer.name+'"/><br>'+
'<input type="checkbox" id="Heat_export_interpowg" value="checkbox"/>Export in arcgrid format; no data value:<input type="text" size="5" id="Id_noHeatowgLayerName_val" value="-9999"/><br>'+
'<p> <button id="okHeatmapOWG_id" type=button onclick=HeatmapCanvas()>OK</button></p>'+'</div>';
'</div>';
if(!document.getElementById("id_HeatmapOWGLegMain2"))
{body.appendChild(DivEditeLeg); 
document.getElementById("id_HeatmapOWGLegMain2").onmousedown=function(event){drags(event)};
document.getElementById("id_HeatmapOWGLegMain2").onmouseup=function(e){enddrag()};
if(edilayerMainLayer.features&&edilayerMainLayer.features[0])
{for (h in edilayerMainLayer.features[0].attributes){var t=document.createElement('option');t.value=h;t.text=h;document.getElementById("htmpselectatrowg_id").appendChild(t);} }  
}
document.getElementById("okHeatmapOWG_id").onclick=function(){var zoomH=0;HeatmapCanvas(zoomH)}

}
function HeatmapCanvas(zoomH)
{
var data = [];
if(zoomH==0)
{var new_layer_Heat = new OpenLayers.Layer(document.getElementById("Id_HeatowgLayerNameAtl_Name").value,{});
if(document.getElementById("id_heatmapDateTime")){if(document.getElementById("id_heatmapDateTime").checked==true){document.getElementById("id_heatmapDateTime").heatmaplayer=document.getElementById("Id_HeatowgLayerNameAtl_Name").value}}//for heatmap in timeline
if(edilayerMainLayer.features&&edilayerMainLayer.features[0]&&edilayerMainLayer.features[0].geometry&&edilayerMainLayer.features[0].geometry.CLASS_NAME=="OpenLayers.Geometry.Point")
{
var format = new OpenLayers.Format.GeoJSON({ 'internalProjection': new OpenLayers.Projection("EPSG:900913"),
'externalProjection': new OpenLayers.Projection("EPSG:900913")});
var jsonstringH = format.write(edilayerMainLayer.features);
new_layer_Heat.featuresH=JSON.parse(jsonstringH).features;
for (var i=0;i<new_layer_Heat.featuresH.length;i++)
{var pix=map.getPixelFromLonLat(new OpenLayers.LonLat(new_layer_Heat.featuresH[i].geometry.coordinates[0],new_layer_Heat.featuresH[i].geometry.coordinates[1]));
data.push([pix.x, pix.y]);}
}
else{alert("No Vector Layer and no Point Layer. Select other Layer"); return;} }
else
{
for (var i=0;i<zoomH.featuresH.length;i++)
{var pix=map.getPixelFromLonLat(new OpenLayers.LonLat(zoomH.featuresH[i].geometry.coordinates[0],zoomH.featuresH[i].geometry.coordinates[1]));
data.push([pix.x, pix.y, Math.random()]);}
}

var brushCanvas = document.createElement('canvas');
if(zoomH==0)
{var brushSize = parseFloat(document.getElementById("Id_radHeatowgLayerNameAtl").value);
var brushBlurSize = parseFloat(document.getElementById("Id_blurHeatowgLayerNameAtl").value);
new_layer_Heat.heatmapparams={brushSize:brushSize,
brushBlurSize:brushBlurSize,
color1:document.getElementById("color1Heatmp").style.backgroundColor,color2:document.getElementById("color2Heatmp").style.backgroundColor,
color3:document.getElementById("color3Heatmp").style.backgroundColor,color4:document.getElementById("color4Heatmp").style.backgroundColor,
color5:document.getElementById("color5Heatmp").style.backgroundColor,
opacity:parseFloat(document.getElementById("Id_opasHeatowgLayerNameAtl").value),
intense:parseFloat(document.getElementById("Id_intenHeatowgLayerNameAtl").value)
} 
}
else
{var brushSize = zoomH.heatmapparams.brushSize;var brushBlurSize = zoomH.heatmapparams.brushBlurSize;}
// set brush size
var r = brushSize + brushBlurSize;
var d = r * 2;
brushCanvas.width = d;brushCanvas.height = d;

var ctx3 = brushCanvas.getContext('2d');
ctx3.shadowOffsetX = d;
ctx3.shadowBlur = brushBlurSize;
ctx3.shadowColor = 'black';

// draw circle in the left to the canvas
ctx3.beginPath();
ctx3.arc(-r, r, brushSize, 0, Math.PI * 2, true);
ctx3.closePath();
ctx3.fill();
var brushCanvasF = document.createElement('canvas');
brushCanvasF.width=document.getElementById("map").style.width.split('px')[0];brushCanvasF.height=document.getElementById("map").style.height.split('px')[0];;
var ctx = brushCanvasF.getContext('2d');

  if(zoomH==0) { if(document.getElementById("htmpselectatrowg_id").value!==0)
    {var minDistC = parseFloat(new_layer_Heat.featuresH[0].properties[document.getElementById("htmpselectatrowg_id").value]);
var  maxDistC = parseFloat(minDistC) ;
for (var ia = 1; ia <  new_layer_Heat.featuresH.length; ++ia) { var NumSS=new_layer_Heat.featuresH[ia].properties[document.getElementById("htmpselectatrowg_id").value];
if (NumSS>parseFloat(maxDistC) ) {maxDistC =  parseFloat(NumSS);}if( NumSS<parseFloat(minDistC) ) {minDistC  = parseFloat(NumSS);}}  } }
else
{if(zoomH.featuresH[0]){
if(zoomH.heatmapparams.attribute)
    {var minDistC = parseFloat(zoomH.featuresH[0].properties[zoomH.heatmapparams.attribute]);
var  maxDistC = parseFloat(minDistC) ;
for (var ia = 1; ia <  zoomH.featuresH.length; ++ia) { var NumSS=zoomH.featuresH[ia].properties[zoomH.heatmapparams.attribute];
if (NumSS>parseFloat(maxDistC) ) {maxDistC =  parseFloat(NumSS);}if( NumSS<parseFloat(minDistC) ) {minDistC  = parseFloat(NumSS);}}  } }
}
var len = data.length;

for (var i = 0; i < len; ++i) {
    var p = data[i];
    var x = p[0];
    var y = p[1];
    //var alpha = p[2]; // using value as alpha
  if(zoomH==0) {var alpha =parseFloat(new_layer_Heat.heatmapparams.opacity); if(!new_layer_Heat.heatmapparams.opacity){var alpha =0.5;}}else{var alpha =parseFloat(zoomH.heatmapparams.opacity); if(!zoomH.heatmapparams.opacity){var alpha =0.5;}}

    // draw with the circle brush with alpha
//ctx.globalAlpha = Math.max(p[2] / this._max, minOpacity === undefined ? 0.05 : minOpacity);
    ctx.globalAlpha = alpha;
    if(zoomH==0)
{
    if(document.getElementById("htmpselectatrowg_id").value==0)
       { ctx.drawImage(brushCanvas, x - r, y - r);}
       else
       {  new_layer_Heat.heatmapparams.attribute=document.getElementById("htmpselectatrowg_id").value;var intens=20;if(!new_layer_Heat.heatmapparams.intense){intens=20;}else{intens=new_layer_Heat.heatmapparams.intense;}
         var xfeat=(parseFloat(new_layer_Heat.featuresH[i].properties[document.getElementById("htmpselectatrowg_id").value])*100)/maxDistC;
         var inowh=Math.abs(Math.round(xfeat)/intens); if(inowh==0){inowh=1;}
        for(var t=0;t<inowh;t++){ctx.drawImage(brushCanvas, x - r, y - r);}
              }              }
              else
              { if(zoomH.featuresH[0]){
              if(!zoomH.heatmapparams.attribute)
       { ctx.drawImage(brushCanvas, x - r, y - r);}
       else
       {    var intens=20;if(!zoomH.heatmapparams.intense){intens=20;}else{intens=zoomH.heatmapparams.intense;}
       var xfeat=(parseFloat(zoomH.featuresH[i].properties[zoomH.heatmapparams.attribute])*100)/maxDistC;
        var inowh=Math.abs(Math.round(xfeat)/intens); if(inowh==0){inowh=1;}
        for(var t=0;t<inowh;t++){ctx.drawImage(brushCanvas, x - r, y - r);}
              }   
            }  }
} 

////
var levels = 256;
var canvas = document.createElement('canvas');
canvas.width = 1;
canvas.height = levels;
var ctx2 = canvas.getContext('2d');

if(zoomH==0)
{var gradientColors = {
    "0.4": document.getElementById("color1Heatmp").style.backgroundColor, "0.5": document.getElementById("color2Heatmp").style.backgroundColor,
    "0.6": document.getElementById("color3Heatmp").style.backgroundColor,"0.8": document.getElementById("color4Heatmp").style.backgroundColor,
    "1.0": document.getElementById("color5Heatmp").style.backgroundColor
}; addLegendHeatmap(gradientColors,new_layer_Heat.name);}
else
{
var gradientColors = {
    "0.4": zoomH.heatmapparams.color1, "0.5": zoomH.heatmapparams.color2,"0.6": zoomH.heatmapparams.color3,"0.8":zoomH.heatmapparams.color4,
    "1.0":zoomH.heatmapparams.color5
}
addLegendHeatmap(gradientColors,zoomH.name);
}

// add color to gradient stops
var gradient = ctx2.createLinearGradient(0, 0, 0, levels);
for (var pos in gradientColors) {
    gradient.addColorStop(pos, gradientColors[pos]);}
ctx2.fillStyle = gradient;
ctx2.fillRect(0, 0, 1, levels);
var gradientPixels = ctx2.getImageData(0, 0, 1, levels).data;
///////////////////
var imageData = ctx.getImageData(0, 0, brushCanvasF.width, brushCanvasF.height);
var pixels = imageData.data; 
var len = pixels.length / 4;var strhorexport='';var indcol=brushCanvasF.width; 
if((document.getElementById("Heat_export_interpowg")&&document.getElementById("Heat_export_interpowg").checked==true)||(document.getElementById("Expgrselectatrowg_id")&&exportGridOWG==1)){if(document.getElementById("Expgrselectatrowg_id")&&exportGridOWG==1){newnoval=document.getElementById("Id_noExgrtowgLayerName_val").value}else{newnoval=document.getElementById("Id_noHeatowgLayerName_val").value} }
while(len--) {
    var id = len * 4 + 3;
    var alpha = pixels[id] / 256; 
    var colorOffset = Math.floor(alpha * (levels - 1));
    pixels[id - 3] = gradientPixels[colorOffset * 4];     // red
    pixels[id - 2] = gradientPixels[colorOffset * 4 + 1]; // green
    pixels[id - 1] = gradientPixels[colorOffset * 4 + 2]; // blue
    
    if((document.getElementById("Heat_export_interpowg")&&document.getElementById("Heat_export_interpowg").checked==true)||(document.getElementById("Expgrselectatrowg_id")&&exportGridOWG==1))
    {if(alpha==0){alpha=newnoval;}indcol--;if(indcol==0){if(len==0){strhorexport=alpha+" "+strhorexport;}else{strhorexport="\n"+alpha+" "+strhorexport;}indcol=brushCanvasF.width;}
else{if(indcol==brushCanvasF.width-1){strhorexport=alpha+strhorexport;}else{strhorexport=alpha+" "+strhorexport;}}
    }
}
if((document.getElementById("Heat_export_interpowg")&&document.getElementById("Heat_export_interpowg").checked==true)||(document.getElementById("Expgrselectatrowg_id")&&exportGridOWG==1))
    {
var georef=map.calculateBounds();
georef.transform(map.getProjectionObject(),new OpenLayers.Projection("EPSG:4326"));var lat1=georef.bottom;var lat2=georef.top;var long1=georef.left;var long2=georef.right; 
if(lat2>lat1)
{
var slat=Math.abs(lat2-lat1)/map.size.h; 
}
else
{var slat=Math.abs(lat1-lat2)/map.size.h; 
}
if(long2>long1)
{ var slon=Math.abs(long2-long1)/map.size.w
}
else{ 
var slon=Math.abs(long1-long2)/map.size.w 
}
 if(slon==slat){var cellz="\r\nCELLSIZE "+slat;}else{var cellz="\r\nDX "+slon+"\r\nDY "+slat}///map.size.h;
var dops="NCOLS "+brushCanvasF.width+"\r\nNROWS "+brushCanvasF.height+"\r\nXLLCORNER "+long1+"\r\nYLLCORNER "+lat1+cellz+"\r\nNODATA_VALUE "+newnoval+"\r\n"
init_download();
//kmlText2=dops+strhorexport; myWinExport= open("download.html", "Export arcgrid","width=900,height=500,status=no,toolbar=no,menubar=no,scrollbars=yes"); myWinExport.focus();
}
ctx.putImageData(imageData, 0, 0);
if(zoomH==0)
{
new_layer_Heat.heatmapOWG="yes";
map.addLayer(new_layer_Heat);new_layer_Heat.div.appendChild(brushCanvasF);
new_layer_Heat.div.style.left=((-1)*parseInt(map.layerContainerDiv.style.left,10))+"px";new_layer_Heat.div.style.top=((-1)*parseInt(map.layerContainerDiv.style.top,10))+"px";
}
else
{zoomH.div.removeChild(zoomH.div.childNodes[0]);zoomH.div.appendChild(brushCanvasF);zoomH.div.style.left=((-1)*parseInt(map.layerContainerDiv.style.left,10))+"px";zoomH.div.style.top=((-1)*parseInt(map.layerContainerDiv.style.top,10))+"px";}


}
function addLegendHeatmap(gradientColors,name)
{if(gradientColors)
  {var bbox = document.getElementById("map").getBoundingClientRect();
 var body = document.body; var docElem = document.documentElement; var scrollTop = window.pageYOffset || docElem.scrollTop || body.scrollTop;
 var scrollLeft = window.pageXOffset || docElem.scrollLeft || body.scrollLeft; var clientTop = docElem.clientTop || body.clientTop || 0; var clientLeft = docElem.clientLeft || body.clientLeft || 0
 var topTop = bbox.top + scrollTop - clientTop; var leftLeft = bbox.left + scrollLeft - clientLeft;var DivEditeLeg=document.createElement("div");var rnd=Math.random();
DivEditeLeg.id="id_legIntmapOWGLegMain2"+name;DivEditeLeg.className="id_divRoutLegMain";DivEditeLeg.title="you can move this window if you select menu item Interface/switch to interface drag"
var strcol='';var lensti=0;
for(h in gradientColors){var lensti1=(h.length+13)*2+30; if(lensti1>lensti){lensti=lensti1;}strcol+='<div style="background: '+gradientColors[h]+';width:30px;height:10px"><a>............./'+h+'</a></div>';}
DivEditeLeg.style.position="relative";DivEditeLeg.innerHTML='<div id="id_divHlegtmpowg_Leg" style="background:#ffffff; color:#0000ff;z-index: 1400;position:absolute;left:'+Math.round(leftLeft+50)+'px;top:'+Math.round(topTop-210)+
'px;overflow:hidden; border: 1px solid black;"><img onclick="closeWearherLegendWin(this)" src="openlayers/theme/default/img/close.gif" style="position:relative; top:2px;float:right; cursor:pointer"><br><a style="font-size: 9px;">legend '+name+'</a><br>'+
'<div style="font-size: 10px;width:'+(lensti+40)+'px">'+strcol+'</div></div>';
if(!document.getElementById("id_legIntmapOWGLegMain2"+name))
{body.appendChild(DivEditeLeg); 
document.getElementById("id_legIntmapOWGLegMain2"+name).onmousedown=function(event){drags(event)};
document.getElementById("id_legIntmapOWGLegMain2"+name).onmouseup=function(e){enddrag()};}
}

}
function IDWCanvas()
{if(document.getElementById("InterpolationPopupF")){document.getElementById("InterpolationPopupF").parentNode.removeChild(document.getElementById("InterpolationPopupF"));}
var bbox = document.getElementById("map").getBoundingClientRect();
 var body = document.body
 var docElem = document.documentElement; var scrollTop = window.pageYOffset || docElem.scrollTop || body.scrollTop; var scrollLeft = window.pageXOffset || docElem.scrollLeft || body.scrollLeft;
 var clientTop = docElem.clientTop || body.clientTop || 0; var clientLeft = docElem.clientLeft || body.clientLeft || 0
 var topTop = bbox.top + scrollTop - clientTop; var leftLeft = bbox.left + scrollLeft - clientLeft
var DivEditeLeg=document.createElement("div");DivEditeLeg.id="id_IDWOWGLegMain2";
DivEditeLeg.className="id_divRoutLegMain";
DivEditeLeg.style.position="relative";
var dopstry='onclick=clickDivColor3d(this) style="float:right;width:25px;height: 10px; border: 1px double black;cursor:pointer;background:';
DivEditeLeg.innerHTML='<div id="id_divIDWmpowg_Leg" style="background:#ffffff; color:#0000ff;z-index: 1400;position:absolute;left:'+Math.round(leftLeft+50)+'px;top:'+Math.round(topTop-150)+
'px;overflow:hidden; border: 1px solid black;"><img onclick="closeWearherLegendWin(this)" src="openlayers/theme/default/img/close.gif" style="position:relative; top:10px;float:right; cursor:pointer"><a style="position:relative; top:20px"></a>'+
'<a style="font-size: 9px;"> you can move this window if you select menu item Interface/switch to interface drag</a><br>'+
'set Radius:<input type="text" size="3" id="Id_radIDWowgLayerNameAtl" title="set radius in pixels" value="30"/>power parameter p:<input type="text" size="3" id="Id_pIDWowgLayerNameAtl" title="set power parameter, such as: 1,2,3,4,5..." value="2"/><br>'+
'smoothing parameter<input type="text" size="3" id="Id_smootIDWowgLayerNameAtl" title="set radius in pixels" value="0"/>'+
'opacity:<input type="text" size="3" id="Id_opIDWowgLayerNameAtl" title="set from 0 to 1" value="0.6"/><br>'+
'<a>Field for IDW:</a>'+
'<select id="IDWselectatrowg_id" >'+ '<option selected value="0">.</option>'+
'</select><br>'+
'name of result Layer:<input type="text" size="25" id="Id_IDWowgLayerNameAtl_Name" value="IDW_'+edilayerMainLayer.name+'"/><br>'+
'get vector Layer<input type="checkbox" id="Id_IDWowgLayerNameVect_check" /><br><a style="font-size: 10px;">name of Vector Layer:</a><input type="text" size="20" id="Id_IDWowgLayerNameVect_name" value="vector_'+edilayerMainLayer.name+'"/><br>'+
'<a style="font-size: 10px;">interval for vector Layer by deg</a><input type="text" size="5" id="Id_IDWowgLayerNameAtl_inerval" value="0.5"/><a style="font-size: 10px;">or by pixels</a><input type="text" size="5" id="Id_IDWowgLayerNamePix_inerval" value="0"/><br>'+
'Set color:<br>set gradient from to:<div id="color2idwtmp" '+dopstry+'#FF0000"></div><div id="color1idwtmp" '+dopstry+'#0000FF"></div><br>'+
'or set number of classification:<select id=Id_coloIDWClass onchange="ChangeIDWclassification()">'+
'</select><br><div id="id_ChangeIDWbutton"></div>'+
'<input type="checkbox" id="IDW_export_interp" value="checkbox"/>Export in arcgrid format; no data value:<input type="text" size="5" id="Id_noIDWowgLayerName_val" value="-9999"/><br>'+
'<p> <button id="okIDWOWG_id" type=button onclick=IDWCanvas2()>OK</button></p>'
'</div>';
if(!document.getElementById("id_IDWOWGLegMain2"))
{body.appendChild(DivEditeLeg); 
document.getElementById("id_IDWOWGLegMain2").onmousedown=function(event){drags(event)};
document.getElementById("id_IDWOWGLegMain2").onmouseup=function(e){enddrag()};
document.getElementById("okIDWOWG_id").onclick=function(){var zoomIDW=0;IDWCanvas2(zoomIDW)}
if(edilayerMainLayer.features&&edilayerMainLayer.features[0])
{for (h in edilayerMainLayer.features[0].attributes){var t=document.createElement('option');t.value=h;t.text=h;document.getElementById("IDWselectatrowg_id").appendChild(t);} }  
for(var ii=0; ii<=20;ii++)
{
  var tt2=document.createElement('option');tt2.value=ii;tt2.text=ii;
document.getElementById("Id_coloIDWClass").appendChild(tt2);
}

}
}
function IDWCanvas2(zoomIDW)
{ var exprtV=0;
if(document.getElementById("Id_IDWowgLayerNameVect_check")&&document.getElementById("Id_IDWowgLayerNameVect_check").checked==true)
{exprtV=1;var new_layer_Vector=new OpenLayers.Layer.Vector(document.getElementById("Id_IDWowgLayerNameVect_name").value,{renderers:["Canvas", "SVG", "VML"]});var arrFeaturest=[];
var georef=map.calculateBounds();
georef.transform(map.getProjectionObject(),new OpenLayers.Projection("EPSG:4326"));
var lat1=georef.bottom;var lat2=georef.top;var long1=georef.left;var long2=georef.right;var startx=long1;var starty=lat2;
var intervalV=parseFloat(document.getElementById("Id_IDWowgLayerNameAtl_inerval").value);
var ext1n = new OpenLayers.Pixel(1,0);var lonlat2n = map.getLonLatFromPixel(ext1n);
var new_posn=lonlat2n.transform(map.getProjectionObject(),new OpenLayers.Projection("EPSG:4326"));
var errinter=Math.abs(Math.abs(new_posn.lon)-Math.abs(startx)); var ext1n = new OpenLayers.Pixel(0,1);
var lonlat2n = map.getLonLatFromPixel(ext1n);var new_posn=lonlat2n.transform(map.getProjectionObject(),new OpenLayers.Projection("EPSG:4326"));
var errintery=Math.abs(Math.abs(new_posn.lat)-Math.abs(starty))
var interPix=parseInt(document.getElementById("Id_IDWowgLayerNamePix_inerval").value);

}
if(zoomIDW==0)
{var data = [];if(document.getElementById("IDWselectatrowg_id").value=="0"){alert("Select name of the field"); return;}
var new_layer_Heat = new OpenLayers.Layer(document.getElementById("Id_IDWowgLayerNameAtl_Name").value,{});new_layer_Heat.IDWOWG="yes";

if(edilayerMainLayer.features&&edilayerMainLayer.features[0]&&edilayerMainLayer.features[0].geometry&&edilayerMainLayer.features[0].geometry.CLASS_NAME=="OpenLayers.Geometry.Point")
{
var format = new OpenLayers.Format.GeoJSON({ 'internalProjection': new OpenLayers.Projection("EPSG:900913"),
'externalProjection': new OpenLayers.Projection("EPSG:900913")});
var jsonstringH = format.write(edilayerMainLayer.features);
new_layer_Heat.featuresIn=JSON.parse(jsonstringH).features;
for (var i=0;i<new_layer_Heat.featuresIn.length;i++)
{var pix=map.getPixelFromLonLat(new OpenLayers.LonLat(new_layer_Heat.featuresIn[i].geometry.coordinates[0],new_layer_Heat.featuresIn[i].geometry.coordinates[1]));
data.push([pix.x, pix.y,new_layer_Heat.featuresIn[i].properties[document.getElementById("IDWselectatrowg_id").value]]);}
} 
new_layer_Heat.idwmapparams={attribute:document.getElementById("IDWselectatrowg_id").value,radius:parseFloat(document.getElementById("Id_radIDWowgLayerNameAtl").value),
p:parseFloat(document.getElementById("Id_pIDWowgLayerNameAtl").value),opacity:parseFloat(document.getElementById("Id_opIDWowgLayerNameAtl").value),smooth:parseFloat(document.getElementById("Id_smootIDWowgLayerNameAtl").value)}
new_layer_Heat.idwmapparams.color1='';new_layer_Heat.idwmapparams.color2='';
if(document.getElementById("Id_coloIDWClass").value!=="0")
{var indiv=document.getElementById("id_ChangeIDWbutton"); var strcolor='';
for(var d=0;d<indiv.childNodes[0].childNodes.length;d++)
{   if(indiv.childNodes[0].childNodes[d].id.split("_val_")[1]){strcolor+=indiv.childNodes[0].childNodes[d].value+";";}
if(indiv.childNodes[0].childNodes[d].id.split("_col_")[1]){strcolor+=indiv.childNodes[0].childNodes[d].style.backgroundColor+"/";}
} new_layer_Heat.idwmapparams.color1=strcolor;new_layer_Heat.idwmapparams.color2='';

} else{new_layer_Heat.idwmapparams.color2=document.getElementById("color1idwtmp").style.backgroundColor+"/"+document.getElementById("color2idwtmp").style.backgroundColor;new_layer_Heat.idwmapparams.color1="";} }
else{var new_layer_Heat=zoomIDW;data=[];
for (var i=0;i<new_layer_Heat.featuresIn.length;i++)
{var pix=map.getPixelFromLonLat(new OpenLayers.LonLat(new_layer_Heat.featuresIn[i].geometry.coordinates[0],new_layer_Heat.featuresIn[i].geometry.coordinates[1]));
data.push([pix.x, pix.y,new_layer_Heat.featuresIn[i].properties[new_layer_Heat.idwmapparams.attribute]]);}

}
var strforexport='';
var minDistC = parseFloat(new_layer_Heat.featuresIn[0].properties[new_layer_Heat.idwmapparams.attribute]);
var  maxDistC = parseFloat(minDistC) ;
for (var ia = 1; ia <  new_layer_Heat.featuresIn.length; ++ia) { var NumSS=new_layer_Heat.featuresIn[ia].properties[new_layer_Heat.idwmapparams.attribute];
if (NumSS>parseFloat(maxDistC) ) {maxDistC =  parseFloat(NumSS);}if( NumSS<parseFloat(minDistC) ) {minDistC  = parseFloat(NumSS);}}

var brushCanvasF = document.createElement('canvas');
brushCanvasF.width=document.getElementById("map").style.width.split('px')[0];brushCanvasF.height=document.getElementById("map").style.height.split('px')[0];;
var ctx = brushCanvasF.getContext('2d');
ctx.globalAlpha = new_layer_Heat.idwmapparams.opacity;
var rad=parseFloat(new_layer_Heat.idwmapparams.radius);
if(new_layer_Heat.idwmapparams.color1=='')
{
var tcolor1=new_layer_Heat.idwmapparams.color2.split("/")[0];var tcolor2=new_layer_Heat.idwmapparams.color2.split("/")[1];
var tcolor11=tcolor1.split("rgb(")[1].split(")")[0].split(",");var tcolor22=tcolor2.split("rgb(")[1].split(")")[0].split(",");
var rescolr=parseInt(tcolor22[0])-parseInt(tcolor11[0]);var rescolg=parseInt(tcolor22[1])-parseInt(tcolor11[1]);var rescolb=parseInt(tcolor22[2])-parseInt(tcolor11[2]);
var levels = 100;var canvasc = document.createElement('canvas');
canvasc.width = 1;canvasc.height = levels;var ctx2 = canvasc.getContext('2d');
var gradient = ctx2.createLinearGradient(0, 0, 0, levels);
gradient.addColorStop(0, tcolor1);gradient.addColorStop(1, tcolor2);
ctx2.fillStyle = gradient;
ctx2.fillRect(0, 0, 1, levels);
var gradientPixels = ctx2.getImageData(0, 0, 1, levels).data;
gColors={};gColors[minDistC]=tcolor1;gColors[maxDistC]=tcolor2;
addLegendHeatmap(gColors,new_layer_Heat.name)
}
if(new_layer_Heat.idwmapparams.color1!=='')
{gColors={};
var arcleg=new_layer_Heat.idwmapparams.color1.split("/");
for(var bl=0;bl<arcleg.length-1;bl++)
{var thleg=parseFloat(arcleg[bl].split(";")[0]).toFixed(3)+"_"+parseFloat(arcleg[bl].split(";")[1]).toFixed(3);gColors[thleg]=arcleg[bl].split(";")[2];}
addLegendHeatmap(gColors,new_layer_Heat.name)
}
var start = performance.now(); var smoothIDW=parseFloat(new_layer_Heat.idwmapparams.smooth);var p = new_layer_Heat.idwmapparams.p;
if((document.getElementById("IDW_export_interp")&&document.getElementById("IDW_export_interp").checked==true)||(document.getElementById("Expgrselectatrowg_id")&&exportGridOWG==1))
{if(document.getElementById("Expgrselectatrowg_id")&&exportGridOWG==1){novalidw=document.getElementById("Id_noExgrtowgLayerName_val").value}else{var novalidw=document.getElementById("Id_noIDWowgLayerName_val").value;} }
 for (var i=0;i<brushCanvasF.height;i++)
 {
 for (var j=0;j<brushCanvasF.width;j++)
 { 
 var wj = 0; var wis = [];var indrad=0;
 for (var k=0;k<data.length;k++)
 {
 var dx = data[k][1] - (i); var dy = data[k][0] - (j);
//var dk = Math.sqrt(Math.pow(dx,2) + Math.pow(dy,2));
var dk = (dx*dx + dy*dy);
if(dk<(rad*rad)){indrad=1;}

if(indrad==1)
{ //dk = Math.pow((dk),0.5);
dk=Math.sqrt(dk);var sdk=dk+smoothIDW;
 var wj_inst = 1/(Math.pow(sdk,p))
 wj += wj_inst;if(dk==0){wj=1;}
 wis.push(wj_inst*data[k][2]);if(dk==0){wis=[];wis[0]=data[k][2];}  } }
 

if(indrad!=1)
{
if((document.getElementById("IDW_export_interp")&&document.getElementById("IDW_export_interp").checked==true)||(document.getElementById("Expgrselectatrowg_id")&&exportGridOWG==1))
{if(j==brushCanvasF.width-1){strforexport+=novalidw+"\n";}else{strforexport+=novalidw+" ";}}
}

if(indrad==1)
{
 var u = 0;
 for (var l=0;l<wis.length;l++)
 {
    u += wis[l]/wj; 
 }  


if((document.getElementById("IDW_export_interp")&&document.getElementById("IDW_export_interp").checked==true)||(document.getElementById("Expgrselectatrowg_id")&&exportGridOWG==1))
{if(j==brushCanvasF.width-1){strforexport+=u+"\n";}else{strforexport+=u+" ";}}
if(exprtV==1)
{if(document.getElementById("Id_IDWowgLayerNamePix_inerval".value=="0"))
   {var ext1 = new OpenLayers.Pixel(j,i);var lonlat1 = map.getLonLatFromPixel(ext1);var lonlat2 = map.getLonLatFromPixel(ext1);
var new_pos=lonlat2.transform(map.getProjectionObject(),new OpenLayers.Projection("EPSG:4326"));
for(var wv=startx;wv<long2;wv=wv+intervalV)
{ for(var wv1=starty;wv1>lat1;wv1=wv1-intervalV)
{
if((new_pos.lon<=wv+errinter&&new_pos.lon>wv-errinter)&&(new_pos.lat<=wv1+errintery&&new_pos.lat>wv1-errintery))
{var point=new OpenLayers.Geometry.Point(lonlat1.lon, lonlat1.lat);var first_point= new OpenLayers.Feature.Vector(point);first_point.attributes[new_layer_Heat.idwmapparams.attribute]=u;
first_point.attributes.longitude=new_pos.lon;first_point.attributes.latitude=new_pos.lat;
arrFeaturest.push(first_point);} } }
   }
   else
   {
   if((j%interPix)==0&&(i%interPix)==0)
{  
   var ext1 = new OpenLayers.Pixel(j,i);var lonlat1 = map.getLonLatFromPixel(ext1);var lonlat2 = map.getLonLatFromPixel(ext1);
var new_pos=lonlat2.transform(map.getProjectionObject(),new OpenLayers.Projection("EPSG:4326"));
var point=new OpenLayers.Geometry.Point(lonlat1.lon, lonlat1.lat);var first_point= new OpenLayers.Feature.Vector(point);first_point.attributes[new_layer_Heat.idwmapparams.attribute]=u;
first_point.attributes.longitude=new_pos.lon;first_point.attributes.latitude=new_pos.lat;
arrFeaturest.push(first_point);   }
   }
}
var scale = (u-minDistC)/(maxDistC-minDistC);
var cr=Math.round((1-scale)*100);scale=Math.round(scale*100);
if(new_layer_Heat.idwmapparams.color1!=='')
{
var arcolor=new_layer_Heat.idwmapparams.color1.split("/");
for(var b=0;b<arcolor.length-1;b++)
{if(u>=arcolor[b].split(";")[0]&&u<arcolor[b].split(";")[1]){ctx.fillStyle=arcolor[b].split(";")[2];} }
}
else{

for (var ie = 0; ie < gradientPixels.length; ie += 4)
{
var s='';if(ie==0){s=ie;}
else
{
s=ie/4
} 
if(scale==s)
{ctx.fillStyle="rgb("+gradientPixels[ie]+","+gradientPixels[ie + 1]+","+gradientPixels[ie + 2]+")";}

}


//ctx.fillStyle="rgba("+scale+","+0+","+cr+","+"1)"
}
ctx.fillRect(j, i, 1, 1);
}
  }   }
if((document.getElementById("IDW_export_interp")&&document.getElementById("IDW_export_interp").checked==true)||(document.getElementById("Expgrselectatrowg_id")&&exportGridOWG==1))
{
kmlText2='';rtt=strforexport; 
var georef=map.calculateBounds();
georef.transform(map.getProjectionObject(),new OpenLayers.Projection("EPSG:4326"));var lat1=georef.bottom;var lat2=georef.top;var long1=georef.left;var long2=georef.right; 
//var slat=Math.abs(lat2-lat1)/map.size.h;var slon=Math.abs(long2-long1)/map.size.w;
if(lat2>lat1)
{
var slat=Math.abs(lat2-lat1)/map.size.h;
}
else
{
var slat=Math.abs(lat1-lat2)/map.size.h;
}
if(long2>long1)
{
var slon=Math.abs(long2-long1)/map.size.w
}
else{
var slon=Math.abs(long1-long2)/map.size.w
}
 if(slon==slat){var cellz="\r\nCELLSIZE "+slat;}else{var cellz="\r\nDX "+slon+"\r\nDY "+slat}///map.size.h;

var dops="NCOLS "+brushCanvasF.width+"\r\nNROWS "+brushCanvasF.height+"\r\nXLLCORNER "+long1+"\r\nYLLCORNER "+lat1+cellz+"\r\nNODATA_VALUE "+novalidw+"\r\n"
init_download();
//kmlText2=dops+strforexport; myWinExport= open("download.html", "Export arcgrid","width=900,height=500,status=no,toolbar=no,menubar=no,scrollbars=yes"); myWinExport.focus();
}
var end =  performance.now()  // log end timestamp
var diff = end - start;console.log("time1:"+diff);
if(zoomIDW==0)
{map.addLayer(new_layer_Heat);}
else{new_layer_Heat.div.removeChild(zoomIDW.div.childNodes[0]);}
new_layer_Heat.div.appendChild(brushCanvasF);
new_layer_Heat.div.style.left=((-1)*parseInt(map.layerContainerDiv.style.left,10))+"px";new_layer_Heat.div.style.top=((-1)*parseInt(map.layerContainerDiv.style.top,10))+"px";
if(exprtV==1)
{new_layer_Vector.addFeatures(arrFeaturest);
var new_style_layer= new OpenLayers.Style({ pointRadius: 2, fillColor: "#FF9000", strokeColor: "#FF9000", strokeWidth: 1,fillOpacity:1, strokeOpacity:1 });
 var selStyle = new OpenLayers.Style({ pointRadius: 5,  fillColor: "#ffaa00", strokeColor: "#00DDFF", strokeWidth:2,fillOpacity:1, strokeOpacity:1 }); 
new_layer_Vector.styleMap=new OpenLayers.StyleMap({'default':new_style_layer,'select': selStyle});

map.addLayer(new_layer_Vector);
var t=document.createElement('option');
t.value=new_layer_Vector.name;t.text=new_layer_Vector.name;
document.getElementById("editL1").appendChild(t)
}

}

function ChangeIDWclassification()
{if(document.getElementById("IDWselectatrowg_id").value=="0"){alert("Select name of the field"); return;}
var minDistC = parseFloat(edilayerMainLayer.features[0].attributes[document.getElementById("IDWselectatrowg_id").value]);
var  maxDistC = parseFloat(minDistC) ;
for (var ia = 1; ia <  edilayerMainLayer.features.length; ++ia) { var NumSS=edilayerMainLayer.features[ia].attributes[document.getElementById("IDWselectatrowg_id").value];
if (NumSS>parseFloat(maxDistC) ) {maxDistC =  parseFloat(NumSS);}if( NumSS<parseFloat(minDistC) ) {minDistC  = parseFloat(NumSS);}
}

if(document.getElementById('Id_IDWdClass_inputs'))
{document.getElementById('Id_IDWdClass_inputs').parentNode.removeChild(document.getElementById('Id_IDWdClass_inputs'));}
if(document.getElementById("Id_coloIDWClass"))
{var count=parseInt(document.getElementById("Id_coloIDWClass").value);}
var arrayclass=document.createElement('div');
arrayclass.id="Id_IDWdClass_inputs";
document.getElementById('id_ChangeIDWbutton').appendChild(arrayclass);var stv= minDistC; dopstv=(maxDistC-minDistC)/(count);
for(var i=0;i<count;i++)
      {
           var inputv=this.document.createElement('input');
inputv.type='text';inputv.size="5";
inputv.id="IdChartIDWClass1_val_"+i;inputv.value=parseFloat(minDistC)+dopstv*i;
var inputv2=this.document.createElement('input');
inputv2.type='text';inputv2.size="5";inputv2.id="IdChartIDWClass2_val_"+i;inputv2.value=parseFloat(inputv.value)+dopstv;
var inputva=this.document.createElement('a');
 inputva.innerHTML="from ";
document.getElementById("Id_IDWdClass_inputs").appendChild(inputva);
document.getElementById("Id_IDWdClass_inputs").appendChild(inputv);
var inputva=this.document.createElement('a');
 inputva.innerHTML="to ";
document.getElementById("Id_IDWdClass_inputs").appendChild(inputva);
document.getElementById("Id_IDWdClass_inputs").appendChild(inputv2);
var inputDiv=this.document.createElement('div');
inputDiv.id="IdChartIDWlassDivColor_col_"+i;
inputDiv.style.width="10px";inputDiv.style.height="10px";
inputDiv.onclick=function(){clickDivColor3d(this);}
inputDiv.style.border="1px double black";
inputDiv.style.cursor="pointer";inputDiv.style.background="#bbbbbb";

document.getElementById("Id_IDWdClass_inputs").appendChild(inputDiv);
var br1=this.document.createElement('br');

document.getElementById("Id_IDWdClass_inputs").appendChild(br1);
     }

}
function OK_Interpolation_First()
{if(document.getElementById("interp_method_id").value=='3'){HeatmapCanvas2();return;}if(document.getElementById("interp_method_id").value=='4'){IDWCanvas();return;}
if(edilayerMainLayer.features.length==0){alert('Layer is not activated.Please activate Layer (click on checkbox near name of Layer) . Or it may be other Layer error');return;}
if(document.getElementById("interp_method_id").value=='1')
{var valueName=edilayerMainLayer.name+"_Inter";
var htmlText=" ";
htmlText+='<a>Field for interpolation:</a>'+
'<select id=interp_id onchange="setField_Interp(value)">'+
 '<option selected value="0">.</option>'+
'</select><br>'+'<li> <a id="MinimumValueLayerInter">Minimum:</a>'+
'</li><br><li> <a id="MaximumValueLayerInter">Maximum:</a></li><br>'+
'<input type="text" size="8" id="radius_inter" title="Radius of the density kernel in pixels" value="50"/>radius'+
'<input type="text" size="8" id="pixel_inter" value="10"/>pixel_per_cell<br>'+
'<input type="text" size="8" id="Count_Col" value="300"/>number of columns (important for export)<br>'+
'<input type="checkbox" id="heatmap_export_value" onchange="setInterBound_Exp()" value="checkbox"/>Export in arcgrid format<br>'+
'<input type="text" size="15" id="Id_InterlayerNameAtl" value="'+valueName+'"/>name new Layer<br>'+
'<p> <button id="InterpOKGis" ype=button onclick=OK_Interpolation()>OK</button></p>';

popup_inter = new OpenLayers.Popup.FramedCloud("InterpolationPopupH",
 map.getCenter(),
 new OpenLayers.Size(400,400),
 htmlText ,
 null, true, onPopupClose);
popup_inter.autoSize=true;
popup_inter.updateSize();
 map.addPopup(popup_inter);
rtt=popup_inter;

}//end if if(document.getElementById("interp_method_id").value==1)
if(document.getElementById("interp_method_id").value=='2')
{ var valueName=edilayerMainLayer.name+"_Inter";
var htmlTextBarnes=" ";
htmlTextBarnes+='<a>Field for interpolation:</a>'+
'<select id=interp_id onchange="setField_Interp(value)">'+
 '<option selected value="0">.</option>'+
'</select><br>'+'<li> <a id="MinimumValueLayerInter">Minimum:</a>'+
'</li><br><li> <a id="MaximumValueLayerInter">Maximum:</a></li><br>'+
'<a>Scale for interpolation:</a>'+
'<select id=interp_id_scale title="Length scale for the interpolation, in units of the source data CRS" onchange="setScale_Interp(value)">'+
 '<option selected value="0">.</option></select><br>'+
'<input type="text" size="8" id="noDataValue_inter" value="-9999"/>no Data Value<br>'+
'<input type="text" size="8" id="pixelBarnes_inter" value="10"/>pixel_per_cell<br>'+
'<input type="text" size="8" id="Count_Col2" value="300"/>number of columns(important for export)<br>'+
'<input type="text" size="8" id="Barnes_class" value="4"/>Classification mode(number of entries)<br>'+
'<input type="text" size="8" id="Barnes_from_value" value="0"/>Classification from value<br>'+
'<input type="checkbox" id="Barnes_export_value" onchange="setInterBound_Exp()" value="checkbox"/>Export in arcgrid format<br>'+
'<input type="text" size="15" id="Id_InterlayerNameAtl" value="'+valueName+'"/>name new Layer<br>'+
'<p> <button id="InterpOKGis" type=button onclick=OK_Interpolation()>OK</button></p>';


popupBarnes_inter = new OpenLayers.Popup.FramedCloud("InterpolationPopupB",
 map.getCenter(),
 new OpenLayers.Size(500,500),
 htmlTextBarnes ,
 null, true, onPopupClose);
 map.addPopup(popupBarnes_inter);
popupBarnes_inter.autoSize=true;
popupBarnes_inter.updateSize();
}//end if if(document.getElementById("interp_method_id").value==2)
var WFSLayerList;

for (var a in edilayerMainLayer.features[0].attributes)
{var t=document.createElement('option');
 t.value=a;
 t.text=a;
 document.getElementById("interp_id").appendChild(t); }

if(document.getElementById("interp_method_id").value=='2')
{
var new_layer_n = new OpenLayers.Layer.Vector("fg");

var box_extents = [ [21.08, 55.19] ];
var new_pos=new OpenLayers.LonLat(21.08,55.19).transform(
new OpenLayers.Projection("EPSG:4326"),
map.getProjectionObject());
var new_lon=new_pos.lon;
var new_lat=new_pos.lat;
var first_point =new OpenLayers.Geometry.Point(new_lon, new_lat);
first_point= new OpenLayers.Feature.Vector(first_point);
new_layer_n.projection=new OpenLayers.Projection("EPSG:900913");
new_layer_n.addFeatures(first_point);
map.addLayer(new_layer_n);
for(var i=0; i<new_layer_n.scales.length; ++i) { 
 var t=document.createElement('option');
t.value=new_layer_n.scales[i];
t.text=new_layer_n.scales[i];
document.getElementById("interp_id_scale").appendChild(t);
 }
map.removeLayer(new_layer_n)

}
//popup_inter_first.hide();
var selectMethod=document.getElementById("interp_method_id").value;
document.getElementById("InterpOKGis").onclick=function(){OK_Interpolation(selectMethod)}
}//end function interpolation
function setField_Interp(field_inter)
{


if(edilayerMainLayer.features.length==0){alert('Layer is not activated.Please activate Layer (click on checkbox near name of Layer) and reopen interpolation window. Or it may be other Layer error');return;}
var minDistC = parseFloat(edilayerMainLayer.features[0].attributes[field_inter]);
 var maxDistC = parseFloat(minDistC) ;
 for (ia = 1; ia < edilayerMainLayer.features.length; ++ia) { var NumSS=edilayerMainLayer.features[ia].attributes[field_inter];
 if (NumSS>parseFloat(maxDistC) ) {maxDistC = parseFloat(NumSS);}
 if( NumSS<parseFloat(minDistC) ) {minDistC = parseFloat(NumSS);}
 }
minValue=minDistC;
maxValue=maxDistC
if(document.getElementById("MinimumValueLayerInter")){
document.getElementById("MinimumValueLayerInter").innerHTML="Minimum:"+minValue;
document.getElementById("MaximumValueLayerInter").innerHTML="Maximum:"+maxValue;
}
field_interpolation_Main=field_inter;
minValue_Interpolation=minValue;
maxValue_Interpolation=maxValue;
if(!document.getElementById("MinimumValueLayerInter"))
{
document.getElementById("Barnes_from_value").value=minValue;
document.getElementById("Barnes_from_value").text=minValue;
}
}
function ChartLayerF()
{
 var seldel = document.getElementById("ChartLayerFX");
 while (seldel.childNodes.length) {
 if (seldel.firstChild.tagName == 'OPTGROUP') {
 while (seldel.firstChild.childNodes.length) {
 seldel.firstChild.removeChild(seldel.firstChild.firstChild);
 }
 }
 seldel.removeChild(seldel.firstChild);
 }
 var t=document.createElement('option');
t.value="0";
t.text=".";
document.getElementById("ChartLayerFX").appendChild(t);
 var seldel = document.getElementById("ChartLayerFY");
 while (seldel.childNodes.length) {
 if (seldel.firstChild.tagName == 'OPTGROUP') {
 while (seldel.firstChild.childNodes.length) {
 seldel.firstChild.removeChild(seldel.firstChild.firstChild);
 }
 }
 seldel.removeChild(seldel.firstChild);
 }
 var t=document.createElement('option');
t.value="0";
t.text=".";
document.getElementById("ChartLayerFY").appendChild(t);
var mLayers=map.layers;
 for(var ab = 0; ab < mLayers.length; ab++ )
 {
 if (mLayers[ab].name==document.getElementById("ChartLayer1").value)
 { if(mLayers[ab].features.length<1){alert("Please activate Layer and select other Layer then select this Layer");}
 for (var a in mLayers[ab].features[0].attributes)
 {var t=document.createElement('option');
 t.value=a;
 t.text=a;
 document.getElementById("ChartLayerFX").appendChild(t);} 
 for (var a in mLayers[ab].features[0].attributes)
 {var t=document.createElement('option');
 t.value=a;
 t.text=a;
 document.getElementById("ChartLayerFY").appendChild(t);} 
 }
 }
}


function setQRMatrix()
{if(document.getElementById("Id_yes_SVDMatrix").checked==true||document.getElementById("Id_yes_SolveMatrix").checked==true){document.getElementById("Id_yes_SVDMatrix").checked=false;document.getElementById("Id_yes_SolveMatrix").checked=false;}}
function setSVDMatrix()
{if(document.getElementById("Id_yes_QRMatrix").checked==true||document.getElementById("Id_yes_SolveMatrix").checked==true){document.getElementById("Id_yes_QRMatrix").checked=false;document.getElementById("Id_yes_SolveMatrix").checked=false;}}
function setSolveMatrix()
{if(document.getElementById("Id_yes_QRMatrix").checked==true||document.getElementById("Id_yes_SVDMatrix").checked==true){document.getElementById("Id_yes_QRMatrix").checked=false;
document.getElementById("Id_yes_SVDMatrix").checked=false}}
function setDetermMatrix()
{
if(document.getElementById("Id_yes_QRMatrix").checked==true||document.getElementById("Id_yes_SVDMatrix").checked==true||document.getElementById("Id_yes_SolveMatrix").checked==true){document.getElementById("Id_yes_QRMatrix").checked=false;document.getElementById("Id_yes_SVDMatrix").checked=false;document.getElementById("Id_yes_SolveMatrix").checked=false;}
}
function setMatrix()
{
if(!document.getElementById("id_rowMatrix"))
{var tdiv=document.createElement('div');
var htmlRCMatrix='<input type="text" size="6" id="id_rowMatrix" value="2"/>кол-во строк<br>'+
'<input type="text" size="6" id="id_colMatrix" value="2"/>кол-во столбцов<br>'+
'<input type="checkbox" id="Id_yes_QRMatrix" onchange="setQRMatrix()" value="checkbox"/>QR-разложение<br>'+
'<input type="checkbox" id="Id_yes_SVDMatrix" onchange="setSVDMatrix()" value="checkbox"/>SVD-разложение<br>'+
'<input type="checkbox" id="Id_yes_SolveMatrix" onchange="setSolveMatrix()" value="checkbox"/>Решить СЛАУ(A*X=B)<br>'+
'<input type="checkbox" id="Id_yes_DetermMatrix" onchange="setDetermMatrix()" value="checkbox"/>Определитель матрицы<br>';
tdiv.innerHTML=htmlRCMatrix;
document.getElementById("Place_Matrix").appendChild(tdiv);
}
}
function forecastAllkvadr(AllnewArrayAggregOrNo,AllnewKvadrSeries)
{
var LF_name=document.getElementById("id_ForecastName_L").value;
var new_AlllayerSumPr = new OpenLayers.Layer.Vector(LF_name,{renderers:["Canvas", "SVG", "VML"]});
new_AlllayerSumPr.projection=new OpenLayers.Projection("EPSG:900913");

for(var k=0;k<AllnewArrayAggregOrNo.length;k++)
     {
rows=AllnewArrayAggregOrNo[k].length;//m
columns=AllnewArrayAggregOrNo[k][0].length;//n
//rtt=AllnewArrayAggregOrNo;

//alert("AllnewArrayAggregOrNo");
var FinalSVD=SVDMatrix(AllnewArrayAggregOrNo[k],columns,rows);
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/*var AllnewArrayAggregOrNo=[]; var newKvadrSeries=[]; var AllnewKvadrSeries=[];
for (var ii=1;ii<document.getElementById("sumNumber_idKvadr").length;ii++)
{var s=document.getElementById("sumNumber_idKvadr").length;
var kvadr=document.getElementById("sumNumber_idKvadr")[ii].value;
rows=document.getElementById("winLength").value
var newLength=0; newKvadrSeries=[]; 
for(var i=0;i<SSALayerMain.features.length;i++)
{if(SSALayerMain.features[i].attributes["NumberKvadr"]==kvadr){newLength++;newKvadrSeries.push(SSALayerMain.features[i]);}}
columns=newLength-rows+1;
var arr = [];  
for(var i=0; i<rows; i++){
    arr[i] = [];
    for(var j=0; j<columns; j++){
if(i==0)
   {    arr[i][j] =newKvadrSeries[j].attributes[document.getElementById("SSALayerField").value];}
else
{arr[i][j]=newKvadrSeries[j+i].attributes[document.getElementById("SSALayerField").value];}
    }
  }
 var  A=arr ;   Aishod=arr;
rtt=A;
rows=A.length;//m
columns=A[0].length;//n
AllnewArrayAggregOrNo.push(A);
AllnewKvadrSeries.push(newKvadrSeries);
}*/
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//rtt=AllnewArrayAggregOrNo;
//alert("AllnewArrayAggregOrNo2");

///multiply matrix - composition
 U=FinalSVD[0];
S=FinalSVD[1];
V=FinalSVD[2];
s=FinalSVD[3];
U=multiplMatixNumber(parseInt(-1),U); //zamena "-" na "+"
V=multiplMatixNumber(parseInt(-1),V);  //zamena "-" na "+"

//newArrayAggregOrNo=AllnewArrayAggregOrNo[i];
//U=multiplMatixNumber(parseInt(-1),U); //zamena "-" na "+"
var ForecastSerial=[];
var varForecastSerial=parseFloat(AllnewKvadrSeries[k][AllnewKvadrSeries[k].length-1].attributes[document.getElementById("SSALayerField").value]);
var u=[];
var Uz=[];
var Qz=[];
var QzTemp;

for(var i=0;i<U.length-1;i++)
    { 
       Uz[i]=[]
     for(var j=0;j<U[i].length-1;j++)
    {Uz[i][j]=(U[i][j]);}
        }
rtt=Uz;
//alert("Uz");
u[0]=[];
for(var i=0;i<U[U.length-1].length-1; i++)
{u[0][i]=U[U.length-1][i];}

PserFinal=parseInt(document.getElementById("id_LengthForecast2").value)


var nextForeFore=0;
for(var Pser=0;Pser<PserFinal;Pser++)
{
var countSerialFor=AllnewKvadrSeries[k].length-U.length+2;
for(var i=0;i<=AllnewKvadrSeries[k].length-countSerialFor;i++)
   {
//Qz[i]=[];
var t=parseInt(i+countSerialFor-1)+Pser;  
 if(AllnewKvadrSeries[k][t])
{Qz[i]=parseFloat(AllnewKvadrSeries[k][t].attributes[document.getElementById("SSALayerField").value]);
if(i==AllnewKvadrSeries[k].length-countSerialFor){Qz[i]=varForecastSerial;}}

    }
 
for(var hj=0;hj<ForecastSerial.length;hj++)
{
if(Qz[Qz.length-1-hj])
{Qz[Qz.length-1-hj]=ForecastSerial[ForecastSerial.length-1-hj]}
}
rtt=Qz;
QzTemp=Qz;
//alert("Qz");

//// GET Forecat value
//Xn+1=u*(1/(UzTrans*Uz))*UzTrans*Qz
 var InversMultMatrix=InverseMatrix(multiplyMatrix(transposeMatrix(Uz),Uz));
//rtt=InversMultMatrix;
//alert("InversMultMatrix");
var MatrixProm=multiplyMatrix(u,InversMultMatrix);
//rtt=MatrixProm;
//alert("MatrixProm");
var MatrixPredFinal=multiplyMatrix(MatrixProm,transposeMatrix(Uz));
//rtt=MatrixPredFinal;
//alert("MatrixPredFinal");
var XfinalFor=multiplyMatrix(MatrixPredFinal,Qz);
//rtt=XfinalFor[0][0];
//alert("forecast "+XfinalFor);
varForecastSerial=XfinalFor[0][0];
 ForecastSerial.push(XfinalFor[0][0]);


       } //end  for(var Pser=0;Pser<9;Pser++)


var lv=document.getElementById("winLength").value;
for(var y=0;y<SSALayerMain.features.length;y++)
{
var n=parseInt(SSALayerMain.features[y].attributes["NumberKvadr"])-parseInt(1);
if(n==k)
{


/*var new_lon=new_pos.lon;
            var new_lat=new_pos.lat;

            var first_point =new OpenLayers.Geometry.Point(new_lon, new_lat);
           first_point= new OpenLayers.Feature.Vector(first_point);*/


var new_style_layer= new OpenLayers.Style({
 pointRadius: 3, fillColor: "#FF9000",
 strokeColor: "#FF9000", strokeWidth: 1,
fillOpacity:1, strokeOpacity:1
 });
 var selStyle = new OpenLayers.Style({
 pointRadius: 5, fillColor: "#ffaa00",
 strokeColor: "#00DDFF", strokeWidth:2,
fillOpacity:1, strokeOpacity:1
 }); 
for(var Pser=0;Pser<PserFinal;Pser++)
{
var format = new OpenLayers.Format.GeoJSON({ 'internalProjection': new OpenLayers.Projection("EPSG:900913"),'externalProjection': new OpenLayers.Projection("EPSG:900913")});
var jsonstring = format.write(SSALayerMain.features[y]);
var format2 = new OpenLayers.Format.GeoJSON({'internalProjection': new OpenLayers.Projection("EPSG:900913"),'externalProjection': new OpenLayers.Projection("EPSG:900913")
});
var feature=format2.read(jsonstring);
var geometry=feature[0].geometry;
var NewAttr={};
 NewAttr["ForecastValue"]=0; 
 NewAttr["NumberKvadr"]=0;
var newFeat=new OpenLayers.Feature.Vector(geometry);
newFeat.attributes=NewAttr;
new_AlllayerSumPr.addFeatures(newFeat);
if(k==0)
{new_AlllayerSumPr.features[k+Pser].attributes["NumberKvadr"]=SSALayerMain.features[y].attributes["NumberKvadr"];
new_AlllayerSumPr.features[k+Pser].attributes["ForecastValue"]=ForecastSerial[Pser];}
else{var rt=new_AlllayerSumPr.features.length-1;rtt=rt; new_AlllayerSumPr.features[rt].attributes["NumberKvadr"]=SSALayerMain.features[y].attributes["NumberKvadr"];
new_AlllayerSumPr.features[rt].attributes["ForecastValue"]=ForecastSerial[Pser];}

}
break;}
}

       }/// end for(var k=0;k<AllnewArrayAggregOrNo.length;k++)
new_AlllayerSumPr.styleMap=new OpenLayers.StyleMap({'default':new_style_layer,'select': selStyle});
map.addLayer(new_AlllayerSumPr);
var t=this.document.createElement('option');
t.value=new_AlllayerSumPr.name;
t.text=new_AlllayerSumPr.name;
this.document.getElementById("editL1").appendChild(t);

}
function setComputeAllKvadr()
{
var htmlTimeKvadr='';
htmlTimeKvadr+='<input type="text" size="10" id="id_ForecastName_L" value="Прогноз_по_квадр"/>название слоя с прогнозом<br>';
var tdiv=document.createElement('div');
tdiv.id="Divid_ForecastName_L";
tdiv.innerHTML=htmlTimeKvadr;
if(!document.getElementById("Divid_ForecastName_L"))
{document.getElementById("divPromSumKvadrNumber").appendChild(tdiv);}
}
function AggregSumKvadrTime(SSALayer)
{
 if(document.getElementById("SSALayerField").value==0)
 {alert("выберите параметр"); return;}
var htmlTimeKvadr='';
htmlTimeKvadr+='<select id=sumNumber_idKvadr>'+
 '<option selected value="0"></option>'+
'</select>номер квадрата<br>'+
'<input type="checkbox" id="Id_yes_AllKvadr" title="Прогноз по всем квадратам и получить новый слой содержащий прогнозные значения" onchange="setComputeAllKvadr()" value="checkbox"/>Прогноз по всем квадратам<br>'+
'<input type="text" size="6" id="id_LengthForecast2" title="Введите число шагов прогноза (например -2 или 3 месяца)" value="0"/>Длина прогноза<br>';
var tdiv=document.createElement('div');
tdiv.id="divPromSumKvadrNumber";
tdiv.innerHTML=htmlTimeKvadr;
if(!document.getElementById("divPromSumKvadrNumber"))
{document.getElementById("Div_Id_AggregSumKvadr").appendChild(tdiv);}
if(!SSALayer.features[0].attributes["NumberKvadr"]){alert("Слой не агрегирован, выберите другой или создайте заново"); return;};
var seldel = document.getElementById("sumNumber_idKvadr");
 while (seldel.childNodes.length) {
 if (seldel.firstChild.tagName == 'OPTGROUP') {
 while (seldel.firstChild.childNodes.length) {
 seldel.firstChild.removeChild(seldel.firstChild.firstChild); } }
 seldel.removeChild(seldel.firstChild); }
 var t=document.createElement('option');
t.value="0";t.text="";document.getElementById("sumNumber_idKvadr").appendChild(t);
var NumberSqC={};
for(var i=0;i<SSALayer.features.length;i++)
{NumberSqC[SSALayer.features[i].attributes["NumberKvadr"]]=true;}
for(h in NumberSqC){
var t=document.createElement('option');
 t.value=h;
 t.text=h;
 document.getElementById("sumNumber_idKvadr").appendChild(t);}

}
function Fractals()
{
var bbox = document.getElementById("map").getBoundingClientRect();
 var body = document.body
 var docElem = document.documentElement
 var scrollTop = window.pageYOffset || docElem.scrollTop || body.scrollTop
 var scrollLeft = window.pageXOffset || docElem.scrollLeft || body.scrollLeft
 var clientTop = docElem.clientTop || body.clientTop || 0
 var clientLeft = docElem.clientLeft || body.clientLeft || 0
 var topTop = bbox.top + scrollTop - clientTop
 var leftLeft = bbox.left + scrollLeft - clientLeft
var DivEditeLeg=document.createElement("div");
DivEditeLeg.id="id_FractLegMain2";
DivEditeLeg.className="id_divRoutLegMain";
DivEditeLeg.style.position="relative";

var htmlSSAStart=" ";
htmlSSAStart+='<div id="id_divFractQLeg" style="background:#ffffff; color:#0000ff;z-index: 6000;position:absolute;left:'+Math.round(leftLeft+50)+'px;top:'+Math.round(topTop-100)+
'px;overflow:hidden; border: 1px solid black;"><img onclick="closeFractWin()" src="openlayers/theme/default/img/close.gif" style="position:relative; top:10px;float:right; cursor:pointer"><a style="position:relative; top:20px"></a>'+
'<a style="font-size: 9px;"> Вы можете перемещать это окно если щёлкните по пункту меню: Интерфейс->переключить режим интерфейса</a><br>';
htmlSSAStart+='<a href=http://en.wikipedia.org/wiki/Fractal target=_blank>Draw and Calculate fractals </a><br>'+
'<a>Z</a><a style="font-size:11px">n+1</a><a>=Z</a><a style="font-size:11px">n</a><sup>d</sup><a>+c</a><a>; </a>'+
'<a>c = p + iq</a><br>'+
'<a>Select name </a>'+
'<select id="FractalsName_1">'+
 '<option selected value="Mandel">Mandelbrot set</option>'+
'<option value="Julia">Julia sets</option>'+
'</select><br>'+
'<a>number of iteration:</a><input type="text" id="fractal_iteration_id" value="50" size=6><br>'+
'<a>delta:</a><input type="text" id="fractal_delta_id" value="0.009" title="Decreasing this value increases the number of point">'+
'<a>;power d:</a><input type="text" id="id_dFracJul" value="2" size="4"><br>'+
'<div id="fractal_id"></div>'+
'<a>Layer name:</a><input type="text" id="fractal_layer_name_id" value="Fractal" size=10><br>'+
'<p> <button type=button onclick=OK_Fractals()>OK</button></p></div>';
DivEditeLeg.innerHTML=htmlSSAStart;
if(!document.getElementById("id_FractLegMain2"))
{body.appendChild(DivEditeLeg);}
document.getElementById("id_FractLegMain2").onmousedown=function(event){drags(event)};
document.getElementById("id_FractLegMain2").onmouseup=function(e){enddrag()};
document.getElementById("FractalsName_1").onchange=function(){nameFractalfunction()};
}
function nameFractalfunction()
{
var t0=document.createElement("a");
var t1=document.createElement("input");
t1.type="text";
t1.size=6;t1.value=0.28;t1.id="id_pFracJul";
var t2=document.createElement("input");
t2.type="text";
t2.size=6;t2.value=0.0113;t2.id="id_qFracJul";
var t3=document.createElement("a");
t0.innerHTML="p:";t3.innerHTML=" q:";
var t01=document.createElement("a");
t01.innerHTML="function Z:";
var t02=document.createElement("select");
t02.id="id_sFracJul";
var t022=document.createElement("select");
t022.id="id_s2FracJul";
var t002=document.createElement("br");
var t003=document.createElement("a");
t003.innerHTML="*";
var t0222=document.createElement("select");
t0222.id="id_s3FracJul";
var t0033=document.createElement("a");
t0033.innerHTML="*";

if(!document.getElementById("id_pFracJul"))
{document.getElementById("fractal_id").appendChild(t0);
document.getElementById("fractal_id").appendChild(t1);
document.getElementById("fractal_id").appendChild(t3);
document.getElementById("fractal_id").appendChild(t2);
document.getElementById("fractal_id").appendChild(t002);
document.getElementById("fractal_id").appendChild(t01);
document.getElementById("fractal_id").appendChild(t02);
document.getElementById("fractal_id").appendChild(t003);
document.getElementById("fractal_id").appendChild(t022);
document.getElementById("fractal_id").appendChild(t0033);
document.getElementById("fractal_id").appendChild(t0222);
var t=document.createElement('option');
t.value="0";
t.text=".";
document.getElementById("id_s3FracJul").appendChild(t);
var t=document.createElement('option');
t.value="Z";
t.text="Z";
document.getElementById("id_s3FracJul").appendChild(t);

var t=document.createElement('option');
t.value="0";
t.text=".";
document.getElementById("id_sFracJul").appendChild(t);
var t=document.createElement('option');
t.value="Math.sin";
t.text="sin(Z)";
document.getElementById("id_sFracJul").appendChild(t);
var t=document.createElement('option');
t.value="Math.cos";
t.text="cos(Z)";
document.getElementById("id_sFracJul").appendChild(t);
var t=document.createElement('option');
t.value="Math.tan";
t.text="tan(Z)";
document.getElementById("id_sFracJul").appendChild(t);
var t=document.createElement('option');
t.value="Math.cotan";
t.text="cotan(Z)";
document.getElementById("id_sFracJul").appendChild(t);
var t=document.createElement('option');
t.value="Math.atan";
t.text="atan(Z)";
document.getElementById("id_sFracJul").appendChild(t);

var t=document.createElement('option');
t.value="0";
t.text=".";
document.getElementById("id_s2FracJul").appendChild(t);
var t=document.createElement('option');
t.value="Math.sin";
t.text="sin(Z)";
document.getElementById("id_s2FracJul").appendChild(t);
var t=document.createElement('option');
t.value="Math.cos";
t.text="cos(Z)";
document.getElementById("id_s2FracJul").appendChild(t);
var t=document.createElement('option');
t.value="Math.tan";
t.text="tan(Z)";
document.getElementById("id_s2FracJul").appendChild(t);
var t=document.createElement('option');
t.value="Math.cotan";
t.text="cotan(Z)";
document.getElementById("id_s2FracJul").appendChild(t);
var t=document.createElement('option');
t.value="Math.atan";
t.text="atan(Z)";
document.getElementById("id_s2FracJul").appendChild(t);

}

}
function OK_Fractals()
{
var new_layer_Fract = new OpenLayers.Layer.Vector(document.getElementById("fractal_layer_name_id").value,{renderers:["Canvas", "SVG", "VML"]});
var points;
lon=0;lat=0;
var st1=new Date('1970-01-01T'+'00:00:00');st1=st1.getTime();
var yii=new Date(st1);
var new_pos2=new OpenLayers.LonLat(lon,lat).transform(
new OpenLayers.Projection("EPSG:4326"),
map.getProjectionObject());
var ext=map.getExtent(); 
IntX=(ext.right-ext.left)/2;IntX=ext.right-IntX
IntY=(ext.top-ext.bottom)/2;IntY=ext.top-IntY;

var new_posE=new OpenLayers.LonLat(IntX, IntY).transform(
map.getProjectionObject(),
new OpenLayers.Projection("EPSG:4326"));
//console.log(new_posE.lon+","+new_posE.lat);
//console.log(IntX+","+IntY)
//arg=Re*Re+Im*Im;
var DELTA=parseFloat(document.getElementById("fractal_delta_id").value);
var CPS = 2; 
var ArrayFeatures=[];
var MAX_ITERATIONS=parseInt(document.getElementById("fractal_iteration_id").value);

 for (var Re = -CPS; Re <= CPS; Re = Re + DELTA) 
{ // Represents the Re-axis. Re is the real part of a complex c value.
next_c_value: 
for (var Im = -CPS; Im <= CPS; Im = Im + DELTA) 
{ // Represents the Im-axis. Im is the imaginary part of a complex c value.
if(document.getElementById("FractalsName_1").value=='Mandel')
{var Zre=0; var Zim=0;var Сre=Re; var Cim=Im;}
if(document.getElementById("FractalsName_1").value=='Julia')
{
var Zre=Re; var Zim=Im;var Сre=parseFloat(document.getElementById("id_pFracJul").value); var Cim=parseFloat(document.getElementById("id_qFracJul").value);
}

      var attr={};  var exponentialSmoothingSum = 0; var iteration=0;
      for (var iterationCount = 1; iterationCount <= MAX_ITERATIONS; iterationCount++)
 {    var phi=0;
if(Zre>0)
{var phi=Math.atan(Zim/Zre);
}
if(Zre==0&&Zim==0){var phi=0;}
if(Zre<0&&Zim>0)
{var phi=Math.PI+Math.atan(Zim/Zre);
}
if(Zre<0&&Zim<0)
{var phi=(-1)*Math.PI+Math.atan(Zim/Zre);
}
var ModulZ=Math.sqrt(Zre*Zre+Zim*Zim);
var dP=parseFloat(document.getElementById("id_dFracJul").value);
//var phiRad=(dP*(Math.PI*phi))/180;
var phiRad=(dP*phi);
var SquareZre=Math.pow(ModulZ,dP)*(Math.cos(phiRad));
var SquareZim=Math.pow(ModulZ,dP)*(Math.sin(phiRad));
//var SquareZre=Zre*Zre-Zim*Zim;
//var SquareZim=2*Zre*Zim;
var ZaddRe=SquareZre+Сre;var ZaddIm=SquareZim+Cim;
if(document.getElementById("id_sFracJul")&&document.getElementById("id_sFracJul").value!=="0")
{
if(document.getElementById("id_sFracJul").value=="Math.cotan")
{ZaddRe=1/Math.tan(ZaddRe); ZaddIm=1/Math.tan(ZaddIm);}
else{
ZaddRe=eval(document.getElementById("id_sFracJul").value+"("+ZaddRe+")");ZaddIm=eval(document.getElementById("id_sFracJul").value+"("+ZaddIm+")");}
}
if(document.getElementById("id_sFracJul")&&document.getElementById("id_s2FracJul").value!=="0")
{
if(document.getElementById("id_s2FracJul").value=="Math.cotan")
{ZaddRe2=1/Math.tan(ZaddRe); ZaddIm=1/Math.tan(ZaddIm);}
else{
ZaddRe2=eval(document.getElementById("id_s2FracJul").value+"("+ZaddRe+")");ZaddIm2=eval(document.getElementById("id_s2FracJul").value+"("+ZaddIm+")");}
}
if(document.getElementById("id_sFracJul")&&document.getElementById("id_sFracJul").value!=="0"&&document.getElementById("id_s2FracJul").value!=="0")
{
ZaddRe=ZaddRe*ZaddRe2;ZaddIm=ZaddIm*ZaddIm2;

}
if(document.getElementById("id_sFracJul")&&document.getElementById("id_s3FracJul").value!=="0")
{ZaddRe=ZaddRe*ZaddRe;ZaddIm=ZaddIm*ZaddIm;}
Zre=ZaddRe;Zim=ZaddIm;
varZmodul=ZaddRe*ZaddRe+ZaddIm*ZaddRe;//mathematically correct expession should be like this: varZmodul=ZaddRe*ZaddRe+ZaddIm*ZaddIm, but also from a mathematical point of view, we can interrupt the iteration at any value so at this point in OpenWebGIS the iteration is terminated under the following condition. In this way, when the iterations are interrupted the fractals become much more interesting. Perhaps in future versions of OpenWebGIS user will be able to choose conditions by themselves.


  iteration+=(Zre*Zre + Zim*Zim)

if (varZmodul> 4) 
{continue next_c_value;} 
      } 
attr.iterationValue=iteration;
if(iteration>MAX_ITERATIONS/4)
{
var PixelW=map.getPixelFromLonLat(new OpenLayers.LonLat(ext.right,ext.top));
var PixelH=map.getPixelFromLonLat(new OpenLayers.LonLat(ext.left,ext.bottom));

lat=((PixelH.y)*(2-Im))/4;
lon=((PixelW.x)*(Re+2))/4;

var lonlat=map.getLonLatFromPixel(new OpenLayers.Pixel(lon,lat));
var lon=lonlat.lon;
var lat=lonlat.lat;

var new_pos2=new OpenLayers.LonLat(lon,lat);

var new_pos22=new OpenLayers.LonLat(lon,lat).transform(map.getProjectionObject(),new OpenLayers.Projection("EPSG:4326"));
attr.longitude=new_pos22.lon;
attr.latitude=new_pos22.lat;
yii.setSeconds(yii.getSeconds()+1);
var monthNN=yii.getMonth()+1;if(monthNN<10){monthNN='0'+monthNN;}
var dayNN=yii.getDate(); if(dayNN<10){dayNN='0'+dayNN;}
var hoursNN=yii.getHours();if(hoursNN<10){hoursNN='0'+hoursNN;}
var minNN=yii.getMinutes();if(minNN<10){minNN='0'+minNN;}
var secNN=yii.getSeconds();if(secNN<10){secNN='0'+secNN;}
var Datert2=yii.getFullYear()+"-"+monthNN+'-'+dayNN+'T'+hoursNN+':'+minNN+':'+secNN;
attr.Time=Datert2;
points=new OpenLayers.Geometry.Point(new_pos2.lon, new_pos2.lat);
var first_point= new OpenLayers.Feature.Vector(points);
first_point.attributes=attr;
ArrayFeatures.push(first_point);}
      //ctx.fillRect(Re, Im, DELTA, DELTA); // This c value is probably part of the Mandelbrot set, so color this pixel black. A "pixel" for the canvas is a DELTA x DELTA black square.
    } // for
  } // for

if (ArrayFeatures.length==0)
{alert("formula does not return data");return;}

new_layer_Fract.addFeatures(ArrayFeatures);
var new_style_layer= new OpenLayers.Style({
 pointRadius: 1,
 fillColor: "#FF9000",
 strokeColor: "#FF9000",
 strokeWidth: 1,
fillOpacity:1,
 strokeOpacity:1
 });
 var selStyle = new OpenLayers.Style({
 pointRadius: 5, 
 fillColor: "#ffaa00",
 strokeColor: "#00DDFF",
 strokeWidth:2,
fillOpacity:1,
 strokeOpacity:1
 }); 
new_layer_Fract.styleMap=new OpenLayers.StyleMap({'default':new_style_layer,'select': selStyle});
new_layer_Fract.projection=new OpenLayers.Projection("EPSG:900913");
map.addLayer(new_layer_Fract);
var t=document.createElement('option');
t.value=new_layer_Fract.name;
t.text=new_layer_Fract.name;
document.getElementById("editL1").appendChild(t);
ArrayFeatures=[];
}
function Corrvalue1()
{
var n=document.getElementById("CorrLayer1").value;
var mLayers=map.layers;
 for(var ab = 0; ab < mLayers.length; ab++ )
 {if(mLayers[ab].name==n)
{for (h in mLayers[ab].features[0].attributes){var t=document.createElement('option');
 t.value=h; t.text=h; document.getElementById("CorrLayerValue1").appendChild(t)}}
}
}
function Corrvalue2()
{
var n=document.getElementById("CorrLayer2").value;
var mLayers=map.layers;
 for(var ab = 0; ab < mLayers.length; ab++ )
 {if(mLayers[ab].name==n)
{for (h in mLayers[ab].features[0].attributes){var t=document.createElement('option');
 t.value=h; t.text=h; document.getElementById("CorrLayerValue2").appendChild(t)}}
}
}
function Correlation()
{
var bbox = document.getElementById("map").getBoundingClientRect();
 var body = document.body
 var docElem = document.documentElement
 var scrollTop = window.pageYOffset || docElem.scrollTop || body.scrollTop
 var scrollLeft = window.pageXOffset || docElem.scrollLeft || body.scrollLeft
 var clientTop = docElem.clientTop || body.clientTop || 0
 var clientLeft = docElem.clientLeft || body.clientLeft || 0
 var topTop = bbox.top + scrollTop - clientTop
 var leftLeft = bbox.left + scrollLeft - clientLeft
var DivEditeLeg=document.createElement("div");
DivEditeLeg.id="id_CorrLegMain2";
DivEditeLeg.className="id_divRoutLegMain";
DivEditeLeg.style.position="relative";

var htmlSSAStart=" ";
htmlSSAStart+='<div id="id_divCorrQLeg" style="background:#ffffff; color:#0000ff;z-index: 6000;position:absolute;left:'+Math.round(leftLeft+50)+'px;top:'+Math.round(topTop-100)+
'px;overflow:hidden; border: 1px solid black;"><img onclick="closeCorrWin()" src="openlayers/theme/default/img/close.gif" style="position:relative; top:10px;float:right; cursor:pointer"><a style="position:relative; top:20px"></a>'+
'<a style="font-size: 9px;"> Вы можете перемещать это окно если щёлкните по пункту меню: Интерфейс->переключить режим интерфейса</a><br>';
htmlSSAStart+='<a href=http://en.wikipedia.org/wiki/Pearson_product-moment_correlation_coefficient target=_blank>Calculate correlation coefficient and </a>'+
'<a href=http://en.wikipedia.org/wiki/Linear_regression target=_blank>regression equation </a><br>'+
'<a>Select Layer </a> <a>to get first value:</a>'+
'<select id="CorrLayer1" onchange="Corrvalue1()">'+
 '<option selected value="0">.</option>'+
'</select><br>'+
'<a>Select first value (y) </a>:'+
'<select id="CorrLayerValue1" title="First of all select Layer">'+
 '<option selected value="0">.</option>'+
'</select><br>'+
'<a>Select Layer </a> <a>to get second value:</a>'+
'<select id="CorrLayer2" onchange="Corrvalue2()">'+
 '<option selected value="0">.</option>'+
'</select><br>'+
'<a>Select second value (x)</a>:'+
'<select id="CorrLayerValue2" title="First of all select Layer">'+
 '<option selected value="0">.</option>'+
'</select><br>'+
'<a>correlation coefficient, variance:</a><br>'+
'<textarea id="id_textCorrel" style="width: 290px; height: 80px;font-size:11px"></textarea>'+
'<p> <button type=button onclick=OK_Correlation()>OK</button></p></div>';
DivEditeLeg.innerHTML=htmlSSAStart;
if(!document.getElementById("id_CorrLegMain2"))
{body.appendChild(DivEditeLeg); }
document.getElementById("id_CorrLegMain2").onmousedown=function(event){drags(event)};
document.getElementById("id_CorrLegMain2").onmouseup=function(e){enddrag()};



var mLayers=map.layers;
 for(var ab = 0; ab < mLayers.length; ab++ )
 {if(mLayers[ab].CLASS_NAME=="OpenLayers.Layer.Vector")
 {var t=document.createElement('option');
 t.value=mLayers[ab].name;
 t.text=mLayers[ab].name;
 document.getElementById("CorrLayer1").appendChild(t);}
 }
for(var ab = 0; ab < mLayers.length; ab++ )
 {if(mLayers[ab].CLASS_NAME=="OpenLayers.Layer.Vector")
 {var t=document.createElement('option');
 t.value=mLayers[ab].name;
 t.text=mLayers[ab].name;
 document.getElementById("CorrLayer2").appendChild(t);}
 }

}
function OK_Correlation()
{
if(document.getElementById("CorrLayer1").value==0||document.getElementById("CorrLayer2").value==0||document.getElementById("CorrLayerValue1").value==0||document.getElementById("CorrLayerValue2").value==0)
{alert("select value");return;}
var n=document.getElementById("CorrLayer1").value;
var countV1=0;var feat1='';
var mLayers=map.layers;
 for(var ab = 0; ab < mLayers.length; ab++ )
 {if(mLayers[ab].name==n)
{countV1=mLayers[ab].features.length;feat1=mLayers[ab].features;
if(isNaN(mLayers[ab].features[0].attributes[document.getElementById("CorrLayerValue1").value]*1)==true){alert("Error value is string");return;} 
}
}
var n=document.getElementById("CorrLayer2").value;
var countV2=0;var feat2='';
var mLayers=map.layers;
 for(var ab = 0; ab < mLayers.length; ab++ )
 {if(mLayers[ab].name==n)
{countV2=mLayers[ab].features.length;feat2=mLayers[ab].features;
if(isNaN(mLayers[ab].features[0].attributes[document.getElementById("CorrLayerValue2").value]*1)==true){alert("Error value is string");return;} 
}
}
if(countV1!=countV2){alert("number of first value not equal number of second value");return;}

var mean1=0;var mean2=0; sumV1V2=0; squaredVal1=0;squaredVal2=0;
for (var i=0;i<feat1.length;i++)
{mean1+=parseFloat(feat1[i].attributes[document.getElementById("CorrLayerValue1").value]);
sumV1V2+=parseFloat(feat1[i].attributes[document.getElementById("CorrLayerValue1").value])*parseFloat(feat2[i].attributes[document.getElementById("CorrLayerValue2").value]);
squaredVal1+=parseFloat(feat1[i].attributes[document.getElementById("CorrLayerValue1").value])*parseFloat(feat1[i].attributes[document.getElementById("CorrLayerValue1").value]);
mean2+=parseFloat(feat2[i].attributes[document.getElementById("CorrLayerValue2").value]);
squaredVal2+=parseFloat(feat2[i].attributes[document.getElementById("CorrLayerValue2").value])*parseFloat(feat2[i].attributes[document.getElementById("CorrLayerValue2").value]);
}

mean1=mean1/feat1.length;
mean2=mean2/feat2.length;
sumV1V2=sumV1V2/feat1.length;
variance1=(squaredVal1/feat1.length)-(mean1*mean1);
variance2=(squaredVal2/feat1.length)-(mean2*mean2);
CoefCorr=(sumV1V2-(mean1*mean2))/ (Math.pow(variance1,0.5)*Math.pow(variance2,0.5));
//coeff regression
var b=(sumV1V2-(mean1*mean2))/variance2;
var a=mean1-b*mean2;
document.getElementById("id_textCorrel").value='correlation coefficient: '+CoefCorr+'\n'+'variance1: '+variance1+'\n'+'variance2:' +variance2+'\n'+'regression equation: '+document.getElementById("CorrLayerValue1").value+'='+a+'+'+b+'*'+document.getElementById("CorrLayerValue2").value;



}
function SSA()
{
var htmlSSAStart=" ";
var bbox = document.getElementById("map").getBoundingClientRect();
 var body = document.body
 var docElem = document.documentElement
 var scrollTop = window.pageYOffset || docElem.scrollTop || body.scrollTop
 var scrollLeft = window.pageXOffset || docElem.scrollLeft || body.scrollLeft
 var clientTop = docElem.clientTop || body.clientTop || 0
 var clientLeft = docElem.clientLeft || body.clientLeft || 0
 var topTop = bbox.top + scrollTop - clientTop
 var leftLeft = bbox.left + scrollLeft - clientLeft
var DivEditeLeg=document.createElement("div");
DivEditeLeg.id="id_SSALegMain2";
DivEditeLeg.className="id_divRoutLegMain";
DivEditeLeg.style.position="relative";

htmlSSAStart+='<div id="id_divSSALeg" style="background:#ffffff; color:#0000ff;z-index: 6000;position:absolute;left:'+Math.round(leftLeft+50)+'px;top:'+Math.round(topTop-100)+
'px;overflow:hidden; border: 1px solid black;"><img onclick="closeSSAWin()" src="openlayers/theme/default/img/close.gif" style="position:relative; top:10px;float:right; cursor:pointer"><a style="position:relative; top:20px"></a>'+
'<a style="font-size: 9px;"> Вы можете перемещать это окно если щёлкните по пункту меню: Интерфейс->переключить режим интерфейса</a><br>'
htmlSSAStart+='<a>Выберите слой </a><a href=https://ru.wikipedia.org/wiki/SSA_%28%EC%E5%F2%EE%E4%29 target=_blank>для анализа и прогноза:</a>'+
'<select id="SSALayer">'+
 '<option selected value="0">.</option>'+
'</select><br>'+
'<input type="checkbox" id="Id_yes_Matrix" onchange="setMatrix()" value="checkbox" title="щёлкните, если вы хотите ввести произвольную матрицу и рассчитать QR-разложение, SVD-разложение, решить системы линейных уравнений LSAE (A * X = B), определитель матрицы"/>Ввести матрицу<br>'+
'<div id="Place_Matrix"></div><br>'+
'<p> <button type=button onclick=OK_SSA()>OK</button></p></div>';
DivEditeLeg.innerHTML=htmlSSAStart;
if(!document.getElementById("id_SSALegMain2"))
{body.appendChild(DivEditeLeg); }
document.getElementById("id_SSALegMain2").onmousedown=function(event){drags(event)};
document.getElementById("id_SSALegMain2").onmouseup=function(e){enddrag()};
var mLayers=map.layers;
 for(var ab = 0; ab < mLayers.length; ab++ )
 {if(mLayers[ab].CLASS_NAME=="OpenLayers.Layer.Vector")
 {var t=document.createElement('option');
 t.value=mLayers[ab].name;
 t.text=mLayers[ab].name;
 document.getElementById("SSALayer").appendChild(t);}
 }
}
function OK_SSA()
{
if(document.getElementById("Id_yes_Matrix").checked==true)
{var htmlRowColMatrix='';
for(var i=0; i<document.getElementById("id_rowMatrix").value; i++){
 for(var j=0; j<document.getElementById("id_colMatrix").value; j++){var varid="id_colMatrix_"+i+"_"+j;
 htmlRowColMatrix+='<input type="text" size="6" id='+varid+' value="0"/>.';
if(j==document.getElementById("id_colMatrix").value-1){htmlRowColMatrix+='<br>';}
 }
 }
if(document.getElementById("Id_yes_SolveMatrix").checked==true)
{
htmlRowColMatrix+='<a>X</a><div id=div_SolveBcolX>';
for(var iff=0; iff<document.getElementById("id_rowMatrix").value; iff++){
 var varidB="id_colMatrixBX_"+iff;
htmlRowColMatrix+='<a>*X'+parseInt(iff+1)+'</a><br>';}
htmlRowColMatrix+='</div>';
htmlRowColMatrix+='<br><a>B</a><div id=div_SolveBcol>';
for(var iff=0; iff<document.getElementById("id_rowMatrix").value; iff++){
 var varidB="id_colMatrixB_"+iff;
htmlRowColMatrix+='<input type="text" size="6" id='+varidB+' value="0"/>.<br>';}
htmlRowColMatrix+='</div>';
}
 htmlRowColMatrix+='<p> <button type=button onclick=OK_SSA2()>Compute Matrix</button></p>';
if(!document.getElementById("divMatrixColRowBox"))
 { var tdiv=document.createElement('div');
tdiv.id="divMatrixColRowBox";
tdiv.innerHTML=htmlRowColMatrix;
document.getElementById("Place_Matrix").appendChild(tdiv);}
else{document.getElementById("divMatrixColRowBox").innerHTML=htmlRowColMatrix;}
 }
if(document.getElementById("Id_yes_Matrix").checked==false)
{if(document.getElementById("id_SSALegMain2")){document.getElementById("id_SSALegMain2").style.display="none";}
var htmlSSAStart2=" ";
var bbox = document.getElementById("map").getBoundingClientRect();
 var body = document.body
 var docElem = document.documentElement
 var scrollTop = window.pageYOffset || docElem.scrollTop || body.scrollTop
 var scrollLeft = window.pageXOffset || docElem.scrollLeft || body.scrollLeft
 var clientTop = docElem.clientTop || body.clientTop || 0
 var clientLeft = docElem.clientLeft || body.clientLeft || 0
 var topTop = bbox.top + scrollTop - clientTop
 var leftLeft = bbox.left + scrollLeft - clientLeft
var DivEditeLeg=document.createElement("div");
DivEditeLeg.id="id_SSA2LegMain2";
DivEditeLeg.className="id_divRoutLegMain";
DivEditeLeg.style.position="relative";
htmlSSAStart2+='<div id="id_divSSALeg" style="background:#ffffff; color:#0000ff;z-index: 6000;position:absolute;left:'+Math.round(leftLeft+50)+'px;top:'+Math.round(topTop-100)+
'px;overflow:hidden; border: 1px solid black;"><img onclick="closeSSAWin2()" src="openlayers/theme/default/img/close.gif" style="position:relative; top:10px;float:right; cursor:pointer"><a style="position:relative; top:20px"></a>'+
'<a style="font-size: 9px;"> Вы можете перемещать это окно если щёлкните по пункту меню: Интерфейс->переключить режим интерфейса</a><br>';
htmlSSAStart2+='<a>выберите параметр:</a>'+
'<select id="SSALayerField">'+
 '<option selected value="0">.</option>'+
 '</select><br>'+
'<a>Подпись по оси Х на графике:</a>'+
'<select id="SSAXField">'+
 '<option selected value="0">.</option>'+
 '</select><br>'+
'<a>Доп. подпись по оси Х на графике:</a>'+
'<select id="SSAXField2">'+
 '<option selected value="0">.</option>'+
 '</select><br>'+
'<a>Введите длину окна:</a><input type="text" size="8" id="winLength" value="0" title="Длина окна должна выбираться, вообще говоря, достаточно большим, чтобы каждый из векторов вложения содержал в себе существенную часть поведения исходного ряда F = (f0, . . . , fN−1).Для анализа структуры временного ряда базовым методом SSA не имеет смысла брать длину окна, большую чем половина длины ряда. Чем больше длина окна, тем более детальным получается разложение исходного ряда. Для рядов со сложной структурой слишком большая длина окна может привести к нежелательному разложению интересующих нас компонентов ряда, в частности, к смешиванию их другими компонентами ряда. Подробно о методе SSA(гусеница) см: Голяндина Н.Э. Метод Гусеница- SSA: анализ временных рядов: Учеб.пособие. СПб.,2004."/><a href=https://ru.wikipedia.org/wiki/SSA_%28%EC%E5%F2%EE%E4%29 target=_blank>для анализа и прогноза временнОго ряда</a><br>'+
'<input type="checkbox" id="Id_AggregSumKvadr" onchange="AggregSumKvadrTime()" value="checkbox"/>Использовать агрегированный слой<br>'+
'<div id="Div_Id_AggregSumKvadr"></div><br>'+
'<p> <button type=button onclick=OK_SSA2()>OK</button></p><div id="PrincCompPopup"></div></div>';
DivEditeLeg.innerHTML=htmlSSAStart2;
if(!document.getElementById("id_SSA2LegMain2"))
{body.appendChild(DivEditeLeg); }
document.getElementById("id_SSA2LegMain2").onmousedown=function(event){drags(event)};
document.getElementById("id_SSA2LegMain2").onmouseup=function(e){enddrag()};

var SSALayer;
var mLayers=map.layers;
 for(var ab = 0; ab < mLayers.length; ab++ )
 {
 if (mLayers[ab].name==document.getElementById("SSALayer").value)
 { SSALayer =mLayers[ab];SSALayerMain=SSALayer;} }
for (var a in SSALayer.features[0].attributes)
{var t=document.createElement('option');
 t.value=a;
 t.text=a;
 document.getElementById("SSALayerField").appendChild(t); }
for (var a in SSALayer.features[0].attributes)
{var t=document.createElement('option');
 t.value=a;
 t.text=a;
 document.getElementById("SSAXField").appendChild(t);}
for (var a in SSALayer.features[0].attributes)
{var t=document.createElement('option');
 t.value=a;
 t.text=a;
 document.getElementById("SSAXField2").appendChild(t);}
/*popupSSAStart.destroy();*/if(document.getElementById("id_SSALegMain2")){closeSSAWin();}}
if(document.getElementById("Id_AggregSumKvadr")){document.getElementById("Id_AggregSumKvadr").onchange=function(){AggregSumKvadrTime(SSALayer);}}
}
function OK_SSA2()
{  var arr = [];
var rows;
var columns;
 if(!document.getElementById("Id_yes_Matrix")||document.getElementById("Id_yes_Matrix").checked==false)
 {
columns=3;
var inF=parseFloat(-1);
 for(var i=0; i<rows; i++){
 arr[i] = [];
 for(var j=0; j<columns; j++){inF++;
 arr[i][j] =SSALayerMain.features[inF].attributes[document.getElementById("SSALayerField").value];
 }
 }
rtt=arr;
}
else { 
 var inF=parseFloat(-1);
 for(var i=0; i<document.getElementById("id_rowMatrix").value; i++){
 arr[i] = [];
 for(var j=0; j<document.getElementById("id_colMatrix").value; j++){
 arr[i][j] =document.getElementById("id_colMatrix_"+i+"_"+j).value;
 }
 }
}
if(document.getElementById("Id_yes_DetermMatrix")&&document.getElementById("Id_yes_DetermMatrix").checked==true){alert("Determinant="+Determinant(arr));};
if(document.getElementById("Id_yes_QRMatrix")&&document.getElementById("Id_yes_QRMatrix").checked==true||document.getElementById("Id_yes_SolveMatrix")&&document.getElementById("Id_yes_SolveMatrix").checked==true)
{
var QR= arr;
var n=columns;
var m=rows;
if(document.getElementById("Id_yes_Matrix")&&document.getElementById("Id_yes_Matrix").checked==true)
{
n=document.getElementById("id_colMatrix").value
m=document.getElementById("id_rowMatrix").value
}
var Rdiag=[]
 for (var k = 0; k < n; k++) { 
 var nrm =parseFloat(0);
 for (var i = k; i < m; i++) {
 nrm = Math.sqrt(nrm*nrm+parseFloat(QR[i][k])*parseFloat(QR[i][k]));
 }
 if (nrm != 0.0) {
 if (QR[k][k] < 0) {
 nrm =parseFloat(-nrm);
 }
 for (var i = k; i < m; i++) {
 QR[i][k] /= nrm;
 }
 QR[k][k] = parseFloat(QR[k][k])+parseFloat(1);
 for (var j = k+1; j < n; j++) {
 var s = parseFloat(0); 
 for (var i = k; i < m; i++) {
 s=parseFloat(s)+parseFloat(QR[i][k]*QR[i][j]);
 }
 s = parseFloat(-s/QR[k][k]);
 for (var i = k; i < m; i++) {
 QR[i][j] =parseFloat(QR[i][j])+parseFloat(s*QR[i][k]);
 }
 }
 }
 Rdiag[k] = -nrm;
 }
 /** Return the Householder vectors
 @return Lower trapezoidal matrix whose columns define the reflections
 */
 var XH = [];
 var H = XH;
 for (var i = 0; i < m; i++) {
 H[i]=[];
 for (var j = 0; j < n; j++) {
 if (i >= j) {
 H[i][j] = QR[i][j];
 } else {
 H[i][j] = parseFloat(0);
 }
 }
 }
 /** Return the upper triangular factor
 @return R
 */
 var XR = [];
 var R = XR;
 for (var i = 0; i < n; i++) {R[i]=[];
 for (var j = 0; j < n; j++) {
 if (i < j) {
 R[i][j] = QR[i][j];
 } else if (i == j) {
 R[i][j] = Rdiag[i];
 } else {
 R[i][j] = parseFloat(0);
 }
 }
 }
 /** Generate and return the (economy-sized) orthogonal factor
 @return Q
 */
 var XQ = [];
 var Q = XQ; for (var i = 0; i < m; i++) {Q[i]=[];}
 for (var k = n-1; k >= 0; k--) {
 for (var i = 0; i < m; i++) {
 Q[i][k] = 0.0;
 }
 Q[k][k] = 1.0;
 for (var j = k; j < n; j++) {
 if (QR[k][k] != 0) {
 var s = parseFloat(0);
 for (var i = k; i < m; i++) {
 s=parseFloat(s)+parseFloat(QR[i][k]*Q[i][j]);
 }
 s = parseFloat(-s/QR[k][k]);
 for (var i = k; i < m; i++) {
 Q[i][j] = Q[i][j]+s*QR[i][k];
 }
 }
 }
 }
if(document.getElementById("Id_yes_SolveMatrix").checked==true)
{
 /** Least squares solution of A*X = B
 @param B A Matrix with as many rows as A and any number of columns.
 @return X that minimizes the two norm of Q*R*X-B.
 @exception IllegalArgumentException Matrix row dimensions must agree.
 @exception RuntimeException Matrix is rank deficient.
 */
var BB=[]
 for(var ief=0; ief<document.getElementById("id_rowMatrix").value; ief++)
{ BB[ief]=document.getElementById("id_colMatrixB_"+ ief).value;}
 var nx;
nx=1;
var X=BB; 
var Y=[];
var Xsolv=[];
var Qtrans=transposeMatrix(Q);
 for (var k = 0; k < n; k++) {
 var s = parseFloat(0); 
 for (var i = 0; i < m; i++) {
 s = parseFloat(s)+parseFloat(Qtrans[k][i]*X[i]);
 }Y[k]=s;
 }
 for (var k = n-1; k >= 0; k--) {
 Xsolv[k] = Y[k]/parseFloat(Rdiag[k]);
 for (var i = 0; i < k; i++) {
 Y[i]=parseFloat(Y[i])-parseFloat(Xsolv[k]*R[i][k]);
 }
 }
}
var htmlTableMatrix='';
htmlTableMatrix+='<a>Q</a><br><table>';
 for(var i=0; i<Q.length; i++){
 htmlTableMatrix+='<tr>';
 for(var j=0; j<Q[0].length; j++){
htmlTableMatrix+='<td style="color: #082567"><font size=2>'+Q[i][j]+'</font></td>';
 }
htmlTableMatrix+='</tr>';
 } 
htmlTableMatrix+='</table><a> .</a><br>';
htmlTableMatrix+='<a>R</a><br><table>';
 for(var i=0; i<R.length; i++){
 htmlTableMatrix+='<tr>';
 for(var j=0; j<R[0].length; j++){
 htmlTableMatrix+='<td style="color: #082567"><font size=2>'+R[i][j]+'</font></td>';
 }
htmlTableMatrix+='</tr>';
 } 
htmlTableMatrix+='</table><br>';
if(!document.getElementById("divMatrixColRowBox2"))
 { var tdiv=document.createElement('div');
tdiv.id="divMatrixColRowBox2";
tdiv.innerHTML=htmlTableMatrix;
document.getElementById("Place_Matrix").appendChild(tdiv);}
else{document.getElementById("divMatrixColRowBox2").innerHTML=htmlTableMatrix;}
if(document.getElementById("Id_yes_SolveMatrix").checked==true)
{
var htmlTableMatrix=''; 
htmlTableMatrix+='<a>Solution (roots of the equations)</a><br><table>';
 for(var i=0; i<Xsolv.length; i++){
 htmlTableMatrix+='<tr>';
 htmlTableMatrix+='<td style="color: #082567"><font size=2>X'+parseInt(i+1)+'='+Xsolv[i]+'</font></td>';
 htmlTableMatrix+='</tr>';
 } 
htmlTableMatrix+='</table><a> .</a><br>';
if(!document.getElementById("divMatrixColRowBox2"))
 { var tdiv=document.createElement('div');
tdiv.id="divMatrixColRowBox2";
tdiv.innerHTML=htmlTableMatrix;
document.getElementById("Place_Matrix").appendChild(tdiv);}
else{document.getElementById("divMatrixColRowBox2").innerHTML=htmlTableMatrix;}
}
 }
if((document.getElementById("Id_yes_SVDMatrix")&&document.getElementById("Id_yes_SVDMatrix").checked==true) || (document.getElementById("SSALayerField"))&&document.getElementById("SSALayerField").value!=0)
 {
 /** Construct the singular value decomposition
 @param Arg Rectangular matrix
 @param thin If true U is economy sized
 @param wantu If true generate the U matrix
 @param wantv If true generate the V matrix
 @return Structure to access U, S and V.
 */
var A; var ArrForLayer; var AA; var Aishod;newArrayAggregOrNo=[];
if(document.getElementById("Id_AggregSumKvadr")&&document.getElementById("Id_AggregSumKvadr").checked==true&&document.getElementById("Id_yes_AllKvadr").checked==true)
{
var AllnewArrayAggregOrNo=[]; var newKvadrSeries=[]; var AllnewKvadrSeries=[];var PromAllnewArrayAggregOrNo=[]
for (var ii=1;ii<document.getElementById("sumNumber_idKvadr").length;ii++)
{
var s=document.getElementById("sumNumber_idKvadr").length;
var kvadr=document.getElementById("sumNumber_idKvadr")[ii].value;
//alert("kvadr "+kvadr);
rows=document.getElementById("winLength").value
var newLength=0; newKvadrSeries=[]; 
for(var i=0;i<SSALayerMain.features.length;i++)
{if(SSALayerMain.features[i].attributes["NumberKvadr"]==kvadr){newLength++;newKvadrSeries.push(SSALayerMain.features[i]);}}
columns=newLength-rows+1;
var arr = []; 
for(var i=0; i<rows; i++){
 arr[i] = [];
 for(var j=0; j<columns; j++){
if(i==0)
 { arr[i][j] =newKvadrSeries[j].attributes[document.getElementById("SSALayerField").value];}
else
{arr[i][j]=newKvadrSeries[j+i].attributes[document.getElementById("SSALayerField").value];}
 }
 }
 var A=arr ; Aishod=arr;
rtt=A;
//alert("A");
rows=A.length;//m
columns=A[0].length;
AllnewArrayAggregOrNo.push(A);
AllnewKvadrSeries.push(newKvadrSeries);
}
forecastAllkvadr(AllnewArrayAggregOrNo,AllnewKvadrSeries);
//rtt=AllnewArrayAggregOrNo;
//alert("forecastAllkvadr(AllnewArrayAggregOrNo,AllnewKvadrSeries)");
return;
}
if(document.getElementById("Id_AggregSumKvadr")&&document.getElementById("Id_AggregSumKvadr").checked==true&&document.getElementById("sumNumber_idKvadr").value!=0)
{
rows=document.getElementById("winLength").value
var newLength=0; newArrayAggregOrNo=[];
for(var i=0;i<SSALayerMain.features.length;i++)
{if(SSALayerMain.features[i].attributes["NumberKvadr"]==document.getElementById("sumNumber_idKvadr").value){newLength++;newArrayAggregOrNo.push(SSALayerMain.features[i]);}}
columns=newLength-rows+1;
var arr = []; 
for(var i=0; i<rows; i++){
 arr[i] = [];
 for(var j=0; j<columns; j++){
if(i==0)
 { arr[i][j] =newArrayAggregOrNo[j].attributes[document.getElementById("SSALayerField").value];}
else
{arr[i][j]=newArrayAggregOrNo[j+i].attributes[document.getElementById("SSALayerField").value];}
 }
 }
 A=arr ; Aishod=arr;
rows=A.length;//m
columns=A[0].length;
}
 if(!document.getElementById("Id_yes_Matrix")||document.getElementById("Id_yes_Matrix").checked==false)
{if(document.getElementById("Id_AggregSumKvadr")&&document.getElementById("Id_AggregSumKvadr").checked==false){
newArrayAggregOrNo=SSALayerMain.features;
rows=document.getElementById("winLength").value
columns=newArrayAggregOrNo.length-rows+1;
var arr = []; 
for(var i=0; i<rows; i++){
 arr[i] = [];
 for(var j=0; j<columns; j++){
if(i==0)
 { arr[i][j] =newArrayAggregOrNo[j].attributes[document.getElementById("SSALayerField").value];}
else
{arr[i][j]=newArrayAggregOrNo[j+i].attributes[document.getElementById("SSALayerField").value];}
 }
 }
 A=arr ; Aishod=arr;
rows=A.length;//m
columns=A[0].length;
}
}
else
{
 for(var i=0; i<document.getElementById("id_rowMatrix").value; i++){
 arr[i] = [];
 for(var j=0; j<document.getElementById("id_colMatrix").value; j++){
 arr[i][j] =document.getElementById("id_colMatrix_"+i+"_"+j).value;
 }
 }
A= arr;
}
A=Aishod;
 if(document.getElementById("Id_yes_Matrix")&&document.getElementById("Id_yes_Matrix").checked==true)
{A= arr;}
rows=A.length;//m
columns=A[0].length;
var FinalSVD=SVDMatrix(A,columns,rows);
var U=FinalSVD[0];
var S=FinalSVD[1];
var V=FinalSVD[2];
var s=FinalSVD[3];
U=multiplMatixNumber(parseInt(-1),U);
V=multiplMatixNumber(parseInt(-1),V); 
var rowsA = U.length;
var C = new Array(rowsA);
C=multiplyMatrix(U,S);
var transpArray=[];for (var i = 0; i < V[0].length; i++) {transpArray[i]=[]; for(var j=0; j<V.length; j++){transpArray[i][j]=0;}}
for(var i = 0; i < V.length; i++)
{for(var j = 0; j < V[0].length; j++)
{transpArray[j][i] = V[i][j];}}
var rowsA = C.length;
var CC = new Array(rowsA);
CC=multiplyMatrix(C, transpArray);
var htmlTableMatrix='';
htmlTableMatrix+='<a>U=</a><br><table>';
 for(var i=0; i<U.length; i++){
 htmlTableMatrix+='<tr>';
 for(var j=0; j<U[0].length; j++){
htmlTableMatrix+='<td style="color: #082567"><font size=2>'+U[i][j]+'</font></td>';
 }
htmlTableMatrix+='</tr>';
 } 
htmlTableMatrix+='</table><a> .</a>';
htmlTableMatrix+='<a>S=</a><br><table>';
 for(var i=0; i<S.length; i++){
 htmlTableMatrix+='<tr>';
if(S[0].length)
 { for(var j=0; j<S[0].length; j++){ htmlTableMatrix+='<td><font size=2>'+S[i][j]+'</font></td>'; }}
else
{htmlTableMatrix+='<td><font size=2>'+S[i]+'</font></td>';}
htmlTableMatrix+='</tr>';
 } 
htmlTableMatrix+='</table><br>';
htmlTableMatrix+='<a>V=</a><br><table>';
 for(var i=0; i<V.length; i++){
 htmlTableMatrix+='<tr>';
 for(var j=0; j<V[0].length; j++){
htmlTableMatrix+='<td style="color: #082567"><font size=2>'+V[i][j]+'</font></td>';
 }
htmlTableMatrix+='</tr>';
 } 
htmlTableMatrix+='</table><br>';
htmlTableMatrix+='<a> verify A=U*S*Vtransp</a><br><table>';
 for(var i=0; i<CC.length; i++){
 htmlTableMatrix+='<tr>';
 for(var j=0; j<CC[0].length; j++){
 htmlTableMatrix+='<td style="color: #082567"><font size=2>'+CC[i][j]+'</font></td>';
 }
htmlTableMatrix+='</tr>';
 } 
htmlTableMatrix+='</table><br>';
 if(document.getElementById("Place_Matrix"))
 {
if(!document.getElementById("divMatrixColRowBox2"))
 { var tdiv=document.createElement('div');
tdiv.id="divMatrixColRowBox2";
tdiv.innerHTML=htmlTableMatrix;
document.getElementById("Place_Matrix").appendChild(tdiv);}
else{document.getElementById("divMatrixColRowBox2").innerHTML=htmlTableMatrix;}
 }
 else
 {
rows=document.getElementById("winLength").value
columns=newArrayAggregOrNo.length-rows+1;
var ArrForLayer= []; 
for(var i=0; i<rows; i++){
 ArrForLayer[i] = [];
 for(var j=0; j<columns; j++){
if(i==0)
 { ArrForLayer[i][j] =newArrayAggregOrNo[j].attributes[document.getElementById("SSALayerField").value];}
else
{ ArrForLayer[i][j]=newArrayAggregOrNo[j+i].attributes[document.getElementById("SSALayerField").value];}
 }
 }
var htmlTableMatrix0='';
htmlTableMatrix0+='<a>A=</a><br><table>';
 for(var i=0; i<ArrForLayer.length; i++){
 htmlTableMatrix0+='<tr>';
 for(var j=0; j<ArrForLayer[0].length; j++){
 htmlTableMatrix0+='<td><font size=2>'+ArrForLayer[i][j]+'</font></td>';
 }
htmlTableMatrix0+='</tr>';
 } 
htmlTableMatrix0+='</table><br>';
var At=transposeMatrix(ArrForLayer);
var AA= multiplyMatrix(ArrForLayer,At);
htmlTableMatrix0+='<a>A=A*Atrasponse</a><br><table>';
 for(var i=0; i<AA.length; i++){
 htmlTableMatrix0+='<tr>';
 for(var j=0; j<AA[0].length; j++){
 htmlTableMatrix0+='<td><font size=2>'+AA[i][j]+'</font></td>';
 }
htmlTableMatrix0+='</tr>';
 } 
htmlTableMatrix0+='</table><br>';
htmlTableMatrix0+=htmlTableMatrix;
var tempMat=[]; var Xmat=[];
var CountS;
if(U[s.length-1]){CountS=s.length}else{CountS=s.length-1}
 for(var i=0; i<CountS; i++)
{
var tempMaTi=[]
var Vi=new Array(V.length);
for(var a=0;a<V.length;a++){Vi[a]=0;}
for(var ii=0;ii<V[i].length;ii++)
{Vi[ii]=V[ii][i];}
var Ui=new Array(U.length);
for(var a=0;a<U.length;a++){Ui[a]=0;}
for(var ii=0;ii<U[i].length;ii++)
{Ui[ii]=U[ii][i];}
var tempMaTi=multiplyMatrix(multiplMatixNumber(s[i],Ui),transposeMatrix(Vi))
tempMat.push(tempMaTi);
}
var Xmat=[];
for(var i=0; i<tempMat.length; i++)
{ 
if(i==0){Xmat=sumMatrix(tempMat[i],tempMat[i+1]);}
else{if(tempMat[i+1]){Xmat=sumMatrix(Xmat,tempMat[i+1])};}
}
rtt=Xmat;
htmlTableMatrix1='';
htmlTableMatrix1+='<a>X=Sum(si*Ui*Vi_trans)</a><br><table>';
 for(var i=0; i<Xmat.length; i++){
 htmlTableMatrix1+='<tr>';
 for(var j=0; j<Xmat[0].length; j++){
 htmlTableMatrix1+='<td><font size=2>'+Xmat[i][j]+'</font></td>';
 }
htmlTableMatrix1+='</tr>';
 } 
htmlTableMatrix1+='</table><br>';
htmlTableMatrix0+=htmlTableMatrix1;
 var myWinSSA= open("", "displayWindow",
 "width=400,height=300,status=yes,toolbar=yes,menubar=no,scrollbars=yes");
 myWinSSA.document.open();
 myWinSSA.document.write("<html><head><title>SVD");
 myWinSSA.document.write("</title>");
 myWinSSA.document.write("</head><body>");
 myWinSSA.document.write("<div id=id_WindowDivSSA></div>");
 myWinSSA.document.write("</body></html>");
 myWinSSA.document.close(); 
 var tdiv=document.createElement('div');
tdiv.id="divMatrixColRowBox2Window";
tdiv.innerHTML=htmlTableMatrix0;
 myWinSSA.document.getElementById("id_WindowDivSSA").appendChild(tdiv);
 var myWinSSA2= open("", "_blank",
 "width=400,height=300,status=yes,toolbar=yes,menubar=no,scrollbars=yes");
 myWinSSA2.document.open();
 myWinSSA2.document.write("<html><head><title>SVD_chart_Eigen_functions");
 myWinSSA2.document.write("</title>");
 myWinSSA2.document.write("</head><body>");
var strChart="<div id=id_WindowDivSSAchart><canvas id=chartSVDcanMain width='1000' height='440'></canvas><br><canvas id=chartSVDcan width='1000' height='440'>"+
"<p>You browser do not have canvas</p></canvas><br></div>";
 myWinSSA2.document.write(strChart);
 myWinSSA2.document.write("</body></html>");
 myWinSSA2.document.close(); 
var myWinSSA3= open("", "_blank",
 "width=400,height=300,status=yes,toolbar=yes,menubar=no,scrollbars=yes");
 myWinSSA3.document.open();
 myWinSSA3.document.write("<html><head><title>SVD_chart_Principal_Component");
 myWinSSA3.document.write("</title>");
 myWinSSA3.document.write("</head><body>");
var strChart="<div id=id_WindowDivSSAchart3></div>";
 myWinSSA3.document.write(strChart);
 myWinSSA3.document.write("</body></html>");
 myWinSSA3.document.close(); 
var CountBrChart=0;
for(var ttt=0; ttt<U.length;ttt++)
{var tdivBr=document.createElement('br');
 var tdiv=document.createElement('canvas');
CountBrChart=CountBrChart+1;
if(CountBrChart==2)
{myWinSSA2.document.getElementById("id_WindowDivSSAchart").appendChild(tdivBr);}
if(CountBrChart==2){CountBrChart=0;}
tdiv.id="chartSVDcan_"+ttt;
tdiv.width=480;
tdiv.height=220;
myWinSSA2.document.getElementById("id_WindowDivSSAchart").appendChild(tdiv);
}
var CountBrChart=0;
for(var ttt=0; ttt<V.length;ttt++)
{var tdivBr=document.createElement('br');
 var tdiv=document.createElement('canvas');
CountBrChart=CountBrChart+1;
if(CountBrChart==2)
{/*myWinSSA3.document.getElementById("id_WindowDivSSAchart3").appendChild(tdivBr);*/}
if(CountBrChart==2){CountBrChart=0;}
tdiv.id="chartSVDcan_"+ttt;
tdiv.width=480;
tdiv.height=220;
myWinSSA3.document.getElementById("id_WindowDivSSAchart3").appendChild(tdiv);
}
 var drawingCanvas0 = myWinSSA2.document.getElementById('chartSVDcanMain');
var context = drawingCanvas0.getContext('2d');
context.lineWidth = 1.5;
 context.lineCap = 'butt';
 context.beginPath();
 context.moveTo(30, 0);
 context.lineTo(30, 420);
 context.lineWidth = 1.5;
 context.lineTo(1000, 420);
 context.stroke();
 var minDistC = parseFloat(newArrayAggregOrNo[0].attributes[document.getElementById("SSALayerField").value]);
 var maxDistC = parseFloat(minDistC) ;
 for (ia = 1; ia < newArrayAggregOrNo.length; ++ia) { var NumSS=newArrayAggregOrNo[ia].attributes[document.getElementById("SSALayerField").value];
 if (NumSS>parseFloat(maxDistC) ) maxDistC = parseFloat(NumSS);
 if( NumSS<parseFloat(minDistC) ) minDistC = parseFloat(NumSS);
 }
var cenDel=(maxDistC-minDistC)/(myWinSSA2.document.getElementById('chartSVDcanMain').height-20);
context.font = "bold 8px sans-serif";
context.textAlign = "right";
context.textBaseline = "bottom";
var YtextP1=(maxDistC-minDistC)/10
for( var Yt=0;Yt<=11;Yt++){YtextP=(maxDistC-(minDistC+(YtextP1*Yt)))/cenDel
context.fillText((minDistC+(YtextP1*Yt)).toFixed(2), 30,YtextP+11);context.lineWidth=1;context.beginPath();context.moveTo(20,YtextP);context.lineTo(35,YtextP);context.stroke();}
var Xa=0
for(var i=0; i<newArrayAggregOrNo.length; i++)
{context.font = "bold 8px sans-serif";
context.textAlign = "right";
context.textBaseline = "bottom";
var AxY=myWinSSA2.document.getElementById('chartSVDcanMain').height-10;
var LenX=(myWinSSA2.document.getElementById('chartSVDcanMain').width-30)/newArrayAggregOrNo.length;
Xa=Xa+1; 
if(Xa==0||Xa==4||i==newArrayAggregOrNo.length-1)
{var fiel=document.getElementById("SSAXField").value;var fiel2=document.getElementById("SSAXField2").value;
if(document.getElementById("SSAXField").value==0){context.fillText(i+1, LenX*i+30, AxY);}else{context.fillText(newArrayAggregOrNo[i].attributes[fiel], LenX*i+30, AxY);}
if(document.getElementById("SSAXField2").value==0){}
else{context.fillText(newArrayAggregOrNo[i].attributes[fiel2], LenX*i+30, AxY+6);}}

if(Xa==4){Xa=0;}
context.lineWidth = 1;
context.beginPath()
context.moveTo(LenX*i+30, myWinSSA2.document.getElementById('chartSVDcanMain').height-20);
context.lineTo(LenX*i+30, myWinSSA2.document.getElementById('chartSVDcanMain').height-24);context.stroke();}
for(var h=0; h<newArrayAggregOrNo.length;h++)
{ var ad=newArrayAggregOrNo[h].attributes[document.getElementById("SSALayerField").value];
 if(newArrayAggregOrNo[h+1]){ var ad2=newArrayAggregOrNo[h+1].attributes[document.getElementById("SSALayerField").value];}
 var NumberChart=(maxDistC-ad)/parseFloat(cenDel);
 context.fillRect(LenX*h+30, NumberChart, 3, 3);context.lineWidth =1;context.beginPath();context.moveTo(LenX*h+30, NumberChart);if(ad2||ad2==0){var 
NumberChart2=(parseFloat(maxDistC)-parseFloat(ad2))/parseFloat(cenDel);context.lineTo(LenX*(h+1)+30, NumberChart2);context.stroke();}}
 var drawingCanvas = myWinSSA2.document.getElementById('chartSVDcan');
if(drawingCanvas && drawingCanvas.getContext) {
 var context = drawingCanvas.getContext('2d');
 context.lineWidth = 2;
 context.lineCap = 'butt';
 context.moveTo(30, 0);
 context.lineTo(30, 400);
context.lineWidth = 2;
context.lineTo(1000, 400);
 context.stroke();
var minDistC = parseFloat(Math.log(s[0]));
 var maxDistC = parseFloat(minDistC) ;
 for (ia = 1; ia < s.length; ++ia) { if(s[ia]==0){var NumSS=0}else{var NumSS= parseFloat(Math.log(s[ia]));}
 if (NumSS> parseFloat(maxDistC) ) maxDistC = parseFloat(NumSS);
 if( NumSS<parseFloat(minDistC) ) minDistC =parseFloat(NumSS);
 }
var LenX=(myWinSSA2.document.getElementById('chartSVDcan').width-30)/s.length;
Yp=minDistC;Yp2=maxDistC;
var YtextP2=(Yp2-Yp)/10;
var cenDel=(Yp2-Yp)/(myWinSSA2.document.getElementById('chartSVDcan').height-40);
for(var i=0; i<s.length-1; i++)
{ad=Math.log(s[i]);
 var NumberChart=(Yp2-ad)/parseFloat(cenDel);
context.fillRect(LenX*i+30, NumberChart, 3, 3);
context.lineWidth = 2;
context.beginPath();
context.moveTo(LenX*i+30, NumberChart);
if(s[i+1])
{context.lineWidth = 1;
ad=Math.log(s[i+1]);
 var NumberChart2=(Yp2-ad)/parseFloat(cenDel);

context.lineTo(LenX*(i+1)+30, NumberChart2);context.stroke();}
context.lineWidth = 1;
context.moveTo(LenX*i+30, 400);
context.lineTo(LenX*i+30, 390);
context.stroke();
context.font = "bold 9px sans-serif";
context.textAlign = "right";
context.textBaseline = "bottom";
context.font = "9px sans-serif";
context.fillText(i+1, LenX*i+30, 420);
context.font = "11px sans-serif";
context.fillText("logarithm of the eigenvalues", 180, 30);
context.font = "9px sans-serif";
context.lineWidth =1;
for( var Yt=0;Yt<=11;Yt++){var YtextP=(Yp2-(Yp+(YtextP2*Yt)))/cenDel;
context.fillText((Yp+(YtextP2*Yt)).toFixed(3), 25,YtextP+11);context.lineWidth=1;context.beginPath();context.moveTo(30,YtextP);context.lineTo(10,YtextP);context.stroke();}
context.font = "8px sans-serif";
context.textAlign = "right";
context.textBaseline = "bottom";
 }
 for(var ttt=0; ttt<U.length;ttt++){
 var drawingCanvas = myWinSSA2.document.getElementById('chartSVDcan_'+ttt);
 if(drawingCanvas && drawingCanvas.getContext) {
 var context = drawingCanvas.getContext('2d');
 context.lineWidth = 1.5;
 context.lineCap = 'butt';
 context.beginPath();
 context.moveTo(60, 0);
 context.lineTo(60, 200);
 context.lineWidth = 1.5;var widthC=myWinSSA2.document.getElementById('chartSVDcan_'+ttt).width;
 context.lineTo(widthC, 200);
 context.stroke();
 var minDistC = parseFloat(U[0][ttt]);
 var maxDistC = parseFloat(minDistC) ;
 for (ia = 1; ia < U.length; ++ia) { var NumSS= parseFloat(U[ia][ttt]);
 if (NumSS> parseFloat(maxDistC) ) maxDistC = parseFloat(NumSS);
 if( NumSS<parseFloat(minDistC) ) minDistC =parseFloat(NumSS);
 }
var cenDel=(maxDistC-minDistC)/(myWinSSA2.document.getElementById('chartSVDcan_'+ttt).height-20);
var LenX=(myWinSSA2.document.getElementById('chartSVDcan_'+ttt).width-60)/U.length;
var SumS=0;//s.length
for(var sii=0;sii<3;sii++){SumS=SumS+s[sii];}
var ProcSumS=(s[ttt]*100)/SumS;
ProcSumS=ProcSumS.toFixed(2);
context.font = "bold 11px sans-serif";
context.textAlign = "right";
context.textBaseline = "bottom";
context.fillText(parseInt(ttt+1)+","+ProcSumS,40,20);
context.font = "bold 8px sans-serif";
context.textAlign = "right";
context.textBaseline = "bottom";
var YtextP1=(maxDistC-minDistC)/10
for( var Yt=0;Yt<=11;Yt++){YtextP=(maxDistC-(minDistC+(YtextP1*Yt)))/cenDel
context.fillText((minDistC+(YtextP1*Yt)).toFixed(3), 60,YtextP+11);context.lineWidth=1;context.beginPath();context.moveTo(50,YtextP);context.lineTo(65,YtextP);context.stroke();}
var Xa=0
for(var iu=0; iu<U.length; iu++)
{context.font = "bold 8px sans-serif";
context.textAlign = "right";
context.textBaseline = "bottom";
var AxY=myWinSSA2.document.getElementById('chartSVDcan_'+ttt).height-10;
Xa=Xa+1;
if(Xa==0||Xa==4||iu==U.length-1)
{context.fillText(iu+1, LenX*iu+60, AxY);}
if(Xa==4){Xa=0;}
context.lineWidth = 1;
context.beginPath()
context.moveTo(LenX*iu+60, myWinSSA2.document.getElementById('chartSVDcan_'+ttt).height-20);
context.lineTo(LenX*iu+60, myWinSSA2.document.getElementById('chartSVDcan_'+ttt).height-25);
context.stroke();}
var mapHtml2='<map name="MapChartForeAnTable_'+ttt+'">';
 for(var h=0; h<U.length; h++)
 { 
 var ad= U[h][ttt];
 if(U[h+1]){ var ad2= U[h+1][ttt];}
 var NumberChart=(maxDistC-ad)/parseFloat(cenDel);
 context.fillRect(LenX*h+60, NumberChart, 3, 3);context.lineWidth =1;context.beginPath();context.moveTo(LenX*h+60, NumberChart);
mapHtml2+='<area coords="'+parseFloat(LenX*h+60)+','+NumberChart+',4" shape="circle" title="'+' y'+': '+ad+'">';
if(ad2||ad2==0){var NumberChart2=(parseFloat(maxDistC)-parseFloat(ad2))/parseFloat(cenDel);context.lineTo(LenX*(h+1)+60, NumberChart2);context.stroke();} 
 }
 }//end canvas chartSVDcan_ttt
mapHtml2+='</map>';
var strDataURI = drawingCanvas.toDataURL();
var NewMapChartImage=this.document.createElement('div');
NewMapChartImage.id='id_NewMapChartImage_'+ttt;
NewMapChartImage.innerHTML=mapHtml2;
myWinSSA2.document.getElementById('id_WindowDivSSAchart').appendChild(NewMapChartImage);
var NewChartImage=this.document.createElement('img');
 NewChartImage.id='id_ NewChartImage_'+ttt;
NewChartImage.style.cssFloat="left";
NewChartImage.src=strDataURI;
NewChartImage.setAttribute("usemap", '#MapChartForeAnTable_'+ttt);
if(myWinSSA2.document.getElementById('chartSVDcan_'+ttt))
{myWinSSA2.document.getElementById('chartSVDcan_'+ttt).parentNode.removeChild(myWinSSA2.document.getElementById('chartSVDcan_'+ttt));}

myWinSSA2.document.getElementById('id_WindowDivSSAchart').appendChild(NewChartImage);
 }//end for(var ttt=0; ttt<U.length;ttt++)
 for(var ttt=0; ttt<V.length;ttt++){
 var drawingCanvas = myWinSSA3.document.getElementById('chartSVDcan_'+ttt);
 if(drawingCanvas && drawingCanvas.getContext) {
 var context = drawingCanvas.getContext('2d');
 context.lineWidth = 1.5;
 context.lineCap = 'butt';
 context.beginPath();
 context.moveTo(60, 0);
 context.lineTo(60, 200);
 context.lineWidth = 1.5;var widthC=myWinSSA3.document.getElementById('chartSVDcan_'+ttt).width;
 context.lineTo(widthC, 200);
 context.stroke();
 var minDistC = parseFloat(V[0][ttt]);
 var maxDistC = parseFloat(minDistC) ;
 for (ia = 1; ia < V.length; ++ia) { var NumSS= parseFloat(V[ia][ttt]);
 if (NumSS> parseFloat(maxDistC) ) maxDistC = parseFloat(NumSS);
 if( NumSS<parseFloat(minDistC) ) minDistC =parseFloat(NumSS);
 }
var cenDel=(maxDistC-minDistC)/(myWinSSA3.document.getElementById('chartSVDcan_'+ttt).height-20);
var LenX=(myWinSSA3.document.getElementById('chartSVDcan_'+ttt).width-60)/V.length;
var SumS=0;

context.font = "bold 8px sans-serif";
context.textAlign = "right";
context.textBaseline = "bottom";
var YtextP1=(maxDistC-minDistC)/10
for( var Yt=0;Yt<=11;Yt++){YtextP=(maxDistC-(minDistC+(YtextP1*Yt)))/cenDel
context.fillText((minDistC+(YtextP1*Yt)).toFixed(3), 60,YtextP+11);context.lineWidth=1;context.beginPath();context.moveTo(50,YtextP);context.lineTo(65,YtextP);context.stroke();}
var Xa=0
for(var iu=0; iu<V.length; iu++)
{context.font = "bold 8px sans-serif";
context.textAlign = "right";
context.textBaseline = "bottom";
var AxY=myWinSSA3.document.getElementById('chartSVDcan_'+ttt).height-10;
Xa=Xa+1;
if(Xa==0||Xa==4||iu==V.length-1)
{context.fillText(iu+1, LenX*iu+60, AxY);}
if(Xa==4){Xa=0;}
context.lineWidth = 1;
context.beginPath()
context.moveTo(LenX*iu+60, myWinSSA3.document.getElementById('chartSVDcan_'+ttt).height-20);
context.lineTo(LenX*iu+60, myWinSSA3.document.getElementById('chartSVDcan_'+ttt).height-25);
context.stroke();}
var mapHtml2='<map name="MapChartForeAnTable_'+ttt+'">';
 for(var h=0; h<V.length; h++)
 { 
 var ad= V[h][ttt];
 if(V[h+1]){ var ad2= V[h+1][ttt];}
 var NumberChart=(maxDistC-ad)/parseFloat(cenDel);
 context.fillRect(LenX*h+60, NumberChart, 3, 3);context.lineWidth =1;context.beginPath();context.moveTo(LenX*h+60, NumberChart);
mapHtml2+='<area coords="'+parseFloat(LenX*h+60)+','+NumberChart+',4" shape="circle" title="'+' y'+': '+ad+'">';
if(ad2||ad2==0){var NumberChart2=(parseFloat(maxDistC)-parseFloat(ad2))/parseFloat(cenDel);context.lineTo(LenX*(h+1)+60, NumberChart2);context.stroke();} 
 }
 }//end canvas chartSVDcan_ttt
mapHtml2+='</map>';
var strDataURI = drawingCanvas.toDataURL();
var NewMapChartImage=this.document.createElement('div');
NewMapChartImage.id='id_NewMapChartImage_'+ttt;
NewMapChartImage.innerHTML=mapHtml2;
myWinSSA3.document.getElementById('id_WindowDivSSAchart3').appendChild(NewMapChartImage);
var NewChartImage=this.document.createElement('img');
 NewChartImage.id='id_ NewChartImage_'+ttt;
NewChartImage.style.cssFloat="left";
NewChartImage.src=strDataURI;
NewChartImage.setAttribute("usemap", '#MapChartForeAnTable_'+ttt);
if(myWinSSA3.document.getElementById('chartSVDcan_'+ttt))
{myWinSSA3.document.getElementById('chartSVDcan_'+ttt).parentNode.removeChild(myWinSSA3.document.getElementById('chartSVDcan_'+ttt));}

myWinSSA3.document.getElementById('id_WindowDivSSAchart3').appendChild(NewChartImage);
 }//end for(var ttt=0; ttt<V.length;ttt++)
 }
 }
if(document.getElementById("PrincCompPopup")){document.getElementById("PrincCompPopup").innerHTML='';
var tdiv=document.createElement('div');
tdiv.id="divComposeSerialsPC";
document.getElementById("PrincCompPopup").appendChild(tdiv);
var tdiv=document.createElement('div');
tdiv.id="divComposeSerialsFunction";
tdiv.innerHTML='<p> <button id=buttonComposeSSA type=button><a><font size=2>Composition series</font></button></p>'+
'<p> <button id=buttonForecastSSA type=button><a><font size=2>Forecast series</font></button><input type="text" size="5" id="id_LengthForecast" value="1"/>insert forecat length<br>'+
'<a>Use Trend principal components:</a><input type="checkbox" id="Id_checkForecastTrend" value="checkbox"/>'+
'<a>Use Harmonic principal components:</a><input type="checkbox" id="Id_checkForecastHarmon" value="checkbox"/><br>'+
'<input type="text" size="5" id="id_LengthBaseForecast" title="insert new start point or default will be from first number of the series" value="from start series"/>insert start point<br></p>';
document.getElementById("PrincCompPopup").appendChild(tdiv);
document.getElementById("buttonComposeSSA").onclick=function(){Compose_SSA(A,U,s,V);}
document.getElementById("buttonForecastSSA").onclick=function(){Forecast_SSA(A,U,s,V);}
for( var kk=0;kk<U.length; kk++)
{
var tdiv=document.createElement('input');
tdiv.id="divComposeSerials_"+parseInt(kk+1);
tdiv.type='checkbox';
tdiv.title='Главная компонента'
var tdiv2=document.createElement('a');
tdiv2.innerHTML='ГК'+parseInt(kk+1);
document.getElementById("divComposeSerialsPC").appendChild(tdiv2);
document.getElementById("divComposeSerialsPC").appendChild(tdiv);
}
var tdiv=document.createElement('div');
tdiv.id="divComposeSerials1";
tdiv.innerHTML='<p> <button type=button onclick=Trend_SSA()><a><font size=2>add to trend</font></button></p>';
document.getElementById("PrincCompPopup").appendChild(tdiv);
var tdiv=document.createElement('div');
tdiv.id="divAddTrendonInitial";
tdiv.innerHTML='<input type="checkbox" id="Id_divAddTrendonInitial" value="checkbox"/>Add trend on Initial series chart<br>';
document.getElementById("PrincCompPopup").appendChild(tdiv);
var tdiv=document.createElement('div');
tdiv.id="divComposeSerials2";
tdiv.innerHTML='<p> <button type=button onclick=Harmonic_SSA()><a><font size=2>add to harmonic</font></button></p>';
document.getElementById("PrincCompPopup").appendChild(tdiv);
var tdiv=document.createElement('div');
tdiv.id="divAddHarmononInitial";
tdiv.innerHTML='<input type="checkbox" id="Id_divAddHarmononInitial" value="checkbox"/>Add harmonic on Initial series chart<br>';
document.getElementById("PrincCompPopup").appendChild(tdiv);
/*popupSSAStart2.setSize(new OpenLayers.Size(500,400))*/;
 }
 }
}
function Trend_SSA()
{
document.getElementById("divComposeSerials1").innerHTML='<p> <button type=button onclick=Trend_SSA()><a><font size=2>add to trend</font></button></p>';
for (var i=0;i<document.getElementById("divComposeSerialsPC").childNodes.length;i++)
{ var elemTr=document.getElementById("divComposeSerialsPC").childNodes[i];
 if(elemTr.type=='checkbox'&&elemTr.checked==true)
 { var tdiv2=document.createElement('a');
 tdiv2.innerHTML='ГК'+parseInt(((i-1)/2)+1);
 document.getElementById("divComposeSerials1").appendChild(tdiv2);
 var tdiv=document.createElement('input');
 tdiv.id="divComposeSerialsTr_"+parseInt(((i-1)/2)+1);
 tdiv.type='checkbox';document.getElementById("divComposeSerials1").appendChild(tdiv);
 }
}
}
function Harmonic_SSA()
{
document.getElementById("divComposeSerials2").innerHTML='<p> <button type=button onclick=Harmonic_SSA()><a><font size=2>add to harmonic</font></button></p>';
for (var i=0;i<document.getElementById("divComposeSerialsPC").childNodes.length;i++)
{ var elemTr=document.getElementById("divComposeSerialsPC").childNodes[i];
 if(elemTr.type=='checkbox'&&elemTr.checked==true)
 { var tdiv2=document.createElement('a');
 tdiv2.innerHTML='ГК'+parseInt(((i-1)/2)+1);
 document.getElementById("divComposeSerials2").appendChild(tdiv2);
 var tdiv=document.createElement('input');
 tdiv.id="divComposeSerialsTr_"+parseInt(((i-1)/2)+1);
 tdiv.type='checkbox';document.getElementById("divComposeSerials2").appendChild(tdiv);
 }
}
}
function Determinant(A) 
{ 
 var N = A.length, B = [], denom = 1, exchanges = 0;
 for (var i=0; i<N; ++i)
 { B[i] = [];
 for (var j=0; j<N; ++j) B[i][j] = A[i][j];
 }
 for (var i=0; i<N-1; ++i)
 { var maxN = i, maxValue = Math.abs(B[i][i]);
 for (var j=i+1; j<N; ++j)
 { var value = Math.abs(B[j][i]);
 if (value > maxValue){ maxN = j; maxValue = value; }
 }
 if (maxN > i)
 { var temp = B[i]; B[i] = B[maxN]; B[maxN] = temp;
 ++exchanges;
 } else { if (maxValue == 0) return maxValue; }
 var value1 = B[i][i];
 for (var j = i+1; j<N; ++j)
 { var value2 = B[j][i];
 B[j][i] = 0;
 for (var k = i+1; k<N; ++k)
 { B[j][k] = (B[j][k]*value1-B[i][k]*value2)/denom; }
 }
 denom = value1;
 }
 if (exchanges%2) return -B[N-1][N-1];
 else return B[N-1][N-1];
}
function MatrixCofactor(i,j,A) 
{ 
 var N = A.length, sign = ((i+j)%2==0) ? 1 : -1;
 for (var m=0; m<N; m++)
 { for (var n=j+1; n<N; n++) A[m][n-1] = A[m][n];
 A[m].length--;
 }
 for (var k=(i+1); k<N; k++) A[k-1] = A[k];
 A.length--;
 return sign*Determinant(A);
}
function AdjugateMatrix(A) 
{ 
 var N = A.length, B = [], adjA = [];
 for (var i=0; i<N; i++)
 { adjA[i] = []; 
 for (var j=0; j<N; j++)
 { for (var m=0; m<N; m++)
 { B[m] = [];
 for (var n=0; n<N; n++) B[m][n] = A[m][n];
 }
 adjA[i][j] = MatrixCofactor(j,i,B);
 }
 }
 return adjA;
}
function InverseMatrix(A) 
{ 
var InversMatrix;
 if (Determinant(A)!=0)
{
var ObrDeterm=parseFloat(1/Determinant(A));
InversMatrix=multiplMatixNumber(ObrDeterm,AdjugateMatrix(A));
}
 else 
 { var res = alert('Матрица необратимая, так как её определитель равен нулю.');}
 return InversMatrix;
} 
function ForecastTrendSSA1(A,U,s,V)
{
var tempMat=[]; var Xmat=[];
if(document.getElementById("Id_checkForecastTrend").checked==true)
{for (var ie=0;ie<document.getElementById("divComposeSerials1").childNodes.length;ie++)
{ var elemTr=document.getElementById("divComposeSerials1").childNodes[ie];
 if(elemTr.type=='checkbox')
 {
tempMat.push(ComputSumTroiki(U,s,V,elemTr));
 }
 }
 }
 if(document.getElementById("Id_checkForecastHarmon").checked==true)
{for (var ie=0;ie<document.getElementById("divComposeSerials2").childNodes.length;ie++)
{ var elemTr=document.getElementById("divComposeSerials2").childNodes[ie];
 if(elemTr.type=='checkbox')
 {
tempMat.push(ComputSumTroiki(U,s,V,elemTr));
 }
 }
 }
Xmat=[];
for(var i=0; i<tempMat.length; i++)
{ if(tempMat.length==1){Xmat=tempMat[0];}
 else
{if(i==0){Xmat=sumMatrix(tempMat[i],tempMat[i+1]);}
else{if(tempMat[i+1]){Xmat=sumMatrix(Xmat,tempMat[i+1])};}}
}
var SerialArray=[]; var ArraySerialArrays=[];
var SelectedTrendSerial=false;
var SelectedHarmSerial=false;
if(document.getElementById("Id_checkForecastTrend").checked==true)
{for (var ie=0;ie<document.getElementById("divComposeSerials1").childNodes.length;ie++)
{ var elemTr=document.getElementById("divComposeSerials1").childNodes[ie];
 if(elemTr.type=='checkbox')
 {SelectedTrendSerial=true}
 }}
 if(document.getElementById("Id_checkForecastHarmon").checked==true)
{for (var ie=0;ie<document.getElementById("divComposeSerials2").childNodes.length;ie++)
{ var elemTr=document.getElementById("divComposeSerials2").childNodes[ie];
 if(elemTr.type=='checkbox')
 {SelectedHarmSerial=true}
 }}

var startBaseForecast=parseInt(document.getElementById("id_LengthBaseForecast").value);
var Atemp=[]; var Atemp2=[];
if(startBaseForecast>1){
rows=document.getElementById("winLength").value
columns=startBaseForecast-rows+1;
var arr = []; 
for(var i=0; i<rows; i++){
 arr[i] = [];
 for(var j=0; j<columns; j++){
if(i==0)
 { arr[i][j] =newArrayAggregOrNo[j].attributes[document.getElementById("SSALayerField").value]; }
else
{arr[i][j]=newArrayAggregOrNo[j+i].attributes[document.getElementById("SSALayerField").value];}
 }
 }
Atemp=A;Atemp2=Aishod;
 A=arr ; Aishod=arr;}

 if (SelectedTrendSerial==true)
 { SerialArray=DiagMatrixUsred(A,Xmat);A=Atemp;Aishod=Atemp2;return SerialArray;;}
  if (SelectedHarmSerial==true)
 { SerialArray=DiagMatrixUsred(A,Xmat);A=Atemp;Aishod=Atemp2;return SerialArray;;}

}
function Forecast_SSA(A,U,s,V)
{
var tempVar=0;
var startBaseForecast=parseInt(document.getElementById("id_LengthBaseForecast").value);
var newArrayAggregOrNo2=[]; var tempVar2=0;
if(document.getElementById("Id_checkForecastTrend").checked==true)
{tempVar2=ForecastTrendSSA1(A,U,s,V);}
if(document.getElementById("Id_checkForecastHarmon").checked==true)
{//tempVar2=ForecastHarmonicSSA1(A,U,s,V);
tempVar2=ForecastTrendSSA1(A,U,s,V);}
if(tempVar2!==0)
{tempVar=newArrayAggregOrNo;newArrayAggregOrNo=tempVar2;}
if(startBaseForecast>1)
{
rows=document.getElementById("winLength").value
columns=startBaseForecast-rows+1;
var arr = []; 
for(var i=0; i<rows; i++){
 arr[i] = [];
 for(var j=0; j<columns; j++){
if(i==0)
 { if(tempVar2!==0){arr[i][j] =tempVar2[j];}else{arr[i][j] =newArrayAggregOrNo[j].attributes[document.getElementById("SSALayerField").value]; }}
else
{if(tempVar2!==0){arr[i][j]=tempVar2[j+i];}else{arr[i][j]=newArrayAggregOrNo[j+i].attributes[document.getElementById("SSALayerField").value];}}
 }
 }
 A=arr ; Aishod=arr;
rows=A.length;//m
columns=A[0].length;
var FinalSVD=SVDMatrix(A,columns,rows);
 U=FinalSVD[0];
S=FinalSVD[1];
V=FinalSVD[2];
s=FinalSVD[3];
U=multiplMatixNumber(parseInt(-1),U);
V=multiplMatixNumber(parseInt(-1),V); 
newArrayAggregOrNo2=[];

if(tempVar!==0)
{newArrayAggregOrNo2=[];
for(var ww=0;ww<startBaseForecast-1;ww++)
{newArrayAggregOrNo2.push(tempVar2[ww])}

}
else
{for(var ww=0;ww<startBaseForecast-1;ww++)
{newArrayAggregOrNo2.push(SSALayerMain.features[ww])}
tempVar=newArrayAggregOrNo;newArrayAggregOrNo=newArrayAggregOrNo2;}
}


var ForecastSerial=[];
//alert("ForecastSerial.length "+ForecastSerial.length);
if(tempVar2!==0)
{var varForecastSerial=parseFloat(newArrayAggregOrNo[newArrayAggregOrNo.length-1])}
else
{var varForecastSerial=parseFloat(newArrayAggregOrNo[newArrayAggregOrNo.length-1].attributes[document.getElementById("SSALayerField").value]);}
var u=[];
var Uz=[];
var Qz=[];
var QzTemp;
for(var i=0;i<U.length-1;i++)
 { 
 Uz[i]=[]
 for(var j=0;j<U[i].length-1;j++)
 {Uz[i][j]=(U[i][j]);}
 }
rtt=Uz;
u[0]=[];
for(var i=0;i<U[U.length-1].length-1; i++)
{u[0][i]=U[U.length-1][i];}

PserFinal=parseInt(document.getElementById("id_LengthForecast").value)
var nextForeFore=0;
for(var Pser=0;Pser<PserFinal;Pser++)
{
var countSerialFor=newArrayAggregOrNo.length-U.length+2;
for(var i=0;i<=newArrayAggregOrNo.length-countSerialFor;i++)
 {
var t=parseInt(i+countSerialFor-1)+Pser;
if(newArrayAggregOrNo[t])
{if(tempVar2!==0){Qz[i]=parseFloat(newArrayAggregOrNo[t]);}
else{Qz[i]=parseFloat(newArrayAggregOrNo[t].attributes[document.getElementById("SSALayerField").value]);}
if(i==newArrayAggregOrNo.length-countSerialFor){Qz[i]=varForecastSerial;}}
 }
for(var hj=0;hj<ForecastSerial.length;hj++)
{
if(Qz[Qz.length-1-hj])
{Qz[Qz.length-1-hj]=ForecastSerial[ForecastSerial.length-1-hj]}
}
rtt=Qz;
QzTemp=Qz;
 var InversMultMatrix=InverseMatrix(multiplyMatrix(transposeMatrix(Uz),Uz));
var MatrixProm=multiplyMatrix(u,InversMultMatrix);
var MatrixPredFinal=multiplyMatrix(MatrixProm,transposeMatrix(Uz));
var XfinalFor=multiplyMatrix(MatrixPredFinal,Qz);
varForecastSerial=XfinalFor[0][0];
 ForecastSerial.push(XfinalFor[0][0]);
 }
rtt=ForecastSerial;
if(tempVar==0){}else{newArrayAggregOrNo=tempVar;}
if(tempVar2==0){}else{newArrayAggregOrNo=tempVar;}
//alert("ForecastSerial");
//alert("SerialArrayHarm "+SerialArrayHarm);
var SerialArrayHarm=ForecastSerial;
var myWinSSA4= open("", "_blank",
 "width=400,height=300,status=yes,toolbar=yes,menubar=no,scrollbars=yes");
 myWinSSA4.document.open();
 myWinSSA4.document.write("<html><head><title>Forecasting series");
 myWinSSA4.document.write("</title>");
 myWinSSA4.document.write("</head><body>");
myWinSSA4.document.write("<div id=id_WindowDivSSAchart4><canvas id=chartSVDcanMain4 height='440' width='2000' ></canvas><br></div>");
 myWinSSA4.document.write("</body></html>");
 myWinSSA4.document.close(); 
var mapHtml='<map name="MapChartForeAnTable">';
htmlTableD='';
htmlTableD+='<a>Table</a><br><a>Data:</a><br><table>';
htmlTableD+='<tr align="center" bgcolor="#FFDB73">';htmlTableD+='<td><font size=2>Input Y</font></td>';htmlTableD+='<td><font size=2>Forecast Y</font></td></tr>';
var drawingCanvas0 = myWinSSA4.document.getElementById('chartSVDcanMain4');
var context = drawingCanvas0.getContext('2d');
var drawingCanvas0 = myWinSSA4.document.getElementById('chartSVDcanMain4');
var context = drawingCanvas0.getContext('2d');
var minDistC = parseFloat(newArrayAggregOrNo[0].attributes[document.getElementById("SSALayerField").value]);
 var maxDistC = parseFloat(minDistC) ;
 for (ia = 1; ia < newArrayAggregOrNo.length; ++ia) { 
var NumSS=newArrayAggregOrNo[ia].attributes[document.getElementById("SSALayerField").value];
 if (NumSS>parseFloat(maxDistC) ) maxDistC = parseFloat(NumSS);
 if( NumSS<parseFloat(minDistC) ) minDistC = parseFloat(NumSS);
 }
var minDistC2 = parseFloat(SerialArrayHarm[0]);
 var maxDistC2 = parseFloat(minDistC2) ;
 for (ia = 1; ia < SerialArrayHarm.length; ++ia) { var NumSS2=SerialArrayHarm[ia];
 if (NumSS2>parseFloat(maxDistC2) ) maxDistC2 = parseFloat(NumSS2);
 if( NumSS2<parseFloat(minDistC2) ) minDistC2 = parseFloat(NumSS2);
 }
var cenDel=(maxDistC-minDistC)/(myWinSSA4.document.getElementById('chartSVDcanMain4').height-20);
var OldHeight=myWinSSA4.document.getElementById('chartSVDcanMain4').height;
var NewHeight;
if(minDistC2<0){NewHeight=(maxDistC-minDistC2)/cenDel;} else{NewHeight=(maxDistC-minDistC)/cenDel;}
if(maxDistC2>maxDistC){NewHeight=(maxDistC2-minDistC)/cenDel;}
if(maxDistC2>maxDistC){myWinSSA4.document.getElementById('chartSVDcanMain4').height=NewHeight+20;}
else{myWinSSA4.document.getElementById('chartSVDcanMain4').height=NewHeight+20;}
//if(myWinSSA4.document.getElementById('chartSVDcanMain4').height<=AxY){AxY=NewHeight-10;}

context.lineWidth = 1.5; context.lineCap = 'butt';
 context.beginPath(); context.moveTo(30, 0);
context.lineTo(30, NewHeight); context.lineWidth = 1.5;
if(maxDistC2>maxDistC)
 {context.moveTo(30, NewHeight);
 context.lineTo(1000,NewHeight);}
else{context.moveTo(30, 420);
 context.lineTo(1000,420);
}
 context.stroke();
 var minDistC = parseFloat(newArrayAggregOrNo[0].attributes[document.getElementById("SSALayerField").value]);
 var maxDistC = parseFloat(minDistC) ;
 for (ia = 1; ia < newArrayAggregOrNo.length; ++ia) { 
var NumSS=newArrayAggregOrNo[ia].attributes[document.getElementById("SSALayerField").value];
 if (NumSS>parseFloat(maxDistC) ) maxDistC = parseFloat(NumSS);
 if( NumSS<parseFloat(minDistC) ) minDistC = parseFloat(NumSS);
 }
context.font = "bold 8px sans-serif";
context.textAlign = "right";
context.textBaseline = "bottom";
var YtextP1=(maxDistC-minDistC)/10;
if(maxDistC2>maxDistC){YtextP1=(maxDistC2-minDistC)/10;}
for( var Yt=0;Yt<=11;Yt++){YtextP=(maxDistC-(minDistC+(YtextP1*Yt)))/cenDel; 
 if(maxDistC2>maxDistC)
{ 
YtextP=(maxDistC2-(minDistC+(YtextP1*Yt)))/cenDel;
YtextP=YtextP;
}
context.fillText((minDistC+(YtextP1*Yt)).toFixed(2), 30,YtextP+11);context.lineWidth=1;context.beginPath();context.moveTo(20,YtextP);context.lineTo(35,YtextP);context.stroke();}
var Xa=0
for(var i=0; i<newArrayAggregOrNo.length; i++)
{context.font = "bold 8px sans-serif";
context.textAlign = "right";
context.textBaseline = "bottom";
var AxY=OldHeight-10; if(maxDistC2>maxDistC){AxY=NewHeight+10;}
//rtt=NewHeight;alert("0");rtt=myWinSSA4.document.getElementById('chartSVDcanMain4').height; alert("1"); rtt=AxY;alert("2"); 
var LenX=(myWinSSA4.document.getElementById('chartSVDcanMain4').width-30-1000)/newArrayAggregOrNo.length;
Xa=Xa+1;
if(Xa==0||Xa==4||i==newArrayAggregOrNo.length-1)
{var fiel=document.getElementById("SSAXField").value;var fiel2=document.getElementById("SSAXField2").value;

if(document.getElementById("SSAXField").value==0){context.fillText(i+1, LenX*i+30, AxY);}else{context.fillText(newArrayAggregOrNo[i].attributes[fiel], LenX*i+30, AxY);}
if(document.getElementById("SSAXField2").value==0){}
else{context.fillText(newArrayAggregOrNo[i].attributes[fiel2], LenX*i+30, AxY+6);}}
if(Xa==4){Xa=0;}
context.lineWidth = 1;
context.beginPath()
var NewHeight2=NewHeight-myWinSSA4.document.getElementById('chartSVDcanMain4').height;
if(maxDistC2>maxDistC){context.moveTo(LenX*i+30, NewHeight);context.lineTo(LenX*i+30, NewHeight-4);}
else{context.moveTo(LenX*i+30, OldHeight-20); context.lineTo(LenX*i+30, OldHeight-24);}context.stroke();}
var StartForChartY;var StartForChartX;var StartForChartY2;var StartForChartX2;
var ArrayDopInput=[];
for(var h=0; h<newArrayAggregOrNo.length;h++)
{ var ad=newArrayAggregOrNo[h].attributes[document.getElementById("SSALayerField").value];
 if(newArrayAggregOrNo[h+1]){ var ad2=newArrayAggregOrNo[h+1].attributes[document.getElementById("SSALayerField").value];}
 var NumberChart=(maxDistC-ad)/parseFloat(cenDel); if(maxDistC2>maxDistC){NumberChart=NumberChart+(NewHeight-OldHeight)+20;};if(h==newArrayAggregOrNo.length-1){StartForChartY=NumberChart;StartForChartX=LenX*h+30;};
 context.fillRect(LenX*h+30, NumberChart, 3, 3); var dddsst='';
var fiel=document.getElementById("SSAXField").value;var fiel2=document.getElementById("SSAXField2").value;
if(newArrayAggregOrNo[h].attributes[fiel])
{dddsst+=fiel +" "+newArrayAggregOrNo[h].attributes[fiel]}if(newArrayAggregOrNo[h].attributes[fiel2]){dddsst+=','+fiel2+" "+newArrayAggregOrNo[h].attributes[fiel2];}
mapHtml+='<area coords="'+parseFloat(LenX*h+30)+','+NumberChart+',4" shape="circle" title="'+'Input y'+': '+ad+'; x='+h+' ;'+dddsst+' ">';

if(startBaseForecast>1)
{if(h<startBaseForecast-1){htmlTableD+='<tr align="center" bgcolor="#E5FB71">';htmlTableD+='<td><font size=2>'+ad+'</font></td><td><font size=2></font></td></tr>';}else{ArrayDopInput.push(ad)}}
else{htmlTableD+='<tr align="center" bgcolor="#E5FB71">';
htmlTableD+='<td><font size=2>'+ad+'</font></td><td><font size=2></font></td></tr>';}
context.lineWidth =1;context.beginPath();context.moveTo(LenX*h+30, NumberChart);if(ad2||ad2==0){var NumberChart2=(parseFloat(maxDistC)-parseFloat(ad2))/parseFloat(cenDel);if(maxDistC2>maxDistC){NumberChart2=NumberChart2+(NewHeight-OldHeight)+20;}
context.lineTo(LenX*(h+1)+30, NumberChart2);context.stroke();}
if(startBaseForecast>1&&(h+1)==startBaseForecast)
{StartForChartY2=NumberChart;StartForChartX2=LenX*h+30;}
}
context.lineWidth =2;context.beginPath();context.moveTo(LenX*h+1000, NumberChart);
context.lineTo(LenX*(h+1)+1000, NumberChart2);context.strokeStyle = "#0000ff";context.stroke();
var addValue; if(startBaseForecast>1){addValue=StartForChartX2;}else{addValue=1000}
var indexForeInput=0;
for(var h=0; h<SerialArrayHarm.length;h++)
{ var ad=SerialArrayHarm[h];
 if(SerialArrayHarm[h+1]){ var ad2=SerialArrayHarm[h+1];}
 var NumberChart=(maxDistC-ad)/parseFloat(cenDel);if(maxDistC2>maxDistC){NumberChart=NumberChart+(NewHeight-OldHeight)+20;}
mapHtml+='<area coords="'+parseFloat(LenX*h+addValue)+','+NumberChart+',4" shape="circle" title="'+'forecast y'+': '+ad+'">';
indexForeInput++;
if(ArrayDopInput[h])
{htmlTableD+='<tr align="center" bgcolor="#E5FB71">'
htmlTableD+='<td><font size=2>'+ArrayDopInput[h]+'</font></td><td><font size=2>'+ad+'</font></td></tr>';}
else{
htmlTableD+='<tr align="center" bgcolor="#E5FB71">'
htmlTableD+='<td><font size=2></font></td><td><font size=2>'+ad+'</font></td></tr>';}
 context.fillRect(LenX*h+addValue, NumberChart, 3, 3);context.lineWidth =2;context.beginPath();
context.moveTo(LenX*h+addValue, NumberChart);if(startBaseForecast>1){}else{if(h==0){context.moveTo(StartForChartX,StartForChartY);context.lineTo(LenX*(h)+addValue, NumberChart)}};
if(ad2){var NumberChart2=(maxDistC-ad2)/parseFloat(cenDel);
if(maxDistC2>maxDistC){NumberChart2=NumberChart2+(NewHeight-OldHeight)+20;}
context.lineTo(LenX*(h+1)+addValue, NumberChart2);context.strokeStyle = "#0000ff";context.stroke();}}
if(ArrayDopInput[indexForeInput])
{for(var cnb=indexForeInput;cnb<ArrayDopInput.length;cnb++){htmlTableD+='<tr align="center" bgcolor="#E5FB71">'
htmlTableD+='<td><font size=2>'+ArrayDopInput[cnb]+'</font></td><td><font size=2></font></td></tr>';}}

context.lineWidth = 1.5;
 context.lineCap = 'butt';
 context.beginPath();
 context.lineWidth = 1.5;
if(maxDistC2>maxDistC)
{context.moveTo(30, NewHeight);
 context.lineTo(2000,NewHeight);}
else
{
context.moveTo(30, 420);
 context.lineTo(2000,420);
}
 context.stroke();
var Xa=0
for(var i=0; i<SerialArrayHarm.length; i++)
{context.font = "bold 8px sans-serif";
context.textAlign = "right";
context.textBaseline = "bottom";
var AxY=OldHeight-10;if(maxDistC2>maxDistC){AxY=NewHeight+10;}
var LenX=(myWinSSA4.document.getElementById('chartSVDcanMain4').width-30-1000)/newArrayAggregOrNo.length;
Xa=Xa+1;
if(Xa==0||Xa==4||i==newArrayAggregOrNo.length-1)
{context.fillText(newArrayAggregOrNo.length+i+1, LenX*i+1000, AxY);}
if(Xa==4){Xa=0;}
context.lineWidth = 1;
context.beginPath()
var NewHeight2=NewHeight-myWinSSA4.document.getElementById('chartSVDcanMain4').height;
if(maxDistC2>maxDistC){context.moveTo(LenX*i+1000, NewHeight);context.lineTo(LenX*i+1000, NewHeight-4);}
else{
context.moveTo(LenX*i+1000, OldHeight-20);
context.lineTo(LenX*i+1000, OldHeight-24); }
context.stroke();}
mapHtml+='</map>';
htmlTableD+='</table>';
var strDataURI = drawingCanvas0.toDataURL();
var NewMapChartImage=this.document.createElement('div');
NewMapChartImage.id='id_NewMapChartImage';
NewMapChartImage.innerHTML=mapHtml;
if(myWinSSA4.document.getElementById('id_NewMapChartImage'))
{myWinSSA4.document.getElementById('id_NewMapChartImage').parentNode.removeChild(myWinSSA4.document.getElementById('id_NewMapChartImage'));}
myWinSSA4.document.getElementById('id_WindowDivSSAchart4').appendChild(NewMapChartImage);
var NewChartImage=this.document.createElement('img');
 NewChartImage.id='id_ NewChartImage';
NewChartImage.src=strDataURI;
NewChartImage.setAttribute("usemap", '#MapChartForeAnTable');
if(myWinSSA4.document.getElementById('id_ NewChartImage'))
{myWinSSA4.document.getElementById('id_ NewChartImage').parentNode.removeChild(myWinSSA4.document.getElementById('id_ NewChartImage'));}
myWinSSA4.document.getElementById('id_WindowDivSSAchart4').appendChild(NewChartImage);
var DivTabl=document.createElement('div');
DivTabl.id="ForeInputTable";
DivTabl.innerHTML=htmlTableD;
myWinSSA4.document.getElementById('id_WindowDivSSAchart4').appendChild(DivTabl);
if(myWinSSA4.document.getElementById('chartSVDcanMain4'))
{myWinSSA4.document.getElementById('chartSVDcanMain4').parentNode.removeChild(myWinSSA4.document.getElementById('chartSVDcanMain4'));}

mapHtml='';htmlTableD='';

 }
function Compose_SSA(A,U,s,V)
{
var myWinSSA4= open("", "_blank",
 "width=400,height=300,status=yes,toolbar=yes,menubar=no,scrollbars=yes");
 myWinSSA4.document.open();
 myWinSSA4.document.write("<html><head><title>Composition series");
 myWinSSA4.document.write("</title>");
 myWinSSA4.document.write("</head><body>");
var strChart="<div id=id_WindowDivSSAchart4><canvas id=chartSVDcanMain4 width='1000' height='440'></canvas><br></div>";
 myWinSSA4.document.write(strChart);
 myWinSSA4.document.write("</body></html>");
 myWinSSA4.document.close(); 
var mapHtml='<map name="MapChartForeAnTable">';
var drawingCanvas0 = myWinSSA4.document.getElementById('chartSVDcanMain4');
var context = drawingCanvas0.getContext('2d');
context.lineWidth = 1.5;
 context.lineCap = 'butt';
 context.beginPath();
 context.moveTo(30, 0);
 context.lineTo(30, 420);
 context.lineWidth = 1.5;
 context.lineTo(1000, 420);
 context.stroke();
 var minDistC = parseFloat(newArrayAggregOrNo[0].attributes[document.getElementById("SSALayerField").value]);
 var maxDistC = parseFloat(minDistC) ;
 for (ia = 1; ia < newArrayAggregOrNo.length; ++ia) { var NumSS=newArrayAggregOrNo[ia].attributes[document.getElementById("SSALayerField").value];
 if (NumSS>parseFloat(maxDistC) ) maxDistC = parseFloat(NumSS);
 if( NumSS<parseFloat(minDistC) ) minDistC = parseFloat(NumSS);
 }
var cenDel=(maxDistC-minDistC)/(myWinSSA4.document.getElementById('chartSVDcanMain4').height-20);
context.font = "bold 8px sans-serif";
context.textAlign = "right";
context.textBaseline = "bottom";
var YtextP1=(maxDistC-minDistC)/10
for( var Yt=0;Yt<=11;Yt++){YtextP=(maxDistC-(minDistC+(YtextP1*Yt)))/cenDel
context.fillText((minDistC+(YtextP1*Yt)).toFixed(2), 30,YtextP+11);context.lineWidth=1;context.beginPath();context.moveTo(20,YtextP);context.lineTo(35,YtextP);context.stroke();}
var Xa=0
for(var i=0; i<newArrayAggregOrNo.length; i++)
{context.font = "bold 8px sans-serif";
context.textAlign = "right";
context.textBaseline = "bottom";
var AxY=myWinSSA4.document.getElementById('chartSVDcanMain4').height-10;
var LenX=(myWinSSA4.document.getElementById('chartSVDcanMain4').width-30)/newArrayAggregOrNo.length;
Xa=Xa+1;
if(Xa==0||Xa==4||i==newArrayAggregOrNo.length-1)
{var fiel=document.getElementById("SSAXField").value;var fiel2=document.getElementById("SSAXField2").value;
if(document.getElementById("SSAXField").value==0){context.fillText(i+1, LenX*i+30, AxY);}else{context.fillText(newArrayAggregOrNo[i].attributes[fiel], LenX*i+30, AxY);}
if(document.getElementById("SSAXField2").value==0){}
else{context.fillText(newArrayAggregOrNo[i].attributes[fiel2], LenX*i+30, AxY+6);}}
if(Xa==4){Xa=0;}
context.lineWidth = 1;
context.beginPath()
context.moveTo(LenX*i+30, myWinSSA4.document.getElementById('chartSVDcanMain4').height-20);
context.lineTo(LenX*i+30, myWinSSA4.document.getElementById('chartSVDcanMain4').height-24);context.stroke();}
for(var h=0; h<newArrayAggregOrNo.length;h++)
{ var ad=newArrayAggregOrNo[h].attributes[document.getElementById("SSALayerField").value];
 if(newArrayAggregOrNo[h+1]){ var ad2=newArrayAggregOrNo[h+1].attributes[document.getElementById("SSALayerField").value];}
 var NumberChart=(maxDistC-ad)/parseFloat(cenDel);
 context.fillRect(LenX*h+30, NumberChart, 3, 3);var dddsst='';
var fiel=document.getElementById("SSAXField").value;var fiel2=document.getElementById("SSAXField2").value;
if(newArrayAggregOrNo[h].attributes[fiel])
{dddsst+=fiel +" "+newArrayAggregOrNo[h].attributes[fiel]}if(newArrayAggregOrNo[h].attributes[fiel2]){dddsst+=','+fiel2+" "+newArrayAggregOrNo[h].attributes[fiel2];}
mapHtml+='<area coords="'+parseFloat(LenX*h+30)+','+NumberChart+',4" shape="circle" title="'+'Input y'+': '+ad+'; x='+h+' ;'+dddsst+' ">';
context.lineWidth =1;context.beginPath();context.moveTo(LenX*h+30, NumberChart);if(ad2||ad2==0){var NumberChart2=(parseFloat(maxDistC)-parseFloat(ad2))/parseFloat(cenDel);context.lineTo(LenX*(h+1)+30, NumberChart2);context.stroke();}}
var tempMat=[]; var Xmat=[];
for (var ie=0;ie<document.getElementById("divComposeSerials1").childNodes.length;ie++)
{ var elemTr=document.getElementById("divComposeSerials1").childNodes[ie];
 if(elemTr.type=='checkbox')
 {
tempMat.push(ComputSumTroiki(U,s,V,elemTr));
 }
 }
Xmat=[];
for(var i=0; i<tempMat.length; i++)
{ if(tempMat.length==1){Xmat=tempMat[0];}
 else
{if(i==0){Xmat=sumMatrix(tempMat[i],tempMat[i+1]);}
else{if(tempMat[i+1]){Xmat=sumMatrix(Xmat,tempMat[i+1])};}}
}
 var SerialArray=[]; var ArraySerialArrays=[];
var SelectedTrendSerial=false;
for (var ie=0;ie<document.getElementById("divComposeSerials1").childNodes.length;ie++)
{ var elemTr=document.getElementById("divComposeSerials1").childNodes[ie];
 if(elemTr.type=='checkbox')
 {SelectedTrendSerial=true}
 }
 if (SelectedTrendSerial==true)
 { SerialArray=DiagMatrixUsred(A,Xmat);}
var tempMat=[]; var Xmat=[];
for (var ie=0;ie<document.getElementById("divComposeSerials2").childNodes.length;ie++)
{ var elemTr=document.getElementById("divComposeSerials2").childNodes[ie];
 if(elemTr.type=='checkbox')
 {
tempMat.push(ComputSumTroiki(U,s,V,elemTr));
 }
 }
Xmat=[];
for(var i=0; i<tempMat.length; i++)
{ if(tempMat.length==1){Xmat=tempMat[0];}
 else
{if(i==0){Xmat=sumMatrix(tempMat[i],tempMat[i+1]);}
else{if(tempMat[i+1]){Xmat=sumMatrix(Xmat,tempMat[i+1])};}}
}
 var SerialArrayHarm=[]; var ArraySerialArrays=[]; var SelectedHarmonic=false;
for (var ie=0;ie<document.getElementById("divComposeSerials2").childNodes.length;ie++)
{ var elemTr=document.getElementById("divComposeSerials2").childNodes[ie];
 if(elemTr.type=='checkbox')
 {SelectedHarmonic=true}
 }
 if (SelectedHarmonic==true)
 { SerialArrayHarm=DiagMatrixUsred(A,Xmat);}
if (document.getElementById("Id_divAddHarmononInitial").checked==true&&SelectedHarmonic==true)
{
var drawingCanvas0 = myWinSSA4.document.getElementById('chartSVDcanMain4');
var context = drawingCanvas0.getContext('2d');
var minDistC2 = parseFloat(SerialArrayHarm[0]);
 var maxDistC2 = parseFloat(minDistC2) ;
 for (ia = 1; ia < SerialArrayHarm.length; ++ia) { var NumSS2=SerialArrayHarm[ia];
 if (NumSS2>parseFloat(maxDistC2) ) maxDistC2 = parseFloat(NumSS2);
 if( NumSS2<parseFloat(minDistC2) ) minDistC2 = parseFloat(NumSS2);
 }
if(minDistC2<0)
{var cenDel=(maxDistC-minDistC)/(myWinSSA4.document.getElementById('chartSVDcanMain4').height-20);
var OldHeight=myWinSSA4.document.getElementById('chartSVDcanMain4').height
var NewHeight=(maxDistC-minDistC2)/cenDel;
myWinSSA4.document.getElementById('chartSVDcanMain4').height=NewHeight;
context.lineWidth = 1.5;
 context.lineCap = 'butt';
 context.beginPath();
 context.moveTo(30, 0);
 context.lineTo(30, NewHeight);
 context.lineWidth = 1.5;
context.moveTo(30, 420);
 context.lineTo(1000,420);
 context.stroke();
 var minDistC = parseFloat(newArrayAggregOrNo[0].attributes[document.getElementById("SSALayerField").value]);
 var maxDistC = parseFloat(minDistC) ;
 for (ia = 1; ia < newArrayAggregOrNo.length; ++ia) { var NumSS=newArrayAggregOrNo[ia].attributes[document.getElementById("SSALayerField").value];
 if (NumSS>parseFloat(maxDistC) ) maxDistC = parseFloat(NumSS);
 if( NumSS<parseFloat(minDistC) ) minDistC = parseFloat(NumSS);
 }
context.font = "bold 8px sans-serif";
context.textAlign = "right";
context.textBaseline = "bottom";
var YtextP1=(maxDistC-minDistC)/10
for( var Yt=0;Yt<=11;Yt++){YtextP=(maxDistC-(minDistC+(YtextP1*Yt)))/cenDel
context.fillText((minDistC+(YtextP1*Yt)).toFixed(2), 30,YtextP+11);context.lineWidth=1;context.beginPath();context.moveTo(20,YtextP);context.lineTo(35,YtextP);context.stroke();}
var Xa=0
for(var i=0; i<newArrayAggregOrNo.length; i++)
{context.font = "bold 8px sans-serif";
context.textAlign = "right";
context.textBaseline = "bottom";
var AxY=OldHeight-10;
var LenX=(myWinSSA4.document.getElementById('chartSVDcanMain4').width-30)/newArrayAggregOrNo.length;
Xa=Xa+1;
if(Xa==0||Xa==4||i==newArrayAggregOrNo.length-1)
{var fiel=document.getElementById("SSAXField").value;var fiel2=document.getElementById("SSAXField2").value;
if(document.getElementById("SSAXField").value==0){context.fillText(i+1, LenX*i+30, AxY);}else{context.fillText(newArrayAggregOrNo[i].attributes[fiel], LenX*i+30, AxY);}
if(document.getElementById("SSAXField2").value==0){}
else{context.fillText(newArrayAggregOrNo[i].attributes[fiel2], LenX*i+30, AxY+6);}}
if(Xa==4){Xa=0;}
context.lineWidth = 1;
context.beginPath()
var NewHeight2=NewHeight-myWinSSA4.document.getElementById('chartSVDcanMain4').height;
context.moveTo(LenX*i+30, OldHeight-20);
context.lineTo(LenX*i+30, OldHeight-24);context.stroke();}
for(var h=0; h<newArrayAggregOrNo.length;h++)
{ var ad=newArrayAggregOrNo[h].attributes[document.getElementById("SSALayerField").value];
 if(newArrayAggregOrNo[h+1]){ var ad2=newArrayAggregOrNo[h+1].attributes[document.getElementById("SSALayerField").value];}
 var NumberChart=(maxDistC-ad)/parseFloat(cenDel);
 context.fillRect(LenX*h+30, NumberChart, 3, 3);context.lineWidth =1;context.beginPath();context.moveTo(LenX*h+30, NumberChart);if(ad2||ad2==0){var NumberChart2=(parseFloat(maxDistC)-parseFloat(ad2))/parseFloat(cenDel);context.lineTo(LenX*(h+1)+30, NumberChart2);context.stroke();}}
}
for(var h=0; h<SerialArrayHarm.length;h++)
{ var ad=SerialArrayHarm[h];
 if(SerialArrayHarm[h+1]){ var ad2=SerialArrayHarm[h+1];}
 var NumberChart=(maxDistC-ad)/parseFloat(cenDel);
 context.fillRect(LenX*h+30, NumberChart, 3, 3);
var dddsst='';
var fiel=document.getElementById("SSAXField").value;var fiel2=document.getElementById("SSAXField2").value;
if(newArrayAggregOrNo[h].attributes[fiel])
{dddsst+=fiel +" "+newArrayAggregOrNo[h].attributes[fiel]}if(newArrayAggregOrNo[h].attributes[fiel2]){dddsst+=','+fiel2+" "+newArrayAggregOrNo[h].attributes[fiel2];}
mapHtml+='<area coords="'+parseFloat(LenX*h+30)+','+NumberChart+',4" shape="circle" title="'+'Harmonic y'+': '+ad+'; x='+h+' ;'+dddsst+' ">';

context.lineWidth =2;context.beginPath();context.moveTo(LenX*h+30, NumberChart);if(ad2||ad2==0){var NumberChart2=(parseFloat(maxDistC)-parseFloat(ad2))/parseFloat(cenDel);context.lineTo(LenX*(h+1)+30, NumberChart2);context.strokeStyle = "#0000ff";context.stroke();}}
 }
if (document.getElementById("Id_divAddTrendonInitial").checked==true&&SelectedTrendSerial==true)
 {
var drawingCanvas0 = myWinSSA4.document.getElementById('chartSVDcanMain4');
var context = drawingCanvas0.getContext('2d');
for(var h=0; h<SerialArray.length;h++)
{ var ad=SerialArray[h];
 if(SerialArray[h+1]){ var ad2=SerialArray[h+1];}
 var NumberChart=(maxDistC-ad)/parseFloat(cenDel);
 context.fillRect(LenX*h+30, NumberChart, 3, 3);
var dddsst='';
var fiel=document.getElementById("SSAXField").value;var fiel2=document.getElementById("SSAXField2").value;
if(newArrayAggregOrNo[h].attributes[fiel])
{dddsst+=fiel +" "+newArrayAggregOrNo[h].attributes[fiel]}if(newArrayAggregOrNo[h].attributes[fiel2]){dddsst+=','+fiel2+" "+newArrayAggregOrNo[h].attributes[fiel2];}
mapHtml+='<area coords="'+parseFloat(LenX*h+30)+','+NumberChart+',4" shape="circle" title="'+'Trend y'+': '+ad+'; x='+h+' ;'+dddsst+' ">';
context.lineWidth =2;context.beginPath();context.moveTo(LenX*h+30, NumberChart);if(ad2||ad2==0){var NumberChart2=(parseFloat(maxDistC)-parseFloat(ad2))/parseFloat(cenDel);context.lineTo(LenX*(h+1)+30, NumberChart2);context.strokeStyle = "#0000ff";context.stroke();}}
 }
////////////////////////
mapHtml+='</map>';
var strDataURI = myWinSSA4.document.getElementById('chartSVDcanMain4').toDataURL();
var NewMapChartImage=this.document.createElement('div');
NewMapChartImage.id='id_NewMapChartImage';
NewMapChartImage.innerHTML=mapHtml;
if(myWinSSA4.document.getElementById('id_NewMapChartImage'))
{myWinSSA4.document.getElementById('id_NewMapChartImage').parentNode.removeChild(myWinSSA4.document.getElementById('id_NewMapChartImage'));}
myWinSSA4.document.getElementById('id_WindowDivSSAchart4').appendChild(NewMapChartImage);
var NewChartImage=this.document.createElement('img');
 NewChartImage.id='id_ NewChartImage';
NewChartImage.src=strDataURI;
NewChartImage.setAttribute("usemap", '#MapChartForeAnTable');
if(myWinSSA4.document.getElementById('id_ NewChartImage'))
{myWinSSA4.document.getElementById('id_ NewChartImage').parentNode.removeChild(myWinSSA4.document.getElementById('id_ NewChartImage'));}
myWinSSA4.document.getElementById('id_WindowDivSSAchart4').appendChild(NewChartImage);
if(myWinSSA4.document.getElementById('chartSVDcanMain4'))
{myWinSSA4.document.getElementById('chartSVDcanMain4').parentNode.removeChild(myWinSSA4.document.getElementById('chartSVDcanMain4'));}

/////////////////////////////////////////////
var tdivBr1=document.createElement('br');
var tdivA=document.createElement('a');
 tdivA.innerHTML='Trend';
var tdiv=document.createElement('canvas');
tdiv.id="divCanvasComposeTrendSerials";
tdiv.width=1000;
tdiv.height=440;
myWinSSA4.document.getElementById("id_WindowDivSSAchart4").appendChild(tdivBr1);
myWinSSA4.document.getElementById("id_WindowDivSSAchart4").appendChild(tdivA);
myWinSSA4.document.getElementById("id_WindowDivSSAchart4").appendChild(tdiv);
var drawingCanvas0 = myWinSSA4.document.getElementById('divCanvasComposeTrendSerials');
var type="trend";
CreateChartComposeSerials(myWinSSA4,drawingCanvas0,SerialArray,newArrayAggregOrNo,type);
 if (SelectedHarmonic==true)
 {
var tdivBr1=document.createElement('br');
var tdivA=document.createElement('a');
 tdivA.innerHTML='Harmonic';
var tdiv=document.createElement('canvas');
tdiv.id="divCanvasComposeHarmonicSerials";
tdiv.width=1000;
tdiv.height=440;
myWinSSA4.document.getElementById("id_WindowDivSSAchart4").appendChild(tdivBr1);
myWinSSA4.document.getElementById("id_WindowDivSSAchart4").appendChild(tdivA);
myWinSSA4.document.getElementById("id_WindowDivSSAchart4").appendChild(tdiv);
var drawingCanvas0 = myWinSSA4.document.getElementById('divCanvasComposeHarmonicSerials');
var type="harmonic";
CreateChartComposeSerials(myWinSSA4,drawingCanvas0,SerialArrayHarm,newArrayAggregOrNo,type);
 }
if(myWinSSA4.document.getElementById('divCanvasComposeTrendSerials'))
{myWinSSA4.document.getElementById('divCanvasComposeTrendSerials').parentNode.removeChild(myWinSSA4.document.getElementById('divCanvasComposeTrendSerials'));}
if(myWinSSA4.document.getElementById('divCanvasComposeHarmonicSerials'))
{myWinSSA4.document.getElementById('divCanvasComposeHarmonicSerials').parentNode.removeChild(myWinSSA4.document.getElementById('divCanvasComposeHarmonicSerials'));}
}
function CreateChartComposeSerials(myWinSSA4,drawingCanvas0,SerialArray,newArrayAggregOrNo,type)
{var mapHtml='<map name="MapChartForeAnTable_'+type+'">';
var context = drawingCanvas0.getContext('2d');
context.lineWidth = 1.5;
 context.lineCap = 'butt';
 context.beginPath();
 context.moveTo(30, 0);
 context.lineTo(30, 420);
 context.lineWidth = 1.5;
 context.lineTo(1000, 420);
 context.stroke();
 var minDistC = parseFloat(SerialArray[0]);
 var maxDistC = parseFloat(minDistC) ;
 for (ia = 1; ia < newArrayAggregOrNo.length; ++ia) { var NumSS=SerialArray[ia];
 if (NumSS>parseFloat(maxDistC) ) maxDistC = parseFloat(NumSS);
 if( NumSS<parseFloat(minDistC) ) minDistC = parseFloat(NumSS);
 }
var cenDel=(maxDistC-minDistC)/(myWinSSA4.document.getElementById('divCanvasComposeTrendSerials').height-20);
context.font = "bold 8px sans-serif";
context.textAlign = "right";
context.textBaseline = "bottom";
var YtextP1=(maxDistC-minDistC)/10
for( var Yt=0;Yt<=11;Yt++){YtextP=(maxDistC-(minDistC+(YtextP1*Yt)))/cenDel
context.fillText((minDistC+(YtextP1*Yt)).toFixed(2), 30,YtextP+11);context.lineWidth=1;context.beginPath();context.moveTo(20,YtextP);context.lineTo(35,YtextP);context.stroke();}
var Xa=0
for(var i=0; i<newArrayAggregOrNo.length; i++)
{context.font = "bold 8px sans-serif";
context.textAlign = "right";
context.textBaseline = "bottom";
var AxY=myWinSSA4.document.getElementById('divCanvasComposeTrendSerials').height-10;
var LenX=(myWinSSA4.document.getElementById('divCanvasComposeTrendSerials').width-30)/newArrayAggregOrNo.length;
Xa=Xa+1;
if(Xa==0||Xa==4||i==newArrayAggregOrNo.length-1)
{var fiel=document.getElementById("SSAXField").value;var fiel2=document.getElementById("SSAXField2").value;
if(document.getElementById("SSAXField").value==0){context.fillText(i+1, LenX*i+30, AxY);}else{context.fillText(newArrayAggregOrNo[i].attributes[fiel], LenX*i+30, AxY);}
if(document.getElementById("SSAXField2").value==0){}
else{context.fillText(newArrayAggregOrNo[i].attributes[fiel2], LenX*i+30, AxY+6);}}

if(Xa==4){Xa=0;}
context.lineWidth = 1;
context.beginPath()
context.moveTo(LenX*i+30, myWinSSA4.document.getElementById('divCanvasComposeTrendSerials').height-20);
context.lineTo(LenX*i+30, myWinSSA4.document.getElementById('divCanvasComposeTrendSerials').height-24);context.stroke();}
for(var h=0; h<SerialArray.length;h++)
{ var ad=SerialArray[h];
 if(SerialArray[h+1]){ var ad2=SerialArray[h+1];}
 var NumberChart=(maxDistC-ad)/parseFloat(cenDel);
 context.fillRect(LenX*h+30, NumberChart, 3, 3);
var dddsst='';
var fiel=document.getElementById("SSAXField").value;var fiel2=document.getElementById("SSAXField2").value;
if(newArrayAggregOrNo[h].attributes[fiel])
{dddsst+=fiel +" "+newArrayAggregOrNo[h].attributes[fiel]}if(newArrayAggregOrNo[h].attributes[fiel2]){dddsst+=','+fiel2+" "+newArrayAggregOrNo[h].attributes[fiel2];}
if(type=='trend')
{mapHtml+='<area coords="'+parseFloat(LenX*h+30)+','+NumberChart+',4" shape="circle" title="'+'Trend y'+': '+ad+'; x='+h+' ;'+dddsst+' ">';}
if(type=='harmonic')
{mapHtml+='<area coords="'+parseFloat(LenX*h+30)+','+NumberChart+',4" shape="circle" title="'+'Harmonic y'+': '+ad+'; x='+h+' ;'+dddsst+' ">';}

context.lineWidth =2;context.beginPath();context.moveTo(LenX*h+30, NumberChart);if(ad2||ad2==0){var NumberChart2=(parseFloat(maxDistC)-parseFloat(ad2))/parseFloat(cenDel);context.lineTo(LenX*(h+1)+30, NumberChart2);context.strokeStyle = "#0000ff";context.stroke();}}


mapHtml+='</map>';
if(type=='harmonic')
{var strDataURI = myWinSSA4.document.getElementById('divCanvasComposeHarmonicSerials').toDataURL();}
if(type=='trend')
{var strDataURI = myWinSSA4.document.getElementById('divCanvasComposeTrendSerials').toDataURL();}
var NewMapChartImage=this.document.createElement('div');
NewMapChartImage.id='id_NewMapChartImage_'+type;
NewMapChartImage.innerHTML=mapHtml;
if(myWinSSA4.document.getElementById('id_NewMapChartImage_'+type))
{myWinSSA4.document.getElementById('id_NewMapChartImage_'+type).parentNode.removeChild(myWinSSA4.document.getElementById('id_NewMapChartImage_'+type));}
myWinSSA4.document.getElementById('id_WindowDivSSAchart4').appendChild(NewMapChartImage);
var NewChartImage=this.document.createElement('img');
 NewChartImage.id='id_ NewChartImage_'+type;
NewChartImage.src=strDataURI;
NewChartImage.setAttribute("usemap", '#MapChartForeAnTable_'+type);
if(myWinSSA4.document.getElementById('id_ NewChartImage_'+type))
{myWinSSA4.document.getElementById('id_ NewChartImage_'+type).parentNode.removeChild(myWinSSA4.document.getElementById('id_ NewChartImage_'+type));}
myWinSSA4.document.getElementById('id_WindowDivSSAchart4').appendChild(NewChartImage);


}
function DiagMatrixUsred(A,Xmat)
{
var SerialArray=[];
var mm=A.length+A[0].length-1;
for(var jlk=0;jlk<mm;jlk++)
{ var SumEl=0;var Gjlk=0;
if(jlk<A.length-1&&jlk>=0)
{SumEl=0;for(var bj=1;bj<=jlk+1;bj++){SumEl=SumEl+Xmat[bj-1][jlk-bj+2-1]}
Gjlk=1/(jlk+1)*SumEl;}
if(jlk<A[0].length&&jlk>=A.length-1)
{SumEl=0; for(var bj=1;bj<=(A.length-1);bj++){SumEl=SumEl+Xmat[bj-1][jlk-bj+2-1]}
Gjlk=1/(A.length)*SumEl; }
if(jlk<mm&&jlk>=A[0].length)
{SumEl=0; for(var bj=parseInt(jlk)-parseInt(A[0].length)+parseInt(2);bj<=parseFloat(mm)-parseFloat(A[0].length)+1;bj++){var sdf=parseInt(jlk-bj+2); SumEl=SumEl+Xmat[bj-1][sdf-1];}
Gjlk=1/(mm-jlk)*SumEl;}
SerialArray.push(Gjlk); 
}
return SerialArray;
}
function ComputSumTroiki(U,s,V,elemTr)
{
var tempMat1=[];
var CountS;
if(U[s.length-1]){CountS=s.length}else{CountS=s.length-1}
 for(var i=0; i<CountS; i++)
{ var coefi=i+1;
 var tempMaTi=[]
 var Vi=new Array(V.length);
 for(var a=0;a<V.length;a++){Vi[a]=0;}
 if(coefi==elemTr.id.split('_')[1])
 { for(var ii=0;ii<V[i].length;ii++)
 {Vi[ii]=V[ii][i];}}
 var Ui=new Array(U.length);
 for(var a=0;a<U.length;a++){Ui[a]=0;}
 if(coefi==elemTr.id.split('_')[1])
 {for(var ii=0;ii<U[i].length;ii++)
 {Ui[ii]=U[ii][i];}}
 if(coefi==elemTr.id.split('_')[1])
 {var tempMaTi=multiplyMatrix(multiplMatixNumber(s[i],Ui),transposeMatrix(Vi))
 tempMat1=tempMaTi;}
} 
return tempMat1;
}
function multiplyMatrix(U,S)
{
var rowsA = U.length,
 rowsB = S.length,
 colsB, 
 C = new Array(rowsA);
colsB = S[0].length;
if(!S[0].length){colsB=1;}
 for (var i=0; i<rowsA; i++)
 { C[i] = new Array(colsB) }
 for (var k=0; k<colsB; k++)
 { for (var i=0; i<rowsA; i++)
 { var temp = parseFloat(0);
 for (var j=0; j<rowsB; j++)
 {
if(!U[1]&&!S[0][1])
 {temp = (parseFloat(temp) + parseFloat(U[i][j])*parseFloat(S[j]))}
 else{ if(S[1]){temp = (parseFloat(temp) + parseFloat(U[i][j])*parseFloat(S[j][k]))}
 else{temp =(parseFloat(temp)+parseFloat(U[i])*parseFloat(S[j][k]));}}
 }
 C[i][k] = parseFloat(temp); 
 }
 }
return C;
}
function transposeMatrix(V)
{
var transpArray=[];
if(V[0].length)
{for (var i = 0; i < V[0].length; i++) 
{transpArray[i]=[]; 
for(var j=0; j<V.length; j++)
{transpArray[i][j]=0;}
 }}
else{transpArray[0]=[];}
for(var i = 0; i < V.length; i++)
{
 if(V[0].length)
 {for(var j = 0; j < V[0].length; j++)
 {transpArray[j][i] = V[i][j]}}
 else{transpArray[0][i]=V[i]; }
}
return transpArray;
}
function sumMatrix(A,B)
{
var rowsA = A.length;
var colsB = A[0].length;
var C=new Array(rowsA);
for (var i=0; i<rowsA; i++)
 { C[i] = new Array(colsB)
 for (var k=0; k<colsB; k++)
 { 
 var temp = (A[i][k]+B[i][k]);
 C[i][k] = temp;
 }
 }
return C;
}
function multiplMatixNumber(a,A)
{
var rowsA = A.length;
var colsB = A[0].length;
var C=new Array(rowsA);
 for (var i=0; i<rowsA; i++)
 { C[i] = new Array(colsB)
 if(colsB){ for (var k=0; k<colsB; k++)
 { 
 var temp = (a*A[i][k]);
 C[i][k] = temp;
 }} else{ var temp = (a*A[i]); C[i] = temp;}
 }
return C;
}
function SVDMatrix(A,columns,rows)
{
rows=A.length;//m
columns=A[0].length;
var s=[];//matrix of singular values
var n=columns;
var m=rows;
if(document.getElementById("Id_yes_Matrix")&&document.getElementById("Id_yes_Matrix").checked==true)
{
n=document.getElementById("id_colMatrix").value
m=document.getElementById("id_rowMatrix").value
}
 var thin = false;
 var wantu=true;
 var wantv=true;
 ncu = thin?Math.min(m,n):m;
var ssCount=ncu;
for (var i = 0; i < ssCount; i++) {s[i]=0;}
 if (wantu) U = []; for (var i = 0; i < m; i++) {U[i]=[]; for(var j=0; j<m; j++){U[i][j]=0;}}
 if (wantv) V = []; for (var i = 0; i < n; i++) {V[i]=[];}
 var e = [];for (var i = 0; i <n; i++) {e[i]=0;}
 var work = [];for (var i = 0; i <m; i++) {work[i]=0;}
 var nct = Math.min(m-1,n);
 var nrt = Math.max(0,Math.min(n-2,m));
 var lu = Math.max(nct,nrt);
 for (var k = 0; k < lu; k++) {
 if (k < nct) {
 s[k] = parseFloat(0); 
 for (var i = k; i < m; i++) { 
 s[k] = Math.sqrt(s[k]*s[k]+A[i][k]*A[i][k]);
 }
 if (s[k] != parseFloat(0)) {
 if (A[k][k] < parseFloat(0)) {
 s[k] = parseFloat(-s[k]);
 }
 for (var i = k; i < m; i++) {
 A[i][k] /= s[k];
 }
 A[k][k] = parseFloat(A[k][k])+parseFloat(1);
 }
 s[k] = parseFloat(-s[k]);
 }
 for (var j = k+1; j < n; j++) {
 if (k < nct && s[k] !=parseFloat(0)) {
 var t = parseFloat(0);
 for (var i = k; i < m; i++) {
 t = parseFloat(t)+parseFloat(A[i][k]*A[i][j]);
 }
 t = parseFloat(-t/A[k][k]);
 for (var i = k; i < m; i++) {
 A[i][j] =parseFloat(A[i][j])+ parseFloat(t*A[i][k]);
 }
 }
 e[j] = A[k][j];
 }
 if (wantu && k < nct) {
 for (var i = k; i < m; i++) {//alert("i="+i+" k="+k+" m="+m);
 U[i][k] = A[i][k];
 }
 }
 if (k < nrt) {
 e[k] = parseFloat(0);
 for (var i = k+1; i < n; i++) {
 e[k] = Math.sqrt(e[k]*e[k]+e[i]*e[i]);
 }
 if (e[k] != parseFloat(0)) {
 if (e[k+1] < parseFloat(0)) {
 e[k] = parseFloat(-e[k]);
 }
 for (var i = k+1; i < n; i++) {
 e[i] /= e[k];
 }
 e[k+1] = e[k+1] +parseFloat(1);
 }
 e[k] = parseFloat(-e[k]);
 if (k+1 < m && e[k] != parseFloat(0)) {
 for (var i = k+1; i < m; i++) {
 work[i] = parseFloat(0);
 }
 for (var j = k+1; j < n; j++) {
 for (var i = k+1; i < m; i++) {
 work[i] = parseFloat(work[i])+parseFloat(e[j]*A[i][j]);
 }
 }
 for (var j = k+1; j < n; j++) {
 var t = parseFloat(-e[j]/e[k+1]);
 for (var i = k+1; i < m; i++) {
 A[i][j] = parseFloat(A[i][j])+parseFloat(t*work[i]);
 }
 }
 }
 if (wantv) {
 for (var i = k+1; i < n; i++) {
 V[i][k] = e[i];
 }
 }
 }
 }
 var p = Math.min(parseInt(n),parseInt(m)+parseInt(1));
 if (nct < n) {
 s[nct] = A[nct][nct];
 }
 if (m < p) {
 s[p-1] = parseFloat(0);
 }
 if (nrt+1 < p) {
 e[nrt] = A[nrt][p-1];
 }
 e[p-1] = parseFloat(0);
 if (wantu) {
 for (var j = nct; j < ncu; j++) {
 for (var i = 0; i < m; i++) {
 U[i][j] = parseFloat(0);
 }
 U[j][j] = parseFloat(1);
 }
 for (var k = nct-1; k >= 0; k--) {
 if (s[k] != parseFloat(0)) {
 for (var j = k+1; j < ncu; j++) {
 var t = parseFloat(0);
 for (var i = k; i < m; i++) {
 t =parseFloat(t)+ parseFloat(U[i][k]*U[i][j]);
 }
 t = parseFloat(-t)/parseFloat(U[k][k]);
 for (var i = k; i < m; i++) {
 U[i][j] =parseFloat(U[i][j])+parseFloat(t*U[i][k]);
 }
 }
 for (var i = k; i < m; i++ ) {
 U[i][k] = parseFloat(-U[i][k]);
 }
 U[k][k] =parseFloat(U[k][k])+parseFloat(1);
 for (var i = 0; i < k-1; i++) {
 U[i][k] = parseFloat(0);
 }
 } else {
 for (var i = 0; i < m; i++) {
 U[i][k] = parseFloat(0);
 }
 U[k][k] = parseFloat(1);
 }
 }
 }
 if (wantv) {
 for (var k = n-1; k >= 0; k--) {
 if (k < nrt && e[k] != parseFloat(0)) {
 for (var j = k+1; j < n; j++) {
 var t = parseFloat(0);
 for (var i = k+1; i < n; i++) {
 t= parseFloat(t)+parseFloat(V[i][k]*V[i][j]);
 }
 t =parseFloat(-t/V[k+1][k]);
 for (var i = k+1; i < n; i++) {
 V[i][j] = parseFloat(V[i][j])+parseFloat(t*V[i][k]);
 }
 }
 }
 for (var i = 0; i < n; i++) {
 V[i][k] = parseFloat(0);
 }
 V[k][k] = parseFloat(1);
 }
 }
 var pp = p-1;
 var iter = 0;
 var eps = parseFloat(Math.pow(2.0,-52.0));
 var tiny = parseFloat(Math.pow(2.0,-966.0));
 while (p > 0) {
 var k,case1;
 for (k = p-2; k >= -1; k--) {
 if (k == -1) {
 break;
 }
 if (Math.abs(e[k]) <=
 tiny + eps*(Math.abs(s[k]) + Math.abs(s[k+1]))) {
 e[k] = parseFloat(0);
 break;
 }
 }
 if (k == p-2) {
 case1 = 4;
 } else {
 var ks;
 for (ks = p-1; ks >= k; ks--) {
 if (ks == k) {
 break;
 }
 var t = (ks != p ? Math.abs(e[ks]) : parseFloat(0)) + 
 (ks != k+1 ? Math.abs(e[ks-1]) : parseFloat(0));
 if (Math.abs(s[ks]) <= tiny + eps*t) {
 s[ks] = parseFloat(0);
 break;
 }
 }
 if (ks == k) {
 case1 = 3;
 } else if (ks == p-1) {
 case1 = 1;
 } else {
 case1 = 2;
 k = ks;
 }
 }
 k++;
 switch (case1) {
 case 1: {
 var f = parseFloat(e[p-2]);
 e[p-2] = parseFloat(0);
 for (var j = p-2; j >= k; j--) {
 var t = parseFloat(Math.sqrt(s[j]*s[j]+f*f));
 var cs = parseFloat(s[j]/t);
 var sn =parseFloat(f/t);
 s[j] = parseFloat(t);
 if (j != k) {
 f = parseFloat(-sn*e[j-1]);
 e[j-1] = parseFloat(cs*e[j-1]);
 }
 if (wantv) {
 for (var i = 0; i < n; i++) {
 t = parseFloat(cs*V[i][j]) + parseFloat(sn*V[i][p-1]);
 V[i][p-1] =parseFloat( -sn*V[i][j]) + parseFloat(cs*V[i][p-1]);
 V[i][j] = parseFloat(t);
 }
 }
 }
 }
 break;
 case 2: {
 var f = e[k-1];
 e[k-1] = parseFloat(0);
 for (var j = k; j < p; j++) {
 var t = parseFloat(Math.sqrt(s[j]*s[j]+f*f));
 var cs = parseFloat(s[j]/t);
 var sn =parseFloat(f/t);
 s[j] = parseFloat(t);
 f = parseFloat(-sn*e[j]);
 e[j] =parseFloat(cs*e[j]);
 if (wantu) {
 for (var i = 0; i < m; i++) {
 t = parseFloat(cs*U[i][j]) + parseFloat(sn*U[i][k-1]);
 U[i][k-1] = parseFloat(-sn*U[i][j]) + parseFloat(cs*U[i][k-1]);
 U[i][j] = parseFloat(t);
 }
 }
 }
 }
 break;
 case 3: {
 var scale = Math.max(Math.max(Math.max(Math.max(
 Math.abs(s[p-1]),Math.abs(s[p-2])),Math.abs(e[p-2])), 
 Math.abs(s[k])),Math.abs(e[k]));
 var sp = parseFloat(s[p-1]/scale);
 var spm1 = parseFloat(s[p-2]/scale);
 var epm1 = parseFloat(e[p-2]/scale);
 var sk = parseFloat(s[k]/scale);
 var ek = parseFloat(e[k]/scale);
 var b = parseFloat(((spm1 + sp)*(spm1 - sp) + epm1*epm1)/2.0);
 var c =parseFloat( (sp*epm1)*(sp*epm1));
 var shift =parseFloat(0);
 if (b != parseFloat(0) || c != parseFloat(0)) {
 shift = parseFloat(Math.sqrt(b*b + c));
 if (b < parseFloat(0)) {
 shift =parseFloat( -shift);
 }
 shift = parseFloat(c/(b + shift));
 }
 var f = parseFloat((sk + sp)*(sk - sp) + shift);
 var g = parseFloat(sk*ek);
 for (var j = k; j < p-1; j++) {
 var t = parseFloat(Math.sqrt(f*f+g*g));
 var cs =parseFloat(f/t);
 var sn = parseFloat(g/t);
 if (j != k) {
 e[j-1] = parseFloat(t);
 }
 f = parseFloat(cs*s[j]) + parseFloat(sn*e[j]);
 e[j] = parseFloat(cs*e[j]) - parseFloat(sn*s[j]);
 g =parseFloat(sn*s[j+1]);
 s[j+1] = parseFloat(cs*s[j+1]);
 if (wantv) {
 for (var i = 0; i < n; i++) {
 t = parseFloat(cs*V[i][j]) + parseFloat(sn*V[i][j+1]);
 V[i][j+1] =parseFloat(-sn*V[i][j])+ parseFloat(cs*V[i][j+1]);
 V[i][j] = parseFloat(t);
 }
 }
 t = parseFloat(Math.sqrt(f*f+g*g));
 cs = parseFloat(f/t);
 sn = parseFloat(g/t);
 s[j] = parseFloat(t);
 f = parseFloat(cs*e[j]) + parseFloat(sn*s[j+1]);
 s[j+1] =parseFloat(-sn*e[j]) + parseFloat(cs*s[j+1]);
 g = parseFloat(sn*e[j+1]);
 e[j+1] = parseFloat(cs*e[j+1]);
 if (wantu && j < m-1) { 
 for (var i = 0; i < m; i++) {
 t = parseFloat(cs*U[i][j]) + parseFloat(sn*U[i][j+1]);
 U[i][j+1] = parseFloat(-sn*U[i][j]) + parseFloat(cs*U[i][j+1]);
 U[i][j] =parseFloat(t);
 }
 }
 }
 e[p-2] = parseFloat(f);
 iter++;
 }
 break;
 case 4: {
 if (s[k] <= parseFloat(0)) {
 s[k] = (s[k] < parseFloat(0) ? -s[k] : parseFloat(0));
 if (wantv) {
 for (var i = 0; i < n; i++) {
 V[i][k] = parseFloat(-V[i][k]);
 }
 }
 }
 while (k < pp) {
 if (s[k] >= s[k+1]) {
 break;
 }
 var t = parseFloat(s[k]);
 s[k] = s[k+1];
 s[k+1] = parseFloat(t);
 if (wantv && k < n-1) {
 for (var i = 0; i < n; i++) {
 t = parseFloat(V[i][k+1]); V[i][k+1] = parseFloat(V[i][k]); V[i][k] = parseFloat(t);
 }
 }
 if (wantu && k < m-1) {
 for (var i = 0; i < m; i++) {
 t = parseFloat(U[i][k+1]); U[i][k+1] =parseFloat(U[i][k]); U[i][k] = parseFloat(t);
 }
 }
 k++;
 }
 iter = 0;
 p--;
 }
 break;
 }
 }
var S = []
for (var i = 0; i < ncu; i++) {S[i]=[]; for(var j=0; j<n; j++){S[i][j]=0;}}
 for (var i = Math.min(m,n)-1; i>=0; i--)
 {S[i][i] = s[i];}
var Final=[]
Final.push(U);
Final.push(S);
Final.push(V);
Final.push(s);
return Final;
}
function Geomathematic()
 {
var bbox = document.getElementById("map").getBoundingClientRect();
 var body = document.body
 var docElem = document.documentElement
 var scrollTop = window.pageYOffset || docElem.scrollTop || body.scrollTop
 var scrollLeft = window.pageXOffset || docElem.scrollLeft || body.scrollLeft
 var clientTop = docElem.clientTop || body.clientTop || 0
 var clientLeft = docElem.clientLeft || body.clientLeft || 0
 var topTop = bbox.top + scrollTop - clientTop
 var leftLeft = bbox.left + scrollLeft - clientLeft
var DivEditeLeg=document.createElement("div");
DivEditeLeg.id="id_divPopGeoMLegMain2";
DivEditeLeg.className="id_divRoutLegMain";
DivEditeLeg.style.position="relative";
//DivEditeLeg.onmouseup="enddrag()";DivEditeLeg.onmousedown="drags(event)"
DivEditeLeg.innerHTML='<div id="id_divPopGeoMLeg" style="background:#ffffff; color:#0000ff;z-index: 6000;position:absolute;left:'+Math.round(leftLeft+50)+'px;top:'+Math.round(topTop)+
'px;overflow:hidden; border: 1px solid black;"><img onclick="closeGeoMathpopUpWin()" src="openlayers/theme/default/img/close.gif" style="position:relative; top:10px;float:right; cursor:pointer"><a style="position:relative; top:20px"></a>'+
'<a style="font-size: 9px;">Вы можете перемещать это окно, если выберите пунтк меню /переключить режим интерфейса/</a><br>'+
'<a>select function:</a>'+
'<select id="functionGeoM" onchange="describeProcess()">'+
 '<option selected value="0" >Select a function</option>'+
'</select><br>'+
'<div><p id="abstract"></p><div id="input"></div>'+
'<div id="output"></div>'+
'</div>';
if(!document.getElementById("id_divPopGeoMLeg"))
{body.appendChild(DivEditeLeg); }
document.getElementById("id_divPopGeoMLegMain2").onmousedown=function(event){drags(event)};
document.getElementById("id_divPopGeoMLegMain2").onmouseup=function(e){enddrag()};
alert("Эта функция работает только в онлайн веб-версии OpenWebGIS")
 {return;}
 OpenLayers.Request.GET({
 url: "/geoserver/wps",
 params: {
 "SERVICE": "WPS",
 "REQUEST": "GetCapabilities"
 },
 success: function(response){
 capabilities = new OpenLayers.Format.WPSCapabilities().read(
 response.responseText
 );
 var dropdown = document.getElementById("functionGeoM");
 var offerings = capabilities.processOfferings, option;
 for (var p in offerings) {
 if(p.split(':')[0]=="JTS")
 {
 option = document.createElement("option");
 option.innerHTML = offerings[p].identifier.split(':')[1];
 option.value = p;
 dropdown.appendChild(option);

 }
else
{
 option = document.createElement("option");
 option.innerHTML = offerings[p].identifier;
 option.value = p;
 dropdown.appendChild(option);

}
 }
 }
 });
 }
function addRasterInput(input) {
    var name = input.identifier;
    var field = document.createElement("textarea");
    field.title = input["abstract"];
field.id="id_fieldRasterFileWeb"
var RasterFile = document.createElement("input");
RasterFile.type="file";
RasterFile.id="id_RasterFileWeb";
RasterFile.title="Нажмите для выбора файла растра(грида) на вашем компьютере и только потом нажимайте 'Execute' для расчёта";
RasterFile.innerHTML = "открыть файл";
var sel=document.createElement("select");
sel.id = 'selRaster_WebGIS';
sel.title= "select format input file";
var option = document.createElement('option');
option.value = 'application/arcgrid';
option.text = 'application/arcgrid';
sel.appendChild(option);
var option = document.createElement('option');
option.value = 'image/tiff';
option.text = 'image/tiff';
sel.appendChild(option);
var sel2=document.createElement("select");
sel2.id = 'selRaster_WebGIS2';
sel2.title= "You can select raster Layer from this combobox";
var selaT = document.createElement('a');
selaT.innerHTML='выберите Слой';
var br = document.createElement('br');
var br2= document.createElement('br');
var option = document.createElement('option');
option.value = '0';
option.text = '';
sel2.appendChild(option);
for(var f=0;f<map.layers.length;f++)
{
if(map.layers[f].CLASS_NAME=="OpenLayers.Layer.WMS"&&map.layers[f].isBaseLayer!==true)
{
var option = document.createElement('option');
option.value = map.layers[f].params.LAYERS;
option.text = map.layers[f].name;
sel2.appendChild(option);
}
}
    var url = window.location.href.split("?")[0];
  field.value = /*url.substr(0, url.lastIndexOf("/")+1) +*/ "data/tazdem.tiff";
 addValueHandlers(field, function() {
if(document.getElementById('selRaster_WebGIS2').value!=='0')
{
}
else{
input.data = field.value ? {
 complexData: {
 mimeType: document.getElementById("selRaster_WebGIS").value,
 value: this.value
 }
 } : undefined;}
 });
    document.getElementById("input").appendChild(field);
document.getElementById("input").appendChild(br);
document.getElementById("input").appendChild(sel2);
document.getElementById("input").appendChild(selaT);
sel2.onchange=function(){onchangeRasterMapLayer(field,input);};
document.getElementById("input").appendChild(br2);
document.getElementById("input").appendChild(sel);
field.click();field.focus();
document.getElementById("input").appendChild(RasterFile);
document.getElementById('id_RasterFileWeb').addEventListener('change', readSingleFileRasterFileWeb, false);
}

// helper function to dynamically create a WFS collection reference input
function onchangeRasterMapLayer(field,input)
{
var t1=document.getElementById('selRaster_WebGIS2').value.split(':')[0];
var t2=document.getElementById('selRaster_WebGIS2').value.split(':')[1];
delete input.data;
delete input.complexData;
//delete input.identifier;
var wmsL = new OpenLayers.Format.WMSCapabilities();
alert("Эта функция работает только в онлайн веб-версии OpenWebGIS")
 {return;}
OpenLayers.Request.GET({
url:'/geoserver/'+t1+'/'+t2+'/'+'wms?'+'SERVICE=WMS&request=GetCapabilities',
 async: false,
success: function(e){
var response = wmsL.read(e.responseText);
var capability = response.capability;
for (var i=0, len=capability.layers.length; i<len; i++) { 
 var layerObj = capability.layers[i];
abstractWMS=layerObj.abstract;
 InterInterpBB=layerObj.llbbox;
}
}
})
 input.reference= {
  mimeType: "image/tiff",
  href: "http://geoserver/wcs",
 method: "POST",
body: {
wcs: {
version: "1.1.1",
outputFormat: "image/tiff",
identifier: t1+":"+t2,
domainSubset: {
boundingBox: {
projection: 'http://www.opengis.net/gml/srs/epsg.xml#4326',
bounds: new OpenLayers.Bounds(InterInterpBB[0], InterInterpBB[1],InterInterpBB[2], InterInterpBB[3])
}
},
output: {format:'image/tiff'},
                }

            }
 } 
 
    


}
function getLayerinJson(name,field)
{var layer='';
for(var i=0;i<map.layers.length;i++)
{if(map.layers[i].name==name){layer=map.layers[i];}}
if(layer==''){alert("Error name of layer");return;}
else{
var format = new OpenLayers.Format.GeoJSON({});
var FeaturesForStat=[];
for (var i=0; i<layer.features.length; i++)
{FeaturesForStat.push(layer.features[i]);
  for(h in layer.features[i].attributes)
{if(isNaN(parseFloat(layer.features[i].attributes[h]))==false)
{FeaturesForStat[FeaturesForStat.length-1].attributes[h]=parseFloat(layer.features[i].attributes[h])}

}
}
//var jsonstring = format.write(layer.features);
var jsonstring = format.write(FeaturesForStat);
var DopStr='}],"crs":{ "type":"name","properties":{"name":"EPSG:900913"}}}';
var Newjsonstring = jsonstring.replace(/}]}/,DopStr);
Newjsonstring = Newjsonstring.replace(/LineString/,'MultiLineString');
jsonstring=Newjsonstring;
field.value=jsonstring;
field.focus();
}
}
function addWFSCollectionInput(input) {
 var name = input.identifier;
 var field = document.createElement("textarea");
var LayerButton = document.createElement("button");
LayerButton.title="Введите название интересующего слоя и нажмите на эту кнопку, что бы получить данные слоя и только потом нажимайте 'Execute' для расчёта"
 LayerButton.innerHTML = "получить данные";
LayerButton.onclick =function(){ getLayerinJson(field.value,field)};
 field.title = input["abstract"]+"; insert layer name from the left list of the Layers (for example: Rivers)";
 field.value = name + " (layer on server)";
 addValueHandlers(field, function() {
input.data = field.value ? {
 complexData: {
 mimeType: "application/json",
 value: this.value
 }
 } : undefined;
 });
 document.getElementById("input").appendChild(field);
document.getElementById("input").appendChild(LayerButton);
}
function addBoundingBoxInput(input) {
 var name = input.identifier;
 var field = document.createElement("input");
 field.title = input["abstract"];
 field.value = "left,bottom,right,top (EPSG:4326)";
 document.getElementById("input").appendChild(field);
 addValueHandlers(field, function() {
 input.boundingBoxData = {
 projection: "EPSG:4326",
 bounds: new OpenLayers.Bounds.fromString(field.value)
 };
 });
}
function describeProcess() {
 var selection =document.getElementById("functionGeoM").options[document.getElementById("functionGeoM").selectedIndex].value;
 alert("Эта функция работает только в онлайн веб-версии OpenWebGIS")
 {return;}
 OpenLayers.Request.GET({
 url: wps,
 params: {
 "SERVICE": "WPS",
 "REQUEST": "DescribeProcess",
 "VERSION": capabilities.version,
 "IDENTIFIER": selection
 },
 success: function(response) {
 process = new OpenLayers.Format.WPSDescribeProcess().read(
 response.responseText
 ).processDescriptions[selection];
 buildForm();
 }
 });
}
function GetListEPSG()
{alert("Эта функция работает только в онлайн веб-версии OpenWebGIS")
 {return;}
wms = new OpenLayers.Format.WMSCapabilities();
OpenLayers.Request.GET({
url:"/geoserver/wms?request=GetCapabilities",
success: function(e){
var response = wms.read(e.responseText);
var capability = response.capability;
var strXml =e.responseText;
 var oXmlDoc = null;
 if ( window.DOMParser ) {
 var oXmlParser = new DOMParser();
 oXmlDoc = oXmlParser.parseFromString( strXml, "text/xml" );
 } else {
 oXmlDoc = new ActiveXObject( "Microsoft.XMLDOM" );
 oXmlDoc.async = "false";
 oXmlDoc.loadXML( strXml );
 }
var tagCRSFull = oXmlDoc; 
var tagCRS = oXmlDoc.getElementsByTagName('CRS');
for(var i=0;i<tagCRS.length;i++)
{var option = document.createElement('option');
 option.value =tagCRS[i].childNodes[0].data;
 option.text =tagCRS[i].childNodes[0].data;
 document.getElementById("selEPSG").appendChild(option);}
}
});
}
function buildForm() {
 document.getElementById("abstract").innerHTML = "<font size='2'>"+process["abstract"]+"</font>";
 document.getElementById("input").innerHTML = "<font size='4'>Input:</font><br>";
 document.getElementById("output").innerHTML = "";
var countEPSG=1;
 var inputs = process.dataInputs, supported = true,
 sld = "text/xml; subtype=sld/1.0.0",
 input;
 for (var i=0,ii=inputs.length; i<ii; ++i) {
 input = inputs[i];
 if (input.complexData) {
 var formats = input.complexData.supported.formats;
 if (formats["application/wkt"]) {
 if (countEPSG==1) 
 {var conInput=document.getElementById("input");
 var labelEPSG = document.createElement("label");
 labelEPSG.title ="to correct calculation distance, area etc you may select Coordinate Reference Systems (CRS). For example: to Curonian and Vistula lagoon the proper CRS can be WGS 84 / UTM zone 34N (EPSG 32634) (unit 'm')";
labelEPSG.innerHTML="<font size='1'>to calculate distance, area etc correctly, you may select necessary Coordinate Reference Systems</font><br>";
conInput.appendChild(labelEPSG);
 document.getElementById("input").appendChild(document.createElement("br"));
 var selEPSG=document.createElement("select");
 selEPSG.id = 'selEPSG';
 selEPSG.name = 'selEPSG';
 selEPSG.title= labelEPSG.title;
 var option = document.createElement('option');
 option.value = '0';
 option.text = '.';
 selEPSG.appendChild(option);
 conInput.appendChild(selEPSG);
 document.getElementById("input").appendChild(document.createElement("br"));
 selEPSG.onchange=function(){var dest1 = new Proj4js.Proj(document.getElementById('selEPSG').value); };
 GetListEPSG(); countEPSG=2;}
addWKTInput(input); 
 } else if (formats["text/xml; subtype=wfs-collection/1.0"]) {
 addWFSCollectionInput(input);
 } else if (formats["image/tiff"]) {
 addRasterInput(input);
 } else if (formats[sld]) {
 addXMLInput(input, sld);
 } else {
 supported = false;
 }
 } else if (input.boundingBoxData) {
 addBoundingBoxInput(input);
 } else if (input.literalData) {
 addLiteralInput(input);
 } else {
 supported = false;
 }
 if (input.minOccurs > 0) {
 document.getElementById("input").appendChild(document.createElement("br"));
 document.getElementById("input").appendChild(document.createTextNode("* "));
 }
 }
 if (supported) {
 var executeButton = document.createElement("button");
 executeButton.innerHTML = "Execute";
 document.getElementById("input").appendChild(executeButton);
 executeButton.onclick = execute;
 } else {
 document.getElementById("input").innerHTML = '<span class="notsupported">' +
 "Sorry, the WPS builder does not support the selected process." +
 "</span>";
 }

}
function $importPrj4js(src){
 var scriptElem = document.createElement('script');
 scriptElem.setAttribute('src',src);
 scriptElem.setAttribute('type','text/javascript');
 document.getElementsByTagName('head')[0].appendChild(scriptElem);
}
function addWKTInput(input, previousSibling) {
 var name = input.identifier;
 var container = document.getElementById("input");
 var label = document.createElement("label");
 label["for"] = name;
 label.title = input["abstract"];
 label.innerHTML = name + " (select feature, then click field):";
 previousSibling && previousSibling.nextSibling ?
 container.insertBefore(label, previousSibling.nextSibling) :
 container.appendChild(label);
 var field = document.createElement("textarea");
 field.onclick = function () {
 if (edilayerMainLayer.selectedFeatures.length) {
 if (document.getElementById("selEPSG").value==0)
 { this.value = new OpenLayers.Format.WKT().write(
 edilayerMainLayer.selectedFeatures[0]
 );}
 else
 {
var format = new OpenLayers.Format.GeoJSON({ 
 'internalProjection': new OpenLayers.Projection("EPSG:900913"),
 'externalProjection': new OpenLayers.Projection("EPSG:4326")
 });
var featureEPSG1=format.write(edilayerMainLayer.selectedFeatures[0]);
var source1 = new Proj4js.Proj("EPSG:4326"); 
var dest1 = new Proj4js.Proj(document.getElementById('selEPSG').value); 
var format2 = new OpenLayers.Format.GeoJSON({ 
 'internalProjection': new OpenLayers.Projection("EPSG:4326"),
'externalProjection': new OpenLayers.Projection("EPSG:4326")
});
var featureEPSG2=format2.read(featureEPSG1)
var geometryEPSGclone=featureEPSG2[0].geometry.clone();
var featureEPSGN=geometryEPSGclone.transform(new OpenLayers.Projection("EPSG:4326"), new OpenLayers.Projection(document.getElementById("selEPSG").value));
featureEPSG2[0].geometry=featureEPSGN;
 this.value = new OpenLayers.Format.WKT().write(featureEPSG2[0]);
 }
 }
 createCopy(input, this, addWKTInput); };
 field.onblur = function() {
 input.data = field.value ? {
 complexData: {
 mimeType: "application/wkt",
 value: this.value
 }
 } : undefined;
 };
 field.title = input["abstract"];
 field.id = name;
 previousSibling && previousSibling.nextSibling ?
 container.insertBefore(field, previousSibling.nextSibling.nextSibling) :
 container.appendChild(field); 
}
function execute() {
    var output = process.processOutputs[0];
    var input;
    // remove occurrences that the user has not filled out
    for (var i=process.dataInputs.length-1; i>=0; --i) {
        input = process.dataInputs[i];
        if ((input.minOccurs === 0 || input.occurrence) && !input.data && !input.reference) {
            OpenLayers.Util.removeItem(process.dataInputs, input);
        }
    }
    process.responseForm = {
        rawDataOutput: {
            identifier: output.identifier
        }
    };
    if (output.complexOutput && output.complexOutput.supported.formats["application/wkt"]) {
        process.responseForm.rawDataOutput.mimeType = "application/wkt";
    }

if(document.getElementById("selRaster_WebGIS2")&&document.getElementById("selRaster_WebGIS2").value!=='0')
{process.responseForm.rawDataOutput.mimeType ="text/xml; subtype=wfs-collection/1.0";}
var strWPSstring=new OpenLayers.Format.WPSExecute().write(process);
if(document.getElementById("selRaster_WebGIS2")&&document.getElementById("selRaster_WebGIS2").value!=='0')
{var txt='GetCoverage xmlns:wcs="http://www.opengis.net/wcs"';strWPSstring = strWPSstring.replace(txt,'GetCoverage xmlns:wcs="http://www.opengis.net/wcs/1.1.1"');}
var
strWPS=strWPS;
alert("Эта функция работает только в онлайн веб-версии OpenWebGIS")
 {return;}
    OpenLayers.Request.POST({
        url: wps,
        data: strWPSstring,
        success: showOutput
    });
}
function createCopy(input, field, fn) {
 if (input.maxOccurs && input.maxOccurs > 1 && !field.userSelected) {
 field.userSelected = true;
 var newInput = OpenLayers.Util.extend({}, input);
 newInput.occurrence = (input.occurrence || 0) + 1;
 process.dataInputs.push(newInput);
 fn(newInput, field);
 }
}
function ShowEdiLayerGeoM()
{
features=featuresGeomM;
var nameGeoM=document.getElementById("functionGeoM").value.split(':')[1]
var new_layer_G = new OpenLayers.Layer.Vector(edilayerMainLayer.name+"_"+nameGeoM);
var format = new OpenLayers.Format.GeoJSON({ 
 'internalProjection': new OpenLayers.Projection("EPSG:4326"),
'externalProjection': new OpenLayers.Projection("EPSG:900913")
});
var jsonstring = format.write(features);
rtt=jsonstring;
var format2 = new OpenLayers.Format.GeoJSON({ 
 'internalProjection': new OpenLayers.Projection("EPSG:900913"),
'externalProjection': new OpenLayers.Projection("EPSG:900913")
});
features=format2.read(jsonstring)
for(i=0;i<features.length;i++)
{features[i].state = OpenLayers.State.INSERT}
edilayerMainLayer.addFeatures(features);
}
function ShowNewLayerGeoM()
{
features=featuresGeomM;

var nameGeoM=document.getElementById("functionGeoM").value.split(':')[1]
var new_layer_G = new OpenLayers.Layer.Vector(edilayerMainLayer.name+"_"+nameGeoM);
if(!featuresGeomM.markwebgisWFS||nameGeoM=="RasterAsPointCollection"){
var format = new OpenLayers.Format.GeoJSON({ 
 'internalProjection': new OpenLayers.Projection("EPSG:4326"),
'externalProjection': new OpenLayers.Projection("EPSG:900913")
});
var jsonstring = format.write(features);
rtt=jsonstring;
var format2 = new OpenLayers.Format.GeoJSON({ 
 'internalProjection': new OpenLayers.Projection("EPSG:900913"),
'externalProjection': new OpenLayers.Projection("EPSG:900913")
});

features=format2.read(jsonstring)
}else{features.markwebgisWFS=1;delete features.markwebgisWFS}
new_layer_G.addFeatures(features);
new_layer_G.projection=new OpenLayers.Projection("EPSG:900913");
map.addLayer(new_layer_G);
 var t=this.document.createElement('option');
t.value=new_layer_G.name;
t.text=new_layer_G.name;
this.document.getElementById("editL1").appendChild(t);
}
function setMarcSaveGeoM()
{
featuresGeomM.state = OpenLayers.State.INSERT; }
function setShowCoordGeom(geomtext, resultGeom)
 { 
 var wktS=geomtext.split('(');
var startGeomStr=wktS[0];
var startGeomStr2;
 if(wktS[1]=="")
 {
 startGeomStr=startGeomStr+"((";
 startGeomStr2="))";
 wktS=wktS[2];
 wktS=wktS.split(')');
 wktS=wktS[0];
 wktS=wktS.split(',');
 }
 else
 { startGeomStr=startGeomStr+"(";
 startGeomStr2=")";
 wktS=wktS[1];
 wktS=wktS.split(')');
 wktS=wktS[0];
 wktS=wktS.split(',');}
var newGeoM=[];
for(var i=0; i<wktS.length; ++i) 
{
var t=wktS[i].split(' ');
if(t.length>2){t[0]=t[1];t[1]=t[2];}
var new_pos=new OpenLayers.LonLat(t[0], t[1]).transform(
map.getProjectionObject(),
new OpenLayers.Projection("EPSG:4326"));
var new_lon=new_pos.lon;
var new_lat=new_pos.lat;
if(t.length<3)
{newGeoM[i]=new_pos.lon+' '+new_pos.lat;}
else{newGeoM[i]=' '+new_pos.lon+' '+new_pos.lat;}
 }
 document.getElementById("textareaGeom").value = startGeomStr+newGeoM+startGeomStr2;
 }
function showOutput(response) {
var result = document.getElementById("output");
 result.innerHTML = "<font size='4'>Output: </font></h3>";
 var features;
 var contentType = response.getResponseHeader("Content-Type");
 if (contentType == "application/wkt") {
 features = new OpenLayers.Format.WKT().read(response.responseText); 
 } else if (contentType == "text/xml; subtype=wfs-collection/1.0") {
 features = new OpenLayers.Format.WFST.v1_0_0().read(response.responseText);
 }
 if (features && (features instanceof OpenLayers.Feature.Vector || features.length)) {
 if(edilayerMainLayer.features[0]){for (var i in edilayerMainLayer.features[0].attributes)
{if(features.attributes){var name = i; features.attributes[name]="0"; features.data[name]="0";}}}
if(!features.attributes)
{
}
/*if(features.attributes)
{ 
edilayerMainLayer.addFeatures(features);
}*/
var dbvalue=response.responseText;
featuresGeomM=features;
if (contentType == "text/xml; subtype=wfs-collection/1.0")
{featuresGeomM.markwebgisWFS='1';}
var strGS='';
if(!features.attributes)
{
strGS="<br><input type='checkbox' id='MarcShowNewLayerGeoM' onclick='ShowNewLayerGeoM()'/><font size='2'>Show result in new Layer</font><br>";
}
var strGS2='';
if(!features.attributes)
{
strGS2="<input type='checkbox' id='MarcShowEdiLayerGeoM' onclick='ShowEdiLayerGeoM()'/><font size='2'>Show result in Editable Layer</font><br>";
}
 result.innerHTML += "<font size='2'>The result should also be visible on the map.</font><br>"+"<input type=\"checkbox\" onclick='setShowCoordGeom(\""+dbvalue+"\",\""+result+"\")'/><font size='1'>Show WGS84 coordinates</font><br><input type='checkbox' id='MarcSaveGeoM' onclick='setMarcSaveGeoM()'/><font size='1'>Mark feature for Save</font><br>"+strGS+strGS2;
var check1=document.createElement("input");
check1.type='checkbox';
document.getElementById("output").appendChild(document.createElement("br"));
 }
 result.innerHTML += "<textarea id='textareaGeom'>" + response.responseText + "</textarea>";
}

function addLiteralInput(input, previousSibling) {
 var name = input.identifier;
 var container = document.getElementById("input");
 var anyValue = input.literalData.anyValue;
 var field = document.createElement(anyValue ? "input" : "select");
 field.id = name;
 field.title = input["abstract"];
 previousSibling && previousSibling.nextSibling ?
 container.insertBefore(field, previousSibling.nextSibling) :
 container.appendChild(field);
 if (anyValue) {
 var dataType = input.literalData.dataType;
 field.value = name + (dataType ? " (" + dataType + ")" : "");
 addValueHandlers(field, function() {
 input.data = field.value ? {
 literalData: {
 value: field.value
 }
 } : undefined;
 createCopy(input, field, addLiteralInput);
 });
 } else {
 var option;
 option = document.createElement("option");
 option.innerHTML = name;
 field.appendChild(option);
 for (var v in input.literalData.allowedValues) {
 option = document.createElement("option");
 option.value = v;
 option.innerHTML = v;
 field.appendChild(option);
 }
 field.onchange = function() {
 createCopy(input, field, addLiteralInput);
 input.data = this.selectedIndex ? {
 literalData: {
 value: this.options[this.selectedIndex].value
 }
 } : undefined;
 };
 }
}
function addValueHandlers(field, onblur) {
 field.onclick = function() {
 if (!this.initialValue) {
 this.initialValue = this.value;
 this.value = "";
 }
 };
 field.onblur = function() {
 if (!this.value) {
 this.value = this.initialValue;
 delete this.initialValue;
 }
 onblur.apply(this, arguments);
 };
}
function ZonalStatistic()
{
var htmlZonalStart ='';
var valueName=edilayerMainLayer.name+"_ZonalStat";
htmlZonalStart +='<a>Select Polygon Layer which features will be</a><br><a>used to compute statistics:</a><br>'+
'<select id="ZonalStart_id">'+
 '<option selected value="0">.</option>'+
'</select><br>'+
'<select id="ZonalStartField_id">'+
 '<option selected value="0">.</option>'+
'</select>Attribute to use for computing statistics<br>'+
'<select id="ZonalStart_id_Type">'+
 '<option selected value="0">.</option>'+
'<option value="application/json">json</option>'+
'<option value="application/zip">shapefile</option>'+
'</select>Output format<br>'+
'<input type="checkbox" id="ZonalStart_id_TypeasLayer" title="click here to create and add to the map new layer with zonal statistics." value="checkbox"/><a>Add new layer</a><br>'+
'<input type="text" size="15" id="Id_ZonalStartNameAtl" value="'+valueName+'"/>name new Layer<br>'+
'<p> <button type=button onclick=OK_ZonalStart()>OK</button></p>';
popupZonalStart = new OpenLayers.Popup.FramedCloud("PopupZonalStartId",
 map.getCenter(),
 new OpenLayers.Size(500,500),
htmlZonalStart ,
 null, true, onPopupClose);
 map.addPopup(popupZonalStart);
for (var a in edilayerMainLayer.features[0].attributes)
{var t=document.createElement('option');
 t.value=a;
 t.text=a;
 document.getElementById("ZonalStartField_id").appendChild(t); }
for(var j=0;j<map.layers.length; j++)
 { 
 if(map.layers[j].CLASS_NAME=="OpenLayers.Layer.Vector")
 {var t=this.document.createElement('option');
t.value=map.layers[j].name;
t.text=map.layers[j].name;
this.document.getElementById("ZonalStart_id").appendChild(t); }
}
document.getElementById("ZonalStart_id_TypeasLayer").checked=true;
document.getElementById("PopupZonalStartId").onmousedown=function(event){drags(event)};
document.getElementById("PopupZonalStartId").onmouseup=function(e){enddrag()};
popupZonalStart.updateSize();


}


function OK_ZonalStart()
{var strUnion="'form'"
var htmlUnion='';
var twoLayer='';
for(var j=0;j<map.layers.length; j++)
 { 
if(map.layers[j].name==document.getElementById("ZonalStart_id").value){twoLayer=map.layers[j];}
}
if(twoLayer.features.length<1){alert("Please activate Layer");return;}
if(edilayerMainLayer.features.length<1){alert("Please activate ediltable Layer");return;}
//var format = new OpenLayers.Format.GeoJSON({});
var format = new OpenLayers.Format.GeoJSON({'internalProjection': new OpenLayers.Projection("EPSG:900913"),
'externalProjection': new OpenLayers.Projection("EPSG:4326")});
var FeaturesForStat=[];
var fieldAggr=document.getElementById("ZonalStartField_id").value;
for (var i=0; i<edilayerMainLayer.features.length; i++)
{if(isNaN(parseFloat(edilayerMainLayer.features[i].attributes[fieldAggr]))==false)
{FeaturesForStat.push(edilayerMainLayer.features[i]);
FeaturesForStat[FeaturesForStat.length-1].attributes[fieldAggr]=parseFloat(edilayerMainLayer.features[i].attributes[fieldAggr]);}
 }

if(FeaturesForStat.length==0){alert("selected field is not numeric. The total number of elements in the layer:"+edilayerMainLayer.features.length); if(popupZonalStart){popupZonalStart.destroy();}return;}
var jsonstring = format.write(edilayerMainLayer.features);
var DopStr='}],"crs":{ "type":"name","properties":{"name":"EPSG:4326"}}}';
//jsonstringExpReadyExport='![CDATA['+jsonstringExp+']]'
var Newjsonstring = jsonstring.replace(/}]}/,DopStr);
jsonstring=Newjsonstring;

var jsonstring2 = format.write(twoLayer.features);
var Newjsonstring2 = jsonstring2.replace(/}]}/,DopStr);
jsonstring2=Newjsonstring2;
var doppstrr='';
if(document.getElementById("ZonalStart_id_Type").value=='application/json'||document.getElementById("ZonalStart_id_Type").value=='0')
{doppstrr='<wps:RawDataOutput mimeType="application/json">';}
else{doppstrr='<wps:RawDataOutput mimeType="application/zip">';}

htmlUnion+='<?xml version="1.0" encoding="UTF-8"?>'+
'<wps:Execute version="1.0.0" service="WPS" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns="http://www.opengis.net/wps/1.0.0" xmlns:wfs="http://www.opengis.net/wfs" xmlns:wps="http://www.opengis.net/wps/1.0.0" xmlns:ows="http://www.opengis.net/ows/1.1" xmlns:gml="http://www.opengis.net/gml" xmlns:ogc="http://www.opengis.net/ogc" xmlns:wcs="http://www.opengis.net/wcs/1.1.1" xmlns:xlink="http://www.w3.org/1999/xlink" xsi:schemaLocation="http://www.opengis.net/wps/1.0.0 http://schemas.opengis.net/wps/1.0.0/wpsAll.xsd">'+
'<ows:Identifier>gs:VectorZonalStatistics</ows:Identifier>'+
'<wps:DataInputs>'+
'<wps:Input>'+
'<ows:Identifier>data</ows:Identifier>'+
'<wps:Data>'+
'<wps:ComplexData mimeType="application/json"><![CDATA['+jsonstring+']]></wps:ComplexData>'+
'</wps:Data>'+
'</wps:Input>'+
'<wps:Input>'+
'<ows:Identifier>dataAttribute</ows:Identifier>'+
'<wps:Data>'+
'<wps:LiteralData>'+document.getElementById("ZonalStartField_id").value+'</wps:LiteralData>'+
'</wps:Data>'+
'</wps:Input>'+
'<wps:Input>'+
'<ows:Identifier>zones</ows:Identifier>'+
'<wps:Data>'+
'<wps:ComplexData mimeType="application/json"><![CDATA['+jsonstring2+']]></wps:ComplexData>'+
'</wps:Data>'+
'</wps:Input>'+
'</wps:DataInputs>'+
'<wps:ResponseForm>'+doppstrr+
'<ows:Identifier>statistics</ows:Identifier>'+
'</wps:RawDataOutput>'+
'</wps:ResponseForm>'+
'</wps:Execute>';

if(document.getElementById("ZonalStart_id_Type").value=='application/json'||document.getElementById("ZonalStart_id_Type").value=='0')
{alert("Эта функция работает только в онлайн веб-версии OpenWebGIS")
 {return;}
 var request = OpenLayers.Request.POST({
 url: "/geoserver/wps",
 async: false,
 data: htmlUnion,
 headers: {
 "Content-Type": "text/xml;charset=utf-8"
 },
 callback: function (response) {
var resulUnionGeoserver=response.responseText;
kmlText2=resulUnionGeoserver;
if(document.getElementById("ZonalStart_id_Type").value=='application/json'){
init_download();//myWinExport= open("download.html", "Export vector layer","width=900,height=500,status=no,toolbar=no,menubar=no,scrollbars=yes");myWinExport.focus();
}
if(document.getElementById("ZonalStart_id_TypeasLayer").checked=true)
{var nameL=document.getElementById("Id_ZonalStartNameAtl").value;
; var new_layer_G = new OpenLayers.Layer.Vector(nameL,{renderers:["Canvas", "SVG", "VML"]});
var format2 = new OpenLayers.Format.GeoJSON({'internalProjection': new OpenLayers.Projection("EPSG:900913"),
'externalProjection': new OpenLayers.Projection("EPSG:4326") });
var newfeatures=format2.read(resulUnionGeoserver)
var obj = {};
   for(var g=0; g<newfeatures.length; g++) {
for(h in  newfeatures[g].attributes){str=h;
obj[str] = true; }
  }
for(var a = 0; a < newfeatures.length; a++ )
{ var NewAttr={};
for(h in obj){NewAttr[h]='';}
delete NewAttr.undefined;

for(h in obj)
{ for (ag in newfeatures[a].attributes) 
{
if(h==ag) 
{NewAttr[h]=newfeatures[a].attributes[ag]; rtt=NewAttr; }
else{if(NewAttr[h]){}else{NewAttr[h]=''};} ;  
}    
 }


 newfeatures[a].attributes=NewAttr;  
}
new_layer_G.addFeatures(newfeatures);
//new_layer_G.projection=new OpenLayers.Projection("EPSG:900913");
new_layer_G.events.register("loadstart",new_layer_G, function() {WaitWindow();});
map.addLayer(new_layer_G);
new_layer_G.events.register("loadend",new_layer_G, function() {if(popup_Wait){try{popup_Wait.destroy();}catch(e){};} });
 var t=this.document.createElement('option');
t.value=new_layer_G.name;
t.text=new_layer_G.name;
this.document.getElementById("editL1").appendChild(t);}
 },
 failure: function (response) {
 alert("Something went wrong in the request");
 }});
}
if(document.getElementById("ZonalStart_id_Type").value=='application/zip')
{var htmlUnion2='';
htmlUnion2+='<html><body onload="document.getElementById('+strUnion+').submit();return false;">'+
'<form id="form" action="../geoserver/TestWfsPost" method="post"><div style="width:0px;height:0px;position:absolute;left:-100px;top:-100px;overflow:hidden"><input'+
' type="hidden" name="form_hf_0" id="form_hf_0" /></div>'+
 '<input type="hidden" name="url" value="http://localhost:8080/geoserver/ows?strict=true"/>'+
 '<textarea style="visibility:hidden" name="body">'+htmlspecialchars(htmlUnion)+
'</textarea>'+'<input type="hidden" name="username" value=""/>'+
 '<input type="hidden" name="password" value=""/>'+
'</form>'+
'<div>'+'<span>Loading............</span>'+
'</div>'+'</body>'+
'</html>';
var myWinUnion=open("", "displayWindow","width=400,height=300,status=no,toolbar=no,menubar=no");
myWinUnion.document.open();
myWinUnion.document.write(htmlUnion2);
myWinUnion.document.close();

if(document.getElementById("ZonalStart_id_TypeasLayer").checked=true)
{var txt='<wps:RawDataOutput mimeType="application/zip">';
 htmlUnion = htmlUnion.replace(txt,'<wps:RawDataOutput mimeType="application/json">');
 alert("Эта функция работает только в онлайн веб-версии OpenWebGIS")
 {return;}
var request = OpenLayers.Request.POST({
 url: "/geoserver/wps",
 async: false,
 data: htmlUnion,
 headers: {
 "Content-Type": "text/xml;charset=utf-8"
 },
 callback: function (response) {
var resulUnionGeoserver=response.responseText;
if(document.getElementById("ZonalStart_id_TypeasLayer").checked=true)
{var nameL=document.getElementById("Id_ZonalStartNameAtl").value; var new_layer_G = new OpenLayers.Layer.Vector(nameL,{renderers:["Canvas", "SVG", "VML"]});
var format2 = new OpenLayers.Format.GeoJSON({'internalProjection': new OpenLayers.Projection("EPSG:900913"),
'externalProjection': new OpenLayers.Projection("EPSG:4326") });
var newfeatures=format2.read(resulUnionGeoserver)
var obj = {};
   for(var g=0; g<newfeatures.length; g++) {
for(h in  newfeatures[g].attributes){str=h;
obj[str] = true; }
  }
for(var a = 0; a < newfeatures.length; a++ )
{ var NewAttr={};
for(h in obj){NewAttr[h]='';}
delete NewAttr.undefined;

for(h in obj)
{ for (ag in newfeatures[a].attributes) 
{
if(h==ag) 
{NewAttr[h]=newfeatures[a].attributes[ag]; rtt=NewAttr; }
else{if(NewAttr[h]){}else{NewAttr[h]=''};} ;  
}    
 }
 newfeatures[a].attributes=NewAttr;  
}
new_layer_G.addFeatures(newfeatures);
//new_layer_G.projection=new OpenLayers.Projection("EPSG:900913");
new_layer_G.events.register("loadstart",new_layer_G, function() {WaitWindow();});
map.addLayer(new_layer_G);
new_layer_G.events.register("loadend",new_layer_G, function() {if(popup_Wait){try{popup_Wait.destroy();}catch(e){};} });
 var t=this.document.createElement('option');
t.value=new_layer_G.name;
t.text=new_layer_G.name;
this.document.getElementById("editL1").appendChild(t);}
 },
 failure: function (response) {
 alert("Something went wrong in the request");
 }});}

}

popupZonalStart.destroy();
}

function Agregation()
{
if(this.document.getElementById("editL1").value=="0")
{alert ("Please select name of Layer in combobox 'Editable Layer'");return;}
var featureTypes2;
var htmlTextAggreg=" ";
htmlTextAggreg+='<a>Field for aggregation:</a>'+
'<select id="aggreg_id">'+
 '<option selected value="0">.</option>'+
'</select><br>'+
'<input type="checkbox" id="Id_ZeroIsValueAtl" value="checkbox"/>zero is blank value<br>'+
'<p> <button type=button onclick=OK_Aggregation()>OK</button></p>';
popupAggreg = new OpenLayers.Popup.FramedCloud("AggregationPopup",
 map.getCenter(),
 new OpenLayers.Size(500,500),
 htmlTextAggreg ,
 null, true, onPopupClose);
 map.addPopup(popupAggreg);
document.getElementById("AggregationPopup").onmousedown=function(event){drags(event)};
document.getElementById("AggregationPopup").onmouseup=function(e){enddrag()};
var WFSLayerList;

for (var a in edilayerMainLayer.features[0].attributes)
{var t=document.createElement('option');
 t.value=a;
 t.text=a;
 document.getElementById("aggreg_id").appendChild(t); }
 

}
function AggregClose(){popupAggregNew.destroy();}
function OK_Aggregation()
{
if (!document.getElementById('ChartOper_id'))
{
var finalData='';
var htmlTextAggreg=" ";
htmlTextAggreg+='<a>Statistic:</a><br>'+
'<a>calculation only for fill values</a><br><a>in the selected field blank value skipped</a><br><textarea id="dataAggreg" style="width: 300px; height: 210px;"></textarea>'+
'<p> <button type=button onclick=AggregClose()>OK</button></p>';
popupAggregNew = new OpenLayers.Popup.FramedCloud("AggregationPopup",
 map.getCenter(),
 new OpenLayers.Size(500,500),
 htmlTextAggreg ,
 null, true, onPopupClose);
 map.addPopup(popupAggregNew);
}
var AggregO = new Object();
AggregO.Count=''; AggregO.Average=''; AggregO.Max='';AggregO.Median='';AggregO.Min=''; AggregO.StdDev=''; AggregO.Sum='';
for (var aggrFunc in AggregO)
{
if (!document.getElementById('ChartOper_id'))
{
var fieldAggr=document.getElementById("aggreg_id").value;
}
else{var fieldAggr=document.getElementById("ChartStart_id").value; }
var FeaturesForStat=[];
for (var i=0; i<edilayerMainLayer.features.length; i++)
{if(isNaN(parseFloat(edilayerMainLayer.features[i].attributes[fieldAggr]))==false)
{if(document.getElementById("Id_ZeroIsValueAtl")){if(document.getElementById("Id_ZeroIsValueAtl").checked==true&&edilayerMainLayer.features[i].attributes[fieldAggr]==0){}else{FeaturesForStat.push(edilayerMainLayer.features[i]);
FeaturesForStat[FeaturesForStat.length-1].attributes[fieldAggr]=parseFloat(edilayerMainLayer.features[i].attributes[fieldAggr]);}}else{FeaturesForStat.push(edilayerMainLayer.features[i]);
FeaturesForStat[FeaturesForStat.length-1].attributes[fieldAggr]=parseFloat(edilayerMainLayer.features[i].attributes[fieldAggr]);}}
 }

if(FeaturesForStat.length==0){alert("selected field is not numeric. The total number of elements in the layer:"+edilayerMainLayer.features.length); if(popupAggreg){popupAggreg.destroy();}return;}
var format = new OpenLayers.Format.GeoJSON({});
var jsonstring = format.write(FeaturesForStat);


strAggreg='<?xml version="1.0" encoding="UTF-8"?>'+
'<wps:Execute version="1.0.0" service="WPS" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns="http://www.opengis.net/wps/1.0.0" xmlns:wfs="http://www.opengis.net/wfs" xmlns:wps="http://www.opengis.net/wps/1.0.0" xmlns:ows="http://www.opengis.net/ows/1.1" xmlns:gml="http://www.opengis.net/gml" xmlns:ogc="http://www.opengis.net/ogc" xmlns:wcs="http://www.opengis.net/wcs/1.1.1" xmlns:xlink="http://www.w3.org/1999/xlink" xsi:schemaLocation="http://www.opengis.net/wps/1.0.0 http://schemas.opengis.net/wps/1.0.0/wpsAll.xsd">'+
 '<ows:Identifier>gs:Aggregate</ows:Identifier>'+
 '<wps:DataInputs>'+
 '<wps:Input>'+
 ' <ows:Identifier>features</ows:Identifier>'+
 '<wps:Data>'+
 '<wps:ComplexData mimeType="application/json"><![CDATA['+jsonstring+']]></wps:ComplexData>'+
 '</wps:Data>'+
 '</wps:Input>'+
 '<wps:Input>'+
 '<ows:Identifier>aggregationAttribute</ows:Identifier>'+
 ' <wps:Data>'+
 ' <wps:LiteralData>'+fieldAggr+'</wps:LiteralData>'+
 ' </wps:Data>'+
 '</wps:Input>'+
 '<wps:Input>'+
 '<ows:Identifier>function</ows:Identifier>'+
 '<wps:Data>'+
 ' <wps:LiteralData>'+aggrFunc+'</wps:LiteralData>'+
 '</wps:Data>'+
 ' </wps:Input>'+
 '</wps:DataInputs>'+
 '<wps:ResponseForm>'+
 ' <wps:RawDataOutput mimeType="text/xml">'+
 ' <ows:Identifier>result</ows:Identifier>'+
 '</wps:RawDataOutput>'+
 '</wps:ResponseForm>'+
'</wps:Execute>';
alert("Эта функция работает только в онлайн веб-версии OpenWebGIS")
 {return;}
var request = OpenLayers.Request.POST({
 url: "/geoserver/wps",
 async: false,
 data: strAggreg,
 headers: {
 "Content-Type": "text/xml;charset=utf-8"
 },
 callback: function (response) {
 var gmlParser = new OpenLayers.Format.GML();
 var xmlSum_L = gmlParser.read(response.responseText);
rtt=response.responseText;
var strXml = response.text;
 var oXmlDoc = null;
strXml = response.responseText;
 if ( window.DOMParser ) {
 var oXmlParser = new DOMParser();
 oXmlDoc = oXmlParser.parseFromString( strXml, "text/xml" );
 } else {
 oXmlDoc = new ActiveXObject( "Microsoft.XMLDOM" );
 oXmlDoc.async = "false";
 oXmlDoc.loadXML( strXml );
 }
arrFeaturesAggreg = oXmlDoc; 
arrFeaturesAggreg = oXmlDoc.getElementsByTagName('AggregationResults');
var arrFeaturesAggreg2 = oXmlDoc.getElementsByTagName('AggregationResults');
var arrFeaturesAggregName=arrFeaturesAggreg2[0].childNodes[0].nodeName;
var arrFeaturesAggreg3 = oXmlDoc.getElementsByTagName('AggregationResults')[0].childNodes[0].textContent;
finalData+=arrFeaturesAggregName+'='+arrFeaturesAggreg3+"; ";
if (document.getElementById('ChartOper_id'))
{
 var t=document.createElement('option');
t.value=arrFeaturesAggreg3;
t.text=arrFeaturesAggregName+'='+arrFeaturesAggreg3;
document.getElementById("ChartOper_id").appendChild(t);
popupChartS.autoSize=true;
popupChartS.updateSize();
}
else
{
document.getElementById('dataAggreg').value=finalData;
}
 },
 failure: function (response) {
 alert("Something went wrong in the request");
 }});
}
 if (!document.getElementById('ChartOper_id'))
 {
 popupAggreg.destroy();
 }
}
function htmlspecialchars(html) {

html = html.replace(/&/g, "&amp;");
html = html.replace(/</g, "&lt;");
html = html.replace(/>/g, "&gt;");
html = html.replace(/"/g, "&quot;");

return html;
}
function OK_Interpolation(selectMethod)
{
var selectMethod=selectMethod;

var resulArcGridnotInGeoserver=0;
 if(selectMethod=='1')
 {var radius_inter=document.getElementById("radius_inter").value;
var pixel_inter=document.getElementById("pixel_inter").value;
var Count_Col=document.getElementById("Count_Col").value;
popup_inter.hide();}
if(selectMethod=='2')
{
var noDataValue_inter=document.getElementById("noDataValue_inter").value; 
var interp_scale=document.getElementById("interp_id_scale").value;
var Count_Col2=document.getElementById("Count_Col2").value;
var pixelBarnes_inter=document.getElementById("pixelBarnes_inter").value;
var Barnes_from_value=document.getElementById("Barnes_from_value").value;
var Barnes_class=document.getElementById("Barnes_class").value;
var count_class_plus=parseFloat((maxValue_Interpolation-Barnes_from_value)/Barnes_class);
var ColorString='';
var start_Barnes_from_value=parseFloat(Barnes_from_value);
var r_color=254;255
var g_color=255;0
var b_color=255;0
r_color1=parseInt(r_color, 10).toString(16); 
g_color1=parseInt(g_color, 10).toString(16);
b_color1=parseInt(b_color, 10).toString(16);
ColorString+='<ColorMapEntry color="#0'+r_color1+g_color1+b_color1+'" quantity="'+parseFloat(start_Barnes_from_value).toFixed(3)+'" label="'+parseFloat(start_Barnes_from_value).toFixed(3)+'"/>'
for(var i=0; i<Barnes_class; ++i) 
{ 
var r_color2=r_color+Math.round(0.5*((i+1)/Barnes_class));
var g_color2=g_color-Math.round(255*((i+1)/Barnes_class)); 
var b_color2=b_color-Math.round(255*((i+1)/Barnes_class));
var F_color=''+parseInt(r_color2, 10).toString(16)+''+parseInt(g_color2, 10).toString(16)+''+parseInt(b_color2, 10).toString(16); 
start_Barnes_from_value=start_Barnes_from_value+count_class_plus 
if(i!==Barnes_class-1)
{
ColorString+='<ColorMapEntry color="#'+F_color+'" quantity="'+parseFloat(start_Barnes_from_value).toFixed(3)+'" label="'+parseFloat(start_Barnes_from_value).toFixed(3)+'"/>'}
else
{ColorString+='<ColorMapEntry color="#'+F_color+'00" quantity="'+parseFloat(start_Barnes_from_value).toFixed(3)+'" label="'+parseFloat(start_Barnes_from_value).toFixed(3)+'"/>'}
}
popupBarnes_inter.hide();}
popup_interW = new OpenLayers.Popup.FramedCloud("InterpolationPopup",
 map.getCenter(),
 new OpenLayers.Size(100,100),
 "Please wait.." ,
 null, true, onPopupClose);
 map.addPopup(popup_interW);
var FeaturesForStat=[];

for (var i=0; i<edilayerMainLayer.features.length; i++)
{if(isNaN(parseFloat(edilayerMainLayer.features[i].attributes[field_interpolation_Main]))==false)
{FeaturesForStat.push(edilayerMainLayer.features[i]);FeaturesForStat[FeaturesForStat.length-1].attributes[field_interpolation_Main]=parseFloat(edilayerMainLayer.features[i].attributes[field_interpolation_Main]);}
 }
if(FeaturesForStat.length==0){alert("selected field is not numeric. The total number of elements in the layer:"+edilayerMainLayer.features.length); if(popup_interW){popup_interW.destroy();}if(popup_inter){popup_inter.destroy();}return;}
var crcformat = new OpenLayers.Format.GeoJSON({}).createCRSObject(edilayerMainLayer.features[0]);
var format = new OpenLayers.Format.GeoJSON({});
var jsonstring = format.write(FeaturesForStat);
var DopStr='}],"crs":{ "type":"name","properties":{"name":"EPSG:900913"}}}';
var formatExp = new OpenLayers.Format.GeoJSON({'internalProjection': new OpenLayers.Projection("EPSG:900913"),
'externalProjection': new OpenLayers.Projection("EPSG:4326")
});
var DopStr2='}],"crs":{ "type":"name","properties":{"name":"EPSG:4326"}}}';
var jsonstringExp = formatExp.write(FeaturesForStat);
var NewjsonstringExp = jsonstringExp.replace(/}]}/,DopStr2);
 jsonstringExp=NewjsonstringExp;
jsonstringExpReadyExport='![CDATA['+jsonstringExp+']]'
var Newjsonstring = jsonstring.replace(/}]}/,DopStr);
jsonstring=Newjsonstring;
if(edilayerMainLayer.options.protocol)
{
 var sld_heat='<?xml version="1.0" encoding="ISO-8859-1"?>'+
 '<StyledLayerDescriptor version="1.0.0"'+
 ' xsi:schemaLocation="http://www.opengis.net/sld StyledLayerDescriptor.xsd"'+
 ' xmlns="http://www.opengis.net/sld"'+
 ' xmlns:ogc="http://www.opengis.net/ogc"'+
 ' xmlns:xlink="http://www.w3.org/1999/xlink"'+
 ' xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">'+
 '<NamedLayer>'+
 '<Name>'+edilayerMainLayer.options.protocol.featureNS.split('/data/')[1].split('/')[0]+':'+edilayerMainLayer.options.protocol.featureType+'</Name>'+
 '<UserStyle>'+
 '<Title>Heatmap</Title>'+
 '<Abstract>A heatmap surface showing population density</Abstract>'+
 '<FeatureTypeStyle>'+
 '<Transformation>'+
 '<ogc:Function name="gs:Heatmap">'+
 '<ogc:Function name="parameter">'+
 '<ogc:Literal>data</ogc:Literal>'+
 '</ogc:Function>'+
 '<ogc:Function name="parameter">'+
 '<ogc:Literal>weightAttr</ogc:Literal>'+
 '<ogc:Literal>'+field_interpolation_Main+'</ogc:Literal>'+
 '</ogc:Function>'+
 '<ogc:Function name="parameter">'+
 '<ogc:Literal>radiusPixels</ogc:Literal>'+
 '<ogc:Function name="env">'+
 '<ogc:Literal>radius</ogc:Literal>'+
 '<ogc:Literal>'+radius_inter+'</ogc:Literal>'+
 '</ogc:Function>'+
 '</ogc:Function>'+
 '<ogc:Function name="parameter">'+
 '<ogc:Literal>pixelsPerCell</ogc:Literal>'+
 '<ogc:Literal>'+pixel_inter+'</ogc:Literal>'+
 '</ogc:Function>'+
 '<ogc:Function name="parameter">'+
 '<ogc:Literal>outputBBOX</ogc:Literal>'+
 '<ogc:Function name="env">'+
 '<ogc:Literal>wms_bbox</ogc:Literal>'+
 '</ogc:Function>'+
 '</ogc:Function>'+
 '<ogc:Function name="parameter">'+
 ' <ogc:Literal>outputWidth</ogc:Literal>'+
 '<ogc:Function name="env">'+
 ' <ogc:Literal>wms_width</ogc:Literal>'+
 '</ogc:Function>'+
 '</ogc:Function>'+
 '<ogc:Function name="parameter">'+
 '<ogc:Literal>outputHeight</ogc:Literal>'+
 '<ogc:Function name="env">'+
 ' <ogc:Literal>wms_height</ogc:Literal>'+
 '</ogc:Function>'+
 '</ogc:Function>'+
 '</ogc:Function>'+
 '</Transformation>'+
 '<Rule>'+
 '<RasterSymbolizer>'+
 '<!-- specify geometry attribute of input to pass validation -->'+
 '<Geometry><ogc:PropertyName>the_geom</ogc:PropertyName></Geometry>'+
 '<Opacity>0.6</Opacity>'+
 '<ColorMap type="ramp" >'+
 '<ColorMapEntry color="#FFFFFF" quantity="0" label="nodata" opacity="0"/>'+
 '<ColorMapEntry color="#FFFFFF" quantity="0.02" label="nodata" opacity="0"/>'+
 '<ColorMapEntry color="#4444FF" quantity=".1" label="nodata"/>'+
 '<ColorMapEntry color="#FF0000" quantity=".5" label="values" />'+
 '<ColorMapEntry color="#FFFF00" quantity="1.0" label="values" />'+
 '</ColorMap>'+
 '</RasterSymbolizer>'+
 '</Rule>'+
 '</FeatureTypeStyle>'+
 '</UserStyle>'+
 '</NamedLayer>'+
 '</StyledLayerDescriptor>';
}
if(!edilayerMainLayer.protocol)
{
InterInterpBB=[];
InterInterpBBExp=[];
var minDistC = parseFloat(edilayerMainLayer.features[0].geometry.y);
 var maxDistC = parseFloat(minDistC) ;
 for (ia = 1; ia < edilayerMainLayer.features.length; ++ia) { var NumSS=edilayerMainLayer.features[ia].geometry.y;
 if (NumSS>parseFloat(maxDistC) ) {maxDistC = parseFloat(NumSS);}
 if( NumSS<parseFloat(minDistC) ) {minDistC = parseFloat(NumSS);}
 }
var minY=minDistC;
var maxY=maxDistC;
var minDistC = parseFloat(edilayerMainLayer.features[0].geometry.x);
 var maxDistC = parseFloat(minDistC) ;
 for (ia = 1; ia < edilayerMainLayer.features.length; ++ia) { var NumSS=edilayerMainLayer.features[ia].geometry.x;
 if (NumSS>parseFloat(maxDistC) ){ maxDistC = parseFloat(NumSS);}
 if( NumSS<parseFloat(minDistC) ) {minDistC = parseFloat(NumSS);}
 }
var minX=minDistC;
var maxX=maxDistC;
InterInterpBB.push(minX);
InterInterpBB.push(minY);
InterInterpBB.push(maxX);
InterInterpBB.push(maxY);
var pos=new OpenLayers.LonLat(minX, minY).transform(map.getProjectionObject(),new OpenLayers.Projection("EPSG:4326"));
var pos2=new OpenLayers.LonLat(maxX, maxY).transform(map.getProjectionObject(),new OpenLayers.Projection("EPSG:4326"));
InterInterpBBExp.push(pos.lon);
InterInterpBBExp.push(pos.lat);
InterInterpBBExp.push(pos2.lon);
InterInterpBBExp.push(pos2.lat);
if(selectMethod=='2'){
var t1=parseFloat((InterInterpBB[2]-InterInterpBB[0])/Count_Col2);
var CountRowst2=parseInt((InterInterpBB[3]-InterInterpBB[1])/t1);
}
if(selectMethod=='1'){
var t1=parseFloat((InterInterpBB[2]-InterInterpBB[0])/Count_Col);
var CountRowst2=parseInt((InterInterpBB[3]-InterInterpBB[1])/t1);
}
if(selectMethod=='1'){
var WPSInterpHeat='<?xml version="1.0" encoding="UTF-8"?>'+
'<wps:Execute version="1.0.0" service="WPS" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns="http://www.opengis.net/wps/1.0.0" '+
' xmlns:wfs="http://www.opengis.net/wfs" xmlns:wps="http://www.opengis.net/wps/1.0.0" xmlns:ows="http://www.opengis.net/ows/1.1" xmlns:gml="http://www.opengis.net/gml" '+
'xmlns:ogc="http://www.opengis.net/ogc" xmlns:wcs="http://www.opengis.net/wcs/1.1.1" xmlns:xlink="http://www.w3.org/1999/xlink" xsi:schemaLocation="http://www.opengis.net/wps/1.0.0 http://schemas.opengis.net/wps/1.0.0/wpsAll.xsd">'+
'<ows:Identifier>gs:Heatmap</ows:Identifier>'+
'<wps:DataInputs>'+
'<wps:Input>'+
'<ows:Identifier>data</ows:Identifier>'+
'<wps:Data>'+
'<wps:ComplexData mimeType="application/json"><![CDATA['+jsonstring+']]></wps:ComplexData>'+
'</wps:Data>'+
'</wps:Input>'+
'<wps:Input>'+
'<ows:Identifier>radiusPixels</ows:Identifier>'+
'<wps:Data>'+
'<wps:LiteralData>'+radius_inter+'</wps:LiteralData>'+
'</wps:Data>'+
'</wps:Input>'+
'<wps:Input>'+
'<ows:Identifier>weightAttr</ows:Identifier>'+
'<wps:Data>'+
'<wps:LiteralData>'+field_interpolation_Main+'</wps:LiteralData>'+
'</wps:Data>'+
'</wps:Input>'+
'<wps:Input>'+
'<ows:Identifier>pixelsPerCell</ows:Identifier>'+
'<wps:Data>'+
'<wps:LiteralData>'+pixel_inter+'</wps:LiteralData>'+
'</wps:Data>'+
'</wps:Input>'+
'<wps:Input>'+
'<ows:Identifier>outputBBOX</ows:Identifier>'+
'<wps:Data>'+
'<wps:BoundingBoxData crs="EPSG:900913" dimensions="2">'+
'<ows:LowerCorner>'+InterInterpBB[0]+' '+InterInterpBB[1]+'</ows:LowerCorner>'+
'<ows:UpperCorner>'+InterInterpBB[2]+' '+InterInterpBB[3]+'</ows:UpperCorner>'+
'</wps:BoundingBoxData>'+
'</wps:Data>'+
'</wps:Input>'+
'<wps:Input>'+
'<ows:Identifier>outputWidth</ows:Identifier>'+
'<wps:Data>'+
'<wps:LiteralData>'+CountRowst2+'</wps:LiteralData>'+
'</wps:Data>'+
'</wps:Input>'+
'<wps:Input>'+
'<ows:Identifier>outputHeight</ows:Identifier>'+
'<wps:Data>'+
'<wps:LiteralData>'+Count_Col+'</wps:LiteralData>'+
'</wps:Data>'+
'</wps:Input>'+
'</wps:DataInputs>'+
'<wps:ResponseForm>'+
'<wps:RawDataOutput mimeType="application/arcgrid">'+
'<ows:Identifier>result</ows:Identifier>'+
'</wps:RawDataOutput>'+
'</wps:ResponseForm>'+
'</wps:Execute>';
}
if(selectMethod=='2'){
var WPSInterpAt='<?xml version="1.0" encoding="UTF-8"?>'+
'<wps:Execute version="1.0.0" service="WPS" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" '+
'xmlns="http://www.opengis.net/wps/1.0.0" xmlns:wfs="http://www.opengis.net/wfs" '+
'xmlns:wps="http://www.opengis.net/wps/1.0.0" xmlns:ows="http://www.opengis.net/ows/1.1" '+
'xmlns:gml="http://www.opengis.net/gml" '+
'xmlns:ogc="http://www.opengis.net/ogc" '+
'xmlns:wcs="http://www.opengis.net/wcs/1.1.1" '+
'xmlns:xlink="http://www.w3.org/1999/xlink" xsi:schemaLocation="http://www.opengis.net/wps/1.0.0 http://schemas.opengis.net/wps/1.0.0/wpsAll.xsd">'+
'<ows:Identifier>gs:BarnesSurface</ows:Identifier>'+
'<wps:DataInputs>'+
'<wps:Input>'+
'<ows:Identifier>data</ows:Identifier>'+
'<wps:Data>'+
'<wps:ComplexData mimeType="application/json"><![CDATA['+jsonstring+']]></wps:ComplexData>'+
' </wps:Data>'+
'</wps:Input>'+
'<wps:Input>'+
'<ows:Identifier>valueAttr</ows:Identifier>'+
'<wps:Data>'+
'<wps:LiteralData>'+field_interpolation_Main+'</wps:LiteralData>'+
'</wps:Data>'+
'</wps:Input>'+
'<wps:Input>'+
'<ows:Identifier>scale</ows:Identifier>'+
'<wps:Data>'+
'<wps:LiteralData>'+parseFloat(interp_scale*1000000)+'</wps:LiteralData>'+
'</wps:Data>'+
'</wps:Input>'+
'<wps:Input>'+
'<ows:Identifier>noDataValue</ows:Identifier>'+
'<wps:Data>'+
'<wps:LiteralData>'+noDataValue_inter+'</wps:LiteralData>'+
'</wps:Data>'+
'</wps:Input>'+
'<wps:Input>'+
'<ows:Identifier>pixelsPerCell</ows:Identifier>'+
'<wps:Data>'+
'<wps:LiteralData>'+pixelBarnes_inter+'</wps:LiteralData>'+
'</wps:Data>'+
'</wps:Input>'+
'<wps:Input>'+
'<ows:Identifier>outputBBOX</ows:Identifier>'+
'<wps:Data>'+
'<wps:BoundingBoxData crs="EPSG:900913" dimensions="2">'+
'<ows:LowerCorner>'+InterInterpBB[0]+' '+InterInterpBB[1]+'</ows:LowerCorner>'+
'<ows:UpperCorner>'+InterInterpBB[2]+' '+InterInterpBB[3]+'</ows:UpperCorner>'+
'</wps:BoundingBoxData>'+
'</wps:Data>'+
'</wps:Input>'+
'<wps:Input>'+
'<ows:Identifier>outputWidth</ows:Identifier>'+
'<wps:Data>'+
'<wps:LiteralData>'+CountRowst2+'</wps:LiteralData>'+
'</wps:Data>'+
'</wps:Input>'+
'<wps:Input>'+
'<ows:Identifier>outputHeight</ows:Identifier>'+
'<wps:Data>'+
'<wps:LiteralData>'+Count_Col2+'</wps:LiteralData>'+
'</wps:Data>'+
'</wps:Input>'+
'</wps:DataInputs>'+
'<wps:ResponseForm>'+
'<wps:RawDataOutput mimeType="application/arcgrid">'+
'<ows:Identifier>result</ows:Identifier>'+
'</wps:RawDataOutput>'+
'</wps:ResponseForm>'+
'</wps:Execute>';
}
var strPost='';
if(selectMethod=='2')
{strPost=WPSInterpAt;}
if(selectMethod=='1')
{strPost=WPSInterpHeat;}
alert("Эта функция работает только в онлайн веб-версии OpenWebGIS")
 {return;}
var request = OpenLayers.Request.POST({
 url: "/geoserver/wps",
 async: false,
 data: strPost,
 headers: {
 "Content-Type": "text/xml;charset=utf-8"
 },
 callback: function (response) {
resulArcGridnotInGeoserver=response.responseText;
/*
*/
 },
 failure: function (response) {
 alert("Something went wrong in the request");
 }});

if(selectMethod=='1')
{if(document.getElementById("heatmap_export_value")&&document.getElementById("heatmap_export_value").checked==true)
{
var txt='![CDATA['+jsonstring+']]>';
 strPost = strPost.replace(txt,'![CDATA['+jsonstringExp+']]>');
var txt='<ows:LowerCorner>'+InterInterpBB[0]+' '+InterInterpBB[1]+'</ows:LowerCorner>';
 strPost = strPost.replace(txt,'<ows:LowerCorner>'+InterInterpBBExp[0]+' '+InterInterpBBExp[1]+'</ows:LowerCorner>');
var txt='<ows:UpperCorner>'+InterInterpBB[2]+' '+InterInterpBB[3]+'</ows:UpperCorner>';
 strPost = strPost.replace(txt,'<ows:UpperCorner>'+InterInterpBBExp[2]+' '+InterInterpBBExp[3]+'</ows:UpperCorner>');
var txt='<wps:BoundingBoxData crs="'+edilayerMainLayer.projection.projCode+'" dimensions="2">';
strPost = strPost.replace(txt,'<wps:BoundingBoxData crs="EPSG:4326" dimensions="2">');
alert("Эта функция работает только в онлайн веб-версии OpenWebGIS")
 {return;}
var requestExp2 = OpenLayers.Request.POST({
 url: "/geoserver/wps",
 async: false,
 data: strPost,
 headers: {
 "Content-Type": "text/xml;charset=utf-8"
 },
 callback: function (response) {
 var resulArcGridnotInGeoserverExp=response.responseText;
kmlText2=resulArcGridnotInGeoserverExp;
init_download();//myWinExport= open("download.html", "Export vector layer","width=900,height=500,status=no,toolbar=no,menubar=no,scrollbars=yes");myWinExport.focus();
rtt=resulArcGridnotInGeoserverExp;
 },
 failure: function (response) {
 alert("Something went wrong in the request");
 }});

}}
if(selectMethod=='2'){
 if(document.getElementById("Barnes_export_value")&&document.getElementById("Barnes_export_value").checked==true)
 {
var txt='![CDATA['+jsonstring+']]>';
 strPost = strPost.replace(txt,'![CDATA['+jsonstringExp+']]>');
var txt='<ows:LowerCorner>'+InterInterpBB[0]+' '+InterInterpBB[1]+'</ows:LowerCorner>';
 strPost = strPost.replace(txt,'<ows:LowerCorner>'+InterInterpBBExp[0]+' '+InterInterpBBExp[1]+'</ows:LowerCorner>');
var txt='<ows:UpperCorner>'+InterInterpBB[2]+' '+InterInterpBB[3]+'</ows:UpperCorner>';
 strPost = strPost.replace(txt,'<ows:UpperCorner>'+InterInterpBBExp[2]+' '+InterInterpBBExp[3]+'</ows:UpperCorner>');
var txt='<wps:BoundingBoxData crs="'+edilayerMainLayer.projection.projCode+'" dimensions="2">';
strPost = strPost.replace(txt,'<wps:BoundingBoxData crs="EPSG:4326" dimensions="2">');
var txt='<wps:LiteralData>'+parseFloat(interp_scale*1000000)+'</wps:LiteralData>';
strPost = strPost.replace(txt,'<wps:LiteralData>'+parseFloat(interp_scale)+'</wps:LiteralData>');
alert("Эта функция работает только в онлайн веб-версии OpenWebGIS")
 {return;}
var requestExp2 = OpenLayers.Request.POST({
 url: "/geoserver/wps",
 async: false,
 data: strPost,
 headers: {
 "Content-Type": "text/xml;charset=utf-8"
 },
 callback: function (response) {
 var resulArcGridnotInGeoserverExp=response.responseText;
kmlText2=resulArcGridnotInGeoserverExp;
init_download();//myWinExport= open("download.html", "Export vector layer","width=900,height=500,status=no,toolbar=no,menubar=no,scrollbars=yes");myWinExport.focus();
rtt=resulArcGridnotInGeoserverExp;
 },
 failure: function (response) {
 alert("Something went wrong in the request");
 }});
 }}
 
var strAsPointCollection='<?xml version="1.0" encoding="UTF-8"?>'+
'<wps:Execute version="1.0.0" service="WPS" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns="http://www.opengis.net/wps/1.0.0" xmlns:wfs="http://www.opengis.net/wfs" '+
'xmlns:wps="http://www.opengis.net/wps/1.0.0" xmlns:ows="http://www.opengis.net/ows/1.1" xmlns:gml="http://www.opengis.net/gml" xmlns:ogc="http://www.opengis.net/ogc"'+
' xmlns:wcs="http://www.opengis.net/wcs/1.1.1" xmlns:xlink="http://www.w3.org/1999/xlink" '+
'xsi:schemaLocation="http://www.opengis.net/wps/1.0.0 http://schemas.opengis.net/wps/1.0.0/wpsAll.xsd">'+
 '<ows:Identifier>gs:RasterAsPointCollection</ows:Identifier>'+
 '<wps:DataInputs>'+
 '<wps:Input>'+
 '<ows:Identifier>data</ows:Identifier>'+
 '<wps:Data>'+
 ' <wps:ComplexData mimeType="application/arcgrid"><![CDATA['+resulArcGridnotInGeoserver+']]></wps:ComplexData>'+
 ' </wps:Data>'+
 ' </wps:Input>'+
 ' </wps:DataInputs>'+
 '<wps:ResponseForm>'+
 '<wps:RawDataOutput mimeType="application/json">'+
 '<ows:Identifier>result</ows:Identifier>'+
 ' </wps:RawDataOutput>'+
 ' </wps:ResponseForm>'+
'</wps:Execute>';
alert("Эта функция работает только в онлайн веб-версии OpenWebGIS")
 {return;}
var request = OpenLayers.Request.POST({
 url: "/geoserver/wps",
 async: false,
 data: strAsPointCollection,
 headers: {
 "Content-Type": "text/xml;charset=utf-8"
 },
 callback: function (response) {
resulArcGridnotInGeoserver=response.responseText;endPart();
 },
 failure: function (response) {
 alert("Something went wrong in the request");
 }});

var nameL=document.getElementById("Id_InterlayerNameAtl").value;
var new_layer_G = new OpenLayers.Layer.Vector(nameL,{renderers:["Canvas", "SVG", "VML"]});
var format2 = new OpenLayers.Format.GeoJSON({ 
});
var newfeatures=format2.read(resulArcGridnotInGeoserver)
new_layer_G.addFeatures(newfeatures);
new_layer_G.projection=new OpenLayers.Projection("EPSG:900913");
new_layer_G.events.register("loadstart",new_layer_G, function() {WaitWindow();});
map.addLayer(new_layer_G);
new_layer_G.events.register("loadend",new_layer_G, function() {if(popup_Wait){try{popup_Wait.destroy();}catch(e){};} });
 var t=this.document.createElement('option');
t.value=new_layer_G.name;
t.text=new_layer_G.name;
this.document.getElementById("editL1").appendChild(t);
Interpolation_L=new_layer_G;
if(selectMethod=='1'){if(popup_inter){popup_inter.destroy();}}else
{
if(popupBarnes_inter){popupBarnes_inter.destroy();}
}
return;
}
if(edilayerMainLayer.options.protocol){
var sld_barnes='<?xml version="1.0" encoding="ISO-8859-1"?>'+
 '<StyledLayerDescriptor version="1.0.0"'+
' xsi:schemaLocation="http://www.opengis.net/sld StyledLayerDescriptor.xsd"'+
' xmlns="http://www.opengis.net/sld"'+
' xmlns:ogc="http://www.opengis.net/ogc"'+
' xmlns:xlink="http://www.w3.org/1999/xlink"'+
' xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">'+
 '<NamedLayer>'+
 '<Name>'+edilayerMainLayer.options.protocol.featureNS.split('/data/')[1].split('/')[0]+':'+edilayerMainLayer.options.protocol.featureType+'</Name>'+
 '<UserStyle>'+
 '<Title>Barnes Surface</Title>'+
// '<Abstract>A style that produces a Barnes surface using a rendering transformation</Abstract>'+
 '<FeatureTypeStyle>'+
 '<Transformation>'+
 '<ogc:Function name="gs:BarnesSurface">'+
 '<ogc:Function name="parameter">'+
 ' <ogc:Literal>data</ogc:Literal>'+
 '</ogc:Function>'+
 '<ogc:Function name="parameter">'+
 '<ogc:Literal>valueAttr</ogc:Literal>'+
 ' <ogc:Literal>'+field_interpolation_Main+'</ogc:Literal>'+
 '</ogc:Function>'+
 '<ogc:Function name="parameter">'+
 '<ogc:Literal>scale</ogc:Literal>'+
 '<ogc:Literal>'+interp_scale+'</ogc:Literal>'+
 '</ogc:Function>'+
//'<ogc:Function name="parameter">'+
//'<ogc:Literal>convergence</ogc:Literal>'+
 //'<ogc:Literal>0.3</ogc:Literal>'+
//'</ogc:Function>'+
//'<ogc:Function name="parameter">'+
//'<ogc:Literal>passes</ogc:Literal>'+
//'<ogc:Literal>2</ogc:Literal>'+
//'</ogc:Function>'+
//'<ogc:Function name="parameter">'+
//'<ogc:Literal>minObservations</ogc:Literal>'+
//'<ogc:Literal>2</ogc:Literal>'+
//'</ogc:Function>'+
//'<ogc:Function name="parameter">'+
//'<ogc:Literal>maxObservationDistance</ogc:Literal>'+
//'<ogc:Literal>0</ogc:Literal>'+
//'</ogc:Function>'+
'<ogc:Function name="parameter">'+
 '<ogc:Literal>noDataValue</ogc:Literal>'+
 '<ogc:Literal>'+noDataValue_inter+'</ogc:Literal>'+
 '</ogc:Function>'+
'<ogc:Function name="parameter">'+
 '<ogc:Literal>pixelsPerCell</ogc:Literal>'+
 '<ogc:Literal>'+pixelBarnes_inter+'</ogc:Literal>'+
 ' </ogc:Function>'+
// '<ogc:Function name="parameter">'+
// '<ogc:Literal>queryBuffer</ogc:Literal>'+
//'<ogc:Literal>40</ogc:Literal>'+
//'</ogc:Function>'+
 '<ogc:Function name="parameter">'+
 '<ogc:Literal>outputBBOX</ogc:Literal>'+
 '<ogc:Function name="env">'+
 '<ogc:Literal>wms_bbox</ogc:Literal>'+
 '</ogc:Function>'+
 '</ogc:Function>'+
 '<ogc:Function name="parameter">'+
 '<ogc:Literal>outputWidth</ogc:Literal>'+
 '<ogc:Function name="env">'+
 '<ogc:Literal>wms_width</ogc:Literal>'+
 '</ogc:Function>'+
 '</ogc:Function>'+
 '<ogc:Function name="parameter">'+
 '<ogc:Literal>outputHeight</ogc:Literal>'+
 '<ogc:Function name="env">'+
 '<ogc:Literal>wms_height</ogc:Literal>'+
 '</ogc:Function>'+
 '</ogc:Function>'+
 '</ogc:Function>'+
 '</Transformation>'+
'<Rule>'+
'<RasterSymbolizer>'+
'<Geometry><ogc:PropertyName>the_geom</ogc:PropertyName></Geometry>'+
'<Opacity>0.9</Opacity>'+
'<ColorMap type="ramp" >'+
'<ColorMapEntry color="#FFFFFF" quantity="'+noDataValue_inter+'" label="nodata" opacity="0"/>'+
ColorString+
'</ColorMap>'+
'</RasterSymbolizer>'+
 '</Rule>'+
 '</FeatureTypeStyle>'+
 '</UserStyle>'+
 '</NamedLayer>'+
 '</StyledLayerDescriptor>';
sld_heat2='<?xml version="1.0" encoding="ISO-8859-1"?>'+
 '<StyledLayerDescriptor version="1.0.0"'+
 ' xsi:schemaLocation="http://www.opengis.net/sld StyledLayerDescriptor.xsd"'+
 ' xmlns="http://www.opengis.net/sld"'+
 ' xmlns:ogc="http://www.opengis.net/ogc"'+
 ' xmlns:xlink="http://www.w3.org/1999/xlink"'+
 ' xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">'+
 '<NamedLayer>'+
 '<Name>sf:sfdem</Name>'+
 '<UserStyle>'+
 '<Title>Heatmap</Title>'+
 '<Abstract>A heatmap surface showing population density</Abstract>'+
 '<FeatureTypeStyle>'+
 '<Rule>'+
 '<RasterSymbolizer>'+
 '<Opacity>0.6</Opacity>'+
 '<ColorMap type="ramp" >'+
 '<ColorMapEntry color="#FFFFFF" quantity="0" label="nodata" opacity="0"/>'+
 '<ColorMapEntry color="#4444FF" quantity=".1" label="0.1"/>'+
 '<ColorMapEntry color="#FF0000" quantity=".5" label="0.5"/>'+
 '<ColorMapEntry color="#FFFF00" quantity="1.0" label="1"/>'+
 '</ColorMap>'+
 '</RasterSymbolizer>'+
 '</Rule>'+
 '</FeatureTypeStyle>'+
 '</UserStyle>'+
 '</NamedLayer>'+
 '</StyledLayerDescriptor>';
sld_barnes2='<?xml version="1.0" encoding="ISO-8859-1"?>'+
 '<StyledLayerDescriptor version="1.0.0"'+
 ' xsi:schemaLocation="http://www.opengis.net/sld StyledLayerDescriptor.xsd"'+
 ' xmlns="http://www.opengis.net/sld"'+
 ' xmlns:ogc="http://www.opengis.net/ogc"'+
 ' xmlns:xlink="http://www.w3.org/1999/xlink"'+
 ' xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">'+
 '<NamedLayer>'+
 '<Name>sf:sfdem</Name>'+
 '<UserStyle>'+
 '<Title>Barnes surface</Title>'+
 '<Abstract>A style that produces a Barnes surface using a rendering transformation</Abstract>'+
 '<FeatureTypeStyle>'+
 '<Rule>'+
 '<RasterSymbolizer>'+
 '<Opacity>0.6</Opacity>'+
 '<ColorMap type="ramp" >'+
 ' <ColorMapEntry color="#FFFFFF" quantity="'+noDataValue_inter+'" label="nodata" opacity="0"/>'+
 ColorString+
 '</ColorMap>'+
 '</RasterSymbolizer>'+
 '</Rule>'+
 '</FeatureTypeStyle>'+
 '</UserStyle>'+
 '</NamedLayer>'+
 '</StyledLayerDescriptor>';
 }
 if(resulArcGridnotInGeoserver==0)
{
if(selectMethod=='1')
{sld_heat=sld_heat;}else{sld_heat=sld_barnes;}
var nameL=document.getElementById("Id_InterlayerNameAtl").value;
Interpolation_L= new OpenLayers.Layer.WMS(nameL,'/geoserver/wms',{ layers: edilayerMainLayer.options.protocol.featureNS.split('/data/')[1].split('/')[0]+':'+edilayerMainLayer.options.protocol.featureType,transparent:true,sld_body:sld_heat,STYLES:''},
{ buffer: 0,
 singleTile:true, 
tileOptions: {maxGetUrlLength: 20},
opacity:0.7,
displayOutsideMaxExtent: true,
isBaseLayer:false,
projection: new OpenLayers.Projection("EPSG:900913"),
displayProjection : new OpenLayers.Projection("EPSG:4326")
 }
);
 }
else
{}
Interpolation_L.events.register("loadstart",Interpolation_L, function()
 {popup_Wait2 = new OpenLayers.Popup.FramedCloud("WaitPopup_"+Interpolation_L.id,
 map.getCenter(),
 new OpenLayers.Size(100,100),
 "<div style='color:#000080;'>Please wait...<div>" ,
 null, true, onPopupClose);
 map.addPopup(popup_Wait2);
}); 
if(resulArcGridnotInGeoserver==0)
{map.addLayer(Interpolation_L);}
Interpolation_L.events.register("loadend",Interpolation_L, function() {if(document.getElementById("WaitPopup_"+Interpolation_L.id))
{document.getElementById("WaitPopup_"+Interpolation_L.id).parentNode.removeChild(document.getElementById("WaitPopup_"+Interpolation_L.id));} });
 setTimeout("endPart()", 7000);//map.removePopup(popup_inter); 
if(edilayerMainLayer.options.protocol)
{if(selectMethod=='1')
{sld_heat2=sld_heat2;}else{sld_heat2=sld_barnes2;}
var htmlText2='<a><img src="/geoserver/wms?REQUEST=GetLegendGraphic&VERSION=1.0.0&FORMAT=image/png&WIDTH=50&HEIGHT=50&LAYER=sf:sfdem&sld_body='+encodeURIComponent(sld_heat2)+'&LEGEND_OPTIONS=fontSize:28" width="120" height="'+parseInt(40)*parseInt(Barnes_class)+'" alt="legend"/></a>';
if(selectMethod=='1')
{ htmlText2='<a><img src="/geoserver/wms?REQUEST=GetLegendGraphic&VERSION=1.0.0&FORMAT=image/png&WIDTH=50&HEIGHT=50&LAYER=sf:sfdem&sld_body='+encodeURIComponent(sld_heat2)+'&LEGEND_OPTIONS=fontSize:28" width="90" height="120" alt="legend"/></a>';
}
 }//end if(edilayerMainLayer.options.protocol) (1)
if(selectMethod=='1')
{
 if(document.getElementById("heatmap_export_value").checked==true)
 {
var t1=parseFloat((InterInterpBB[2]-InterInterpBB[0])/Count_Col);
var CountRowst2=parseInt((InterInterpBB[3]-InterInterpBB[1])/t1);

var strHeatGis='<?xml version="1.0" encoding="UTF-8"?>'+
'<wps:Execute version="1.0.0" service="WPS" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns="http://www.opengis.net/wps/1.0.0" '+
' xmlns:wfs="http://www.opengis.net/wfs" xmlns:wps="http://www.opengis.net/wps/1.0.0" xmlns:ows="http://www.opengis.net/ows/1.1" xmlns:gml="http://www.opengis.net/gml" '+
'xmlns:ogc="http://www.opengis.net/ogc" xmlns:wcs="http://www.opengis.net/wcs/1.1.1" xmlns:xlink="http://www.w3.org/1999/xlink" xsi:schemaLocation="http://www.opengis.net/wps/1.0.0 http://schemas.opengis.net/wps/1.0.0/wpsAll.xsd">'+
'<ows:Identifier>gs:Heatmap</ows:Identifier>'+
'<wps:DataInputs>'+
'<wps:Input>'+
'<ows:Identifier>data</ows:Identifier>'+
'<wps:Data>'+
'<wps:ComplexData mimeType="application/json"><'+jsonstringExpReadyExport+'></wps:ComplexData>'+
'</wps:Data>'+
'</wps:Input>'+
'<wps:Input>'+
'<ows:Identifier>radiusPixels</ows:Identifier>'+
'<wps:Data>'+
'<wps:LiteralData>'+radius_inter+'</wps:LiteralData>'+
'</wps:Data>'+
'</wps:Input>'+
'<wps:Input>'+
'<ows:Identifier>weightAttr</ows:Identifier>'+
'<wps:Data>'+
'<wps:LiteralData>'+field_interpolation_Main+'</wps:LiteralData>'+
'</wps:Data>'+
'</wps:Input>'+
'<wps:Input>'+
'<ows:Identifier>pixelsPerCell</ows:Identifier>'+
'<wps:Data>'+
'<wps:LiteralData>'+pixel_inter+'</wps:LiteralData>'+
'</wps:Data>'+
'</wps:Input>'+
'<wps:Input>'+
'<ows:Identifier>outputBBOX</ows:Identifier>'+
'<wps:Data>'+
'<wps:BoundingBoxData crs="EPSG:4326" dimensions="2">'+
'<ows:LowerCorner>'+InterInterpBB[0]+' '+InterInterpBB[1]+'</ows:LowerCorner>'+
'<ows:UpperCorner>'+InterInterpBB[2]+' '+InterInterpBB[3]+'</ows:UpperCorner>'+
'</wps:BoundingBoxData>'+
'</wps:Data>'+
'</wps:Input>'+
'<wps:Input>'+
'<ows:Identifier>outputWidth</ows:Identifier>'+
'<wps:Data>'+
'<wps:LiteralData>'+CountRowst2+'</wps:LiteralData>'+
'</wps:Data>'+
'</wps:Input>'+
'<wps:Input>'+
'<ows:Identifier>outputHeight</ows:Identifier>'+
'<wps:Data>'+
'<wps:LiteralData>'+Count_Col+'</wps:LiteralData>'+
'</wps:Data>'+
'</wps:Input>'+
'</wps:DataInputs>'+
'<wps:ResponseForm>'+
'<wps:RawDataOutput mimeType="application/arcgrid">'+
'<ows:Identifier>result</ows:Identifier>'+
'</wps:RawDataOutput>'+
'</wps:ResponseForm>'+
'</wps:Execute>';
alert("Эта функция работает только в онлайн веб-версии OpenWebGIS")
 {return;}
var requestHeat = OpenLayers.Request.POST({
 url: "/geoserver/wps",
 async: false,
 data: strHeatGis,
 headers: {
 "Content-Type": "text/xml;charset=utf-8"
 },
 callback: function (response) {
 var result=response.responseText;
kmlText2=result;

init_download();//myWinExport= open("download.html", "Export to Arcgrid","width=900,height=500,status=no,toolbar=no,menubar=no,scrollbars=yes");myWinExport.focus();
//rtt=resulArcGridnotInGeoserverExp;
 },
 failure: function (response) {
 alert("Something went wrong in the request");
 }});

}}
 if(edilayerMainLayer.options.protocol){//(2)
if(selectMethod=='2')
{
 if(document.getElementById("Barnes_export_value").checked==true)
 {
var t1=parseFloat((InterInterpBB[2]-InterInterpBB[0])/Count_Col2);
var CountRowst2=parseInt((InterInterpBB[3]-InterInterpBB[1])/t1);


var strWPSBarnesExport='<?xml version="1.0" encoding="UTF-8"?>'+
'<wps:Execute version="1.0.0" service="WPS" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" '+
'xmlns="http://www.opengis.net/wps/1.0.0" xmlns:wfs="http://www.opengis.net/wfs" '+
'xmlns:wps="http://www.opengis.net/wps/1.0.0" xmlns:ows="http://www.opengis.net/ows/1.1" '+
'xmlns:gml="http://www.opengis.net/gml" '+
'xmlns:ogc="http://www.opengis.net/ogc" '+
'xmlns:wcs="http://www.opengis.net/wcs/1.1.1" '+
'xmlns:xlink="http://www.w3.org/1999/xlink" xsi:schemaLocation="http://www.opengis.net/wps/1.0.0 http://schemas.opengis.net/wps/1.0.0/wpsAll.xsd">'+
'<ows:Identifier>gs:BarnesSurface</ows:Identifier>'+
'<wps:DataInputs>'+
'<wps:Input>'+
'<ows:Identifier>data</ows:Identifier>'+
'<wps:Data>'+
'<wps:ComplexData mimeType="application/json"><'+jsonstringExpReadyExport+'></wps:ComplexData>'+
' </wps:Data>'+
'</wps:Input>'+
'<wps:Input>'+
'<ows:Identifier>valueAttr</ows:Identifier>'+
'<wps:Data>'+
'<wps:LiteralData>'+field_interpolation_Main+'</wps:LiteralData>'+
'</wps:Data>'+
'</wps:Input>'+
'<wps:Input>'+
'<ows:Identifier>scale</ows:Identifier>'+
'<wps:Data>'+
'<wps:LiteralData>'+interp_scale+'</wps:LiteralData>'+
'</wps:Data>'+
'</wps:Input>'+
'<wps:Input>'+
'<ows:Identifier>noDataValue</ows:Identifier>'+
'<wps:Data>'+
'<wps:LiteralData>'+noDataValue_inter+'</wps:LiteralData>'+
'</wps:Data>'+
'</wps:Input>'+
'<wps:Input>'+
'<ows:Identifier>pixelsPerCell</ows:Identifier>'+
'<wps:Data>'+
'<wps:LiteralData>'+pixelBarnes_inter+'</wps:LiteralData>'+
'</wps:Data>'+
'</wps:Input>'+
'<wps:Input>'+
'<ows:Identifier>outputBBOX</ows:Identifier>'+
'<wps:Data>'+
'<wps:BoundingBoxData crs="EPSG:4326" dimensions="2">'+
'<ows:LowerCorner>'+InterInterpBB[0]+' '+InterInterpBB[1]+'</ows:LowerCorner>'+
'<ows:UpperCorner>'+InterInterpBB[2]+' '+InterInterpBB[3]+'</ows:UpperCorner>'+
'</wps:BoundingBoxData>'+
'</wps:Data>'+
'</wps:Input>'+
'<wps:Input>'+
'<ows:Identifier>outputWidth</ows:Identifier>'+
'<wps:Data>'+
'<wps:LiteralData>'+CountRowst2+'</wps:LiteralData>'+
'</wps:Data>'+
'</wps:Input>'+
'<wps:Input>'+
'<ows:Identifier>outputHeight</ows:Identifier>'+
'<wps:Data>'+
'<wps:LiteralData>'+Count_Col2+'</wps:LiteralData>'+
'</wps:Data>'+
'</wps:Input>'+
'</wps:DataInputs>'+
'<wps:ResponseForm>'+
'<wps:RawDataOutput mimeType="application/arcgrid">'+
'<ows:Identifier>result</ows:Identifier>'+
'</wps:RawDataOutput>'+
'</wps:ResponseForm>'+
'</wps:Execute>';
alert("Эта функция работает только в онлайн веб-версии OpenWebGIS")
 {return;}
var requestBarnes = OpenLayers.Request.POST({
 url: "/geoserver/wps",
 async: false,
 data: strWPSBarnesExport,
 headers: {
 "Content-Type": "text/xml;charset=utf-8"
 },
 callback: function (response) {
 var result=response.responseText;
kmlText2=result;
init_download();//myWinExport= open("download.html", "Export to Arcgrid","width=900,height=500,status=no,toolbar=no,menubar=no,scrollbars=yes");myWinExport.focus();
//rtt=resulArcGridnotInGeoserverExp;
 },
 failure: function (response) {
 alert("Something went wrong in the request");
 }});




 }
}}
if(selectMethod=='1'){popup_inter.destroy();}else
{//map.removePopup(popupBarnes_inter);
if(popupBarnes_inter){popupBarnes_inter.destroy();}
}
var new_pos=new OpenLayers.LonLat(0.6, 0).transform(
new OpenLayers.Projection("EPSG:4326"),
map.getProjectionObject());
var new_lon=new_pos.lon;
var new_lat=new_pos.lat;
var new_new_pos=new OpenLayers.LonLat(map.getCenter().lon+new_lon,map.getCenter().lat+new_lat);
popup_inter2 = new OpenLayers.Popup("InterpolationPopupLeg",
 new_new_pos,
 new OpenLayers.Size(100,100),
 htmlText2 ,
 true, onPopupClose);
if(edilayerMainLayer.options.protocol) 
 {map.addPopup(popup_inter2);
document.getElementById("InterpolationPopupLeg").onmousedown=function(event){drags(event)};
document.getElementById("InterpolationPopupLeg").onmouseup=function(e){enddrag()};
popup_inter2.autoSize=true;
popup_inter2.updateSize();}
}
function NewfromSelect_Layer()
{
var bbox = document.getElementById("map").getBoundingClientRect();
 var body = document.body
 var docElem = document.documentElement
 var scrollTop = window.pageYOffset || docElem.scrollTop || body.scrollTop
 var scrollLeft = window.pageXOffset || docElem.scrollLeft || body.scrollLeft
 var clientTop = docElem.clientTop || body.clientTop || 0
 var clientLeft = docElem.clientLeft || body.clientLeft || 0
 var topTop = bbox.top + scrollTop - clientTop
 var leftLeft = bbox.left + scrollLeft - clientLeft
var DivEditeLeg=document.createElement("div");
DivEditeLeg.id="id_divSelecMain2";
DivEditeLeg.className="id_divSelecMain";
DivEditeLeg.style.position="relative";
DivEditeLeg.innerHTML='<div id="id_divSelecLeg" style="background:#ffffff; color:#0000ff;z-index: 6000;position:absolute;left:'+Math.round(leftLeft+50)+'px;top:'+Math.round(topTop+20)+
'px;overflow:hidden; border: 1px solid black;"><img onclick="closeSelecWin()" src="openlayers/theme/default/img/close.gif" style="position:relative; top:10px;float:right; cursor:pointer"><a style="position:relative; top:20px"></a>'+
'<a style="font-size: 9px;">Вы можете перемещать это окно если щёлкните по пункту меню: переключить режим интерфейса/</a><br>'+
'<a style="font-size: 11px;">Фильтровать или выделять элементы Редактируемого слоя</a><br>'+
'Название слоя<input type="text" size="25" id="CQLfilter_id_Name" value="SelectFilterLayer"/><br>'+
'<br>'+
'<a href="http://en.wikipedia.org/wiki/Contextual_Query_Language" target="_blank">CQL</a> <a href="http://docs.geotools.org/stable/userguide/library/cql/index.html" target="_blank">фильтр</a><input title="Введите условие фильтрации,например: названиеПоля>100 или: названиеПоля>50 and названиеПоля<100. Если вы применяете фильтр для текстовых полей, то нужно использовть одинарные кавычки." type="text" size="25" id="CQLfilter_id_Web" value="" />'+
'<img src="openlayers/img/east-mini.png" onClick="updateFilter2()" title="Применить фильтр"/>'+
'<img title="Сбросить фильтр" onclick="clearSelecWin1()" src="openlayers/img/cancel.png"><br>'+
'<input type="checkbox" id="id_SelecCheck_Web" title="" value="checkbox"/><a>из выделенных элементов</a><br>'+
'<p> <button type=button onclick=NewfromSelect_Layer2()>OK</button></p>'+'</div>';
if(!document.getElementById("id_divSelecLeg"))
{body.appendChild(DivEditeLeg); 

document.getElementById("id_divSelecMain2").onmousedown=function(event){drags(event)};
document.getElementById("id_divSelecMain2").onmouseup=function(e){enddrag()};
}

}
function updateFilter2(){
if(this.document.getElementById("editL1").value=="0")
{alert ("Please select name of Layer in combobox 'Editable Layer'"); return;}
var format = new OpenLayers.Format.CQL();
 var filter = document.getElementById('CQLfilter_id_Web').value;
 var filterParams = {
 filter: null,
 cql_filter: null,
 featureId: null
 };
 //if (OpenLayers.String.trim(filter) != "") {
 //if (filterType == "cql") 
filterParams["cql_filter"] = filter;
// if (filterType == "ogc") 
filterParams["filter"] = filter;
 //if (filterType == "fid") 
 filterParams["featureId"] = filter;
 //}
// mergeNewParams(filterParams);

if(edilayerMainLayer.styleMap.styles.default.rules[0]&&edilayerMainLayer.styleMap.styles.default.rules[0].filter.property)
{filterStartG2=1;filterStartGArr2=[];}
var rule2 = new OpenLayers.Rule({
    name: "date",
    filter: new OpenLayers.Filter.Logical({
        type: OpenLayers.Filter.Logical.AND,
        filters: [
        ]
    }) ,symbolizer: {
                   pointRadius: 3,fillColor: "#FFFF3F",
                strokeColor: "#666666", strokeWidth: 1,
                fillOpacity:1,strokeOpacity:1
    }    
    });
if(filterStartG2==1)
{var arF=filterStartGArr2;
if(arF&&arF.length==0)
{for(var ghi=0;ghi<edilayerMainLayer.styleMap.styles.default.rules.length;ghi++)
{var parserF = new OpenLayers.Format.Filter();
var filter1 = parserF.write(edilayerMainLayer.styleMap.styles.default.rules[ghi].filter);
var filter1 = parserF.read(filter1);
arF.push(filter1)}}
for(var f=0;f<arF.length;f++)
{var parserF = new OpenLayers.Format.Filter();
var filter1 = parserF.write(rule2.filter);
var filterRul2 = parserF.read(filter1);
edilayerMainLayer.styleMap.styles.default.rules[f].filter=filterRul2;
var filterInput=format.read(filter);
edilayerMainLayer.styleMap.styles.default.rules[f].filter.filters.push(filterInput);
edilayerMainLayer.styleMap.styles.default.rules[f].filter.filters.push(arF[f]);
}
edilayerMainLayer.redraw();

}
else{
var rule2 = new OpenLayers.Rule({
 title:"jkkkkk",
 symbolizer: {
 pointRadius: 3,
 fillColor: "#FFFF3F",
 strokeColor: "#666666",
 strokeWidth: 1,
 fillOpacity:1,
 strokeOpacity:1
 } 
});

rule2.filter=format.read(filter);
//edilayerMainLayer.styleMap.styles.default=new OpenLayers.Style(null, {rules: [rule2]});
edilayerMainLayer.styleMap.styles.default.rules=[rule2];
edilayerMainLayer.redraw();
}
 }
 function resetFilter2() {
 //if(pureCoverage)
// return;
    if(filterStartG2==10)
{}              
else{                  
           if(edilayerMainLayer.styleMap.styles.default.rules&&edilayerMainLayer.styleMap.styles.default.rules.length>0)
           {if(edilayerMainLayer.styleMap.styles.default.rules[0].filter.filters)
           {
           for(var ghi=0;ghi<edilayerMainLayer.styleMap.styles.default.rules.length;ghi++)
{edilayerMainLayer.styleMap.styles.default.rules[ghi].filter=edilayerMainLayer.styleMap.styles.default.rules[ghi].filter.filters[1]}
           } else
           {}
           }
else{}
if(edilayerMainLayer.styleMap.styles.default.rules.length==1){edilayerMainLayer.styleMap.styles.default.rules=[]}
           filterStartG2=0;
filterStartGArr2=[];
}
edilayerMainLayer.redraw();

 }
function NewfromSelect_Layer2()
{var featuresAr=[];

if(document.getElementById('id_SelecCheck_Web').checked==true)
{for(var y=0;y<edilayerMainLayer.selectedFeatures.length;y++){var ty=edilayerMainLayer.selectedFeatures[y].clone();featuresAr.push(ty);}}
else{if(document.getElementById('CQLfilter_id_Web').value!==''){updateFilter2();}
for (var i=0;i<edilayerMainLayer.features.length;i++){if (edilayerMainLayer.features[i].getVisibility()){var ty=edilayerMainLayer.features[i].clone();featuresAr.push(ty);}}
}
var new_layer = new OpenLayers.Layer.Vector(document.getElementById("CQLfilter_id_Name").value,{renderers:["Canvas", "SVG", "VML"]});
 new_layer.strategies=[saveStrategy]
var format = new OpenLayers.Format.GeoJSON({ 'internalProjection': new OpenLayers.Projection("EPSG:900913"),
'externalProjection': new OpenLayers.Projection("EPSG:900913")});
var jsonstring = format.write(featuresAr);
var featuresS=format.read(jsonstring);
new_layer.addFeatures(featuresS);
var new_style_layer= new OpenLayers.Style({
 pointRadius: 3,
 fillColor: "#FF9000", strokeColor: "#FF9000",
 strokeWidth: 1,fillOpacity:1, strokeOpacity:1
 });
 var selStyle = new OpenLayers.Style({
 pointRadius: 5,  fillColor: "#ffaa00",
 strokeColor: "#00DDFF", strokeWidth:2,
fillOpacity:1, strokeOpacity:1 }); 
new_layer.styleMap=new OpenLayers.StyleMap({'default':new_style_layer,'select': selStyle});
map.addLayer(new_layer);
var t=this.document.createElement('option');
t.value=new_layer.name;
t.text=new_layer.name;
this.document.getElementById("editL1").appendChild(t);


}
function OK_SetSLDLayer()
{
htmlTextReLayer='';

var bbox = document.getElementById("map").getBoundingClientRect();
 var body = document.body
 var docElem = document.documentElement
 var scrollTop = window.pageYOffset || docElem.scrollTop || body.scrollTop
 var scrollLeft = window.pageXOffset || docElem.scrollLeft || body.scrollLeft
 var clientTop = docElem.clientTop || body.clientTop || 0
 var clientLeft = docElem.clientLeft || body.clientLeft || 0
 var topTop = bbox.top + scrollTop - clientTop
 var leftLeft = bbox.left + scrollLeft - clientLeft
var DivEditeLeg=document.createElement("div");
DivEditeLeg.id="id_SLDLegMain2";
DivEditeLeg.className="id_divRoutLegMain";
DivEditeLeg.style.position="relative";

DivEditeLeg.innerHTML='<div id="id_divSLDLeg" style="background:#ffffff; color:#0000ff;z-index: 6000;position:absolute;left:'+Math.round(leftLeft+50)+'px;top:'+Math.round(topTop-150)+
'px;overflow:hidden; border: 1px solid black;"><img onclick="closeWearherLegendWin(this)" src="openlayers/theme/default/img/close.gif" style="position:relative; top:10px;float:right; cursor:pointer"><a style="position:relative; top:20px"></a>'+
'<a style="font-size: 9px;"> you can move this window if you select menu item Interface/switch to interface drag</a><br>'+
'<a>Select the Layer:</a>'+
'<select id="ReSLDLayer_id">'+
 '<option selected value="0">.</option>'+
'</select><br>'+
 '<br>Select <a href="https://en.wikipedia.org/wiki/Styled_Layer_Descriptor" target="_blank">SLD File</a>: <input title="Select SLD file" type="file" id="file_SLDlayer"><br>'+
'<p><button type=button onclick=OK_SetSLDLayer2()>Load(import) SLD</button></p>'+
'<p> <button type=button onclick=OK_ExportSLDLayer2()>Export legend to SLD</button>Version of SLD:<select id="VerSLDLayer_id">'+
 '<option selected value="1.0.0">1.0.0</option><option value="1.1.0">1.1.0</option>'+
'</select><br></p>'+'</div>';
if(!document.getElementById("id_SLDLegMain2"))
{body.appendChild(DivEditeLeg); 
document.getElementById("id_SLDLegMain2").onmousedown=function(event){drags(event)};
document.getElementById("id_SLDLegMain2").onmouseup=function(e){enddrag()};}

for(var j=0;j<map.layers.length; j++)
{if(map.layers[j].isBaseLayer==false)
{var t=this.document.createElement('option');t.value=map.layers[j].name;t.text=map.layers[j].name;
this.document.getElementById("ReSLDLayer_id").appendChild(t); 
} }
document.getElementById('file_SLDlayer').addEventListener('change', readSingleFileSLD, false);
}
function readSingleFileSLD(evt)
{fileZIP = evt.target.files[0]; }

function OK_SetSLDLayer2()
{
var lines = [];var headers;var contents2;
var contents;
 if (fileZIP) {
 var r = new FileReader();
 r.onload = function(e) { 
 contents = e.target.result;
var SLDcont=contents;
OK_SetSLDLayer3(SLDcont);
//if(popupReSLDName){popupReSLDName.destroy();}
 }
 r.readAsText(fileZIP);
 } else {  alert("Failed to load file"); }
}
function OK_SetSLDLayer3(SLDcont)
{
var format=new OpenLayers.Format.SLD()
var SLDcont2=SLDcont.split("<NamedLayer>")[1];
 var pos = SLDcont.indexOf('<se:');
if(pos!=-1)
{var tsld='<?xml version="1.0" encoding="UTF-8"?><sld:StyledLayerDescriptor version="1.0.0" '+
'xmlns:sld="http://www.opengis.net/sld" xmlns:ogc="http://www.opengis.net/ogc" xmlns:gml="http://www.opengis.net/gml" xmlns:xlink="http://www.w3.org/1999/xlink" '+
'xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" '+
'xsi:schemaLocation="http://www.opengis.net/sld '+'http://schemas.opengis.net/sld/1.0.0/StyledLayerDescriptor.xsd">xmlns:se="http://www.opengis.net/se"><NamedLayer>';
SLDcont2=tsld+SLDcont2;SLDcont2=SLDcont2.split("</NamedLayer>")[0]+'</NamedLayer></sld:StyledLayerDescriptor>';

SLDcont2=SLDcont2.replace(/SvgParameter/g,"CssParameter");SLDcont2=SLDcont2.replace(/<se:/g,"<sld:");SLDcont2=SLDcont2.replace(/<\/se:/g,"<\/sld:");
var styleSLD=format.read(SLDcont2);}
else{var styleSLD=format.read(SLDcont);SLDcont2=SLDcont;} 
for(var j=0;j<map.layers.length; j++)
{if(map.layers[j].CLASS_NAME=="OpenLayers.Layer.Vector"&&map.layers[j].name==document.getElementById("ReSLDLayer_id").value)
{ 
 for (var l in styleSLD.namedLayers) {
        var styles = styleSLD.namedLayers[l].userStyles, style;
        for (var i=0,ii=styles.length; i<ii; ++i) {
            style = styles[i];
            if (style.isDefault||!style.isDefault) {
                map.layers[j].styleMap.styles["default"] = style;
                break;
            }
        } }
var de=map.layers[j].styleMap.styles.default.rules;
for(var b=0;b<de.length;b++)
{if(de[b].symbolizer.Point&&!de[b].symbolizer.Text){de[b].symbolizer=JSON.parse(JSON.stringify(de[b].symbolizer.Point))}
if(de[b].symbolizer.Point&&de[b].symbolizer.Text){var psl=JSON.stringify(de[b].symbolizer.Point);//psl='"'+psl.split(\"}\")[1].split(\"{\")[0]+'"}'; //alert("a");
var psl2=JSON.stringify(de[b].symbolizer.Text);psl2=psl2.replace(/fillColor/g,"fontColor");var psl3=(psl2+psl).replace('}{',",");
de[b].symbolizer=JSON.parse(psl3);de[b].symbolizer.fontColor=SetHexRGBColor(de[b].symbolizer.fontColor)}
}
} 
if((map.layers[j].CLASS_NAME=="OpenLayers.Layer.WMS"||map.layers[j].CLASS_NAME=="OpenLayers.Layer.Grid"||map.layers[j].CLASS_NAME=="OpenLayers.Layer.XYZ")&&map.layers[j].name==document.getElementById("ReSLDLayer_id").value)
{
map.layers[j].params.SLD_BODY=SLDcont2;
map.layers[j].tileOptions={maxGetUrlLength: 20}

}


map.layers[j].redraw(); }

}
function OK_ExportSLDLayer2()
{
var format=new OpenLayers.Format.SLD();
format.multipleSymbolizers=true; var ifNoRules=0;
for(var j=0;j<map.layers.length; j++)
{if(map.layers[j].CLASS_NAME=="OpenLayers.Layer.Vector"&&map.layers[j].name==document.getElementById("ReSLDLayer_id").value)
{ if(map.layers[j].styleMap.styles.default.rules)
{if(map.layers[j].styleMap.styles.default.rules.length==0)
{ifNoRules=1;
 var rul0=new OpenLayers.Rule({
 title: map.layers[j].name, filter: null,
 symbolizer: { } });
rul0.symbolizer=JSON.parse(JSON.stringify(map.layers[j].styleMap.styles.default.defaultStyle));
map.layers[j].styleMap.styles.default.rules.push(rul0);
}  }

if(map.layers[j].styleMap.styles.default.rules)
{
for(var b=0;b<map.layers[j].styleMap.styles.default.rules.length;b++)
{if(map.layers[j].features[0])
{var typsld='';var erp=map.layers[j].features[0].geometry.CLASS_NAME;var sym=map.layers[j].styleMap.styles.default.rules[b];
if(erp=="OpenLayers.Geometry.Point"){typsld="Point"}
if(erp=='OpenLayers.Geometry.MultiLineString'||erp=='OpenLayers.Geometry.LineString'){typsld="Line"}
if(erp=="OpenLayers.Geometry.Polygon"||erp=="OpenLayers.Geometry.MultiPolygon"){typsld="Polygon"}
sym.symbolizer[typsld]=JSON.parse(JSON.stringify(map.layers[j].styleMap.styles.default.rules[b].symbolizer));
if(sym.symbolizer[typsld].fillColor){if(sym.symbolizer[typsld].fillColor.indexOf('#')==-1){sym.symbolizer[typsld].fillColor='#'+SetHexRGBColor(sym.symbolizer[typsld].fillColor);}}
if(sym.symbolizer[typsld].strokeColor){if(sym.symbolizer[typsld].strokeColor.indexOf('#')==-1){sym.symbolizer[typsld].strokeColor='#'+SetHexRGBColor(sym.symbolizer[typsld].strokeColor);}}
if(!sym.symbolizer[typsld].externalGraphic&&typsld=="Point"){sym.symbolizer[typsld].graphicName="circle"}
if(sym.filter){if(sym.filter.lowerBoundary&&sym.filter.upperBoundary){sym.title=sym.filter.property+" "+sym.filter.lowerBoundary+" "+sym.filter.type+" "+sym.filter.upperBoundary}
if(sym.filter.value!==null){sym.title=sym.filter.property+" "+sym.filter.value;}rtt=sym.symbolizer[typsld];
if(sym.symbolizer[typsld].label){sym.symbolizer["Text"]=JSON.parse(JSON.stringify(map.layers[j].styleMap.styles.default.rules[b].symbolizer));sym.symbolizer["Text"].fillColor=sym.symbolizer["Text"].fontColor}
 }; if(!sym.filter){if(sym.symbolizer[typsld].label){sym.symbolizer["Text"]=JSON.parse(JSON.stringify(map.layers[j].styleMap.styles.default.rules[b].symbolizer));sym.symbolizer["Text"].fillColor=sym.symbolizer["Text"].fontColor}}
 }
}
var expsld=format.write(
{namedLayers: [{
name: map.layers[j].name,userStyles: [map.layers[j].styleMap.styles.default]
    }]
} );

for(var j=0;j<map.layers.length; j++)
{if(map.layers[j].name==document.getElementById("ReSLDLayer_id").value)
{if(ifNoRules==1){map.layers[j].styleMap.styles.default.rules=[];}for(var b=0;b<map.layers[j].styleMap.styles.default.rules.length;b++)
{delete map.layers[j].styleMap.styles.default.rules[b].symbolizer[typsld];  if(map.layers[j].styleMap.styles.default.rules[b].symbolizer.Text){delete map.layers[j].styleMap.styles.default.rules[b].symbolizer.Text}  } } }
expsld=expsld.replace(/<sld:Size>(\d*)<\/sld:Size>/g,replasesld);

if(document.getElementById("VerSLDLayer_id").value=='1.1.0')
{var tsld='<?xml version="1.0" encoding="UTF-8"?><sld:StyledLayerDescriptor version="1.0.0" '+'xmlns:sld="http://www.opengis.net/sld" xmlns:ogc="http://www.opengis.net/ogc" xmlns:gml="http://www.opengis.net/gml" xmlns:xlink="http://www.w3.org/1999/xlink" '+'xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" '+'xsi:schemaLocation="http://www.opengis.net/sld '+'http://schemas.opengis.net/sld/1.0.0/StyledLayerDescriptor.xsd">xmlns:se="http://www.opengis.net/se"><NamedLayer>';
var tsld2='<?xml version="1.0" encoding="UTF-8"?> '+
'<StyledLayerDescriptor xmlns="http://www.opengis.net/sld" xmlns:ogc="http://www.opengis.net/ogc" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" version="1.1.0" xmlns:xlink="http://www.w3.org/1999/xlink" xsi:schemaLocation="http://www.opengis.net/sld http://schemas.opengis.net/sld/1.1.0/StyledLayerDescriptor.xsd" xmlns:se="http://www.opengis.net/se"> '+
 '<NamedLayer>';
var tempexpsld2=expsld.split("<sld:NamedLayer>")[1];expsld=tsld2+tempexpsld2;expsld=expsld.split("</sld:NamedLayer>")[0]+'</NamedLayer></StyledLayerDescriptor>';
expsld=expsld.replace(/CssParameter/g,"SvgParameter");expsld=expsld.replace(/<sld:/g,"<se:");expsld=expsld.replace(/<\/sld:/g,"<\/se:");}

kmlText2='';kmlText2=expsld;
 init_download();//var myWinExport= open("download.html", "Export to the SLD","width=900,height=500,status=no,toolbar=no,menubar=no,scrollbars=yes");myWinExport.focus();
}  }
}

}
function replasesld(str, p1,offset, s){return str='<sld:Size>'+p1/2+'</sld:Size>';}
function SetHexRGBColor(color)
{
  color = color.replace(/\s/g,"");
  var aRGB = color.match(/^rgb\((\d{1,3}[%]?),(\d{1,3}[%]?),(\d{1,3}[%]?)\)$/i);

  if(aRGB)
  {
    color = '';
    for (var i=1;  i<=3; i++) color += Math.round((aRGB[i][aRGB[i].length-1]=="%"?2.55:1)*parseInt(aRGB[i])).toString(16).replace(/^(.)$/,'0$1');
  }
  else color = color.replace(/^#?([\da-f])([\da-f])([\da-f])$/i, '$1$1$2$2$3$3');
  
  return color;
}
function OK_SetBaseLayer()
{
htmlTextReLayer='';
htmlTextReLayer+='<a>Select the Layer which</a><br><a>you wont to make base layer:</a><br>'+
'<select id="ReBaseLayer_id">'+
 '<option selected value="0">.</option>'+
'</select><br>'+
'number of ZoomLevels:<input type="text" size="5" id="Id_OpZBaseLayerNameAtl" value="32"/>'+
'<div id="id_change_backgroundColormap" style="cursor:pointer"><a style="font-size:11px">click to change color of background map</a></div>'+
'<p> <button type=button onclick=OK_SetBaseLayer2()>OK</button></p>';
popupReBaseName = new OpenLayers.Popup.FramedCloud("SetBaseLPopup",
map.getCenter(),
new OpenLayers.Size(500,500),
htmlTextReLayer ,
null, true, onPopupClose);
map.addPopup(popupReBaseName);
document.getElementById("id_change_backgroundColormap").onclick=function(){colorEdit(document.getElementById("map").childNodes[3].childNodes[0]);}
for(var j=0;j<map.layers.length; j++)
{if(map.layers[j].isBaseLayer==false)
{var t=this.document.createElement('option');
t.value=map.layers[j].name;
t.text=map.layers[j].name;
this.document.getElementById("ReBaseLayer_id").appendChild(t); 
}
}
document.getElementById("SetBaseLPopup").onmousedown=function(event){drags(event)};
document.getElementById("SetBaseLPopup").onmouseup=function(e){enddrag()};
popupReBaseName.updateSize();

}
function OK_SetBaseLayer()
{
htmlTextReLayer='';
htmlTextReLayer+='<a>Выберите слой который</a><br><a>который необходимо сделать базовым</a><br>'+
'<select id="ReBaseLayer_id">'+
 '<option selected value="0">.</option>'+
'</select><br>'+'number of ZoomLevels:<input type="text" size="5" id="Id_OpZBaseLayerNameAtl" value="32"/>'+
'<div id="id_change_backgroundColormap" style="cursor:pointer"><a style="font-size:11px">нажмите здесь чтобы изменить цвет фона карты</a></div>'+
'<p> <button type=button onclick=OK_SetBaseLayer2()>OK</button></p>';

popupReBaseName = new OpenLayers.Popup.FramedCloud("SetBaseLPopup",
map.getCenter(),
new OpenLayers.Size(500,500),
htmlTextReLayer ,
null, true, onPopupClose);
map.addPopup(popupReBaseName);
document.getElementById("id_change_backgroundColormap").onclick=function(){colorEdit(document.getElementById("map").childNodes[3].childNodes[0]);}
for(var j=0;j<map.layers.length; j++)
{if(map.layers[j].isBaseLayer==false)
{var t=this.document.createElement('option');
t.value=map.layers[j].name;
t.text=map.layers[j].name;
this.document.getElementById("ReBaseLayer_id").appendChild(t); 
}
}
document.getElementById("SetBaseLPopup").onmousedown=function(event){drags(event)};
document.getElementById("SetBaseLPopup").onmouseup=function(e){enddrag()};
popupReBaseName.updateSize();

}
function OK_SetBaseLayer2()
{
for(var j=0;j<map.layers.length; j++)
{
if(map.layers[j].name==document.getElementById("ReBaseLayer_id").value)
{var la=map.layers[j];map.removeLayer(map.layers[j]);
la.isBaseLayer=true;
if(la.CLASS_NAME=='OpenLayers.Layer.Vector')
{if(la.name==edilayerMainLayer.name)
{highlightCtrl.destroy();
selectCtrl .destroy();}}
var opt= {buffer: 0,
 displayOutsideMaxExtent: true,
 isBaseLayer:true,queryable: true,
projection: new OpenLayers.Projection("EPSG:900913"),
minResolution: null,
maxResolution: 156543.03390625,
numZoomLevels : parseInt(document.getElementById("Id_OpZBaseLayerNameAtl").value),
maxScale: null,
minScale: null,
maxExtent: new OpenLayers.Bounds(-20037508.34, -20037508.34, 20037508.34, 20037508.34),
minExtent : null,
 }
la.options=opt;

la.displayOutsideMaxExtent=true;la.buffer=0;
la.queryable=true;la.projection=new OpenLayers.Projection("EPSG:900913");
la.minResolution=null;la.maxResolution=156543.03390625;la.numZoomLevels=parseInt(document.getElementById("Id_OpZBaseLayerNameAtl").value);la.maxScale=null;la.minScale=null;
la.maxExtent=new OpenLayers.Bounds(-20037508.34, -20037508.34, 20037508.34, 20037508.34);la.minExtent=null;
var ListL=document.getElementById('editL1');
for (var k=0; k<ListL.length; k++)
{if(ListL.options[k].value==la.name){ListL.removeChild(ListL.options[k]);}}
if(la.CLASS_NAME=='OpenLayers.Layer.Vector')
{la.events.unregister('featureselected', la, regFeatureSelected);
la.events.unregister('featureunselected', la, onFeatureUnselect);}
if(la.protocol&&la.features)
{ var format = new OpenLayers.Format.GeoJSON({ });
var jsonFeatures=format.write(la.features); la.removeFeatures(la.features);la.protocol=null;
var nf=format.read(jsonFeatures);la.addFeatures(nf);la.strategies=null;}
map.addLayer(la);var indexb=-1;
for(var i=0;i<map.layers.length;i++)
{ if(map.layers[i].isBaseLayer==true)
{ indexb++;} }
map.setLayerIndex(la,indexb);
map.setBaseLayer(la);
}

}
popupReBaseName.destroy();
}
function Rename_Layer()
{
htmlTextReLayer='';
htmlTextReLayer+='<a>Слой имя которого будет</a><br><a>изменено:</a><br>'+
'<select id="ReLayer_id">'+
 '<option selected value="0">.</option>'+
'</select><br>'+
'<input type="text" size="15" id="Id_RenLayerNameAtl" value="New_Name"/>введите новое имя<br>'+
'<p> <button type=button onclick=OK_Rename_Layer()>OK</button></p>';
popupReName = new OpenLayers.Popup.FramedCloud("RenameLPopup",
map.getCenter(),
new OpenLayers.Size(500,500),
htmlTextReLayer ,
null, true, onPopupClose);
map.addPopup(popupReName);
for(var j=0;j<map.layers.length; j++)
{var t=this.document.createElement('option');
t.value=map.layers[j].name;
t.text=map.layers[j].name;
this.document.getElementById("ReLayer_id").appendChild(t); 
}
document.getElementById("RenameLPopup").onmousedown=function(event){drags(event)};
document.getElementById("RenameLPopup").onmouseup=function(e){enddrag()};
popupReName.updateSize();
}
function Donate()
{
var myWinTable= open("support.htm", "_blank",
 "width=900,height=500,status=yes,toolbar=yes,menubar=yes,scrollbars=yes");
}
function closeWeathWinSel()
{document.getElementById("id_divWeatherMainSel").parentNode.removeChild(document.getElementById("id_divWeatherMainSel"));}
function Weather_SelectOk()
{
if(document.getElementById("SelWeathSourc_id").value=="worldweatheronline.com")
{Weather_Layer2();}
if(document.getElementById("SelWeathSourc_id").value=="openweathermap.org")
{Weather_Layer3();}

}
function Weather_Layer3()
{
var scriptWMS = document.createElement("script"); 
scriptWMS.src = 'openlayers/OWM.OpenLayers.1.3.6.js'; 
 scriptWMS.type = 'text/javascript'; 
 scriptWMS.id="WMSWeathscript_id";
scriptWMS.async=false;
scriptWMS.onload= function(){Weather_Layer4()};
document.body.appendChild(scriptWMS);
addLegendTempOWM();
addLegendPressOWM();
addLegendRainOWM();
addLegendWindOWM();
}
function addLegendTempOWM()
{
var bbox = document.getElementById("map").getBoundingClientRect(); var body = document.body; var docElem = document.documentElement;
 var scrollTop = window.pageYOffset || docElem.scrollTop || body.scrollTop; var scrollLeft = window.pageXOffset || docElem.scrollLeft || body.scrollLeft;
 var clientTop = docElem.clientTop || body.clientTop || 0; var clientLeft = docElem.clientLeft || body.clientLeft || 0;
 var topTop = bbox.top + scrollTop - clientTop; var leftLeft = bbox.left + scrollLeft - clientLeft;
var DivEditeLeg=document.createElement("div");DivEditeLeg.id="id_divTempLegendWeather";DivEditeLeg.className="id_divRoutLegMain";DivEditeLeg.style.position="relative";
var tr='<div style="background: rgba(';var tr2=',1);width:30px;height:8px"/>'; var tr3='..............';
DivEditeLeg.innerHTML='<div id="id_divTempLegendWeather2" style="background:#ffffff; color:#0000ff;z-index: 6000;position:absolute;left:'+Math.round(leftLeft+50)+'px;top:'+Math.round(topTop-220)+
'px;overflow:hidden; border: 1px solid black;" title="Вы можете перемещать это окно если щёлкните по пункту меню: Интерфейс->переключить режим интерфейса">'+
'<img onclick="closeWearherLegendWin(this)" src="openlayers/theme/default/img/close.gif" style="position:relative; top:10px;float:right; cursor:pointer"><br>'+
//'<a style="font-size: 9px;">you can move this window</a><br><a style="font-size: 9px;">if you select menu item:</a><br><a style="font-size: 9px;">Interface->switch to interface drag</a><br><br>'+
'<a style="font-size: 11px;">legend</a><br><a style="font-size: 11px;">температура (°C):</a><br>'+
'<div style="font-size: 10px;">'+tr+'0,0,153,1);width:30px;height:8px;"/>'+tr3+'-100</div>'+tr+'0,0,153'+tr2+''+tr3+'-36</div>'+tr+'0,0,180'+
tr2+''+tr3+'-32</div>'+tr+'0,0,223'+tr2+''+tr3+'-28</div>'+tr+'0,24,254'+tr2+''+tr3+'-24</div>'+tr+'0,114,254'+tr2+''+tr3+'-20</div>'+tr+'0,173,254'+tr2+''+tr3+'-16</div>'+tr+'0,238,254'+tr2+''+tr3+'-12</div>'+tr+'43,254,211'+tr2+''+tr3+'-8</div>'+tr+'103,254,151'+tr2+''+tr3+'-4</div>'+tr+'155,254,99'+tr2+''+tr3+'0</div>'+tr+'211,254,43'+tr2+''+tr3+'4</div>'+tr+'254,243,0'+tr2+''+tr3+'8</div>'+tr+'254,183,0'+tr2+''+tr3+'12</div>'+tr+'254,121,0'+tr2+''+tr3+'16</div>'+tr+'254,75,0'+tr2+''+tr3+'20</div>'+tr+'254,23,0'+tr2+''+tr3+'24</div>'+tr+'220,0,0'+tr2+''+tr3+'28</div>'+
tr+'173,0,0'+tr2+''+tr3+'32</div>'+tr+'154,0,0'+tr2+''+tr3+'36</div>'+
'<br>'+'</div>'+'</div>';
if(!document.getElementById("id_divTempLegendWeather"))
{body.appendChild(DivEditeLeg); document.getElementById("id_divTempLegendWeather").onmousedown=function(event){drags(event)};document.getElementById("id_divTempLegendWeather").onmouseup=function(e){enddrag()}; }


}
function addLegendPressOWM()
{
var bbox = document.getElementById("map").getBoundingClientRect(); var body = document.body; var docElem = document.documentElement;
 var scrollTop = window.pageYOffset || docElem.scrollTop || body.scrollTop; var scrollLeft = window.pageXOffset || docElem.scrollLeft || body.scrollLeft;
 var clientTop = docElem.clientTop || body.clientTop || 0; var clientLeft = docElem.clientLeft || body.clientLeft || 0;
 var topTop = bbox.top + scrollTop - clientTop; var leftLeft = bbox.left + scrollLeft - clientLeft;
var DivEditeLeg=document.createElement("div");DivEditeLeg.id="id_divPressLegendWeather";DivEditeLeg.className="id_divRoutLegMain";DivEditeLeg.style.position="relative";
var tr='<div style="background: rgba(';var tr2=',1);width:30px;height:8px"/>'; var tr3='..............';
DivEditeLeg.innerHTML='<div id="id_divPressLegendWeather2" style="background:#ffffff; color:#0000ff;z-index: 6000;position:absolute;left:'+Math.round(leftLeft+140)+'px;top:'+Math.round(topTop-220)+
'px;overflow:hidden; border: 1px solid black;" title="Вы можете перемещать это окно если щёлкните по пункту меню: Интерфейс->переключить режим интерфейса">'+
'<img onclick="closeWearherLegendWin(this)" src="openlayers/theme/default/img/close.gif" style="position:relative; top:10px;float:right; cursor:pointer"><br>'+
'<a style="font-size: 11px;">legend</a><br><a style="font-size: 11px;">давление ( Па) :</a><br>'+
'<div style="font-size: 10px;">'+tr+'0,0,100,1);width:30px;height:8px;"/>'+tr3+'1</div>'+
''+tr+'0,0,100'+tr2+''+tr3+'95000</div>'+tr+'0,0,153'+tr2+''+tr3+'95500</div>'+tr+'0,0,180'+tr2+''+tr3+'96000</div>'+tr+'0,0,223'+tr2+''+tr3+'96500</div>'+tr+'0,114,254'+tr2+''+tr3+'97500</div>'+''+tr+'0,173,254'+tr2+''+tr3+'98000</div>'+''+tr+'0,238,254'+tr2+''+tr3+'98500</div>'+''+tr+'43,254,211'+tr2+''+tr3+'99000</div>'+''+tr+'103,254,151'+tr2+''+tr3+'99500</div>'+''+tr+'155,254,99'+tr2+''+tr3+'100500</div>'+''+tr+'211,254,43'+tr2+''+tr3+'101000</div>'+''+tr+'254,243,0'+tr2+''+tr3+'101500</div>'+''+tr+'254,183,0'+tr2+''+tr3+'102000</div>'+''+tr+'254,121,0'+tr2+''+tr3+'102500</div>'+''+tr+'254,75,0'+tr2+''+tr3+'103000</div>'+''+tr+'254,23,0'+tr2+''+tr3+'103500</div>'+''+tr+'220,0,0'+tr2+''+tr3+'104000</div>'+''+tr+'173,0,0'+tr2+''+tr3+'104500</div>'+''+tr+'154,0,0'+tr2+''+tr3+'105000</div>'+''+tr+'154,0,0'+tr2+''+tr3+'1050000</div>'+
'<br>'+'</div>'+'</div>';
if(!document.getElementById("id_divPressLegendWeather"))
{body.appendChild(DivEditeLeg); document.getElementById("id_divPressLegendWeather").onmousedown=function(event){drags(event)};document.getElementById("id_divPressLegendWeather").onmouseup=function(e){enddrag()}; }


}
function addLegendRainOWM()
{
var bbox = document.getElementById("map").getBoundingClientRect(); var body = document.body; var docElem = document.documentElement;
 var scrollTop = window.pageYOffset || docElem.scrollTop || body.scrollTop; var scrollLeft = window.pageXOffset || docElem.scrollLeft || body.scrollLeft;
 var clientTop = docElem.clientTop || body.clientTop || 0; var clientLeft = docElem.clientLeft || body.clientLeft || 0;
 var topTop = bbox.top + scrollTop - clientTop; var leftLeft = bbox.left + scrollLeft - clientLeft;
var DivEditeLeg=document.createElement("div");DivEditeLeg.id="id_divRainLegendWeather";DivEditeLeg.className="id_divRoutLegMain";DivEditeLeg.style.position="relative";
var tr='<div style="background: rgba(';var tr2=',1);width:30px;height:8px"/>'; var tr3='..............';
DivEditeLeg.innerHTML='<div id="id_divRainLegendWeather2" style="background:#ffffff; color:#0000ff;z-index: 6000;position:absolute;left:'+Math.round(leftLeft+220)+'px;top:'+Math.round(topTop-220)+
'px;overflow:hidden; border: 1px solid black;" title="Вы можете перемещать это окно если щёлкните по пункту меню: Интерфейс->переключить режим интерфейса">'+
'<img onclick="closeWearherLegendWin(this)" src="openlayers/theme/default/img/close.gif" style="position:relative; top:10px;float:right; cursor:pointer"><br>'+
'<a style="font-size: 11px;">legend</a><br><a style="font-size: 11px;">дождь/осадки(мм):</a><br>'+
'<div style="font-size: 10px;">'+''+tr+'230,230,230'+tr2+''+tr3+'0.1</div>'+''+tr+'210,210,210'+tr2+''+tr3+'0.5</div>'+''+tr+'188,188,188'+tr2+''+tr3+'2</div>'+''+tr+'150,150,150'+tr2+''+tr3+'4.5</div>'+
''+tr+'100,100,100'+tr2+''+tr3+'6</div>'+''+tr+'20,100,200'+tr2+''+tr3+'7</div>'+''+tr+'0,114,254'+tr2+''+tr3+'8</div>'+''+tr+'20,100,210'+tr2+' '+tr3+'10</div>'+''+tr+'30,119,235'+tr2+' '+tr3+'11</div>'+''+tr+'40,130,240'+tr2+' '+tr3+'12</div>'+''+tr+'60,150,245'+tr2+' '+tr3+'13</div>'+''+tr+'80,165,245'+tr2+' '+tr3+'14</div>'+''+tr+'120,185,250'+tr2+''+tr3+'15</div>'+''+tr+'150,210,250'+tr2+''+tr3+'16</div>'+''+tr+'180,240,250'+tr2+''+tr3+'17</div>'+''+tr+'100,240,100'+tr2+''+tr3+'18</div>'+
''+tr+'15,160,15'+tr2+'  '+tr3+'19</div>'+''+tr+'30,180,30'+tr2+'  '+tr3+'20</div>'+''+tr+'55,210,60'+tr2+'  '+tr3+'21</div>'+''+tr+'80,240,80'+tr2+'  '+tr3+'22</div>'+''+tr+'120,245,115'+tr2+''+tr3+'23</div>'+''+tr+'150,245,140'+tr2+''+tr3+'24</div>'+''+tr+'180,250,170'+tr2+''+tr3+'25</div>'+''+tr+'200,255,190'+tr2+''+tr3+'26</div>'+
''+tr+'255,232,120'+tr2+''+tr3+'28</div>'+''+tr+'255,192,60'+tr2+' '+tr3+'30</div>'+''+tr+'255,160,0'+tr2+'  '+tr3+'32</div>'+''+tr+'255,96,0'+tr2+''+tr3+'34</div>'+''+tr+'255,50,0'+tr2+''+tr3+'36</div>'+''+tr+'225,20,0'+tr2+''+tr3+'38</div>'+''+tr+'192,0,0'+tr2+' '+tr3+'40</div>'+''+tr+'165,0,0'+tr2+' '+tr3+'42</div>'+
''+tr+'100,60,50'+tr2+'  '+tr3+'44</div>'+''+tr+'120,80,70'+tr2+'  '+tr3+'46</div>'+''+tr+'140,100,90'+tr2+' '+tr3+'48</div>'+''+tr+'180,140,130'+tr2+''+tr3+'50</div>'+
''+tr+'225,190,180'+tr2+''+tr3+'52</div>'+''+tr+'240,220,210'+tr2+''+tr3+'54</div>'+''+tr+'255,200,200'+tr2+''+tr3+'57</div>'+''+tr+'245,160,160'+tr2+''+tr3+'60</div>'+
''+tr+'225,100,100'+tr2+''+tr3+'63</div>'+''+tr+'200,60,60'+tr2+'  '+tr3+'70</div>'+
'<br>'+'</div>'+'</div>';
if(!document.getElementById("id_divRainLegendWeather"))
{body.appendChild(DivEditeLeg); document.getElementById("id_divRainLegendWeather").onmousedown=function(event){drags(event)};document.getElementById("id_divRainLegendWeather").onmouseup=function(e){enddrag()}; }


}
function addLegendWindOWM()
{var bbox = document.getElementById("map").getBoundingClientRect(); var body = document.body; var docElem = document.documentElement;
 var scrollTop = window.pageYOffset || docElem.scrollTop || body.scrollTop; var scrollLeft = window.pageXOffset || docElem.scrollLeft || body.scrollLeft;
 var clientTop = docElem.clientTop || body.clientTop || 0; var clientLeft = docElem.clientLeft || body.clientLeft || 0;
 var topTop = bbox.top + scrollTop - clientTop; var leftLeft = bbox.left + scrollLeft - clientLeft;
var DivEditeLeg=document.createElement("div");DivEditeLeg.id="id_divWindLegendWeather";DivEditeLeg.className="id_divRoutLegMain";DivEditeLeg.style.position="relative";
var tr='<div style="background: rgba(';var tr2=',1);width:30px;height:8px"/>'; var tr3='..............';
DivEditeLeg.innerHTML='<div id="id_divWindLegendWeather2" style="background:#ffffff; color:#0000ff;z-index: 6000;position:absolute;left:'+Math.round(leftLeft+315)+'px;top:'+Math.round(topTop-220)+
'px;overflow:hidden; border: 1px solid black;" title="Вы можете перемещать это окно если щёлкните по пункту меню: Интерфейс->переключить режим интерфейса">'+
'<img onclick="closeWearherLegendWin(this)" src="openlayers/theme/default/img/close.gif" style="position:relative; top:10px;float:right; cursor:pointer"><br>'+
'<a style="font-size: 11px;">legend</a><br><a style="font-size: 11px;">ветер ( м/с):</a><br>'+
'<div style="font-size: 10px;">'+''+tr+'0,0,153'+tr2+''+tr3+'0</div>'+''+tr+'0,0,180'+tr2+''+tr3+'1.5</div>'+''+tr+'0,0,223'+tr2+''+tr3+'3</div>'+''+tr+'0,24,254'+tr2+''+tr3+'5</div>'+
''+tr+'0,114,254'+tr2+'   '+tr3+'6.5</div>'+''+tr+'0,173,254'+tr2+'   '+tr3+'8.5</div>'+''+tr+'0,238,254'+tr2+'   '+tr3+'10</div>'+''+tr+'43,254,211'+tr2+'  '+tr3+'12</div>'+
''+tr+'103,254,151'+tr2+' '+tr3+'13.5</div>'+''+tr+'155,254,99'+tr2+'  '+tr3+'15.5</div>'+''+tr+'211,254,43'+tr2+'  '+tr3+'17</div>'+''+tr+'254,243,0'+tr2+''+tr3+'19</div>'+
''+tr+'254,183,0'+tr2+''+tr3+'20.5</div>'+''+tr+'254,121,0'+tr2+''+tr3+'22.5</div>'+''+tr+'254,75,0'+tr2+''+tr3+'24</div>'+''+tr+'254,23,0'+tr2+''+tr3+'25.5</div>'+
''+tr+'220,0,0'+tr2+''+tr3+'27.5</div>'+''+tr+'173,0,0'+tr2+''+tr3+'29</div>'+''+tr+'154,0,0'+tr2+''+tr3+'1000</div>'+
'<br>'+'</div>'+'</div>';
if(!document.getElementById("id_divWindLegendWeather"))
{body.appendChild(DivEditeLeg); document.getElementById("id_divWindLegendWeather").onmousedown=function(event){drags(event)};document.getElementById("id_divWindLegendWeather").onmouseup=function(e){enddrag()}; }

}
function Weather_Layer4()
{
var stations = new OpenLayers.Layer.Vector.OWMStations("СтанцииOpen",{renderers:["Canvas", "SVG", "VML"]});
var city = new OpenLayers.Layer.Vector.OWMWeather("ПогодаOpen",{renderers:["Canvas", "SVG", "VML"]});
city.events.register("loadstart",city, function() {WaitWindow();});
city.events.register("loadend",city, function() {if(document.getElementById("WaitPopup")){try{document.getElementById("WaitPopup").parentNode.removeChild(document.getElementById("WaitPopup"))}catch(e){};} });
var precipitation = new OpenLayers.Layer.XYZ(
"ОсадкиOpen",
"http://${s}.tile.openweathermap.org/map/precipitation/${z}/${x}/${y}.png",
{numZoomLevels: 19, 
isBaseLayer: false,
opacity: 0.6,
sphericalMercator: true
});
precipitation.setVisibility(false);
precipitation.events.register("loadstart",precipitation, function() {WaitWindow();});
precipitation.events.register("loadend",precipitation, function() {if(document.getElementById("WaitPopup")){try{document.getElementById("WaitPopup").parentNode.removeChild(document.getElementById("WaitPopup"))}catch(e){};} });
var clouds = new OpenLayers.Layer.XYZ(
"ОблачностьOpen",
"http://${s}.tile.openweathermap.org/map/clouds/${z}/${x}/${y}.png",
{
numZoomLevels: 19, 
isBaseLayer: false,
opacity: 0.7,
sphericalMercator: true
});
clouds.setVisibility(false);
clouds.events.register("loadstart",clouds, function() {WaitWindow();});
clouds.events.register("loadend",clouds, function() {if(document.getElementById("WaitPopup")){try{document.getElementById("WaitPopup").parentNode.removeChild(document.getElementById("WaitPopup"))}catch(e){};} });

var pressure_contour = new OpenLayers.Layer.XYZ(
"ДавлениеOpenКонтур",
"http://${s}.tile.openweathermap.org/map/pressure_cntr/${z}/${x}/${y}.png",
{numZoomLevels: 19, isBaseLayer: false,
opacity: 0.4,sphericalMercator: true}
);
pressure_contour.setVisibility(false);
pressure_contour.events.register("loadstart",pressure_contour, function() {WaitWindow();});
pressure_contour.events.register("loadend",pressure_contour, function() {if(document.getElementById("WaitPopup")){try{document.getElementById("WaitPopup").parentNode.removeChild(document.getElementById("WaitPopup"))}catch(e){};} });

var rainOWM = new OpenLayers.Layer.XYZ(
"ДождьOpen","http://${s}.tile.openweathermap.org/map/rain/${z}/${x}/${y}.png",
{numZoomLevels: 19, isBaseLayer: false,opacity: 0.4,sphericalMercator: true});
rainOWM.setVisibility(false);rainOWM.events.register("loadstart",rainOWM, function() {WaitWindow();});
rainOWM.events.register("loadend",rainOWM, function() {if(document.getElementById("WaitPopup")){try{document.getElementById("WaitPopup").parentNode.removeChild(document.getElementById("WaitPopup"))}catch(e){};} });

var pressOWM = new OpenLayers.Layer.XYZ(
"ДавлениеOpen","http://${s}.tile.openweathermap.org/map/pressure/${z}/${x}/${y}.png",
{numZoomLevels: 19, isBaseLayer: false,opacity: 0.4,sphericalMercator: true});
pressOWM.setVisibility(false);pressOWM.events.register("loadstart",pressOWM, function() {WaitWindow();});
pressOWM.events.register("loadend",pressOWM, function() {if(document.getElementById("WaitPopup")){try{document.getElementById("WaitPopup").parentNode.removeChild(document.getElementById("WaitPopup"))}catch(e){};} });

var tempOWM = new OpenLayers.Layer.XYZ("ТемператураOpen","http://${s}.tile.openweathermap.org/map/temp/${z}/${x}/${y}.png",
{numZoomLevels: 19, isBaseLayer: false,opacity: 0.4,sphericalMercator: true});
tempOWM.setVisibility(false);tempOWM.events.register("loadstart",tempOWM, function() {WaitWindow();});
tempOWM.events.register("loadend",tempOWM, function() {if(document.getElementById("WaitPopup")){try{document.getElementById("WaitPopup").parentNode.removeChild(document.getElementById("WaitPopup"))}catch(e){};} });

var windOWM = new OpenLayers.Layer.XYZ("ВетерOpen","http://${s}.tile.openweathermap.org/map/wind/${z}/${x}/${y}.png",
{numZoomLevels: 19, isBaseLayer: false,opacity: 0.4,sphericalMercator: true});
windOWM.setVisibility(false);windOWM.events.register("loadstart",windOWM, function() {WaitWindow();});windOWM.events.register("loadend",windOWM, function() {if(document.getElementById("WaitPopup")){try{document.getElementById("WaitPopup").parentNode.removeChild(document.getElementById("WaitPopup"))}catch(e){};} });
var snowOWM = new OpenLayers.Layer.XYZ("СнегOpen","http://${s}.tile.openweathermap.org/map/snow/${z}/${x}/${y}.png",
{numZoomLevels: 19, isBaseLayer: false,opacity: 0.4,sphericalMercator: true});
snowOWM.setVisibility(false);snowOWM.events.register("loadstart",snowOWM, function() {WaitWindow();});snowOWM.events.register("loadend",snowOWM, function() {if(document.getElementById("WaitPopup")){try{document.getElementById("WaitPopup").parentNode.removeChild(document.getElementById("WaitPopup"))}catch(e){};} });


map.addLayers([stations, city]);map.addLayer(precipitation);map.addLayer(clouds);map.addLayer(pressure_contour);map.addLayer(rainOWM);map.addLayer(pressOWM);map.addLayer(tempOWM);map.addLayer(windOWM);map.addLayer(snowOWM);

var t=this.document.createElement('option');
t.value=stations.name;
t.text=stations.name;
this.document.getElementById("editL1").appendChild(t);
var t=this.document.createElement('option');
t.value=city.name;
t.text=city.name;
this.document.getElementById("editL1").appendChild(t);

}
function Weather_Layer()
{
var bbox = document.getElementById("buttonWeather_id").getBoundingClientRect();
 var body = document.body
 var docElem = document.documentElement
 var scrollTop = window.pageYOffset || docElem.scrollTop || body.scrollTop
 var scrollLeft = window.pageXOffset || docElem.scrollLeft || body.scrollLeft
 var clientTop = docElem.clientTop || body.clientTop || 0
 var clientLeft = docElem.clientLeft || body.clientLeft || 0
 var topTop = bbox.top + scrollTop - clientTop
 var leftLeft = bbox.left + scrollLeft - clientLeft
var DivEditeLeg=document.createElement("div");
DivEditeLeg.id="id_divWeatherMainSel";
DivEditeLeg.className="id_divWeatherMainSel";
DivEditeLeg.style.position="relative";
DivEditeLeg.innerHTML='<div id="id_divWeathLegSel" style="background:#ffffff; color:#0000ff;z-index: 100000;position:absolute;left:'+Math.round(leftLeft+50)+'px;top:'+Math.round(topTop-230)+
'px;overflow:hidden; border: 1px solid black;"><img onclick="closeWeathWinSel()" src="openlayers/theme/default/img/close.gif" style="position:relative; top:5px;float:right; cursor:pointer"><a style="position:relative; top:20px"></a><br>'+
'<a style="font-size:11px">выберите источник информации о погоде:</a><br>'+
'<select id="SelWeathSourc_id" onchange="selectWeatherChange()">'+
'<option selected  value="worldweatheronline.com" >worldweatheronline.com</option>'+
'<option value="openweathermap.org" >openweathermap.org</option>'+
'</select><br>'+
'<div id="divSelectWeather_id"></div>'+
'<p> <button type=button onclick=Weather_SelectOk()>OK</button></p>';
if(!document.getElementById("id_divWeathLegSel"))
{body.appendChild(DivEditeLeg); }

}
function selectWeatherChange()
{
if(document.getElementById("SelWeathSourc_id").value=="worldweatheronline.com")
{document.getElementById("divSelectWeather_id").innerHTML='<a href="http://www.worldweatheronline.com" target="_blank">http://www.worldweatheronline.com</a>';}
if(document.getElementById("SelWeathSourc_id").value=="openweathermap.org")
{document.getElementById("divSelectWeather_id").innerHTML='<a href="http://www.openweathermap.org" target="_blank">http://www.openweathermap.org</a>'; }
}
function Weather_Layer2()
{
var bbox = document.getElementById("map").getBoundingClientRect();
 var body = document.body
 var docElem = document.documentElement
 var scrollTop = window.pageYOffset || docElem.scrollTop || body.scrollTop
 var scrollLeft = window.pageXOffset || docElem.scrollLeft || body.scrollLeft
 var clientTop = docElem.clientTop || body.clientTop || 0
 var clientLeft = docElem.clientLeft || body.clientLeft || 0
 var topTop = bbox.top + scrollTop - clientTop
 var leftLeft = bbox.left + scrollLeft - clientLeft
var DivEditeLeg=document.createElement("div");
DivEditeLeg.id="id_divWeatherMain2";
DivEditeLeg.className="id_divWeatherMain";
DivEditeLeg.style.position="relative";
DivEditeLeg.innerHTML='<div id="id_divWeathLeg" style="background:#ffffff; color:#0000ff;z-index: 6000;position:absolute;left:'+Math.round(leftLeft+50)+'px;top:'+Math.round(topTop+20)+
'px;overflow:hidden; border: 1px solid black;"><img onclick="closeWeathWin()" src="openlayers/theme/default/img/close.gif" style="position:relative; top:10px;float:right; cursor:pointer"><a style="position:relative; top:20px"></a>'+
'<a style="font-size: 9px;"> Вы можете перемещать это окно, если выберите пунтк меню /переключить режим интерфейса/</a><br>'+
'<a  style="font-size: 11px;">Вы должны щёлкнуть по карте для того, чтобы получить координаты, </a><br>'+
'<a style="font-size: 11px;">и затем нажмите OK для того, чтобы получить информацию о погоде в этих координатах</a><br>'+
'<br>'+
'Координаты<input type="text" size="25" id="CityId_start" value=""/><img onclick="clearWeathWin1()" src="openlayers/img/cancel.png"><br>'+
//'Название слоя маршрута <input type="text" size="20" id="NameRoutId_web" value="NewRout"/><br>'+
'<p> <button type=button onclick=Weather_LayerOk()>OK</button></p>'+
'<div style="font-size: 10px;" id="legal-notice" >'+
'Powered by <a href="http://www.worldweatheronline.com/" '+
'title="Free local weather content provider" '+
'target="_blank">World Weather Online</a></div><br>'+
'</div>';
if(!document.getElementById("id_divWeathLeg"))
{body.appendChild(DivEditeLeg); 

document.getElementById("id_divWeatherMain2").onmousedown=function(event){drags(event)};
document.getElementById("id_divWeatherMain2").onmouseup=function(e){enddrag()};

OpenLayers.Control.Click = OpenLayers.Class(OpenLayers.Control, {                
defaultHandlerOptions: {
'single': true,
'double': false,
'pixelTolerance': 0,
'stopSingle': false,
'stopDouble': false
},

initialize: function(options) {
this.handlerOptions = OpenLayers.Util.extend(
{}, this.defaultHandlerOptions
);
OpenLayers.Control.prototype.initialize.apply(
this, arguments
); 
this.handler = new OpenLayers.Handler.Click(
                        this, {
'click': this.trigger
}, this.handlerOptions
                    );
                }, 

trigger: function(e) {
var lonlat = map.getLonLatFromPixel(e.xy);

var new_pos=new OpenLayers.LonLat(lonlat.lon,lonlat.lat).transform(
map.getProjectionObject(),new OpenLayers.Projection("EPSG:4326"));
if(document.getElementById("CityId_start")){document.getElementById("CityId_start").value=new_pos.lon+";"+new_pos.lat;}

    }

});
var clickWeather = new OpenLayers.Control.Click();
clickWeather.title="click to get weather";
 map.addControl(clickWeather);
clickWeather.activate();

}
}

function SearchOnMapHide()
{
if(document.getElementById("ResultSearchOpenStreet_id").style.display=='block')
{document.getElementById("ResultSearchOpenStreet_id").style.display='none';}
else{document.getElementById("ResultSearchOpenStreet_id").style.display='block';}
}
function SearchWikipediaOnMapHide()
{
if(document.getElementById("ResultSearchWikipedia_id").style.display=='block')
{document.getElementById("ResultSearchWikipedia_id").style.display='none';}
else{document.getElementById("ResultSearchWikipedia_id").style.display='block';}
}
function zoomToSelectOpenStreet(e)
{
var r=e.id.split('_')[1];
r=r.split(';');
var pos=new OpenLayers.LonLat(parseFloat(r[2]), parseFloat(r[0])).transform(new OpenLayers.Projection("EPSG:4326"),map.getProjectionObject());
var pos2=new OpenLayers.LonLat(parseFloat(r[3]), parseFloat(r[1])).transform(new OpenLayers.Projection("EPSG:4326"),map.getProjectionObject());
map.zoomToExtent(new OpenLayers.Bounds(pos.lon,pos.lat,pos2.lon,pos2.lat));
}

function SearchWikipediaOnMap()
{
try {var xmlhttp2 =new XMLHttpRequest();}
catch (e) {alert("error");}
var qVal=document.getElementById("Id_WikipediaMapId").value;
xmlhttp2.open('GET','/temp.php?'+'c='+qVal+'&lan='+WikiLanguageSel, true);
xmlhttp2.setRequestHeader("Cache-Control", "no-cache");
xmlhttp2.setRequestHeader("Content-type", "text/xml");
xmlhttp2.onreadystatechange = function()
{if(xmlhttp2.readyState == 4&&xmlhttp2.status == 200) {
if(xmlhttp2==''){alert("нет данных");return;}
var varSearch=xmlhttp2.responseText;
if(varSearch.split("<!DOCTYPE html PUBLIC")[1]){alert("нет данных");return;}
if(varSearch==''){alert("нет данных");return;}
 var oXmlDoc = null;
 if ( window.DOMParser ) {
 var oXmlParser = new DOMParser();
 oXmlDoc = oXmlParser.parseFromString( varSearch, "text/xml" );
 } else {
 oXmlDoc = new ActiveXObject( "Microsoft.XMLDOM" );
 oXmlDoc.async = "false";
 oXmlDoc.loadXML( varSearch );
 }
 var s1=[];var s2=[];var s3=[];
var ListNameWiki = oXmlDoc.getElementsByTagName('Text');
for (var i=0;i<ListNameWiki.length;i++)
{s1.push(ListNameWiki[i].childNodes[0].nodeValue)}
var ListNameWiki = oXmlDoc.getElementsByTagName('Description');
for (var i=0;i<ListNameWiki.length;i++)
{s2.push(ListNameWiki[i].childNodes[0].nodeValue)}
var ListNameWiki = oXmlDoc.getElementsByTagName('Url');
for (var i=0;i<ListNameWiki.length;i++)
{s3.push(ListNameWiki[i].childNodes[0].nodeValue)}
//varSearch=varSearch[1];
var textDiv='';
for(var i=0;i<s1.length;i++)
{textDiv+='<a title="'+s2[i]+'" id="'+s3[i]+';.,'+i+'SelOpenWikiStrClick__;;'+s1[i]+'" style="cursor:pointer" onclick="zoomToSelectWiki(this)" onmouseout="outPunktWiki(this);" onmouseover="overPunktWiki(this);">'+s1[i]+'</a><br>';
document.getElementById("ResultSearchWikipedia_id").innerHTML=textDiv;
}
document.getElementById("ResultSearchWikipedia_id").style.display='block';
document.getElementById("ResultSearchWikipedia_id").style.height="100px";
document.getElementById("ResultSearchWikipedia_id").style.width="360px";
}}
alert("Эта функция работает только в онлайн веб-версии OpenWebGIS")
{return;
xmlhttp2.send(null);}
}
function outPunktWiki(tr)
{
tr.style.background="#ffffff";
}
function overPunktWiki(tr)
{
tr.style.background="#99D9EA";
}
function zoomToSelectWiki(tr)
{
var strS=tr.id.split('__;;')[1];
var qVal=strS;
try {var xmlhttp2 =new XMLHttpRequest();}
catch (e) {alert("error");}
var qVal=strS;
xmlhttp2.open('GET','/temp.php?'+'c='+qVal+'&lan='+WikiLanguageSel, true);
xmlhttp2.setRequestHeader("Cache-Control", "no-cache");
xmlhttp2.setRequestHeader("Content-type", "text/xml");
xmlhttp2.onreadystatechange = function()
{if(xmlhttp2.readyState == 4&&xmlhttp2.status == 200) {
if(xmlhttp2==''){alert("нет данных");return;}
var varSearch=xmlhttp2.responseText;
if(varSearch.split("<!DOCTYPE html PUBLIC")[1]){alert("нет данных");return;}
if(varSearch==''){alert("нет данных");return;}
varSearch=JSON.parse(varSearch);
rtt=varSearch;
var lat=''; var lon='';
for(h in varSearch.query.pages)
{for (hh in varSearch.query.pages[h]){
if (hh=='coordinates')
{var r=varSearch.query.pages[h];lat=r.coordinates[0].lat;lon=r.coordinates[0].lon;}
} }

if(lat==''){alert('no coordinates');return;}
lon=parseFloat(lon);
lat=parseFloat(lat);
var strS=tr.id.split('__;;')[1];
var new_layer_Wiki = new OpenLayers.Layer.Vector(strS,{renderers:["Canvas", "SVG", "VML"]});
var points;
var new_pos2=new OpenLayers.LonLat(lon,lat).transform(
new OpenLayers.Projection("EPSG:4326"),
map.getProjectionObject());

points=new OpenLayers.Geometry.Point(new_pos2.lon, new_pos2.lat);

var first_point= new OpenLayers.Feature.Vector(points);


new_layer_Wiki.addFeatures(first_point);
var new_style_layer= new OpenLayers.Style({
 pointRadius: 3,
 fillColor: "#FF9000",
 strokeColor: "#FF9000",
 strokeWidth: 1,
fillOpacity:1,
 strokeOpacity:1
 });
 var selStyle = new OpenLayers.Style({
 pointRadius: 5, 
 fillColor: "#ffaa00",
 strokeColor: "#00DDFF",
 strokeWidth:2,
fillOpacity:1,
 strokeOpacity:1
 }); 
new_layer_Wiki.styleMap=new OpenLayers.StyleMap({'default':new_style_layer,'select': selStyle});
new_layer_Wiki.projection=new OpenLayers.Projection("EPSG:900913");
var strS=tr.id.split('__;;')[1];var strS2=tr.id.split(';.,')[0];var strS3=tr.title;
first_point.attributes['placeWiki']=strS;
first_point.attributes['urlWiki']='<a href="'+strS2+'" target="_blank">'+strS+'</a>';
if(checkDiscrWiki==true)
{first_point.attributes['descrWiki']=strS3;}

var layeradd='';

if(WikiLayerOpenWebGIS!=='0')
{
for(var tt=0;tt<map.layers.length;tt++)
{if(map.layers[tt].name==WikiLayerOpenWebGIS)
{layeradd=map.layers[tt];
for(var ttt=0;ttt<map.layers[tt].features.length;ttt++)
{if(!map.layers[tt].features[ttt].attributes['placeWiki'])
{map.layers[tt].features[ttt].attributes['placeWiki']='';}
if(!map.layers[tt].features[ttt].attributes['urlWiki'])
{map.layers[tt].features[ttt].attributes['urlWiki']='';}
if(checkDiscrWiki==true)
{if(!map.layers[tt].features[ttt].attributes['descrWiki'])
{map.layers[tt].features[ttt].attributes['descrWiki']='';}}
}
}
}
}

if(WikiLayerOpenWebGIS!=='0')
{for (jk in layeradd.features[0].attributes)
{
if(jk=='placeWiki'||jk=='urlWiki'||jk=='descrWiki'){}
else{first_point.attributes[jk]='';}
}


layeradd.addFeatures(first_point);layeradd.redraw();
}

if(WikiLayerOpenWebGIS!=='0'){}
else{map.addLayer(new_layer_Wiki);
var t=document.createElement('option');
t.value=new_layer_Wiki.name;
t.text=new_layer_Wiki.name;
document.getElementById("editL1").appendChild(t);
if(document.getElementById("WikiLayerAdd_id"))
{
var t=document.createElement('option');
t.value=new_layer_Wiki.name;
t.text=new_layer_Wiki.name;
document.getElementById("WikiLayerAdd_id").appendChild(t);
}

}

var textDiv='';
}}
alert("Эта функция работает только в онлайн веб-версии OpenWebGIS")
{return;
xmlhttp2.send(null);}

}
function SearchWikipediaOnMapOption()

{
var bbox = document.getElementById("map").getBoundingClientRect();
 var body = document.body
 var docElem = document.documentElement
 var scrollTop = window.pageYOffset || docElem.scrollTop || body.scrollTop
 var scrollLeft = window.pageXOffset || docElem.scrollLeft || body.scrollLeft
 var clientTop = docElem.clientTop || body.clientTop || 0
 var clientLeft = docElem.clientLeft || body.clientLeft || 0
 var topTop = bbox.top + scrollTop - clientTop
 var leftLeft = bbox.left + scrollLeft - clientLeft
var DivEditeLeg=document.createElement("div");
DivEditeLeg.id="id_divWikiMain2";
DivEditeLeg.className="id_divWikiMain";
DivEditeLeg.style.position="relative";
DivEditeLeg.innerHTML='<div id="id_divWikiLeg" style="background:#ffffff; color:#0000ff;z-index: 6000;position:absolute;left:'+Math.round(leftLeft+50)+'px;top:'+Math.round(topTop+20)+
'px;overflow:hidden; border: 1px solid black;"><img onclick="closeWikiWin()" src="openlayers/theme/default/img/close.gif" style="position:relative; top:10px;float:right; cursor:pointer"><a style="position:relative; top:20px"></a><br>'+
'<a style="font-size: 9px;">Вы можете перемещать это окно,</a><br><a style="font-size: 9px;">если выберите пунтк меню /переключить режим интерфейса/</a><br>'+
'выберите язык: <select id="WikiLanguage_id" onchange="ChangeWikiLangSel()" >.'+
'<option lang="ar" value="ar">العربية</option>'+'<option lang="az" value="az">Azərbaycanca</option>'+
'<option lang="bg" value="bg">Български</option>'+'<option lang="ca" value="ca">Català</option>'+
'<option lang="cs" value="cs">Česky</option>'+'<option lang="da" value="da">Dansk</option>'+
'<option lang="de" value="de">Deutsch</option>'+'<option lang="el" value="el">Ελληνικά</option>'+
'<option lang="en" selected="selected" value="en">English</option>'+
'<option lang="es" value="es">Español</option>'+'<option lang="eo" value="eo">Esperanto</option>'+
'<option lang="et" value="et">Eesti</option>'+'<option lang="eu" value="eu">Euskara</option>'+
'<option lang="fa" value="fa">فارسی</option>'+'<option lang="fr" value="fr">Français</option>'+
'<option lang="gl" value="gl">Galego</option>'+'<option lang="ko" value="ko">한국어</option>'+
'<option lang="hy" value="hy">Հայերեն</option>'+'<option lang="hi" value="hi">हिन्दी</option>'+
'<option lang="hr" value="hr">Hrvatski</option>'+'<option lang="id" value="id">Bahasa Indonesia</option>'+
'<option lang="it" value="it">Italiano</option>'+'<option lang="he" value="he">עברית</option>'+
'<option lang="la" value="la">Latina</option>'+'<option lang="lt" value="lt">Lietuvių</option>'+
'<option lang="hu" value="hu">Magyar</option>'+'<option lang="ms" value="ms">Bahasa Melayu</option>'+
'<option lang="min" value="min">Baso Minangkabau</option>'+'<option lang="nl" value="nl">Nederlands</option>'+
'<option lang="ja" value="ja">日本語</option>'+'<option lang="nb" value="no">Norsk (bokmål)</option>'+
'<option lang="nn" value="nn">Norsk (nynorsk)</option>'+'<option lang="uz" value="uz">Oʻzbekcha</option>'+
'<option lang="pl" value="pl">Polski</option>'+'<option lang="pt" value="pt">Português</option>'+
'<option lang="kk" value="kk">Қазақша / Qazaqşa / قازاقشا</option>'+'<option lang="ro" value="ro">Română</option>'+
'<option lang="ru" value="ru">Русский</option>'+'<option lang="sah" value="sah">Саха Тыла</option>'+
'<option lang="en" value="simple">Simple English</option>'+'<option lang="ceb" value="ceb">Sinugboanong</option>'+
'<option lang="sk" value="sk">Slovenčina</option>'+'<option lang="sl" value="sl">Slovenščina</option>'+
'<option lang="sr" value="sr">Српски / Srpski</option>'+'<option lang="sh" value="sh">Srpskohrvatski / Српскохрватски</option>'+
'<option lang="fi" value="fi">Suomi</option>'+'<option lang="sv" value="sv">Svenska</option>'+
'<option lang="tr" value="tr">Türkçe</option>'+'<option lang="uk" value="uk">Українська</option>'+
'<option lang="vi" value="vi">Tiếng Việt</option>'+'<option lang="vo" value="vo">Volapük</option>'+
'<option lang="war" value="war">Winaray</option>'+'<option lang="zh" value="zh">中文</option>'+
'</select><br>'+ 
'Добавить в выбранный слой: <select id="WikiLayerAdd_id" onchange="ChangeWikiLayerSel()" title="Если в этом списке будет выбран слой, то информация об объекте будет  добавлена в этот слой,иначе будет создан новый слой ">.'+
 '<option selected value="0">.</option>'+
'</select><br>'+ 
'<input type="checkbox" title="добавить описание в аттрибут  слоя /descrWiki/" id="Id_wikiAddDes" onclick="ChechWikiDescr()" value="true" checked />добавить описание<br>'+
'.<input title="Название слоя для объектов выбранных вокруг точки" type="text" size="15" id="NewLayWiki_id" value="WikiLayer"/>название слоя<br>'+
'.<a>Введите параметры:</a>.<br>'+
'.<input title="Введите координаты точки, для того что бы получить объекты вокруг этой точки. Щёлкните по карте для того, что бы получить координаты или введите вручную, разделяя точкой с запятой. Вначале введите долготу, потом широту" type="text" size="22" id="WikiPoint_id" style="font-size:11px" value="0.00;0.00"/>координаты точки<br>'+
'.<input title="Радиус поиска в метрах вокруг точки.Величина должна быть между 10 и 10000 м" type="text" size="8" id="RadWiki_id" value="100"/>Радиус поиска<br>'+
'.<input title="Максимальное количество объектов которое может быть найдено.Величина должна быть между 1 и 500" type="text" size="8" id="limitWiki_id" value="10"/>лимит  кол-ва объектов<br>'+
'<p> <button title="Если вы щёлкните по этой кнопке то вы получите объекты (без ссылки википедии) вокруг указанной точки " type=button onclick=OK_WikiRadius()>OK-выбрать вокруг точки</button></p>'+
'</div>';

    OpenLayers.Control.Click = OpenLayers.Class(OpenLayers.Control, {                
defaultHandlerOptions: {
'single': true,'double': false,'pixelTolerance': 0,'stopSingle': false,'stopDouble': false},
initialize: function(options) {
this.handlerOptions = OpenLayers.Util.extend(
{}, this.defaultHandlerOptions);
OpenLayers.Control.prototype.initialize.apply(
this, arguments); 
this.handler = new OpenLayers.Handler.Click(
                        this, {'click': this.trigger
}, this.handlerOptions                    );                }, 
trigger: function(e) {
var lonlat = map.getLonLatFromPixel(e.xy);
var new_pos=new OpenLayers.LonLat(lonlat.lon,lonlat.lat).transform(
map.getProjectionObject(),new OpenLayers.Projection("EPSG:4326") );
if(document.getElementById("WikiPoint_id"))
{document.getElementById("WikiPoint_id").value=new_pos.lon+";"+new_pos.lat;}
    }
});

var clickWiki = new OpenLayers.Control.Click();
clickWiki.title="click to get point for wikipedia";
 map.addControl(clickWiki);
clickWiki.activate();
if(!document.getElementById("id_divWikiLeg"))
{body.appendChild(DivEditeLeg); }
 if(checkDiscrWiki==true){document.getElementById("Id_wikiAddDes").checked=true;}
  if(checkDiscrWiki==false){document.getElementById("Id_wikiAddDes").checked=false;}
document.getElementById("id_divWikiMain2").onmousedown=function(event){drags(event)};
document.getElementById("id_divWikiMain2").onmouseup=function(e){enddrag()};
for(var i=0;i<map.layers.length;i++)
{
if(map.layers[i].CLASS_NAME=="OpenLayers.Layer.Vector")
{
var t=document.createElement('option');
t.value=map.layers[i].name;
t.text=map.layers[i].name;
document.getElementById("WikiLayerAdd_id").appendChild(t);}
}

}
function ChechWikiDescr()
{
if(document.getElementById("Id_wikiAddDes").checked==true)
{checkDiscrWiki=true}
if(document.getElementById("Id_wikiAddDes").checked==false)
{checkDiscrWiki=false}
}
function ChangeWikiLangSel()
{
WikiLanguageSel=document.getElementById("WikiLanguage_id").value;
}
function ChangeWikiLayerSel()
{
WikiLayerOpenWebGIS=document.getElementById("WikiLayerAdd_id").value;
}
function closeWikiWin()
{
for(var i=0;i<map.controls.length;i++){if(map.controls[i].title=="click to get point for wikipedia"){ map.controls[i].destroy();}} delete OpenLayers.Control.Click;
document.getElementById("id_divWikiMain2").parentNode.removeChild(document.getElementById("id_divWikiMain2"));
}
function OK_WikiRadius()
{
var strS1lat=document.getElementById("WikiPoint_id").value.split(';')[1];
var strS2lon=document.getElementById("WikiPoint_id").value.split(';')[0];
var strS=strS1lat+"|"+strS2lon
var qVal=strS;
var rad=document.getElementById("RadWiki_id").value;
var lim=document.getElementById("limitWiki_id").value;

try {var xmlhttp2 =new XMLHttpRequest();}
catch (e) {alert("error");}
var qVal=strS;
xmlhttp2.open('GET','/temp.php?'+'c='+qVal+'&rad='+rad+'&lim='+lim+'&lan='+WikiLanguageSel, true);
xmlhttp2.setRequestHeader("Cache-Control", "no-cache");
xmlhttp2.setRequestHeader("Content-type", "text/xml");
xmlhttp2.onreadystatechange = function()
{if(xmlhttp2.readyState == 4&&xmlhttp2.status == 200) {
if(xmlhttp2==''){alert("нет данных");return;}
var varSearch=xmlhttp2.responseText;
if(varSearch.split("<!DOCTYPE html PUBLIC")[1]){alert("нет данных");return;}
if(varSearch==''){alert("нет данных");return;}
varSearch=JSON.parse(varSearch);
rtt=varSearch;
if(varSearch.query.geosearch.length==0){alert("нет данных");return;}
var new_layer_Wiki = new OpenLayers.Layer.Vector(document.getElementById("NewLayWiki_id").value,{renderers:["Canvas", "SVG", "VML"]});
var pointss = new Array();
var layeradd='';

if(document.getElementById("WikiLayerAdd_id").value!=='0')
{
for(var tt=0;tt<map.layers.length;tt++)
{if(map.layers[tt].name==WikiLayerOpenWebGIS)
{layeradd=map.layers[tt];
for(var ttt=0;ttt<map.layers[tt].features.length;ttt++)
{if(!map.layers[tt].features[ttt].attributes['placeWiki'])
{map.layers[tt].features[ttt].attributes['placeWiki']='';}
if(!map.layers[tt].features[ttt].attributes['distWiki'])
{map.layers[tt].features[ttt].attributes['distWiki']='';}
}
}
}
}
for (var f=0;f<varSearch.query.geosearch.length;f++)
{
var lon,lat;
lat=varSearch.query.geosearch[f].lat;
lon=varSearch.query.geosearch[f].lon;
lon=parseFloat(lon);
lat=parseFloat(lat);
//var points = new Array();
var new_pos2=new OpenLayers.LonLat(lon,lat).transform(
new OpenLayers.Projection("EPSG:4326"),
map.getProjectionObject());

points=new OpenLayers.Geometry.Point(new_pos2.lon, new_pos2.lat);
var first_point= new OpenLayers.Feature.Vector(points);
first_point.attributes['placeWiki']=varSearch.query.geosearch[f].title;
first_point.attributes['distWiki']=varSearch.query.geosearch[f].dist;
pointss.push(first_point);
}
if(document.getElementById("WikiLayerAdd_id").value!=='0')
{for(var ii=0;ii<pointss.length;ii++)
{
for (jk in layeradd.features[0].attributes)
{
if(jk=='placeWiki'||jk=='distWiki'){}
else{pointss[ii].attributes[jk]='';}
}

}
layeradd.addFeatures(pointss);layeradd.redraw();
}
else
{new_layer_Wiki.addFeatures(pointss);}
var new_style_layer= new OpenLayers.Style({
 pointRadius: 3, fillColor: "#FF9000", strokeColor: "#FF9000",
 strokeWidth: 1,fillOpacity:1, strokeOpacity:1
 });
 var selStyle = new OpenLayers.Style({
 pointRadius: 5,  fillColor: "#ffaa00",
 strokeColor: "#00DDFF", strokeWidth:2,
fillOpacity:1, strokeOpacity:1
 }); 
new_layer_Wiki.styleMap=new OpenLayers.StyleMap({'default':new_style_layer,'select': selStyle});
new_layer_Wiki.projection=new OpenLayers.Projection("EPSG:900913");
if(document.getElementById("WikiLayerAdd_id").value!=='0')
{}else{
map.addLayer(new_layer_Wiki);
var t=document.createElement('option');
t.value=new_layer_Wiki.name;
t.text=new_layer_Wiki.name;
document.getElementById("editL1").appendChild(t);
if(document.getElementById("WikiLayerAdd_id"))
{
var t=document.createElement('option');
t.value=new_layer_Wiki.name;
t.text=new_layer_Wiki.name;
document.getElementById("WikiLayerAdd_id").appendChild(t);
}
}

}
}
alert("Эта функция работает только в онлайн веб-версии OpenWebGIS")
{return;
xmlhttp2.send(null);}
}

function SearchOnMap()
{

try {var xmlhttp2 =new XMLHttpRequest();}
catch (e) {alert("error");}
var qVal=document.getElementById("Id_OpenStreetMapId").value;
xmlhttp2.open('GET','/temp.php?'+'c='+qVal, true);
xmlhttp2.setRequestHeader("Cache-Control", "no-cache");
xmlhttp2.setRequestHeader("Content-type", "text/xml");
xmlhttp2.onreadystatechange = function()
{if(xmlhttp2.readyState == 4&&xmlhttp2.status == 200) {
if(xmlhttp2==''){alert("нет данных. Пожалуйста, попробуйте ещё раз");return;}
var varSearch=xmlhttp2.responseText;
if(varSearch.split("<!DOCTYPE html PUBLIC")[1]){alert("нет данных. Пожалуйста, попробуйте ещё раз");return;}
if(varSearch==''||varSearch=="[]"){alert("нет данных. Пожалуйста, попробуйте ещё раз");return;}
varSearch=JSON.parse(varSearch);
rtt=varSearch;

var textDiv='';
for(var i=0;i<varSearch.length;i++)
{textDiv+='<a id='+i+'SelOpenStrClick_'+ varSearch[i].boundingbox[0]+';'+varSearch[i].boundingbox[1]+';'+varSearch[i].boundingbox[2]+';'+varSearch[i].boundingbox[3]+' style="cursor:pointer" onclick="zoomToSelectOpenStreet(this)">'+varSearch[i].display_name+'</a><br>';
document.getElementById("ResultSearchOpenStreet_id").style.display='block';
document.getElementById("ResultSearchOpenStreet_id").style.height="100px";
document.getElementById("ResultSearchOpenStreet_id").style.width="360px";
document.getElementById("ResultSearchOpenStreet_id").innerHTML=textDiv;
}
}}
alert("Эта функция работает только в онлайн веб-версии OpenWebGIS")
{return;
xmlhttp2.send(null);}
}

function clearWeathWin1()
{document.getElementById("CityId_start").value='';}
function closeWeathWin()
{for(var i=0;i<map.controls.length;i++){if(map.controls[i].title=="click to get weather"){ map.controls[i].destroy();}} delete OpenLayers.Control.Click;
document.getElementById("id_divWeatherMain2").parentNode.removeChild(document.getElementById("id_divWeatherMain2"));GlobalWeatherVar='';}
function closeWeathForWin()
{document.getElementById("id_divWeatherForMain2").parentNode.removeChild(document.getElementById("id_divWeatherForMain2"));}
function Weather_LayerOk(){
try {var xmlhttp =new XMLHttpRequest();}
catch (e) {alert("error");}
var qVal=document.getElementById("CityId_start").value.split(';')[1]+'%2C'+document.getElementById("CityId_start").value.split(';')[0]
xmlhttp.open('GET','/temp.php?'+'c='+qVal+
'&rand='+Math.random(), true);
xmlhttp.setRequestHeader("Cache-Control", "no-cache");
xmlhttp.setRequestHeader("Content-type", "text/xml");
xmlhttp.onreadystatechange = function()
{if(xmlhttp.readyState == 4&&xmlhttp.status == 200) {
if(xmlhttp==''){alert("нет данных");return;}
var varWeath=xmlhttp.responseText;
varWeath=JSON.parse(varWeath);
GlobalWeatherVar=varWeath;
var new_pos=new OpenLayers.LonLat(document.getElementById("CityId_start").value.split(';')[0],document.getElementById("CityId_start").value.split(';')[1]).transform(
new OpenLayers.Projection("EPSG:4326"),map.getProjectionObject());
var nvarWeath=varWeath.data.current_condition[0];
nvarWeath["время"]='<a title="время наблюдения">'+nvarWeath["observation_time"]+'</a>';
delete nvarWeath["observation_time"];

nvarWeath["темп_С"]='<a title="температура в градусах Цельсия">'+nvarWeath["temp_C"]+'</a>';
delete nvarWeath["temp_C"];

nvarWeath["ветерСкоростьМили"]='<a title="скрость ветра в милях/час">'+nvarWeath["windspeedMiles"]+'</a>';
delete nvarWeath["windspeedMiles"];

nvarWeath["ветерСкоростьКмЧас"]='<a title="скрость ветра в км/час">'+nvarWeath["windspeedKmph"]+'</a>';
delete nvarWeath["windspeedKmph"];

nvarWeath["ветерНаправленГрад"]='<a title="направление ветра в граудсах">'+nvarWeath["winddirDegree"]+'</a>';
delete nvarWeath["winddirDegree"];

nvarWeath["ветерНаправленКомпас"]='<a title="направление ветра по компасу">'+nvarWeath["winddir16Point"]+'</a>';
delete nvarWeath["winddir16Point"];

nvarWeath["ПогодаЯвления"]=nvarWeath["weatherDesc"];
delete nvarWeath["weatherDesc"];

nvarWeath["осадкиММ"]='<a title="осадки в мм">'+nvarWeath["precipMM"]+'</a>';
delete nvarWeath["precipMM"];
nvarWeath["влажность"]='<a title="влажность в %">'+nvarWeath["humidity"]+'</a>';
delete nvarWeath["humidity"];
nvarWeath["видимость"]='<a title="видимость в киллометрах">'+nvarWeath["visibility"]+'</a>';
delete nvarWeath["visibility"];
nvarWeath["давление"]='<a title="давление в миллибарах">'+nvarWeath["pressure"]+'</a>';
delete nvarWeath["pressure"];
nvarWeath["облачность"]='<a title="облачность в %">'+nvarWeath["cloudcover"]+'</a>';
delete nvarWeath["cloudcover"];
nvarWeath["темп_Ф"]='<a title="температура в градусах Фаренгейта">'+nvarWeath["temp_F"]+'</a>';
delete nvarWeath["temp_F"];

htmlText='';
htmlText+='<div style="font-size: 11px"> '

for(h in nvarWeath)
{var str=nvarWeath[h];var hh=h+': ';if(h=='ПогодаЯвления')
{str='<a title="описание погоды (пока на английском) ">'+nvarWeath[h][0].value+'</a>';}
if(h=='weatherIconUrl')
{str='<img src="'+nvarWeath[h][0].value+'"'+'>';hh='';}
if(h=='weatherCode')
{h='';str='';}
htmlText+=hh+str+'<br>';
}
htmlText+='</div>';
htmlText+='<div style="font-size: 10px;" id="legal-notice" >'+
'Powered by <a href="http://www.worldweatheronline.com/" '+
'title="Free local weather content provider" '+
'target="_blank">World Weather Online</a></div><br>'+
'<div  style="font-size: 15px;" id="legal-notice" >'+
'<button id ="buttonforec_idWeb" title="Прогноз пока даётся на английском языке" type=button onclick=WeatherForec_LayerOk()>Прогноз</button><br>'+
'<input type="checkbox" id="id_WeatherForinNew" title="" value="checkbox"/><a>открыть прогноз в новом окне</a><br>'
'</div>'


popup = new OpenLayers.Popup.FramedCloud("WeatherPopup",
new OpenLayers.LonLat(new_pos.lon,new_pos.lat),
 new OpenLayers.Size(20,100),
 htmlText ,
 null, true, onPopupClose);


popup.id="popup_"+Math.random();
 map.addPopup(popup);
popup.updateSize();
document.getElementById("buttonforec_idWeb").onclick=function(){WeatherForec_LayerOk()};
document.getElementById("WeatherPopup").onmousedown=function(event){drags(event)};
document.getElementById("WeatherPopup").onmouseup=function(e){enddrag()};

}}
alert("Эта функция работает только в онлайн веб-версии OpenWebGIS")
{return;
xmlhttp.send(null);}


}
function WeatherForec_LayerOk()
{var nvarWeath=GlobalWeatherVar.data.weather;
var bbox = document.getElementById("map").getBoundingClientRect();
 var body = document.body
 var docElem = document.documentElement
 var scrollTop = window.pageYOffset || docElem.scrollTop || body.scrollTop
 var scrollLeft = window.pageXOffset || docElem.scrollLeft || body.scrollLeft
 var clientTop = docElem.clientTop || body.clientTop || 0
 var clientLeft = docElem.clientLeft || body.clientLeft || 0
 var topTop = bbox.top + scrollTop - clientTop
 var leftLeft = bbox.left + scrollLeft - clientLeft
var DivEditeLeg=document.createElement("div");
DivEditeLeg.id="id_divWeatherForMain2";
DivEditeLeg.className="id_divForWeatherMain";
DivEditeLeg.style.position="relative";
htmlText='';
for(var t=0;t<nvarWeath.length;t++)
{htmlText+='<div style="float: left;height: 250px; width:100px;font-size: 11px; overflow:auto;border: solid 1px black;">';for(h in nvarWeath[t])
{var str=nvarWeath[t][h];var hh=h+': ';if(h=='weatherDesc')
{str=nvarWeath[t][h][0].value;}
if(h=='weatherIconUrl')
{str='<img src="'+nvarWeath[t][h][0].value+'"'+'>';hh='';}
if(h=='weatherCode')
{h='';str='';}
htmlText+=hh+str+'<br>';
}
htmlText+='</div>'
}
var WeatherStr='<div id="id_divWeathForLeg" style="background:#ffffff; color:#0000ff;z-index: 6000;position:absolute;left:'+Math.round(leftLeft+0)+'px;top:'+Math.round(topTop-190)+
'px;overflow:hidden; border: 1px solid black;"><img onclick="closeWeathForWin()" src="openlayers/theme/default/img/close.gif" style="position:relative; top:10px;float:right; cursor:pointer"><a style="position:relative; top:20px"></a>Forecast<br>'+
'<a style="font-size: 9px;">Вы можете перемещать это окно если щёлкните по пункту меню: Интерфейс->переключить режим интерфейса</a><br>'+htmlText+'</div><br>';
DivEditeLeg.innerHTML=WeatherStr;
if(document.getElementById("id_WeatherForinNew").checked==true)
{
WeatherStr='<div id="id_divWeathForLeg" style="background:#ffffff; color:#0000ff;z-index: 6000;position:absolute;left:10px;top:0px;overflow:hidden; border: 1px solid black;"><a style="position:relative; top:20px"></a>Forecast<br>'+
htmlText+'</div><br>';

var myWin= open("", "displayWindowWeather",
 "width=600,height=500,status=yes,toolbar=yes,menubar=yes");
 myWin.document.open();
 myWin.document.write("<html><head><title>Forecast Weather OpenWebGIS");
 myWin.document.write("</title>");
 myWin.document.write("</head><body>");
var newstr='<div style="font-size: 12px; position:absolute;left:10px;top:300px;" id="legal-notice" >'+
'Powered by <a href="http://www.worldweatheronline.com/" '+
'title="Free local weather content provider" '+
'target="_blank">World Weather Online</a></div>';
 myWin.document.write(WeatherStr);
 myWin.document.write(newstr);
 myWin.document.write("</body></html>");
 myWin.document.close(); 
return;
}

if(!document.getElementById("id_divWeathForLeg"))
{body.appendChild(DivEditeLeg); }else{document.getElementById("id_divWeatherForMain2").innerHTML=WeatherStr;}
document.getElementById("id_divWeatherForMain2").onmousedown=function(event){drags(event)};
document.getElementById("id_divWeatherForMain2").onmouseup=function(e){enddrag()};
}

function OK_Rename_Layer()
{
for(var j=0;j<map.layers.length; j++)
{
if(map.layers[j].name==document.getElementById("ReLayer_id").value)
{map.layers[j].name=document.getElementById("Id_RenLayerNameAtl").value}

}
external_control2.redraw();
var ListL=document.getElementById('editL1');
var n=document.getElementById("ReLayer_id").value;
for (var k=0; k<ListL.length; k++)
{if(ListL.options[k].value==n){ListL.removeChild(ListL.options[k]);}}
var t=this.document.createElement('option');
t.value=document.getElementById("Id_RenLayerNameAtl").value;
t.text=document.getElementById("Id_RenLayerNameAtl").value;
this.document.getElementById("editL1").appendChild(t); 
popupReName.destroy();
}
function Union_Layer()
{
if(this.document.getElementById("editL1").value=="0")
{alert ("Please select name of Layer in combobox 'Editable Layer'");}
else
 { 
var htmlTextUnLayer=" ";
var valueName=edilayerMainLayer.name+"_Union";
htmlTextUnLayer+='<a>Layer which features will be</a><br><a>added to the editable layer:</a><br>'+
'<select id="UnLayer_id">'+
 '<option selected value="0">.</option>'+
'</select><br>'+
'<select id="UnLayer_id_Type">'+
 '<option selected value="0">.</option>'+
'<option value="application/json">json</option>'+
'<option value="application/zip">shapefile</option>'+
'</select>Output format<br>'+
'<input type="checkbox" id="UnLayer_id_TypeasLayer" title="click here to create and add to the map new union layer." value="checkbox"/><a>Add new layer</a><br>'+
'<input type="text" size="15" id="Id_UnLayerNameAtl" value="'+valueName+'"/>name new Layer<br>'+
'<p> <button type=button onclick=OK_UnionLayer()>OK</button></p>';
popupAggregU = new OpenLayers.Popup.FramedCloud("AggregationPopupU",
 map.getCenter(),
 new OpenLayers.Size(500,500),
 htmlTextUnLayer ,
 null, true, onPopupClose);
 map.addPopup(popupAggregU);
for(var j=0;j<map.layers.length; j++)
 { 
 if(map.layers[j].CLASS_NAME=="OpenLayers.Layer.Vector")
 {var t=this.document.createElement('option');
t.value=map.layers[j].name;
t.text=map.layers[j].name;
this.document.getElementById("UnLayer_id").appendChild(t); }
}
document.getElementById("UnLayer_id_TypeasLayer").checked=true;
document.getElementById("AggregationPopupU").onmousedown=function(event){drags(event)};
document.getElementById("AggregationPopupU").onmouseup=function(e){enddrag()};
popupAggregU.updateSize();
}
}
function Export_Layer_Shape()
{if(document.getElementById("editL1").value=="0")
{alert ("Пожалуйста, выберите название слоя для экспорта в списке 'Редактируемый слой'"); return;}
var htmlUnion='';
var twoLayer='';
var firstLayer = new OpenLayers.Layer.Vector('temp1',{renderers:["Canvas", "SVG", "VML"]});
var tempFeatures=[];
for(var i=0;i<edilayerMainLayer.features.length;i++)
{tempFeatures.push(edilayerMainLayer.features[i].clone());}
firstLayer.addFeatures(tempFeatures);
var twoLayer = new OpenLayers.Layer.Vector('temp2',{renderers:["Canvas", "SVG", "VML"]});
twoLayer.addFeatures(firstLayer.features[edilayerMainLayer.features.length-1]);
if(edilayerMainLayer.features.length<1){alert("Please activate ediltable Layer");return;}
if(edilayerMainLayer.features.length==1){}
else{firstLayer.removeFeatures(firstLayer.features[firstLayer.features.length-1])}
var format = new OpenLayers.Format.GeoJSON({'internalProjection': new OpenLayers.Projection("EPSG:900913"),
'externalProjection': new OpenLayers.Projection("EPSG:4326")});
var jsonstring = format.write(firstLayer.features);
var DopStr='}],"crs":{ "type":"name","properties":{"name":"EPSG:4326"}}}';
var Newjsonstring = jsonstring.replace(/}]}/,DopStr);
jsonstring=Newjsonstring;

var jsonstring2 = format.write(twoLayer.features);
var Newjsonstring2 = jsonstring2.replace(/}]}/,DopStr);
jsonstring2=Newjsonstring2;
var doppstrr='';
doppstrr='<wps:RawDataOutput mimeType="application/zip">';
htmlUnion+='<?xml version="1.0" encoding="UTF-8"?>'+
'<wps:Execute version="1.0.0" service="WPS" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns="http://www.opengis.net/wps/1.0.0" xmlns:wfs="http://www.opengis.net/wfs" xmlns:wps="http://www.opengis.net/wps/1.0.0" xmlns:ows="http://www.opengis.net/ows/1.1" xmlns:gml="http://www.opengis.net/gml" xmlns:ogc="http://www.opengis.net/ogc" xmlns:wcs="http://www.opengis.net/wcs/1.1.1" xmlns:xlink="http://www.w3.org/1999/xlink" xsi:schemaLocation="http://www.opengis.net/wps/1.0.0 http://schemas.opengis.net/wps/1.0.0/wpsAll.xsd">'+
'<ows:Identifier>gs:UnionFeatureCollection</ows:Identifier>'+'<wps:DataInputs>'+'<wps:Input>'+'<ows:Identifier>first</ows:Identifier>'+
'<wps:Data>'+'<wps:ComplexData mimeType="application/json"><![CDATA['+jsonstring+']]></wps:ComplexData>'+
'</wps:Data>'+'</wps:Input>'+'<wps:Input>'+'<ows:Identifier>second</ows:Identifier>'+
'<wps:Data>'+'<wps:ComplexData mimeType="application/json"><![CDATA['+jsonstring2+']]></wps:ComplexData>'+
'</wps:Data>'+'</wps:Input>'+'</wps:DataInputs>'+'<wps:ResponseForm>'+doppstrr+
'<ows:Identifier>result</ows:Identifier>'+'</wps:RawDataOutput>'+
'</wps:ResponseForm>'+'</wps:Execute>';
var xmlhttp =new XMLHttpRequest();
xmlhttp.open('POST','/geoserver/wps', true);
xmlhttp.responseType = 'arraybuffer';
xmlhttp.setRequestHeader("Cache-Control", "no-cache");
xmlhttp.setRequestHeader("Content-type", "text/xml");
xmlhttp.onload = function(e) {
  if (this.status == 200) {
var filename = "";
var disposition = this.getResponseHeader('Content-Disposition');
if (disposition && disposition.indexOf('attachment') !== -1) {
var filenameRegex = /filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/;
var matches = filenameRegex.exec(disposition);
if (matches != null && matches[1]) filename = matches[1].replace(/['"]/g, '');}
filename=edilayerMainLayer.name+".zip";
var type =this.getResponseHeader('Content-Type');
var blob = new Blob([this.response], { type: type });
if (typeof window.navigator.msSaveBlob !== 'undefined') {
            window.navigator.msSaveBlob(blob, filename);    } else {
            var URL = window.URL || window.webkitURL;            var downloadUrl = URL.createObjectURL(blob);
            if (filename) {
                // use HTML5 a[download] attribute to specify filename
                var a = document.createElement("a");
if (typeof a.download === 'undefined') {window.location = downloadUrl; } else {
a.href = downloadUrl;   a.download = filename; document.body.appendChild(a); a.click();                }
            } else { window.location = downloadUrl; }
            setTimeout(function () { URL.revokeObjectURL(downloadUrl); }, 100); // cleanup
    }  }
};
alert("Эта функция работает только в онлайн веб-версии OpenWebGIS")
{return;
xmlhttp.send(htmlUnion);}
}
function OK_UnionLayer()
{var strUnion="'form'"
var htmlUnion='';
var twoLayer='';
for(var j=0;j<map.layers.length; j++)
 { 
if(map.layers[j].name==document.getElementById("UnLayer_id").value){twoLayer=map.layers[j];}
}
if(twoLayer.features.length<1){alert("Пожалуйста, активируйте слой");return;}
if(edilayerMainLayer.features.length<1){alert("Пожалуйста, активируйте редактируемый слой");return;}
//var format = new OpenLayers.Format.GeoJSON({});
var format = new OpenLayers.Format.GeoJSON({'internalProjection': new OpenLayers.Projection("EPSG:900913"),
'externalProjection': new OpenLayers.Projection("EPSG:4326")});
var jsonstring = format.write(edilayerMainLayer.features);
var DopStr='}],"crs":{ "type":"name","properties":{"name":"EPSG:4326"}}}';
//jsonstringExpReadyExport='![CDATA['+jsonstringExp+']]'
var Newjsonstring = jsonstring.replace(/}]}/,DopStr);
jsonstring=Newjsonstring;

var jsonstring2 = format.write(twoLayer.features);
var Newjsonstring2 = jsonstring2.replace(/}]}/,DopStr);
jsonstring2=Newjsonstring2;
var doppstrr='';
if(document.getElementById("UnLayer_id_Type").value=='application/json'||document.getElementById("UnLayer_id_Type").value=='0')
{doppstrr='<wps:RawDataOutput mimeType="application/json">';}
else{doppstrr='<wps:RawDataOutput mimeType="application/zip">';}

htmlUnion+='<?xml version="1.0" encoding="UTF-8"?>'+
'<wps:Execute version="1.0.0" service="WPS" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns="http://www.opengis.net/wps/1.0.0" xmlns:wfs="http://www.opengis.net/wfs" xmlns:wps="http://www.opengis.net/wps/1.0.0" xmlns:ows="http://www.opengis.net/ows/1.1" xmlns:gml="http://www.opengis.net/gml" xmlns:ogc="http://www.opengis.net/ogc" xmlns:wcs="http://www.opengis.net/wcs/1.1.1" xmlns:xlink="http://www.w3.org/1999/xlink" xsi:schemaLocation="http://www.opengis.net/wps/1.0.0 http://schemas.opengis.net/wps/1.0.0/wpsAll.xsd">'+
'<ows:Identifier>gs:UnionFeatureCollection</ows:Identifier>'+
'<wps:DataInputs>'+
'<wps:Input>'+
'<ows:Identifier>first</ows:Identifier>'+
'<wps:Data>'+
'<wps:ComplexData mimeType="application/json"><![CDATA['+jsonstring+']]></wps:ComplexData>'+
'</wps:Data>'+
'</wps:Input>'+
'<wps:Input>'+
'<ows:Identifier>second</ows:Identifier>'+
'<wps:Data>'+
'<wps:ComplexData mimeType="application/json"><![CDATA['+jsonstring2+']]></wps:ComplexData>'+
'</wps:Data>'+
'</wps:Input>'+
'</wps:DataInputs>'+
'<wps:ResponseForm>'+doppstrr+
'<ows:Identifier>result</ows:Identifier>'+
'</wps:RawDataOutput>'+
'</wps:ResponseForm>'+
'</wps:Execute>';
if(document.getElementById("UnLayer_id_Type").value=='application/json'||document.getElementById("UnLayer_id_Type").value=='0')
{alert("Эта функция работает только в онлайн веб-версии OpenWebGIS")
 {return;}
 var request = OpenLayers.Request.POST({
 url: "/geoserver/wps",
 async: false,
 data: htmlUnion,
 headers: {
 "Content-Type": "text/xml;charset=utf-8"
 },
 callback: function (response) {
var resulUnionGeoserver=response.responseText;
kmlText2=resulUnionGeoserver;
if(document.getElementById("UnLayer_id_Type").value=='application/json'){
init_download();//myWinExport= open("download.html", "Export vector layer","width=900,height=500,status=no,toolbar=no,menubar=no,scrollbars=yes");myWinExport.focus();
}
if(document.getElementById("UnLayer_id_TypeasLayer").checked=true)
{var nameL=document.getElementById("Id_UnLayerNameAtl").value;
; var new_layer_G = new OpenLayers.Layer.Vector(nameL,{renderers:["Canvas", "SVG", "VML"]});
var format2 = new OpenLayers.Format.GeoJSON({'internalProjection': new OpenLayers.Projection("EPSG:900913"),
'externalProjection': new OpenLayers.Projection("EPSG:4326") });
var newfeatures=format2.read(resulUnionGeoserver)
var obj = {};
   for(var g=0; g<newfeatures.length; g++) {
for(h in  newfeatures[g].attributes){str=h;
obj[str] = true; }
  }
for(var a = 0; a < newfeatures.length; a++ )
{ var NewAttr={};
for(h in obj){NewAttr[h]='';}
delete NewAttr.undefined;

for(h in obj)
{ for (ag in newfeatures[a].attributes) 
{
if(h==ag) 
{NewAttr[h]=newfeatures[a].attributes[ag]; rtt=NewAttr; }
else{if(NewAttr[h]){}else{NewAttr[h]=''};} ;  
}    
 }


 newfeatures[a].attributes=NewAttr;  
}
new_layer_G.addFeatures(newfeatures);
//new_layer_G.projection=new OpenLayers.Projection("EPSG:900913");
new_layer_G.events.register("loadstart",new_layer_G, function() {WaitWindow();});
map.addLayer(new_layer_G);
new_layer_G.events.register("loadend",new_layer_G, function() {if(popup_Wait){try{popup_Wait.destroy();}catch(e){};} });
 var t=this.document.createElement('option');
t.value=new_layer_G.name;
t.text=new_layer_G.name;
this.document.getElementById("editL1").appendChild(t);}
 },
 failure: function (response) {
 alert("Something went wrong in the request");
 }});
}
if(document.getElementById("UnLayer_id_Type").value=='application/zip')
{var htmlUnion2='';
htmlUnion2+='<html><body onload="document.getElementById('+strUnion+').submit();return false;">'+
'<form id="form" action="../geoserver/TestWfsPost" method="post"><div style="width:0px;height:0px;position:absolute;left:-100px;top:-100px;overflow:hidden"><input'+
' type="hidden" name="form_hf_0" id="form_hf_0" /></div>'+
 '<input type="hidden" name="url" value="http://localhost:8080/geoserver/ows?strict=true"/>'+
 '<textarea style="visibility:hidden" name="body">'+htmlspecialchars(htmlUnion)+
'</textarea>'+'<input type="hidden" name="username" value=""/>'+
 '<input type="hidden" name="password" value=""/>'+
'</form>'+
'<div>'+'<span>Loading............</span>'+
'</div>'+'</body>'+
'</html>';
var myWinUnion=open("", "displayWindow","width=400,height=300,status=no,toolbar=no,menubar=no");
myWinUnion.document.open();
myWinUnion.document.write(htmlUnion2);
myWinUnion.document.close();

if(document.getElementById("UnLayer_id_TypeasLayer").checked=true)
{var txt='<wps:RawDataOutput mimeType="application/zip">';
 htmlUnion = htmlUnion.replace(txt,'<wps:RawDataOutput mimeType="application/json">');
alert("Эта функция работает только в онлайн веб-версии OpenWebGIS")
 {return;}
var request = OpenLayers.Request.POST({
 url: "/geoserver/wps",
 async: false,
 data: htmlUnion,
 headers: {
 "Content-Type": "text/xml;charset=utf-8"
 },
 callback: function (response) {
var resulUnionGeoserver=response.responseText;
if(document.getElementById("UnLayer_id_TypeasLayer").checked=true)
{var nameL=document.getElementById("Id_UnLayerNameAtl").value; var new_layer_G = new OpenLayers.Layer.Vector(nameL,{renderers:["Canvas", "SVG", "VML"]});
var format2 = new OpenLayers.Format.GeoJSON({'internalProjection': new OpenLayers.Projection("EPSG:900913"),
'externalProjection': new OpenLayers.Projection("EPSG:4326") });
var newfeatures=format2.read(resulUnionGeoserver)
var obj = {};
   for(var g=0; g<newfeatures.length; g++) {
for(h in  newfeatures[g].attributes){str=h;
obj[str] = true; }
  }
for(var a = 0; a < newfeatures.length; a++ )
{ var NewAttr={};
for(h in obj){NewAttr[h]='';}
delete NewAttr.undefined;

for(h in obj)
{ for (ag in newfeatures[a].attributes) 
{
if(h==ag) 
{NewAttr[h]=newfeatures[a].attributes[ag]; rtt=NewAttr; }
else{if(NewAttr[h]){}else{NewAttr[h]=''};} ;  
}    
 }
 newfeatures[a].attributes=NewAttr;  
}
new_layer_G.addFeatures(newfeatures);
//new_layer_G.projection=new OpenLayers.Projection("EPSG:900913");
new_layer_G.events.register("loadstart",new_layer_G, function() {WaitWindow();});
map.addLayer(new_layer_G);
new_layer_G.events.register("loadend",new_layer_G, function() {if(popup_Wait){try{popup_Wait.destroy();}catch(e){};} });
 var t=this.document.createElement('option');
t.value=new_layer_G.name;
t.text=new_layer_G.name;
this.document.getElementById("editL1").appendChild(t);}
 },
 failure: function (response) {
 alert("Something went wrong in the request");
 }});}

}

popupAggregU.destroy();
}
function Login()
{
var myWinLogin= open("", "_blank", "width=400,height=300,status=yes,toolbar=yes,menubar=no,scrollbars=yes");
 myWinLogin.document.open();
 myWinLogin.document.write("<html><head><title>Login window OpenWebGIS");
 myWinLogin.document.write("</title>");
var str1='<script type="text/javascript" src="/geoserver/web/resources/org.geoserver.web.GeoServerBasePage/js/jquery-1.2.6.min.js"><\x2fscript>';
var str2='<script type="text/javascript" src="/geoserver/web/resources/org.geoserver.web.GeoServerBasePage/js/jquery.inline-info.js"><\x2fscript>';
var str3='<script type="text/javascript" src="/geoserver/web/resources/org.geoserver.web.demo.MapPreviewPage/mappreview_keyshortcut.js"><\x2fscript>';
 myWinLogin.document.write(str1);
 myWinLogin.document.write(str2);
myWinLogin.document.write(str3);
 myWinLogin.document.write("</head><body onload='init()'>");
var strChart='<div id=id_Login> <form method="post" action="/geoserver/j_spring_security_check">'+
 '<label class="noshow" for="username">Username</label>'+
 '<input id="username" type="text" name="username" value="defaultuser" title="Username"/><br>'+
 '<label class="noshow" for="password">Password </label>'+
 '<input id="password" type="password" name="password" value="default" title="Password"/><br>'+
 '<label class="shown" for="_spring_security_remember_me">Remember me</label>'+
 '<input id="_spring_security_remember_me" type="checkbox" name="_spring_security_remember_me" />'+
 '<button id="id_button_login" class="button-login positive icon" type="submit">'+
'<div>Login</div></button>'+
 '<script type="text/javascript">'+
 'jQuery(document).ready(function() {$("#username, #password").inlineInfoTextify();});'+
'function init(){document.getElementById("username").value="defaultuser";document.getElementById("id_button_login").onclick=function(){window.opener.GlobalUN=document.getElementById("username").value; window.opener.closeLogin(window);};}'+
 ' <\x2fscript>'+
 '</form></div>'
 myWinLogin.document.write(strChart);
 myWinLogin.document.write("</body></html>");
 myWinLogin.document.close(); 
}
function closeLogin(win){setTimeout(function(){win.close()}, 500)}
function Game()
{ countAnim=2;countAnim2=1;NumIterGame=0;var htmlGame=" ";
htmlGame+='<a>Layer which features will be</a><br><a>added to the editable layer:</a><br>'+
'<select id="GamePop_id">'+
 '<option selected value="100">100</option>'+
 '<option selected value="200">200</option>'+
 '<option selected value="300">300</option>'+
'<option selected value="400">400</option>'+
'<option selected value="500">500</option>'+
'<option selected value="1500">1500</option>'+
'</select>population size<br>'+
'<input type="text" size="8" id="count_animal" value="30"/>start count of animals<br>'+
'<input type="text" size="8" id="count_predator" value="10"/>start count of predators<br>'+
'<input type="text" size="8" id="count_polGame" value="6"/>count of food polygons<br>'+
'<p> <button type=button id="game_start" onclick=OK_Game()>Start</button><button type=button onclick=OK_GameEnd()>Stop</button></p>';
map.setCenter(new OpenLayers.LonLat(19.08,55.19).transform(
new OpenLayers.Projection("EPSG:4326"),
map.getProjectionObject()),8)
popupGame = new OpenLayers.Popup.FramedCloud("GamePopup",
 new OpenLayers.LonLat(19.08,55.19).transform(
new OpenLayers.Projection("EPSG:4326"),
map.getProjectionObject()),
 new OpenLayers.Size(500,500),
 htmlGame,
 null, true, onPopupClose);
 map.addPopup(popupGame);
popupGame.updateSize();
}
function OK_GameEnd()
{ window.clearInterval(intervalID);NumIterGame=0;window.clearInterval(intervalID2);}
function OK_Game()
{
if(vectorLayer)
{vectorLayer.destroyFeatures();}
var new_pos=new OpenLayers.LonLat(21.08,55.19).transform(
new OpenLayers.Projection("EPSG:4326"),
map.getProjectionObject());
var new_lon=new_pos.lon;
var new_lat=new_pos.lat;
 var style_blue = OpenLayers.Util.extend({}, OpenLayers.Feature.Vector.style['default']);
 style_blue.strokeColor = "blue"; 
 style_blue.fillColor = "blue"; 
style_blue.pointRadius=3;
 var style_green = {
 strokeColor: "#339933",
 strokeOpacity: 1,
 strokeWidth: 3,
 pointRadius: 6,
 pointerEvents: "visiblePainted"
 };
 var style_red = OpenLayers.Util.extend({}, OpenLayers.Feature.Vector.style['default']);
 style_red.strokeColor = "blue"; 
 style_red.fillColor = "red"; 
 var style_green = {
 strokeColor: "#339933",
 strokeOpacity: 1,
 strokeWidth: 3,
 pointRadius: 3,
 pointerEvents: "visiblePainted"
 };
 var style_green = OpenLayers.Util.extend({}, OpenLayers.Feature.Vector.style['default']);
 style_green.strokeColor = "green"; 
 style_green.fillColor = "green"; 
 var style_green = {
 strokeColor: "#339933",
 strokeOpacity: 1,
 strokeWidth: 3,
 pointRadius: 3,
 pointerEvents: "visiblePainted"
 };
 vectorLayer = new OpenLayers.Layer.Vector("Animal_Predator");
vectorLayer2 = new OpenLayers.Layer.Vector("food");
for(var pol=0; pol<document.getElementById("count_polGame").value; ++pol) {
var new_pol=new OpenLayers.LonLat(21.08+Math.random(),55.19+Math.random()).transform(
new OpenLayers.Projection("EPSG:4326"),
map.getProjectionObject());
var new_lonp=new_pol.lon;
var new_latp=new_pol.lat;
 var pointList = [];
 for(var p=0; p<6; ++p) {
 var a = p * (2 * Math.PI) / 7;
 var r = Math.random(1) + 1;
 var newPoint = new OpenLayers.Geometry.Point(new_lonp + 4000*(r * Math.cos(a)),
 new_latp + 4000*(r * Math.sin(a)));
 pointList.push(newPoint);
 }
 pointList.push(pointList[0]);
 var linearRing = new OpenLayers.Geometry.LinearRing(pointList);
 polygonFeature = new OpenLayers.Feature.Vector(
 new OpenLayers.Geometry.Polygon([linearRing]));
 polygonFeature.attributes.food="1";
 polygonFeature.attributes.id=pol;
 var style_pol = OpenLayers.Util.extend({}, OpenLayers.Feature.Vector.style['default']);
 style_pol.strokeColor = "blue"; 
 style_pol.fillColor = "#31F20B"; 
 /*style_pol = {
 strokeColor: "#339933",
 strokeOpacity: 1,
 strokeWidth: 2,
 pointRadius: 6,
 fillColor : "#31F20B",
 fillOpacity:1,
 pointerEvents: "visiblePainted"
 };*/
polygonFeature.style=style_pol ;
vectorLayer2.addFeatures(polygonFeature);
}
var att={};
att.mass="5";
att.effect="0";
 var point = new OpenLayers.Geometry.Point(new_lon, new_lat);
 var pointFeature = new OpenLayers.Feature.Vector(point, att, style_blue);
pointFeature.data.mass="5";
 var point2 = new OpenLayers.Geometry.Point(new_lon, new_lat);
att.effect="0";
 pointFeature2 = new OpenLayers.Feature.Vector(point2, att, style_red);
 map.addLayer(vectorLayer);
map.addLayer(vectorLayer2);
var t=this.document.createElement('option');
t.value=vectorLayer.name;
t.text=vectorLayer.name;
this.document.getElementById("editL1").appendChild(t);
var t=this.document.createElement('option');
t.value=vectorLayer2.name;
t.text=vectorLayer2.name;
this.document.getElementById("editL1").appendChild(t);
for(var a = 0; a <document.getElementById("count_predator").value; a++ )
 {
var att={};
 var point3 = new OpenLayers.Geometry.Point(new_lon, new_lat);
var pointFeature3 = new OpenLayers.Feature.Vector(point3, att, style_green);
 pointFeature3.attributes.mass="1";
pointFeature3.data.mass="1"; 
pointFeature3.attributes.effect="0";
pointFeature3.attributes.age="0";
pointFeature3.data.effect="0";
vectorLayer.addFeatures(pointFeature3);
}
pointFeature.data.mass="5";
pointFeature.data.effect="0";
for(var a = 0; a <document.getElementById("count_animal").value; a++ )
 {
var att={};
att.mass="5";
att.effect="0";
att.food="1"
 var point = new OpenLayers.Geometry.Point(new_lon, new_lat);
 var pointFeature = new OpenLayers.Feature.Vector(point, att, style_blue);
pointFeature.data.mass="5";
pointFeature.data.effect="0";
vectorLayer.addFeatures(pointFeature);
 }
alert("start");
countAnim=parseInt(document.getElementById("count_animal").value);
countAnim2=parseInt(document.getElementById("count_predator").value);
myWinGame= open("", "displayWindow", "width=400,height=300,status=no,toolbar=no,menubar=no,scrollbars=yes");
 myWinGame.document.open();
 myWinGame.document.write("<html><head><title>count animals and predator");
 myWinGame.document.write("</title>");
 myWinGame.document.write("</head><body>");
myWinGame.document.write("<li> <a>Grapth:</a>");
 myWinGame.document.write('<div id="blockGame_id"> <div id="blockGraph"> .</div><div id="blockGraph2"> .</div>'+
'<div id="blockGraphRec"><font size="1">animal</font></div><div id="blockGraphRec2"><font size="1">predator</font></div></div><br><div id="blockGame_id2"></div>');
 myWinGame.document.write("</body></html>");
 myWinGame.document.close(); 
myWinGame.document.getElementById("blockGraph2").style.height=countAnim2+'px';myWinGame.document.getElementById("blockGraph2").innerHTML=countAnim2;
myWinGame.document.getElementById("blockGraph").style.height=countAnim+'px';myWinGame.document.getElementById("blockGraph").innerHTML=countAnim;
myWinGame.document.getElementById("blockGraph").style.width="10px";
myWinGame.document.getElementById("blockGraph").style.height="2px";
myWinGame.document.getElementById("blockGraph").style.background="#ccc"; 
myWinGame.document.getElementById("blockGraph2").style.width="10px";
myWinGame.document.getElementById("blockGraph2").style.height="2px";
myWinGame.document.getElementById("blockGraph2").style.background="#E01414"; 
myWinGame.document.getElementById("blockGraph2").style.position="absolute";
myWinGame.document.getElementById("blockGraph").style.position="absolute";
myWinGame.document.getElementById("blockGraph2").style.bottom="50px";
myWinGame.document.getElementById("blockGraph").style.bottom="50px";
myWinGame.document.getElementById("blockGraphRec").style.bottom="25px";
myWinGame.document.getElementById("blockGraphRec2").style.bottom="25px";
myWinGame.document.getElementById("blockGraph2").style.left="40px";
myWinGame.document.getElementById("blockGraph").style.left="10px";
myWinGame.document.getElementById("blockGraphRec").style.left="7px";
myWinGame.document.getElementById("blockGraphRec").style.position="absolute";
myWinGame.document.getElementById("blockGraphRec2").style.left="35px";
myWinGame.document.getElementById("blockGraphRec2").style.position="absolute";
var new_pos3=new OpenLayers.LonLat(21.10,55.20).transform(
new OpenLayers.Projection("EPSG:4326"),
map.getProjectionObject());
var new_lon3=new_pos3.lon;
var new_lat3=new_pos3.lat;
var origin = new OpenLayers.Geometry.Point(new_lon3, new_lat3);
 var style = {
 strokeColor: "#666666",
 strokeOpacity: 1,
 strokeWidth: 1,
 pointRadius: 2,
 pointerEvents: "visiblePainted"
 };
var t=21.08;
var new_pos2=0;
var new_lon2=0;
var new_lat2=0;
var leftSpace=parseInt(50);
var NumB=0;
intervalID2=window.setInterval(function(){
leftSpace=leftSpace+parseInt(45);
NumB=parseInt(NumB+1);
var t1=myWinGame.document.createElement('div');
t1.id='blockGraph_'+NumB;
var t3=myWinGame.document.createElement('div');
t3.id='blockRecSec_'+NumB;
myWinGame.document.getElementById("blockGame_id2").appendChild(t1);
var t2=myWinGame.document.createElement('div');
t2.id='blockGraph2_'+NumB;
myWinGame.document.getElementById("blockGame_id2").appendChild(t2);
myWinGame.document.getElementById("blockGame_id2").appendChild(t3);
myWinGame.document.getElementById("blockGame_id2").style.left="100px";
myWinGame.document.getElementById('blockGraph_'+NumB).style.width="25px";
myWinGame.document.getElementById('blockGraph2_'+NumB).innerHTML=countAnim2;
myWinGame.document.getElementById('blockGraph_'+NumB).innerHTML=countAnim;
myWinGame.document.getElementById('blockRecSec_'+NumB).innerHTML='<font size="1">'+parseInt(NumB*2)+' sec'+'</font>';
myWinGame.document.getElementById('blockGraph_'+NumB).style.height=countAnim+'px';
myWinGame.document.getElementById('blockGraph_'+NumB).style.background="#ccc"; 
myWinGame.document.getElementById('blockGraph2_'+NumB).style.width="25px";
myWinGame.document.getElementById('blockGraph2_'+NumB).style.height=countAnim2+'px';
myWinGame.document.getElementById('blockGraph2_'+NumB).style.background="#E01414"; 
myWinGame.document.getElementById('blockGraph2_'+NumB).style.position="absolute";
myWinGame.document.getElementById('blockRecSec_'+NumB).style.position="absolute";
myWinGame.document.getElementById('blockGraph_'+NumB).style.position="absolute";
myWinGame.document.getElementById('blockGraph2_'+NumB).style.bottom="50px";
myWinGame.document.getElementById('blockGraph_'+NumB).style.bottom="50px";
myWinGame.document.getElementById('blockRecSec_'+NumB).style.bottom="25px";
myWinGame.document.getElementById('blockGraph2_'+NumB).style.left=leftSpace+'px';
myWinGame.document.getElementById('blockRecSec_'+NumB).style.left=leftSpace+'px';
myWinGame.document.getElementById('blockGraph_'+NumB).style.left=parseInt(leftSpace+25)+'px';leftSpace=leftSpace+parseInt(5);},2000
)
intervalID=window.setInterval(function() {
 var counPol=vectorLayer2.features.length
 for(var a = 0; a <counPol; a++ )
 {
if(parseFloat(vectorLayer2.features[a].attributes.food)<parseFloat(1)&&parseFloat(vectorLayer2.features[a].attributes.food)>=parseFloat(0)){vectorLayer2.features[a].attributes.food=(parseFloat(vectorLayer2.features[a].attributes.food))*(2-parseFloat(vectorLayer2.features[a].attributes.food))+0.01}
 if(parseFloat(vectorLayer2.features[a].attributes.food)>1){vectorLayer2.features[a].attributes.food="1";}
 if(parseFloat(vectorLayer2.features[a].attributes.food)<0){vectorLayer2.features[a].attributes.food="0";}
 }
 var cont=vectorLayer.features.length;
for(var a = 0; a < cont; a++ )
{
new_pos2=new OpenLayers.LonLat(21.08+Math.random(),55.19+Math.random()).transform(
new OpenLayers.Projection("EPSG:4326"),
map.getProjectionObject());
new_lon2=new_pos2.lon;
new_lat2=new_pos2.lat;
if(parseFloat(vectorLayer.features[a].attributes.food)==parseFloat(0)&&vectorLayer.features[a].attributes.mass=="5")
{vectorLayer.destroyFeatures(vectorLayer.features[a]);countAnim=countAnim-1;myWinGame.document.getElementById("blockGraph").style.height=countAnim+'px'; myWinGame.document.getElementById("blockGraph").innerHTML=countAnim;
 return;}
if(parseFloat(vectorLayer.features[a].attributes.effect)<parseInt(1)&&parseFloat(vectorLayer.features[a].attributes.age)>parseInt(150)&&vectorLayer.features[a].attributes.mass=="1")
{vectorLayer.destroyFeatures(vectorLayer.features[a]);countAnim2=countAnim2-1;myWinGame.document.getElementById("blockGraph2").style.height=countAnim2+'px'; myWinGame.document.getElementById("blockGraph2").innerHTML=countAnim2;
 return;}
if(parseFloat(vectorLayer.features[a].attributes.age)>parseInt(190)&&vectorLayer.features[a].attributes.mass=="1")
{vectorLayer.destroyFeatures(vectorLayer.features[a]);countAnim2=countAnim2-1;myWinGame.document.getElementById("blockGraph2").style.height=countAnim2+'px'; myWinGame.document.getElementById("blockGraph2").innerHTML=countAnim2;return;}
moveFeature( vectorLayer.features[a], new_lon2, new_lat2)
 }
 NumIterGame=NumIterGame+1;}, 1000);
}//end game
function stopAnimation() {
 window.clearInterval(intervalID);
window.clearInterval(intervalID2);
 }
 function rotateFeature(feature, angle, origin) {
 feature.geometry.rotate(angle, origin);
 feature.layer.drawFeature(feature);
 }
 function moveFeature(feature, x1, y1) {
if(NumIterGame<1)
 { 
 feature.move(new OpenLayers.LonLat(x1, y1));
 feature.layer.drawFeature(feature);
 }
else
{
if(feature.attributes.mass=="1"){ feature.move(new OpenLayers.LonLat(x1, y1));
 feature.layer.drawFeature(feature);feature.attributes.age=parseInt(feature.attributes.age)+parseInt(1);}
 var DistArr = []
 var counPol=vectorLayer2.features.length
 if (feature.attributes.mass=="5")
 {for(var a = 0; a <counPol; a++ )
 {
 var pointCentr=vectorLayer2.features[a].geometry.getCentroid()
 var dist=feature.geometry.distanceTo(pointCentr);
if(parseFloat(vectorLayer2.features[a].attributes.food)>=0.1)
 { DistArr.push(dist);}
if(parseFloat(vectorLayer2.features[a].attributes.food)==parseFloat(1))
{vectorLayer2.features[a].style.fillColor="#31F20B"; vectorLayer2.features[a].layer.drawFeature(vectorLayer2.features[a]);} 
if(parseFloat(vectorLayer2.features[a].attributes.food)<parseFloat(1)&&parseFloat(vectorLayer2.features[a].attributes.food)>=parseFloat(0.8))
{vectorLayer2.features[a].style.fillColor="#7BF20B";vectorLayer2.features[a].layer.drawFeature(vectorLayer2.features[a]);}
if(parseFloat(vectorLayer2.features[a].attributes.food)<parseFloat(0.8)&&parseFloat(vectorLayer2.features[a].attributes.food)>=parseFloat(0.6))
{ vectorLayer2.features[a].style.fillColor="#D4F20B";vectorLayer2.features[a].layer.drawFeature(vectorLayer2.features[a]);}
if(parseFloat(vectorLayer2.features[a].attributes.food)<parseFloat(0.6)&&parseFloat(vectorLayer2.features[a].attributes.food)>=parseFloat(0.4))
{vectorLayer2.features[a].style.fillColor="#F2DF0B";vectorLayer2.features[a].layer.drawFeature(vectorLayer2.features[a]);}
if(parseFloat(vectorLayer2.features[a].attributes.food)<parseFloat(0.4)&&parseFloat(vectorLayer2.features[a].attributes.food)>=parseFloat(0.2))
{vectorLayer2.features[a].style.fillColor="#F2A90B";vectorLayer2.features[a].layer.drawFeature(vectorLayer2.features[a]);}
if(parseFloat(vectorLayer2.features[a].attributes.food)<parseFloat(0.2)&&parseFloat(vectorLayer2.features[a].attributes.food)>parseFloat(0))
{vectorLayer2.features[a].style.fillColor="#F2770B";vectorLayer2.features[a].layer.drawFeature(vectorLayer2.features[a]);}
if(parseFloat(vectorLayer2.features[a].attributes.food)==parseFloat(0))
{vectorLayer2.features[a].style.fillColor="#F20F0B";vectorLayer2.features[a].layer.drawFeature(vectorLayer2.features[a]);}
 }
 }
 var minDist = parseFloat(DistArr[0]);
 var maxDist = parseFloat(minDist) ;
 for (i = 1; i < DistArr.length; ++i) {
 if (DistArr[i] > parseFloat(maxDist) ) maxDist = parseFloat(DistArr[i]);
 if( DistArr[i] < parseFloat(minDist) ) minDist = parseFloat(DistArr[i]);
 }
 if (feature.attributes.mass=="5")
 {for(var a = 0; a <counPol; a++ )
 {
 var pointCentr=vectorLayer2.features[a].geometry.getCentroid()
 var dist=feature.geometry.distanceTo(pointCentr);
 if(isNaN(minDist)==true){feature.attributes.food=parseFloat(feature.attributes.food)-parseFloat(0.25)}
 if(parseFloat(feature.attributes.food)<0){feature.attributes.food="0";}
 if(dist==minDist)
 {feature.move(new OpenLayers.LonLat(pointCentr.x+Math.random()*(0.001*pointCentr.x), pointCentr.y+Math.random()*(0.001*pointCentr.y)));
 feature.layer.drawFeature(feature);
 var intersect1 = (feature.geometry.intersects(vectorLayer2.features[a].geometry));
 if(intersect1==true)
 { 
 vectorLayer2.features[a].attributes.food=parseFloat(vectorLayer2.features[a].attributes.food) -parseFloat(0.1);
 feature.attributes.food=parseFloat(feature.attributes.food)+parseFloat(0.1);if(parseFloat(feature.attributes.food)>1){feature.attributes.food="1";}
 if(parseFloat(vectorLayer2.features[a].attributes.food)<=0){vectorLayer2.features[a].attributes.food="0";feature.attributes.food=parseFloat(feature.attributes.food)-parseFloat(0.25)}
 }
 }
 }
 }
}
var count=vectorLayer.features.length;
for(var a = 0; a < count; a++ )
{
if(feature!=vectorLayer.features[a])
{
var XleftInterval=vectorLayer.features[a].geometry.x-(feature.geometry.x*0.01)/100;
var XrightInterval=vectorLayer.features[a].geometry.x+(feature.geometry.x*0.01)/100;
var YleftInterval=vectorLayer.features[a].geometry.y-(feature.geometry.y*0.01)/100
var YrightInterval=vectorLayer.features[a].geometry.y+(feature.geometry.y*0.01)/100
if (feature.attributes.mass=="1"&&parseInt(feature.attributes.effect)>=1)
{
var radPred=parseInt(feature.attributes.effect);
if(parseInt(feature.attributes.effect)>=11){radPred=parseInt(11);}
var XleftInterval=vectorLayer.features[a].geometry.x-(feature.geometry.x*0.1*radPred)/100;
var XrightInterval=vectorLayer.features[a].geometry.x+(feature.geometry.x*0.1*radPred)/100;
var YleftInterval=vectorLayer.features[a].geometry.y-(feature.geometry.y*0.1*radPred)/100
var YrightInterval=vectorLayer.features[a].geometry.y+(feature.geometry.y*0.1*radPred)/100
}
if(feature.geometry.x<=XrightInterval&&feature.geometry.x>=XleftInterval&&feature.geometry.y<=YrightInterval&&feature.geometry.y>=YleftInterval)
{
var new_pos=new OpenLayers.LonLat(21.08,55.19).transform(
new OpenLayers.Projection("EPSG:4326"),
map.getProjectionObject());
var new_lon=new_pos.lon;
var new_lat=new_pos.lat;
 var style_blue = OpenLayers.Util.extend({}, OpenLayers.Feature.Vector.style['default']);
 style_blue.strokeColor = "blue"; style_blue.fillColor = "blue"; style_blue.pointRadius=3;
 var style_green = OpenLayers.Util.extend({}, OpenLayers.Feature.Vector.style['default']);
 style_green.strokeColor = "green"; 
 style_green.fillColor = "green"; 
 var style_green = {
 strokeColor: "#339933",
 strokeOpacity: 1,
 strokeWidth: 3,
 pointRadius: 3,
 pointerEvents: "visiblePainted"
 };
var att={};
att.mass="5";
 var point3 = new OpenLayers.Geometry.Point(new_lon, new_lat);
var pointFeature3 = new OpenLayers.Feature.Vector(point3, att, style_green);
 pointFeature3.attributes.mass="1";
pointFeature3.data.mass="1";
pointFeature3.attributes.effect="0";
pointFeature3.attributes.age="0"
pointFeature3.data.effect="0";
var point = new OpenLayers.Geometry.Point(new_lon, new_lat); 
var pointFeature = new OpenLayers.Feature.Vector(point, att, style_blue);
pointFeature.data.mass="5";
if (feature.attributes.mass=="1"&&vectorLayer.features[a].attributes.mass!="1")
 {feature.attributes.effect=parseInt(parseInt(feature.attributes.effect)+1)
 vectorLayer.destroyFeatures(vectorLayer.features[a]);
 countAnim=countAnim-1;
if (parseInt(feature.attributes.effect)>=1)
 { 
 pointFeature3.attributes.mass="1";pointFeature3.attributes.effect="0";pointFeature3.data.mass="1";pointFeature3.data.effect="0"; pointFeature3.attributes.age="0";vectorLayer.addFeatures(pointFeature3);countAnim2=countAnim2+1;
 myWinGame.document.getElementById("blockGraph2").style.height=countAnim2+'px';
myWinGame.document.getElementById("blockGraph2").innerHTML=countAnim2;
 }
 myWinGame.document.getElementById("blockGraph").style.height=countAnim+'px';myWinGame.document.getElementById("blockGraph").innerHTML=countAnim;return;
 }
 if (feature.attributes.mass=="5"&&vectorLayer.features[a].attributes.mass=="5"&&parseFloat(feature.attributes.food)==1&&parseFloat(vectorLayer.features[a].attributes.food)==1)
 { pointFeature.attributes.mass="5";
pointFeature.attributes.effect="0";
pointFeature.attributes.food="1";
pointFeature.data.mass="5";
pointFeature.data.effect="0";
 vectorLayer.addFeatures(pointFeature); countAnim=countAnim+1; 
 myWinGame.document.getElementById("blockGraph").style.height=countAnim+'px';
 myWinGame.document.getElementById("blockGraph").innerHTML=countAnim;
 }
if(count>=document.getElementById("GamePop_id").value)
{stopAnimation();alert ("count "+count);}
 }}
 }
 }
function TestIntersection()
{
}
function endPart()
{map.removePopup(popup_interW); }

function ZoomLayer()
{
if(this.document.getElementById("editL1").value=="0")
{alert ("выберите название слоя в списке 'Редактируемый слой'");return;}
var minDistC = parseFloat(edilayerMainLayer.features[0].geometry.bounds.left);
var  maxDistC = parseFloat(minDistC) ;
for (var ia = 1; ia <  edilayerMainLayer.features.length; ++ia) { var NumSS=edilayerMainLayer.features[ia].geometry.bounds.left;
if (NumSS>parseFloat(maxDistC) ) {maxDistC =  parseFloat(NumSS);}
if( NumSS<parseFloat(minDistC) ) {minDistC  = parseFloat(NumSS);}
}

var x1=minDistC ;
var minDistC = parseFloat(edilayerMainLayer.features[0].geometry.bounds.right);
var  maxDistC = parseFloat(minDistC) ;
for (var ia = 1; ia <  edilayerMainLayer.features.length; ++ia) { var NumSS=edilayerMainLayer.features[ia].geometry.bounds.right;
if (NumSS>parseFloat(maxDistC) ) {maxDistC =  parseFloat(NumSS);}
if( NumSS<parseFloat(minDistC) ) {minDistC  = parseFloat(NumSS);}
}

var x2=maxDistC;
var minDistC = parseFloat(edilayerMainLayer.features[0].geometry.bounds.bottom);
var  maxDistC = parseFloat(minDistC) ;
for (var ia = 1; ia <  edilayerMainLayer.features.length; ++ia) { var NumSS=edilayerMainLayer.features[ia].geometry.bounds.bottom;
if (NumSS>parseFloat(maxDistC) ) {maxDistC =  parseFloat(NumSS);}
if( NumSS<parseFloat(minDistC) ) {minDistC  = parseFloat(NumSS);}
}

var y1=minDistC ;
var minDistC = parseFloat(edilayerMainLayer.features[0].geometry.bounds.top);
var  maxDistC = parseFloat(minDistC) ;
for (var ia = 1; ia <  edilayerMainLayer.features.length; ++ia) { var NumSS=edilayerMainLayer.features[ia].geometry.bounds.top;
if (NumSS>parseFloat(maxDistC) ) {maxDistC =  parseFloat(NumSS);}
if( NumSS<parseFloat(minDistC) ) {minDistC  = parseFloat(NumSS);}
}

var y2=maxDistC;


var bound=new OpenLayers.Bounds(x1,y1,x2,y2);
map.zoomToExtent(bound);

}

function RemoveLayer(map)
{
var bbox = document.getElementById("mapResize").parentNode.getBoundingClientRect();
bbox.top=0;
bbox.left=0;
 var body = document.body
 var docElem = document.documentElement
 var scrollTop = window.pageYOffset || docElem.scrollTop || body.scrollTop
 var scrollLeft = window.pageXOffset || docElem.scrollLeft || body.scrollLeft
 var clientTop = docElem.clientTop || body.clientTop || 0
 var clientLeft = docElem.clientLeft || body.clientLeft || 0
 var topTop = bbox.top + scrollTop - clientTop
 var leftLeft = bbox.left + scrollLeft - clientLeft
var DivEditeLeg=document.createElement("div");
DivEditeLeg.id="id_divRemoveLayer2";
DivEditeLeg.style.width=600;
DivEditeLeg.style.height=400;
DivEditeLeg.className="id_divRemoveLayer";
DivEditeLeg.style.position="absolute";

DivEditeLeg.style.left=Math.round(document.body.clientWidth/2-300);
DivEditeLeg.style.top=Math.round(document.body.clientHeight/2-200);
DivEditeLeg.innerHTML='<div id="id_divControlRemoveLayerLeg" style="background:#ffffff; color:#0000ff;z-index: 600000;position:relative;'+
'px;overflow:hidden; border: 1px solid black; width:600px;height:200px;"><img onclick="closeRemoveLayerWin()" src="openlayers/theme/default/img/close.gif" style="position:relative; top:3px left:50px;float:right; cursor:pointer"><a style="position:relative; top:20px"></a>'+'<div id="id_divControlRemoveLayerLeg2" style="top:10px;position:relative"></div>'+'</div>';

var htmlRemL='<a>.Удалить слой</a><br><li> <a>Список слоёв:</a>'+'<select id="SelectorRemoveLayer" onchange='+'setSel(value)'+'>'+
" <option value="+"full"+">.</option> </select> </li>"+
"<div> <p>"+
' <button type="button" onclick="OKRemLay()">OK</button></p></div>'+
"<center><font size=+3>"+
"</font></center>";
if(!document.getElementById("id_divControlRemoveLayerLeg"))
{body.appendChild(DivEditeLeg);document.getElementById("id_divControlRemoveLayerLeg2").innerHTML=htmlRemL;}
document.getElementById("id_divRemoveLayer2").onmousedown=function(event){drags(event)};
document.getElementById("id_divRemoveLayer2").onmouseup=function(e){enddrag()};
var mLayers = map.layers;
for(var a = 0; a < mLayers.length; a++ ){
 var t=document.createElement('option');
t.value=mLayers[a].name;
t.text=mLayers[a].name;
document.getElementById('SelectorRemoveLayer').appendChild(t);
};
}
function closeRemoveLayerWin()
{document.getElementById("id_divRemoveLayer2").parentNode.removeChild(document.getElementById("id_divRemoveLayer2"));}
function OKRemLay(){document.getElementById("id_divRemoveLayer2").parentNode.removeChild(document.getElementById("id_divRemoveLayer2"));}
function setSel(value)
{layerSel=value; sellayer3=layerSel; var remSel=document.getElementById("SelectorRemoveLayer"); RemoveLayer2(map,remSel); }
function RemoveLayer2(map,remSel)
{
if(document.getElementById('editL1').value==sellayer3)
{if ( highlightCtrl){highlightCtrl.destroy();selectCtrl.destroy();}}
var mLayers = map.layers;
for(var a = 0; a < mLayers.length; a++ ){
if(mLayers[a].name==sellayer3)
{
for (var k=0; k<remSel.length; k++)
{if(remSel.options[k].value==mLayers[a].name){remSel.removeChild(remSel.options[k]);}}
var ListL=document.getElementById('editL1');
for (var k=0; k<ListL.length; k++)
{if(ListL.options[k].value==mLayers[a].name){ListL.removeChild(ListL.options[k]);}}
//map.removeLayer(mLayers[a]);
if(document.getElementById("WikiLayerAdd_id"))
{var wl=document.getElementById("WikiLayerAdd_id");
for (var k=0; k<wl.length; k++)
{if(wl.options[k].value==mLayers[a].name){wl.removeChild(wl.options[k]);}}
}
if(mLayers[a].attribution&&mLayers[a].attribution=='&copy; <a href="http://osmbuildings.org">OSM Buildings</a>'){OSMBuildings='';osmb='';
for(var mpv=0;mpv<map.events.listeners.click.length;mpv++)
{if(map.events.listeners.click[mpv].obj.clickosmowg&&map.events.listeners.click[mpv].obj.clickosmowg=='clickosmowg'){map.events.listeners.click.splice(mpv,1);mpv--;}}
}
mLayers[a].destroy();
}
}
}
function updateLegend()
{
var pRad;
var mLayers = map.layers;
for(var a = 0; a < mLayers.length; a++ )
{
if(mLayers[a].name==layerLegendMain)
{
if(typeof graticuleCtl2!=='undefined'&&mLayers[a]==graticuleCtl2.gratLayer)
{graticuleCtl2.gratLayer.styleMap.styles.default.propertyStyles=GraticulePropertyStyles;
graticuleCtl2.gratLayer.styleMap.styles.default.rules[0].symbolizer.Line.strokeColor=StrokeColorLegend;
graticuleCtl2.gratLayer.styleMap.styles.default.rules[0].symbolizer.Line.strokeWidth=pStrokeLegend;
graticuleCtl2.gratLayer.styleMap.styles.default.rules[0].symbolizer.Line.strokeOpacity=pOpacityLegend;
graticuleCtl2.gratLayer.styleMap.styles.default.rules[0].symbolizer.fillColor=StrokeColorLegend;
graticuleCtl2.gratLayer.redraw();
graticuleCtl2.gratLayer.setVisibility(false);
graticuleCtl2.gratLayer.setVisibility(true);
return;
}
mLayers[a].styleMap.styles.default.defaultStyle.pointRadius=pRadLegend;
mLayers[a].styleMap.styles.default.defaultStyle.strokeWidth=pStrokeLegend;
mLayers[a].styleMap.styles.default.defaultStyle.fillOpacity=pOpacityLegend;
mLayers[a].styleMap.styles.default.defaultStyle.strokeOpacity=pOpacityLegend;
mLayers[a].styleMap.styles.default.defaultStyle.externalGraphic=pLegendImageWebGis;
mLayers[a].styleMap.styles.default.defaultStyle.graphicWidth=15;
mLayers[a].styleMap.styles.default.defaultStyle.graphicHeight=15;
mLayers[a].styleMap.styles.default.defaultStyle.fillColor=fillColorLegend;
mLayers[a].styleMap.styles.default.defaultStyle.strokeColor=StrokeColorLegend;
var rulestLayer;
var rulesArray= new Array();
var rulesEl= new Array();
var arrayt=new Array();
var newLegendDiv='';
for(var i=0; i<=LegendIndexMain.length-1; ++i) 
{
var strLab='';
var strlab1='';
var rowc='';
if(labelAtrrinuteArrayMain[i].name)
{if(labelAtrrinuteArrayMain[i].rowcol==true){rowc='\n';}
if(labelAtrrinuteArrayMain[i].name)
{
for(var z=0;z<labelAtrrinuteArrayMain[i].name.length;z++)
{
if(labelAtrrinuteArrayMain[i].ckeckname==true)
{strlab1=labelAtrrinuteArrayMain[i].name[z]+":";}
var dop='';if(z>0){dop=' ';}
strLab+=dop+strlab1+"${"+labelAtrrinuteArrayMain[i].name[z]+"}"+rowc;
}}
if(labelAtrrinuteArrayMain[i].randomText==true)
{strLab=labelAtrrinuteArrayMain[i].randomTextText;}
}


var strWidthline=1;
if(mLayers[a].features[0]&&(mLayers[a].features[0].geometry.CLASS_NAME=='OpenLayers.Geometry.MultiLineString'||mLayers[a].features[0].geometry.CLASS_NAME=='OpenLayers.Geometry.LineString'))
{strWidthline=SizeInputMain[i].value;}
else{strWidthline=1;}

 rulesEl[i]=
 new OpenLayers.Rule({
 title: "< 15.182 grad",
 filter: new OpenLayers.Filter.Comparison({
 type: OpenLayers.Filter.Comparison.BETWEEN,
 property: LegendFieldMain,
 upperBoundary:parseFloat(LegendValueMain[2*i+1].value),
 lowerBoundary: parseFloat(LegendValueMain[2*i].value)
 }),
 symbolizer: {
 pointRadius: SizeInputMain[i].value,
 fillColor: divPalBMain[i].style.backgroundColor,
 strokeColor: LegendStrockRMain[i].style.backgroundColor,
 strokeWidth: strWidthline,
 label:strLab
 }
 });
 
  if(labelAtrrinuteArrayMain[i].name){if(labelAtrrinuteArrayMain[i].name.length>0||labelAtrrinuteArrayMain[i].randomText==true)
{
rulesEl[i].symbolizer.fontColor=labelAtrrinuteArrayMain[i].colorlab;
rulesEl[i].symbolizer.fontSize=labelAtrrinuteArrayMain[i].fontsize+"px";
rulesEl[i].symbolizer.fontFamily=labelAtrrinuteArrayMain[i].fontFamily;
rulesEl[i].symbolizer.fontWeight=labelAtrrinuteArrayMain[i].fontWeight;
rulesEl[i].symbolizer.labelAlign=labelAtrrinuteArrayMain[i].fontAlign;
rulesEl[i].symbolizer.fontOpacity=labelAtrrinuteArrayMain[i].fontopac;
rulesEl[i].symbolizer.fontStyle=labelAtrrinuteArrayMain[i].fontStyle
rulesEl[i].symbolizer.labelOutlineColor="white";
rulesEl[i].symbolizer.labelOutlineWidth=3;
}}
 
 
if(imageMarkerArWebGis[i]!=='')
{rulesEl[i].symbolizer["externalGraphic"]=imageMarkerArWebGis[i];
if(imageMarkerArWebGisWH[i]&&(imageMarkerArWebGisWH[i].split(",")[0])){rulesEl[i].symbolizer["graphicWidth"]=parseInt(imageMarkerArWebGisWH[i].split(",")[0]);}
if(imageMarkerArWebGisWH[i]&&(imageMarkerArWebGisWH[i].split(",")[0])){rulesEl[i].symbolizer["graphicHeight"]=parseInt(imageMarkerArWebGisWH[i].split(",")[1]);}
}
 newLegendDiv+='<div id="'+mLayers[a].name+'StartLegendDivLayer'+i+'"><a>field: '+ LegendFieldMain+'</a><br><a>from:'+LegendValueMain[2*i].value+' to:'+LegendValueMain[2*i+1].value+'</a>'+
'<style type="text/css">.blockk'+mLayers[a].id.split('.')[2]+'_'+i+'{ background:'+divPalBMain[i].style.backgroundColor+'; width: 15px; height: 4px; padding: 0px; margin: 0px; border: outset 1px black;}</style> <div class=blockk'+mLayers[a].id.split('.')[2]+'_'+i+'>.</div></br></div>'
}
for(var i=0; i<=LegendTextMain.length-1; ++i) 
{

var strLab='';
var strlab1='';
var rowc='';
if(labelAtrrinuteArrayMain[i].name)
{if(labelAtrrinuteArrayMain[i].rowcol==true){rowc='\n';}
if(labelAtrrinuteArrayMain[i].name)
{
for(var z=0;z<labelAtrrinuteArrayMain[i].name.length;z++)
{
if(labelAtrrinuteArrayMain[i].ckeckname==true)
{strlab1=labelAtrrinuteArrayMain[i].name[z]+":";}
var dop='';if(z>0){dop=' ';}
strLab+=dop+strlab1+"${"+labelAtrrinuteArrayMain[i].name[z]+"}"+rowc;
}}
if(labelAtrrinuteArrayMain[i].randomText==true)
{strLab=labelAtrrinuteArrayMain[i].randomTextText;}
}
var strWidthline=1;
if(mLayers[a].features[0]&&(mLayers[a].features[0].geometry.CLASS_NAME=='OpenLayers.Geometry.MultiLineString'||mLayers[a].features[0].geometry.CLASS_NAME=='OpenLayers.Geometry.LineString'))
{strWidthline=SizeInputMain[i].value;}
else{strWidthline=1;}
 rulesEl[i]=
 new OpenLayers.Rule({
 title: "< 15.182 grad",
 filter: new OpenLayers.Filter.Comparison({
 type: OpenLayers.Filter.Comparison.EQUAL_TO,
 property: LegendFieldMain,
 value:LegendTextNameMain[i]
 }),
 symbolizer: {
 pointRadius: SizeInputMain[i].value,
 fillColor: divPalBMain[i].style.backgroundColor,
 strokeColor: LegendStrockRMain[i].style.backgroundColor,
 strokeWidth: strWidthline,
label:strLab
 }
 });
   if(labelAtrrinuteArrayMain[i].name){if(labelAtrrinuteArrayMain[i].name.length>0||labelAtrrinuteArrayMain[i].randomText==true)
{
rulesEl[i].symbolizer.fontColor=labelAtrrinuteArrayMain[i].colorlab;
rulesEl[i].symbolizer.fontSize=labelAtrrinuteArrayMain[i].fontsize+"px";
rulesEl[i].symbolizer.fontFamily=labelAtrrinuteArrayMain[i].fontFamily;
rulesEl[i].symbolizer.fontWeight=labelAtrrinuteArrayMain[i].fontWeight;
rulesEl[i].symbolizer.labelAlign=labelAtrrinuteArrayMain[i].fontAlign;
rulesEl[i].symbolizer.fontOpacity=labelAtrrinuteArrayMain[i].fontopac;
rulesEl[i].symbolizer.fontStyle=labelAtrrinuteArrayMain[i].fontStyle
rulesEl[i].symbolizer.labelOutlineColor="white";
rulesEl[i].symbolizer.labelOutlineWidth=3;
}}
 
 
 
if(imageMarkerArWebGis[i]!=='')
{rulesEl[i].symbolizer["externalGraphic"]=imageMarkerArWebGis[i];
if(imageMarkerArWebGisWH[i]&&(imageMarkerArWebGisWH[i].split(",")[0])){rulesEl[i].symbolizer["graphicWidth"]=parseInt(imageMarkerArWebGisWH[i].split(",")[0]);}
if(imageMarkerArWebGisWH[i]&&(imageMarkerArWebGisWH[i].split(",")[0])){rulesEl[i].symbolizer["graphicHeight"]=parseInt(imageMarkerArWebGisWH[i].split(",")[1]);}
}
 newLegendDiv+='<div id="'+mLayers[a].name+'StartLegendDivLayer'+i+'"><a>field: '+ LegendFieldMain+'</a><br><a>LegendTextNameMain[i]+</a>'+
'<style type="text/css">.blockk'+mLayers[a].id.split('.')[2]+'_'+i+'{ background:'+divPalBMain[i].style.backgroundColor+'; width: 15px; height: 4px; padding: 0px; margin: 0px; border: outset 1px black;}</style> <div class=blockk'+mLayers[a].id.split('.')[2]+'_'+i+'>.</div></br></div>'
}
if(LegendIndexMain.length>0||LegendTextMain>0)
 {var NewDivLeg1=document.createElement("div");
NewDivLeg1.id=mLayers[a].name+"LayerLegendDivN_"+a;NewDivLeg1.innerHTML=newLegendDiv;
newLegendDivMain=newLegendDiv;
 var NewLegDiv=document.getElementById(mLayers[a].name+"Leg_"+a);
 var NewLegDiv2=document.getElementById(mLayers[a].name+"LayerLegendDivN_"+a);
NewLegDiv.childNodes[0].parentNode.removeChild(NewLegDiv2);
NewLegDiv.appendChild(NewDivLeg1);
 }
if (window.StrokeColorLegend == undefined)
{StrokeColorLegend="#666666"}
if (window.pRadLegend == undefined)
{pRadLegend=3}
if (window.fillColorLegend == undefined)
{fillColorLegend="#FF693F"}
var strLab='';
var strlab1='';
var rowc='';
if(labelAtrrinuteMain.rowcol==true){rowc='\n';}
if(labelAtrrinuteMain.name)
{
for(var z=0;z<labelAtrrinuteMain.name.length;z++)
{
if(labelAtrrinuteMain.ckeckname==true)
{strlab1=labelAtrrinuteMain.name[z]+":";}
var dop='';if(z>0){dop=' ';}
strLab+=dop+strlab1+"${"+labelAtrrinuteMain.name[z]+"}"+rowc;
}}
if(labelAtrrinuteMain.randomText==true)
{strLab=labelAtrrinuteMain.randomTextText;}
styleN= new OpenLayers.Style({
 pointRadius: pRadLegend,
fillColor: fillColorLegend,
 strokeColor:StrokeColorLegend,
 strokeWidth: pStrokeLegend,
fillOpacity:pOpacityLegend,
 strokeOpacity:pOpacityLegend,
label:strLab
});
//if(typeof labelAtrrinuteMain !=='undefined'&&typeof labelAtrrinuteMain.name !=='undefined'&&labelAtrrinuteMain.name!=='')
if(labelAtrrinuteMain.name.length>0||labelAtrrinuteMain.randomText==true)
{//styleN.defaultStyle.label=labelAtrrinuteMain.name+": "+"${"+labelAtrrinuteMain.name+"}";
styleN.defaultStyle.fontColor=labelAtrrinuteMain.colorlab;
styleN.defaultStyle.fontSize=labelAtrrinuteMain.fontsize+"px";
styleN.defaultStyle.fontFamily=labelAtrrinuteMain.fontFamily;
styleN.defaultStyle.fontWeight=labelAtrrinuteMain.fontWeight;
styleN.defaultStyle.labelAlign=labelAtrrinuteMain.fontAlign;
styleN.defaultStyle.fontOpacity=labelAtrrinuteMain.fontopac;
styleN.defaultStyle.fontStyle=labelAtrrinuteMain.fontStyle
styleN.defaultStyle.labelOutlineColor="white";
styleN.defaultStyle.labelOutlineWidth=3;
}
var styleNS= new OpenLayers.Style({fillColor:"#ffaa00",
fillOpacity:1,
pointRadius:5,
strokeColor:"#00DDFF",
strokeOpacity:1,
strokeWidth:2});
if(pLegendImageWebGis)
{styleN.defaultStyle["externalGraphic"]=pLegendImageWebGis;
styleN.defaultStyle["graphicWidth"]=pLegendImageWebGisW;
styleN.defaultStyle["graphicHeight"]=pLegendImageWebGisH;
}
if(pLegendImageWebGis)
{styleNS.defaultStyle["externalGraphic"]=pLegendImageWebGis;
styleNS.defaultStyle["graphicWidth"]=parseInt(pLegendImageWebGisW)+5;
styleNS.defaultStyle["graphicHeight"]=parseInt(pLegendImageWebGisH)+5;
}
mLayers[a].styleMap.styles.default=styleN;
mLayers[a].styleMap.styles.select=styleNS;
for (var iu=0;iu<=rulesEl.length-1;++iu)
{//alert(rulesEl[iu]);
mLayers[a].styleMap.styles.default.addRules([rulesEl[iu]]);}
if (mLayers[a].visibility==true)
{mLayers[a].setVisibility(false); mLayers[a].setVisibility(true);}
if (mLayers[a].visibility==false)
{mLayers[a].setVisibility(true);mLayers[a].setVisibility(false);}
}
}
}
function overPunkt(obj_listPunkt)
{
obj_listPunkt.childNodes[1].style.display="block";
obj_listPunkt.childNodes[1].style.top=obj_listPunkt.offsetHeight;
obj_listPunkt.style.background="#5ddb5d";
obj_listPunkt.style.padding=0;
obj_listPunkt.childNodes[0].style.border="solid 1px #000";
obj_listPunkt.childNodes[0].style.borderBottom="none";
color_text=obj_listPunkt.style.color;
obj_listPunkt.style.color="#dfd";
}
function outPunkt(obj_listPunkt)
{
obj_listPunkt.childNodes[1].style.display="none";
obj_listPunkt.style.background="transparent";
obj_listPunkt.style.padding=1;
obj_listPunkt.style.paddingBottom=0;
obj_listPunkt.childNodes[0].style.border="none";
obj_listPunkt.style.color=color_text;
}
function overPunkt2(obj_listPunkt)
{
obj_listPunkt.style.background="#0000ff";
obj_listPunkt.style.padding=0;
obj_listPunkt.childNodes[0].style.border="solid 0px #000";
obj_listPunkt.childNodes[0].style.borderBottom="none";
color_text=obj_listPunkt.style.color;
obj_listPunkt.style.color="#dfd";
}
function outPunkt2(obj_listPunkt)
{
obj_listPunkt.style.background="transparent";
obj_listPunkt.style.padding=1;
obj_listPunkt.style.paddingBottom=0;
obj_listPunkt.childNodes[0].style.border="none";
obj_listPunkt.style.color=color_text;
}
function SeteditlayerMain(editlayerM)
{editlayerMainName=editlayerM;
if(panel){panel.deactivate();
panel.destroy();
panel=null;}
var mLayers = map.layers;
if(editlayerMainName=="0")
{ if ( highlightCtrl){highlightCtrl.destroy();selectCtrl.destroy();}
}
for(var ab = 0; ab < mLayers.length; ab++ )
{
if(mLayers[ab].name==editlayerMainName)
{edilayerMainLayer=mLayers[ab];
highlightCtrl.destroy();
selectCtrl .destroy();
var mLayers = map.layers;
for(var aa = 0; aa < mLayers.length; aa++ )
{if (mLayers[aa].name==editlayerM){ edilayerMainLayer=mLayers[aa];} }
var report = function(e) {
 };
highlightCtrl = new OpenLayers.Control.SelectFeature(edilayerMainLayer, {
 hover: true,
 highlightOnly: true,
 renderIntent: edilayerMainLayer.styleMap.styles.selectStyles,
 eventListeners: {
 'beforefeaturehighlighted': report,
 'featurehighlighted':report,
 'featureunhighlighted': report
 }
 });
 selectCtrl = new OpenLayers.Control.SelectFeature(edilayerMainLayer,
 {clickout: true}
 );
 map.addControl(highlightCtrl);
 map.addControl(selectCtrl);
 highlightCtrl.activate();
 selectCtrl.activate();
if( highlightCtrl)
{
edilayerMainLayer.events.unregister('featureselected', edilayerMainLayer, regFeatureSelected);
edilayerMainLayer.events.unregister('featureunselected', edilayerMainLayer, onFeatureUnselect);
}
edilayerMainLayer.events.on({"featureselected":regFeatureSelected,'featureunselected': onFeatureUnselect });
}
}
panel = new OpenLayers.Control.Panel({
 displayClass: 'customEditingToolbar',
 allowDepress: true
 });
 var drawLine = new OpenLayers.Control.DrawFeature(
 edilayerMainLayer, OpenLayers.Handler.Path,
 {displayClass: 'olControlDrawFeaturePath',multi: true,title:'Добавить линию'}
 );
 drawLine.featureAdded = function(feature) {
feature.attributes={};
feature.data={};
if(edilayerMainLayer.features.length>2&&edilayerMainLayer.features[edilayerMainLayer.features.length-2].fid)
{
var numberP=parseInt(edilayerMainLayer.features[edilayerMainLayer.features.length-2].fid.split('.')[1])+parseInt(1);
var lnewFid=edilayerMainLayer.features[edilayerMainLayer.features.length-2].fid.split('.')[0]+"."+numberP;
}
else{var lnewFid=edilayerMainLayer.name+"."+parseInt(edilayerMainLayer.features.length);}
feature.fid=lnewFid;
for (var i in edilayerMainLayer.features[0].attributes)
{var name = i; feature.attributes[name]="0";feature.data[name]="0";
}

 feature.state = OpenLayers.State.INSERT;
 feature.layer.drawFeature(feature);
 }
  var drawLineRule = new OpenLayers.Control.DrawFeature(
 edilayerMainLayer, OpenLayers.Handler.Path,
 {displayClass: 'ControlRuleFeatures',multi: true,title: "Измерить расстояние"}
 );
  drawLineRule.featureAdded = function(feature) {
feature.attributes={};
feature.data={};
if(edilayerMainLayer.features.length>2&&edilayerMainLayer.features[edilayerMainLayer.features.length-2].fid)
{
var numberP=parseInt(edilayerMainLayer.features[edilayerMainLayer.features.length-2].fid.split('.')[1])+parseInt(1);
var lnewFid=edilayerMainLayer.features[edilayerMainLayer.features.length-2].fid.split('.')[0]+"."+numberP;
}
else{var lnewFid=edilayerMainLayer.name+"."+parseInt(edilayerMainLayer.features.length);}
feature.fid=lnewFid;
for (var i in edilayerMainLayer.features[0].attributes)
{var name = i; feature.attributes[name]="0";feature.data[name]="0";
}

 feature.state = OpenLayers.State.INSERT;
 feature.layer.drawFeature(feature);
 }
 var drawPoligon = new OpenLayers.Control.DrawFeature(
 edilayerMainLayer, OpenLayers.Handler.Polygon,
 {displayClass: 'olControlDrawFeaturePolygon',multi:true,title: "Добавить полигон"}
 );
 drawPoligon.featureAdded = function(feature) {
feature.attributes={};
feature.data={};
if(edilayerMainLayer.features.length>2&&edilayerMainLayer.features[edilayerMainLayer.features.length-2].fid)
{
var numberP=parseInt(edilayerMainLayer.features[edilayerMainLayer.features.length-2].fid.split('.')[1])+parseInt(1);
var lnewFid=edilayerMainLayer.features[edilayerMainLayer.features.length-2].fid.split('.')[0]+"."+numberP;
}
else{var lnewFid=edilayerMainLayer.name+"."+parseInt(edilayerMainLayer.features.length);}
feature.fid=lnewFid;
for (var i in edilayerMainLayer.features[0].attributes)
{var name = i; feature.attributes[name]="0";feature.data[name]="0";
}
 feature.state = OpenLayers.State.INSERT;
 feature.layer.drawFeature(feature);
 }
var drawPoint = new OpenLayers.Control.DrawFeature(
 edilayerMainLayer, OpenLayers.Handler.Point,
 {
 title: "Добавить точку",
 displayClass: "olControlDrawFeaturePoint",
 multi: false
 }
 ); 
 drawPoint.featureAdded = function(feature) { 
feature.attributes={};
feature.data={};
if(edilayerMainLayer.features.length>2&&edilayerMainLayer.features[edilayerMainLayer.features.length-2].fid)
{
var numberP=parseInt(edilayerMainLayer.features[edilayerMainLayer.features.length-2].fid.split('.')[1])+parseInt(1);
var lnewFid=edilayerMainLayer.features[edilayerMainLayer.features.length-2].fid.split('.')[0]+"."+numberP;
}
else{var lnewFid=edilayerMainLayer.name+"."+parseInt(edilayerMainLayer.features.length);}
feature.fid=lnewFid;
for (var i in edilayerMainLayer.features[0].attributes)
{var name = i; feature.attributes[name]="0";feature.data[name]="0";
}
 feature.state = OpenLayers.State.INSERT; 
edilayerMainLayer.drawFeature(feature);
 };
var edit = new OpenLayers.Control.ModifyFeature(edilayerMainLayer, {
title: "Редактировать(модифицировать) элемент слоя",
displayClass: "olControlModifyFeature"
});
var del = new DeleteFeature(edilayerMainLayer, {title: "Удалить элемент слоя"});
del.events.register("activate", del, function(){
if(edilayerMainLayer.selectedFeatures.length>0)
{
del.panel_div.id="ControlDel_id";

var bbox = document.getElementById("ControlDel_id").parentNode.getBoundingClientRect();
 var body = document.body
 var docElem = document.documentElement
 var scrollTop = window.pageYOffset || docElem.scrollTop || body.scrollTop
 var scrollLeft = window.pageXOffset || docElem.scrollLeft || body.scrollLeft
 var clientTop = docElem.clientTop || body.clientTop || 0
 var clientLeft = docElem.clientLeft || body.clientLeft || 0
 var topTop = bbox.top + scrollTop - clientTop
 var leftLeft = bbox.left + scrollLeft - clientLeft
var DivEditeLeg=document.createElement("div");
DivEditeLeg.id="id_divControlDel2";
DivEditeLeg.className="id_divControlmeasureGisSq";
DivEditeLeg.style.position="relative";
DivEditeLeg.innerHTML='<div id="id_divControlDelLeg" style="background:#ffffff; color:#0000ff;z-index: 6000;position:absolute;left:'+Math.round(leftLeft)+'px;top:'+Math.round(topTop-230)+'px;overflow:hidden; border: 1px solid black;"><img id="imgConSelDel" onclick="closeDelSelConWin()" src="openlayers/theme/default/img/close.gif" style="position:relative; top:3px left:50px;float:right; cursor:pointer"><a style="position:relative; top:20px"></a><br><a>Удалить выделенное</a><br><button type=button onclick=DeleteSelectedControl()>Да</button></div>';

if(!document.getElementById("id_divControlDelLeg"))
{body.appendChild(DivEditeLeg); 
document.getElementById("id_divControlDel2").onmousedown=function(event){drags(event)};
document.getElementById("id_divControlDel2").onmouseup=function(e){enddrag()};
}
document.getElementById("imgConSelDel").onclick=function(){closeDelSelConWin(del);}
}})
var rout = new OpenLayers.Control.Button({
title: "Построить маршрут на авто",
trigger: function() {

var bbox = document.getElementById("map").getBoundingClientRect();
 var body = document.body
 var docElem = document.documentElement
 var scrollTop = window.pageYOffset || docElem.scrollTop || body.scrollTop
 var scrollLeft = window.pageXOffset || docElem.scrollLeft || body.scrollLeft
 var clientTop = docElem.clientTop || body.clientTop || 0
 var clientLeft = docElem.clientLeft || body.clientLeft || 0
 var topTop = bbox.top + scrollTop - clientTop
 var leftLeft = bbox.left + scrollLeft - clientLeft
var DivEditeLeg=document.createElement("div");
DivEditeLeg.id="id_divRoutLegMain2";
DivEditeLeg.className="id_divRoutLegMain";
DivEditeLeg.style.position="relative";
DivEditeLeg.innerHTML='<div id="id_divRoutLeg" style="background:#ffffff; color:#0000ff;z-index: 6000;position:absolute;left:'+Math.round(leftLeft+50)+'px;top:'+Math.round(topTop+20)+
'px;overflow:hidden; border: 1px solid black;"><img onclick="closeRoutWin()" src="openlayers/theme/default/img/close.gif" style="position:relative; top:10px;float:right; cursor:pointer"><a style="position:relative; top:20px"></a>'+
'<a style="font-size: 9px;"> Вы можете перемещать это окно если щёлкните по пункту меню: переключить режим интерфейса</a><br>'+
'<a>Пожалуйста щёлкните по карте:</a>'+
'<a>маршрут только для авто:</a><br>'+
'Начало<input type="text" size="25" id="RoutId_start" value=""/><img onclick="clearRoutWin1()" src="openlayers/img/cancel.png"><br>'+
'Конец..<input type="text" size="25" id="RoutId_end" value=""/><img onclick="clearRoutWin2()" src="openlayers/img/cancel.png"><br>'+
'Название слоя маршрута <input type="text" size="20" id="NameRoutId_web" value="NewRout"/><br>'+
'<input type="checkbox" id="id_RoutCheckGis" title="если галочка не стоит, то маршрут будет построен в виде набора линий с указанием параметров каждого отрезка маршрута - длина, время и т.д., если галочка стоит, то будет построена одна линия с указание общей длины и времени маршрута" value="checkbox"/>результат как одна линия<br>'+
'<p> <button type=button onclick=Routing()>OK</button></p>'+
'<div style="font-size: 10px;" id="legal-notice" >Routing by '+
'<a href="http://project-osrm.org/">Project OSRM</a>'+
'- Geocoder by '+'<a href="http://wiki.openstreetmap.org/wiki/Nominatim">Nominatim</a>'+
'- OSRM hosting by '+'<a href="http://algo2.iti.kit.edu/">KIT</a></div><br>'+
'<div id="instructRourwebgis" style="height: 10px; font-size: 10px; overflow:auto;border: solid 1px black;"</div><br>'+
'</div>';
if(!document.getElementById("id_divRoutLeg"))
{body.appendChild(DivEditeLeg); 

document.getElementById("id_divRoutLegMain2").onmousedown=function(event){drags(event)};
document.getElementById("id_divRoutLegMain2").onmouseup=function(e){enddrag()};
      OpenLayers.Control.Click = OpenLayers.Class(OpenLayers.Control, {                
defaultHandlerOptions: {
'single': true,
'double': false,
'pixelTolerance': 0,
'stopSingle': false,
'stopDouble': false
},

initialize: function(options) {
this.handlerOptions = OpenLayers.Util.extend(
{}, this.defaultHandlerOptions
);
OpenLayers.Control.prototype.initialize.apply(
this, arguments
); 
this.handler = new OpenLayers.Handler.Click(
                        this, {
'click': this.trigger
}, this.handlerOptions
                    );
                }, 

trigger: function(e) {
var lonlat = map.getLonLatFromPixel(e.xy);
var yesLayer='no';
for(var l=0;l<map.layers.length;l++)
{if(map.layers[l].name=='MarkersRout'&&map.layers[l].CLASS_NAME=='OpenLayers.Layer.Markers'){yesLayer='yes';markers=map.layers[l];}}
if(yesLayer=='no'){var markers = new OpenLayers.Layer.Markers( "MarkersRout" ); 
map.addLayer(markers);}

var size = new OpenLayers.Size(21,25);
var offset = new OpenLayers.Pixel(10.5, -25);
offset.x=(-1)*offset.x;
rtt=offset;

var icon = new OpenLayers.Icon('img/markerstartdss.png', size, offset);
var icon2 = new OpenLayers.Icon('img/markerenddss.png', size, offset);


var new_pos=new OpenLayers.LonLat(lonlat.lon,lonlat.lat).transform(
map.getProjectionObject(),new OpenLayers.Projection("EPSG:4326")
);
if(document.getElementById("RoutId_start")&&!document.getElementById("RoutId_start").value.split(';')[0])
{document.getElementById("RoutId_start").value=new_pos.lon+";"+new_pos.lat;
for(var kk=0;kk<markers.markers.length;kk++)
{if(markers.markers[kk].icon.url=='img/markerstartdss.png'){markers.removeMarker(markers.markers[kk]); }}
markers.addMarker(new OpenLayers.Marker(new OpenLayers.LonLat(lonlat.lon,lonlat.lat),icon.clone()));
}

else{
if(document.getElementById("RoutId_end")&&document.getElementById("RoutId_start").value.split(';')[0])
{document.getElementById("RoutId_end").value=new_pos.lon+";"+new_pos.lat}
for(var kk=0;kk<markers.markers.length;kk++)
{if(markers.markers[kk].icon.url=='img/markerenddss.png'){markers.removeMarker(markers.markers[kk]); }}
markers.addMarker(new OpenLayers.Marker(new OpenLayers.LonLat(lonlat.lon,lonlat.lat),icon2.clone()));
}


	
                }

            });
var clickRout = new OpenLayers.Control.Click();
clickRout.title="click to routing";
 map.addControl(clickRout);
clickRout.activate();
}




},
displayClass: "olControlRoutFeatures"
});
var new_layer_area = new OpenLayers.Layer.Vector(nameMeaslayerMainSq,{renderers:["Canvas", "SVG", "VML"]});
 var drawPolygonSq = new OpenLayers.Control.DrawFeature(
 new_layer_area, OpenLayers.Handler.Polygon,
 {displayClass: 'olControlSquareFeatures',multi:true,title: "Измерить площадь",callbacks : {"point": pointHandlerSq}}
 );
function pointHandlerSq()
{
var areaP=drawPolygonSq.handler.polygon.clone().geometry.transform(map.getProjectionObject(),new OpenLayers.Projection("EPSG:4326"));
var area=areaP.getGeodesicArea(new OpenLayers.Projection("EPSG:4326"));
var areaL=areaP.getGeodesicLength(new OpenLayers.Projection("EPSG:4326"));
if(document.getElementById("id_divControlmeasureGisSqLeg"))
{if(areaL<0.1)
{document.getElementById("id_divControlmeasureGisLegSq2").innerHTML='<a>area: '+area.toFixed(10)+' sq.m.</a><br>'+'<a>length: '+areaL.toFixed(10)+' m<a>';}
else
{document.getElementById("id_divControlmeasureGisLegSq2").innerHTML='<a>area: '+area.toFixed(5)+' sq.m.</a><br>'+'<a>length: '+areaL.toFixed(5)+' m<a>';}
}
}
drawPolygonSq.featureAdded = function(feature) {
feature.attributes={};
feature.data={};
if(new_layer_area.features.length>2)
{
var numberP=parseInt(new_layer_area.features[new_layer_area.features.length-2].fid.split('.')[1])+parseInt(1);
var lnewFid=new_layer_area.features[new_layer_area.features.length-2].fid.split('.')[0]+"."+numberP;
}
else{var lnewFid=new_layer_area.name+"."+parseInt(new_layer_area.features.length);}
var areaP=feature.clone().geometry.transform(map.getProjectionObject(),new OpenLayers.Projection("EPSG:4326"));
area=areaP.getGeodesicArea(new OpenLayers.Projection("EPSG:4326"));
feature.attributes["area"]=parseFloat(area);feature.data["area"]=parseFloat(area);
feature.fid=lnewFid;
 feature.state = OpenLayers.State.INSERT;
var layeradd='';

if(document.getElementById("DistMeasureGisaSq_id").value!=='0')
{
for(var tt=0;tt<map.layers.length;tt++)
{if(map.layers[tt].name==document.getElementById("DistMeasureGisaSq_id").value)
{layeradd=map.layers[tt];
for(var ttt=0;ttt<map.layers[tt].features.length;ttt++)
{if(!map.layers[tt].features[ttt].attributes['area'])
{map.layers[tt].features[ttt].attributes['area']='';}
for (jk in layeradd.features[0].attributes)
{if(jk=='area'){}
else{feature.attributes[jk]='';}
}

}
}
}
}
feature.layer.drawFeature(feature);
if(document.getElementById("DistMeasureGisaSq_id").value!=='0'){var e=[];e.push(feature.clone());layeradd.addFeatures(e);}
 }

drawPolygonSq.events.register("activate", drawPolygonSq, function(){

drawPolygonSq.panel_div.id="ControlmeasureGisSq_id";
var bbox = document.getElementById("ControlmeasureGisSq_id").parentNode.getBoundingClientRect();
 var body = document.body
 var docElem = document.documentElement
 var scrollTop = window.pageYOffset || docElem.scrollTop || body.scrollTop
 var scrollLeft = window.pageXOffset || docElem.scrollLeft || body.scrollLeft
 var clientTop = docElem.clientTop || body.clientTop || 0
 var clientLeft = docElem.clientLeft || body.clientLeft || 0
 var topTop = bbox.top + scrollTop - clientTop
 var leftLeft = bbox.left + scrollLeft - clientLeft
var DivEditeLeg=document.createElement("div");
DivEditeLeg.id="id_divControlmeasureGisSq2";
DivEditeLeg.className="id_divControlmeasureGisSq";
DivEditeLeg.style.position="relative";
DivEditeLeg.innerHTML='<div id="id_divControlmeasureGisSqLeg" style="background:#ffffff; color:#0000ff;z-index: 6000;position:absolute;left:'+Math.round(leftLeft)+'px;top:'+Math.round(topTop-230)+
'px;overflow:hidden; border: 1px solid black;"><img onclick="closeMeasureSqWin()" src="openlayers/theme/default/img/close.gif" style="position:relative; top:3px left:50px;float:right; cursor:pointer"><a style="position:relative; top:20px"></a>'+
'<div id="id_divControlmeasureGisLegSq2" style="font-size:11px"></div>'+
'<div onclick="OptionSqMeas()" title="open options of  measure area" style="cursor:pointer"><img src="img/option.png"/></div><div id="DistMeasureGisaSqDiv_id" style="display:none;font-size:11px" ><a style="font-size:11px">add to:</a> <select style="font-size:11px" id="DistMeasureGisaSq_id" onchange="" title="if in this combobox the layer is selected then information about area will be added to this layer and in the new layer,otherwise the information about area will be added ONLY in the new layer">.'+
 '<option selected value="0">.</option>'+
'</select>'+'<br>layer name:<input type="text" style="font-size:11px" size="15" id="DistMeasureGisaSqL_id" title="insert name of the new layer with area. The new name will be set after the reopening of this popup window" value="'+nameMeaslayerMainSq+'" onBlur="OnBlurtDistMeasureGisaSqL()"/>'+
'<br><input type="checkbox" title="delete new layer with area after deactivating of control /measure area/" id="Id_CheckSqMeas" onclick="DistMeasDelLSq()" value="true" checked />delete new layer'+
'</div>'+
'</div>';

if(!document.getElementById("id_divControlmeasureGisSqLeg"))
{body.appendChild(DivEditeLeg); document.getElementById("id_divControlmeasureGisLegSq2").innerHTML='0.00000'+" sq.m";}

drawPolygonSqMain=drawPolygonSq;
document.getElementById("id_divControlmeasureGisSq2").onmousedown=function(event){drags(event)};
document.getElementById("id_divControlmeasureGisSq2").onmouseup=function(e){enddrag()};
var new_layer_area = new OpenLayers.Layer.Vector(document.getElementById("DistMeasureGisaSqL_id").value,{renderers:["Canvas", "SVG", "VML"]});
drawPolygonSq.layer=new_layer_area;
var t=document.createElement('option');t.value=new_layer_area.name;t.text=new_layer_area.name;
document.getElementById("editL1").appendChild(t);
map.addLayer(new_layer_area);
for(var i=0;i<map.layers.length;i++)
{if(map.layers[i].CLASS_NAME=="OpenLayers.Layer.Vector"&&map.layers[i].name!=="OpenLayers.Handler.Polygon")
{var t=document.createElement('option');
t.value=map.layers[i].name;t.text=map.layers[i].name;document.getElementById("DistMeasureGisaSq_id").appendChild(t);}
}

if(checkMeasSqMain==true)
{document.getElementById("Id_CheckSqMeas").checked=true}
if(checkMeasSqMain==false)
{document.getElementById("Id_CheckSqMeas").checked=false}

});

 drawPolygonSq.events.register("deactivate", drawPolygonSq, function(){
 if(checkMeasSqMain==true)
 {
 var ListL=document.getElementById('editL1');
for (var k=0; k<ListL.length; k++)
{if(ListL.options[k].value==drawPolygonSq.layer.name){ListL.removeChild(ListL.options[k]);}}
drawPolygonSq.layer.destroy();
 }
 });
var new_layer_Rule = new OpenLayers.Layer.Vector(nameMeaslayerMain,{renderers:["Canvas", "SVG", "VML"]});
var drawLineRule = new OpenLayers.Control.DrawFeature(
 new_layer_Rule, OpenLayers.Handler.Path,
 {displayClass: 'olControlRuleFeatures',multi: true,title: "Measure distance", callbacks : {"point": pointHandler}}
 );
function pointHandler()
{
var new_pos1=new OpenLayers.LonLat(drawLineRule.handler.point.geometry.x,drawLineRule.handler.point.geometry.y);
measurePointGis.push(new_pos1);
var lengt=measurePointGis.length-2; if(lengt==-1){lengt=0;}
var dist=distanceOpenWebGIS(measurePointGis[lengt].lon,measurePointGis[lengt].lat,new_pos1.lon,new_pos1.lat)
measurePointDist=measurePointDist+dist;
if(document.getElementById("id_divControlmeasureGisLeg"))
{if(measurePointDist<0.01)
{document.getElementById("id_divControlmeasureGisLeg2").innerHTML=measurePointDist.toFixed(10)+" m";}
else
{document.getElementById("id_divControlmeasureGisLeg2").innerHTML=measurePointDist.toFixed(5)+" m";}
}
}
function distanceOpenWebGIS(x1,y1,x2,y2)
{
var new_pos1=new OpenLayers.LonLat(x1,y1).transform(map.getProjectionObject(),new OpenLayers.Projection("EPSG:4326"));
var new_pos2=new OpenLayers.LonLat(x2,y2).transform(map.getProjectionObject(),new OpenLayers.Projection("EPSG:4326"));
var long1=new_pos1.lon;
var lat1=new_pos1.lat;
var long2=new_pos2.lon;
var lat2=new_pos2.lat;
var R = 6372795;
lat1 *= Math.PI / 180;lat2 *= Math.PI / 180;
long1 *= Math.PI / 180;long2 *= Math.PI / 180;
var cl1 = Math.cos(lat1);var cl2 = Math.cos(lat2);var sl1 = Math.sin(lat1);var sl2 = Math.sin(lat2);
var delta = long2 - long1;var cdelta = Math.cos(delta);var sdelta = Math.sin(delta);var y = Math.sqrt(Math.pow(cl2 * sdelta, 2) + Math.pow(cl1 * sl2 - sl1 * cl2 * cdelta, 2));
var x = sl1 * sl2 + cl1 * cl2 * cdelta;var ad = Math.atan2(y, x);
if((ad * R)<0.01){var dist = parseFloat((ad * R).toFixed(10));}
else
{var dist = parseFloat((ad * R).toFixed(5));}
return dist;

}
  drawLineRule.featureAdded = function(feature) {
feature.attributes={};
feature.data={};
measurePointGis=[];
var x1=feature.geometry.components[0].components[0].x;
var y1=feature.geometry.components[0].components[0].y;
var x2=feature.geometry.components[0].components[feature.geometry.components[0].components.length-1].x
var y2=feature.geometry.components[0].components[feature.geometry.components[0].components.length-1].y
//var dist=distanceOpenWebGIS(x1,y1,x2,y2);
if(document.getElementById("id_divControlmeasureGisLeg"))
{document.getElementById("id_divControlmeasureGisLeg2").innerHTML=measurePointDist+" m";}

if(new_layer_Rule.features.length>2)
{
var numberP=parseInt(new_layer_Rule.features[new_layer_Rule.features.length-2].fid.split('.')[1])+parseInt(1);
var lnewFid=new_layer_Rule.features[new_layer_Rule.features.length-2].fid.split('.')[0]+"."+numberP;
}
else{var lnewFid=new_layer_Rule.name+"."+parseInt(new_layer_Rule.features.length);}
//DistMeasureGisa_id
feature.attributes["distance"]=parseFloat(measurePointDist);feature.data[name]=parseFloat(measurePointDist);
measurePointDist=0;
feature.fid=lnewFid;
 feature.state = OpenLayers.State.INSERT;
 

var layeradd='';

if(document.getElementById("DistMeasureGisa_id").value!=='0')
{
for(var tt=0;tt<map.layers.length;tt++)
{if(map.layers[tt].name==document.getElementById("DistMeasureGisa_id").value)
{layeradd=map.layers[tt];
for(var ttt=0;ttt<map.layers[tt].features.length;ttt++)
{if(!map.layers[tt].features[ttt].attributes['distance'])
{map.layers[tt].features[ttt].attributes['distance']='';}
for (jk in layeradd.features[0].attributes)
{if(jk=='distance'){}
else{feature.attributes[jk]='';}
}

}
}
}
}
feature.layer.drawFeature(feature);
if(document.getElementById("DistMeasureGisa_id").value!=='0'){var e=[];e.push(feature.clone());layeradd.addFeatures(e);}

 }
  drawLineRule.events.register("deactivate", drawLineRule, function(){
 if(checkMeasDistMain==true)
 {
 var ListL=document.getElementById('editL1');
for (var k=0; k<ListL.length; k++)
{if(ListL.options[k].value==drawLineRule.layer.name){ListL.removeChild(ListL.options[k]);}}
drawLineRule.layer.destroy();
 }
 });
drawLineRule.events.register("activate", drawLineRule, function(){

drawLineRule.panel_div.id="ControlmeasureGis_id";
var bbox = document.getElementById("ControlmeasureGis_id").parentNode.getBoundingClientRect();
 var body = document.body
 var docElem = document.documentElement
 var scrollTop = window.pageYOffset || docElem.scrollTop || body.scrollTop
 var scrollLeft = window.pageXOffset || docElem.scrollLeft || body.scrollLeft
 var clientTop = docElem.clientTop || body.clientTop || 0
 var clientLeft = docElem.clientLeft || body.clientLeft || 0
 var topTop = bbox.top + scrollTop - clientTop
 var leftLeft = bbox.left + scrollLeft - clientLeft
var DivEditeLeg=document.createElement("div");
DivEditeLeg.id="id_divControlmeasureGis2";
DivEditeLeg.className="id_divControlmeasureGis";
DivEditeLeg.style.position="relative";
DivEditeLeg.innerHTML='<div id="id_divControlmeasureGisLeg" style="background:#ffffff; color:#0000ff;z-index: 6000;position:absolute;left:'+Math.round(leftLeft)+'px;top:'+Math.round(topTop-230)+
'px;overflow:hidden; border: 1px solid black;"><img onclick="closeMeasureWin()" src="openlayers/theme/default/img/close.gif" style="position:relative; top:3px left:50px;float:right; cursor:pointer"><a style="position:relative; top:20px"></a>'+
'<div id="id_divControlmeasureGisLeg2" style="font-size:11px"></div>'+
'<div onclick="OptionDistMeas()" title="open options of  measure distance" style="cursor:pointer"><img src="img/option.png"/></div><div id="DistMeasureGisaDiv_id" style="display:none;font-size:11px" ><a style="font-size:11px">add to:</a> <select style="font-size:11px" id="DistMeasureGisa_id" onchange="" title="if in this combobox the layer is selected then information about distance will be added to this layer and in the new layer,otherwise the information about distance will be added ONLY in the new layer">.'+
 '<option selected value="0">.</option>'+
'</select>'+'<br>layer name:<input type="text" style="font-size:11px" size="15" id="DistMeasureGisaL_id" title="insert name of the new layer with distance. The new name will be set after the reopenin of this popup window" value="'+nameMeaslayerMain+'" onBlur="OnBlurtDistMeasureGisaL()"/>'+
'<br><input type="checkbox" title="delete new layer with distance after deactivate control /measure distance/" id="Id_CheckDistMeas" onclick="DistMeasDelL()" value="true" checked />delete new layer'+
'</div>'+
'</div>';

if(!document.getElementById("id_divControlmeasureGisLeg"))
{body.appendChild(DivEditeLeg); document.getElementById("id_divControlmeasureGisLeg2").innerHTML='0.00000'+" m";}
if(checkMeasDistMain==true)
{document.getElementById("Id_CheckDistMeas").checked=true}
if(checkMeasDistMain==false)
{document.getElementById("Id_CheckDistMeas").checked=false}
drawLineRuleMain=drawLineRule;
document.getElementById("id_divControlmeasureGis2").onmousedown=function(event){drags(event)};
document.getElementById("id_divControlmeasureGis2").onmouseup=function(e){enddrag()};
var new_layer_Rule = new OpenLayers.Layer.Vector(document.getElementById("DistMeasureGisaL_id").value,{renderers:["Canvas", "SVG", "VML"]});
drawLineRule.layer=new_layer_Rule;
var t=document.createElement('option');t.value=new_layer_Rule.name;t.text=new_layer_Rule.name;
document.getElementById("editL1").appendChild(t);
map.addLayer(new_layer_Rule);
for(var i=0;i<map.layers.length;i++)
{if(map.layers[i].CLASS_NAME=="OpenLayers.Layer.Vector"&&map.layers[i].name!=="OpenLayers.Handler.Path")
{var t=document.createElement('option');
t.value=map.layers[i].name;t.text=map.layers[i].name;document.getElementById("DistMeasureGisa_id").appendChild(t);}
}



});
var save = new OpenLayers.Control.Button({
title: "Сохранить изменения",
trigger: function() {
var Arrfid=[];
if(edit.feature) {
edit.selectControl.unselectAll();
}
if(!edilayerMainLayer.protocol){alert('saved OK');}
if(edilayerMainLayer.protocol){
saveStrategy.layer=edilayerMainLayer;
saveStrategy.onCommit=function(){for(var g=0;g<edilayerMainLayer.features.length;g++){edilayerMainLayer.features[g].state=null;if(edilayerMainLayer.features[g].fid!==Arrfid[g]){edilayerMainLayer.features[g].fid=Arrfid[g]}}Arrfid=[];alert('saved');};
saveStrategy.save();}
saveStrategy.onCommit=function(){for(var g=0;g<edilayerMainLayer.features.length;g++){edilayerMainLayer.features[g].state=null;}};
var countDelfeat=edilayerMainLayer.features.length;
for(var i=0;i<edilayerMainLayer.features.length;i++)
{if(edilayerMainLayer.features[i].state ==OpenLayers.State.DELETE)
{edilayerMainLayer.destroyFeatures([edilayerMainLayer.features[i]]);i=i-1;}
}
for(var g=0;g<edilayerMainLayer.features.length;g++)
{Arrfid.push(edilayerMainLayer.features[g].fid);}

},
displayClass: "olControlSaveFeatures"
});
editCoord = new OpenLayers.Control.ModifyFeature(edilayerMainLayer, {
title: "Редактировать координаты",
dragStart: startModify,
displayClass: "olControlDrawFeatureCoord",
});
function startModify(feature,pixel)
{
var epsg4326 = new OpenLayers.Projection("EPSG:4326");
var lonlatF = new OpenLayers.LonLat(feature.geometry.x, feature.geometry.y).transform(map.getProjectionObject(),epsg4326);
var htmlText="";
htmlText+='Longitude (x):'+'<input id=x_'+feature.id+' type="text" value='+lonlatF.lon+'>'+'<br>'+'Latitude (y):'+'<input id=y_'+feature.id+' type="text" value='+lonlatF.lat+'>'+'<br>';
htmlText +='<button type="button" onclick="UpdateGeometry();">Update Geometry</button>';
 popupGeom = new OpenLayers.Popup.FramedCloud("featurePopupG",
 feature.geometry.getBounds().getCenterLonLat(),
 new OpenLayers.Size(100,100),
 htmlText ,
 null, true, onPopupClose);
 feature.popup = popupGeom;
 popupGeom.feature = feature;
 map.addPopup( popupGeom);
feature2Geom=feature;
}
var drag = new OpenLayers.Control.DragFeature(edilayerMainLayer, {
 onStart: startDrag,
 onDrag: doDrag,
 onComplete: endDrag,
displayClass: "olControlDrawFeaturePolygon2"
});
drag.title="Переместить элемент слоя"
var select = new OpenLayers.Control.SelectFeature(edilayerMainLayer, {
 box: true,
 multiple: true,
 onSelect: addSelected,
 onUnselect: clearSelected,
displayClass: "olControlDrawFeaturePolygon3"
});
select.title="Выделить элемент слоя"
function addSelected(feature) {
 
}
function clearSelected(feature) {
edilayerMainLayer.selectedFeatures=[];for(var t=0;t<edilayerMainLayer.features.length;t++){edilayerMainLayer.features[t].renderIntent="default";}
edilayerMainLayer.redraw();
}
function startDrag(feature, pixel) {
 lastPixel = pixel;
}
function doDrag(feature, pixel) {
 for (f in edilayerMainLayer.selectedFeatures) {
 if (feature != edilayerMainLayer.selectedFeatures[f]) {
 var res = map.getResolution();
 edilayerMainLayer.selectedFeatures[f].geometry.move(res * (pixel.x - lastPixel.x), res * (lastPixel.y - pixel.y));
 edilayerMainLayer.drawFeature(edilayerMainLayer.selectedFeatures[f]);
 }
 }
 lastPixel = pixel;
}
function endDrag(feature, pixel) {
if(edilayerMainLayer.selectedFeatures!=0)
{
 for (f in edilayerMainLayer.selectedFeatures) {
 edilayerMainLayer.selectedFeatures[f].state = OpenLayers.State.UPDATE;
 }
}
else {feature.state = OpenLayers.State.UPDATE;}
}
function endDragModify(feature, pixel) {
if(edilayerMainLayer.selectedFeatures!=0)
{
 for (f in edilayerMainLayer.selectedFeatures) {
 edilayerMainLayer.selectedFeatures[f].state = OpenLayers.State.UPDATE;
 }
}
else {feature.state = OpenLayers.State.UPDATE;}
}

var selectLenArea = new OpenLayers.Control.SelectFeature(edilayerMainLayer, {
 box: true,
 multiple: true,
 clickout : true,
 onSelect: addSelectedLenArea,
 onUnselect: clearSelectedLenArea,
displayClass: "olControlSelectLenArea"
});
selectLenArea.title="Выделить элемент слоя и определить длину и площадь. Если будет выделено несколько элементов слоя, то будет подсчитана сумма их длин и площадей"
function addSelectedLenArea(feature) {

 var s=edilayerMainLayer.selectedFeatures;
 var area=0;
 var areaL=0;

 for(var i=0;i<s.length;i++)
 {
if(s[i].geometry.CLASS_NAME=='OpenLayers.Geometry.Point')
{}//.transform(map.getProjectionObject(),new OpenLayers.Projection("EPSG:4326"))
else{
var areaP=s[i].clone().geometry.transform(map.getProjectionObject(),new OpenLayers.Projection("EPSG:4326"));
if(s[i].geometry.CLASS_NAME=='OpenLayers.Geometry.Polygon'||s[i].geometry.CLASS_NAME=='OpenLayers.Geometry.MultiPolygon')
{area=area+areaP.getGeodesicArea(new OpenLayers.Projection("EPSG:4326"));}
areaL=areaL+areaP.getGeodesicLength(new OpenLayers.Projection("EPSG:4326"));}
 }

if(document.getElementById("Id_CheckAreaLengthOpenWebGIS").checked==true)
{for(var ttt=0;ttt<edilayerMainLayer.features.length;ttt++)
{if(!edilayerMainLayer.features[ttt].attributes['areaOpenWebGIS'])
{edilayerMainLayer.features[ttt].attributes['areaOpenWebGIS']='';}
if(!edilayerMainLayer.features[ttt].attributes['lengthOpenWebGIS'])
{edilayerMainLayer.features[ttt].attributes['lengthOpenWebGIS']='';}
}}
if(document.getElementById("Id_CheckAreaLengthOpenWebGIS").checked==true)
{ for(var i=0;i<s.length;i++)
 { s[i].attributes['areaOpenWebGIS']=area;s[i].attributes['lengthOpenWebGIS']=areaL;
 } }
 
if(document.getElementById("Id_CheckAreaLengthOpenWebGIS2").checked==true)
{ for(var i=0;i<s.length;i++)
 { 
if(s[i].geometry.CLASS_NAME=='OpenLayers.Geometry.Point')
{}else{
var areaP=s[i].clone().geometry.transform(map.getProjectionObject(),new OpenLayers.Projection("EPSG:4326"));
if(s[i].geometry.CLASS_NAME=='OpenLayers.Geometry.Polygon'||s[i].geometry.CLASS_NAME=='OpenLayers.Geometry.MultiPolygon')
{var areae=areaP.getGeodesicArea(new OpenLayers.Projection("EPSG:4326"));}
var areaLe=areaP.getGeodesicLength(new OpenLayers.Projection("EPSG:4326"));}

s[i].attributes['areaOpenWebGIS']=areae;s[i].attributes['lengthOpenWebGIS']=areaLe;
 } }

if(area<0.1)
{document.getElementById("div"+selectLenArea.panel_div.id+"2").innerHTML='<a>area: '+area.toFixed(10)+' sq.m.</a><br>'+'<a>length: '+areaL.toFixed(10)+' m<a>';}
else
{document.getElementById("div"+selectLenArea.panel_div.id+"2").innerHTML='<a>area: '+area.toFixed(5)+' sq.m.</a><br>'+'<a>length: '+areaL.toFixed(5)+' m<a>';}

}
function clearSelectedLenArea(feature) {
edilayerMainLayer.selectedFeatures=[];for(var t=0;t<edilayerMainLayer.features.length;t++){edilayerMainLayer.features[t].renderIntent="default";}
edilayerMainLayer.redraw();
}
selectLenArea.events.register("activate", selectLenArea, function(){

selectLenArea.panel_div.id="ControlSelectLenArea_id";
var htmlv='';
htmlv+='<br><input type="checkbox" title="if this checkbox is checked then information about area and length will be added to the editable layer " id="Id_CheckAreaLengthOpenWebGIS" value="true" /><a style="font-size:11px">add to the layer sum area and length</a><br>'+
'<input type="checkbox" title="if this checkbox is checked then information about area and length will be added to the editable layer " id="Id_CheckAreaLengthOpenWebGIS2" /><a style="font-size:11px">add to the layer area and length for each features</a>';
DivEditeLeg=CreatpopUPOpenWebGIS(selectLenArea.panel_div.id,htmlv);
if(!document.getElementById("id_divControlSelectLenArea_idLeg"))
{document.body.appendChild(DivEditeLeg); document.getElementById("div"+selectLenArea.panel_div.id+"2").innerHTML='0.00000';}
document.getElementById("id_div"+selectLenArea.panel_div.id+"2").onmousedown=function(event){drags(event)};
document.getElementById("id_div"+selectLenArea.panel_div.id+"2").onmouseup=function(e){enddrag()};
selectLenAreaMain=selectLenArea;
})
var m3dContAdd = new OpenLayers.Control.Button({
title: "Добавить 3D карту. Глобус. Для работы с 3D-картой используйте следующие инструкции: Двигать вид: щелкните левой кнопкой + перетаскивание; Увеличить изображение: Щелкните правой кнопкой мыши + перетаскивание или Колесо прокрутки мыши. Вращать вид: средняя кнопка мыши + перетаскивание или CTRL + щелчок левой кнопкой мыши + перетаскивание.",
trigger: function() {

var bbox = document.getElementById("map").getBoundingClientRect();
 var body = document.body
 var docElem = document.documentElement
 var scrollTop = window.pageYOffset || docElem.scrollTop || body.scrollTop
 var scrollLeft = window.pageXOffset || docElem.scrollLeft || body.scrollLeft
 var clientTop = docElem.clientTop || body.clientTop || 0
 var clientLeft = docElem.clientLeft || body.clientLeft || 0
 var topTop = bbox.top + scrollTop - clientTop
 var leftLeft = bbox.left + scrollLeft - clientLeft
var DivEditeLeg=document.createElement("div");
DivEditeLeg.id="id_div3dMapMain0";
DivEditeLeg.className="id_divRoutLegMain";
DivEditeLeg.style.position="relative";
DivEditeLeg.innerHTML='<div id="id_id_div3dWebGisLeg0" style="background:#ffffff; color:#0000ff;z-index: 6000;position:absolute;left:'+Math.round(leftLeft+50)+'px;top:'+Math.round(topTop-20)+
'px;overflow:hidden; border: 1px solid black;">'+
'<img onclick="close3dFirstWin()" src="openlayers/theme/default/img/close.gif" style="position:relative; top:10px;float:right; cursor:pointer"><a style="position:relative; top:20px"><br>'+
'<a>Установить размер области 3D карты в пикселях:</a><br>'+
'<a>ширина:</a><input type="text" size="5" id="id_3dOpenWebWidth" value="500"/><br>'+
'<a>высота:</a><input type="text" size="5" id="id_3dOpenWebHeight" value="500"/><br>'+
'<input type="checkbox" id="id_zoom3dCurrent" title="" value="checkbox" checked/>увеличить 3d карту до текущего экстента<br>'+
'<input type="checkbox" id="id_3dJSON" title="" value="checkbox" />дополнительные настройки 3D (добавление высоты) <br>'+
'<div id="dopdiv3djson" style="display:none"></div>'+
'<p> <button type=button onclick=Open3Dmap()>Ok</button>'+
//'<p></p>'+
'</div>';
if(!document.getElementById("id_div3dMapMain0"))
{body.appendChild(DivEditeLeg);
document.getElementById("id_3dJSON").onchange=function (){onchangeid_3dJSON();}
 }
},
displayClass: "olControl3dFeatures"
});
var OsmBuild = new OpenLayers.Control.Button({
title: "OSM Buildings (OSM здания). Щёлкните для визуализации OpenStreetMap геометрии зданий на интерактивных картах.'OSM Buildings' создаёт 3D вид зданий по данным OpenStreetMap (OSM) на 2D карте. 'OSM Buildings' не создаёт  настоящую 3D модель но использует  специальную технологию наложения тени для того что бы изображения зданий казались трёхмерными ‘3D’.Copyright (c) 2014, OSM Buildings, Jan Marsch <mail@osmbuildings.org> All rights reserved.",
trigger: function() {
if(!document.getElementById("OSMscript_script_id"))
{var scriptB = document.createElement("script"); 
scriptB.src = 'openlayers/OSMBuildings-OpenLayers.js'; 
 scriptB.type = 'text/javascript'; 
 scriptB.id="OSMscript_script_id";
scriptB.async=false;document.body.appendChild(scriptB)
scriptB.onload= function(){osmb = new OSMBuildings(map).load();if(map.zoom<=14){alert("Новый слой с именем 'OSM Buildings' был успешно добавлен. Для того что бы увидеть 3D представление зданий OpenStreetMap вы должны увеличить карту до интересующего вас города")}
osmb.click(function(e) {informationOSM(e)});;map.events.listeners.click[map.events.listeners.click.length-1].obj.clickosmowg='clickosmowg';osmb.onMapResize=function(){OSMBonMapResize(osmb)};
};
}
else{ var yesOSMLayer=0;
for(var io=0;io<map.layers.length;io++)
{if(!map.layers[io].customJson&&map.layers[io].attribution&&map.layers[io].attribution=='&copy; <a href="http://osmbuildings.org">OSM Buildings</a>')
{yesOSMLayer=1;} }
if(yesOSMLayer==0){
if(document.getElementById("OSMscript_script_id"))
{document.getElementById("OSMscript_script_id").parentNode.removeChild(document.getElementById("OSMscript_script_id"));OSMBuildings='';}
var scriptB = document.createElement("script"); scriptB.src = 'openlayers/OSMBuildings-OpenLayers.js'; 
 scriptB.type = 'text/javascript';  scriptB.id="OSMscript_script_id";scriptB.async=false;document.body.appendChild(scriptB)
scriptB.onload= function(){
try{osmb = new OSMBuildings(map).load();}catch(e){alert(e)}
osmb.click(function(e) {informationOSM(e)});map.events.listeners.click[map.events.listeners.click.length-1].obj.clickosmowg='clickosmowg';osmb.onMapResize=function(){OSMBonMapResize(osmb)};}

}


}

},
displayClass: "olControlOSMB"
});
var link = new OpenLayers.Control.Button({
title: "Получить ссылку на вашу карту или код для встраивания(добавления) карты в ваш сайт",
trigger: function() {

var bbox = document.getElementById("map").getBoundingClientRect();
 var body = document.body
 var docElem = document.documentElement
 var scrollTop = window.pageYOffset || docElem.scrollTop || body.scrollTop
 var scrollLeft = window.pageXOffset || docElem.scrollLeft || body.scrollLeft
 var clientTop = docElem.clientTop || body.clientTop || 0
 var clientLeft = docElem.clientLeft || body.clientLeft || 0
 var topTop = bbox.top + scrollTop - clientTop
 var leftLeft = bbox.left + scrollLeft - clientLeft
var DivEditeLeg=document.createElement("div");
DivEditeLeg.id="id_divLinkLegMain2";
DivEditeLeg.className="id_divRoutLegMain";
DivEditeLeg.style.position="relative";
DivEditeLeg.innerHTML='<div id="id_divLinkWebGisLeg" style="background:#ffffff; color:#0000ff;z-index: 6000;position:absolute;left:'+Math.round(leftLeft+50)+'px;top:'+Math.round(topTop-120)+
'px;overflow:hidden; border: 1px solid black;"><img onclick="closeLinkWin()" src="openlayers/theme/default/img/close.gif" style="position:relative; top:10px;float:right; cursor:pointer"><a style="position:relative; top:20px"><br>'+
'<a>Вы хотите получить ссылку?</a><br>'+
'<input type="checkbox" id="id_LinkSaveInterface" title="" value="checkbox"/>сохранить интерфейс<input type="checkbox" id="id_LinkSaveErrorNocode" title="Если ссылка или код для встраивания в сайт, созданные вами не работают, то поставьте здесь галочку и заново нажмите кнопку /Да/ или /Да -получить код/" value="checkbox"/><a style="font-size: 11px;">активируйте если ссылка или код встраивания не работает</a><div id=id_saveTimeLinelink></div>'+
'<p> <button title="нажмите чтобы получить ссылку" type=button onclick=GetLinkOpenWebGis()>Да</button><button type=button onclick=closeLinkWin()>Закрыть</button></p>'+
'link:<textarea id="LinkOpenwebgisTextArea" style="width: 300px; height: 40px;font-size:11px"></textarea><br>'+
'<a>Автор:</a><input type="text" size="15" id="id_LinkOpenWebGisAuth" value="name"/><br>'+
'<a>Описание:</a><input type="text" size="35" id="id_LinkOpenWebGisSum" value=""/><br>'+
'<a>Получить код для встраивания(добавления) карты в ваш сайт?</a><br>'+
'<input type="checkbox" id="id_EmbSaveClearMap" title="" value="checkbox"/>только карта <input type="checkbox" id="id_EmbSaveAllSite" title="Вы получите код для встраивания всего интерфейса OpenWebGIS в ваш сайт. Установите ширину и высоту в пикселах охвата интерфейса." value="checkbox"/>весь сайт:<a>ширина:</a><input type="text" size="3" id="id_EmbedClearsite_w" value="800"/><a>высота:</a><input type="text" size="3" id="id_EmbedClearsite_h" value="600"/><br>'+
'<button title="нажмите, чтобы получить код" type=button onclick=GetEmbedOpenWebGis()>Да- получить код</button><br>'+
'код для добавления:<textarea id="EmbedOpenwebgisTextArea" style="width: 300px; height: 30px;font-size:11px"></textarea>'+
'</div>';
if(!document.getElementById("id_divLinkWebGisLeg"))
{body.appendChild(DivEditeLeg); }
document.getElementById("id_divLinkLegMain2").onmousedown=function(event){drags(event)};
document.getElementById("id_divLinkLegMain2").onmouseup=function(e){enddrag()};
if(document.getElementById("id_TimeLineLegMain2"))
{var timesli=document.createElement('input');timesli.id='timsaveTimeLinelink';timesli.type='checkbox';document.getElementById("id_saveTimeLinelink").appendChild(timesli);var timeslia=document.createElement('a');timeslia.innerHTML="сохранить шкалу времени";document.getElementById("id_saveTimeLinelink").appendChild(timeslia);}
},
displayClass: "olControlLinkFeatures"
});
var pointPol = new OpenLayers.Control.Button({
title: "Создать полигон из выделенных точек или соединить выделенные полигоны",
trigger: function() {
var bbox = document.getElementById("map").getBoundingClientRect();
 var body = document.body;
 var docElem = document.documentElement; var scrollTop = window.pageYOffset || docElem.scrollTop || body.scrollTop
 var scrollLeft = window.pageXOffset || docElem.scrollLeft || body.scrollLeft;var clientTop = docElem.clientTop || body.clientTop || 0
 var clientLeft = docElem.clientLeft || body.clientLeft || 0; var topTop = bbox.top + scrollTop - clientTop
 var leftLeft = bbox.left + scrollLeft - clientLeft
var DivEditeLeg=document.createElement("div");
DivEditeLeg.id="id_divPointPolLegMain2";
DivEditeLeg.className="id_divRoutLegMain";
DivEditeLeg.style.position="relative";
DivEditeLeg.innerHTML='<div id="id_divPointPolLeg" style="background:#ffffff; color:#0000ff;z-index: 6000;position:absolute;left:'+Math.round(leftLeft+50)+'px;top:'+Math.round(topTop-150)+
'px;overflow:hidden; border: 1px solid black;"><img onclick="closePointPolWin()" src="openlayers/theme/default/img/close.gif" style="position:relative; top:10px;float:right; cursor:pointer"><a style="position:relative; top:20px"><br>'+
'<a>Выделите интересующие вас точки, полигоны на карте</a><br>'+'Выберите тип полигона: <select id="PointPolRes_id" >.'+
 '<option selected value="convexpolygon">выпуклый полигон</option>'+'<option value="polygon">полигон</option>'+'</select><br>'+ 
'<input type="checkbox" id="id_checkPolpointnum" title="" value="checkbox"/><a style="font-size: 12px;">Создать полигон по порядковому номеру точек</a><br>'+
'<input type="checkbox" id="id_checkLinepointnum" title="" value="checkbox"/><a style="font-size: 12px;">Создать линию по порядковому номеру точек</a><br>'+
'<select title="выберите атрибут с порядковым номером" id="PointPolnum_id" >.'+ '<option selected value="0">.</option></select><br>'+ 
'<a>Layer name:</a><input title="название нового векторного слоя с результатами" type="text" id="PointP_layer_name_id" value="PointPolygon" size=15><br>'+
'<a> Or add result to:</a><select id="AddPointP_layer_name_id" >'+ '<option selected value="0">.</option>'+'</select><br>'+ 
'<input type="checkbox" id="id_checkPolyMergenum" title="" value="checkbox"/><a style="font-size: 12px;">объединить выделенные(выбранные) полигоны</a><br>'+
'<input type="checkbox" id="id_checkPolyMergenumrep" title="удалить выделенные элементы редактируемого слоя после операции объединения" value="checkbox"/><a style="font-size: 12px;">удалить выделенные элементы<br>'+
'<p> <button type=button onclick=CreatePoLfromPoint()>OK</button>'+
'</div>';
if(!document.getElementById("id_divPointPolLegMain2"))
{body.appendChild(DivEditeLeg); }
document.getElementById("id_divPointPolLegMain2").onmousedown=function(event){drags(event)};document.getElementById("id_divPointPolLegMain2").onmouseup=function(e){enddrag()};
for(h in edilayerMainLayer.features[0].attributes){var t=document.createElement('option');t.value=h;t.text=h;document.getElementById("PointPolnum_id").appendChild(t); }
for(var i=0;i<map.layers.length;i++)
{if(map.layers[i].CLASS_NAME=="OpenLayers.Layer.Vector")
{var t=document.createElement('option');t.value=map.layers[i].name;t.text=map.layers[i].name;document.getElementById("AddPointP_layer_name_id").appendChild(t);}}
},displayClass: "olControlPointPolFeatures"});
var GetGeoloc = new OpenLayers.Control.Button({
title: "Геолокация. Щёлкните чтобы увидеть ваше, или чьё-либо другое местоположение на карте",
trigger: function() {
creatDialogGeolocation();
},
displayClass: "olControlGeoLoc"
});
 panel.addControls(
 [new OpenLayers.Control.Navigation(),drawLine,drawPoint,drawPoligon,pointPol,save,editCoord,drag,select,edit,del,rout,drawLineRule,drawPolygonSq,selectLenArea,link,OsmBuild,GetGeoloc,m3dContAdd]
 );
 map.addControl(panel);
for(var pa=0;pa<panel.controls.length;pa++){panel.controls[pa].panel_div.style.cursor="pointer";}
}
function CreatpopUPOpenWebGIS(id,htmlv)
{
var bbox = document.getElementById(id).parentNode.getBoundingClientRect();
 var body = document.body
 var docElem = document.documentElement
 var scrollTop = window.pageYOffset || docElem.scrollTop || body.scrollTop
 var scrollLeft = window.pageXOffset || docElem.scrollLeft || body.scrollLeft
 var clientTop = docElem.clientTop || body.clientTop || 0
 var clientLeft = docElem.clientLeft || body.clientLeft || 0
 var topTop = bbox.top + scrollTop - clientTop
 var leftLeft = bbox.left + scrollLeft - clientLeft
var DivEditeLeg=document.createElement("div");
DivEditeLeg.id="id_div"+id+"2";
DivEditeLeg.className="id_divControlmeasureGisSq";
DivEditeLeg.style.position="relative";
DivEditeLeg.innerHTML='<div id="id_div'+id+'Leg" style="background:#ffffff; color:#0000ff;z-index: 6000;position:absolute;left:'+Math.round(leftLeft)+'px;top:'+Math.round(topTop-230)+
'px;overflow:hidden; border: 1px solid black;"><img onclick="closeSelectLenAreaWin()" src="openlayers/theme/default/img/close.gif" style="position:relative; top:3px left:50px;float:right; cursor:pointer"><a style="position:relative; top:20px"></a>'+
'<div id="div'+id+'2" style="font-size:11px"></div>'+htmlv+'</div>';
return DivEditeLeg;
}
function UpdateGeometry()
{
var epsg4326 = new OpenLayers.Projection("EPSG:4326");
var lonlatF = new OpenLayers.LonLat(document.getElementById("x_"+feature2Geom.id).value, document.getElementById("y_"+feature2Geom.id).value).transform(epsg4326,map.getProjectionObject());
feature2Geom.move(new OpenLayers.LonLat(lonlatF.lon,lonlatF.lat));
editCoord.feature.state=OpenLayers.State.UPDATE;
editCoord.resetVertices();
editCoord.layer.drawFeature(editCoord.feature);
}
function UpdateSizePopUpFeatAtl()
{
if(popup){popup.setSize(new OpenLayers.Size(document.getElementById("id_sizePopupFeatAtlw").value,document.getElementById("id_sizePopupFeatAtlh").value));
}
}
function OpenSepPopupWinmap(divs)
{
var bbox = document.getElementById("map").getBoundingClientRect();
 var body = document.body
 var docElem = document.documentElement
 var scrollTop = window.pageYOffset || docElem.scrollTop || body.scrollTop
 var scrollLeft = window.pageXOffset || docElem.scrollLeft || body.scrollLeft
 var clientTop = docElem.clientTop || body.clientTop || 0
 var clientLeft = docElem.clientLeft || body.clientLeft || 0
 var topTop = bbox.top + scrollTop - clientTop
 var leftLeft = bbox.left + scrollLeft - clientLeft
var DivEditeLeg=document.createElement("div");
DivEditeLeg.id="id_divSepTableImage";
DivEditeLeg.className="id_divRoutLegMain";
DivEditeLeg.style.position="relative";
DivEditeLeg.onmousedown=function(event){drags(event)};
DivEditeLeg.onmouseup=function(e){enddrag()};var dopsepstr=''; if(divs.parentNode.parentNode.parentNode.childNodes[0].childNodes[0])
{dopsepstr=divs.parentNode.parentNode.parentNode.childNodes[0].childNodes[0];
DivEditeLeg.innerHTML='<div id="id_divSepTableImageLeg" style="background:#ffffff; color:#0000ff;z-index: 6000;position:absolute;left:'+Math.round(leftLeft+50)+'px;top:'+Math.round(topTop+20)+
'px;overflow:hidden; border: 1px solid black;"><a style="font-size: 9px;"> you can move this window if you select menu item Interface/switch to interface drag</a><img id="id_closeSepTableImageWin" onclick="closeSepTableImageWin(this)" src="openlayers/theme/default/img/close.gif" style="position:relative; top:0px;float:right; cursor:pointer"><a style="position:relative; top:20px"><br>'+
dopsepstr.innerHTML+
'</div>';
}

else{dopsepstr=divs.parentNode.parentNode;
DivEditeLeg.innerHTML=dopsepstr.innerHTML;}
//if(!document.getElementById("id_divSepTableImageLeg"))
body.appendChild(DivEditeLeg);
var inputn = DivEditeLeg.getElementsByTagName('input');
var buttonsn = DivEditeLeg.getElementsByTagName('button');rtt=buttonsn;
for(var i=0;i<buttonsn.length;i++)
{
if(buttonsn[i].id=='')
{/*buttonsn[i].id=='id_SizeUpdateAtt'+Math.random();*/var butn=buttonsn[i];buttonsn[i].onclick=function(){EditeUpdateAttNewDiv(butn,inputn)}}
if(buttonsn[i].id=='id_EditeUpdateAttributes')
{ /*buttonsn[i].id=='id_EditeUpdateAtt'+Math.random();*/var tablen=DivEditeLeg.getElementsByTagName('table');var butn=buttonsn[i];buttonsn[i].onclick=function(){EditeTableNewDiv(butn,tablen)}
}
if(buttonsn[i].id=='id_UpdateAttributesB')
{/*buttonsn[i].id=='id_UpdateAttsave'+Math.random();*/buttonsn[i].innerHTML='<a style="font-size:11px">Update</a>';var tablen=DivEditeLeg.getElementsByTagName('table');var butn=buttonsn[i];buttonsn[i].onclick=function(){UpdateAttsaveNewDiv(butn,tablen)}
}
if(buttonsn[i].id=='id_OpenSepPopupWinmap')
{
buttonsn[i].onclick=function(){OpenSepPopupWinmap(this);}
}
}
//document.getElementById("id_divSepTableImage").onmousedown=function(event){drags(event)};
//document.getElementById("id_divSepTableImage").onmouseup=function(e){enddrag()};

}
function EditeUpdateAttNewDiv(butn,inputn)
{
butn.parentNode.style.width=inputn[0].value+"px";butn.parentNode.style.height=inputn[1].value+"px";
}
function EditeTableNewDiv(butn,tablen)
{tablen=tablen[0];
for(var i=1;i<tablen.childNodes[0].childNodes.length;i++)
{
for(var j=0;j<tablen.childNodes[0].childNodes[i].cells.length;j++)
{
tablen.childNodes[0].childNodes[i].cells[j].innerHTML='<textarea style="height:20px; width:100px" id="" type="text" size="10" value='+'"'+tablen.childNodes[0].childNodes[i].cells[j].innerHTML+'"'+'>'+tablen.childNodes[0].childNodes[i].cells[j].innerHTML+'</textarea><div title="add image or video" onclick="addtableimage(this)" style="float:right; cursor:pointer;width: 20px; height: 15px;background:#0000ff"></div>';
} }
}
function UpdateAttsaveNewDiv(butn,tablen)
{
tablen=tablen[0];
for(var i=1;i<tablen.childNodes[0].childNodes.length;i++)
{
for(var j=0;j<tablen.childNodes[0].childNodes[i].cells.length;j++)
{if(tablen.childNodes[0].childNodes[i].cells[j].innerHTML.indexOf('textarea')==-1){return;}
tablen.childNodes[0].childNodes[i].cells[j].innerHTML=tablen.childNodes[0].childNodes[i].cells[j].childNodes[0].value;
} }
}
function closeSepTableImageWin(e)
{e.parentNode.parentNode.parentNode.removeChild(e.parentNode.parentNode);}
function regFeatureSelected(lay)
{ var feature = lay.feature; var tegForFishbase=0;var tegForPaleobase=0;
if(edilayerMainLayer.attribution=='Weather from <a href="http://openweathermap.org/" alt="World Map and worldwide Weather Forecast online">OpenWeatherMap</a>'){return;}
if(edilayerMainLayer.selectedFeatures.length>1){return;}
selectedFeatureWebGis=lay;
var htmlText="";
htmlText +='<button  id="id_UpdateAttributesB" type="button" onclick="UpdateAttributes();"><a style="font-size: 9px;">Сохранить изменения</a></button>';
htmlText +='<button id=id_EditeUpdateAttributes type="button" title="нажмите для начала редактирования таблицы атрибутов" "><a style="font-size: 9px;">Редактировать</a></button>';
htmlText +='<input id="id_sizePopupFeatAtlw" title="ширина окна в пикселах" type="text" size="1" value="0">';
htmlText +='<input id="id_sizePopupFeatAtlh" title="высота окна в пикселах" type="text" size="1" value="0"><font size="1">размеры окна</font>';
htmlText +='<button type="button" title="нажмите для изменения размера окна" onclick="UpdateSizePopUpFeatAtl();"><a style="font-size: 9px;">изменить размер</a></button>';
htmlText +='<button id="id_OpenSepPopupWinmap" type="button" title="открыть в отдельном окне" onclick="OpenSepPopupWinmap(this);"><a style="font-size: 9px;">в отдельном окне</a></button>';
if(feature.cluster)
{
htmlText+='<div id=tableAttributeAtl> количество в кластере: '+feature.cluster.length+'<br><table width="10%" border="1" cellspacing="0" cellpadding="1">'
htmlText+='<tr>';
for (var i in feature.cluster[0].attributes)
{if(i=="stratgroup"){tegForPaleobase++};if(i=="geogscale"){tegForPaleobase++};if(i=="genus_name"){tegForPaleobase++};
if(i=="early_interval"){tegForPaleobase++};if(i=="cx_int_no"){tegForPaleobase++};
htmlText+='<td><font size="2" color="#082567">'+i+'</font></td>'}
htmlText+='</tr>';}
else{
htmlText+='<div id=tableAttributeAtl> <table width="10%" border="1" cellspacing="0" cellpadding="1">'
htmlText+='<tr>';
for (var i in feature.attributes)
{if(i=="stratgroup"){tegForPaleobase++};if(i=="geogscale"){tegForPaleobase++};if(i=="genus_name"){tegForPaleobase++};
if(i=="early_interval"){tegForPaleobase++};if(i=="cx_int_no"){tegForPaleobase++};
htmlText+='<td><font size="2" color="#082567">'+i+'</font></td>'}
htmlText+='</tr>';}
for(var j=0;j<edilayerMainLayer.features.length;j++)
{ 

if(edilayerMainLayer.features[j].geometry.bounds.bottom==feature.geometry.bounds.bottom&&edilayerMainLayer.features[j].geometry.bounds.left==feature.geometry.bounds.left&&edilayerMainLayer.features[j].geometry.bounds.top==feature.geometry.bounds.top&&edilayerMainLayer.features[j].geometry.bounds.right==feature.geometry.bounds.right){
if(edilayerMainLayer.features[j].cluster)
{
for(var se=0;se<edilayerMainLayer.features[j].cluster.length;se++)
{
htmlText+='<tr align="center" >';
for (var i in edilayerMainLayer.features[j].cluster[se].attributes)
{
if(tegForPaleobase==5&&(i=="order"||i=="subgenus_name"||i=="taxon_name"||i=="stratgroup"||i=="early_interval"||i=="state"||i=="country"||i=="species_name"||i=="family"||i=="class"||i=="late_interval"||i=="matched_name"||i=="county"||i=="phylum"||i=="genus_name"||i=="lithology2"))
{if(typeof edilayerMainLayer.features[j].cluster[se].attributes[i]=='undefined'){htmlText+='<td height="20px" style="font-size: 60%; font-family: sans-serif;color: #082567">'+edilayerMainLayer.features[j].cluster[se].attributes[i]+'</td>';}else{ if(edilayerMainLayer.features[j].cluster[se]){if(edilayerMainLayer.features[j].cluster[se].attributes[i]&&typeof(edilayerMainLayer.features[j].cluster[se].attributes[i])=="string"){if(edilayerMainLayer.features[j].cluster[se].attributes[i].indexOf("https://en.wikipedia.org/wiki/")!==-1){htmlText+='<td height="20px" style="font-size: 60%; font-family: sans-serif;color: #082567">'+edilayerMainLayer.features[j].cluster[se].attributes[i]+'</td>';}else{
if(edilayerMainLayer.features[j].attributes[i]!==''){var paleoStr=edilayerMainLayer.features[j].attributes[i].replace(/\s+/g, '_');
htmlText+='<td height="20px" style="font-size: 60%; font-family: sans-serif"><a href=https://en.wikipedia.org/wiki/'+paleoStr+' target=_blank>'+edilayerMainLayer.features[j].attributes[i]+'</a></td>';}
else{htmlText+='<td height="20px" style="font-size: 60%; font-family: sans-serif;color: #082567">'+edilayerMainLayer.features[j].attributes[i]+'</td>';}
}}   else{htmlText+='<td height="20px" style="font-size: 60%; font-family: sans-serif;color: #082567">'+edilayerMainLayer.features[j].attributes[i]+'</td>';}      }}}
else
{htmlText+='<td height="20px" style="font-size: 60%; font-family: sans-serif;color: #082567">'+edilayerMainLayer.features[j].cluster[se].attributes[i]+'</td>';}
}
htmlText+='</tr>';

}

}
else{
htmlText+='<tr align="center" >';
for (var i in edilayerMainLayer.features[j].attributes)
{
if(tegForPaleobase==5&&(i=="order"||i=="subgenus_name"||i=="taxon_name"||i=="stratgroup"||i=="early_interval"||i=="state"||i=="country"||i=="species_name"||i=="family"||i=="class"||i=="late_interval"||i=="matched_name"||i=="county"||i=="phylum"||i=="genus_name"||i=="lithology2"))
{if(typeof edilayerMainLayer.features[j].attributes[i]=='undefined'){htmlText+='<td height="20px" style="font-size: 60%; font-family: sans-serif;color: #082567">'+edilayerMainLayer.features[j].attributes[i]+'</td>';}else{ if(edilayerMainLayer.features[j]){if(edilayerMainLayer.features[j].attributes[i]&&typeof(edilayerMainLayer.features[j].attributes[i])=="string"){if(edilayerMainLayer.features[j].attributes[i].indexOf("https://en.wikipedia.org/wiki/")!==-1){htmlText+='<td height="20px" style="font-size: 60%; font-family: sans-serif;color: #082567">'+edilayerMainLayer.features[j].attributes[i]+'</td>';}else{
if(edilayerMainLayer.features[j].attributes[i]!==''){var paleoStr=edilayerMainLayer.features[j].attributes[i].replace(/\s+/g, '_');
htmlText+='<td height="20px" style="font-size: 60%; font-family: sans-serif"><a href=https://en.wikipedia.org/wiki/'+paleoStr+' target=_blank>'+edilayerMainLayer.features[j].attributes[i]+'</a></td>';}
else{htmlText+='<td height="20px" style="font-size: 60%; font-family: sans-serif;color: #082567">'+edilayerMainLayer.features[j].attributes[i]+'</td>';}
}}   else{htmlText+='<td height="20px" style="font-size: 60%; font-family: sans-serif;color: #082567">'+edilayerMainLayer.features[j].attributes[i]+'</td>';}     }}}
else
{htmlText+='<td height="20px" style="font-size: 60%; font-family: sans-serif;color: #082567">'+edilayerMainLayer.features[j].attributes[i]+'</td>';}
}
htmlText+='</tr>';
  }
 }
     
 }
htmlText+='</table></div>';
if(ChartKvadr&&ChartKvadr.active==true)
{
creatChartKvadr(lay);
}
if (editCoord.active==true)
{var epsg4326 = new OpenLayers.Projection("EPSG:4326");
var lonlatF = new OpenLayers.LonLat(feature.geometry.x, feature.geometry.y).transform(map.getProjectionObject(),epsg4326);
var htmlText="";
htmlText+='Longitude (x):'+'<input id=x_'+feature.id+' type="text" value='+lonlatF.lon+'>'+'<br>'+'Latitude (y):'+'<input id=y_'+feature.id+' type="text" value='+lonlatF.lat+'>'+'<br>';
htmlText +='<button type="button" onclick="UpdateGeometry();">Update Geometry</button>'; feature2Geom=feature;}
 popup = new OpenLayers.Popup.FramedCloud("featurePopup",
 feature.geometry.getBounds().getCenterLonLat(),
 new OpenLayers.Size(20,100),
 htmlText ,
 null, true, onPopupClose);
 feature.popup = popup;
 popup.feature = feature;
popup.id="popup_"+feature.id
popup.minSize=new OpenLayers.Size(150,100);
popup.maxSize=new OpenLayers.Size(450,260);
 map.addPopup(popup);
 if(document.getElementById("id_UpdateAttributesB")){document.getElementById("id_UpdateAttributesB").onclick=function(){UpdateAttributes(lay)}}
document.getElementById("featurePopup").onmousedown=function(event){drags(event)};
document.getElementById("featurePopup").onmouseup=function(e){enddrag()};
if(document.getElementById("id_EditeUpdateAttributes")){document.getElementById("id_sizePopupFeatAtlw").value= popup.size.w;
document.getElementById("id_sizePopupFeatAtlh").value= popup.size.h; 
document.getElementById("id_EditeUpdateAttributes").onclick=function(){EditeUpdateAttributes(feature)}}
}
function addtableimage(e)
{ var td=e; 
var bbox = document.getElementById("map").getBoundingClientRect();
 var body = document.body
 var docElem = document.documentElement
 var scrollTop = window.pageYOffset || docElem.scrollTop || body.scrollTop
 var scrollLeft = window.pageXOffset || docElem.scrollLeft || body.scrollLeft
 var clientTop = docElem.clientTop || body.clientTop || 0
 var clientLeft = docElem.clientLeft || body.clientLeft || 0
 var topTop = bbox.top + scrollTop - clientTop
 var leftLeft = bbox.left + scrollLeft - clientLeft
var DivEditeLeg=document.createElement("div");
DivEditeLeg.id="id_divTableImage";
DivEditeLeg.onmousedown=function(event){drags(event)};
DivEditeLeg.onmouseup=function(e){enddrag()};
DivEditeLeg.className="id_divRoutLegMain";
DivEditeLeg.style.position="relative";
DivEditeLeg.innerHTML='<div id="id_divTableImageLeg" style="background:#ffffff; color:#0000ff;z-index: 6000;position:absolute;left:'+Math.round(leftLeft+50)+'px;top:'+Math.round(topTop+20)+
'px;overflow:hidden; border: 1px solid black;"><img onclick="closeTableImageWin()" src="openlayers/theme/default/img/close.gif" style="position:relative; top:10px;float:right; cursor:pointer"><a style="position:relative; top:20px"><br>'+
'<a>Выберете файл изображения(картинки):</a><br>'+
'<input title="Выберете изображение с вашего компьютера" type="file" id="file_idImageTable"><input type="checkbox" id="id_imageTableUpload" value="checkbox"/>Загрузить изображение в OpenWebGIS'+'<br>'+
'Или введите URL-адрес изображения:<textarea id="id_imageTableTextArea" style="width: 250px; height: 20px;font-size:11px"></textarea><br>'+
'Или введите URL-адрес видео:<textarea id="id_VideoTableTextArea" value="" style="width: 250px; height: 20px;font-size:11px"></textarea><br>'+
'<a>ширина:</a><input type="text" size="5" id="id_imageTableWidth" value="50"/><br>'+
'<a>высота:</a><input type="text" size="5" id="id_imageTableHeight" value="50"/><br>'+
'<input type="checkbox" id="id_imageTableorSize"  onchange="" value="checkbox"/>оставить размер<br>'+
'<p> <button type=button id= "id_OK_ImageTable" onclick=OK_ImageTable()>OK</button></p>';
'</div>';
if(!document.getElementById("id_divTableImageLeg"))
{body.appendChild(DivEditeLeg); }
//document.getElementById("id_divTableImage").onmousedown=function(event){drags(event)};
//document.getElementById("id_divTableImage").onmouseup=function(e){enddrag()};
//DivEditeLeg.childNodes[0].childNodes[4].addEventListener('change', readSingleFileImage, false);
document.getElementById('file_idImageTable').addEventListener('change', readSingleFileImage, false);
//DivEditeLeg.childNodes[0].childNodes[23].childNodes[1].onclick=function(){OK_ImageTable(td);}
document.getElementById('id_OK_ImageTable').onclick=function(){OK_ImageTable(td);}
var c; fileZIP=c;
}
function OK_ImageTable(td)
{var w=document.getElementById("id_imageTableWidth").value; var h=document.getElementById("id_imageTableHeight").value;
var myUrl0='';
myUrl0=document.getElementById("id_VideoTableTextArea").value; 
if(myUrl0!=='')
{var ddsst='';if(myUrl0.search(/youtube/g)!==-1){ddsst='//';if(myUrl0.search(/watch\?v=/g)!==-1){var tsy00=myUrl0.split('https://')[1];var tsy=myUrl0.split('http://')[1];if(typeof tsy00=='undefined' ){}else{tsy=tsy00;}if(typeof tsy=='undefined' ){tsy=myUrl0} tsy0=tsy.split('watch?v=')[0];tsy1=tsy.split('watch?v=')[1];myUrl0=tsy0+'embed/'+tsy1;}}
if(myUrl0.search(/youtu.be/g)!==-1){ddsst='//';var tsy=myUrl0.split('http://')[1];if(typeof tsy=='undefined' ){tsy=myUrl0} tsy0=tsy.split('youtu.be/')[1];myUrl0='www.youtube.com/embed/'+tsy0;}

td.previousElementSibling.value="<iframe width="+w+" height="+h+" src="+ddsst+myUrl0+" frameborder=0 allowfullscreen></iframe>";  closeTableImageWin();return;}
if(fileZIP){if(fileZIP.type=="image/jpeg"||fileZIP.type=="image/png"||fileZIP.type=="image/tiff"||fileZIP.type=="image/gif"||fileZIP.type=="image/bmp"||fileZIP.type=="image/tif"){} else{alert("ERROR. file is not image");return;}}
myUrl=document.getElementById("id_imageTableTextArea").value; 

if(myUrl.length==0)
{
var contents;
 if (fileZIP) {
 var r = new FileReader();
 r.onload = function(e) { contents = e.target.result;
 if(document.getElementById('id_imageTableorSize').checked==true)
 {var imgN=document.createElement("img");
 imgN.src=contents;w=imgN.width; h=imgN.height;}
  if(document.getElementById('id_imageTableUpload').checked==true)
 {
 if(fileZIP.size>8000000){alert("size of the file could not be more than 8 MB"); return;}
 try {var xmlhttp =new XMLHttpRequest();}
catch (e) {alert("error");}
xmlhttp.open('POST','/temp.php?rand='+Math.random(), true);
xmlhttp.setRequestHeader("Cache-Control", "no-cache");
//xmlhttp.setRequestHeader("Content-type", fileZIP.type);
 xmlhttp.setRequestHeader("Content-Type","application/x-www-form-urlencoded");
xmlhttp.onreadystatechange = function()
{if(xmlhttp.readyState == 4&&xmlhttp.status == 200) {
if(xmlhttp==''){alert("нет данных");return;}
//var varlink=xmlhttp.responseText;
td.previousElementSibling.value="<img src="+window.location.origin+"/images/"+xmlhttp.responseText+" style=width:"+w+"px;height:"+h+"px>";
}}
alert("Эта функция работает только в онлайн веб-версии OpenWebGIS")
{return;
xmlhttp.send('value='+contents+'&name='+fileZIP.name);}
 }
 else
{td.previousElementSibling.value="<img src="+contents+" style=width:"+w+"px;height:"+h+"px>";}
closeTableImageWin();
 } 
 r.readAsDataURL(fileZIP); } else {  alert("Ошибка загрузки файла"); }
 }
 else{
 if(myUrl.length<5)
{alert("error in the url"); return;}
 if(document.getElementById('id_imageTableorSize').checked==true)
 {var imgN=document.createElement("img");
 imgN.src=document.getElementById("id_imageTableTextArea").value;w=imgN.width; h=imgN.height;}
 td.previousElementSibling.value="<img src="+document.getElementById("id_imageTableTextArea").value+" style=width:"+w+"px;height:"+h+"px>";
 closeTableImageWin();
 }
 

}
function EditeUpdateAttributes(feature)
{
var feature=feature;
if(!document.getElementById("tableAttributeAtl2")){
var NewTableLegAtl=document.createElement("div");
NewTableLegAtl.id="tableAttributeAtl2";
var htmlText='';
htmlText+='<table width="10%" border="1" cellspacing="0" cellpadding="1">'
htmlText+='<tr>';
for (var i in feature.attributes)
{htmlText+='<td><font size="2" color="#082567">'+i+'</font></td>'}
htmlText+='</tr>';
var temSelFeature=[];var y=0;
for(var j=0;j<edilayerMainLayer.features.length;j++)
{ if(edilayerMainLayer.features[j].geometry.bounds.bottom==feature.geometry.bounds.bottom&&edilayerMainLayer.features[j].geometry.bounds.left==feature.geometry.bounds.left&&edilayerMainLayer.features[j].geometry.bounds.top==feature.geometry.bounds.top&&edilayerMainLayer.features[j].geometry.bounds.right==feature.geometry.bounds.right){
htmlText+='<tr align="center" >';temSelFeature.push(edilayerMainLayer.features[j]);
selectedFeatureWebGis=temSelFeature;
for (var i in edilayerMainLayer.features[j].attributes)
{
var varid=i+"_"+y+"_"+edilayerMainLayer.features[j].id;
htmlText+='<td height="20px" style="font-size: 60%; font-family: sans-serif;color: #082567"><textarea style="height:20px; width:100px" id="'+varid+'" type="text" size="10" value='+'"'+edilayerMainLayer.features[j].attributes[i]+'"'+'>'+edilayerMainLayer.features[j].attributes[i]+'</textarea><div title="add image or video" onclick="addtableimage(this)" style="float:right; cursor:pointer;width: 20px; height: 15px;background:#0000ff"></div></td>';
}
htmlText+='</tr>';
 y++; }
 }
htmlText+='</table>';
document.getElementById("tableAttributeAtl").innerHTML='';
NewTableLegAtl.innerHTML=htmlText;
document.getElementById("tableAttributeAtl").appendChild(NewTableLegAtl);
 }//end if(!document.getElementById("tableAttributeAtl2)){
}
function onPopupClose(gg) {
 map.removePopup(this);VarPostGISfromCSV=0;
}
function onFeatureUnselect(lay)
{feature = lay.feature;
if (feature.popup) {
 popup.feature = null;
 map.removePopup(feature.popup);
 feature.popup.destroy();
 feature.popup = null;
 }
}
function UpdateAttributes(lay)
{
 x=confirm('Вы уверены?');
 if (x==true) {
for(var y=0;y<selectedFeatureWebGis.length;y++)
{var feature = selectedFeatureWebGis[y]
for (var i in feature.attributes)
{
var varid=i+"_"+y+"_"+selectedFeatureWebGis[y].id
var data = document.getElementById(varid).value;
if(feature.attributes[i] != data)
 { feature.attributes[i] = data;
feature.data[i]=data; feature.state = OpenLayers.State.UPDATE; }
}
 }
if(edilayerMainLayer.protocol){
saveStrategy.layer=edilayerMainLayer; saveStrategy.save();}
document.getElementById("featurePopup").parentNode.removeChild(document.getElementById("featurePopup"));
regFeatureSelected(lay);
 }
 else {
 }
}
function Update3Dmap(widget)
{//widget.scene.primitives.destroyPrimitives = true;
//widget.scene.primitives.destroy();
if(typeof CesiumDisplay!=="undefined")
{CesiumDisplay.destroy();CesiumDisplay=undefined;}
for(var i=0;i<primitive3D.length;i++)
{widget.scene.primitives.remove(widget.scene.primitives.get(i));}
for(var i=0;i<wmsArray3d.length;i++)
{widget.scene.imageryLayers.remove(widget.scene.imageryLayers.get(i));}
primitive3D=[];  var img1=[];var img2=[];wmsArray3d=[];

var dataSource = new Cesium.GeoJsonDataSource();
var ds=new Cesium.DataSourceCollection()
var dis=new Cesium.DataSourceDisplay({scene:widget.scene,dataSourceCollection:ds})
CesiumDisplay=dis; globalwidg3dEntity={};globalwidg3dWMS={};
for(var a=0;a<map.layers.length;a++)
{
var layers = widget.scene.imageryLayers;
 if(map.layers[a].visibility==true&&(map.layers[a].CLASS_NAME=="OpenLayers.Layer.WMS"||map.layers[a].CLASS_NAME=="OpenLayers.Layer.XYZ"))
 { var wmsurl='';var sldbody='';
 for(var y=0; y<map.layers[a].grid.length;y++)
 {// '//mesonet.agron.iastate.edu/cgi-bin/wms/nexrad/n0r.cgi?'
 //'name:wmsurl.split("LAYERS=")[1].split('&')';
 for(var yj=0; yj<map.layers[a].grid[y].length;yj++)
 { if(map.layers[a].grid[y][yj].url!==null){wmsurl=map.layers[a].grid[y][yj].url;}}}
if(wmsurl.split('http://')[1])
{var wmsurl2='//'+wmsurl.split('http://')[1].split('?')[0]}
else
{var wmsurl2=wmsurl.split('?')[0];}
if(wmsurl.split('SLD_BODY=')[1]){if(wmsurl.split('SLD_BODY=')[1].split('STYLES=')[1]){ sldbody=wmsurl.split('SLD_BODY=')[1].split('STYLES=')[1];}}
if(wmsurl.split('http://')[1]){
 var wms3d = layers.addImageryProvider(
 new Cesium.WebMapServiceImageryProvider({
url : wmsurl2,
layers : map.layers[a].params.LAYERS,
parameters : {transparent : 'true',format : map.layers[a].params.FORMAT }//,
               //proxy : new Cesium.DefaultProxy(wmsstr)
            }));
            globalwidg3dWMS[a+"_layerwms"]={"1":wmsurl2,"2":JSON.stringify({transparent : 'true',format : map.layers[a].params.FORMAT }),"3":map.layers[a].params.LAYERS}
            }
else{
if(sldbody==''){var param={transparent : 'true',format : map.layers[a].params.FORMAT}}
else{var param={transparent : 'true',format : map.layers[a].params.FORMAT, sld_body:sldbody }}
 var wms3d = layers.addImageryProvider(
 new Cesium.WebMapServiceImageryProvider({
url : wmsurl2,
layers : map.layers[a].params.LAYERS,
parameters : param//,
               //proxy : new Cesium.DefaultProxy(wmsstr)
            }));
 globalwidg3dWMS[a+"_layerwms"]={"1":wmsurl2,"2":param,"3":map.layers[a].params.LAYERS};

}


wms3d.alpha = parseFloat(map.layers[a].opacity);wmsArray3d.push(wms3d);
globalwidg3dWMS[a+"_layerwms"]["4"]=parseFloat(map.layers[a].opacity);

 }
 
var primit=widget.scene.primitives;
 if((map.layers[a].CLASS_NAME=="OpenLayers.Layer.Image"&&map.layers[a].visibility==true)||(map.layers[a].featuresH&&map.layers[a].visibility==true)||(map.layers[a].featuresIn&&map.layers[a].visibility==true))
{var img = new Image(); 
if(map.layers[a].featuresH||map.layers[a].featuresIn)
{img.src=map.layers[a].div.childNodes[0].toDataURL("image/png");}
else{img.src=map.layers[a].url;}
img.id="3dim_id";
img1.push(img);
var imageWidth=map.size.w;
 var imageHeight=map.size.h;
var splitBw=imageWidth/30;
var splitBh=imageHeight/30;
if(primit.length!==0){var indexn=primit.length-1} else{var indexn=0};index=[]
for(i=0;i<imageWidth;i+=splitBw){
      for(j=0;j<imageHeight;j+=splitBh){if(primit.length!==0){indexn++;index.push(indexn)}else{index.push(indexn);}
     rectangle2=primit.add(new Cesium.RectanglePrimitive({}))
     primitive3D.push(rectangle2);
      
      }
            }
            
var is1=img1[img1.length-1];
img1[img1.length-1].onload=function(a,is1,index)
{
return function()
{

var can00=document.createElement("canvas");
if(map.layers[a].featuresH||map.layers[a].featuresIn)
{
var posx=map.layers[a].div.style.left.split('px')[0];
var posy=map.layers[a].div.style.top.split('px')[0];
var sizw=map.layers[a].div.childNodes[0].width;
var sizh=map.layers[a].div.childNodes[0].height;
}
else
{
var posx=map.layers[a].tile.position.x;
var posy=map.layers[a].tile.position.y;
var sizw=map.layers[a].tile.size.w;
var sizh=map.layers[a].tile.size.h;
}
can00.width=is1.width;
can00.height=is1.height;
var ctx00 = can00.getContext("2d");
var alphaImg=parseFloat(1);if(map.layers[a].opacity===null) {alphaImg=parseFloat(1);}else{alphaImg=parseFloat(map.layers[a].opacity);}
ctx00.globalAlpha = alphaImg;
ctx00.drawImage(is1, 0, 0);
var ImageData0=can00.toDataURL();
var img22= new Image(); img22.src=ImageData0;
img2.push(img22)
//var ctx0 = can0.getContext("2d");
var ElemDivImg=map.layers[a].div.childNodes[0];
var bbox1=ElemDivImg.getBoundingClientRect();
var bbox = document.getElementById("map").getBoundingClientRect();
var topTop = bbox1.top-bbox.top;
 var leftLeft = bbox1.left-bbox.left;posx=leftLeft;posy=topTop;
//rtt=topTop;alert("1");rtt=leftLeft;alert("2");

var is2=img2[img2.length-1];
img2[img2.length-1].onload = function(a,is2,index){return function(){
var can0=document.createElement("canvas");
can0.width=map.size.w;
  can0.height=map.size.h;var sx=0;var sy=0;var dsx=0;var dsy=0;
var ctx0 = can0.getContext("2d");

dsx=is2.width;dsy=is2.height;
if(sizw>map.size.w){ sx=0;}
if(sizh>map.size.h){ sy=0;}

//ctx0.drawImage(img, sx,sy,dsx,dsy,posx, posy,sizw,sizh);
ctx0.drawImage(is2, posx, posy,sizw,sizh);

var imageWidth=can0.width;
 var imageHeight=can0.height;
var splitBw=imageWidth/30;
var splitBh=imageHeight/30;
var ind2=0;
for(i=0;i<imageWidth;i+=splitBw){
      for(j=0;j<imageHeight;j+=splitBh){
            var ImageData = ctx0.getImageData(i,j,splitBw,splitBh);     
var sndCanvas=document.createElement("canvas");
 sndCanvas.width=splitBw;  sndCanvas.height=splitBh;
if(i==0&&j==0)
{var ext1 = new OpenLayers.Pixel(i+splitBw, j);
var ext2 = new OpenLayers.Pixel(i, j+splitBh);}//left,bottom}
else
{var ext1 = new OpenLayers.Pixel(i+splitBw, j);var ext2 = new OpenLayers.Pixel(i, j+splitBh);}
//rtt=ext2;alert("1");rtt=ext1;alert("2");
var lonlat1 = map.getLonLatFromPixel(ext1);var lonlat2 = map.getLonLatFromPixel(ext2);
var boundImage=new OpenLayers.Bounds(lonlat2.lon, lonlat2.lat, lonlat1.lon, lonlat1.lat);
            var ctx2 = sndCanvas.getContext("2d");            ctx2.putImageData(ImageData,0,0);
ImageData=sndCanvas.toDataURL();boundImage.transform(map.getProjectionObject(),new OpenLayers.Projection("EPSG:4326"));
 //var alphaImg=parseFloat(0.999);if(map.layers[a].opacity===null) {alphaImg=parseFloat(0.999);;}else{alphaImg=parseFloat(map.layers[a].opacity);}
//alert(alphaImg);
var pr=primit.get(index[ind2]);ind2++;
pr.rectangle=Cesium.Rectangle.fromDegrees(boundImage.left, boundImage.bottom,boundImage.right, boundImage.top);
pr.material=new Cesium.Material({translucent:true,        fabric : {type : 'Image', uniforms : {image : ImageData }         }     })
//primitive3D.push(rectangle2);
          }
    }
}}(a,is2,index);
}}(a,is1,index);
}


if(map.layers[a].renderer&&map.layers[a].renderer.canvas&&map.layers[a].CLASS_NAME=="OpenLayers.Layer.Vector")
{if(map.layers[a].visibility==true&&map.layers[a].features[0])
{//var strDataURI = map.layers[i].renderer.canvas.canvas.toDataURL();
if (document.getElementById("id_3dJSON").checked==true)
{

var format = new OpenLayers.Format.GeoJSON({ 'internalProjection': new OpenLayers.Projection("EPSG:900913"),'externalProjection': new OpenLayers.Projection("EPSG:4326")});
//rtt=
var jsonstring=''
if(map.layers[a].features)
{
jsonstring = format.write(map.layers[a].features);
}
 Cesium.Math.setRandomNumberSeed(0);
 var jsonDS=new Cesium.GeoJsonDataSource();
ds.add(jsonDS); 
//widget.scene.dataSources
if(map.layers[a].features[0].geometry.CLASS_NAME=="OpenLayers.Geometry.Point")
{
var ArrayFeat=jsonstring.split('{"type":"Feature"');
for (var v=0;v<map.layers[a].features.length;v++)
{ var br=new OpenLayers.Bounds(map.layers[a].features[v].geometry.bounds.left, map.layers[a].features[v].geometry.bounds.bottom,map.layers[a].features[v].geometry.bounds.right,map.layers[a].features[v].geometry.bounds.top);
var lonlat=br.transform(map.getProjectionObject(),new OpenLayers.Projection("EPSG:4326"));
var pointsiz=1;
if(map.layers[a].styleMap.styles.default.rules.length==0){pointsiz=map.layers[a].styleMap.styles.default.defaultStyle.pointRadius;}
else{
for(var tt=0;tt<map.layers[a].styleMap.styles.default.rules.length;tt++)
{ 
if(map.layers[a].styleMap.styles.default.rules[tt].filter.CLASS_NAME=="OpenLayers.Filter.Comparison"&&map.layers[a].features[v].attributes[map.layers[a].styleMap.styles.default.rules[tt].filter.property]>=map.layers[a].styleMap.styles.default.rules[tt].filter.lowerBoundary&&map.layers[a].features[v].attributes[map.layers[a].styleMap.styles.default.rules[tt].filter.property]<=map.layers[a].styleMap.styles.default.rules[tt].filter.upperBoundary)
{pointsiz=map.layers[a].styleMap.styles.default.rules[tt].symbolizer.pointRadius;}
if(map.layers[a].styleMap.styles.default.rules[tt].filter.type=="==")
{
if(map.layers[a].features[v].attributes[map.layers[a].styleMap.styles.default.rules[tt].filter.property]==map.layers[a].styleMap.styles.default.rules[tt].filter.value)
{pointsiz=map.layers[a].styleMap.styles.default.rules[tt].symbolizer.pointRadius;}

}
    }
}

//var strzam='"type":"Point","coordinates":['+lonlat.left+','+lonlat.bottom+']}'; rtt=strzam; alert("ee");
var multcoefSq=parseFloat(document.getElementById("dopWid3djson"+"_"+map.layers[a].name).value);
var x0=lonlat.left;var y0=lonlat.bottom-pointsiz*multcoefSq;var x1=lonlat.left-pointsiz*multcoefSq; var y1=lonlat.bottom;var x2=lonlat.left;var y2=lonlat.bottom+pointsiz*multcoefSq;var x3=lonlat.left+pointsiz*multcoefSq;var y3=lonlat.bottom;
var strzam2= '"type":"MultiPolygon","coordinates":[[[['+x1+','+y0+'],['+x1+','+y2+'],['+x3+','+y2+'],['+x3+','+y0+'],['+x1+','+y0+']]]]},';
if(typeof ArrayFeat[v+1].split(']},')[1]!=='undefined')
{ArrayFeat[v+1]='{"type":"Feature"'+ArrayFeat[v+1].split('"type":"Point",')[0]+strzam2+ArrayFeat[v+1].split(']},')[1];}
else
{var strzam2='"type":"MultiPolygon","coordinates":[[[['+x1+','+y0+'],['+x1+','+y2+'],['+x3+','+y2+'],['+x3+','+y0+'],['+x1+','+y0+']]]]}'; var strk="},";
if(v+1>=map.layers[a].features.length){strk='}]}';}
ArrayFeat[v+1]='{"type":"Feature"'+ArrayFeat[v+1].split('"type":"Point",')[0]+strzam2+strk;
}
//jsonstring=jsonstring.replace(strzam,strzam2);

}
jsonstring=ArrayFeat.join("");
}
var multCoefHei=parseFloat(document.getElementById("dopHei3djson"+"_"+map.layers[a].name).value);
var coefAtrr=document.getElementById("3d_dop_select_id"+"_"+map.layers[a].name).value;
var multCoefHei2=parseFloat(document.getElementById("dopHei3djson2"+"_"+map.layers[a].name).value);
var coefAtrr2=document.getElementById("3d_dop_select_id2"+"_"+map.layers[a].name).value;
var strcoefsve=multCoefHei+","+coefAtrr+","+multCoefHei2+","+coefAtrr2;
globalwidg3dEntity[a+"layerent"]={"1":jsonstring,"2":strcoefsve};
var objcoloren={}; objcolorenLine={};
 jsonstring=JSON.parse(jsonstring);
//jsonDS.fromUrl('ne_10m_us_states.topojson');

jsonDS.load(jsonstring).then(function() {
var entities = jsonDS.entities.values;rtt=jsonDS; var pointyes=false;var pointsiz=100;var widthL=2;
if(map.layers[a].features[0].geometry.CLASS_NAME=="OpenLayers.Geometry.Point")
{pointyes=true;}
if(map.layers[a].styleMap.styles.default.rules.length==0){pointsiz=1000*map.layers[a].styleMap.styles.default.defaultStyle.pointRadius;}
for (var ii = 0; ii < entities.length; ii++) 
{var color=''; stcolor='';var styla=map.layers[a].styleMap.styles.default;
var entity = entities[ii];
if(map.layers[a].styleMap.styles.default.rules.length==0)
{if(map.layers[a].features[0].geometry.CLASS_NAME=="OpenLayers.Geometry.Point"||map.layers[a].features[0].geometry.CLASS_NAME=="OpenLayers.Geometry.Polygon"||map.layers[a].features[0].geometry.CLASS_NAME=="OpenLayers.Geometry.MultiPolygon")
{color=new Cesium.Color.fromCssColorString(styla.defaultStyle.fillColor);stcolor=new Cesium.Color.fromCssColorString(styla.defaultStyle.strokeColor);}
else
{color=new Cesium.Color.fromCssColorString(styla.defaultStyle.strokeColor);widthL=styla.defaultStyle.strokeWidth;}
}
else
{
for(var tt=0;tt<map.layers[a].styleMap.styles.default.rules.length;tt++)
{ 
if(styla.rules[tt].filter.CLASS_NAME=="OpenLayers.Filter.Comparison"&&parseFloat(entity.properties[styla.rules[tt].filter.property])>=parseFloat(styla.rules[tt].filter.lowerBoundary)&&parseFloat(entity.properties[styla.rules[tt].filter.property])<=parseFloat(styla.rules[tt].filter.upperBoundary))
{
if(map.layers[a].features[0].geometry.CLASS_NAME=="OpenLayers.Geometry.Point"||map.layers[a].features[0].geometry.CLASS_NAME=="OpenLayers.Geometry.Polygon"||map.layers[a].features[0].geometry.CLASS_NAME=="OpenLayers.Geometry.MultiPolygon")
{var c=styla.rules[tt].symbolizer.fillColor.split('rgb(')[1].split(')')[0].split(',');
var c2=styla.rules[tt].symbolizer.strokeColor.split('rgb(')[1].split(')')[0].split(',');
c2[0]=parseInt(c2[0]);c2[1]=parseInt(c2[1]);c2[2]=parseInt(c2[2]);stcolor=Cesium.Color.fromBytes(c2[0],c2[1],c2[2],1);

}
else{var c=styla.rules[tt].symbolizer.strokeColor.split('rgb(')[1].split(')')[0].split(',');widthL=map.layers[a].styleMap.styles.default.rules[tt].symbolizer.strokeWidth;}
c[0]=parseInt(c[0]);c[1]=parseInt(c[1]);c[2]=parseInt(c[2]);

color=Cesium.Color.fromBytes(c[0],c[1],c[2],1);
}
if(styla.rules[tt].filter.CLASS_NAME=="OpenLayers.Filter.Logical"&&styla.rules[0].filter.filters)
{ if(map.layers[a].styleMap.styles.default.rules.length==1)
{if(entity.properties[map.layers[a].styleMap.styles.default.rules[tt].filter.filters[0].property]>=map.layers[a].styleMap.styles.default.rules[tt].filter.filters[0].value&&entity.properties[map.layers[a].styleMap.styles.default.rules[tt].filter.filters[0].property]<map.layers[a].styleMap.styles.default.rules[tt].filter.filters[1].value)
{
if(map.layers[a].features[0].geometry.CLASS_NAME=="OpenLayers.Geometry.Point"||map.layers[a].features[0].geometry.CLASS_NAME=="OpenLayers.Geometry.Polygon"||map.layers[a].features[0].geometry.CLASS_NAME=="OpenLayers.Geometry.MultiPolygon")
{
if(map.layers[a].styleMap.styles.default.rules[tt].symbolizer.fillColor.split('rgb(')[1])
{var c=map.layers[a].styleMap.styles.default.rules[tt].symbolizer.fillColor.split('rgb(')[1].split(')')[0].split(',');
color=Cesium.Color.fromBytes(c[0],c[1],c[2],1);
var c2=map.layers[a].styleMap.styles.default.rules[tt].symbolizer.strokeColor.split('rgb(')[1].split(')')[0].split(',');
stcolor=Cesium.Color.fromBytes(c2[0],c2[1],c2[2],1);

}
else{color=Cesium.Color.fromCssColorString(map.layers[a].styleMap.styles.default.rules[tt].symbolizer.fillColor);}
}
else{
if(map.layers[a].styleMap.styles.default.rules[tt].symbolizer.fillColor.split('rgb(')[1])
{var c=map.layers[a].styleMap.styles.default.rules[tt].symbolizer.strokeColor.split('rgb(')[1].split(')')[0].split(',');color=Cesium.Color.fromBytes(c[0],c[1],c[2],1);}
else{color=Cesium.Color.fromCssColorString(map.layers[a].styleMap.styles.default.rules[tt].symbolizer.strokeColor);}
widthL=map.layers[a].styleMap.styles.default.rules[tt].symbolizer.strokeWidth;
}
}}
if(map.layers[a].styleMap.styles.default.rules.length>1)
{if(entity.properties[map.layers[a].styleMap.styles.default.rules[tt].filter.filters[0].property]>=map.layers[a].styleMap.styles.default.rules[tt].filter.filters[0].value&&entity.properties[map.layers[a].styleMap.styles.default.rules[tt].filter.filters[0].property]<map.layers[a].styleMap.styles.default.rules[tt].filter.filters[1].value&&entity.properties[map.layers[a].styleMap.styles.default.rules[tt].filter.filters[2].property]>=map.layers[a].styleMap.styles.default.rules[tt].filter.filters[2].lowerBoundary&&entity.properties[map.layers[a].styleMap.styles.default.rules[tt].filter.filters[2].property]<=map.layers[a].styleMap.styles.default.rules[tt].filter.filters[2].upperBoundary)
{
if(map.layers[a].features[0].geometry.CLASS_NAME=="OpenLayers.Geometry.Point"||map.layers[a].features[0].geometry.CLASS_NAME=="OpenLayers.Geometry.Polygon"||map.layers[a].features[0].geometry.CLASS_NAME=="OpenLayers.Geometry.MultiPolygon")
{
if(map.layers[a].styleMap.styles.default.rules[tt].symbolizer.fillColor.split('rgb(')[1])
{var c=map.layers[a].styleMap.styles.default.rules[tt].symbolizer.fillColor.split('rgb(')[1].split(')')[0].split(',');
color=Cesium.Color.fromBytes(c[0],c[1],c[2],1);
  if(map.layers[a].styleMap.styles.default.rules[tt].symbolizer.strokeColor.split('rgb(')[1])
{var c2=map.layers[a].styleMap.styles.default.rules[tt].symbolizer.strokeColor.split('rgb(')[1].split(')')[0].split(',');
stcolor=Cesium.Color.fromBytes(c2[0],c2[1],c2[2],1);}
   else{stcolor=Cesium.Color.fromCssColorString(map.layers[a].styleMap.styles.default.rules[tt].symbolizer.strokeColor);}
}
else{color=Cesium.Color.fromCssColorString(map.layers[a].styleMap.styles.default.rules[tt].symbolizer.fillColor);
if(map.layers[a].styleMap.styles.default.rules[tt].symbolizer.strokeColor.split('rgb(')[1])
{var c2=map.layers[a].styleMap.styles.default.rules[tt].symbolizer.strokeColor.split('rgb(')[1].split(')')[0].split(',');
stcolor=Cesium.Color.fromBytes(c2[0],c2[1],c2[2],1);}
   else{stcolor=Cesium.Color.fromCssColorString(map.layers[a].styleMap.styles.default.rules[tt].symbolizer.strokeColor);}
}
}
else{
if(map.layers[a].styleMap.styles.default.rules[tt].symbolizer.fillColor.split('rgb(')[1])
{var c=map.layers[a].styleMap.styles.default.rules[tt].symbolizer.strokeColor.split('rgb(')[1].split(')')[0].split(',');color=Cesium.Color.fromBytes(c[0],c[1],c[2],1);}
else{color=Cesium.Color.fromCssColorString(map.layers[a].styleMap.styles.default.rules[tt].symbolizer.strokeColor);}
widthL=map.layers[a].styleMap.styles.default.rules[tt].symbolizer.strokeWidth;
}
}}
}

if(map.layers[a].styleMap.styles.default.rules[tt].filter.type=="==")
{
if(entity.properties[map.layers[a].styleMap.styles.default.rules[tt].filter.property]==map.layers[a].styleMap.styles.default.rules[tt].filter.value)
{

if(map.layers[a].features[0].geometry.CLASS_NAME=="OpenLayers.Geometry.Point"||map.layers[a].features[0].geometry.CLASS_NAME=="OpenLayers.Geometry.Polygon"||map.layers[a].features[0].geometry.CLASS_NAME=="OpenLayers.Geometry.MultiPolygon")
{
var c=map.layers[a].styleMap.styles.default.rules[tt].symbolizer.fillColor.split('rgb(')[1].split(')')[0].split(',');
var c2=map.layers[a].styleMap.styles.default.rules[tt].symbolizer.strokeColor.split('rgb(')[1].split(')')[0].split(',');
c2[0]=parseInt(c2[0]);c2[1]=parseInt(c2[1]);c2[2]=parseInt(c2[2]);
stcolor=Cesium.Color.fromBytes(c2[0],c2[1],c2[2],1);
}
else{var c=map.layers[a].styleMap.styles.default.rules[tt].symbolizer.strokeColor.split('rgb(')[1].split(')')[0].split(',');widthL=map.layers[a].styleMap.styles.default.rules[tt].symbolizer.strokeWidth;}
c[0]=parseInt(c[0]);c[1]=parseInt(c[1]);c[2]=parseInt(c[2]);

color=Cesium.Color.fromBytes(c[0],c[1],c[2],1);

}
}
}
//var color = Cesium.Color.fromRandom();

}
if (color=='')
{/*color = Cesium.Color.fromCssColorString('green');color.alpha=0;*/jsonDS.entities.remove(entity);ii=ii-1;}
else{
var opac=parseFloat(document.getElementById("dopOpac3djson"+"_"+map.layers[a].name).value)
color.alpha=opac;
objcoloren[ii+"_entityc"]=color.red+","+color.green+","+color.blue+","+color.alpha;

if(typeof entity.polyline!=='undefined')
{entity.polyline.material = new Cesium.ColorMaterialProperty(color);entity.polyline.width=new Cesium.ConstantProperty(parseFloat(widthL));objcolorenLine[ii+"_linePos"]={"points":'',"wid":widthL};}
else{entity.polygon.material = new Cesium.ColorMaterialProperty(color);stcolor.alpha=opac;entity.polygon.outlineColor=stcolor;objcoloren[ii+"_entitycst"]=stcolor.red+","+stcolor.green+","+stcolor.blue+","+stcolor.alpha;}
var multCoefHei=parseFloat(document.getElementById("dopHei3djson"+"_"+map.layers[a].name).value);
var coefAtrr=document.getElementById("3d_dop_select_id"+"_"+map.layers[a].name).value;
if(typeof entity.polyline=='undefined'&&coefAtrr!=="0")
{entity.polygon.extrudedHeight = new Cesium.ConstantProperty(parseFloat(entity.properties[coefAtrr])*multCoefHei);}
if(multCoefHei==0&&typeof entity.polyline=='undefined')
{entity.polygon.extrudedHeight=undefined}
var multCoefHei2=parseFloat(document.getElementById("dopHei3djson2"+"_"+map.layers[a].name).value);
var coefAtrr2=document.getElementById("3d_dop_select_id2"+"_"+map.layers[a].name).value;
if(typeof multCoefHei2!=='undefined'&&coefAtrr2!=="0")
{var arrPoint=[];if(typeof entity.polyline!=='undefined')
{var pl='';
if(map.layers[a].features[ii].geometry.CLASS_NAME=="OpenLayers.Geometry.LineString"){pl=map.layers[a].features[ii].geometry.components;}
if(map.layers[a].features[ii].geometry.CLASS_NAME=="OpenLayers.Geometry.MultiLineString"){pl=map.layers[a].features[ii].geometry.components[0].components;}
for (var thu=0;thu<pl.length;thu++)
{var p=pl[thu];

var br=new OpenLayers.Bounds(p.bounds.left, p.bounds.bottom,p.right,p.bounds.top);
var lonlat=br.transform(map.getProjectionObject(),new OpenLayers.Projection("EPSG:4326"));
var h=parseFloat(entity.properties[coefAtrr2])*multCoefHei2;
arrPoint.push(lonlat.left,lonlat.bottom,h)
}
entity.polyline.positions.setValue(Cesium.Cartesian3.fromDegreesArrayHeights(arrPoint));
objcolorenLine[ii+"_linePos"]={"points":arrPoint,"wid":widthL};
}

if(typeof entity.polygon!=='undefined')
{entity.polygon.height=new Cesium.ConstantProperty(parseFloat(entity.properties[coefAtrr2])*multCoefHei2);
if(typeof entity.polygon.extrudedHeight!=='undefined')
{entity.polygon.extrudedHeight=new Cesium.ConstantProperty(parseFloat(entity.properties[coefAtrr2])*multCoefHei2+parseFloat(entity.properties[coefAtrr])*multCoefHei);}}

}
} //end else color=='undefined'
}
globalwidg3dEntity[a+"layerent"]["3"]=objcoloren;globalwidg3dEntity[a+"layerent"]["4"]=objcolorenLine;
dis.update(widget.clock.currentTime);
});

}
if ((document.getElementById("id_3dJSON").checked!==true)||(document.getElementById("id_3dJSON").checked==true&&document.getElementById("valLeav"+"_"+map.layers[a].name).checked==true))
{
var can=map.layers[a].renderer.canvas.canvas;
var ctx = can.getContext("2d");

var imageWidth=can.width;
 var imageHeight=can.height;
var splitBw=imageWidth/30;
var splitBh=imageHeight/30;

 for(i=0;i<imageWidth;i+=splitBw){
      for(j=0;j<imageHeight;j+=splitBh){
            var ImageData = ctx.getImageData(i,j,splitBw,splitBh);     
var sndCanvas=document.createElement("canvas");
 sndCanvas.width=splitBw;
  sndCanvas.height=splitBh;
if(i==0&&j==0)
{var ext1 = new OpenLayers.Pixel(i+splitBw, j);
var ext2 = new OpenLayers.Pixel(i, j+splitBh);}//left,bottom}
else
{var ext1 = new OpenLayers.Pixel(i+splitBw, j);var ext2 = new OpenLayers.Pixel(i, j+splitBh);}
//rtt=ext2;alert("1");rtt=ext1;alert("2");
var lonlat1 = map.getLonLatFromPixel(ext1);
var lonlat2 = map.getLonLatFromPixel(ext2);
var boundImage=new OpenLayers.Bounds(lonlat2.lon, lonlat2.lat, lonlat1.lon, lonlat1.lat);
            var ctx2 = sndCanvas.getContext("2d");
            ctx2.putImageData(ImageData,0,0);
ImageData=sndCanvas.toDataURL();//rtt=ImageData;alert("stop");
boundImage.transform(map.getProjectionObject(),new OpenLayers.Projection("EPSG:4326"));
//rtt=boundImage;alert("stop2");
var prim0=new Cesium.RectanglePrimitive({
        rectangle : Cesium.Rectangle.fromDegrees(boundImage.left, boundImage.bottom,boundImage.right, boundImage.top),
   material : new Cesium.Material({
translucent:true,
        fabric : {  type : 'Image',  uniforms : {image : ImageData  }
        }     })
    })
  rectangle2 =primit.add(prim0);primit.raise(prim0);primitive3D.push(rectangle2);
           //tiles.push([ImageData,boundImage]);  
      }
    }
    }////canvas
}
}
}

var bound=map.calculateBounds();bound.transform(map.getProjectionObject(),new OpenLayers.Projection("EPSG:4326"));
  widget.scene.camera.viewRectangle(Cesium.Rectangle.fromDegrees(bound.left, bound.bottom, bound.right, bound.top));
  globalwidg3dowg=widget;
//var layers = widget.scene.imageryLayers;

}
function SelectBase3d(widget)
{var baseLayer3d='';
 var layerRemoved = widget.scene.imageryLayers.get(0);
layerRemoved.show=false;
 widget.scene.imageryLayers.remove(layerRemoved);
//rtt=layerRemoved; alert("55");
      //imageryLayerCollection.remove(layerRemoved);
if(document.getElementById("BaseLayer_id3d"). value=='Bing Maps Road')
{  baseLayer3d=new Cesium.BingMapsImageryProvider({
 url: 'http://dev.virtualearth.net',mapStyle: Cesium.BingMapsStyle.ROAD})}
if(document.getElementById("BaseLayer_id3d"). value=='OpenStreetMaps')
{ baseLayer3d=new Cesium.OpenStreetMapImageryProvider({url : 'http://a.tile.openstreetmap.org/'});}
if(document.getElementById("BaseLayer_id3d"). value=='MapQuest OpenStreetMaps')
{ baseLayer3d= new Cesium.OpenStreetMapImageryProvider({ url: 'http://otile1-s.mqcdn.com/tiles/1.0.0/osm/'})}
if(document.getElementById("BaseLayer_id3d"). value=='Stamen Maps')
{ baseLayer3d=new Cesium.OpenStreetMapImageryProvider({url: 'http://stamen-tiles.a.ssl.fastly.net/watercolor/',
                fileExtension: 'jpg',credit: 'Map tiles by Stamen Design, under CC BY 3.0. Data by OpenStreetMap, under CC BY SA.'})}
if(document.getElementById("BaseLayer_id3d"). value=='Natural Earth II (local)')
{ baseLayer3d= new Cesium.TileMapServiceImageryProvider({url : '3d/Source/Assets/Textures/NaturalEarthII'     })}
if(document.getElementById("BaseLayer_id3d"). value=='USGS Shaded Relief (via WMTS)')
{ baseLayer3d= new Cesium.WebMapTileServiceImageryProvider({ 
                url : 'http://basemap.nationalmap.gov/arcgis/rest/services/USGSShadedReliefOnly/MapServer/WMTS',
                layer : 'USGSShadedReliefOnly',style : 'default', format : 'image/jpeg',tileMatrixSetID : 'default028mm',
                maximumLevel: 19,credit : new Cesium.Credit('U. S. Geological Survey')
            })}
if(document.getElementById("BaseLayer_id3d"). value=='ArcGIS World Street Maps')
{ baseLayer3d= new Cesium.ArcGisMapServerImageryProvider({
                url : 'http://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer'
            })}
if(document.getElementById("BaseLayer_id3d"). value=='City Lights of the Earth')
{
baseLayer3d=new Cesium.TileMapServiceImageryProvider({
    url : 'http://cesiumjs.org/tilesets/imagery/blackmarble',
    maximumLevel :10,
    credit : 'Black Marble imagery courtesy NASA Earth Observatory'})}


if(document.getElementById("BaseLayer_id3d"). value=='Bing Maps Aerial')
{  baseLayer3d=new Cesium.BingMapsImageryProvider({
 url: 'http://dev.virtualearth.net',mapStyle: Cesium.BingMapsStyle.AERIAL})}


/*if (typeof imageryProvider === 'undefined') {
        layer = imageryLayers.get(0);
        viewModel.selectedLayer = layer;
    } else {
        layer = new Cesium.ImageryLayer(imageryProvider);
    }*/
widget.scene.imageryLayers.addImageryProvider(baseLayer3d,0);
}
function auto3drefreshf(widget)
{
if(document.getElementById("id_Auto3drefresh").checked==true)
{interva3dRefresh=setInterval( function()
{

Update3Dmap(widget)

},document.getElementById("id_Auto3drefreshm").value);}
else
{clearInterval(interva3dRefresh);}
}
function change2_5D(widget)
{

if(document.getElementById("id_change2_5D_a").innerHTML=="_2.5D")
{document.getElementById("id_change2_5D_a").innerHTML="_3D";widget.scene.morphToColumbusView(); 
  setTimeout(function(){var bound=map.calculateBounds();bound.transform(map.getProjectionObject(),new OpenLayers.Projection("EPSG:4326"));
widget.scene.camera.viewRectangle(Cesium.Rectangle.fromDegrees(bound.left, bound.bottom, bound.right, bound.top));
widget.scene.camera.direction=new Cesium.Cartesian3(0,0.7071067811865476,-0.7071067811865476); },3000);}

else{document.getElementById("id_change2_5D_a").innerHTML="_2.5D"; widget.scene.morphTo3D();

  setTimeout(function(){var bound=map.calculateBounds();bound.transform(map.getProjectionObject(),new OpenLayers.Projection("EPSG:4326"));
  widget.scene.camera.viewRectangle(Cesium.Rectangle.fromDegrees(bound.left, bound.bottom, bound.right, bound.top));},3000);
}
//widget.scene.SceneMode=Cesium.SceneMode.COLUMBUS_VIEW;
}
function onchangeid_3dJSON()
{
if(document.getElementById("id_3dJSON").checked==true)
{document.getElementById("dopdiv3djson").style.display="block"; 
for(var a=0;a<map.layers.length;a++)
{
if(map.layers[a].renderer&&map.layers[a].renderer.canvas&&map.layers[a].CLASS_NAME=="OpenLayers.Layer.Vector")
{//var dopDiv=document.createElement('div');dopDiv.id="dopdiv3djson";

if(map.layers[a].visibility==true&&map.layers[a].features[0])
{
var a_name=document.createElement('a');
a_name.innerHTML=map.layers[a].name;
var a_name1=document.createElement('a'); a_name1.innerHTML=':  высота(толщина):';var valHeight=document.createElement('input'); valHeight.size=3; 
valHeight.title="установить умножающий коэффициент  в метрах. Результирующая высота (толщина) объекта будет равна произведению величины выбранного атрибута на коэффициент"
valHeight.value=1000; valHeight.id="dopHei3djson"+"_"+map.layers[a].name;
var a_name2=document.createElement('a'); a_name2.innerHTML=';  атрибут:'; 
var d3_dop_select=document.createElement('select');d3_dop_select.id="3d_dop_select_id"+"_"+map.layers[a].name;
if(map.layers[a].features[0].geometry.CLASS_NAME=="OpenLayers.Geometry.Point")
{var a_name3=document.createElement('a'); a_name3.innerHTML=';  размер квадрата в град. :'; var valWidth=document.createElement('input');valWidth.title="Точки в 3D виде визуализируются как квадраты (параллелепипеды). Установите размер основания (квадрата) этого параллелепипеда в градусах"; valWidth.size=3; valWidth.value=0.1; valWidth.id="dopWid3djson"+"_"+map.layers[a].name;}


var br1= document.createElement('br');var br2= document.createElement('br');var br3= document.createElement('br');var br4= document.createElement('br');
document.getElementById("dopdiv3djson").appendChild(a_name);document.getElementById("dopdiv3djson").appendChild(a_name1); document.getElementById("dopdiv3djson").appendChild(valHeight);document.getElementById("dopdiv3djson").appendChild(a_name2);
document.getElementById("dopdiv3djson").appendChild(d3_dop_select);
var t=document.createElement('option');t.value="0";t.text=".";document.getElementById("3d_dop_select_id"+"_"+map.layers[a].name).appendChild(t);
for(h in map.layers[a].features[0].attributes)
{var t=document.createElement('option');t.value=h;t.text=h;document.getElementById("3d_dop_select_id"+"_"+map.layers[a].name).appendChild(t);}
if(map.layers[a].features[0].geometry.CLASS_NAME=="OpenLayers.Geometry.Point")
{var a_name3=document.createElement('a'); a_name3.innerHTML='; размер квадрата в град.:'; a_name3.title="размер квадрата в градусах";var valWidth=document.createElement('input'); valWidth.title="Точки в 3D виде визуализируются как квадраты (параллелепипеды). Установите размер основания (квадрата) этого параллелепипеда в градусах. Результирующий размер квадрата будет равен произведению установленного размера на радиус точки на 2D карте ";valWidth.size=3; valWidth.value=0.1; valWidth.id="dopWid3djson"+"_"+map.layers[a].name;document.getElementById("dopdiv3djson").appendChild(a_name3);document.getElementById("dopdiv3djson").appendChild(valWidth);}
var a_name4=document.createElement('a'); a_name4.innerHTML='; оставить исходный вид :'; var valLeav=document.createElement('input'); valLeav.type="checkbox"; valLeav.id="valLeav"+"_"+map.layers[a].name;document.getElementById("dopdiv3djson").appendChild(br2);document.getElementById("dopdiv3djson").appendChild(a_name4);document.getElementById("dopdiv3djson").appendChild(valLeav);
var a_name5=document.createElement('a'); a_name5.innerHTML='; прозрачность :'; a_name5.title="Прозрачность. Изменяется от 0 (полностью прозрачно) до 1.0 (непрозрачно) "; var valOpac=document.createElement('input');valOpac.size=2; valOpac.value=0.9; valOpac.id="dopOpac3djson"+"_"+map.layers[a].name;
document.getElementById("dopdiv3djson").appendChild(a_name5);document.getElementById("dopdiv3djson").appendChild(valOpac);
document.getElementById("dopdiv3djson").appendChild(br1);
var a_name6=document.createElement('a'); a_name6.innerHTML='; атрибут для альтитуды объекта:'; 
//The height, in meters, that the polygon is raised above the
var a_name7=document.createElement('a'); a_name7.innerHTML=';  умнож.коэфф.:';var valHeight2=document.createElement('input'); valHeight2.size=3; 
valHeight2.title="установить умножающий коэффициент  в метрах для установления высота(альтитуды) объекта над поверхностью земли. Результирующая высота (альтитуда) объекта над поверхностью земли будет равна произведению величины выбранного 'атрибут для альтитуды объекта' на коэффициент ."
valHeight2.value=1; valHeight2.id="dopHei3djson2"+"_"+map.layers[a].name;
var d3_dop_select2=document.createElement('select');d3_dop_select2.id="3d_dop_select_id2"+"_"+map.layers[a].name;

//document.getElementById("dopdiv3djson").appendChild(br3);
document.getElementById("dopdiv3djson").appendChild(a_name7);document.getElementById("dopdiv3djson").appendChild(valHeight2);document.getElementById("dopdiv3djson").appendChild(a_name6);
document.getElementById("dopdiv3djson").appendChild(d3_dop_select2);
document.getElementById("dopdiv3djson").appendChild(br3);
var t=document.createElement('option');t.value="0";t.text=".";document.getElementById("3d_dop_select_id2"+"_"+map.layers[a].name).appendChild(t);
for(h in map.layers[a].features[0].attributes)
{var t=document.createElement('option');t.value=h;t.text=h;document.getElementById("3d_dop_select_id2"+"_"+map.layers[a].name).appendChild(t);}
}
}

 }

}
else
{document.getElementById("dopdiv3djson").style.display="none";document.getElementById("dopdiv3djson").innerHTML='';}
}
function changeSky3d(widget)
{
var bbox = document.getElementById("map").getBoundingClientRect();
 var body = document.body
 var docElem = document.documentElement
 var scrollTop = window.pageYOffset || docElem.scrollTop || body.scrollTop
 var scrollLeft = window.pageXOffset || docElem.scrollLeft || body.scrollLeft
 var clientTop = docElem.clientTop || body.clientTop || 0
 var clientLeft = docElem.clientLeft || body.clientLeft || 0
 var topTop = bbox.top + scrollTop - clientTop
 var leftLeft = bbox.left + scrollLeft - clientLeft
var DivEditeLeg=document.createElement("div");
DivEditeLeg.id="id_div3dSky2";
DivEditeLeg.className="id_divRoutLegMain";
DivEditeLeg.style.position="relative";
DivEditeLeg.innerHTML='<div id="id_id_div3dSkyLeg" style="background:#ffffff; color:#0000ff;z-index: 6000;position:absolute;left:'+Math.round(leftLeft+350)+'px;top:'+Math.round(topTop-200)+
'px;overflow:hidden; border: 1px solid black;">'+
'<img onclick="close3dSkyWin()" src="openlayers/theme/default/img/close.gif" style="position:relative; top:0px;float:left; cursor:pointer"><a style="position:relative; top:20px"><a style="font-size: 9px;">Вы можете перемещать это окно если щёлкните по пункту меню: "Интерфейс->переключить режим интерфейса"</a><br>'+
'<br><a>Выберете файл изображения positiveX :</a>'+'<input title="Select image file" type="file" id="file_id3dImage1"><br>'+
'<a>Выберете файл изображения negativeX :</a>'+'<input title="Select image file" type="file" id="file_id3dImage2"><br>'+
'<a>Выберете файл изображения positiveY :</a>'+'<input title="Select image file" type="file" id="file_id3dImage3"><br>'+
'<a>Выберете файл изображения negativeY :</a>'+'<input title="Select image file" type="file" id="file_id3dImage4"><br>'+
'<a>Выберете файл изображения positiveZ :</a>'+'<input title="Select image file" type="file" id="file_id3dImage5"><br>'+
'<a>Выберете файл изображения negativeZ :</a>'+'<input title="Select image file" type="file" id="file_id3dImage6"><br>'+
'<input type="checkbox" id="Id_sky3d_sun"  onchange="" value="checkbox"/>turn off Sun<br>'+
'<input type="checkbox" id="Id_moon3d_sun"  onchange="" value="checkbox"/>turn off Moon<br>'+
'<input type="checkbox" id="Id_defa3d_sky"  onchange="" value="checkbox"/>set default sky<br>'+
'<input type="checkbox" id="Id_terr3d_opt"  onchange="" value="checkbox"/>turn on sun lighting and elevation<br>'+

'<p> <button type=button id= "buttonSky3d_id" onclick=OK_file3dImageSky()>OK</button></p>';
'</div>';
file3dSky[0]=widget.scene.skyBox.sources.positiveX ;file3dSky[1]=widget.scene.skyBox.sources.negativeX;file3dSky[2]=widget.scene.skyBox.sources.positiveY;file3dSky[3]=widget.scene.skyBox.sources.negativeY;
file3dSky[4]=widget.scene.skyBox.sources.positiveZ;file3dSky[5]=widget.scene.skyBox.sources.negativeZ;
           
if(!document.getElementById("id_div3dSky2"))
{body.appendChild(DivEditeLeg); 
document.getElementById("id_div3dSky2").onmousedown=function(event){drags(event)};
document.getElementById("id_div3dSky2").onmouseup=function(e){enddrag()};
}
document.getElementById('file_id3dImage1').addEventListener('change', read3dFileImage1, false);
document.getElementById('file_id3dImage2').addEventListener('change', read3dFileImage2, false);document.getElementById('file_id3dImage3').addEventListener('change', read3dFileImage3, false);
document.getElementById('file_id3dImage4').addEventListener('change', read3dFileImage4, false);document.getElementById('file_id3dImage5').addEventListener('change', read3dFileImage5, false);
document.getElementById('file_id3dImage6').addEventListener('change', read3dFileImage6, false);
document.getElementById('buttonSky3d_id').onclick=function(){OK_file3dImageSky(widget)}
}
function OK_file3dImageSky(widget)
{

//var img3d=document.createElement("img");
 //img3d.src=contents;
// arrImg.push(img3d)
//img3d.width=2048;
//img3d.height=2048;
if(document.getElementById("Id_defa3d_sky").checked==true)
{widget.scene.sun.show = true;widget.scene.moon.show = true;widget.scene.skyBox = new Cesium.SkyBox({
 sources : {
              positiveX : '3d/stars/TychoSkymapII.t3_08192x04096/TychoSkymapII.t3_08192x04096_80_px.jpg',
        negativeX : '3d/stars/TychoSkymapII.t3_08192x04096/TychoSkymapII.t3_08192x04096_80_mx.jpg',
        positiveY : '3d/stars/TychoSkymapII.t3_08192x04096/TychoSkymapII.t3_08192x04096_80_py.jpg',
         negativeY : '3d/stars/TychoSkymapII.t3_08192x04096/TychoSkymapII.t3_08192x04096_80_my.jpg',
       positiveZ : '3d/stars/TychoSkymapII.t3_08192x04096/TychoSkymapII.t3_08192x04096_80_pz.jpg',
         negativeZ : '3d/stars/TychoSkymapII.t3_08192x04096/TychoSkymapII.t3_08192x04096_80_mz.jpg'
        }
    });

file3dSky=[];alert("Wait...");return;}



if(typeof file3dSky[0]=='undefined'){file3dSky[0]=widget.scene.skyBox.sources.positiveX ;}if(typeof file3dSky[1]=='undefined'){file3dSky[1]=widget.scene.skyBox.sources.negativeX ;}
if(typeof file3dSky[2]=='undefined'){file3dSky[2]=widget.scene.skyBox.sources.positiveY ;}if(typeof file3dSky[3]=='undefined'){file3dSky[3]=widget.scene.skyBox.sources.negativeY ;}
if(typeof file3dSky[4]=='undefined'){file3dSky[4]=widget.scene.skyBox.sources.positiveZ ;}if(typeof file3dSky[5]=='undefined'){file3dSky[5]=widget.scene.skyBox.sources.negativeZ ;}
//rtt=file3dSky; alert("y");
widget.scene.skyBox = new Cesium.SkyBox({
 sources : {
             positiveX : file3dSky[0],
        negativeX : file3dSky[1],
        positiveY : file3dSky[2],
         negativeY : file3dSky[3],
       positiveZ : file3dSky[4],
         negativeZ : file3dSky[5]
        }
    });
if(document.getElementById('Id_sky3d_sun').checked==true)
{widget.scene.sun.show = false;}else{widget.scene.sun.show = true;}
if(document.getElementById('Id_moon3d_sun').checked==true)
{widget.scene.moon.show = false;}else{widget.scene.moon.show = true;}
if(document.getElementById("Id_defa3d_sky").checked==true)
{}
if(document.getElementById("Id_terr3d_opt").checked==true)
{widget.scene.globe.terrainProvider=new Cesium.CesiumTerrainProvider({
        url : '//assets.agi.com/stk-terrain/world',  credit : 'Terrain data courtesy Analytical Graphics, Inc.'    })}
else
{widget.scene.globe.terrainProvider=new Cesium.EllipsoidTerrainProvider();}
file3dSky=[];
//close3dSkyWin();
//widget.scene.render();
//rtt=widget; 
alert("Wait...");
 

}
function load3dSkyImage(file,n,tdiv)
{var contents;
if (file){
var r = new FileReader();
 r.onload = function(e) { 
contents = e.target.result;

var img = new Image(); img.src=contents;
img.onload=function(n,tdiv){return function(){
tdiv.width=1024;tdiv.height=1024;var ctx00 = tdiv.getContext("2d");ctx00.drawImage(img, 0, 0,1024,1024);
try{var contents2=tdiv.toDataURL();}
catch (e) {alert(e+"Please reload image");}
file3dSky[n]=contents2; ctx00='';tdiv='';
//rtt=file3dSky;alert("loaded");
}}(n,tdiv)
 }
 r.readAsDataURL(file);
 }
else { 
 alert("Ошибка загрузки файла");
 }
}
function read3dFileImage1(evt){var n=0;var tdiv=document.createElement('canvas');load3dSkyImage(evt.target.files[0],n,tdiv); }
function read3dFileImage2(evt){var n=1;var tdiv=document.createElement('canvas');load3dSkyImage(evt.target.files[0],n,tdiv); }
function read3dFileImage3(evt){var n=2;var tdiv=document.createElement('canvas');load3dSkyImage(evt.target.files[0],n,tdiv); }
function read3dFileImage4(evt){var n=3;var tdiv=document.createElement('canvas');load3dSkyImage(evt.target.files[0],n,tdiv); }
function read3dFileImage5(evt){var n=4;var tdiv=document.createElement('canvas');load3dSkyImage(evt.target.files[0],n,tdiv); }
function read3dFileImage6(evt){var n=5;var tdiv=document.createElement('canvas');load3dSkyImage(evt.target.files[0],n,tdiv); }

function loadProj3dMap(str3dowg,str3dowgEnt,pos3dWMS)
{var pos3d=str3dowg.split(" map3dOWGss ")[1].split(" map3dOWGes ")[0];
if(pos3dWMS!=="0"&&pos3dWMS!==""){pos3dWMS=JSON.parse(pos3dWMS);}
var obj3dl=JSON.parse(str3dowg.split(" map3dOWGss ")[0]);
var pos3d=pos3d.split(";");
var DivEditeLeg=document.createElement("div"); var body = document.body;
DivEditeLeg.id="id_div3dMapMain2";
DivEditeLeg.className="id_divRoutLegMain";
DivEditeLeg.style.position="relative";
DivEditeLeg.innerHTML='<div id="id_id_div3dMapTwoLeg" style="background:#ffffff; color:#0000ff;z-index: 6000;position:absolute;left:'+pos3d[2]+';top:'+pos3d[3]+
'px;overflow:hidden; border: 1px solid black;">'+
'<img onclick="close3dMapWin()" src="openlayers/theme/default/img/close.gif" style="position:relative; top:0px;float:left; cursor:pointer"><a style="position:relative; top:20px"><a style="font-size: 9px;"> Вы можете перемещать это окно если щёлкните по пункту меню: Интерфейс->переключить режим интерфейса</a><br>'+
'<button id="id_buttonUpdate3dmap" type=button onclick=Update3Dmap()>Update</button>'+
 '<a>базовый слой:</a><select id="BaseLayer_id3d" onchange="SelectBase3d(value)" style="background:#f5f7fa;border: 1px solid black" style="font-size: 11px;">'+
'<option value="0">.</option>'+
 '<option value="Bing Maps Aerial">Bing Maps Aerial</option>'+
'<option value="Bing Maps Road">Bing Maps Road</option>'+
'<option value="ArcGIS World Street Maps">ArcGIS World Street Maps</option>'+
'<option value="OpenStreetMaps">OpenStreetMaps</option>'+
'<option value="MapQuest OpenStreetMaps">MapQuest OpenStreetMaps</option>'+
'<option value="Stamen Maps">Stamen Maps</option>'+
'<option value="Natural Earth II (local)">Natural Earth II (local)</option>'+
'<option value="USGS Shaded Relief (via WMTS)">USGS Shaded Relief (via WMTS)</option>'+
'<option value="City Lights of the Earth">City Lights of the Earth</option>'+
 '</select>'+
 '<input type="checkbox" id="id_Auto3drefresh" title="установить интервал обновления в миллисекундах" value="checkbox" onchange="auto3drefreshf()"/>обновлять '+
 '<input type="text" size="2" id="id_Auto3drefreshm" title="миллисекунды" value="3000"/>ms '+
 '<div id="id_change2_5D" title="Сменить вид: 3D или 2.5D. Вид 2.5D(Columbus View mode) -вид при котором карта плоская а объекты высота которых ненулевая рисуются поверх её" style="float: left; cursor:pointer;border: 1px solid black;"> <a id="id_change2_5D_a">_2.5D</a></div><div id="changeSky3d" title="Выберете изображения(картинки)для каждой из шести сторон куба в который вписан Глобус Земли. Поменяйте фон вокруг глобуса. A sky box around the Globe to draw stars or other objects. The sky box is defined using the True Equator Mean Equinox (TEME) axes.This is only supported in 3D. The sky box is faded out when morphing to 2D or Columbus view.  " style="float: left; cursor:pointer;border: 1px solid black;">_изменить небо</div>'+
'<div><input type="checkbox" id="id_3dJSON" title="additional options for 3d (add height)" value="checkbox" />options</div>'+
'<div id="dopdiv3djson" style="display:none"></div>'+
'</div>';

if(!document.getElementById("id_div3dMapMain2"))
{body.appendChild(DivEditeLeg); 
var cesiumContainer=document.createElement("div");
cesiumContainer.id=map.layerContainerDiv.id+"3d";cesiumContainer.style.position="absolute";cesiumContainer.style.width="100%";cesiumContainer.style.height="100%";
cesiumContainer.style.left=pos3d[2];cesiumContainer.style.top=pos3d[3];




if(document.getElementById("id_div3dMapMain0")){close3dFirstWin()} 
document.getElementById("id_3dJSON").onchange=function (){onchangeid_3dJSON();}
document.getElementById("id_div3dMapMain2").onmousedown=function(event){drags(event)};
document.getElementById("id_div3dMapMain2").onmouseup=function(e){enddrag()};

cesiumContainer.style.zIndex = 3000;
document.getElementById("id_div3dMapMain2").appendChild(cesiumContainer);


var widget = new Cesium.CesiumWidget(cesiumContainer, {
    imageryProvider : new Cesium.OpenStreetMapImageryProvider({url : 'http://a.tile.openstreetmap.org/'}),
    /*terrainProvider : new Cesium.CesiumTerrainProvider({
        url : '//assets.agi.com/stk-terrain/world',  credit : 'Terrain data courtesy Analytical Graphics, Inc.'    }),*/
    // Use high-res stars downloaded from https://github.com/AnalyticalGraphicsInc/cesium-assets
    skyBox : new Cesium.SkyBox({
        sources : {
         positiveX : '3d/stars/TychoSkymapII.t3_08192x04096/TychoSkymapII.t3_08192x04096_80_px.jpg',
        negativeX : '3d/stars/TychoSkymapII.t3_08192x04096/TychoSkymapII.t3_08192x04096_80_mx.jpg',
        positiveY : '3d/stars/TychoSkymapII.t3_08192x04096/TychoSkymapII.t3_08192x04096_80_py.jpg',
         negativeY : '3d/stars/TychoSkymapII.t3_08192x04096/TychoSkymapII.t3_08192x04096_80_my.jpg',
       positiveZ : '3d/stars/TychoSkymapII.t3_08192x04096/TychoSkymapII.t3_08192x04096_80_pz.jpg',
         negativeZ : '3d/stars/TychoSkymapII.t3_08192x04096/TychoSkymapII.t3_08192x04096_80_mz.jpg'
         }
    }),
    // Show Columbus View map with Web Mercator projection
   //sceneMode : Cesium.SceneMode.SCENE2D,
 mapProjection : new Cesium.WebMercatorProjection(),
  mode : Cesium.SceneMode.SCENE3D,
  moon:new Cesium.Moon({onlySunLighting :false,textureUrl:'3d/Build/Apps/CesiumViewerAssets/Textures/moonSmall.jpg'}),
  //mapProjection : new Cesium.GeographicProjection()
});globalwidg3dEntity
 globalwidg3dowg=widget;globalwidg3dEntity={};globalwidg3dWMS={};
var primit=widget.scene.primitives;
primitive3D=[]; wmsArray3d=[]; var img1=[];var img2=[];
document.getElementById("BaseLayer_id3d").onchange=function(){SelectBase3d(widget)}
document.getElementById("id_Auto3drefresh").onchange=function(){auto3drefreshf(widget)}
document.getElementById("id_change2_5D").onclick=function(){change2_5D(widget);}
document.getElementById("changeSky3d").onclick=function(){changeSky3d(widget);}
//var primit = new Cesium.PrimitiveCollection();
var dataSource = new Cesium.GeoJsonDataSource();
var ds=new Cesium.DataSourceCollection()
var dis=new Cesium.DataSourceDisplay({scene:widget.scene,dataSourceCollection:ds})
CesiumDisplay=dis;
var layerswms = widget.scene.imageryLayers;
if(pos3dWMS!=="0"&&pos3dWMS!=="")
{
for (th in pos3dWMS)
{
var wms3dsav =layerswms.addImageryProvider(
 new Cesium.WebMapServiceImageryProvider({
url : pos3dWMS[th]["1"],layers : pos3dWMS[th]["3"],
parameters : pos3dWMS[th]["2"]      }));
wms3dsav.alpha =pos3dWMS[th]["4"];
globalwidg3dWMS[th]={"1":pos3dWMS[th]["1"],"2":pos3dWMS[th]["2"],"3":pos3dWMS[th]["3"]}
globalwidg3dWMS[th]["4"]=pos3dWMS[th]["4"];
wmsArray3d.push(wms3dsav);
} }
for (h in obj3dl)
{obj3dl[h]["5"]=obj3dl[h]["5"].replace(/\s/g,"+");
var prim0=new Cesium.RectanglePrimitive({
        rectangle : Cesium.Rectangle.fromDegrees(obj3dl[h]["1"], obj3dl[h]["2"],obj3dl[h]["3"], obj3dl[h]["4"]),
   material : new Cesium.Material({
translucent:true,
        fabric : {  type : 'Image',  uniforms : {image : obj3dl[h]["5"]  }
        }     })
    })
primit.add(prim0);primit.raise(prim0);
primitive3D.push(primit);
}

if(str3dowgEnt!==''&&str3dowgEnt!=='0')
{var obj3dEnt=JSON.parse(str3dowgEnt);

var format = new OpenLayers.Format.GeoJSON({ 'internalProjection': new OpenLayers.Projection("EPSG:900913"),'externalProjection': new OpenLayers.Projection("EPSG:4326")});


for (h in obj3dEnt)
{var jsonstring=obj3dEnt[h]["1"];rtt=obj3dEnt[h]; 
var jsonDS=new Cesium.GeoJsonDataSource();
ds.add(jsonDS); 
 jsonstring=JSON.parse(jsonstring);
jsonDS.load(jsonstring).then(function(h) {
var coefffs=obj3dEnt[h]["2"].split(",");var objcoloren={}; objcolorenLine={};
var multCoefHei=parseFloat(coefffs[0]); var coefAtrr=coefffs[1];var multCoefHei2=parseFloat(coefffs[2]);var coefAtrr2=coefffs[3];
var strcoefsve=multCoefHei+","+coefAtrr+","+multCoefHei2+","+coefAtrr2;
globalwidg3dEntity[h]={"1":JSON.stringify(jsonstring),"2":strcoefsve};

var entities = jsonDS.entities.values;rtt=jsonDS; var pointyes=false;var pointsiz=100;var widthL=2;

for (var ii = 0; ii < entities.length; ii++) 
{var color=''; stcolor='';
var entity = entities[ii];rtt=obj3dEnt[h];
var coent=obj3dEnt[h]["3"][ii+"_entityc"].split(","); 
color=new Cesium.Color(parseFloat(coent[0]),parseFloat(coent[1]),parseFloat(coent[2]),parseFloat(coent[3]));

objcoloren[ii+"_entityc"]=color.red+","+color.green+","+color.blue+","+color.alpha;

if(typeof entity.polyline!=='undefined')
{widthL=parseFloat(obj3dEnt[h]["4"][ii+"_linePos"]["wid"]);entity.polyline.material = new Cesium.ColorMaterialProperty(color);entity.polyline.width=new Cesium.ConstantProperty(parseFloat(widthL));objcolorenLine[ii+"_linePos"]={"points":'',"wid":widthL};}
else{entity.polygon.material = new Cesium.ColorMaterialProperty(color);
var coentst=obj3dEnt[h]["3"][ii+"_entitycst"].split(","); stcolor=new Cesium.Color(parseFloat(coentst[0]),parseFloat(coentst[1]),parseFloat(coentst[2]),parseFloat(coentst[3]));entity.polygon.outlineColor=stcolor;objcoloren[ii+"_entitycst"]=stcolor.red+","+stcolor.green+","+stcolor.blue+","+stcolor.alpha;}
if(typeof entity.polyline=='undefined'&&coefAtrr!=="0")
{rtt=parseFloat(entity.properties[coefAtrr]);entity.polygon.extrudedHeight = new Cesium.ConstantProperty(parseFloat(entity.properties[coefAtrr])*multCoefHei);}
if(multCoefHei==0&&typeof entity.polyline=='undefined')
{entity.polygon.extrudedHeight=undefined}
if(typeof multCoefHei2!=='undefined'&&coefAtrr2!=="0")
{var arrPoint=[];if(typeof entity.polyline!=='undefined')
{
arrPoint=obj3dEnt[h]["4"][ii+"_linePos"]["points"];for(var pcl=0;pcl<arrPoint.length;pcl++){arrPoint[pcl]=parseFloat(arrPoint[pcl])}
entity.polyline.positions.setValue(Cesium.Cartesian3.fromDegreesArrayHeights(arrPoint));
objcolorenLine[ii+"_linePos"]={"points":arrPoint,"wid":widthL};
}

if(typeof entity.polygon!=='undefined')
{entity.polygon.height=new Cesium.ConstantProperty(parseFloat(entity.properties[coefAtrr2])*multCoefHei2);
if(typeof entity.polygon.extrudedHeight!=='undefined')
{entity.polygon.extrudedHeight=new Cesium.ConstantProperty(parseFloat(entity.properties[coefAtrr2])*multCoefHei2+parseFloat(entity.properties[coefAtrr])*multCoefHei);}}

}

}
globalwidg3dEntity[h]["3"]=objcoloren;globalwidg3dEntity[h]["4"]=objcolorenLine;
dis.update(widget.clock.currentTime);
}(h));
}

}
document.getElementById("id_buttonUpdate3dmap").onclick=function(){Update3Dmap(widget)}
cesiumContainer.childNodes[0].style.border="1px solid black";
cesiumContainer.childNodes[0].style.width=pos3d[0];cesiumContainer.childNodes[0].style.height=pos3d[1];
cesiumContainer.childNodes[0].childNodes[0].style.width=pos3d[0];cesiumContainer.childNodes[0].childNodes[0].style.height=pos3d[1];
cesiumContainer.childNodes[0].childNodes[0].clientWidth=pos3d[0];cesiumContainer.childNodes[0].childNodes[0].clientHeight=pos3d[1];
widget.scene.camera.position=new Cesium.Cartesian3(parseFloat(pos3d[5]),parseFloat(pos3d[6]),parseFloat(pos3d[7]));
widget.scene.camera.direction=new Cesium.Cartesian3(parseFloat(pos3d[8]),parseFloat(pos3d[9]),parseFloat(pos3d[10]));
widget.scene.camera.right=new Cesium.Cartesian3(parseFloat(pos3d[11]),parseFloat(pos3d[12]),parseFloat(pos3d[13]));
widget.scene.camera.up=new Cesium.Cartesian3(parseFloat(pos3d[14]),parseFloat(pos3d[15]),parseFloat(pos3d[16]));
if(pos3d[17]!==""){document.getElementById("id_div3dMapMain2").style.left=pos3d[17];document.getElementById("id_div3dMapMain2").style.top=pos3d[18];}
if(pos3d[4]!=="0"){document.getElementById("BaseLayer_id3d"). value=pos3d[4];SelectBase3d(widget)}
}
}

function Open3Dmap()
{
var bbox = document.getElementById("map").getBoundingClientRect();
 var body = document.body
 var docElem = document.documentElement
 var scrollTop = window.pageYOffset || docElem.scrollTop || body.scrollTop
 var scrollLeft = window.pageXOffset || docElem.scrollLeft || body.scrollLeft
 var clientTop = docElem.clientTop || body.clientTop || 0
 var clientLeft = docElem.clientLeft || body.clientLeft || 0
 var topTop = bbox.top + scrollTop - clientTop
 var leftLeft = bbox.left + scrollLeft - clientLeft
var DivEditeLeg=document.createElement("div");
DivEditeLeg.id="id_div3dMapMain2";
DivEditeLeg.className="id_divRoutLegMain";
DivEditeLeg.style.position="relative";
DivEditeLeg.innerHTML='<div id="id_id_div3dMapTwoLeg" style="background:#ffffff; color:#0000ff;z-index: 6000;position:absolute;left:'+Math.round(leftLeft+450)+'px;top:'+Math.round(topTop-200)+
'px;overflow:hidden; border: 1px solid black;">'+
'<img onclick="close3dMapWin()" src="openlayers/theme/default/img/close.gif" style="position:relative; top:0px;float:left; cursor:pointer"><a style="position:relative; top:20px"><a style="font-size: 9px;"> Вы можете перемещать это окно если щёлкните по пункту меню: Интерфейс->переключить режим интерфейса</a><br>'+
'<button id="id_buttonUpdate3dmap" type=button onclick=Update3Dmap()>Update</button>'+
 '<a>базовый слой:</a><select id="BaseLayer_id3d" onchange="SelectBase3d(value)" style="background:#f5f7fa;border: 1px solid black" style="font-size: 11px;">'+
'<option value="0">.</option>'+
 '<option value="Bing Maps Aerial">Bing Maps Aerial</option>'+
'<option value="Bing Maps Road">Bing Maps Road</option>'+
'<option value="ArcGIS World Street Maps">ArcGIS World Street Maps</option>'+
'<option value="OpenStreetMaps">OpenStreetMaps</option>'+
'<option value="MapQuest OpenStreetMaps">MapQuest OpenStreetMaps</option>'+
'<option value="Stamen Maps">Stamen Maps</option>'+
'<option value="Natural Earth II (local)">Natural Earth II (local)</option>'+
'<option value="USGS Shaded Relief (via WMTS)">USGS Shaded Relief (via WMTS)</option>'+
'<option value="City Lights of the Earth">City Lights of the Earth</option>'+
 '</select>'+
 '<input type="checkbox" id="id_Auto3drefresh" title="установить интервал обновления в миллисекундах" value="checkbox" onchange="auto3drefreshf()"/>обновлять '+
 '<input type="text" size="2" id="id_Auto3drefreshm" title="миллисекунды" value="3000"/>ms '+
 '<div id="id_change2_5D" title="Сменить вид: 3D или 2.5D. Вид 2.5D(Columbus View mode) -вид при котором карта плоская а объекты высота которых ненулевая рисуются поверх её" style="float: left; cursor:pointer;border: 1px solid black;"> <a id="id_change2_5D_a">_2.5D</a></div><div id="changeSky3d" title="Выберете изображения(картинки)для каждой из шести сторон куба в который вписан Глобус Земли. Поменяйте фон вокруг глобуса. A sky box around the Globe to draw stars or other objects. The sky box is defined using the True Equator Mean Equinox (TEME) axes.This is only supported in 3D. The sky box is faded out when morphing to 2D or Columbus view.  " style="float: left; cursor:pointer;border: 1px solid black;">_изменить небо</div>'+
'<div><input type="checkbox" id="id_3dJSON" title="additional options for 3d (add height)" value="checkbox" />options</div>'+
'<div id="dopdiv3djson" style="display:none"></div>'+
'</div>';

if(!document.getElementById("id_div3dMapMain2"))
{body.appendChild(DivEditeLeg); 
var cesiumContainer=document.createElement("div");
cesiumContainer.id=map.layerContainerDiv.id+"3d";cesiumContainer.style.position="absolute";cesiumContainer.style.width="100%";cesiumContainer.style.height="100%";
cesiumContainer.style.left=Math.round(leftLeft+450)+"px";cesiumContainer.style.top=Math.round(topTop-200)+"px";
cesiumContainer.style.height="100%";
cesiumContainer.style.zIndex = 3000;
document.getElementById("id_div3dMapMain2").appendChild(cesiumContainer);

var widget = new Cesium.CesiumWidget(cesiumContainer, {
    imageryProvider : new Cesium.OpenStreetMapImageryProvider({url : 'http://a.tile.openstreetmap.org/'}),
    /*terrainProvider : new Cesium.CesiumTerrainProvider({
        url : '//assets.agi.com/stk-terrain/world',  credit : 'Terrain data courtesy Analytical Graphics, Inc.'    }),*/
    // Use high-res stars downloaded from https://github.com/AnalyticalGraphicsInc/cesium-assets
    skyBox : new Cesium.SkyBox({
        sources : {
         positiveX : '3d/stars/TychoSkymapII.t3_08192x04096/TychoSkymapII.t3_08192x04096_80_px.jpg',
        negativeX : '3d/stars/TychoSkymapII.t3_08192x04096/TychoSkymapII.t3_08192x04096_80_mx.jpg',
        positiveY : '3d/stars/TychoSkymapII.t3_08192x04096/TychoSkymapII.t3_08192x04096_80_py.jpg',
         negativeY : '3d/stars/TychoSkymapII.t3_08192x04096/TychoSkymapII.t3_08192x04096_80_my.jpg',
       positiveZ : '3d/stars/TychoSkymapII.t3_08192x04096/TychoSkymapII.t3_08192x04096_80_pz.jpg',
         negativeZ : '3d/stars/TychoSkymapII.t3_08192x04096/TychoSkymapII.t3_08192x04096_80_mz.jpg'
         }
    }),
    // Show Columbus View map with Web Mercator projection
   //sceneMode : Cesium.SceneMode.SCENE2D,
 mapProjection : new Cesium.WebMercatorProjection(),
  mode : Cesium.SceneMode.SCENE3D,
  moon:new Cesium.Moon({onlySunLighting :false,textureUrl:'3d/Build/Apps/CesiumViewerAssets/Textures/moonSmall.jpg'}),
  //mapProjection : new Cesium.GeographicProjection()
});
 globalwidg3dowg=widget;
var primit=widget.scene.primitives;
primitive3D=[]; wmsArray3d=[]; var img1=[];var img2=[];
document.getElementById("BaseLayer_id3d").onchange=function(){SelectBase3d(widget)}
document.getElementById("id_Auto3drefresh").onchange=function(){auto3drefreshf(widget)}
document.getElementById("id_change2_5D").onclick=function(){change2_5D(widget);}
document.getElementById("changeSky3d").onclick=function(){changeSky3d(widget);}
//var primit = new Cesium.PrimitiveCollection();
var dataSource = new Cesium.GeoJsonDataSource();
var ds=new Cesium.DataSourceCollection()
var dis=new Cesium.DataSourceDisplay({scene:widget.scene,dataSourceCollection:ds})
CesiumDisplay=dis;globalwidg3dEntity={};globalwidg3dWMS={}
for(var a=0;a<map.layers.length;a++)
{
var layers = widget.scene.imageryLayers;
 if(map.layers[a].visibility==true&&(map.layers[a].CLASS_NAME=="OpenLayers.Layer.WMS"||map.layers[a].CLASS_NAME=="OpenLayers.Layer.XYZ"))
 {
 var wmsurl='';var sldbody='';
 for(var y=0; y<map.layers[a].grid.length;y++)
 {// '//mesonet.agron.iastate.edu/cgi-bin/wms/nexrad/n0r.cgi?'
 'name:wmsurl.split("LAYERS=")[1].split('&')';
 for(var yj=0; yj<map.layers[a].grid[y].length;yj++)
 { if(map.layers[a].grid[y][yj].url!==null){wmsurl=map.layers[a].grid[y][yj].url;}}}
if(wmsurl.split('http://')[1])
{var wmsurl2='//'+wmsurl.split('http://')[1].split('?')[0]}
else
{var wmsurl2=wmsurl.split('?')[0];}
if(wmsurl.split('SLD_BODY=')[1]){if(wmsurl.split('SLD_BODY=')[1].split('STYLES=')[1]){ sldbody=wmsurl.split('SLD_BODY=')[1].split('STYLES=')[1];}}
if(wmsurl.split('http://')[1]){
 var wms3d = layers.addImageryProvider(
 new Cesium.WebMapServiceImageryProvider({
url : wmsurl2,
layers : map.layers[a].params.LAYERS,
parameters : {transparent : 'true',format : map.layers[a].params.FORMAT }//,
               //proxy : new Cesium.DefaultProxy(wmsstr)
            }));
            globalwidg3dWMS[a+"_layerwms"]={"1":wmsurl2,"2":JSON.stringify({transparent : 'true',format : map.layers[a].params.FORMAT }),"3":map.layers[a].params.LAYERS}
            }
else{
if(sldbody==''){var param={transparent : 'true',format : map.layers[a].params.FORMAT}}
else{var param={transparent : 'true',format : map.layers[a].params.FORMAT, sld_body:sldbody }}
 var wms3d = layers.addImageryProvider(
 new Cesium.WebMapServiceImageryProvider({
url : wmsurl2,
layers : map.layers[a].params.LAYERS,
parameters : param//,
               //proxy : new Cesium.DefaultProxy(wmsstr)
            }));

 globalwidg3dWMS[a+"_layerwms"]={"1":wmsurl2,"2":param,"3":map.layers[a].params.LAYERS}
}
wms3d.alpha = parseFloat(map.layers[a].opacity);
globalwidg3dWMS[a+"_layerwms"]["4"]=parseFloat(map.layers[a].opacity);
wmsArray3d.push(wms3d);
 }
 


 if((map.layers[a].CLASS_NAME=="OpenLayers.Layer.Image"&&map.layers[a].visibility==true)||(map.layers[a].featuresH&&map.layers[a].visibility==true)||(map.layers[a].featuresIn&&map.layers[a].visibility==true))
{var img = new Image(); 
if(map.layers[a].featuresH||map.layers[a].featuresIn)
{img.src=map.layers[a].div.childNodes[0].toDataURL("image/png");}
else{img.src=map.layers[a].url;}
img.id="3dim_id";
img1.push(img);
var imageWidth=map.size.w;
 var imageHeight=map.size.h;
var splitBw=imageWidth/30;
var splitBh=imageHeight/30;
if(primit.length!==0){var indexn=primit.length-1} else{var indexn=0};index=[]
for(i=0;i<imageWidth;i+=splitBw){
      for(j=0;j<imageHeight;j+=splitBh){if(primit.length!==0){indexn++;index.push(indexn)}else{index.push(indexn);}
     rectangle2=primit.add(new Cesium.RectanglePrimitive({}))
     primitive3D.push(rectangle2);
      
      }
            }
            
var is1=img1[img1.length-1];
img1[img1.length-1].onload=function(a,is1,index)
{
return function()
{

var can00=document.createElement("canvas");
if(map.layers[a].featuresH||map.layers[a].featuresIn)
{
var posx=map.layers[a].div.style.left.split('px')[0];
var posy=map.layers[a].div.style.top.split('px')[0];
var sizw=map.layers[a].div.childNodes[0].width;
var sizh=map.layers[a].div.childNodes[0].height;
}
else
{
var posx=map.layers[a].tile.position.x;
var posy=map.layers[a].tile.position.y;
var sizw=map.layers[a].tile.size.w;
var sizh=map.layers[a].tile.size.h;
}
can00.width=is1.width;
can00.height=is1.height;
var ctx00 = can00.getContext("2d");
var alphaImg=parseFloat(1);if(map.layers[a].opacity===null) {alphaImg=parseFloat(1);}else{alphaImg=parseFloat(map.layers[a].opacity);}
ctx00.globalAlpha = alphaImg;
ctx00.drawImage(is1, 0, 0);
var ImageData0=can00.toDataURL();
var img22= new Image(); img22.src=ImageData0;
img2.push(img22)
//var ctx0 = can0.getContext("2d");
var ElemDivImg=map.layers[a].div.childNodes[0];
var bbox1=ElemDivImg.getBoundingClientRect();
var bbox = document.getElementById("map").getBoundingClientRect();
var topTop = bbox1.top-bbox.top;
 var leftLeft = bbox1.left-bbox.left;posx=leftLeft;posy=topTop;
//rtt=topTop;alert("1");rtt=leftLeft;alert("2");

var is2=img2[img2.length-1];
img2[img2.length-1].onload = function(a,is2,index){return function(){
var can0=document.createElement("canvas");
can0.width=map.size.w;
  can0.height=map.size.h;var sx=0;var sy=0;var dsx=0;var dsy=0;
var ctx0 = can0.getContext("2d");

dsx=is2.width;dsy=is2.height;
if(sizw>map.size.w){ sx=0;}
if(sizh>map.size.h){ sy=0;}

//ctx0.drawImage(img, sx,sy,dsx,dsy,posx, posy,sizw,sizh);
ctx0.drawImage(is2, posx, posy,sizw,sizh);

var imageWidth=can0.width;
 var imageHeight=can0.height;
var splitBw=imageWidth/30;
var splitBh=imageHeight/30;
var ind2=0;
for(i=0;i<imageWidth;i+=splitBw){
      for(j=0;j<imageHeight;j+=splitBh){
            var ImageData = ctx0.getImageData(i,j,splitBw,splitBh);     
var sndCanvas=document.createElement("canvas");
 sndCanvas.width=splitBw;  sndCanvas.height=splitBh;
if(i==0&&j==0)
{var ext1 = new OpenLayers.Pixel(i+splitBw, j);
var ext2 = new OpenLayers.Pixel(i, j+splitBh);}//left,bottom}
else
{var ext1 = new OpenLayers.Pixel(i+splitBw, j);var ext2 = new OpenLayers.Pixel(i, j+splitBh);}
//rtt=ext2;alert("1");rtt=ext1;alert("2");
var lonlat1 = map.getLonLatFromPixel(ext1);var lonlat2 = map.getLonLatFromPixel(ext2);
var boundImage=new OpenLayers.Bounds(lonlat2.lon, lonlat2.lat, lonlat1.lon, lonlat1.lat);
            var ctx2 = sndCanvas.getContext("2d");            ctx2.putImageData(ImageData,0,0);
ImageData=sndCanvas.toDataURL();boundImage.transform(map.getProjectionObject(),new OpenLayers.Projection("EPSG:4326"));
 //var alphaImg=parseFloat(0.999);if(map.layers[a].opacity===null) {alphaImg=parseFloat(0.999);;}else{alphaImg=parseFloat(map.layers[a].opacity);}
//alert(alphaImg);
var pr=primit.get(index[ind2]);ind2++;
pr.rectangle=Cesium.Rectangle.fromDegrees(boundImage.left, boundImage.bottom,boundImage.right, boundImage.top);
pr.material=new Cesium.Material({translucent:true,        fabric : {type : 'Image', uniforms : {image : ImageData }         }     })
          }
    }
}}(a,is2,index);
}}(a,is1,index);
}


if(map.layers[a].renderer&&map.layers[a].renderer.canvas&&map.layers[a].CLASS_NAME=="OpenLayers.Layer.Vector")
{if(map.layers[a].visibility==true&&map.layers[a].features[0])
{//var strDataURI = map.layers[i].renderer.canvas.canvas.toDataURL();
if (document.getElementById("id_3dJSON").checked==true)
{

var format = new OpenLayers.Format.GeoJSON({ 'internalProjection': new OpenLayers.Projection("EPSG:900913"),'externalProjection': new OpenLayers.Projection("EPSG:4326")});
//rtt=
var jsonstring=''
if(map.layers[a].features)
{
jsonstring = format.write(map.layers[a].features);
}
 Cesium.Math.setRandomNumberSeed(0);
 var jsonDS=new Cesium.GeoJsonDataSource();
ds.add(jsonDS); 
//widget.scene.dataSources
if(map.layers[a].features[0].geometry.CLASS_NAME=="OpenLayers.Geometry.Point")
{
var ArrayFeat=jsonstring.split('{"type":"Feature"');
for (var v=0;v<map.layers[a].features.length;v++)
{ var br=new OpenLayers.Bounds(map.layers[a].features[v].geometry.bounds.left, map.layers[a].features[v].geometry.bounds.bottom,map.layers[a].features[v].geometry.bounds.right,map.layers[a].features[v].geometry.bounds.top);
var lonlat=br.transform(map.getProjectionObject(),new OpenLayers.Projection("EPSG:4326"));
var pointsiz=1;
if(map.layers[a].styleMap.styles.default.rules.length==0){pointsiz=map.layers[a].styleMap.styles.default.defaultStyle.pointRadius;}
else{
for(var tt=0;tt<map.layers[a].styleMap.styles.default.rules.length;tt++)
{ 
if(map.layers[a].styleMap.styles.default.rules[tt].filter.CLASS_NAME=="OpenLayers.Filter.Comparison"&&map.layers[a].features[v].attributes[map.layers[a].styleMap.styles.default.rules[tt].filter.property]>=map.layers[a].styleMap.styles.default.rules[tt].filter.lowerBoundary&&map.layers[a].features[v].attributes[map.layers[a].styleMap.styles.default.rules[tt].filter.property]<=map.layers[a].styleMap.styles.default.rules[tt].filter.upperBoundary)
{pointsiz=map.layers[a].styleMap.styles.default.rules[tt].symbolizer.pointRadius;}
if(map.layers[a].styleMap.styles.default.rules[tt].filter.type=="==")
{
if(map.layers[a].features[v].attributes[map.layers[a].styleMap.styles.default.rules[tt].filter.property]==map.layers[a].styleMap.styles.default.rules[tt].filter.value)
{pointsiz=map.layers[a].styleMap.styles.default.rules[tt].symbolizer.pointRadius;}

}
    }
}

//var strzam='"type":"Point","coordinates":['+lonlat.left+','+lonlat.bottom+']}'; rtt=strzam; alert("ee");
var multcoefSq=parseFloat(document.getElementById("dopWid3djson"+"_"+map.layers[a].name).value);
var x0=lonlat.left;var y0=lonlat.bottom-pointsiz*multcoefSq;var x1=lonlat.left-pointsiz*multcoefSq; var y1=lonlat.bottom;var x2=lonlat.left;var y2=lonlat.bottom+pointsiz*multcoefSq;var x3=lonlat.left+pointsiz*multcoefSq;var y3=lonlat.bottom;
var strzam2= '"type":"MultiPolygon","coordinates":[[[['+x1+','+y0+'],['+x1+','+y2+'],['+x3+','+y2+'],['+x3+','+y0+'],['+x1+','+y0+']]]]},';
if(typeof ArrayFeat[v+1].split(']},')[1]!=='undefined')
{ArrayFeat[v+1]='{"type":"Feature"'+ArrayFeat[v+1].split('"type":"Point",')[0]+strzam2+ArrayFeat[v+1].split(']},')[1];}
else
{var strzam2='"type":"MultiPolygon","coordinates":[[[['+x1+','+y0+'],['+x1+','+y2+'],['+x3+','+y2+'],['+x3+','+y0+'],['+x1+','+y0+']]]]}'; var strk="},";
if(v+1>=map.layers[a].features.length){strk='}]}';}
ArrayFeat[v+1]='{"type":"Feature"'+ArrayFeat[v+1].split('"type":"Point",')[0]+strzam2+strk;
}
//jsonstring=jsonstring.replace(strzam,strzam2);

}
jsonstring=ArrayFeat.join("");
}
var multCoefHei=parseFloat(document.getElementById("dopHei3djson"+"_"+map.layers[a].name).value);
var coefAtrr=document.getElementById("3d_dop_select_id"+"_"+map.layers[a].name).value;
var multCoefHei2=parseFloat(document.getElementById("dopHei3djson2"+"_"+map.layers[a].name).value);
var coefAtrr2=document.getElementById("3d_dop_select_id2"+"_"+map.layers[a].name).value;
var strcoefsve=multCoefHei+","+coefAtrr+","+multCoefHei2+","+coefAtrr2;
globalwidg3dEntity[a+"layerent"]={"1":jsonstring,"2":strcoefsve};
var objcoloren={}; objcolorenLine={};
 jsonstring=JSON.parse(jsonstring);
//jsonDS.fromUrl('ne_10m_us_states.topojson');

jsonDS.load(jsonstring).then(function() {
var entities = jsonDS.entities.values;rtt=jsonDS; var pointyes=false;var pointsiz=100;var widthL=2;
if(map.layers[a].features[0].geometry.CLASS_NAME=="OpenLayers.Geometry.Point")
{pointyes=true;}
if(map.layers[a].styleMap.styles.default.rules.length==0){pointsiz=1000*map.layers[a].styleMap.styles.default.defaultStyle.pointRadius;}
for (var ii = 0; ii < entities.length; ii++) 
{var color=''; stcolor='';var styla=map.layers[a].styleMap.styles.default;
var entity = entities[ii];
if(map.layers[a].styleMap.styles.default.rules.length==0)
{if(map.layers[a].features[0].geometry.CLASS_NAME=="OpenLayers.Geometry.Point"||map.layers[a].features[0].geometry.CLASS_NAME=="OpenLayers.Geometry.Polygon"||map.layers[a].features[0].geometry.CLASS_NAME=="OpenLayers.Geometry.MultiPolygon")
{color=new Cesium.Color.fromCssColorString(styla.defaultStyle.fillColor);stcolor=new Cesium.Color.fromCssColorString(styla.defaultStyle.strokeColor);}
else
{color=new Cesium.Color.fromCssColorString(styla.defaultStyle.strokeColor);widthL=styla.defaultStyle.strokeWidth;}
}
else
{
for(var tt=0;tt<map.layers[a].styleMap.styles.default.rules.length;tt++)
{ 
if(styla.rules[tt].filter.CLASS_NAME=="OpenLayers.Filter.Comparison"&&parseFloat(entity.properties[styla.rules[tt].filter.property])>=parseFloat(styla.rules[tt].filter.lowerBoundary)&&parseFloat(entity.properties[styla.rules[tt].filter.property])<=parseFloat(styla.rules[tt].filter.upperBoundary))
{
if(map.layers[a].features[0].geometry.CLASS_NAME=="OpenLayers.Geometry.Point"||map.layers[a].features[0].geometry.CLASS_NAME=="OpenLayers.Geometry.Polygon"||map.layers[a].features[0].geometry.CLASS_NAME=="OpenLayers.Geometry.MultiPolygon")
{var c=styla.rules[tt].symbolizer.fillColor.split('rgb(')[1].split(')')[0].split(',');
var c2=styla.rules[tt].symbolizer.strokeColor.split('rgb(')[1].split(')')[0].split(',');
c2[0]=parseInt(c2[0]);c2[1]=parseInt(c2[1]);c2[2]=parseInt(c2[2]);stcolor=Cesium.Color.fromBytes(c2[0],c2[1],c2[2],1);

}
else{var c=styla.rules[tt].symbolizer.strokeColor.split('rgb(')[1].split(')')[0].split(',');widthL=map.layers[a].styleMap.styles.default.rules[tt].symbolizer.strokeWidth;}
c[0]=parseInt(c[0]);c[1]=parseInt(c[1]);c[2]=parseInt(c[2]);

color=Cesium.Color.fromBytes(c[0],c[1],c[2],1);
}
if(styla.rules[tt].filter.CLASS_NAME=="OpenLayers.Filter.Logical"&&styla.rules[0].filter.filters)
{ if(map.layers[a].styleMap.styles.default.rules.length==1)
{if(entity.properties[map.layers[a].styleMap.styles.default.rules[tt].filter.filters[0].property]>=map.layers[a].styleMap.styles.default.rules[tt].filter.filters[0].value&&entity.properties[map.layers[a].styleMap.styles.default.rules[tt].filter.filters[0].property]<map.layers[a].styleMap.styles.default.rules[tt].filter.filters[1].value)
{
if(map.layers[a].features[0].geometry.CLASS_NAME=="OpenLayers.Geometry.Point"||map.layers[a].features[0].geometry.CLASS_NAME=="OpenLayers.Geometry.Polygon"||map.layers[a].features[0].geometry.CLASS_NAME=="OpenLayers.Geometry.MultiPolygon")
{
if(map.layers[a].styleMap.styles.default.rules[tt].symbolizer.fillColor.split('rgb(')[1])
{var c=map.layers[a].styleMap.styles.default.rules[tt].symbolizer.fillColor.split('rgb(')[1].split(')')[0].split(',');
color=Cesium.Color.fromBytes(c[0],c[1],c[2],1);
var c2=map.layers[a].styleMap.styles.default.rules[tt].symbolizer.strokeColor.split('rgb(')[1].split(')')[0].split(',');
stcolor=Cesium.Color.fromBytes(c2[0],c2[1],c2[2],1);

}
else{color=Cesium.Color.fromCssColorString(map.layers[a].styleMap.styles.default.rules[tt].symbolizer.fillColor);}
}
else{
if(map.layers[a].styleMap.styles.default.rules[tt].symbolizer.fillColor.split('rgb(')[1])
{var c=map.layers[a].styleMap.styles.default.rules[tt].symbolizer.strokeColor.split('rgb(')[1].split(')')[0].split(',');color=Cesium.Color.fromBytes(c[0],c[1],c[2],1);}
else{color=Cesium.Color.fromCssColorString(map.layers[a].styleMap.styles.default.rules[tt].symbolizer.strokeColor);}
widthL=map.layers[a].styleMap.styles.default.rules[tt].symbolizer.strokeWidth;
}
}}
if(map.layers[a].styleMap.styles.default.rules.length>1)
{if(entity.properties[map.layers[a].styleMap.styles.default.rules[tt].filter.filters[0].property]>=map.layers[a].styleMap.styles.default.rules[tt].filter.filters[0].value&&entity.properties[map.layers[a].styleMap.styles.default.rules[tt].filter.filters[0].property]<map.layers[a].styleMap.styles.default.rules[tt].filter.filters[1].value&&entity.properties[map.layers[a].styleMap.styles.default.rules[tt].filter.filters[2].property]>=map.layers[a].styleMap.styles.default.rules[tt].filter.filters[2].lowerBoundary&&entity.properties[map.layers[a].styleMap.styles.default.rules[tt].filter.filters[2].property]<=map.layers[a].styleMap.styles.default.rules[tt].filter.filters[2].upperBoundary)
{
if(map.layers[a].features[0].geometry.CLASS_NAME=="OpenLayers.Geometry.Point"||map.layers[a].features[0].geometry.CLASS_NAME=="OpenLayers.Geometry.Polygon"||map.layers[a].features[0].geometry.CLASS_NAME=="OpenLayers.Geometry.MultiPolygon")
{
if(map.layers[a].styleMap.styles.default.rules[tt].symbolizer.fillColor.split('rgb(')[1])
{var c=map.layers[a].styleMap.styles.default.rules[tt].symbolizer.fillColor.split('rgb(')[1].split(')')[0].split(',');
color=Cesium.Color.fromBytes(c[0],c[1],c[2],1);
  if(map.layers[a].styleMap.styles.default.rules[tt].symbolizer.strokeColor.split('rgb(')[1])
{var c2=map.layers[a].styleMap.styles.default.rules[tt].symbolizer.strokeColor.split('rgb(')[1].split(')')[0].split(',');
stcolor=Cesium.Color.fromBytes(c2[0],c2[1],c2[2],1);}
   else{stcolor=Cesium.Color.fromCssColorString(map.layers[a].styleMap.styles.default.rules[tt].symbolizer.strokeColor);}
}
else{color=Cesium.Color.fromCssColorString(map.layers[a].styleMap.styles.default.rules[tt].symbolizer.fillColor);
if(map.layers[a].styleMap.styles.default.rules[tt].symbolizer.strokeColor.split('rgb(')[1])
{var c2=map.layers[a].styleMap.styles.default.rules[tt].symbolizer.strokeColor.split('rgb(')[1].split(')')[0].split(',');
stcolor=Cesium.Color.fromBytes(c2[0],c2[1],c2[2],1);}
   else{stcolor=Cesium.Color.fromCssColorString(map.layers[a].styleMap.styles.default.rules[tt].symbolizer.strokeColor);}
}
}
else{
if(map.layers[a].styleMap.styles.default.rules[tt].symbolizer.fillColor.split('rgb(')[1])
{var c=map.layers[a].styleMap.styles.default.rules[tt].symbolizer.strokeColor.split('rgb(')[1].split(')')[0].split(',');color=Cesium.Color.fromBytes(c[0],c[1],c[2],1);}
else{color=Cesium.Color.fromCssColorString(map.layers[a].styleMap.styles.default.rules[tt].symbolizer.strokeColor);}
widthL=map.layers[a].styleMap.styles.default.rules[tt].symbolizer.strokeWidth;
}
}}
}

if(map.layers[a].styleMap.styles.default.rules[tt].filter.type=="==")
{
if(entity.properties[map.layers[a].styleMap.styles.default.rules[tt].filter.property]==map.layers[a].styleMap.styles.default.rules[tt].filter.value)
{

if(map.layers[a].features[0].geometry.CLASS_NAME=="OpenLayers.Geometry.Point"||map.layers[a].features[0].geometry.CLASS_NAME=="OpenLayers.Geometry.Polygon"||map.layers[a].features[0].geometry.CLASS_NAME=="OpenLayers.Geometry.MultiPolygon")
{
var c=map.layers[a].styleMap.styles.default.rules[tt].symbolizer.fillColor.split('rgb(')[1].split(')')[0].split(',');
var c2=map.layers[a].styleMap.styles.default.rules[tt].symbolizer.strokeColor.split('rgb(')[1].split(')')[0].split(',');
c2[0]=parseInt(c2[0]);c2[1]=parseInt(c2[1]);c2[2]=parseInt(c2[2]);
stcolor=Cesium.Color.fromBytes(c2[0],c2[1],c2[2],1);
}
else{var c=map.layers[a].styleMap.styles.default.rules[tt].symbolizer.strokeColor.split('rgb(')[1].split(')')[0].split(',');widthL=map.layers[a].styleMap.styles.default.rules[tt].symbolizer.strokeWidth;}
c[0]=parseInt(c[0]);c[1]=parseInt(c[1]);c[2]=parseInt(c[2]);

color=Cesium.Color.fromBytes(c[0],c[1],c[2],1);

}
}
}
//var color = Cesium.Color.fromRandom();

}
if (color=='')
{/*color = Cesium.Color.fromCssColorString('green');color.alpha=0;*/jsonDS.entities.remove(entity);ii=ii-1;}
else{
var opac=parseFloat(document.getElementById("dopOpac3djson"+"_"+map.layers[a].name).value)
color.alpha=opac;
objcoloren[ii+"_entityc"]=color.red+","+color.green+","+color.blue+","+color.alpha;

if(typeof entity.polyline!=='undefined')
{entity.polyline.material = new Cesium.ColorMaterialProperty(color);entity.polyline.width=new Cesium.ConstantProperty(parseFloat(widthL));objcolorenLine[ii+"_linePos"]={"points":'',"wid":widthL};}
else{entity.polygon.material = new Cesium.ColorMaterialProperty(color);stcolor.alpha=opac;entity.polygon.outlineColor=stcolor;objcoloren[ii+"_entitycst"]=stcolor.red+","+stcolor.green+","+stcolor.blue+","+stcolor.alpha;}
var multCoefHei=parseFloat(document.getElementById("dopHei3djson"+"_"+map.layers[a].name).value);
var coefAtrr=document.getElementById("3d_dop_select_id"+"_"+map.layers[a].name).value;
if(typeof entity.polyline=='undefined'&&coefAtrr!=="0")
{entity.polygon.extrudedHeight = new Cesium.ConstantProperty(parseFloat(entity.properties[coefAtrr])*multCoefHei);}
if(multCoefHei==0&&typeof entity.polyline=='undefined')
{entity.polygon.extrudedHeight=undefined}
var multCoefHei2=parseFloat(document.getElementById("dopHei3djson2"+"_"+map.layers[a].name).value);
var coefAtrr2=document.getElementById("3d_dop_select_id2"+"_"+map.layers[a].name).value;
if(typeof multCoefHei2!=='undefined'&&coefAtrr2!=="0")
{var arrPoint=[];if(typeof entity.polyline!=='undefined')
{var pl='';
if(map.layers[a].features[ii].geometry.CLASS_NAME=="OpenLayers.Geometry.LineString"){pl=map.layers[a].features[ii].geometry.components;}
if(map.layers[a].features[ii].geometry.CLASS_NAME=="OpenLayers.Geometry.MultiLineString"){pl=map.layers[a].features[ii].geometry.components[0].components;}
for (var thu=0;thu<pl.length;thu++)
{var p=pl[thu];

var br=new OpenLayers.Bounds(p.bounds.left, p.bounds.bottom,p.right,p.bounds.top);
var lonlat=br.transform(map.getProjectionObject(),new OpenLayers.Projection("EPSG:4326"));
var h=parseFloat(entity.properties[coefAtrr2])*multCoefHei2;
arrPoint.push(lonlat.left,lonlat.bottom,h)
}
entity.polyline.positions.setValue(Cesium.Cartesian3.fromDegreesArrayHeights(arrPoint));
objcolorenLine[ii+"_linePos"]={"points":arrPoint,"wid":widthL};
}

if(typeof entity.polygon!=='undefined')
{entity.polygon.height=new Cesium.ConstantProperty(parseFloat(entity.properties[coefAtrr2])*multCoefHei2);
if(typeof entity.polygon.extrudedHeight!=='undefined')
{entity.polygon.extrudedHeight=new Cesium.ConstantProperty(parseFloat(entity.properties[coefAtrr2])*multCoefHei2+parseFloat(entity.properties[coefAtrr])*multCoefHei);}}

}
} //end else color=='undefined'
}
globalwidg3dEntity[a+"layerent"]["3"]=objcoloren;globalwidg3dEntity[a+"layerent"]["4"]=objcolorenLine;
dis.update(widget.clock.currentTime);
});

}
if ((document.getElementById("id_3dJSON").checked!==true)||(document.getElementById("id_3dJSON").checked==true&&document.getElementById("valLeav"+"_"+map.layers[a].name).checked==true))
{
var can=map.layers[a].renderer.canvas.canvas;
var ctx = can.getContext("2d");

var imageWidth=can.width;
 var imageHeight=can.height;
var splitBw=imageWidth/30;
var splitBh=imageHeight/30;

 for(i=0;i<imageWidth;i+=splitBw){
      for(j=0;j<imageHeight;j+=splitBh){
            var ImageData = ctx.getImageData(i,j,splitBw,splitBh);     
var sndCanvas=document.createElement("canvas");
 sndCanvas.width=splitBw;
  sndCanvas.height=splitBh;
if(i==0&&j==0)
{var ext1 = new OpenLayers.Pixel(i+splitBw, j);
var ext2 = new OpenLayers.Pixel(i, j+splitBh);}//left,bottom}
else
{var ext1 = new OpenLayers.Pixel(i+splitBw, j);var ext2 = new OpenLayers.Pixel(i, j+splitBh);}
//rtt=ext2;alert("1");rtt=ext1;alert("2");
var lonlat1 = map.getLonLatFromPixel(ext1);
var lonlat2 = map.getLonLatFromPixel(ext2);
var boundImage=new OpenLayers.Bounds(lonlat2.lon, lonlat2.lat, lonlat1.lon, lonlat1.lat);
            var ctx2 = sndCanvas.getContext("2d");
            ctx2.putImageData(ImageData,0,0);
ImageData=sndCanvas.toDataURL();//rtt=ImageData;alert("stop");
boundImage.transform(map.getProjectionObject(),new OpenLayers.Projection("EPSG:4326"));
//rtt=boundImage;alert("stop2");
var prim0=new Cesium.RectanglePrimitive({
        rectangle : Cesium.Rectangle.fromDegrees(boundImage.left, boundImage.bottom,boundImage.right, boundImage.top),
   material : new Cesium.Material({
translucent:true,
        fabric : {  type : 'Image',  uniforms : {image : ImageData  }
        }     })
    })
  rectangle2 =primit.add(prim0);primit.raise(prim0);primitive3D.push(rectangle2);
           //tiles.push([ImageData,boundImage]);  
      }
    }
    }////canvas
}
}
}
document.getElementById("id_buttonUpdate3dmap").onclick=function(){Update3Dmap(widget)}
cesiumContainer.childNodes[0].childNodes[0].style.width=parseInt(document.getElementById("id_3dOpenWebWidth").value);cesiumContainer.childNodes[0].childNodes[0].style.height=parseInt(document.getElementById("id_3dOpenWebHeight").value);
cesiumContainer.childNodes[0].style.border="1px solid black";
cesiumContainer.childNodes[0].style.width=parseInt(document.getElementById("id_3dOpenWebWidth").value)+"px";cesiumContainer.childNodes[0].style.height=parseInt(document.getElementById("id_3dOpenWebWidth").value)+"px";
cesiumContainer.childNodes[0].childNodes[0].clientWidth=parseInt(document.getElementById("id_3dOpenWebWidth").value);cesiumContainer.childNodes[0].childNodes[0].clientHeight=parseInt(document.getElementById("id_3dOpenWebHeight").value);
if(document.getElementById("id_zoom3dCurrent").checked==true){var bound=map.calculateBounds();bound.transform(map.getProjectionObject(),new OpenLayers.Projection("EPSG:4326"));
  widget.scene.camera.viewRectangle(Cesium.Rectangle.fromDegrees(bound.left, bound.bottom, bound.right, bound.top));
}
if(document.getElementById("id_div3dMapMain0")){close3dFirstWin()} 
document.getElementById("id_3dJSON").onchange=function (){onchangeid_3dJSON();}
document.getElementById("id_div3dMapMain2").onmousedown=function(event){drags(event)};
document.getElementById("id_div3dMapMain2").onmouseup=function(e){enddrag()};

}

}
 function base64code(str) {
var b64chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefg'+
'hijklmnopqrstuvwxyz0123456789+/=';
var b64encoded = '';var chr1, chr2, chr3;var enc1, enc2, enc3, enc4;
for (var i=0; i<str.length;) {
chr1 = str.charCodeAt(i++);chr2 = str.charCodeAt(i++);chr3 = str.charCodeAt(i++);
enc1 = chr1 >> 2;
enc2 = ((chr1 & 3) << 4) | (chr2 >> 4);
enc3 = isNaN(chr2) ? 64:(((chr2 & 15) << 2) | (chr3 >> 6));
enc4 = isNaN(chr3) ? 64:(chr3 & 63); 
 b64encoded += b64chars.charAt(enc1) + b64chars.charAt(enc2) +b64chars.charAt(enc3) + b64chars.charAt(enc4);}
return b64encoded;
} 
function GetEmbedOpenWebGis()
{ var weblink='';
var w=document.getElementById("map").style.width.split('px')[0];var h=document.getElementById("map").style.height.split('px')[0];
var posleft=parseInt(document.getElementById("mapResize").style.left.split('px')[0])+12;var postop=parseInt(document.getElementById("mapResize").style.top.split('px')[0])+12;

localStorageOpenWebGIS=SaveProject2();
if(document.getElementById("id_LinkSaveErrorNocode").checked==true)
{var linkstr=localStorageOpenWebGIS+" noCodeOpenWebGISlzw EndnoCodeOpenWebGISlzw";}
else{var linkstr=lzw_encode(localStorageOpenWebGIS);}
if(linkstr!=='')
{try {var xmlhttp =new XMLHttpRequest();}
catch (e) {alert("error");}
xmlhttp.open('POST','/temp.php?rand='+Math.random(), true);
xmlhttp.setRequestHeader("Cache-Control", "no-cache");
//xmlhttp.setRequestHeader("Content-type", "text/plain;charset=UTF-8");
 xmlhttp.setRequestHeader("Content-Type","application/x-www-form-urlencoded");
xmlhttp.onreadystatechange = function()
{if(xmlhttp.readyState == 4&&xmlhttp.status == 200) {
if(xmlhttp==''){alert("no data");return;}
var varlink=xmlhttp.responseText;

if(typeof window.location.href.split('?')[1]!='undefined'&&window.location.href.split('?')[1].length>0)
{weblink=window.location.href.split('#')[0].split('?')[0]+'?openwebgis='+varlink;}
else
{weblink=window.location.href.split('#')[0]+'?openwebgis='+varlink;}
var lw=parseInt(w)+parseInt(posleft); var th=parseInt(h)+parseInt(postop);var th2=th+2;var lw2=lw+2; var w3=parseInt(w)+2; var h3=parseInt(h)+2;
var stremb='<div style="position: relative; width:'+w3+'px; height:'+h3+'px;overflow: hidden;"><iframe src="'+weblink+'" scrolling="no" frameborder="no" style="position: absolute; left:-'+posleft+'px;top:-'+postop+'px;width:'+lw2+'px; height:'+th2+'px;"></iframe></div>';
if(document.getElementById("id_EmbSaveAllSite").checked==true)
{var wcs=document.getElementById("id_EmbedClearsite_w").value;var hcs=document.getElementById("id_EmbedClearsite_h").value;
var stremb='<div style="position: relative; width:'+wcs+'px; height:'+hcs+'px;overflow: hidden;"><iframe src="'+weblink+'" scrolling="yes" frameborder="no" style="position: absolute; width:'+wcs+'px; height:'+hcs+'px;"></iframe></div>';
}
document.getElementById("EmbedOpenwebgisTextArea").value=stremb;
document.getElementById("EmbedOpenwebgisTextArea").style.height=119;document.getElementById("EmbedOpenwebgisTextArea").style.width=355;
}}
alert("Эта функция работает только в онлайн веб-версии OpenWebGIS")
{return;
xmlhttp.send('l='+linkstr+'&a='+document.getElementById("id_LinkOpenWebGisAuth").value+'&w='+document.getElementById("id_LinkOpenWebGisSum").value);}

localStorageOpenWebGIS='';


}

}
function GetLinkOpenWebGis()
{
localStorageOpenWebGIS=SaveProject2();
if(document.getElementById("id_LinkSaveErrorNocode").checked==true)
{var linkstr=localStorageOpenWebGIS+" noCodeOpenWebGISlzw EndnoCodeOpenWebGISlzw";}
else{var linkstr=lzw_encode(localStorageOpenWebGIS);}
if(linkstr!=='')
{try {var xmlhttp =new XMLHttpRequest();}
catch (e) {alert("error");}
linkstr=linkstr.replace(/&/g," ;and_owg; ");
xmlhttp.open('POST','/temp.php?rand='+Math.random(), true);
xmlhttp.setRequestHeader("Cache-Control", "no-cache");
//xmlhttp.setRequestHeader("Content-type", "text/plain;charset=UTF-8");
 xmlhttp.setRequestHeader("Content-Type","application/x-www-form-urlencoded");
xmlhttp.onreadystatechange = function()
{if(xmlhttp.readyState == 4&&xmlhttp.status == 200) {
if(xmlhttp==''){alert("no data");return;}
var varlink=xmlhttp.responseText;

if(typeof window.location.href.split('?')[1]!='undefined'&&window.location.href.split('?')[1].length>0)
{document.getElementById("LinkOpenwebgisTextArea").value=window.location.href.split('#')[0].split('?')[0]+'?openwebgis='+varlink;document.getElementById("LinkOpenwebgisTextArea").style.width=500;}
else
{document.getElementById("LinkOpenwebgisTextArea").value=window.location.href.split('#')[0]+'?openwebgis='+varlink;document.getElementById("LinkOpenwebgisTextArea").style.width=500;}
}}
alert("Эта функция работает только в онлайн веб-версии OpenWebGIS")
{return;
xmlhttp.send('l='+linkstr+'&a='+document.getElementById("id_LinkOpenWebGisAuth").value+'&w='+document.getElementById("id_LinkOpenWebGisSum").value);}

localStorageOpenWebGIS='';}
}
function creatDialogGeolocation()
{
var bbox = document.getElementById("map").getBoundingClientRect();
 var body = document.body
 var docElem = document.documentElement
 var scrollTop = window.pageYOffset || docElem.scrollTop || body.scrollTop
 var scrollLeft = window.pageXOffset || docElem.scrollLeft || body.scrollLeft
 var clientTop = docElem.clientTop || body.clientTop || 0
 var clientLeft = docElem.clientLeft || body.clientLeft || 0
 var topTop = bbox.top + scrollTop - clientTop
 var leftLeft = bbox.left + scrollLeft - clientLeft
var DivEditeLeg=document.createElement("div");
DivEditeLeg.id="id_divMyLocation";
DivEditeLeg.className="id_divRoutLegMain";
DivEditeLeg.style.position="relative";
//DivEditeLeg.style.opacity=0.8;
DivEditeLeg.innerHTML='<div id="id_divMyLocation" style="background:#ffffff; color:#0000ff;z-index: 6000;position:absolute;left:'+Math.round(leftLeft+50)+'px;top:'+Math.round(topTop-220)+
'px;overflow:hidden; border: 1px solid black;">'+
'<img onclick="closeGeoLocFirstWin()" src="openlayers/theme/default/img/close.gif" style="position:relative; top:10px;float:right; cursor:pointer">'+
'<a style="font-size: 9px;">Вы можете перемещать это окно если щёлкните по пункту меню:</a> <br><a style="font-size: 9px;">Интерфейс->переключить режим интерфейса</a><br>'+
'<a>Определение позиций в реальном времени:</a><br>'+
'<a style="font-size: 11px;">Интервал обвновления в секундах:</a><input type="text" size="5" id="id_MyLocatSec" value="60" title="Установите интервал обновления вашего местоположения в секундах"/><button title="После нажатия на эту кнопку, вы будете получать набор точек с вашей геолокацией. Набор точек будет обновлятся примерно через то количество секунд, которое вы установили." type=button onclick=StartMyGeoLocation()><a style="font-size: 11px;">старт</a></button><button type=button onclick=StopMyGeoLocation()><a style="font-size: 11px;">стоп</a></button><br>'+
'<input type="checkbox" id="id_LastPointLoc" title="" value="checkbox"/>оставлять последние: <input  type="text" size="6" id="leaveLocP_id" value="10"/>точек<br>'+
'<a>название Слоя:</a><input type="text" size="15" id="id_MyLocatName" value="MyLocation"/><br>'+
'<input type="checkbox" id="id_MoveMyLoc" title="" value="checkbox" checked/><a style="font-size: 11px;">перемещать экстент карты за позицией</a><br><a style="font-size: 11px;">размер экстента в градусах</a><input type="text" style="font-size: 11px;" title="размер экстента в градусах." size="4" id="MyPosmovemap_val" value="0.005"/><br>'+
'<input type="checkbox" id="id_TrackMyLocTime" title="" value="checkbox" checked/><a>Добавить трек</a><br>'+
'<input type="checkbox" id="id_PointSaveServerLocat" title="Поставьте галочку, чтобы сохранять данные вашего местоположения на сервере OpenWebGIS. Данные сохраняются только после нажатия кнопки /старт/. После нажатия кнопки /стоп/ запись прекращается. ВАЖНО: если вы активировали запись местоположения на сервер, то после нажатия на кнопку старт вы получите буквенно-цифровой идентификатор id вашей записи, он появится в текстовом поле справа. Этот идентификатор вы или кто-то другой(кому вы его передадите) можете использовать для получения данных о вашем местоположении, путём внесения его в соответствующее поле под названием /введите id геолокации/. Это поле находится ниже в разделе /Нажмите для определения местоположения других объектов или отобразить записанное:/" value="checkbox" /><a style="font-size: 11px;">сохранить позиции</a><a style="font-size: 12px;"> id:</a><textarea title="если вы активировали запись местоположений(геолокаций) на сервер, то после нажатия на кнопку старт вы получите В ЭТОМ ПОЛЕ буквенно-цифровой идентификатор id вашей записи" style="height:20px; width:120px" id="id_PointSaveLinkLocat" type="text" size="10" value=""></textarea>'+
'<p> <button type=button onclick=GetMyGeoLocation() title="После нажатия на эту кнопку, вы получите одну точку с вашей геолокации (позицией)">Получить текущую позицию</button></p>'+
'<div onclick=showotherlocation() style="border:solid 2px #000; cursor:pointer "><a style="font-size: 12px;">Нажмите для определения местоположения</a> <br><a style="font-size: 12px;">других объектов или отобразить записанное:</a></div>'+
'<div id="id_divOtherGeolocat" style="display:none;">'+
'<a style="font-size: 11px;">введите id геолокации</a><textarea style="height:20px; width:120px" id="id_PointOtherSaveLinkLocat" type="text" size="10" value=""></textarea><br>'+
'<a>название Слоя:</a><input type="text" size="15" id="id_MyLocatName2" value="Геолокация"/><br>'+
'<a style="font-size: 11px;">обвновления в секундах:</a><input type="text" size="5" id="id_MyLocatSec2" value="60" title="Установите интервал обновления местоположения в секундах"/><button title="После нажатия на эту кнопку, вы будете получать набор точек с геолокацией. Набор точек будет обновлятся примерно через то количество секунд, которое вы установили." type=button onclick=StartOtherGeoLocation()><a style="font-size: 11px;">start</a></button><button type=button onclick=StopOtherGeoLocation()><a style="font-size: 11px;">stop</a></button><br>'+
'<input type="checkbox" id="id_MoveMyLoc2" title="" value="checkbox" checked/><a style="font-size: 11px;">перемещать экстент карты за позицией</a><br><a style="font-size: 11px;">размер экстента в градусах</a><input type="text" style="font-size: 11px;" title="размер экстента в градусах" size="4" id="MyPosmovemap_val2" value="0.005"/><br>'+
'<input type="checkbox" id="id_LastPointLoc2" title="" value="checkbox"/>оставлять последние:<input  type="text" size="6" id="leaveLocP_id2" value="10"/>точек<br>'+
'<button type=button onclick=GetAllSavePLocation() title="После нажатия  на эту кнопку  вы получите все точки геолокации">Получить все точки</button><input type="checkbox" id="id_TrackOtherLocTime" title="" value="checkbox" /><a>Добавить трек</a><br>'+
'<a style="font-size: 10px;">Название слоя:</a><input type="text" size="15" id="id_MyLocatName3" value="ВсеТочки"/><br>'+
'</div>'
'</div>';
if(!document.getElementById("id_divMyLocation"))
{body.appendChild(DivEditeLeg);
document.getElementById("id_divMyLocation").onmousedown=function(event){drags(event)};
document.getElementById("id_divMyLocation").onmouseup=function(e){enddrag()};
}}

function GetAllSavePLocation()
{
if(document.getElementById("id_PointOtherSaveLinkLocat").value==''){alert("insert id of geolocation"); return;}
var new_layer_OtherLocationInterval = new OpenLayers.Layer.Vector(document.getElementById("id_MyLocatName3").value,{renderers:["Canvas", "SVG", "VML"]});
var new_style_layer= new OpenLayers.Style({ pointRadius: 4, fillColor: "#FF9000", strokeColor: "#FF0000",
 strokeWidth: 2,fillOpacity:1, strokeOpacity:1 });
var new_style_layer2= new OpenLayers.Style({ pointRadius: 3, fillColor: "#FF9000", strokeColor: "#FF9000",
 strokeWidth: 1,fillOpacity:1, strokeOpacity:1 });
 var selStyle = new OpenLayers.Style({ pointRadius: 5,  fillColor: "#ffaa00",
 strokeColor: "#00DDFF", strokeWidth:2,fillOpacity:1, strokeOpacity:1 }); 
new_layer_OtherLocationInterval.styleMap=new OpenLayers.StyleMap({'default':new_style_layer,'select': selStyle});
new_layer_OtherLocationInterval.projection=new OpenLayers.Projection("EPSG:900913");
map.addLayer(new_layer_OtherLocationInterval);
var t=document.createElement('option');t.value=new_layer_OtherLocationInterval.name;t.text=new_layer_OtherLocationInterval.name;document.getElementById("editL1").appendChild(t);
var strsave=document.getElementById("id_PointOtherSaveLinkLocat").value;
try {var xmlhttp =new XMLHttpRequest();}
catch (e) {alert("error");}
xmlhttp.open('POST','/temp.php?rand='+Math.random(), true);
xmlhttp.setRequestHeader("Cache-Control", "no-cache");
 xmlhttp.setRequestHeader("Content-Type","application/x-www-form-urlencoded");
xmlhttp.onreadystatechange = function()
{if(xmlhttp.readyState == 4&&xmlhttp.status == 200) {
if(xmlhttp==''){alert("no data");return;} 
var varlink=xmlhttp.responseText;
if(varlink=="id does not exist"||varlink==""){alert("id does not exist or other error."); stoptimerOtherLocate(intervaTimeGeoLocOther);return;}
var atrn0=varlink.split("/");
for(var et=1;et<atrn0.length; et++)
{
var atrn=atrn0[et].split(";");

var lat=atrn[1];  var lon=atrn[0];  var alt=atrn[2]; var sp=atrn[3]; var timeS=atrn[4];
var new_pos=new OpenLayers.LonLat(lon,lat).transform(new OpenLayers.Projection("EPSG:4326"),map.getProjectionObject());
points=new OpenLayers.Geometry.Point(new_pos.lon, new_pos.lat);
var first_point= new OpenLayers.Feature.Vector(points);
var attr={};attr.latitude=lat; attr.longitude=lon;attr.altitude=alt;attr.speed=sp;attr.time=timeS; 
first_point.attributes=attr; new_layer_OtherLocationInterval.addFeatures(first_point);}
zoomAllLoacation(new_layer_OtherLocationInterval);

}}
alert("Эта функция работает только в онлайн веб-версии OpenWebGIS")
{return;
xmlhttp.send('l='+strsave);}

}
function zoomAllLoacation(new_layer_OtherLocationInterval)
{var valg=parseFloat(document.getElementById("MyPosmovemap_val2").value);
var la=new_layer_OtherLocationInterval;
var minDistC = parseFloat(la.features[0].geometry.bounds.left);
var  maxDistC = parseFloat(minDistC) ;
for (var ia = 1; ia <  la.features.length; ++ia) { var NumSS=la.features[ia].geometry.bounds.left;
if (NumSS>parseFloat(maxDistC) ) {maxDistC =  parseFloat(NumSS);}if( NumSS<parseFloat(minDistC) ) {minDistC  = parseFloat(NumSS);}}
var x1=minDistC ;var minDistC = parseFloat(la.features[0].geometry.bounds.right);
var  maxDistC = parseFloat(minDistC) ;
for (var ia = 1; ia <  la.features.length; ++ia) { var NumSS=la.features[ia].geometry.bounds.right;
if (NumSS>parseFloat(maxDistC) ) {maxDistC =  parseFloat(NumSS);}if( NumSS<parseFloat(minDistC) ) {minDistC  = parseFloat(NumSS);}}
var x2=maxDistC;var minDistC = parseFloat(la.features[0].geometry.bounds.bottom);
var  maxDistC = parseFloat(minDistC) ;
for (var ia = 1; ia <  la.features.length; ++ia) { var NumSS=la.features[ia].geometry.bounds.bottom;
if (NumSS>parseFloat(maxDistC) ) {maxDistC =  parseFloat(NumSS);}if( NumSS<parseFloat(minDistC) ) {minDistC  = parseFloat(NumSS);}}
var y1=minDistC ;var minDistC = parseFloat(la.features[0].geometry.bounds.top);var  maxDistC = parseFloat(minDistC) ;
for (var ia = 1; ia <  la.features.length; ++ia) { var NumSS=la.features[ia].geometry.bounds.top;if (NumSS>parseFloat(maxDistC) ) {maxDistC =  parseFloat(NumSS);}
if( NumSS<parseFloat(minDistC) ) {minDistC  = parseFloat(NumSS);}}
var y2=maxDistC;var bounds=new OpenLayers.Bounds(x1,y1,x2,y2);
bounds.transform(map.getProjectionObject(),new OpenLayers.Projection("EPSG:4326"));
bounds.left=bounds.left-valg;bounds.right=bounds.right+valg;bounds.top=bounds.top-valg;bounds.bottom=bounds.bottom+valg;
bounds.transform(new OpenLayers.Projection("EPSG:4326"),map.getProjectionObject());
map.zoomToExtent(bounds);
}
function showotherlocation()
{if(document.getElementById("id_divOtherGeolocat").style.display=="none"){document.getElementById("id_divOtherGeolocat").style.display="block"}else{document.getElementById("id_divOtherGeolocat").style.display="none"}}
function StartOtherGeoLocation()
{var err=(document.getElementById("id_MyLocatSec2").value/document.getElementById("id_MyLocatSec2").value) ? true : false; 
if(err==false){alert("error in seconds");return;}
if(err==true){if(parseInt(document.getElementById("id_MyLocatSec2").value)<10){alert("set seconds more then 9");return;}}
if(document.getElementById("id_PointOtherSaveLinkLocat").value==''){alert("insert id of geolocation"); return;}
var new_layer_OtherLocationInterval = new OpenLayers.Layer.Vector(document.getElementById("id_MyLocatName2").value,{renderers:["Canvas", "SVG", "VML"]});
var new_style_layer= new OpenLayers.Style({ pointRadius: 4, fillColor: "#FF9000", strokeColor: "#FF0000",
 strokeWidth: 2,fillOpacity:1, strokeOpacity:1 });
var new_style_layer2= new OpenLayers.Style({ pointRadius: 3, fillColor: "#FF9000", strokeColor: "#FF9000",
 strokeWidth: 1,fillOpacity:1, strokeOpacity:1 });
 var selStyle = new OpenLayers.Style({ pointRadius: 5,  fillColor: "#ffaa00",
 strokeColor: "#00DDFF", strokeWidth:2,fillOpacity:1, strokeOpacity:1 }); 
new_layer_OtherLocationInterval.styleMap=new OpenLayers.StyleMap({'default':new_style_layer,'select': selStyle});
new_layer_OtherLocationInterval.projection=new OpenLayers.Projection("EPSG:900913");
map.addLayer(new_layer_OtherLocationInterval);
var t=document.createElement('option');t.value=new_layer_OtherLocationInterval.name;t.text=new_layer_OtherLocationInterval.name;document.getElementById("editL1").appendChild(t);
var new_layer_OtherLocationT=0;
if(document.getElementById("id_TrackOtherLocTime").checked==true)
{new_layer_OtherLocationT = new OpenLayers.Layer.Vector(document.getElementById("id_MyLocatName2").value+"Track",{renderers:["Canvas", "SVG", "VML"]});
var new_style_layer2= new OpenLayers.Style({ pointRadius: 4, fillColor: "#FF9000", strokeColor: "#FF9000", strokeWidth: 2,fillOpacity:1, strokeOpacity:1 });
new_layer_OtherLocationT.styleMap=new OpenLayers.StyleMap({'default':new_style_layer2,'select': selStyle});
new_layer_OtherLocationT.projection=new OpenLayers.Projection("EPSG:900913");
map.addLayer(new_layer_OtherLocationT);var t=document.createElement('option');t.value=new_layer_OtherLocationT.name;t.text=new_layer_OtherLocationT.name;document.getElementById("editL1").appendChild(t);
}
var strsave=document.getElementById("id_PointOtherSaveLinkLocat").value;var valg=parseFloat(document.getElementById("MyPosmovemap_val2").value);
var intervaTimeGeoLocOther=0;StartOtherGeoLocation2(new_layer_OtherLocationInterval,intervaTimeGeoLocOther,strsave,valg,new_layer_OtherLocationT);
var intervaTimeGeoLocOther=setInterval( function(){
StartOtherGeoLocation2(new_layer_OtherLocationInterval,intervaTimeGeoLocOther,strsave,valg,new_layer_OtherLocationT);
},parseInt(document.getElementById("id_MyLocatSec2").value)*1000);
intervaTimeLocateOthArray.push(intervaTimeGeoLocOther);


}
function StartOtherGeoLocation2(new_layer_OtherLocationInterval,intervaTimeGeoLocOther,strsave,valg,new_layer_OtherLocationT)
{

try {var xmlhttp =new XMLHttpRequest();}
catch (e) {alert("error");}
xmlhttp.open('POST','/temp.php?rand='+Math.random(), true);
xmlhttp.setRequestHeader("Cache-Control", "no-cache");
 xmlhttp.setRequestHeader("Content-Type","application/x-www-form-urlencoded");
xmlhttp.onreadystatechange = function()
{if(xmlhttp.readyState == 4&&xmlhttp.status == 200) {
if(xmlhttp==''){alert("no data");return;} 
var varlink=xmlhttp.responseText;
if(varlink=="id does not exist"||varlink==""){alert("id does not exist or other error."); stoptimerOtherLocate(intervaTimeGeoLocOther);return;}

var atrn=varlink.split(";");
var lat=atrn[1];  var lon=atrn[0];  var alt=atrn[2]; var sp=atrn[3]; var timeS=atrn[4];
var new_pos=new OpenLayers.LonLat(lon,lat).transform(new OpenLayers.Projection("EPSG:4326"),map.getProjectionObject());
points=new OpenLayers.Geometry.Point(new_pos.lon, new_pos.lat);
var first_point= new OpenLayers.Feature.Vector(points);
var attr={};attr.latitude=lat; attr.longitude=lon;attr.altitude=alt;attr.speed=sp;attr.time=timeS; 
first_point.attributes=attr; new_layer_OtherLocationInterval.addFeatures(first_point);
if(document.getElementById("id_LastPointLoc2").checked==true)
{var u=parseInt(document.getElementById("leaveLocP_id2").value)+1;if(new_layer_OtherLocationInterval.features.length==u)
{if(new_layer_OtherLocationInterval.features[0]){new_layer_OtherLocationInterval.removeFeatures(new_layer_OtherLocationInterval.features[0])}}
if(new_layer_OtherLocationInterval.features.length>u){for(var vb=0;vb<u;vb++){new_layer_OtherLocationInterval.removeFeatures(new_layer_OtherLocationInterval.features[vb])}}
}
if (document.getElementById("id_MoveMyLoc2").checked==true)
{;var x1s=lon-valg;var y1s=lat-valg;var x2s=lon+valg;var y2s=lat+valg;var bounds=new OpenLayers.Bounds(x1s,y1s,x2s,y2s);
bounds.transform(new OpenLayers.Projection("EPSG:4326"),map.getProjectionObject());
map.zoomToExtent(bounds);}

//document.getElementById("id_PointSaveLinkLocat").value=varlink;
}}
alert("Эта функция работает только в онлайн веб-версии OpenWebGIS")
{return;
xmlhttp.send('l='+strsave);}
if(new_layer_OtherLocationT!==0)
{
try {var xmlhttp2 =new XMLHttpRequest();}
catch (e) {alert("error");}
xmlhttp2.open('POST','/temp.php?rand='+Math.random(), true);
xmlhttp2.setRequestHeader("Cache-Control", "no-cache");
 xmlhttp2.setRequestHeader("Content-Type","application/x-www-form-urlencoded");
xmlhttp2.onreadystatechange = function()
{if(xmlhttp2.readyState == 4&&xmlhttp2.status == 200) {
if(xmlhttp2==''){alert("no data");return;} 
var varlink=xmlhttp2.responseText;
var atrn0=varlink.split("/");var pointList=[];var ListSpeed=[];var ListTime=[];
for(var et=1;et<atrn0.length; et++)
{
var atrn=atrn0[et].split(";");

var lat=atrn[1];  var lon=atrn[0];  var sp=atrn[3]; var timeS=atrn[4]; //var alt=atrn[2];
var new_pos=new OpenLayers.LonLat(lon,lat).transform(new OpenLayers.Projection("EPSG:4326"),map.getProjectionObject());
var points=new OpenLayers.Geometry.Point(new_pos.lon, new_pos.lat);
pointList.push(points);ListSpeed.push(sp);ListTime.push(timeS);
//var attr={};attr.latitude=lat; attr.longitude=lon;attr.altitude=alt;attr.speed=sp;attr.time=timeS; 
//first_point.attributes=attr; 
}
var sd1=new Date(ListTime[0])
sd1=sd1.getTime()
var minDistC = parseInt(sd1);
 var maxDistC = parseFloat(minDistC) ;
 for (ia = 1; ia < ListTime.length; ++ia) { sd2=new Date(ListTime[ia]);var sd2=sd2.getTime();var NumSS=sd2;
 if (NumSS>parseFloat(maxDistC) ){ maxDistC = parseFloat(NumSS);}
 if( NumSS<parseFloat(minDistC) ) {minDistC = parseFloat(NumSS);}
 }
var timemin=minDistC;var timemax=maxDistC;
var timeInter=(timemax-timemin)/1000;
 var line = new OpenLayers.Geometry.LineString(pointList);
new_layer_OtherLocationT.removeFeatures(new_layer_OtherLocationT.features);
var lineTr= new OpenLayers.Feature.Vector(line);
lineTr.attributes.travel_time_sec=timeInter;lineTr.attributes.travel_time_min=timeInter/60;;
var areaP=lineTr.clone().geometry.transform(map.getProjectionObject(),new OpenLayers.Projection("EPSG:4326"));
areaL=areaP.getGeodesicLength(new OpenLayers.Projection("EPSG:4326"));
lineTr.attributes.travel_dist_meter=areaL;lineTr.attributes.travel_dist_km=areaL/1000;
lineTr.attributes.avg_speed_km_hour=(areaL/1000)/((timeInter/60)/60);
new_layer_OtherLocationT.addFeatures(lineTr);
//zoomAllLoacation(new_layer_OtherLocationT);

}}
alert("Эта функция работает только в онлайн веб-версии OpenWebGIS")
{return;
xmlhttp2.send('l='+strsave);}




}
}
function stoptimerOtherLocate(intervaTimeGeoLocOther)
{clearInterval(intervaTimeGeoLocOther);}
function StopOtherGeoLocation()
{for(var b=0;b<intervaTimeLocateOthArray.length;b++){clearInterval(intervaTimeLocateOthArray[b]);}intervaTimeLocateOthArray=[];}

function StartMyGeoLocation()
{
if(intervaTimeGeoLoc!==0){alert("Вы должны остановить предыдущий процесс");return;}
var err=(document.getElementById("id_MyLocatSec").value/document.getElementById("id_MyLocatSec").value) ? true : false; 
if(err==false){alert("ошибка в секундах");return;}
var ArrayFeatures=[];
new_layer_MyLocationInterval = new OpenLayers.Layer.Vector(document.getElementById("id_MyLocatName").value,{renderers:["Canvas", "SVG", "VML"]});
var new_style_layer= new OpenLayers.Style({
 pointRadius: 4, fillColor: "#FF9000", strokeColor: "#FF0000",
 strokeWidth: 2,fillOpacity:1, strokeOpacity:1 });
var new_style_layer2= new OpenLayers.Style({
 pointRadius: 3, fillColor: "#FF9000", strokeColor: "#FF9000",
 strokeWidth: 1,fillOpacity:1, strokeOpacity:1 });
 var selStyle = new OpenLayers.Style({
 pointRadius: 5,  fillColor: "#ffaa00",
 strokeColor: "#00DDFF", strokeWidth:2,fillOpacity:1, strokeOpacity:1 }); 
new_layer_MyLocationInterval.styleMap=new OpenLayers.StyleMap({'default':new_style_layer,'select': selStyle});
new_layer_MyLocationInterval.projection=new OpenLayers.Projection("EPSG:900913");
map.addLayer(new_layer_MyLocationInterval);
var t=document.createElement('option');
t.value=new_layer_MyLocationInterval.name;t.text=new_layer_MyLocationInterval.name;
document.getElementById("editL1").appendChild(t);
if (document.getElementById("id_TrackMyLocTime").checked==true)
{new_layer_MyLocationIntervalTrack=new OpenLayers.Layer.Vector(document.getElementById("id_MyLocatName").value+"Track",{renderers:["Canvas", "SVG", "VML"]});
new_layer_MyLocationIntervalTrack.styleMap=new OpenLayers.StyleMap({'default':new_style_layer2,'select': selStyle});
new_layer_MyLocationIntervalTrack.projection=new OpenLayers.Projection("EPSG:900913");
map.addLayer(new_layer_MyLocationIntervalTrack);var t=document.createElement('option');
t.value=new_layer_MyLocationIntervalTrack.name;t.text=new_layer_MyLocationIntervalTrack.name;
document.getElementById("editL1").appendChild(t);
}
if(document.getElementById("id_PointSaveServerLocat").checked==true)
////////
{var strsave='';
try {var xmlhttp =new XMLHttpRequest();}
catch (e) {alert("error");}
xmlhttp.open('POST','/temp.php?rand='+Math.random(), true);
xmlhttp.setRequestHeader("Cache-Control", "no-cache");
 xmlhttp.setRequestHeader("Content-Type","application/x-www-form-urlencoded");
xmlhttp.onreadystatechange = function()
{if(xmlhttp.readyState == 4&&xmlhttp.status == 200) {
if(xmlhttp==''){alert("no data");return;}
var varlink=xmlhttp.responseText;
document.getElementById("id_PointSaveLinkLocat").value=varlink;
}}
alert("Эта функция работает только в онлайн веб-версии OpenWebGIS")
{return;
xmlhttp.send('l='+strsave);}
}/////////////////////////
if (navigator.geolocation)     {     navigator.geolocation.getCurrentPosition(showPositionInterval,showError);     }   
else{alert("Геолокация не поддерживается этим браузером.");return;}  
intervaTimeGeoLoc=setInterval( function(){

if (navigator.geolocation)     {     navigator.geolocation.getCurrentPosition(showPositionInterval,showError);     }   
else{alert("Geolocation is not supported by this browser.");return;}  

},parseInt(document.getElementById("id_MyLocatSec").value*1000));
}

function StopMyGeoLocation()
{
if(intervaTimeGeoLoc!==0){clearInterval(intervaTimeGeoLoc);intervaTimeGeoLoc=0;}
}
function showPositionInterval(position)
{
var lat=position.coords.latitude;  var lon=position.coords.longitude;  var alt=position.coords.altitude; var sp=position.coords.speed; var timeS=new Date(position.timestamp);
var new_pos=new OpenLayers.LonLat(lon,lat).transform(new OpenLayers.Projection("EPSG:4326"),map.getProjectionObject());
points=new OpenLayers.Geometry.Point(new_pos.lon, new_pos.lat);
var first_point= new OpenLayers.Feature.Vector(points);
var now=timeS;var Y=now.getFullYear();
var M=now.getMonth()+1;if(parseInt(M)<10){M='0'+M;}var D=now.getDate();if(parseInt(D)<10){D='0'+D;}
var H=now.getHours();if(parseInt(H)<10){H='0'+H;}var MM=now.getMinutes();if(parseInt(MM)<10){MM='0'+MM;}
var S=now.getSeconds();if(parseInt(S)<10){S='0'+S;}var neD=Y+'-'+M+'-'+D+'T'+H+':'+MM+':'+S;
var attr={};attr.latitude=lat; attr.longitude=lon;attr.altitude=alt;attr.speed=sp;attr.time=neD; var strsave=lon+";"+lat+";"+alt+";"+sp+";"+neD;
first_point.attributes=attr; new_layer_MyLocationInterval.addFeatures(first_point);
if(document.getElementById("id_PointSaveServerLocat").checked==true)
////////
{
try {var xmlhttp =new XMLHttpRequest();}
catch (e) {alert("error");}
xmlhttp.open('POST','/temp.php?rand='+Math.random(), true);
xmlhttp.setRequestHeader("Cache-Control", "no-cache");
//xmlhttp.setRequestHeader("Content-type", "text/plain;charset=UTF-8");
 xmlhttp.setRequestHeader("Content-Type","application/x-www-form-urlencoded");
xmlhttp.onreadystatechange = function()
{if(xmlhttp.readyState == 4&&xmlhttp.status == 200) {
if(xmlhttp==''){alert("no data");return;}
var varlink=xmlhttp.responseText;
if(varlink=='link did not execute'){alert(varlink); return;}
}}
alert("Эта функция работает только в онлайн веб-версии OpenWebGIS")
{return;
xmlhttp.send('l='+strsave+'&j='+document.getElementById("id_PointSaveLinkLocat").value);}
}/////////////////////////
if(document.getElementById("id_LastPointLoc").checked==true)
{var u=parseInt(document.getElementById("leaveLocP_id").value)+1;if(new_layer_MyLocationInterval.features.length==u)
{if(new_layer_MyLocationInterval.features[0]){new_layer_MyLocationInterval.removeFeatures(new_layer_MyLocationInterval.features[0])}}
if(new_layer_MyLocationInterval.features.length>u){for(var vb=0;vb<u;vb++){new_layer_MyLocationInterval.removeFeatures(new_layer_MyLocationInterval.features[vb])}}
}

if (document.getElementById("id_MoveMyLoc").checked==true)
{var valg=parseFloat(document.getElementById("MyPosmovemap_val").value);var x1s=lon-valg;var y1s=lat-valg;var x2s=lon+valg;var y2s=lat+valg;var bounds=new OpenLayers.Bounds(x1s,y1s,x2s,y2s);
bounds.transform(new OpenLayers.Projection("EPSG:4326"),map.getProjectionObject());
map.zoomToExtent(bounds);}
if (document.getElementById("id_TrackMyLocTime").checked==true)
{var pointList=[];
var sd1=new Date(new_layer_MyLocationInterval.features[0].attributes.time)
sd1=sd1.getTime()
var minDistC = parseInt(sd1);
 var maxDistC = parseFloat(minDistC) ;
 for (ia = 1; ia < new_layer_MyLocationInterval.features.length; ++ia) { sd2=new Date(new_layer_MyLocationInterval.features[ia].attributes.time);var sd2=sd2.getTime();var NumSS=sd2;
 if (NumSS>parseFloat(maxDistC) ){ maxDistC = parseFloat(NumSS);}
 if( NumSS<parseFloat(minDistC) ) {minDistC = parseFloat(NumSS);}
 }
var timemin=minDistC;var timemax=maxDistC;
var timeInter=(timemax-timemin)/1000;
for(var ty=0;ty<new_layer_MyLocationInterval.features.length;ty++)
{var newPoint1 = new OpenLayers.Geometry.Point(new_layer_MyLocationInterval.features[ty].geometry.x,new_layer_MyLocationInterval.features[ty].geometry.y);pointList.push(newPoint1);
if(new_layer_MyLocationInterval.features[ty+1])
{var newPoint1 = new OpenLayers.Geometry.Point(new_layer_MyLocationInterval.features[ty+1].geometry.x,new_layer_MyLocationInterval.features[ty+1].geometry.y);pointList.push(newPoint1);}
else{var newPoint1 = new OpenLayers.Geometry.Point(new_layer_MyLocationInterval.features[ty].geometry.x,new_layer_MyLocationInterval.features[ty].geometry.y);pointList.push(newPoint1);}
}
 var line = new OpenLayers.Geometry.LineString(pointList);
new_layer_MyLocationIntervalTrack.removeFeatures(new_layer_MyLocationIntervalTrack.features);
var lineTr= new OpenLayers.Feature.Vector(line);
lineTr.attributes.travel_time_sec=timeInter;
lineTr.attributes.travel_time_min=timeInter/60;;
var areaP=lineTr.clone().geometry.transform(map.getProjectionObject(),new OpenLayers.Projection("EPSG:4326"));
areaL=areaP.getGeodesicLength(new OpenLayers.Projection("EPSG:4326"));
lineTr.attributes.travel_dist_meter=areaL;
lineTr.attributes.travel_dist_km=areaL/1000;
lineTr.attributes.avg_speed_km_hour=(areaL/1000)/((timeInter/60)/60);

new_layer_MyLocationIntervalTrack.addFeatures(lineTr);

}

}
function GetMyGeoLocation()
{
if (navigator.geolocation)     {     navigator.geolocation.getCurrentPosition(showPosition,showError);     }   
else{alert("Geolocation is not supported by this browser.");return;}   
}
function showPosition(position)   
{  var lat=position.coords.latitude;   var lon=position.coords.longitude;  var alt=position.coords.altitude; var sp=position.coords.speed; var timeS=new Date(position.timestamp);
var new_pos=new OpenLayers.LonLat(lon,lat).transform(new OpenLayers.Projection("EPSG:4326"),map.getProjectionObject());
points=new OpenLayers.Geometry.Point(new_pos.lon, new_pos.lat);
var first_point= new OpenLayers.Feature.Vector(points);
var ArrayFeatures=[];var now=timeS;
var Y=now.getFullYear();
var M=now.getMonth()+1;if(parseInt(M)<10){M='0'+M;}var D=now.getDate();if(parseInt(D)<10){D='0'+D;}
var H=now.getHours();if(parseInt(H)<10){H='0'+H;}var MM=now.getMinutes();if(parseInt(MM)<10){MM='0'+MM;}
var S=now.getSeconds();if(parseInt(S)<10){S='0'+S;}var neD=Y+'-'+M+'-'+D+'T'+H+':'+MM+':'+S;
var attr={};attr.latitude=lat; attr.longitude=lon;attr.altitude=alt;attr.speed=sp;attr.time=neD;
first_point.attributes=attr;
ArrayFeatures.push(first_point);


if (document.getElementById("id_MoveMyLoc").checked==true)
{var valg=parseFloat(document.getElementById("MyPosmovemap_val").value);var x1s=lon-valg;var y1s=lat-valg;var x2s=lon+valg;var y2s=lat+valg;var bounds=new OpenLayers.Bounds(x1s,y1s,x2s,y2s);
bounds.transform(new OpenLayers.Projection("EPSG:4326"),map.getProjectionObject());
map.zoomToExtent(bounds);}

var new_layer_MyLocation = new OpenLayers.Layer.Vector(document.getElementById("id_MyLocatName").value,{renderers:["Canvas", "SVG", "VML"]});
new_layer_MyLocation.addFeatures(ArrayFeatures);
var new_style_layer= new OpenLayers.Style({
 pointRadius: 4, fillColor: "#FF9000", strokeColor: "#FF0000",
 strokeWidth: 2,fillOpacity:1, strokeOpacity:1 });
 var selStyle = new OpenLayers.Style({
 pointRadius: 5,  fillColor: "#ffaa00",
 strokeColor: "#00DDFF", strokeWidth:2,
fillOpacity:1, strokeOpacity:1 }); 
new_layer_MyLocation.styleMap=new OpenLayers.StyleMap({'default':new_style_layer,'select': selStyle});
new_layer_MyLocation.projection=new OpenLayers.Projection("EPSG:900913");
map.addLayer(new_layer_MyLocation);
var t=document.createElement('option');
t.value=new_layer_MyLocation.name;
t.text=new_layer_MyLocation.name;
document.getElementById("editL1").appendChild(t);

}
function showError(error)   
{   switch(error.code)      
{     case error.PERMISSION_DENIED:       alert("User denied the request for Geolocation.");       break;
     case error.POSITION_UNAVAILABLE:       alert("Location information is unavailable.");       break; 
    case error.TIMEOUT:       alert("The request to get user location timed out.");      break;  
   case error.UNKNOWN_ERROR:       alert("An unknown error occurred.");       break;     }   }
function OpenTable()
{
if(this.document.getElementById("editL1").value=="0")
{alert ("выберите название слоя в списке 'Редактируемый слой'");return;}
if(!edilayerMainLayer.features.length)
{alert ("Please activate Editable Layer in layer switcher");return;}
var body = document.body; var docElem = document.documentElement;
 var scrollTop = window.pageYOffset || docElem.scrollTop || body.scrollTop; var scrollLeft = window.pageXOffset || docElem.scrollLeft || body.scrollLeft
 var clientTop = docElem.clientTop || body.clientTop || 0; var clientLeft = docElem.clientLeft || body.clientLeft || 0
 var topTop = 0 + scrollTop - clientTop; var leftLeft =0 + scrollLeft - clientLeft
var DivEditeLeg=document.createElement("div");DivEditeLeg.id="id_tableOWG";
DivEditeLeg.style.width=screen.width;DivEditeLeg.style.height=screen.height;
DivEditeLeg.className="id_divRoutLegMain";DivEditeLeg.style.position="absolute";DivEditeLeg.style.display="block";DivEditeLeg.style.zIndex = 300000;DivEditeLeg.style.overflow="auto";DivEditeLeg.style.background="#ffffff";DivEditeLeg.style.border="2px solid black";DivEditeLeg.style.color="#000000";
DivEditeLeg.style.left=Math.round(document.body.clientWidth/2-100);DivEditeLeg.style.top="0px";
DivEditeLeg.innerHTML='<div class="blockbutOpen"><button type=button onclick=OpenTable()>Open table</button><button type=button display=none onclick=EditTable()>Edit table</button><div id="block_UpdateTable" class="blockUpdateTable"><button type=button onclick=UpdateTable()>Update</button></div></div><div class="ok"> <p> <button type=button onclick=OKclose()>Exit</button></p></div><center><font size=+3></font></center></div><div id="countRow"  class="blockRule" ><li> <a>count rows:</a><select id=pCount >  <option selected value="0">0</option><option value="1">1</option><option value="10">10</option><option value="20">20</option><option value="50">50</option><option value="100">100</option><option value="200">200</option><option value="300">300</option><option value="500">500</option><option value="1000">1000</option><option value="1500">1500</option><option value="2000">2000</option><option value="3000">3000</option><option value="All">All</option></select><br><input id="select_feat_map_id" type="checkbox"  value="false"><a style="font-size:12px">select features on the map</a></li></div><div id="id_ChartBlock" class="ChartBlockAreaDiv"><canvas id=id_canvas1Chart width=1000px height=640px style="display:none; border: 2px double black;"></canvas></div><div id="table" class="blockTable"></div><div id="FieldTable"  class="blockFilter" ><li> <a>Field for filter:</a><div class="blockSort"><a>Sort by</a><br><input id="sortA" type="checkbox"  value="A"  onclick=SortA()>Ascending<br><input id="sortD" type="checkbox"  value="D" onclick=SortD()>Descending</div><select id=pFieldTable>  <option selected value="0">.</option></select></li><br><li> <a>Operator</a><select id=pOperTable>  <option selected value="0">.</option> <option value=">">></option> <option value="<"><</option> <option value=">=">>=</option> <option value="<="><=</option> <option value="==">=</option></select></li><br> <input id=pInputFilterTable type="text" size="15"><br><p> <button type=button onclick=Applyfilter()>Apply filter</button></p></div><div id="CalcText" class="blockTextCalculation"><a>Calculation</a><br><textarea rows="5" title="Names of all attributes must be put in square brackets. Name of the new attribute must be without any brackets. For example: calc=[LATITUDE]/[LONGITUDE]*100+[LATITUDE] . In this example  \calc\ is the new attribute(field). Note: new attributes are not saved in shapefile or database in web-server from which the Layer was created. In order to save it in web-server, you must use menu item \Export Layer\ gml or csv file, or create shapefile in other software and then upload it in web-server. Without this you can anyway use new attribute to change legend Layer, use in all calculations and create chart in new window.Also use the functions: Math.sin ([newField]), Math.abs ([newField]), Math.cos ([newField]), Math.random (), Math.exp (([newField]), Math.sqrt ([newField] ), Math.log ([newField]) - natural logarithm, Math.pow ([newField]), x) - exponentiation x. Example, newField = (Math.cos ([SomeField1]) / Math.abs ([SomeField2])) + Math.sqrt (16) - Math.sqrt ([SomeField3]). To round numbers, you can use the notation: newField = [newField] .toFixed (x), where x is the desired number of decimal places.You can also use special formulas: mean, min, max. To find the average value for all rows in a column (attribute) SomeField you need to write newField = mean (SomeField). The square brackets in the title of the column are not needed. To find the average value in the column SomeField1 for each unique column values SomeField2, you need to write newField = mean (SomeField2, SomeField1). Similarly newField = min (SomeField2, SomeField1) and newField = count (SomeField2, SomeField1). This is useful for example to calculate the minimum or maximum, quantity of some value within each year, if you have a layer containing information about many years." cols="25" id="textCalc" name="text"></textarea><br><button type=button onclick=ApplyCalc()>Apply Calculation</button><br><input type="checkbox" id="CheckSaveOldAtt" value="checkbox"/><font size="2">Save result (it does not work for the new attribute)</font><br><input type="checkbox" id="CheckSaveTextAtt" title="if activate this checkbox, then resulted attribute will be  strings concatenation. You must use apostrophe in both side of the string.Example: calc=[LATITUDE]+&#8217text&#8217, then if [LATITUDE]=24.5 -> calc=24.5text; but if string is a number you not may use apostrophe. Example:calc=24.5+3 then calc=24.53" value="checkbox"/><a title="if activate this checkbox, then resulted attribute will be  strings concatenation. You must use apostrophe in both side of the string.Example: calc=[LATITUDE]+&#8217text&#8217, then if [LATITUDE]=24.5 -> calc=24.5text; but if strintable.htmg is a number you not may use apostrophe. Example:calc=24.5+3 then calc=24.53"><font size="2">strings concatenation</a></font><br></div><div id="CharBlockMenu" class="blockChart"><a>Chart</a><br><div style="float:left"><a>Axis X</a><select id=fieldChartX> <option selected value="0">.</option> </select></div><div onclick="OptionFuncChart()" title="open options of chart" style="cursor:pointer;float:left"><img src="img/option.png"/  width="20" height="20"></div><br><div style="float:left"><a>Axis Y</a><select id=fieldChartY>  <option selected value="0">.</option> </select></div><br><div style="float:left"><a>Axis Z </a><select id=fieldChartZ>  <option selected value="0">.</option> </select></div><br> <div style="float:left"><a style="font-size: 11px;">label by interval in X</a><input id=id_IntervalX type="text" size="2" value="2"><a style="font-size: 11px;">sum by interval in X</a><input id=id_IntervalXs type="text" size="2" value="0"></div><br> <div style="float:right"><input id="id_repeatV" type="checkbox"  value="check">merge repeated values on axis X in single value</div><br> <div id="id_correlDiv" style="float:left"><input id="id_CorrRegV" type="checkbox"  value="check">get line regression equation(y/x)</div><br><button type=button onclick=ApplyChart()>Create Chart</button><button type=button onclick=RemoveChart()>Remove Chart</button></div>';
if(!document.getElementById("id_tableOWG"))
{body.appendChild(DivEditeLeg); initTable();
document.getElementById("id_tableOWG").onmousedown=function(event){drags(event)};
document.getElementById("id_tableOWG").onmouseup=function(e){enddrag()};}
//myWinTable= open("table.htm", "AttributionTable", "width=900,height=500,status=yes,toolbar=yes,menubar=yes,scrollbars=yes");
//myWinTable.focus();
}
function CoordSet_opt()
{
var bbox = document.getElementById("map").getBoundingClientRect();
 var body = document.body; var docElem = document.documentElement;
 var scrollTop = window.pageYOffset || docElem.scrollTop || body.scrollTop; var scrollLeft = window.pageXOffset || docElem.scrollLeft || body.scrollLeft
 var clientTop = docElem.clientTop || body.clientTop || 0; var clientLeft = docElem.clientLeft || body.clientLeft || 0
 var topTop = bbox.top + scrollTop - clientTop; var leftLeft = bbox.left + scrollLeft - clientLeft
var DivEditeLeg=document.createElement("div");
DivEditeLeg.id="id_divOpGratMain2";
DivEditeLeg.className="id_divRoutLegMain";
DivEditeLeg.style.position="relative";
var dopstry='onclick=clickDivColor3d(this) style="position:relative; left:-190px;float:right;width:25px;height: 10px; border: 1px double black;cursor:pointer;background:';
DivEditeLeg.innerHTML='<div id="id_divOpGratMainLeg" style="background:#ffffff; color:#0000ff;z-index: 1000;position:absolute;left:'+Math.round(leftLeft+450)+'px;top:'+Math.round(topTop-200)+
'px;overflow:hidden; border: 1px solid black;">'+
'<a style="position:relative; top:20px"><a style="font-size: 9px;"> Вы можете перемещать это окно если щёлкните по пункту меню: Интерфейс->переключить режим интерфейса</a><img onclick="closeWearherLegendWin(this)" src="openlayers/theme/default/img/close.gif" style="position:relative; top:0px;float:right; cursor:pointer"><br>'+
'интервалы в град<input type="text" size="20" id="id_optGraticuleOWGh" title="" value="45,30,20,10,5,2,1,0.5,0.2,0.1,0.05,0.01,0.005,0.002,0.001"/><br> '+
'размер подписи<input type="text" size="2" id="id_optGraticuleOWGlabz" title="" value="12"/><br> '+
'цвет подписи:<div id="id_graticuleColorlabel" '+dopstry+'#000000"></div>'+
'<p> <button type=button onclick=OK_redrawGraticule()>OK</button></p>';
'</div>';
if(!document.getElementById("id_divOpGratMain2"))
{body.appendChild(DivEditeLeg); document.getElementById("id_divOpGratMain2").onmousedown=function(event){drags(event)};document.getElementById("id_divOpGratMain2").onmouseup=function(e){enddrag()};}
}

function OK_redrawGraticule()
{
for(var i=0;i<map.controls.length;i++)
{if(map.controls[i].CLASS_NAME=="OpenLayers.Control.Graticule")
{
var inter=document.getElementById("id_optGraticuleOWGh").value.split(",");for(var e=0;e<inter.length;e++){inter[e]=parseFloat(inter[e])}
map.controls[i].intervals=inter;
map.controls[i].labelSymbolizer.fontSize=document.getElementById("id_optGraticuleOWGlabz").value+"px";
map.controls[i].labelSymbolizer.fontColor=document.getElementById("id_graticuleColorlabel").style.backgroundColor;
map.controls[i].gratLayer.redraw()}

}

}
function CoordSet()
{//var new_layer_gratLayer = new OpenLayers.Layer.Vector("Graticule",{renderers:["Canvas", "SVG", "VML"]});
var VarDivGrad=document.getElementById("idGradiculeAtl");
if (stopGradiculeInterface==false){stopGradiculeInterface=true;VarDivGrad.firstChild.data="Сетка включена"; graticuleCtl2 = new OpenLayers.Control.Graticule({
 labelled: true,
 targetSize: 200
 });map.addControl( graticuleCtl2);
filterA=new OpenLayers.Filter.Comparison({
 type: OpenLayers.Filter.Comparison.BETWEEN,
 property: "value",
 upperBoundary: parseInt(180.0),
 lowerBoundary: parseInt(-180.0)
 })
graticuleCtl2.gratLayer.styleMap.styles.default.rules[0].filter=filterA;
graticuleCtl2.gratLayer.styleMap.styles.default.defaultStyle={};
graticuleCtl2.gratLayer.styleMap.styles.default.defaultStyle.strokeOpacity=0.5;
graticuleCtl2.gratLayer.styleMap.styles.default.defaultStyle.strokeWidth=1;
graticuleCtl2.gratLayer.styleMap.styles.default.defaultStyle.pointRadius=3;
graticuleCtl2.gratLayer.setVisibility(false);
graticuleCtl2.gratLayer.setVisibility(true);
graticuleCtl2.gratLayer.redraw()
GraticulePropertyStyles=graticuleCtl2.gratLayer.styleMap.styles.default.propertyStyles;
GraticuleRule=filterA;
for(var i=0;i<graticuleCtl2.gratLayer.features.length;i++)
{if(!graticuleCtl2.gratLayer.features[i].attributes['value']){graticuleCtl2.gratLayer.features[i].attributes['value']=0}};graticuleCtl2.gratLayer.redraw();
graticuleCtl2.gratLayer.events.register("featureadded",graticuleCtl2.gratLayer, function() {for(var i=0;i<graticuleCtl2.gratLayer.features.length;i++)
{if(!graticuleCtl2.gratLayer.features[i].attributes['value']){graticuleCtl2.gratLayer.features[i].attributes['value']=0}};graticuleCtl2.gratLayer.redraw();})
}
else{stopGradiculeInterface=false;VarDivGrad.firstChild.data="Сетка отключена";
map.removeLayer(graticuleCtl2.gratLayer);map.removeControl(graticuleCtl2);
var temp;
graticuleCtl2.gratLayer.events.unregister("featureadded",graticuleCtl2.gratLayer, function() {});
graticuleCtl2.gratLayer=temp;
var graticuleCtl3;
graticuleCtl2=graticuleCtl3;
}
}
function SetDefaultInterface()
{
document.body.style.backgroundColor="rgb(153, 217, 234)";
document.getElementById("map").style.width="1000px";
document.getElementById("map").style.height="600px" ;
document.getElementById("mapResize").style.top="174px";
document.getElementById("mapResize").style.left="252px";
document.getElementById("external_control2").style.backgroundColor="rgba(239, 228, 176,0.5)";
document.getElementById("drag").style.top="174px";
document.getElementById("drag").style.left="-4px";
document.getElementById("dragMenu").style.top="123px";
document.getElementById("dragMenu").style.left="4px";
document.getElementById("id_menu").style.backgroundColor="rgb(80, 240, 120)";
document.getElementById("dragEditLayer").style.top="159px"; 
document.getElementById("dragEditLayer").style.left="29px";
document.getElementById("dragCoord").style.top="163px"; 
document.getElementById("dragCoord").style.left="579px"; 
document.getElementById("dragScale").style.top="157px"; 
document.getElementById("dragScale").style.left="425px";
document.getElementById("dragToolbar_opt").style.top="218px";
document.getElementById("dragToolbar_opt").style.left="343px";
document.getElementById("OpenStreetMapIdSearch").style.top="90px";
document.getElementById("OpenStreetMapIdSearch").style.left="410px";
document.getElementById("OpenWikipediaSearch").style.top="90px";
document.getElementById("OpenWikipediaSearch").style.left="977px";
var r=document.getElementById("id_block_menu"); 
if(r&&r.childNodes[0].id&&r.childNodes[0].id=="changeMenubr_"+0)
{changeMenu();}

}
function SaveInterface()
{
localStorage["bodyColor2"]=document.body.style.backgroundColor;
localStorage["mapWidth2"]=document.getElementById("map").style.width;
localStorage["mapHeight2"]=document.getElementById("map").style.height;
localStorage["mapLeft2"]=document.getElementById("mapResize").style.left;
localStorage["mapTop2"]=document.getElementById("mapResize").style.top;
localStorage["LayerSwitcher2"]=document.getElementById("external_control2").style.backgroundColor;
localStorage["LayerSwitcherTop2"]=document.getElementById("drag").style.top;
localStorage["LayerSwitcherLeft2"]=document.getElementById("drag").style.left;
localStorage["dragMenuTop2"]=document.getElementById("dragMenu").style.top;
localStorage["dragMenuLeft2"]=document.getElementById("dragMenu").style.left;
localStorage["menu2"]=document.getElementById("id_menu").style.backgroundColor;
localStorage["dragEditLayerTop2"]=document.getElementById("dragEditLayer").style.top;
localStorage["dragEditLayerLeft2"]=document.getElementById("dragEditLayer").style.left;
localStorage["dragCoordTop2"]=document.getElementById("dragCoord").style.top;
localStorage["dragCoordLeft2"]=document.getElementById("dragCoord").style.left;
localStorage["dragScaleTop2"]=document.getElementById("dragScale").style.top;
localStorage["dragScaleLeft2"]=document.getElementById("dragScale").style.left;
localStorage["dragToolbar_optTop2"]=document.getElementById("dragToolbar_opt").style.top;
localStorage["dragToolbar_optLeft2"]=document.getElementById("dragToolbar_opt").style.left;
localStorage["OpenStreetMapIdSearchLeft"]=document.getElementById("OpenStreetMapIdSearch").style.left;
localStorage["OpenStreetMapIdSearchTop"]=document.getElementById("OpenStreetMapIdSearch").style.top;
localStorage["OpenWikipediaSearchLeft"]=document.getElementById("OpenWikipediaSearch").style.left;
localStorage["OpenWikipediaSearchTop"]=document.getElementById("OpenWikipediaSearch").style.top;
var r=document.getElementById("id_block_menu"); 
if(r&&r.childNodes[0].id&&r.childNodes[0].id=="changeMenubr_"+0)
{localStorage["changeMenubrYes"]='changeMenubrYes';}
else{localStorage["changeMenubrYes"]='changeMenubrNo';}
}
function SaveProject2()
{
if(!window.localStorage){alert("Your browser can not work with this function. Please upgrade"); return;}

var DataProjectWebGis='';
for(var i=0;i<map.layers.length;i++)
{
if(map.layers[i].CLASS_NAME=='OpenLayers.Layer.Vector')
{var jsonstring='';
var format = new OpenLayers.Format.GeoJSON({ 'internalProjection': new OpenLayers.Projection("EPSG:900913"),
'externalProjection': new OpenLayers.Projection("EPSG:900913")});
if(map.layers[i].features)
 {
if(map.layers[i].protocol&&map.layers[i].protocol.featureType){jsonstring ='';
if(map.layers[i].features[0]&&map.layers[i].features[0].cluster)
{
var featuresClust=[];
for(var se=0;se<map.layers[i].features.length;se++)
  {
if(map.layers[i].features[se].cluster){for(var se2=0;se2<map.layers[i].features[se].cluster.length;se2++){featuresClust.push(map.layers[i].features[se].cluster[se2].clone());}} }
jsonstring = format.write(featuresClust);
}

}
if(!map.layers[i].protocol||!map.layers[i].protocol.featureType){
if(map.layers[i].features[0]&&!map.layers[i].features[0].cluster)
{jsonstring = format.write(map.layers[i].features);}
else{var featuresClust=[];
for(var se=0;se<map.layers[i].features.length;se++)
  {
if(map.layers[i].features[se].cluster){for(var se2=0;se2<map.layers[i].features[se].cluster.length;se2++){featuresClust.push(map.layers[i].features[se].cluster[se2].clone());}} }
jsonstring = format.write(featuresClust);
}
}
}
var rules='';
for(var k=0;k<map.layers[i].styleMap.styles.default.rules.length;k++)
{rules+=" count="+map.layers[i].styleMap.styles.default.rules.length+" endCon "+" filt_"+k+" "+JSON.stringify(map.layers[i].styleMap.styles.default.rules[k].filter,function(key, value) { 
 if (typeof key !== 'function'&& key !=='__proto__') {return value;}} ) 
rules+=" sym_"+k+" "+JSON.stringify(map.layers[i].styleMap.styles.default.rules[k].symbolizer)+" Esym_"+k+" "
}
var ObjProtocol='';
if(map.layers[i].protocol)
{
ObjProtocol={ "url": map.layers[i].protocol.url,"featurePrefix":map.layers[i].protocol.featurePrefix,
"geometryName":map.layers[i].protocol.geometryName,"featureNS":map.layers[i].protocol.featureNS,"featureType":map.layers[i].protocol.featureType}
}
var proj=map.layers[i].projection.projCode;
rtt=map.layers[i].strategies;
var strag=0;
strag=0;
if(map.layers[i].strategies){
for(var n=0;n<map.layers[i].strategies.length;n++)
{
strag++;;
if(map.layers[i].strategies[n].CLASS_NAME=='OpenLayers.Strategy.Cluster'){strag=3+"/ ; /"+map.layers[i].strategies[n].distance;}
if(map.layers[i].strategies[n].CLASS_NAME=='OpenLayers.Strategy.AttributeCluster'){strag=4+"/_/ "+map.layers[i].strategies[n].attribute+" ; "+map.layers[i].strategies[n].distance}
if(map.layers[i].strategies[n].CLASS_NAME=='OpenLayers.Strategy.RuleCluster'){strag=5+"/_/ "+map.layers[i].strategies[n].options.rule.filter.property+" ; "+map.layers[i].strategies[n].options.rule.filter.type+" : "+map.layers[i].strategies[n].options.rule.filter.value+"/;/"+map.layers[i].strategies[n].distance;}
}}
var EditTextLegendWebGis=''
if(typeof map.layers[i].EditTextLegendWebGis!=="undefined")
{EditTextLegendWebGis=map.layers[i].EditTextLegendWebGis;}
var centrMapLon=map.getCenter().lon;
var centrMapLat=map.getCenter().lat;
var MapProj=map.baseLayer.projection.projCode;var weatherOWM='';
if(map.layers[i].attribution=='Weather from <a href="http://openweathermap.org/" alt="World Map and worldwide Weather Forecast online">OpenWeatherMap</a>')
{if(map.layers[i].features[0]){if(map.layers[i].features[0].attributes.stationType){weatherOWM=' startOWMdowg '+'yesOWMstan'+' endOWMdowg ';}}
if(map.layers[i].features[0]){if(!map.layers[i].features[0].attributes.stationType){weatherOWM=' startOWMdowg '+'yesOWMweath'+' endOWMdowg ';}}
jsonstring='';}
DataProjectWebGis+=" LayerWMSWFS "+" StartlayerWebgisName "+map.layers[i].name+" EndlayerWebgisName "+" visL "+map.layers[i].visibility+" visLE "+jsonstring+" SstyleDef "+JSON.stringify(map.layers[i].styleMap.styles.default.defaultStyle)+
" rulWeb "+rules+
" SstyleSel "+JSON.stringify(map.layers[i].styleMap.styles.select.defaultStyle)+" Endstyle "+" Startprotocol "+JSON.stringify(ObjProtocol)+" Endprotocol "+" projW "+proj+" Eproj "+" strag "+strag+" Estrag "+" editLeg "+
EditTextLegendWebGis+" EeditLeg "+" startIsBaseLVect "+map.layers[i].isBaseLayer+"_"+map.layers[i].numZoomLevels+" endIsBaseLVect "+weatherOWM;
 }
if(map.layers[i].CLASS_NAME=='OpenLayers.Layer.Image')
{var objWms={}
objWms["extent"]='new OpenLayers.Bounds('+map.layers[i].extent.left+','+map.layers[i].extent.bottom+','+map.layers[i].extent.right+','+map.layers[i].extent.top+')';
objWms["url"]=map.layers[i].url;
objWms["name"]=map.layers[i].name;
objWms["visibility"]=map.layers[i].visibility;
objWms["opacity"]=map.layers[i].opacity;
var objWms=JSON.stringify(objWms);
DataProjectWebGis+=" LayerWMSWFS "+" StartlayerImage "+objWms+" ELayImage "+" startIsImBaseLVect "+map.layers[i].isBaseLayer+"_"+map.layers[i].numZoomLevels+" endIsImBaseLVect ";
}

if(map.layers[i].CLASS_NAME=='OpenLayers.Layer.WMS'&&map.layers[i].isBaseLayer!==true)
{
var objWms={}
objWms["isBaseLayer"]=false;
objWms["queryable"]=true;
//objWms["projection"]='new OpenLayers.Projection(map.layers[i].projection.projCode)';
objWms["projection"]=map.layers[i].projection.projCode;
//objWms["minResolution"]=null;
if(map.layers[i].minResolution)
{objWms["minResolution"]=map.layers[i].minResolution;} else{objWms["minResolution"]=null;}
//objWms["maxResolution"]=156543.03390625;
if(map.layers[i].maxResolution)
{objWms["maxResolution"]=map.layers[i].maxResolution;}else{objWms["maxResolution"]=156543.03390625;}

objWms["numZoomLevels"]=32;
//objWms["maxScale"]=null;
//objWms["minScale"]=null;
objWms["maxScale"]=map.layers[i].maxScale;
objWms["minScale"]=map.layers[i].minScale;;
objWms["maxExtent"]='new OpenLayers.Bounds(-20037508.34, -20037508.34, 20037508.34, 20037508.34)';
//objWms["minExtent"]=null;
objWms["minExtent"]=map.layers[i].minExtent;
objWms["opacity"]=map.layers[i].opacity;
objWms["visibility"]=map.layers[i].visibility;
var sldbodyOWG='sldbodyOWG';
if(typeof map.layers[i].params!=='undefined'&&typeof map.layers[i].params.SLD_BODY!=='undefined')
{sldbodyOWG+=map.layers[i].params.SLD_BODY;}
var objWms=JSON.stringify(objWms);
DataProjectWebGis+=" LayerWMSWFS "+" StartlayerWMS "+map.layers[i].name+" EStartlayerWMS "+objWms+ " EObjL "+map.layers[i].url+" EWMSurl "+" LayWMS "+map.layers[i].params.LAYERS+sldbodyOWG+" ELayWMS ";
/**/
 }
 if(map.layers[i].CLASS_NAME=='OpenLayers.Layer.XYZ')
{
var objWms={};objWms["isBaseLayer"]=map.layers[i].isBaseLayer;
objWms["queryable"]=true;objWms["projection"]=map.layers[i].projection.projCode;
if(map.layers[i].minResolution){objWms["minResolution"]=map.layers[i].minResolution;} else{objWms["minResolution"]=null;}
if(map.layers[i].maxResolution){objWms["maxResolution"]=map.layers[i].maxResolution;}else{objWms["maxResolution"]=156543.03390625;}
objWms["numZoomLevels"]=32;objWms["maxScale"]=map.layers[i].maxScale;objWms["minScale"]=map.layers[i].minScale;;
objWms["maxExtent"]='new OpenLayers.Bounds(-20037508.34, -20037508.34, 20037508.34, 20037508.34)';
objWms["minExtent"]=map.layers[i].minExtent;objWms["opacity"]=map.layers[i].opacity;objWms["visibility"]=map.layers[i].visibility;
if(map.layers[i].CLASS_NAME=="OpenLayers.Layer.XYZ"){objWms["XYZ"]='truexyz';}
var sldbodyOWG='sldbodyOWG';
if(typeof map.layers[i].params!=='undefined'&&typeof map.layers[i].params.SLD_BODY!=='undefined')
{sldbodyOWG+=map.layers[i].params.SLD_BODY;}; var objWms=JSON.stringify(objWms);
DataProjectWebGis+=" LayerWMSWFS "+" StartlayerWMS "+map.layers[i].name+" EStartlayerWMS "+objWms+ " EObjL "+map.layers[i].url+" EWMSurl "+" LayWMS "+map.layers[i].params.LAYERS+sldbodyOWG+" ELayWMS ";
 }
if((map.layers[i].CLASS_NAME=='OpenLayers.Layer.WMS'&&map.layers[i].isBaseLayer==true)||map.layers[i].CLASS_NAME=='OpenLayers.Layer.OSM'||map.layers[i].CLASS_NAME=='OpenLayers.Layer.Google')
{
var objWms={}
objWms["isBaseLayer"]=true;
objWms["queryable"]=true;
objWms["projection"]=map.layers[i].projection.projCode;
if(map.layers[i].minResolution)
{objWms["minResolution"]=map.layers[i].minResolution;} else{objWms["minResolution"]=null;}
if(map.layers[i].maxResolution)
{objWms["maxResolution"]=map.layers[i].maxResolution;}else{objWms["maxResolution"]=156543.03390625;}
objWms["numZoomLevels"]=map.layers[i].numZoomLevels;
objWms["maxScale"]=map.layers[i].maxScale;
objWms["minScale"]=map.layers[i].minScale;;
objWms["maxExtent"]='new OpenLayers.Bounds(-20037508.34, -20037508.34, 20037508.34, 20037508.34)';
objWms["minExtent"]=map.layers[i].minExtent;
objWms["opacity"]=map.layers[i].opacity;
objWms["url"]=map.layers[i].url;
objWms["visibility"]=map.layers[i].visibility;
if(map.layers[i].name=="Google Maps....")
{objWms["url"]=map.layers[i].type;}
var objWms=JSON.stringify(objWms);

if(map.layers[i].CLASS_NAME!=='OpenLayers.Layer.OSM'&&map.layers[i].CLASS_NAME!=='OpenLayers.Layer.Google')
{DataProjectWebGis+=" LayerWMSWFS "+" StartlayerWMS "+map.layers[i].name+" EStartlayerWMS "+objWms+ " EObjL "+map.layers[i].url+" EWMSurl "+" LayWMS "+map.layers[i].params.LAYERS+" ELayWMS ";}
else
{DataProjectWebGis+=" LayerWMSWFS "+" StartlayerWMS "+map.layers[i].name+" EStartlayerWMS "+objWms+ " EObjL "+map.layers[i].url+" EWMSurl "+" LayWMS "+''+" ELayWMS ";}
/**/
 }


}
DataProjectWebGis+=" lonCen "+centrMapLon+" ElonCen "+" latCen "+centrMapLat+" ElatCen "+" mapZ "+map.zoom+" EmapZ "+" mapProj "+MapProj+" EmapProj ";
//localStorage["Project"]=DataProjectWebGis;
if(document.getElementById("id_LinkSaveInterface")&&document.getElementById("id_LinkSaveInterface").checked==true)
{
var r=document.getElementById("id_block_menu"); var changeMenubr='cMenubrNo';
if(r.childNodes[0].id&&r.childNodes[0].id=="changeMenubr_"+0){changeMenubr='cMenubrYes';}
DataProjectWebGis+=" InterfaceSave "+";"+document.body.style.backgroundColor+";"+document.getElementById("map").style.width+";"+document.getElementById("map").style.height+";"+
document.getElementById("mapResize").style.left+";"+document.getElementById("mapResize").style.top+";"+document.getElementById("external_control2").style.backgroundColor+";"+
document.getElementById("drag").style.top+";"+document.getElementById("drag").style.left+";"+document.getElementById("dragMenu").style.top+";"+
document.getElementById("dragMenu").style.left+";"+document.getElementById("id_menu").style.backgroundColor+";"+document.getElementById("dragEditLayer").style.top+";"+
document.getElementById("dragEditLayer").style.left+";"+document.getElementById("dragCoord").style.top+";"+document.getElementById("dragCoord").style.left+";"+
document.getElementById("dragScale").style.top+";"+document.getElementById("dragScale").style.left+";"+document.getElementById("dragToolbar_opt").style.top+";"+
document.getElementById("dragToolbar_opt").style.left+";"+document.getElementById("OpenStreetMapIdSearch").style.left+";"+document.getElementById("OpenStreetMapIdSearch").style.top+";"+
document.getElementById("OpenWikipediaSearch").style.left+";"+document.getElementById("OpenWikipediaSearch").style.top+";"+changeMenubr+";"+" InterfaceSaveEnd ";
var divSeparateL=document.getElementsByTagName("div");var divSeparateLS='';
for(var sd=0;sd<divSeparateL.length;sd++)
{if(divSeparateL[sd].id=='id_divSepTableImage')
{divSeparateLS+=" divsepoewg_ "+divSeparateL[sd].innerHTML+" owgs;owgs "+divSeparateL[sd].style.cssText+" owg;owg ";}
}
if(divSeparateLS!=='')
{divSeparateLS=" InterfSepDSaveStart "+divSeparateLS+" InterfSepDSaveEnd ";DataProjectWebGis+=divSeparateLS; }
}
if(document.getElementById("id_EmbSaveClearMap")&&document.getElementById("id_EmbSaveClearMap").checked==true)
{DataProjectWebGis+=" ClearMapOWG "+" ClearMapEndOWG"}
if(document.getElementById("timsaveTimeLinelink")&&document.getElementById("timsaveTimeLinelink").checked==true&&document.getElementById("id_TimeLineLegMain2"))
{var time1=document.getElementById("TimeLayerField").value; var time2=document.getElementById("htmlTimeYear1").value;var time3=document.getElementById("htmlTimeMonth1").value;
var time4=document.getElementById("htmlTimeDay1").value;var time5=document.getElementById("htmlTimeHour1").value;var time6=document.getElementById("htmlTimeMin1").value;
var time7=document.getElementById("htmlTimeSec1").value;
var time8=document.getElementById("htmlTimeYear2").value;var time9=document.getElementById("htmlTimeMonth2").value;
var time10=document.getElementById("htmlTimeDay2").value;var time11=document.getElementById("htmlTimeHour2").value;var time12=document.getElementById("htmlTimeMin2").value;
var time13=document.getElementById("htmlTimeSec2").value;
var timeInF=document.getElementById("TimeInterField").value;var timeMils=document.getElementById("id_milisecAtl").value;if(document.getElementById("id_MoveTimeWmap").checked==true){var moveMap=true;}else{var moveMap=false;};
if(document.getElementById("id_previousDateTime").checked==true){var prevMap=true;}else{var prevMap=false;}
var prevMapval=document.getElementById("id_MoveTimeWmap_val").value;var divleft=document.getElementById("id_TimeLineLegMain2").style.left; var divTop=document.getElementById("id_TimeLineLegMain2").style.top;var heattime="0";
if(document.getElementById("id_heatmapDateTime")){if(document.getElementById("id_heatmapDateTime").checked==true&&document.getElementById("id_heatmapDateTime").heatmaplayer){heattime="HeatmapName_OWG_"+document.getElementById("id_heatmapDateTime").heatmaplayer;}}
var osm25dtime="0";
if(document.getElementById("id_25dDateTime")){if(document.getElementById("id_25dDateTime").checked==true&&document.getElementById("id_25dDateTime").layer25D){osm25dtime="osm25dName_OWG_"+document.getElementById("id_25dDateTime").layer25D;}}
var numberT='';
if(TimeFieldowg=="number"){numberT=" TimeLineOpenWebNumbers "+"number"+","+document.getElementById("htmlTimeNum1").value+","+document.getElementById("htmlTimeInterN").value+","+document.getElementById("htmlTimeNum2").value+" TimeLineOpenWebNumbere "}
DataProjectWebGis+=" TimeLineOpenWebStart "+";"+time1+";"+time2+";"+time3+";"+time4+";"+time5+";"+time6+";"+time7+";"+time8+";"+time9+";"+time10+";"+time11+";"+time12+";"+time13+";"+timeInF+";"+timeMils+";"+moveMap+";"+prevMap+";"+edilayerMainLayer.name+";"+prevMapval+";"
+divleft+";"+divTop+";"+heattime+";"+numberT+";"+osm25dtime+";"+" TimeLineOpenWebEnd";

}
DataProjectWebGis+=" MapColorback " +document.getElementById("map").style.backgroundColor+" endMapColorback ";
for(var rew=0; rew<map.layers.length;rew++)
{if(!map.layers[rew].customJson&&map.layers[rew].attribution&&map.layers[rew].attribution=='&copy; <a href="http://osmbuildings.org">OSM Buildings</a>')
{if(map.layers[rew].wallColor){var c1=map.layers[rew].wallColor; var c2=map.layers[rew].roofColor;var c3=map.layers[rew].shadow; var c4=map.layers[rew].opacityOSMbuild;var c5=map.layers[rew].visibility;}else{var c1='';var c2='';var c3='';var c4='';var c5=map.layers[rew].visibility}
DataProjectWebGis+=" OSMBowgS "+rew+";"+c1+";"+c2+";"+c3+";"+c4+";"+c5+";"+" endOSMBowgS "} }
var OSMBowgScust1=" OSMBowgScust ";var OSMBowgScust2=" endOSMBowgScust "; var OSMBowgScustNew='';
for(var rew=0; rew<map.layers.length;rew++)
{
if(map.layers[rew].customJson&&map.layers[rew].attribution&&map.layers[rew].attribution=='&copy; <a href="http://osmbuildings.org">OSM Buildings</a>')
{if(map.layers[rew].wallColor){var c1=map.layers[rew].wallColor; var c2=map.layers[rew].roofColor;var c3=map.layers[rew].shadow;var c4=map.layers[rew].opacityOSMbuild;var c5=map.layers[rew].visibility;}else{var c1='';var c2='';var c3='';var c4='';var c5=map.layers[rew].visibility}
OSMBowgScustNew+=" OSMBowgScustL "+rew+" owg; "+c1+" owg; "+c2+" owg; "+c3+" owg; "+map.layers[rew].customJson+" owg; "+map.layers[rew].name+" owg; "+c4+" owg; "+c5+" owg; "+" endOSMBowgScustL "}
}
var listEnd1='';
if(OSMBowgScustNew!==''){ 
for(var ij=0;ij<map.layers.length;ij++)
{if(map.layers[ij].isBaseLayer==false)
{listEnd1+=map.layers[ij].name+"_owgosmb "+";"+map.layers[ij].getZIndex()+";"+ij+";";}}
listEnd1=" startOSMBlasl "+listEnd1+" endOSMBlasl "

OSMBowgScustNew=OSMBowgScust1+OSMBowgScustNew+listEnd1+OSMBowgScust2;}
DataProjectWebGis+=OSMBowgScustNew;
var OWGHeatmaps=''; var OWGHeatmapsStart=' startOWGHeatmaps '; var OWGHeatmapsEnd=' endOWGHeatmaps ';var listHeatL='';
for(var rew=0; rew<map.layers.length;rew++)
{if(map.layers[rew].heatmapparams)
{var objparh=JSON.stringify(map.layers[rew].heatmapparams);var objparF=JSON.stringify(map.layers[rew].featuresH);
listHeatL+=" startHeatlasl "+" snameowgHeatn "+map.layers[rew].name+";"+map.layers[rew].visibility+";"+rew+";"+map.layers[rew].getZIndex()+" enameowgHeatn "+" startOWGParamH "+objparh+" endOWGParamH "+" startOWGParamF "+objparF+" endOWGParamF "+" endHeatlasl "
}  }
if(listHeatL!==''){OWGHeatmaps= OWGHeatmapsStart+listHeatL+OWGHeatmapsEnd;}
DataProjectWebGis+=OWGHeatmaps;

var OWGIDWmaps=''; var OWGIDWmapsStart=' startOWGIDWmaps '; var OWGIDWmapsEnd=' endOWGIDWmaps ';var listIDWL='';
for(var rew=0; rew<map.layers.length;rew++)
{if(map.layers[rew].idwmapparams)
{var objparh=JSON.stringify(map.layers[rew].idwmapparams);var objparF=JSON.stringify(map.layers[rew].featuresIn);
listIDWL+=" startIDWlasl "+" snameowgIDWn "+map.layers[rew].name+";"+map.layers[rew].visibility+";"+rew+";"+map.layers[rew].getZIndex()+" enameowgIDWn "+" startOWGParamI "+objparh+" endOWGParamI "+" startOWGParamFi "+objparF+" endOWGParamFi "+" endIDWlasl "
}  }
if(listIDWL!==''){OWGIDWmaps= OWGIDWmapsStart+listIDWL+OWGIDWmapsEnd;}
DataProjectWebGis+=OWGIDWmaps;

if(document.getElementById("id_div3dMapMain2"))
{var str3dowg=''; var objprimitiv={};var s3dentity='';

var posDiv=document.getElementById("id_div3dMapMain2").style.left+";"+document.getElementById("id_div3dMapMain2").style.top;
var str3dowg=document.getElementById(map.layerContainerDiv.id+"3d").childNodes[0].style.width+";"+document.getElementById(map.layerContainerDiv.id+"3d").childNodes[0].style.height+";"+document.getElementById(map.layerContainerDiv.id+"3d").style.left+";"+document.getElementById(map.layerContainerDiv.id+"3d").style.top;
var sel3dbase=document.getElementById("BaseLayer_id3d").value;
for (var wd=0;wd<globalwidg3dowg.scene.primitives.length;wd++)
{var tpr=wd+"layerimg"; var tb=globalwidg3dowg.scene.primitives.get(wd).rectangle;
if(tb){objprimitiv[tpr]={"1":((tb.west*180)/Math.PI),"2":((tb.south*180)/Math.PI),"3":((tb.east*180)/Math.PI),"4":((tb.north*180)/Math.PI),"5":globalwidg3dowg.scene.primitives.get(wd).material._template.uniforms.image}}
}
var posCam=globalwidg3dowg.scene.camera.position.x+";"+globalwidg3dowg.scene.camera.position.y+";"+globalwidg3dowg.scene.camera.position.z+";"+globalwidg3dowg.scene.camera.direction.x+";"+globalwidg3dowg.scene.camera.direction.y+";"+globalwidg3dowg.scene.camera.direction.z+";"+globalwidg3dowg.scene.camera.right.x+";"+globalwidg3dowg.scene.camera.right.y+";"+globalwidg3dowg.scene.camera.right.z+";"+globalwidg3dowg.scene.camera.up.x+";"+globalwidg3dowg.scene.camera.up.y+";"+globalwidg3dowg.scene.camera.up.z+";"+posDiv;
if(globalwidg3dEntity!==0)
{
s3dentity=JSON.stringify(globalwidg3dEntity);
}
DataProjectWebGis+=" map3dOWGs "+JSON.stringify(objprimitiv)+" map3dOWGss "+str3dowg+";"+sel3dbase+";"+posCam+" map3dOWGes "+" map3dOWGents " +s3dentity+" map3dOWGente "+" map3dOWGwmss " + JSON.stringify(globalwidg3dWMS)+" map3dOWGwmse "+" map3dOWGe ";

}

if(document.getElementById("editL1").value!=="0")
{DataProjectWebGis+=" edilLayerOWG "+edilayerMainLayer.name+" endedilLayerOWG ";}
return DataProjectWebGis;
}
function SaveProject()
{
localStorage["Project"]=SaveProject2()
alert("OK. Проект сохранён в локальном хранилище (local Storage) вашего браузера");
}
function LoadProject(loadfree)
{localStorageOpenWebGIS=localStorageOpenWebGIS.replace(/ ;and_owg; /g,"&");
if(loadfree!==true)
{if(!window.localStorage["Project"]||localStorage["Project"]==''){alert("No saved project"); return;}}
var g=map.layers.length;var ListL=document.getElementById('editL1');
var seldel = document.getElementById("editL1");
         while (seldel.childNodes.length) {
    if (seldel.firstChild.tagName == 'OPTGROUP') {
    while (seldel.firstChild.childNodes.length) {
    seldel.firstChild.removeChild(seldel.firstChild.firstChild);
    }
    }
    seldel.removeChild(seldel.firstChild);
    }
    var er=this.document.createElement('option');
er.value='0';
er.text='';
document.getElementById("editL1").appendChild(er);



for(var i=0;i<g;i++)
 {
if(map.layers[i].CLASS_NAME=='OpenLayers.Layer.Vector')
 {
for (var k=0; k<ListL.length; k++)
{if(ListL.options[k].value==map.layers[i].name){ListL.removeChild(ListL.options[k]);}}
map.removeLayer(map.layers[i]);
i=i-1;
g=g-1;
 }
 }
for(var i=0;i<g;i++)
{
map.removeLayer(map.layers[i]);
i=i-1;
g=g-1;
}
if(loadfree!==true)
{var lonCent=localStorage["Project"].split(" lonCen ")[1].split(" ElonCen ")[0];
var latCent=localStorage["Project"].split(" latCen ")[1].split(" ElatCen ")[0];
var zoom=localStorage["Project"].split(" mapZ ")[1].split(" EmapZ ")[0];
var mapProj=localStorage["Project"].split(" mapProj ")[1].split(" EmapProj ")[0];
//map.baseLayer.projection=new OpenLayers.Projection(mapProj);
var LisLayer=localStorage["Project"].split(" LayerWMSWFS ");}
else
{
var lonCent=localStorageOpenWebGIS.split(" lonCen ")[1].split(" ElonCen ")[0];
var latCent=localStorageOpenWebGIS.split(" latCen ")[1].split(" ElatCen ")[0];
var zoom=localStorageOpenWebGIS.split(" mapZ ")[1].split(" EmapZ ")[0];
var mapProj=localStorageOpenWebGIS.split(" mapProj ")[1].split(" EmapProj ")[0];
//map.baseLayer.projection=new OpenLayers.Projection(mapProj);
var LisLayer=localStorageOpenWebGIS.split(" LayerWMSWFS ");}


var layersArray=[]; var featuresArray=[];
for(var i=1;i<LisLayer.length;i++)
 {
if(LisLayer[i].split(" StartlayerWebgisName ")[1]){
var newSaved_layer = new OpenLayers.Layer.Vector(LisLayer[i].split(" StartlayerWebgisName ")[1].split(" EndlayerWebgisName ")[0],{renderers:["Canvas", "SVG", "VML"]});
var format2 = new OpenLayers.Format.GeoJSON({ 
 'internalProjection': new OpenLayers.Projection("EPSG:900913"),
'externalProjection': new OpenLayers.Projection("EPSG:900913")
});
var strFeature=LisLayer[i].split(" visLE ")[1].split(" SstyleDef ")[0];
if(strFeature!=='')
{features=format2.read(strFeature);
for(var jr=0;jr<features.length;jr++)
{for (var ir in features[jr].attributes)
{if(features[jr].attributes[ir]&&features[jr].attributes[ir].search){if(features[jr].attributes[ir].search(/<img src=data:image\//g)!==-1){var str1=features[jr].attributes[ir].split('<img src=data:image/')[1].split(' style=width')[0]; str1=str1.replace(/\s/g,"+"); features[jr].attributes[ir]="<img src=data:image/"+str1+" style=width"+features[jr].attributes[ir].split(' style=width')[1];}}
}}
}
else
{features=[];}
var ObjProtocol;
var strObjProtocol=null;
ObjProtocol=JSON.parse(LisLayer[i].split(" Startprotocol ")[1].split(" Endprotocol ")[0]);
if(ObjProtocol.featureType)
{newSaved_layer.protocol=new OpenLayers.Protocol.WFS(OpenLayers.Util.applyDefaults({featureType:ObjProtocol.featureType}, ObjProtocol));strObjProtocol=new OpenLayers.Protocol.WFS(OpenLayers.Util.applyDefaults({featureType:ObjProtocol.featureType}, ObjProtocol));}
newSaved_layer.projection=new OpenLayers.Projection(LisLayer[i].split(" projW ")[1].split(" Eproj ")[0]);
var StrStrat=null;
if(LisLayer[i].split(" strag ")[1].split(" Estrag ")[0]==1)
{newSaved_layer.strategies=[saveStrategy];StrStrat=[saveStrategy];}
if(LisLayer[i].split(" strag ")[1].split("Estrag ")[0]==2)
{newSaved_layer.strategies=[new OpenLayers.Strategy.Fixed(),saveStrategy];StrStrat=[saveStrategy,new OpenLayers.Strategy.Fixed()];}
if(LisLayer[i].split(" strag ")[1].split("Estrag ")[0].split("/ ; /")[0]==3)
{var stcl=new OpenLayers.Strategy.Cluster();stcl.distance=parseFloat(LisLayer[i].split(" strag ")[1].split("Estrag ")[0].split("/ ; /")[1]);newSaved_layer.strategies=[stcl,saveStrategy];StrStrat=[saveStrategy,stcl];}
if(LisLayer[i].split(" strag ")[1].split("Estrag ")[0].split("/_/ ")[0]==4)
{OpenLayers.Strategy.AttributeCluster = OpenLayers.Class(OpenLayers.Strategy.Cluster, {
        attribute: null,shouldCluster: function(cluster, feature) {
        var cc_attrval = cluster.cluster[0].attributes[this.attribute];
        var fc_attrval = feature.attributes[this.attribute]; var superProto = OpenLayers.Strategy.Cluster.prototype;
        return cc_attrval === fc_attrval &&superProto.shouldCluster.apply(this, arguments);    },
    CLASS_NAME: "OpenLayers.Strategy.AttributeCluster"});
  var stcl=new OpenLayers.Strategy.AttributeCluster({attribute:LisLayer[i].split(" strag ")[1].split("Estrag ")[0].split("/_/ ")[1].split(" ; ")[0]                })
stcl.distance=parseFloat(LisLayer[i].split(" strag ")[1].split("Estrag ")[0].split("/_/ ")[1].split(" ; ")[1]);newSaved_layer.strategies=[stcl,saveStrategy];StrStrat=[saveStrategy,stcl];}
if(LisLayer[i].split(" strag ")[1].split("Estrag ")[0].split("/_/ ")[0]==5)
{OpenLayers.Strategy.RuleCluster = OpenLayers.Class(OpenLayers.Strategy.Cluster, {
       rule: null,shouldCluster: function(cluster, feature) {
        var superProto = OpenLayers.Strategy.Cluster.prototype;
        return this.rule.evaluate(cluster.cluster[0]) &&
               this.rule.evaluate(feature) &&superProto.shouldCluster.apply(this, arguments);},
    CLASS_NAME: "OpenLayers.Strategy.RuleCluster"});

  var stcl=new OpenLayers.Strategy.RuleCluster({
rule: new OpenLayers.Rule({ filter: new OpenLayers.Filter.Comparison({
                            type: LisLayer[i].split(" strag ")[1].split("Estrag ")[0].split("/_/ ")[1].split(" ; ")[1].split(" : ")[0],
                            property: LisLayer[i].split(" strag ")[1].split("Estrag ")[0].split("/_/ ")[1].split(" ; ")[0],
                            value: LisLayer[i].split(" strag ")[1].split("Estrag ")[0].split("/_/ ")[1].split(" ; ")[1].split(" : ")[1].split("/:/")[0]
                        })
                    })
                })
stcl.distance=parseFloat(LisLayer[i].split(" strag ")[1].split("Estrag ")[0].split("/_/")[1].split(" ; ")[1].split(" : ")[1].split("/:/")[1]);newSaved_layer.strategies=[stcl,saveStrategy];StrStrat=[saveStrategy,stcl];}
var bool='';
if(LisLayer[i].split(" visL ")[1].split(" visLE ")[0]=="true")
{bool=true;}else{bool=false;}
newSaved_layer.setVisibility(bool);
newSaved_layer.styleMap.styles.default.defaultStyle=JSON.parse(LisLayer[i].split(" SstyleDef ")[1].split(" rulWeb ")[0]);
newSaved_layer.styleMap.styles.select.defaultStyle=JSON.parse(LisLayer[i].split(" SstyleSel ")[1].split(" Endstyle ")[0]);
rtt=newSaved_layer.styleMap.styles.default;
newSaved_layer= new OpenLayers.Layer.Vector(LisLayer[i].split(" StartlayerWebgisName ")[1].split(" EndlayerWebgisName ")[0], {
strategies:StrStrat,
 visibility: bool,styleMap: new OpenLayers.StyleMap({'default':newSaved_layer.styleMap.styles.default.defaultStyle,'select':newSaved_layer.styleMap.styles.select.defaultStyle}),
projection : new OpenLayers.Projection(LisLayer[i].split(" projW ")[1].split(" Eproj ")[0]),
 isBaseLayer: false, renderers:["Canvas", "SVG", "VML"],
 protocol: strObjProtocol
 });
//newSaved_layer.addFeatures(features);
featuresArray.push(features);
if(LisLayer[i].split(" rulWeb ")[1].split(" count=")[1])
{
var CountRules=LisLayer[i].split(" rulWeb ")[1].split(" count=")[1].split(" endCon ");
CountRules=parseInt(CountRules);
var rulesEl= new Array();
for (var h=0;h<CountRules;h++)
{
var obj=JSON.parse(LisLayer[i].split(" filt_"+h+" ")[1].split(" sym_"+h+" ")[0])
if(obj.type==".."){obj.type=OpenLayers.Filter.Comparison.BETWEEN;}
if(obj.type=="=="){obj.type=OpenLayers.Filter.Comparison.EQUAL_TO;}
var obj2=JSON.parse(LisLayer[i].split(" sym_"+h+" ")[1].split(" Esym_"+h+" ")[0])
rulesEl[h]=new OpenLayers.Rule( {title: "< 15.182 grad",filter:new OpenLayers.Filter.Comparison(obj),symbolizer: obj2 });
if(rulesEl[h].filter&&rulesEl[h].filter.filters)
{var fi=new OpenLayers.Filter.Logical(obj);
var fifi1=new OpenLayers.Filter.Comparison(rulesEl[h].filter.filters[0]);
for ( ph in rulesEl[h].filter.filters[0] ){
{if (ph=='filters')
fifi1=parseOb2(rulesEl[h].filter.filters[0])}}



//for (var ety=0;ety
var fifi2=new OpenLayers.Filter.Comparison(rulesEl[h].filter.filters[1]);
fi.filters[0]=fifi1;fi.filters[1]=fifi2;rtt=fi; ;rulesEl[h]=new OpenLayers.Rule( {title: "< 15.182 grad",filter:fi,symbolizer: obj2 });}
if(rulesEl[h].symbolizer&&rulesEl[h].symbolizer.externalGraphic)
{var exgImage=rulesEl[h].symbolizer&&rulesEl[h].symbolizer.externalGraphic.replace(/\s/g,"+");rulesEl[h].symbolizer.externalGraphic=exgImage;}
newSaved_layer.styleMap.styles.default.addRules([rulesEl[h]]);
}
 }//end if(LisLayer[i].split(" rulWeb ")[1].split(" count=")[1])
var EditTextLegendWebGis=LisLayer[i].split(" editLeg ")[1].split(" EeditLeg ")[0];
if(LisLayer[i].split(" startIsBaseLVect ")[1])
{var isBaseVectorLayerW=LisLayer[i].split(" startIsBaseLVect ")[1].split(" endIsBaseLVect ")[0];
if(isBaseVectorLayerW!=='')
{newSaved_layer.isBaseLayer=eval(isBaseVectorLayerW.split("_")[0]);}
if(newSaved_layer.isBaseLayer==true)
{var opt= {buffer: 0,
 displayOutsideMaxExtent: true,
 isBaseLayer:true,queryable: true,
projection: new OpenLayers.Projection("EPSG:900913"),
minResolution: null,maxResolution: 156543.03390625,
numZoomLevels : parseInt(isBaseVectorLayerW.split("_")[1]),maxScale: null,minScale: null,maxExtent: new OpenLayers.Bounds(-20037508.34, -20037508.34, 20037508.34, 20037508.34),
minExtent : null, }
newSaved_layer.options=opt;newSaved_layer.displayOutsideMaxExtent=true;newSaved_layer.buffer=0;
newSaved_layer.queryable=true;newSaved_layer.projection=new OpenLayers.Projection("EPSG:900913");
newSaved_layer.minResolution=null;newSaved_layer.maxResolution=156543.03390625;newSaved_layer.numZoomLevels=parseInt(isBaseVectorLayerW.split("_")[1]);newSaved_layer.maxScale=null;newSaved_layer.minScale=null;
newSaved_layer.maxExtent=new OpenLayers.Bounds(-20037508.34, -20037508.34, 20037508.34, 20037508.34);newSaved_layer.minExtent=null;
} }
if(LisLayer[i].split(" startOWMdowg ")[1])
{var indexOWM=0;var listOWMn=LisLayer[i];
if(!document.getElementById("WMSWeathscript_id"))
{indexOWM=1;
var scriptWMS = document.createElement("script"); 
scriptWMS.src = 'openlayers/OWM.OpenLayers.1.3.6.js'; 
 scriptWMS.type = 'text/javascript'; 
 scriptWMS.id="WMSWeathscript_id";
scriptWMS.async=false;
document.body.appendChild(scriptWMS);
scriptWMS.onload= function(listOWMn){alert("Погода загружена");
if(listOWMn.split(" startOWMdowg ")[1].split(" endOWMdowg ")[0]=='yesOWMweath')
{newSaved_layer=new OpenLayers.Layer.Vector.OWMWeather(listOWMn.split(" StartlayerWebgisName ")[1].split(" EndlayerWebgisName ")[0],{renderers:["Canvas", "SVG", "VML"]});}
if(listOWMn.split(" startOWMdowg ")[1].split(" endOWMdowg ")[0]=='yesOWMstan')
{newSaved_layer=new OpenLayers.Layer.Vector.OWMStations(listOWMn.split(" StartlayerWebgisName ")[1].split(" EndlayerWebgisName ")[0],{renderers:["Canvas", "SVG", "VML"]});}
}(listOWMn);

    }
else{if(indexOWM==0){if(listOWMn.split(" startOWMdowg ")[1].split(" endOWMdowg ")[0]=='yesOWMweath')
{newSaved_layer=new OpenLayers.Layer.Vector.OWMWeather(listOWMn.split(" StartlayerWebgisName ")[1].split(" EndlayerWebgisName ")[0],{renderers:["Canvas", "SVG", "VML"]});}
if(listOWMn.split(" startOWMdowg ")[1].split(" endOWMdowg ")[0]=='yesOWMstan')
{newSaved_layer=new OpenLayers.Layer.Vector.OWMStations(listOWMn.split(" StartlayerWebgisName ")[1].split(" EndlayerWebgisName ")[0],{renderers:["Canvas", "SVG", "VML"]});} }  }
}

if(EditTextLegendWebGis!=='')
{newSaved_layer["EditTextLegendWebGis"]=EditTextLegendWebGis;}
var selectedBaseLayer;
if(newSaved_layer.isBaseLayer==true&&newSaved_layer.visibility==true)
{selectedBaseLayer=newSaved_layer;}
layersArray.push(newSaved_layer);
//map.addLayer(newSaved_layer);
var t=this.document.createElement('option');
t.value=newSaved_layer.name;
t.text=newSaved_layer.name;
this.document.getElementById("editL1").appendChild(t);
if(newSaved_layer.visibility==true){newSaved_layer.redraw();}
}
if(LisLayer[i].split(" StartlayerWMS ")[1])
{

var ObjWMS=JSON.parse(LisLayer[i].split(" EStartlayerWMS ")[1].split(" EObjL ")[0]);
//map.baseLayer.projection=new OpenLayers.Projection(mapProj);
rtt=ObjWMS;

//ObjWMS.projection=eval(ObjWMS.projection);
ObjWMS.projection=new OpenLayers.Projection(ObjWMS.projection);
ObjWMS.maxExtent=eval(ObjWMS.maxExtent);
if(LisLayer[i].split(" StartlayerWMS ")[1].split(" EStartlayerWMS ")[0]=="Google Maps....")
{
var newSaved_WMSlayer = new OpenLayers.Layer.Google(
"Google Maps....", {
type : ObjWMS.url,sphericalMercator: true,
numZoomLevels : 21,visibility:ObjWMS["visibility"]},
{useCanvas: OpenLayers.Layer.Grid.ONECANVASPERLAYER});rtt=newSaved_WMSlayer;newSaved_WMSlayer.projection=ObjWMS.projection;}
if(LisLayer[i].split(" StartlayerWMS ")[1].split(" EStartlayerWMS ")[0]=="OpenStreetMap")
{
var newSaved_WMSlayer = new OpenLayers.Layer.OSM(LisLayer[i].split(" StartlayerWMS ")[1].split(" EStartlayerWMS ")[0],ObjWMS);newSaved_WMSlayer.url=ObjWMS.url;newSaved_WMSlayer.projection=ObjWMS.projection;}

if(LisLayer[i].split(" StartlayerWMS ")[1].split(" EStartlayerWMS ")[0]!=="Google Maps...."&&LisLayer[i].split(" StartlayerWMS ")[1].split(" EStartlayerWMS ")[0]!=="OpenStreetMap")
{
if(ObjWMS["isBaseLayer"]==false)
{var strsld=LisLayer[i].split(" LayWMS ")[1].split(" ELayWMS ")[0].split('sldbodyOWG')[1];
if(typeof strsld!=='undefined'&&strsld!=='')
{//newSaved_WMSlayer.params.SLD_BODY=LisLayer[i].split(" LayWMS ")[1].split(" ELayWMS ")[0].split('sldbodyOWG')[1];
var newSaved_WMSlayer= new OpenLayers.Layer.WMS(LisLayer[i].split(" StartlayerWMS ")[1].split(" EStartlayerWMS ")[0],
 LisLayer[i].split(" EObjL ")[1].split(" EWMSurl ")[0],
 {transparent: true,layers: LisLayer[i].split(" LayWMS ")[1].split(" ELayWMS ")[0].split('sldbodyOWG')[0],transparent:true,sld_body:strsld,STYLES:''},
 { buffer: 0,
 singleTile:true, 
tileOptions: {maxGetUrlLength: 20},
opacity:ObjWMS["opacity"],
displayOutsideMaxExtent: true,
isBaseLayer:ObjWMS["isBaseLayer"],
projection: ObjWMS.projection,
displayProjection : new OpenLayers.Projection("EPSG:4326")
 });
}
else{
if(ObjWMS["XYZ"])
{
var newSaved_WMSlayer= new OpenLayers.Layer.XYZ(LisLayer[i].split(" StartlayerWMS ")[1].split(" EStartlayerWMS ")[0],
 LisLayer[i].split(" EObjL ")[1].split(" EWMSurl ")[0],
  { opacity:ObjWMS["opacity"],isBaseLayer:ObjWMS["isBaseLayer"],sphericalMercator: true,
visibility:ObjWMS.visibility
 });
if(newSaved_WMSlayer.url=="http://${s}.tile.openweathermap.org/map/wind/${z}/${x}/${y}.png"){addLegendWindOWM();}
if(newSaved_WMSlayer.url=="http://${s}.tile.openweathermap.org/map/temp/${z}/${x}/${y}.png"){addLegendTempOWM();}
if(newSaved_WMSlayer.url=="http://${s}.tile.openweathermap.org/map/pressure/${z}/${x}/${y}.png"){addLegendPressOWM();}
if(newSaved_WMSlayer.url=="http://${s}.tile.openweathermap.org/map/rain/${z}/${x}/${y}.png"){addLegendRainOWM();}
if(newSaved_WMSlayer.url=="http://${s}.tile.openweathermap.org/map/precipitation/${z}/${x}/${y}.png"){addLegendRainOWM();}
 }
else{
var newSaved_WMSlayer= new OpenLayers.Layer.WMS(LisLayer[i].split(" StartlayerWMS ")[1].split(" EStartlayerWMS ")[0],
 LisLayer[i].split(" EObjL ")[1].split(" EWMSurl ")[0], {transparent: true,layers: LisLayer[i].split(" LayWMS ")[1].split(" ELayWMS ")[0].split('sldbodyOWG')[0]},
  { buffer: 0,
 singleTile:false, 
//tileOptions: {maxGetUrlLength: 20},
opacity:ObjWMS["opacity"],
displayOutsideMaxExtent: true,
isBaseLayer:ObjWMS["isBaseLayer"],
projection: ObjWMS.projection,
visibility:ObjWMS.visibility
//displayProjection : new OpenLayers.Projection("EPSG:4326")
 }); }
 }
}
else
{if(ObjWMS["XYZ"])
{
var newSaved_WMSlayer= new OpenLayers.Layer.XYZ(LisLayer[i].split(" StartlayerWMS ")[1].split(" EStartlayerWMS ")[0],
 LisLayer[i].split(" EObjL ")[1].split(" EWMSurl ")[0],
  { opacity:ObjWMS["opacity"],isBaseLayer:ObjWMS["isBaseLayer"],sphericalMercator: true,
visibility:ObjWMS.visibility
 });  
if(newSaved_WMSlayer.url=="http://${s}.tile.openweathermap.org/map/wind/${z}/${x}/${y}.png"){addLegendWindOWM();}
if(newSaved_WMSlayer.url=="http://${s}.tile.openweathermap.org/map/temp/${z}/${x}/${y}.png"){addLegendTempOWM();}
if(newSaved_WMSlayer.url=="http://${s}.tile.openweathermap.org/map/pressure/${z}/${x}/${y}.png"){addLegendPressOWM();}
if(newSaved_WMSlayer.url=="http://${s}.tile.openweathermap.org/map/rain/${z}/${x}/${y}.png"){addLegendRainOWM();}
if(newSaved_WMSlayer.url=="http://${s}.tile.openweathermap.org/map/precipitation/${z}/${x}/${y}.png"){addLegendRainOWM();}

}
 else{
var newSaved_WMSlayer= new OpenLayers.Layer.WMS(LisLayer[i].split(" StartlayerWMS ")[1].split(" EStartlayerWMS ")[0],
 LisLayer[i].split(" EObjL ")[1].split(" EWMSurl ")[0], {layers: LisLayer[i].split(" LayWMS ")[1].split(" ELayWMS ")[0].split('sldbodyOWG')[0]},
 ObjWMS); }
}


}
rtt=newSaved_WMSlayer;
var selectedBaseLayer;
if(newSaved_WMSlayer.isBaseLayer==true&&newSaved_WMSlayer.visibility==true)
{selectedBaseLayer=newSaved_WMSlayer;}

layersArray.push(newSaved_WMSlayer);
//map.addLayer(newSaved_WMSlayer);
}


if(LisLayer[i].split(" StartlayerImage ")[1])
{

var ObjWMS=JSON.parse(LisLayer[i].split(" StartlayerImage ")[1].split(" ELayImage ")[0]);
rtt=ObjWMS["url"];
var objurlImage=ObjWMS["url"].replace(/\s/g,"+");
rtt=objurlImage;
 var graphic = new OpenLayers.Layer.Image(
 ObjWMS.name,
 objurlImage,
eval(ObjWMS.extent),
new OpenLayers.Size(1,1),
 {numZoomLevels: 32, 'isBaseLayer': false,'alwaysInRange': true,visibility:ObjWMS.visibility,opacity:ObjWMS.opacity
}   ); 
if(LisLayer[i].split(" startIsImBaseLVect ")[1])
{var isBaseImLayerW=LisLayer[i].split(" startIsImBaseLVect ")[1].split(" endIsImBaseLVect ")[0];
if(isBaseImLayerW!=='')
{graphic.isBaseLayer=eval(isBaseImLayerW.split("_")[0]);}
if(graphic.isBaseLayer==true)
{graphic.numZoomLevels=parseInt(isBaseImLayerW.split("_")[1]); graphic.maxResolution=156543.03390625; 
graphic.maxExtent=new OpenLayers.Bounds(-20037508.34, -20037508.34, 20037508.34, 20037508.34) ;  graphic.projection=new OpenLayers.Projection("EPSG:900913");graphic.displayOutsideMaxExtent=true;graphic.buffer=0; }

var opt= {buffer: 0,
 displayOutsideMaxExtent: true,
 isBaseLayer:true,queryable: true,
projection: new OpenLayers.Projection("EPSG:900913"),
minResolution: null,
maxResolution: 156543.03390625,
numZoomLevels : parseInt(isBaseImLayerW.split("_")[1]),
maxScale: null,
minScale: null,
maxExtent: new OpenLayers.Bounds(-20037508.34, -20037508.34, 20037508.34, 20037508.34),
minExtent : null,
 }
graphic.options=opt;}
var selectedBaseLayer;
if(graphic.isBaseLayer==true&&graphic.visibility==true)
{selectedBaseLayer=graphic;} 
layersArray.push(graphic);
}

" LayerWMSWFS "





//map.setCenter(new OpenLayers.LonLat(lonCent, latCent), zoom);
 }
rtt=layersArray;

map.projection=new OpenLayers.Projection("EPSG:900913");
map.addLayers(layersArray);
for(var hiy=0;hiy<map.layers.length;hiy++)
{if(map.layers[hiy].CLASS_NAME=='OpenLayers.Layer.Vector')
{map.layers[hiy].addFeatures(featuresArray[0]);featuresArray.splice(0,1) }

}
if(selectedBaseLayer)
{map.setBaseLayer(selectedBaseLayer);}
//external_control2.redraw();

map.setCenter(new OpenLayers.LonLat(lonCent, latCent), zoom);

for(var rt=0;rt<map.layers.length;rt++)
{if(map.layers[rt].name=='OpenStreetMap')
{map.layers[rt].events.register("loadstart",map.layers[rt], function() {document.getElementById("tableAlertWait2").style.display="block";});
map.layers[rt].events.register("loadend",map.layers[rt], function() {document.getElementById("tableAlertWait2").style.display="none"; });}
else
{
if(map.layers[rt].name=='Google Maps....')
{google.maps.event.addListener(map.layers[rt].mapObject, "tilesloaded", 
function(){var removeFin=document.getElementById("tableAlertWait");var removeFin2=document.getElementById("tableAlertWait2");
if(removeFin)
{document.getElementById("tableAlertWait").parentNode.removeChild(removeFin);}
if(removeFin2)
{removeFin2.style.display="none";}
});}
else{if(map.layers[rt].CLASS_NAME=="OpenLayers.Layer.Vector"&&map.layers[rt].protocol)
{//var responseLine = new OpenLayers.Protocol.Response();if(map.layers[rt].protocol.success()==true){alert(map.layers.name)};}

  map.layers[rt].events.register("featuresadded",map.layers[rt], function(event) 
  {  if(event.features){if(event.features[0]){if(event.features[0].geometry.CLASS_NAME=='OpenLayers.Geometry.MultiLineString'||event.features[0].geometry.CLASS_NAME=='OpenLayers.Geometry.LineString')
{if(event.features[0].layer.visibility==true){ var tlname=event.features[0].layer.name;event.features[0].layer.name=tlname+"__%&owg";external_control2.redraw();var ctrvr=tlname.split('_%&owg')[0];event.features[0].layer.name=ctrvr;external_control2.redraw();}}}}})
  
}
}}}
if(loadfree==true)
{
if(localStorageOpenWebGIS.split(" InterfaceSave ")[1])
{var strsaveinter=localStorageOpenWebGIS.split(" InterfaceSave ;")[1].split(" InterfaceSaveEnd ")[0];
var newstrsaveinter=strsaveinter.split(";");
document.body.style.backgroundColor=newstrsaveinter[0];document.getElementById("map").style.width=newstrsaveinter[1];
document.getElementById("map").style.height=newstrsaveinter[2];document.getElementById("mapResize").style.left=newstrsaveinter[3];
document.getElementById("mapResize").style.top=newstrsaveinter[4];document.getElementById("external_control2").style.backgroundColor=newstrsaveinter[5];
document.getElementById("drag").style.top=newstrsaveinter[6];document.getElementById("drag").style.left=newstrsaveinter[7];
document.getElementById("dragMenu").style.top=newstrsaveinter[8];document.getElementById("dragMenu").style.left=newstrsaveinter[9];
document.getElementById("id_menu").style.backgroundColor=newstrsaveinter[10];document.getElementById("dragEditLayer").style.top=newstrsaveinter[11];
document.getElementById("dragEditLayer").style.left=newstrsaveinter[12];document.getElementById("dragCoord").style.top=newstrsaveinter[13];
document.getElementById("dragCoord").style.left=newstrsaveinter[14];document.getElementById("dragScale").style.top=newstrsaveinter[15];
document.getElementById("dragScale").style.left=newstrsaveinter[16];document.getElementById("dragToolbar_opt").style.top=newstrsaveinter[17];
document.getElementById("dragToolbar_opt").style.left=newstrsaveinter[18];document.getElementById("OpenStreetMapIdSearch").style.left=newstrsaveinter[19];
document.getElementById("OpenStreetMapIdSearch").style.top=newstrsaveinter[20];document.getElementById("OpenWikipediaSearch").style.left=newstrsaveinter[21];
document.getElementById("OpenWikipediaSearch").style.top=newstrsaveinter[22]; var changeMenuv=newstrsaveinter[23]; if(changeMenuv=='cMenubrYes'){changeMenu();}
}
if(localStorageOpenWebGIS.split(" InterfSepDSaveStart ")[1])
{
var strsavesepd=localStorageOpenWebGIS.split(" InterfSepDSaveStart ")[1].split(" InterfSepDSaveEnd ")[0];
var strsavesepdArr=strsavesepd.split(" owg;owg "); 
for(var jk=0;jk<strsavesepdArr.length-1; jk++)
{ var bbox = document.getElementById("map").getBoundingClientRect(); var body = document.body; var docElem = document.documentElement;
 var scrollTop = window.pageYOffset || docElem.scrollTop || body.scrollTop; var scrollLeft = window.pageXOffset || docElem.scrollLeft || body.scrollLeft;
 var clientTop = docElem.clientTop || body.clientTop || 0; var clientLeft = docElem.clientLeft || body.clientLeft || 0;
 var topTop = bbox.top + scrollTop - clientTop; var leftLeft = bbox.left + scrollLeft - clientLeft;
var DivEditeLeg=document.createElement("div");DivEditeLeg.id="id_divSepTableImage";
DivEditeLeg.className="id_divRoutLegMain";DivEditeLeg.style=strsavesepdArr[jk].split(" owgs;owgs ")[1];
DivEditeLeg.onmousedown=function(event){drags(event)};
DivEditeLeg.onmouseup=function(e){enddrag()};
DivEditeLeg.innerHTML=strsavesepdArr[jk].split(" divsepoewg_ ")[1].split(" owgs;owgs ")[0];
body.appendChild(DivEditeLeg);
var inputn = DivEditeLeg.getElementsByTagName('input');
var buttonsn = DivEditeLeg.getElementsByTagName('button');rtt=buttonsn;
for(var is=0;is<buttonsn.length;is++)
{
if(buttonsn[is].id=='')
{var butn=buttonsn[is];buttonsn[is].onclick=function(butn,inputn){return function(){EditeUpdateAttNewDiv(butn,inputn)}}(butn,inputn) }
if(buttonsn[is].id=='id_EditeUpdateAttributes')
{ var tablen=DivEditeLeg.getElementsByTagName('table');var butn=buttonsn[is];buttonsn[is].onclick=function(butn,tablen){return function(){EditeTableNewDiv(butn,tablen)}}(butn,tablen);
}
if(buttonsn[is].id=='id_UpdateAttributesB')
{buttonsn[is].innerHTML='<a style="font-size:11px">Update</a>';var tablen=DivEditeLeg.getElementsByTagName('table');var butn=buttonsn[is];
buttonsn[is].onclick=function(butn,tablen){return function(){UpdateAttsaveNewDiv(butn,tablen)}}(butn,tablen);
}
if(buttonsn[is].id=='id_OpenSepPopupWinmap')
{
buttonsn[is].onclick=function(){OpenSepPopupWinmap(this);}
}
} }
}
}
map.updateSize();
if(loadfree==true)
{
if(localStorageOpenWebGIS.split(" ClearMapOWG ")[1])
{
panel.deactivate();panel.destroy();panel=null;document.getElementById("options").parentNode.removeChild(document.getElementById("options")); 
for(var i=0;i<map.controls.length;i++){if(map.controls[i].displayClass=="olControlPanZoomBar"||map.controls[i].displayClass=="olControlNavToolbar"||map.controls[i].displayClass=="olControlOverviewMap"){ map.controls[i].destroy();i--;}

} }}
if(loadfree==true)
{
if(localStorageOpenWebGIS.split(" TimeLineOpenWebStart ")[1])
{
var strtimeline=localStorageOpenWebGIS.split(" TimeLineOpenWebStart ;")[1].split(" InterfaceSaveEnd ")[0];
var newstrtimeline=strtimeline.split(";");document.getElementById('editL1').value = newstrtimeline[17]; 
SeteditlayerMain(newstrtimeline[17]);
for(var w=0;w<map.layers.length;w++)
{if(map.layers[w].name==newstrtimeline[17])
{if(map.layers[w].features.length>0){
TimeLine();document.getElementById("TimeLayerField").value=newstrtimeline[0];
document.getElementById("htmlTimeYear1").value=newstrtimeline[1];document.getElementById("htmlTimeMonth1").value=newstrtimeline[2];
document.getElementById("htmlTimeDay1").value=newstrtimeline[3];document.getElementById("htmlTimeHour1").value=newstrtimeline[4];document.getElementById("htmlTimeMin1").value=newstrtimeline[5];
document.getElementById("htmlTimeSec1").value=newstrtimeline[6];
document.getElementById("htmlTimeYear2").value=newstrtimeline[7];document.getElementById("htmlTimeMonth2").value=newstrtimeline[8];
document.getElementById("htmlTimeDay2").value=newstrtimeline[9];document.getElementById("htmlTimeHour2").value=newstrtimeline[10];document.getElementById("htmlTimeMin2").value=newstrtimeline[11];
document.getElementById("htmlTimeSec2").value=newstrtimeline[12];
document.getElementById("TimeInterField").value=newstrtimeline[13];document.getElementById("id_milisecAtl").value=newstrtimeline[14];document.getElementById("id_MoveTimeWmap").checked=eval(newstrtimeline[15]);
document.getElementById("id_previousDateTime").checked=eval(newstrtimeline[16]);document.getElementById("id_MoveTimeWmap_val").value=newstrtimeline[18];
if(newstrtimeline[19]!=='undefined'){document.getElementById("id_TimeLineLegMain2").style.left=newstrtimeline[19]};if(newstrtimeline[20]!=='undefined'){document.getElementById("id_TimeLineLegMain2").style.top=newstrtimeline[20]}
if(newstrtimeline[21]){if(newstrtimeline[21]!=='0'){if(document.getElementById("id_heatmapDateTime")&&newstrtimeline[21].split("HeatmapName_OWG_")[1]){document.getElementById("id_heatmapDateTime").checked=true;document.getElementById("id_heatmapDateTime").heatmaplayer=newstrtimeline[21].split("HeatmapName_OWG_")[1]}}}

if(newstrtimeline[23]){if(newstrtimeline[23]!=='0'){if(document.getElementById("id_25dDateTime")&&newstrtimeline[23].split("osm25dName_OWG_")[1]){document.getElementById("id_25dDateTime").checked=true;document.getElementById("id_25dDateTime").layer25D=newstrtimeline[23].split("osm25dName_OWG_")[1]}}}

if(newstrtimeline[22]){onChangeTimeLine();if(newstrtimeline[22].split(" TimeLineOpenWebNumbers ")[1])
{var timenumber=newstrtimeline[22].split(" TimeLineOpenWebNumbers ")[1].split(" TimeLineOpenWebNumbere ")[0].split(",");TimeFieldowg=timenumber[0];document.getElementById("htmlTimeNum1").value=timenumber[1];document.getElementById("htmlTimeInterN").value=timenumber[2];document.getElementById("htmlTimeNum2").value=timenumber[3];} }
document.getElementById("id_OK_PlayTimeLine").click();}
else
{               
setTimeout(function() {
  try{
  TimeLine();document.getElementById("TimeLayerField").value=newstrtimeline[0];
document.getElementById("htmlTimeYear1").value=newstrtimeline[1];document.getElementById("htmlTimeMonth1").value=newstrtimeline[2];
document.getElementById("htmlTimeDay1").value=newstrtimeline[3];document.getElementById("htmlTimeHour1").value=newstrtimeline[4];document.getElementById("htmlTimeMin1").value=newstrtimeline[5];
document.getElementById("htmlTimeSec1").value=newstrtimeline[6];
document.getElementById("htmlTimeYear2").value=newstrtimeline[7];document.getElementById("htmlTimeMonth2").value=newstrtimeline[8];
document.getElementById("htmlTimeDay2").value=newstrtimeline[9];document.getElementById("htmlTimeHour2").value=newstrtimeline[10];document.getElementById("htmlTimeMin2").value=newstrtimeline[11];
document.getElementById("htmlTimeSec2").value=newstrtimeline[12];
document.getElementById("TimeInterField").value=newstrtimeline[13];document.getElementById("id_milisecAtl").value=newstrtimeline[14];document.getElementById("id_MoveTimeWmap").checked=eval(newstrtimeline[15]);
document.getElementById("id_previousDateTime").checked=eval(newstrtimeline[16]);document.getElementById("id_MoveTimeWmap_val").value=newstrtimeline[18];
if(newstrtimeline[19]!=='undefined'){document.getElementById("id_TimeLineLegMain2").style.left=newstrtimeline[19]};if(newstrtimeline[20]!=='undefined'){document.getElementById("id_TimeLineLegMain2").style.top=newstrtimeline[20]}
if(newstrtimeline[19]!=='undefined'){document.getElementById("id_TimeLineLegMain2").style.left=newstrtimeline[19]};if(newstrtimeline[20]!=='undefined'){document.getElementById("id_TimeLineLegMain2").style.top=newstrtimeline[20]}
if(newstrtimeline[21]){if(newstrtimeline[21]!=='0'){if(document.getElementById("id_heatmapDateTime")&&newstrtimeline[21].split("HeatmapName_OWG_")[1]){document.getElementById("id_heatmapDateTime").checked=true;document.getElementById("id_heatmapDateTime").heatmaplayer=newstrtimeline[21].split("HeatmapName_OWG_")[1]}}}

if(newstrtimeline[23]){if(newstrtimeline[23]!=='0'){if(document.getElementById("id_25dDateTime")&&newstrtimeline[23].split("osm25dName_OWG_")[1]){document.getElementById("id_25dDateTime").checked=true;document.getElementById("id_25dDateTime").layer25D=newstrtimeline[23].split("osm25dName_OWG_")[1]}}}

if(newstrtimeline[22]){onChangeTimeLine();if(newstrtimeline[22].split(" TimeLineOpenWebNumbers ")[1])
{var timenumber=newstrtimeline[22].split(" TimeLineOpenWebNumbers ")[1].split(" TimeLineOpenWebNumbere ")[0].split(",");TimeFieldowg=timenumber[0];document.getElementById("htmlTimeNum1").value=timenumber[1];document.getElementById("htmlTimeInterN").value=timenumber[2];document.getElementById("htmlTimeNum2").value=timenumber[3];} }
document.getElementById("id_OK_PlayTimeLine").click();
  
  }
  catch(e){alert(e);}
}, 7000);

                }
  } }
}
}
if(loadfree==true)
{if(localStorageOpenWebGIS.split(" MapColorback ")[1])
{document.getElementById("map").style.backgroundColor=localStorageOpenWebGIS.split(" MapColorback ")[1].split(" endMapColorback ")[0];}   }
if(loadfree==true)
{if(localStorageOpenWebGIS.split(" OSMBowgS ")[1])
{var indexba=localStorageOpenWebGIS.split(" OSMBowgS ")[1].split(" endOSMBowgS ")[0];
var newosmbar=indexba.split(";"); rtt=newosmbar;
var indexb=parseInt(newosmbar[0]);
for(var bc=0;bc<map.controls.length;bc++)
{if(map.controls[bc].displayClass=='olControlOSMB'){ map.controls[bc].trigger(); var timosmb=2000+(indexb*5);
setTimeout(function()
{for(var njkl=0;njkl<map.layers.length;njkl++){if(!map.layers[njkl].customJson&&map.layers[njkl].attribution&&map.layers[njkl].attribution=='&copy; <a href="http://osmbuildings.org">OSM Buildings</a>'){
if(newosmbar[1]!==''){if(newosmbar[4]!==""){opacityOSMbuild=newosmbar[4];}map.layers[njkl].style({ wallColor:newosmbar[1], roofColor:newosmbar[2], shadows:eval(newosmbar[3])});map.layers[njkl].wallColor=newosmbar[1];map.layers[njkl].roofColor=newosmbar[2];map.layers[njkl].shadow=newosmbar[3];
if(newosmbar[4]!==""){map.layers[njkl].opacityOSMbuild=newosmbar[4];}}
map.layers[njkl].setVisibility(false);map.layers[njkl].setVisibility(true);if(newosmbar[5]!==""){map.layers[njkl].setVisibility(eval(newosmbar[5]));map.setLayerIndex(map.layers[njkl],indexb);} } } },timosmb)
}   }
} }
if(loadfree==true)
{if(localStorageOpenWebGIS.split(" OSMBowgScust ")[1])
{if(localStorageOpenWebGIS.split(" OSMBowgScustL ")[1])
{var sosmbl1=localStorageOpenWebGIS.split(" OSMBowgScust ")[1].split(" endOSMBowgScust ")[0].split(" startOSMBlasl ")[0];
var sosmbl2=localStorageOpenWebGIS.split(" OSMBowgScust ")[1].split(" endOSMBowgScust ")[0].split(" startOSMBlasl ")[1].split(" endOSMBlasl ")[0];
var sosmbl=sosmbl1.split(" OSMBowgScustL ");
for(var tosmb=1;tosmb<sosmbl.length;tosmb++)
{var indexba=sosmbl[tosmb].split(" endOSMBowgScustL ")[0];rtt=sosmbl; 
//else
//{var indexba=localStorageOpenWebGIS.split(" OSMBowgScust ")[1].split(" endOSMBowgScust ")[0];}
var newosmbar2=indexba.split(" owg; ");var indexb=parseInt(newosmbar2[0]);

if(!document.getElementById("OSMscript_script_id"))
{var scriptB = document.createElement("script"); 
scriptB.src = 'openlayers/OSMBuildings-OpenLayers.js';  scriptB.type = 'text/javascript';  scriptB.id="OSMscript_script_id";
scriptB.async=false;document.body.appendChild(scriptB);
scriptB.onload= function(newosmbar2){return function(){var jsparse=JSON.parse(newosmbar2[4]);
var osmbjson = new OSMBuildings(map).set(jsparse);
osmbjson.name=newosmbar2[5];osmbjson.customJson=newosmbar2[4];osmbjson.setVisibility(false);osmbjson.setVisibility(true); ;}}(newosmbar2)}
else
{document.getElementById("OSMscript_script_id").parentNode.removeChild(document.getElementById("OSMscript_script_id"));OSMBuildings='';
var scriptB = document.createElement("script"); scriptB.src = 'openlayers/OSMBuildings-OpenLayers.js'; 
 scriptB.type = 'text/javascript';  scriptB.id="OSMscript_script_id";scriptB.async=false;document.body.appendChild(scriptB)
scriptB.onload= function(newosmbar2){return function(){var jsparse=JSON.parse(newosmbar2[4]);
var osmbjson = new OSMBuildings(map).set(jsparse);osmbjson.name=newosmbar2[5];var njosmb=newosmbar2[5];
osmbjson.customJson=newosmbar2[4];osmbjson.setVisibility(false);osmbjson.setVisibility(true);}}(newosmbar2);
}
var timosmb=2500+(indexb*5);var t=1;//setTimeout( function(t){return function(){alert("stop")}}(t),15000)
setTimeout(function(newosmbar2,sosmbl2,tosmb,sosmbl){return function(){
if(tosmb==sosmbl.length-1)
{var sosmbl2ar=sosmbl2.split(";"); 
for(var vr=0;vr<sosmbl2ar.length;vr++){
for(var njkl=0;njkl<map.layers.length;njkl++)
{if(map.layers[njkl].isBaseLayer==false&&map.layers[njkl].name+"_owgosmb "==sosmbl2ar[vr])
{map.setLayerIndex(map.layers[njkl],sosmbl2ar[vr+2]);map.layers[njkl].setZIndex(sosmbl2ar[vr+1]);}
} } }
for(var njkl=0;njkl<map.layers.length;njkl++){
if(map.layers[njkl].customJson&&map.layers[njkl].attribution&&map.layers[njkl].attribution=='&copy; <a href="http://osmbuildings.org">OSM Buildings</a>'&&map.layers[njkl].name==newosmbar2[5]){
if(newosmbar2[1]!==''){if(newosmbar2[6]!==""){opacityOSMbuild=newosmbar2[6];}map.layers[njkl].style({ wallColor:newosmbar2[1], roofColor:newosmbar2[2], shadows:eval(newosmbar2[3])});map.layers[njkl].wallColor=newosmbar2[1];map.layers[njkl].roofColor=newosmbar2[2];map.layers[njkl].shadow=newosmbar2[3];if(newosmbar2[6]!==""){map.layers[njkl].opacityOSMbuild=newosmbar2[6];}}
map.layers[njkl].setVisibility(false);map.layers[njkl].setVisibility(true);if(newosmbar2[7]!==""){map.layers[njkl].setVisibility(eval(newosmbar2[7]));map.setLayerIndex(map.layers[njkl],indexb);}}} }}(newosmbar2,sosmbl2,tosmb,sosmbl),timosmb)

}  }  } }      
if(loadfree==true)
{if(localStorageOpenWebGIS.split(" startOWGHeatmaps ")[1])
{
var layerHeatmpowg=localStorageOpenWebGIS.split(" startOWGHeatmaps ")[1].split(" endOWGHeatmaps ")[0].split(" startHeatlasl "); 
for(var het=1;het<layerHeatmpowg.length;het++)
{ var bheat=layerHeatmpowg[het].split(" endtHeatlasl ")[0]; 
var parl=bheat.split(" snameowgHeatn ")[1].split(" enameowgHeatn ")[0].split(";")
var new_layer_Heat = new OpenLayers.Layer(parl[0],{});
new_layer_Heat.heatmapparams=JSON.parse(bheat.split(" startOWGParamH ")[1].split(" endOWGParamH ")[0]);
new_layer_Heat.featuresH=JSON.parse(bheat.split(" startOWGParamF ")[1].split(" endOWGParamF ")[0]);
new_layer_Heat.heatmapOWG="yes";
var brushCanvasF = document.createElement('canvas');new_layer_Heat.setVisibility(eval(parl[1]))
map.addLayer(new_layer_Heat);new_layer_Heat.div.appendChild(brushCanvasF);
map.setLayerIndex(new_layer_Heat,parseInt(parl[2]));new_layer_Heat.setZIndex(parl[3]);
var zoomH=new_layer_Heat;HeatmapCanvas(zoomH);
} }
}
if(loadfree==true)
{if(localStorageOpenWebGIS.split(" startOWGIDWmaps ")[1])
{
var layerIDWmpowg=localStorageOpenWebGIS.split(" startOWGIDWmaps ")[1].split(" endOWGIDWmaps ")[0].split(" startIDWlasl "); 
for(var het=1;het<layerIDWmpowg.length;het++)
{ var bheat=layerIDWmpowg[het].split(" endtIDWlasl ")[0]; 
var parl=bheat.split(" snameowgIDWn ")[1].split(" enameowgIDWn ")[0].split(";")
var new_layer_Heat = new OpenLayers.Layer(parl[0],{});
new_layer_Heat.idwmapparams=JSON.parse(bheat.split(" startOWGParamI ")[1].split(" endOWGParamI ")[0]);
new_layer_Heat.featuresIn=JSON.parse(bheat.split(" startOWGParamFi ")[1].split(" endOWGParamFi ")[0]);
new_layer_Heat.IDWOWG="yes";
var brushCanvasF = document.createElement('canvas');new_layer_Heat.setVisibility(eval(parl[1]))
map.addLayer(new_layer_Heat);new_layer_Heat.div.appendChild(brushCanvasF);
map.setLayerIndex(new_layer_Heat,parseInt(parl[2]));new_layer_Heat.setZIndex(parl[3]);
var zoomIDW=new_layer_Heat;IDWCanvas2(zoomIDW);
} } 
}

if(loadfree==true)
{if(localStorageOpenWebGIS.split(" map3dOWGs ")[1])
{var pos3dWMS="0";var str3dowgEnt="0";
var str3dowg=localStorageOpenWebGIS.split(" map3dOWGs ")[1].split(" map3dOWGe ")[0];
if(localStorageOpenWebGIS.split(" map3dOWGents ")[1]){str3dowgEnt=localStorageOpenWebGIS.split(" map3dOWGents ")[1].split(" map3dOWGente ")[0];}
if(localStorageOpenWebGIS.split(" map3dOWGwmss ")[1]){pos3dWMS=localStorageOpenWebGIS.split(" map3dOWGwmss ")[1].split(" map3dOWGwmse ")[0]};
loadProj3dMap(str3dowg,str3dowgEnt,pos3dWMS); 
}
}

if(loadfree==true)
{if(localStorageOpenWebGIS.split(" edilLayerOWG ")[1])
{document.getElementById('editL1').value=localStorageOpenWebGIS.split(" edilLayerOWG ")[1].split(" endedilLayerOWG ")[0];SeteditlayerMain(localStorageOpenWebGIS.split(" edilLayerOWG ")[1].split(" endedilLayerOWG ")[0]);} }
localStorageOpenWebGIS='';

}
function ExportProject()
{
kmlText2='';
//kmlText2=localStorage["Project"];
kmlText2=SaveProject2();
namedownlodfileopenwebgis='projectOpenWGS.owg';
 init_download();//myWinExport= window.open("download.html", "Export project","width=900,height=500,status=no,toolbar=no,menubar=no,scrollbars=yes");
myWinExport.focus();
}
function LoadFileProject()
{
var htmlProjFile='';
htmlProjFile+='<a>Please select file:</a><br>'+
 '<input title="Select Project file" type="file" id="file_idProject"><br>'+
'<p> <button type=button onclick=New_ProjectFile()>OK</button></p>';
popup_new_fileProject = new OpenLayers.Popup.FramedCloud("NewFileProject",
 map.getCenter(),
 new OpenLayers.Size(400,400),
 htmlProjFile ,
 null, true, onPopupClose);
 map.addPopup(popup_new_fileProject);
document.getElementById('file_idProject').addEventListener('change', readSingleFileProject, false);
}
function New_ProjectFile() {
var lines = [];
var headers;
var contents2;
var contents;
 if (fileZIP) {
 var r = new FileReader();
 r.onload = function(e) { 
 contents = e.target.result;
//localStorage["Project"]=contents;
localStorageOpenWebGIS=contents;
var loadfree=true;
LoadProject(loadfree);
if(popup_new_fileProject){popup_new_fileProject.destroy();}
 }
 r.readAsText(fileZIP);
 } else { 
 alert("Ошибка загрузки файла");
 }
}
function SwitchDrag()
{ VarDivSwitch=document.getElementById("idSwitchInterface");
if (stopDragInterface==false){stopDragInterface=true;VarDivSwitch.firstChild.data="Интерфейс можно менять";}else{stopDragInterface=false;VarDivSwitch.firstChild.data="Интерфейс нельзя менять";}
}
function AblePopUp()
{
 var VarDivSwitch2=document.getElementById("idAbleOpacity");
if (TurnOffPopUpOpacity==false){TurnOffPopUpOpacity=true;VarDivSwitch2.firstChild.data="окно прозрачности вкл";}else{TurnOffPopUpOpacity=false;VarDivSwitch2.firstChild.data="окно прозрачности выкл";}
 }
 function drags(e)
 {
if (stopDragInterface==false){ return;}
 if (!(is_ie)&&!(!is_ie)) return
 var firedobj=(!is_ie)? e.target : event.srcElement
 var topelement=(!is_ie)? "HTML" : "BODY"
 while (firedobj.tagName!=topelement && firedobj.className!="dragMenu" && firedobj.className!="dragSwitcher" && firedobj.className!="dragMap" && firedobj.className!="sizeMap" && firedobj.className!="moveCoord" && firedobj.className!="dragEditLayer" && firedobj.className!="dragScale" && firedobj.className!="moveToolbar_opt"&&firedobj.className!="olPopup"&&firedobj.className!="id_divRoutLegMain"&&firedobj.className!="id_divWeatherMain"&&firedobj.className!="id_divForWeatherMain"&&firedobj.className!="id_divSelecMain"&&firedobj.className!="OpenStreetMapIdClass"&&firedobj.className!="id_divImageMain"&&firedobj.className!="InterpolationPopupLeg"&&firedobj.className!="id_divWikiMain"&&firedobj.className!="OpenWikipediaClass"&&firedobj.className!="id_divControlmeasureGis"&&firedobj.className!="id_divControlmeasureGisSq"&&firedobj.className!="id_divRemoveLayer"&&firedobj.className!="id_divAddLayer")
 {//alert("gggg"); 
 firedobj=(!is_ie)? firedobj.parentNode : firedobj.parentElement
 }
 checkdrag_or_size=0;
if(firedobj.className=="sizeMap"){document.getElementById("mapResize").style.padding="60px"; 
tempTopMapSize=document.getElementById("mapResize").style.top;
tempLeftMapSize=document.getElementById("mapResize").style.left;
document.getElementById("mapResize").style.top=(parseInt(document.getElementById("mapResize").style.top.split("px")[0])-parseInt(60))+"px"; 
document.getElementById("mapResize").style.left=(parseInt(document.getElementById("mapResize").style.left.split("px")[0])-parseInt(60))+"px"; }
 if (firedobj.className=="dragMenu"||firedobj.className=="dragSwitcher"||firedobj.className=="dragMap"||firedobj.className=="moveCoord"||firedobj.className=="dragEditLayer"||firedobj.className=="dragScale"||firedobj.className=="moveToolbar_opt"||firedobj.className=="olPopup"||firedobj.className=="id_divRoutLegMain"||firedobj.className=="id_divWeatherMain"||firedobj.className=="id_divForWeatherMain"||firedobj.className=="id_divSelecMain"||firedobj.className=="OpenStreetMapIdClass"||firedobj.className=="id_divImageMain"||firedobj.className=="InterpolationPopupLeg"||firedobj.className=="id_divWikiMain"||firedobj.className=="OpenWikipediaClass"||firedobj.className=="id_divControlmeasureGis"||firedobj.className=="id_divControlmeasureGisSq"||firedobj.className=="id_divRemoveLayer"||firedobj.className=="id_divAddLayer")
 {
 dragapproved = true
 z = firedobj
if(z.className=="dragMap"){z=(!is_ie)? z.parentNode : z.parentElement;checkdrag_or_size=1}
 var tmpheight = z.style.height.split("px")
 maxbottom = (tmpheight[0])?document.body.clientHeight - tmpheight[0]:document.body.clientHeight - 20;
if(maxbottom<0){maxbottom=document.body.clientHeight;};
 temp1 = parseInt(z.style.left+0)
 temp2 = parseInt(z.style.top+0)
 x = (!is_ie)? e.clientX: event.clientX
 y = (!is_ie)? e.clientY: event.clientY
 document.onmousemove = move
 return false
 }
 if (firedobj.className=="sizeMap")
 {
 dragapproved = true
zz = firedobj.childNodes[2].childNodes[2]
 z = firedobj
 var tmpheight = zz.style.height.split("px")
 maxbottom = (tmpheight[0])?document.body.clientHeight - tmpheight[0]:document.body.clientHeight - 20;
 temp1 = parseInt(zz.style.width+0)
 temp2 = parseInt(zz.style.height+0)
 x = (!is_ie)? e.clientX: event.clientX
 y = (!is_ie)? e.clientY: event.clientY
 document.onmousemove = move
 return false
 }
 } 
 function setdragBounds()
 {
 maxleft = 10;
 maxtop = 10;
 maxright = document.body.clientWidth - 10;
 maxbottom = document.body.clientHeight - 100;
 }
 function move(e)
 {
if(z.className!="sizeMap"||checkdrag_or_size==1) 
{var tmpXpos = (!is_ie)? temp1+e.clientX-x: temp1+event.clientX-x;
 var tmpYpos = (!is_ie)? temp2+e.clientY-y : temp2+event.clientY-y;
 if (dragapproved)
 {
 z.style.left = tmpXpos;
 z.style.top = tmpYpos;
 if (tmpXpos < maxleft)
 z.style.left = maxleft;
 if (tmpXpos > maxright)
 z.style.left = maxright;
 if (tmpYpos < maxtop)
 z.style.top = maxtop;
 if (tmpYpos > maxbottom)
 z.style.top = maxbottom;
 return false
 }
}
else
{
var tmpXpos = (!is_ie)? temp1+e.clientX-x: temp1+event.clientX-x;
 var tmpYpos = (!is_ie)? temp2+e.clientY-y : temp2+event.clientY-y;
 if (dragapproved)
 {
 zz.style.width = tmpXpos;
 zz.style.height = tmpYpos;
 /** if (tmpXpos < maxleft)
 { zz.style.left = maxleft;}
 if (tmpXpos > maxright)
 zz.style.left = maxright;
 if (tmpYpos < maxtop)
 { alert(tmpYpos+" < "+ maxtop); zz.style.top = maxtop;}
 if (tmpYpos > maxbottom)
 {alert(tmpYpos+" < "+ maxbottom); zz.style.top = maxbottom;}*/
 return false
 }
map.updateSize(); 
}
 } 
function enddrag(){dragapproved=false;if(z){if(z.className=="sizeMap"&&checkdrag_or_size!=1){document.getElementById("mapResize").style.padding="5px";
document.getElementById("mapResize").style.top=tempTopMapSize; 
document.getElementById("mapResize").style.left=tempLeftMapSize; 
}}}
function enddragMenu(){}
function dragsMenu(){}
function changeMenu()
{

var r=document.getElementById("id_block_menu"); 
var b=r.childNodes.length;b=b+b/2+10;var b2=r.childNodes.length;
if(r.childNodes[0].id&&r.childNodes[0].id=="changeMenubr_"+0)
{var f=0; for(var i=0;i<r.childNodes.length;i++)
{
if(r.childNodes[i].id&&r.childNodes[i].id=="changeMenubr_"+f)
{f=f+2;
r.removeChild(r.childNodes[i]);i=i-1;

} } 
document.getElementById("id_block_menu").style.height=25;document.getElementById("id_block_menu").style.width=1700;
document.getElementById("id_menu").style.height=25;document.getElementById("id_menu").style.width=1700;
}
else
{for(var i=0;i<b;i++)
{
var bre=document.createElement("br");bre.id="changeMenubr_"+i;r.insertBefore(bre,r.childNodes[i]);i=i+1;
}
document.getElementById("id_block_menu").style.height=575;document.getElementById("id_block_menu").style.width=180;
document.getElementById("id_menu").style.height=575;document.getElementById("id_menu").style.width=180; }
}
function colorEdit(obj){ /*colorWin= open("color.htm", "Edit Color interface",
 "width=400,height=100,status=no,toolbar=no,menubar=no");colorWin.focus();*/ colorElem=obj; 
 initColorpalOWG();
 }
 </script> 
 </head> 
 <body style="color:#efe4b0; background-color:#99d9ea" onload="init()" > 
 <h3><a style="position:absolute;top:0px;"href="index2.html><img src="imgopen/opengis.png" ></a>
</h3>
<div id="colorMain" style="position:relative;top:30px;left:180px" align="left"> <img id="colorColorMain" title="изменить цвет фона" src="img/color.png" onclick="colorEdit(this)" > </div>
<!--<div onclick="Login()" style="position:relative;left:390px;top:-120px;bottom:50px;width:50px; height:20px;background:#082567; color:#ffffff; cursor:pointer">Login</div></div>-->
<input type="button" id="buttonWeather_id" value="Погода" class="Weathclass" onclick="Weather_Layer()"/>
<!--<input type="button" value="Помощь проекту" class="Donclass" onclick="Donate()"/>-->
<form action="https://www.paypal.com/cgi-bin/webscr" method="post" target="_top" class="DonPclass">
<input type="hidden" name="cmd" value="_s-xclick">
<input type="hidden" name="hosted_button_id" value="2VTYZJ88BKZBG">
<input type="image" src="https://www.paypalobjects.com/ru_RU/RU/i/btn/btn_donateCC_LG.gif" border="0" name="submit" alt="PayPal — более безопасный и легкий способ оплаты через Интернет!">
<img alt="" border="0" src="https://www.paypalobjects.com/ru_RU/i/scr/pixel.gif" width="1" height="1">
</form>

</div>
<div style="position:absolute;top:65px;left:220px;cursor:pointer;width:200px">
<a href="https://plus.google.com/112343419546545616455/posts" target="_blank"><img src="img/g.png" ></a>
<a href="https://www.facebook.com/openwebgisPage" target="_blank"><img src="img/f.png" ></a>
<a href="http://vk.com/openwebgis" target="_blank"><img src="img/vk.png" ></a>
<a href="https://www.youtube.com/user/openwebgis" target="_blank"><img src="img/y.png" ></a>
<a href="http://openwebgisystem.blogspot.com" target="_blank" title="Blogger. Информация, помощь, статьи о OpenWebGIS, Javascript, OpenLayers и т.п."><img src="img/b.png" ></a>
<a href="http://openwebgis.livejournal.com/" target="_blank" title="LiveJournal"><img src="img/lj.png" ></a>
<a href="http://paleonews.ru/index.php/new/414-gis" title="© PaleoNews - первый в России специализированный сайт новостей палеонтологии.Актуальная информация о новых научных гипотезах, событиях и находках доисторических животных." target="_blank"><img src="img/paleo.png" ></a>
</div>
<div id="dragMenu" style="background:#ffffff; width:10px; height:10px;  padding: 5px;
 padding-right: 15 px; border: solid 0px black; position:absolute; left:4px; top:123px;
 float: left; z-index:4000; cursor:move;" class="dragMenu" onmouseup="enddrag()" onmousedown="drags(event)"><div title="щёлкните чтобы переместить" style="width:10px; height:10px;"></div>
 <div id="id_menu" class="menu" ><div id="colorMenu" style="position:relative; left:0px;top:0px; float:left; z-index:2000;"> <img id="colorColorMenu" title="edit color" src="img/color.png" onclick="colorEdit(this)" > </div><div id="changeMenu" title="сделать главное меню вертикальным/горизонтальным" onclick="changeMenu()" style="position:relative; left:0px;top:0px; float:left; z-index:2000;cursor:pointer;border: solid 1px black; width:10px; height:17px;"></div>
<div id="id_block_menu" class="block_menu" >
<div class="punkt" onMouseOver="overPunkt(this);" onMouseOut="outPunkt(this);"><div>Слои</div
><div class="list_punkts"><div class="kont">
<a href="#" onclick="addLayer(map);" ><div class="podpunkt" onMouseOver="overPunkt2(this);" onMouseOut="outPunkt2(this);"><div>Добавить слой</div></div></a>
<a href="#" onclick="RemoveLayer(map);"><div class="podpunkt" onMouseOver="overPunkt2(this);" onMouseOut="outPunkt2(this);"><div>Удалить слой</div></div></a>
<a href="#" onclick="ZoomLayer(map);"><div class="podpunkt" onMouseOver="overPunkt2(this);" onMouseOut="outPunkt2(this);"><div>Увеличить до слоя</div></div></a>
<a href="#" onclick="New_Layer();"><div title="Создать и добавить новый слой" class="podpunkt" onMouseOver="overPunkt2(this);" onMouseOut="outPunkt2(this);"><div>Новый слой</div></div></a>
<a href="#" onclick="New_LayerOSM();"><div title="Создайте и добавте новый слой из файла OpenSreetMap(OSM)." class="podpunkt" onMouseOver="overPunkt2(this);" onMouseOut="outPunkt2(this);"><div>Новый слой из OSM файла</div></div></a>
<a href="#" onclick="New_LayerTXT();"><div title="Создать и добавить точечный слой из csv файла (текстового файла с разделителями). 
Разделитель должен быть точкой с запятой или запятой" class="podpunkt" onMouseOver="overPunkt2(this);" onMouseOut="outPunkt2(this);"><div>Новый точ. слой из CSV файла</div></div></a>
<a href="#" onclick="New_LayerGML();"><div title="Создать и добавить новый слой из GML файла" class="podpunkt" onMouseOver="overPunkt2(this);" onMouseOut="outPunkt2(this);"><div>Новый слой из GML файла</div></div></a>
<a href="#" onclick="New_LayerJSON();"><div title="Создать и добавить новый слой из JSON файла" class="podpunkt" onMouseOver="overPunkt2(this);" onMouseOut="outPunkt2(this);"><div>Новый слой из JSON файла</div></div></a>
<a href="#" onclick="New_LayerGPX();"><div title="Создать и добавить новый слой из GPX файла. Данные с GPS прибора" class="podpunkt" onMouseOver="overPunkt2(this);" onMouseOut="outPunkt2(this);"><div>Новый слой из GPX файла</div></div></a>
<a href="#" onclick="New_LayerKML();"><div title="Создать и добавить новый слой из KML файла" class="podpunkt" onMouseOver="overPunkt2(this);" onMouseOut="outPunkt2(this);"><div>Новый слой из KML файла</div></div></a>
<a href="#" onclick="New_LayerWMS();"><div title="Создать и добавить новый слой из WMS URL" class="podpunkt" onMouseOver="overPunkt2(this);" onMouseOut="outPunkt2(this);"><div>Новый слой из WMS url</div></div></a>

<a href="#" onclick="New_LayerFileUrl();"><div title="Создать и добавить новый слой из URL файла. Введит url адрес файла. Например: http://host.com/data.kml" class="podpunkt" onMouseOver="overPunkt2(this);" onMouseOut="outPunkt2(this);"><div>Новый слой из url файла</div></div></a>

<a href="#" onclick="New_LayerImage();"><div title="Создать и добавить новый слой из изоражения (png,gif,jpeg)" class="podpunkt" onMouseOver="overPunkt2(this);" onMouseOut="outPunkt2(this);"><div>Новый слой из изображения</div></div></a>
<a href="#" onclick="New_LayerImageUrl();"><div title="Создать и добавить новый слой из URL(интернет-адреса) изображения" class="podpunkt" onMouseOver="overPunkt2(this);" onMouseOut="outPunkt2(this);"><div>Новый слой из url изображения</div></div></a>
<a href="#" onclick="New_PostGIS();"><div title="Импорт gml файла в базу данных сервера, создать и добавить новый слой из gml файла. Экспорт этого файла в формат shapefile" class="podpunkt" onMouseOver="overPunkt2(this);" onMouseOut="outPunkt2(this);"><div>Импорт GML файла <font size="1">в базу данных сервера</font></div></div></a>
<a href="#" onclick="New_PostGIScsv();"><div title="Импорт csv файла в базу данных сервера, создать и добавить новый слой из csv файла. Экспорт этого файла в формат shapefile" class="podpunkt" onMouseOver="overPunkt2(this);" onMouseOut="outPunkt2(this);"><div>Импорт CSV файла <font size="1">в базу данных сервера</font></div></div></a>
<a href="#" onclick="Export_LayerOSM();"><div title="Экспорт слоя в OpenStreetMap(OSM) format" class="podpunkt" onMouseOver="overPunkt2(this);" onMouseOut="outPunkt2(this);"><div>Экспорт слоя в OSM format</div></div></a>
<a href="#" onclick="Export_Layer();"><div title="Экспорт слоя в KML format" class="podpunkt" onMouseOver="overPunkt2(this);" onMouseOut="outPunkt2(this);"><div>Экспорт слоя в KML format</div></div></a>
<a href="#" onclick="Export_Layer_GML();"><div title="Экспорт слоя в GML format" class="podpunkt" onMouseOver="overPunkt2(this);" onMouseOut="outPunkt2(this);"><div>Экспорт слоя в GML format</div></div></a>
<a href="#" onclick="Export_Layer_CSV();"><div title="Экспорт слоя в CSV format" class="podpunkt" onMouseOver="overPunkt2(this);" onMouseOut="outPunkt2(this);"><div>Экспорт слоя в CSV format</div></div></a>
<a href="#" onclick="Export_Layer_JSON();"><div title="Экспорт слоя в JSON format" class="podpunkt" onMouseOver="overPunkt2(this);" onMouseOut="outPunkt2(this);"><div>Экспорт слоя в JSON format</div></div></a>
<a href="#" onclick="Export_Layer_Shape();"><div title="Экспорт редактируемого слоя в  shapefile(Шейп-файл). После щелчка по этому пункту меню начнётся закачка архива в формате zip, в котором будут  5 файлов: cst, dbf, prj, shp,shx. Если слой большой - содержит несколько тысяч элементов то возможно придётся подождать некоторое время до начала закачки." class="podpunkt" onMouseOver="overPunkt2(this);" onMouseOut="outPunkt2(this);"><div>Экспорт слоя в SHAPEFILE</div></div></a>
<a href="#" onclick="Export_Layer_GPX();"><div title="Экспорт слоя в GPX format" class="podpunkt" onMouseOver="overPunkt2(this);" onMouseOut="outPunkt2(this);"><div>Экспорт слоя в GPX format</div></div></a>
<a href="#" onclick="Union_Layer();"><div title="Получить слой с именем редактируемого слоя содержащего элементы из двух слоёв. The output attribute schema is a combination of the attributes from the inputs. Attributes with same name but different types will be converted to strings" class="podpunkt" onMouseOver="overPunkt2(this);" onMouseOut="outPunkt2(this);"><div>Объединить слои</div></div></a>
<a href="#" onclick="Rename_Layer();"><div title="Переименовать слой.Меняется только имя(название) слоя на карте (в списке слоёв слева), имя слоя на сервере, если он загружен на сервер - не меняется" class="podpunkt" onMouseOver="overPunkt2(this);" onMouseOut="outPunkt2(this);"><div>Переименовать слой на карте</div></div></a>
<a href="#" onclick="Weather_Layer();"><div title="Получите информацию о погоде (пока только на английском языке)" class="podpunkt" onMouseOver="overPunkt2(this);" onMouseOut="outPunkt2(this);"><div>Погода</div></div></a>
<a style="font-size: 11.5px;" href="#" onclick="NewfromSelect_Layer();"><div title="Новый слой из выделенных или отфильтрованных элементов" class="podpunkt" onMouseOver="overPunkt2(this);" onMouseOut="outPunkt2(this);"><div>Новый слой из выделенных элементов</div></div></a>
</div></div>
</div>
<div class="punkt" onMouseOver="overPunkt(this);" onMouseOut="outPunkt(this);"><div>Вид</div
><div class="list_punkts"><div class="kont">
<a href="#" onclick="PreView();"><div title="Set previous view" class="podpunkt" onMouseOver="overPunkt2(this);" onMouseOut="outPunkt2(this);"><div>Предыдущий вид</div></div></a>
<a href="#" onclick="ZoomCoord();"><div title="Переместиться к точке с координатами" class="podpunkt" onMouseOver="overPunkt2(this);" onMouseOut="outPunkt2(this);"><div>Перейти к координатам</div></div></a>
<a href="#" onclick="ZoomCur();"><div title="Перейти к городу" class="podpunkt" onMouseOver="overPunkt2(this);" onMouseOut="outPunkt2(this);"><div>Перейти к городу</div></div></a>
<a href="#" onclick="CoordSet(this);"><div title="Включить/отключить координатную сетку" class="podpunkt" onMouseOver="overPunkt2(this);" onMouseOut="outPunkt2(this);"><div id="idGradiculeAtl">Координатная сетка</div></div></a>
<a href="#" onclick="CoordSet_opt(this);"><div title="Настроить координатную сетку" class="podpunkt" onMouseOver="overPunkt2(this);" onMouseOut="outPunkt2(this);"><div id="idGradiculeAtlop">Настройка сетки</div></div></a>
<a href="#" onclick="PrintMap();"><div title="Экспорт карты в png изоражение в новом окне" class="podpunkt" onMouseOver="overPunkt2(this);" onMouseOut="outPunkt2(this);"><div>Экспорт карты в изображение png</div></div></a>
<a href="#" onclick="TimeLine();"><div title="Временная шкала.Дата должна быть в формате: гггг-мм-ддTчч:мм:сс. Например: 2007-06-20T12:30:00, где 'T' буква латинского алфавита " class="podpunkt" onMouseOver="overPunkt2(this);" onMouseOut="outPunkt2(this);"><div>Временная шкала</div></div></a>
</div></div>
</div>
<div class="punkt" onMouseOver="overPunkt(this);" onMouseOut="outPunkt(this);"><div>Редактирование</div
><div class="list_punkts"><div class="kont">
<a href="#" onclick="OpenTable();"><div title="Открыть атрибутивную талицу" class="podpunkt" onMouseOver="overPunkt2(this);" onMouseOut="outPunkt2(this);"><div>Открыть атрибутивную таблицу</div></div></a>
<a href="#" onclick="AddAttribute();"><div title="добавить атрибут в редактируемый слой" class="podpunkt" onMouseOver="overPunkt2(this);" onMouseOut="outPunkt2(this);"><div>Добавить атрибут в слой</div></div></a>
<a href="#" onclick="DelAttribute();"><div title="Внимание: если вы удалите любой атрибут, результат не будет сохранен в shapefile" class="podpunkt" onMouseOver="overPunkt2(this);" onMouseOut="outPunkt2(this);"><div>Удалить атрибут из слоя</div></div></a>
<a href="#" onclick="UploadFile();"><div title="выберите shapefile упакованый в zip формат" class="podpunkt" onMouseOver="overPunkt2(this);" onMouseOut="outPunkt2(this);"><div>Загрузить shapefile</div></div></a>
<a href="#" onclick="UploadFileAsc();"><div title="выберите ArcGrid файл в asc format" class="podpunkt" onMouseOver="overPunkt2(this);" onMouseOut="outPunkt2(this);"><div>Загрузить ArcGrid file</div></div></a>
<a href="#" onclick="ExportFileAsc();"><div title="Экспорт  слой с Гридом(Heatmap, IDW interpolation) в формат ArcGrid ASCII" class="podpunkt" onMouseOver="overPunkt2(this);" onMouseOut="outPunkt2(this);"><div>Экспорт в ArcGrid формат</div></div></a>
<a href="#" onclick="NewArcGridLayer();"><div title="Создать новый слой из файла ArcGrid ASCII" class="podpunkt" onMouseOver="overPunkt2(this);" onMouseOut="outPunkt2(this);"><div>Новый слой из файла ArcGrid</div></div></a>

<a href="#" onclick="UploadTiffFile();"><div title="выберите GeoTiff файл" class="podpunkt" onMouseOver="overPunkt2(this);" onMouseOut="outPunkt2(this);"><div>Загрузить GeoTiff file</div></div></a>
<a href="#" onclick="OK_ImageAnalysis();"><div title="Модуль работы со слоем Изображения(фото, картинки,спутниковые фото). &#013; Сегментация областей по цвету и векторизация. &#013; Повышение резкости, бинаризация, выделение границ, инвертирование и преобразование к оттенкам серого" class="podpunkt" onMouseOver="overPunkt2(this);" onMouseOut="outPunkt2(this);"><div>Сегментация изображения (ДЗЗ)</div></div></a>
<a href="#" onclick="OK_ExtrudeImage();"><div title="Экструдировать(выдавить) изображение(картинку) по яркости пикселей" class="podpunkt" onMouseOver="overPunkt2(this);" onMouseOut="outPunkt2(this);"><div>Экструдировать изображение</div></div></a>
<a href="#" onclick="LegendAsc();"><div title="Редактировать легенду (style) слоя ArcGrid,GeoTIFF" class="podpunkt" onMouseOver="overPunkt2(this);" onMouseOut="outPunkt2(this);"><div>Редак-ть легенду растра(грида)</div></div></a>
<a href="#" onclick="OK_BoundImage();"><div title="Редактировать границы слоя изображения" class="podpunkt" onMouseOver="overPunkt2(this);" onMouseOut="outPunkt2(this);"><div>Редак-ть границы слоя изображения</div></div></a>
<a href="#" onclick="OK_OrderLayer();"><div title="После того как вы щёлкните по этому пункту меню появится окно со списком названий слоёв на карте. Просто измените порядок названий в этом списке и нажмите кнопку OK. В списке названия слоёв должны быть разделены точкой с запятой!" class="podpunkt" onMouseOver="overPunkt2(this);" onMouseOut="outPunkt2(this);"><div>Изменить порядок слоёв</div></div></a>
<a href="#" onclick="OK_OSMeditLayer();"><div title="" class="podpunkt" onMouseOver="overPunkt2(this);" onMouseOut="outPunkt2(this);"><div>Редактировать слой OSM Buildings</div></div></a>
<a href="#" onclick="OK_SetBaseLayer();"><div title="" class="podpunkt" onMouseOver="overPunkt2(this);" onMouseOut="outPunkt2(this);"><div>Сделать слой базовым</div></div></a>
<a href="#" onclick="OK_SetSLDLayer();"><div title="" class="podpunkt" onMouseOver="overPunkt2(this);" onMouseOut="outPunkt2(this);"><div>Импорт/Экспорт SLD легенду</div></div></a>

</div></div>
</div>
<div class="punkt" onMouseOver="overPunkt(this);" onMouseOut="outPunkt(this);"><div>Вычисления</div><div class="list_punkts"><div class="kont">
<!--<a href="#"><div class="podpunkt" onMouseOver="overPunkt2(this);" onMouseOut="outPunkt2(this);"><div>Distance</div></div></a>/-->
<a href="#" onclick="Interpolation();"><div title="Важно: Выбирайте методы ‘Heatmap’ или ‘Inverse Distance Weighting (IDW)’ для любых (как загруженных, так и не загруженных на сервер) типов точечных слоёв. Если вы выбираете методы ‘Heatmap (additional)’ или ‘Barnes Surface’ для слоя, загруженного на сервер OpenWebGIS, то результаты интерполяции будут показаны в слое формата WMS. Если Вы интерполируете слой, не загруженный на сервер (а созданный из файлов csv, gml, kml и т.п.) с помощью методов ‘Heatmap (additional)’ или ‘Barnes Surface’,  то результаты интерполяции будут  показаны в ТОЧЕЧНОМ векторном слое. В этом случае в зависимости от выбранных параметров результирующий слой может  содержать множество элементов и медленно перерисовываться во время увеличения, уменьшения, перемещения." class="podpunkt" onMouseOver="overPunkt2(this);" onMouseOut="outPunkt2(this);"><div>Интерполяция</div></div></a>
<a href="#" title="showing the isotherm,isobath etc. lines generated by contouring the Barnes Surface" onclick="Contour();"><div class="podpunkt" onMouseOver="overPunkt2(this);" onMouseOut="outPunkt2(this);"><div><font size="2">Контур из векторного слоя (точечного)</font></div></div></a>
<a href="#" title="Creating the isotherm,isobath etc. lines generated from ArcGrid layer and export in shapefile" onclick="ContourGrid();"><div class="podpunkt" onMouseOver="overPunkt2(this);" onMouseOut="outPunkt2(this);"><div><font size="2">Контур из ArcGrid слоя (grid)</font></div></div></a>
<a href="#" title="Computes aggregation functions on a feature attribute. Functions include Count, Average, Max, Median, Min, StdDev, and Sum for all features in Layer" onclick="Agregation();"><div class="podpunkt" onMouseOver="overPunkt2(this);" onMouseOut="outPunkt2(this);"><div>Статистика(Sum,StdDev etc)</div></div></a>
<a href="#" title="Расчёт  статистик(Count, Average, Max, Median, Min, StdDev, and Sum) с учётом выбраного аттрибута 'Редактируемого слоя' для каждого полигона полигонального Слоя. Редактируемый слой должен быть точечным." onclick="ZonalStatistic();"><div class="podpunkt" onMouseOver="overPunkt2(this);" onMouseOut="outPunkt2(this);"><div><font size="2">Зональная статистика(Sum,StdDev etc)</font></div></div></a>
<a href="#" title="Some geomathematics function (distance,buffer,centroid,....) ." onclick="Geomathematic();"><div class="podpunkt" onMouseOver="overPunkt2(this);" onMouseOut="outPunkt2(this);"><div>Геоматематика</div></div></a>
<a href="#" title="Агрегирование данных слоя по квадратам (суммирование, усреднение). Установите размер квадрата в градусах" onclick="SumKvadrLayer();"><div class="podpunkt" onMouseOver="overPunkt2(this);" onMouseOut="outPunkt2(this);"><div><font size=3>Расчет по квадратам</font></div></div></a>
<a href="#" title="Анализ временного ряда." onclick="SSA();"><div class="podpunkt" onMouseOver="overPunkt2(this);" onMouseOut="outPunkt2(this);"><div><font size=3>Временной и матричный анализ</font></div></div></a>
<a href="#" title="Корреляционный и регрессионный анализ" onclick="Correlation();"><div class="podpunkt" onMouseOver="overPunkt2(this);" onMouseOut="outPunkt2(this);"><div><font size=3>Корреляционный анализ</font></div></div></a>
<a href="#" title="Fractals" onclick="Fractals();"><div class="podpunkt" onMouseOver="overPunkt2(this);" onMouseOut="outPunkt2(this);"><div><font size=3>Фракталы</font></div></div></a>
</div></div>
</div>
<div class="punkt" onMouseOver="overPunkt(this);" onMouseOut="outPunkt(this);"><div>Интерфейс</div
><div class="list_punkts"><div class="kont">
<a href="#" onclick="SwitchDrag(this);"><div title="Переключить режим интерфейса" class="podpunkt" onMouseOver="overPunkt2(this);" onMouseOut="outPunkt2(this);"><div id="idSwitchInterface">Переключить режим интерфейса</div></div></a>
<a href="#" onclick="SaveInterface(this);"><div title="Сохранить изменения интерфейса" class="podpunkt" onMouseOver="overPunkt2(this);" onMouseOut="outPunkt2(this);"><div id="idSaveInterface">Сохранить интерфейс</div></div></a>
<a href="#" onclick="SetDefaultInterface(this);"><div title="Установить стандартный интерфейс" class="podpunkt" onMouseOver="overPunkt2(this);" onMouseOut="outPunkt2(this);"><div id="idDefaultInterface">Стандартный интерфейс</div></div></a>
<a href="#" onclick="AblePopUp(this);"><div title="Включить/отключить всплывающее окно изменения прозрачности слоя в списке слоёв" class="podpunkt" onMouseOver="overPunkt2(this);" onMouseOut="outPunkt2(this);"><div id="idAbleOpacity">Вкл/Выкл окно прозрачности</div></div></a>
</div></div>
</div>
<div class="punkt" onMouseOver="overPunkt(this);" onMouseOut="outPunkt(this);"><div>Проект</div
><div class="list_punkts"><div class="kont">
<a href="#" onclick="SaveProject(this);"><div title="Сохранить проект" class="podpunkt" onMouseOver="overPunkt2(this);" onMouseOut="outPunkt2(this);"><div id="idSaveProject">Сохранить проект</div></div></a>
<a href="#" onclick="LoadProject(this);"><div title="Загрузить проект" class="podpunkt" onMouseOver="overPunkt2(this);" onMouseOut="outPunkt2(this);"><div id="idLoadProject">Загрузить проект</div></div></a>
<a href="#" onclick="ExportProject(this);"><div title="Экспорт проекта в файл" class="podpunkt" onMouseOver="overPunkt2(this);" onMouseOut="outPunkt2(this);"><div id="idExportProject">Экспорт проекта в файл</div></div></a>
<a href="#" onclick="LoadFileProject(this);"><div title="Загрузить файл проекта " class="podpunkt" onMouseOver="overPunkt2(this);" onMouseOut="outPunkt2(this);"><div id="idLoadFileProject">Загрузить файл проекта</div></div></a>
</div></div>
</div>
<div class="punkt" onMouseOver="overPunkt(this);" onMouseOut="outPunkt(this);"><div>ГеоБазыДанных</div
><div class="list_punkts"><div class="kont">
<a href="#" onclick="FAObase();"><div class="podpunkt" onMouseOver="overPunkt2(this);" onMouseOut="outPunkt2(this);"><div title="Информация предоставлена: Food and Agriculture Organization of the United Nations. Fisheries and Aquaculture Department. Продовольственная и сельскохозяйственная организация ООН. Департамент  рыболовства и аквакультуры" style="font-size:11px">Распределение водных биоресурсов (FAO)</div></div></a>
<a href="#" onclick="Paleobiology();"><div class="podpunkt" onMouseOver="overPunkt2(this);" onMouseOut="outPunkt2(this);"><div title="This service is provided by the Paleobiology Database, hosted by the Department of Geoscience at the University of Wisconsin-Madison" style="font-size:11px">ПалеоБиологическая база данных</div></div></a>
<a href="#" onclick="EarthquakesB();"><div class="podpunkt" onMouseOver="overPunkt2(this);" onMouseOut="outPunkt2(this);"><div title="Информация предоставлена: USGS. USGS is a science bureau within the United States Department of the Interior, http://www.usgs.gov/" style="font-size:11px">Землетрясения база данных</div></div></a>
<a href="#" onclick="MonTemperature();"><div class="podpunkt" onMouseOver="overPunkt2(this);" onMouseOut="outPunkt2(this);"><div title="Информация предоставлена: International Research Institute for Climate and Society (IGOSS) http://iridl.ldeo.columbia.edu" style="font-size:11px">Среднемесячная температура</div></div></a>
<a href="#" onclick="InternationalSpace();"><div class="podpunkt" onMouseOver="overPunkt2(this);" onMouseOut="outPunkt2(this);"><div title="Траектории спутников Земли" style="font-size:11px">Траектории спутников Земли</div></div></a>
<a href="#" onclick="OpenSreetMapdatabase();"><div class="podpunkt" onMouseOver="overPunkt2(this);" onMouseOut="outPunkt2(this);"><div title="Выберите информацию из базы данных OpenSreetMap" style="font-size:11px">OpenSreetMap база данных</div></div></a>
</div></div>
</div>
<div class="punkt" onMouseOver="overPunkt(this);" onMouseOut="outPunkt(this);"><div>О системе</div
><div class="list_punkts"><div class="kont">
<a href="#" onclick="Help();"><div class="podpunkt" onMouseOver="overPunkt2(this);" onMouseOut="outPunkt2(this);"><div>Помощь</div></div></a>
<a href="#" onclick="aboutSoftware();"><div class="podpunkt" onMouseOver="overPunkt2(this);" onMouseOut="outPunkt2(this);"><div >Состав OpenWebGIS</div></div></a>
<a href="#"><div class="podpunkt" onMouseOver="overPunkt2(this);" onMouseOut="outPunkt2(this);"><div>Authors</div></div></a>
<a href="#" onclick="Game();"><div class="podpunkt" onMouseOver="overPunkt2(this);" onMouseOut="outPunkt2(this);"><div>Game</div></div></a>
</div></div>
</div>
<div class="punkt" onMouseOver="overPunkt(this);" onMouseOut="outPunkt(this);" ><div><a href="owgagreement.htm" target="_blank" title="Щелкните левой клавишей" style="color: #efe4b0; font: 1em Arial, sans-serif; text-shadow: #0000ff 0 0 2px;">Пользовательское соглашение</a></div
><div class="list_punkts"><div class="kont">
</div></div>
</div>
<div class="punkt" onMouseOver="overPunkt(this);" onMouseOut="outPunkt(this);" ><div><a href="support.htm" target="_blank" title="Щелкните левой клавишей" style="color: #efe4b0; font: 1em Arial, sans-serif; text-shadow: #0000ff 0 0 2px;">Поддержите проект</a></div
><div class="list_punkts"><div class="kont">
</div></div>
</div>
<div class="punkt" onMouseOver="overPunkt(this);" onMouseOut="outPunkt(this);" ><div id="id_ContactsOpenGis"><a onclick="Contact();" title="Щелкните левой клавишей" style="color: #efe4b0; font: 1em Arial, sans-serif; text-shadow: #0000ff 0 0 2px;">Контакты</a></div
><div class="list_punkts"><div class="kont">
</div></div>
</div>
<div class="punkt" onMouseOver="overPunkt(this);" onMouseOut="outPunkt(this);" ><div><a href="News.htm" target="_blank" title="Щелкните левой клавишей" style="color: #efe4b0; font: 1em Arial, sans-serif; text-shadow: #0000ff 0 0 2px;">Новости</a></div
><div class="list_punkts"><div class="kont">
</div></div>
</div>
<div class="punkt" onMouseOver="overPunkt(this);" onMouseOut="outPunkt(this);" ><div><a href="download/javascriptCodeOpenWebGIS20151014.zip" target="_blank" title="Javascript and html source code" style="color: #efe4b0; font: 1em Arial, sans-serif; text-shadow: #0000ff 0 0 2px;">JavascriptSourceCode</a></div
><div class="list_punkts"><div class="kont">
</div></div>
</div>
</div>
<div class="footer_menu"></div>
</div> 
</div>
<!--<a href="#" onclick="map.layers[1].commit();return false">Save boundry</a><br /-->
 <!--<a href="#" onclick="map.layers[2].commit();return false">Save temper</a><br /-->
<div id="drag" style=" width: 10px;
height:10px; 
background:rgba(255,255,255,0.5);
 padding:5px;
 padding-right:15px; 
 border:solid 1px black; 
 float:left;
cursor:move;
position:absolute; top:174px; left:-5px;
z-index:1200;" class="dragSwitcher" onmousedown="drags(event)" onmouseup="enddrag()"><div title="щёлкните чтобы переместить" style="width:12px; height:12px;"></div><div id="external_control2" class="block1" ><div id="colorSwitcher" style="position:relative; left:0px;top:0px; float:right; z-index:2000;"> <img id="colorColorSwitcher" title="edit color" src="img/color.png" onclick="colorEdit(this)" > </div></div> </div>
<div id="dragEditLayer" class="dragEditLayer" style="width: 3px;
height:3px; 
 background:#ffffff;
color:#082567;
 padding:2px;
 padding-right:5px; 
 border:solid 0px black; 
 float:left; position:absolute;left:29px; top:159px;cursor:move;z-index:1500;" onmousedown="drags(event)" onmouseup="enddrag()"><div title="click to drag" style="width:4px; height:4px;"></div>
<div style="position:relative; top:0px; left:10px; width:350px;height:15px; cursor:default;">
 <a title="Select Layer for edit or interpolation" style="width:50px" >Редактируемый слой: </a>
 <select id="editL1" onchange="SeteditlayerMain(value)">
 <option value="0">.</option>
 </select>
</div>
</div> 
<div id="OpenStreetMapIdSearch" class="OpenStreetMapIdClass" onmousedown="drags(event)" onmouseup="enddrag()" style=" float:none; position:absolute;left:410px; top:90px;
z-index:91500;cursor:move;color:#082567;">
<div style="float: left;width:489px"><a href="http://nominatim.openstreetmap.org/" target="_blank">OpenStreetMap_Поиск:</a><br><input type="text" size="35" id="Id_OpenStreetMapId" title="Введите название объекта, для того что бы найти его на карте" value=""/><button type=button class="Searchclass" onclick=SearchOnMap()>Поиск</button><button type=button  title="Показать/скрыть результат поиска" onclick=SearchOnMapHide() class="SearchHclass"><a style="font-size: 10px;">скрыть</a></button></div><br>
<div id="ResultSearchOpenStreet_id" style="position:relative;top:0;left:0px;display:none;height: 10px; font-size: 10px; overflow:auto;border: solid 1px; black;background:#ffffff;"></div>
</div>
<div id="OpenWikipediaSearch" class="OpenWikipediaClass" onmousedown="drags(event)" onmouseup="enddrag()" style=" float:none; position:absolute;left:977px; top:90px;
z-index:91500;cursor:move;color:#082567;">
<div style="float: left;width:505px"><a href="http://www.mediawiki.org" target="_blank">Wikipedia(Mediawiki)_Поиск:</a><br><div style="width:505px;"><input type="text" size="35" id="Id_WikipediaMapId" title="Введите название объекта, для того что бы найти его на карте" value=""/><button type=button class="Searchclass" onclick=SearchWikipediaOnMap()>Поиск</button><button type=button  title="Показать/скрыть результат поиска" onclick=SearchWikipediaOnMapHide() class="SearchHclass"><a style="font-size: 10px;">скрыть</a></button><div title="Открыть окно с настройками выборки из Википедии. Установите язык, выборку вокруг точки и т.п." onclick=SearchWikipediaOnMapOption() style="cursor:pointer;width:15px;height:15px;float:right;position:relative;left:-155px;top:-15px"><a style="font-size: 10px;"></a><img src="img/option.png"/></div></div></div><br>
<div id="ResultSearchWikipedia_id" style="position:relative;top:0;left:0px;display:none;height: 10px; font-size: 10px; overflow:auto;border: solid 1px; black;background:#ffffff;"></div>
</div>
<div id="dragCoord" class="moveCoord" style="width: 3px;
height:3px; 
 background:#ffffff;
 color:#082567;
 padding:0px;
 padding-right:0px; 
 border:solid 0px black; 
 float:left; position:absolute;left:579px; top:163px; cursor:move;z-index:1500;" onmousedown="drags(event)" onmouseup="enddrag()"><div title="щелкните чтобы сдвинуть координаты" style="width:2px; height:2px;"></div>
<div id="external_control" style="width:285px;height:20px; float:left; position:relative;left:12px; cursor:default;">.</div> 

</div>
<div title="щёлкните чтобы переместить" id="dragToolbar_opt" class="moveToolbar_opt" style="width: 3px;
height:3px; 
 background:#ccc;
 padding:2px;
 padding-right:2px; 
 border:solid 2px black; 
 float:left; position:absolute;left:343px; top:218px; cursor:move;z-index:5000; display:none" onmousedown="drags(event)" onmouseup="enddrag()">
<div title=" " id="toolbar" class="toolbar" style="display: none; width:1200px; height:150px; left:0px; top:0px;position:relative;cursor:default;">
 <ul>
 <li>
 <a>Tiling:</a>
 <select id="tilingModeSelector" onchange="setTileMode(value)" disabled title="Might work in next version WebGis">
 <option value="ams">Single tile</option>
 <option value="ams2">Tiled</option>
 </select>
 </li>
 <li>
 <a>Transition effect:</a>
 <select id="transitionEffectSelector" onchange="setTransitionMode(value)" disabled title="Might work in next version WebGis">
 <option value="">None</option>
 <option value="resize">Resize</option>
 </select>
 </li>
 <li>
 <a>Antialias:</a>
 <select id="antialiasSelector" onchange="setAntialiasMode(value)" disabled title="Might work in next version WebGis">
 <option value="full">Full</option>
 <option value="text">Text only</option>
 <option value="none">Disabled</option>
 </select>
 </li>
 <li>
 <a>Format:</a>
 <select id="imageFormatSelector" onchange="setImageFormat(value)" disabled title="Might work in next version WebGis">
 <option value="image/png">PNG 24bit</option>
 <option value="image/png8">PNG 8bit</option>
 <option value="image/gif">GIF</option>
 <option id="jpeg" value="image/jpeg">JPEG</option>
 </select>
 </li>
 <li>
 <a>Styles:</a>
 <select id="imageFormatSelector" onchange="setStyle(value)" disabled title="Might work in next version WebGis">
 <option value="">Default</option>
 <option value="burg">burg</option> 
 <option value="point">point</option> 
 </select>
 </li>
  <li>
 <a>Width/Height:</a>
 <select title="Введите стандартное значение ширины карты в пикселях" id="widthSelector" onchange="setWidth(value)">
 <option value="auto">Auto</option> <option value="100">100</option> <option value="200">200</option>
 <option value="300">300</option> <option value="400">400</option>
 <option value="500">500</option> <option value="600">600</option>
 <option value="650">650</option> <option value="700">700</option>
 <option value="750">750</option> <option value="800">800</option>
 <option value="850">850</option> <option value="900">900</option>
 <option value="950">950</option> <option value="1000">1000</option>
 <option value="1080">1080</option> <option value="1100">1100</option>
 <option value="1200">1200</option> <option value="1300">1300</option>
 <option value="1400">1400</option> <option value="1500">1500</option>
 <option value="1600">1600</option> <option value="1900">1900</option>
 <option value="1920">1920</option>
 </select>
<input title="Введите произвольное значение ширины карты в пикселях" type="text" size="5" id="widthSelectorInput_web" value="600"/>
 <select title="Введите стандартное значение высоты карты в пикселях" id="heigthSelector" onchange="setHeight(value)">
 <option value="auto">Auto</option> <option value="100">100</option> <option value="200">200</option>
 <option value="300">300</option> <option value="400">400</option>
 <option value="500">500</option> <option value="600">600</option>
 <option value="650">650</option> <option value="700">700</option>
 <option value="750">750</option> <option value="800">800</option>
 <option value="850">850</option> <option value="900">900</option>
 <option value="950">950</option> <option value="1000">1000</option>
 <option value="1080">1080</option> <option value="1100">1100</option>
 <option value="1200">1200</option> <option value="1300">1300</option>
 <option value="1400">1400</option> <option value="1500">1500</option>
 <option value="1600">1600</option> <option value="1900">1900</option>
 <option value="1920">1920</option>
 </select>
<input title="Введите произвольное значение высоты карты в пикселях и нажмите кнопку 'Изменить'" type="text" size="5" id="heightSelectorInput_web" value="600"/>
<button title="Изменить размер карты" type=button onclick=EditmapSizeFree()>Изменить</button>
 </li>
 <li>
 <a>Filter:</a>
 <select id="filterType">
 <option value="cql">CQL</option>
 <option value="ogc">OGC</option>
 <option value="fid">FeatureID</option>
 </select>
 <input type="text" size="80" id="filter" title="Если вы применяете фильтр для текстовых полей, то нужно использовть одинарные кавычки. Например: НАЗВАНИЕ='Москва'"/>
 <img id="updateFilterButton" src="openlayers/img/east-mini.png" onClick="updateFilter()" title="Apply filter"/>
 <img id="resetFilterButton" src="openlayers/img/cancel.png" onClick="resetFilter()" title="Reset filter"/>
 </li>
<li>
 <a title="Defines the strategy used to interpolate missing values">Interplation: </a>
<select id="imageFormatSelector2" onchange="setImageFormat2(value)" disabled title="Might work in next version WebGis">
 <option value="3">Simple implementation of inverse distance weighting</option>
 <option value="1">Nearest neighbor found</option>
 <option value="2">Value decays with distance</option>
 </select>
 </li>
<li>
 <a title="Defines the method to reduce the set of data to be interloped">Simplify: </a>
 <select id="imageSimpl" onchange="setSimplify(value)" disabled title="Might work in next version WebGis">
 <option value="1">Uniform distributed grid</option>
 <option value="0">Copy the first value</option>
 <option value="2">Random samples</option>
 <option value="3">Highest and lowest values</option>
 </select>
 </li>
<li>
 <a title="Defines the size of the simplify sample">Simplify size: </a>
<input type="text" size="5" id="SZ" value="30" disabled title="Might work in next version WebGis"/>
 <img id="updateSZButton" src="openlayers/img/east-mini.png" onClick="updateSZ()" title="click to change simplify size"/>
 <! <img id="resetSZButton" src="http://ams.xoomcode.comopenlayers/img/cancel.png" onClick="resetSZ()" title="Reset Simplify size"/>
 </li>
<li>
 <a title="Defines the radius used by interpolation">Radius: </a>
<input type="text" size="5" id="Radius_inter" value="140" disabled title="Might work in next version WebGis"/>
 <img id="updateRadiusButton" src="openlayers/img/east-mini.png" onClick="updateRadius()" title="click to change radius"/>
 <! <img id="resetRadiusButton" src="http://ams.xoomcode.comopenlayers/img/cancel.png" onClick="resetRadius()" title="Reset Simplify size"/>
 </li>
<li>
 <a title=" Defines a set of real numbers with the property that any number that lies between two numbers in the set is also included in the set. Values must to be speared by comma: 10,20,45,70,100">Intervals[]: </a>
<input type="text" size="15" id="INTERVALS[]" value="14.014,15.182,15.351,15.52,15.688,15.857,16.025,16.194,16.365" disabled title="Might work in next version WebGis"/>
 <img id="updateIntervalsButton" src="openlayers/img/east-mini.png" onClick="updateIntervals()" title="click to change intervals"/>
 <! <img id="resetRadiusButton" src="http://ams.xoomcode.comopenlayers/img/cancel.png" onClick="resetRadius()" title="Reset Simplify size"/>
 </li>
<li>
 <a title="Determines how interpolated values are rendered">Renderer type: </a>
 <select id="renderer" onchange="SetRendererType(value)" disabled title="Might work in next version WebGis">
 <option title="Generate an smooth color rendering" value="2" selected>2</option>
 <option title="dense: Allows to set a color for each value generated by the interpolation" value="0">0</option>
 <option title="sparse: Set the color defined in intervals_colors to the values that lies within the interval corresponding" value="1">1</option>
 </select>
 </li>
 </ul>
 </div>
 </div> <!--end drag block for toolbar option -->
 <!-- <div>
 <p>
 <button type="button" onclick="addLayer(map);">Add Layer </button>
 </p>
 </div> 
 <div>
 <p>
 <button type="button" onclick="RemoveLayer(map);">Remove Layer </button>
 </p>
 </div> -->
<div id="mapResize" style=" width: 10px;
height:10px; 
 background:rgba(204,204,204,0.5);
 padding:5px;
  
 border:solid 1px black; 
 float:right;
cursor:se-resize;
position:absolute; top:174px; left:252px;
z-index:1000;" class="sizeMap" onmousedown="drags(event)" onmouseup="enddrag()"><div title="щелкните чтобы изменить размер карты" style="width:4px; height:4px;"></div>
 <div id="mapMain" style=" width: 10px;
height:10px; 
background:rgba(204,204,204,0.5);
 padding:5px;
 padding-right:15px; 
 border:solid 1px black; 
 float:left;
cursor:move;
position:relative; top:0px; left:0px;
z-index:1000;" class="dragMap" onmousedown="drags(event)" onmouseup="enddrag()"><div title="щёлкните чтобы двигать карту" style="width:2px; height:2px;"></div>
<div id="map" class="block2" style="width: 1000px; 
height: 600px;
 background: #a5ccdd; 
color:#000080;
 padding: 5px; 
 border: solid 1px black; 
 float: left; 
 position: relative; 
 top: 0px; 
 left: 0px; ">
<img id="options" style="cursor:pointer" title="additional toolbar. Изменить размер Карты" src="img/options.png"/>
 </div> 
</div> 
</div> <!resize
<!</div>
 <div title="щёлкните чтобы переместить" id="dragScale" style=" width: 3px;
height:3px; 
 background:#fffff;
color:#082567;
 padding:2px;
 padding-right:5px; 
 border:solid 0px black; 
 float:left;
cursor:move;
position:absolute; top:157px; left:425px;
z-index:1600;" class="dragScale" onmousedown="drags(event)" onmouseup="enddrag()"><div title="щелкните чтобы перетащить" style="width:4px; height:4px;"></div>
<div id="wrapper" style="position:relative; width: 80px; height:15px; top: 0px; left: 0px; cursor:default;">
 <!-- <div id="location" style="float:left; left:10px;top:3px;width:130px;position: relative;" >location</div> -->
 <div id="scale" style="float:left; left:10px;top:3px;width:150px;position: relative;">
 </div>
 </div>
</div>
 <div id="nodelist" style="position:relative; top:500px" >
 <em>Click on the map to get feature info</em>
 </div>
 <! <div id="map" class="smallmap" style="width: 200; height: 10"></div> 
 <! <textarea id="output"></textarea>
 </body> 
</html> 
